"use strict";(()=>{var ra=Object.create;var Yt=Object.defineProperty,oa=Object.defineProperties,oo=Object.getOwnPropertyDescriptor,aa=Object.getOwnPropertyDescriptors,ga=Object.getOwnPropertyNames,co=Object.getOwnPropertySymbols,ao=Object.getPrototypeOf,go=Object.prototype.hasOwnProperty,da=Object.prototype.propertyIsEnumerable,ua=Reflect.get;var ro=(g,i,t)=>i in g?Yt(g,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[i]=t,G=(g,i)=>{for(var t in i||(i={}))go.call(i,t)&&ro(g,t,i[t]);if(co)for(var t of co(i))da.call(i,t)&&ro(g,t,i[t]);return g},A=(g,i)=>oa(g,aa(i)),a=(g,i)=>Yt(g,"name",{value:i,configurable:!0});var Ba=(g,i)=>()=>(i||g((i={exports:{}}).exports,i),i.exports),Vi=(g,i)=>{for(var t in i)Yt(g,t,{get:i[t],enumerable:!0})},Ia=(g,i,t,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let l of ga(i))!go.call(g,l)&&l!==t&&Yt(g,l,{get:()=>i[l],enumerable:!(n=oo(i,l))||n.enumerable});return g};var ba=(g,i,t)=>(t=g!=null?ra(ao(g)):{},Ia(i||!g||!g.__esModule?Yt(t,"default",{value:g,enumerable:!0}):t,g));var Qe=(g,i,t,n)=>{for(var l=n>1?void 0:n?oo(i,t):i,s=g.length-1,c;s>=0;s--)(c=g[s])&&(l=(n?c(i,t,l):c(l))||l);return n&&l&&Yt(i,t,l),l};var kn=(g,i,t)=>ua(ao(g),t,i);var R=(g,i,t)=>new Promise((n,l)=>{var s=o=>{try{r(t.next(o))}catch(d){l(d)}},c=o=>{try{r(t.throw(o))}catch(d){l(d)}},r=o=>o.done?n(o.value):Promise.resolve(o.value).then(s,c);r((t=t.apply(g,i)).next())});var Io=Ba((Ag,$l)=>{"use strict";var Ca=Object.prototype.hasOwnProperty,q="~";function Si(){}a(Si,"Events");Object.create&&(Si.prototype=Object.create(null),new Si().__proto__||(q=!1));function Qa(g,i,t){this.fn=g,this.context=i,this.once=t||!1}a(Qa,"EE");function Bo(g,i,t,n,l){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new Qa(t,n||g,l),c=q?q+i:i;return g._events[c]?g._events[c].fn?g._events[c]=[g._events[c],s]:g._events[c].push(s):(g._events[c]=s,g._eventsCount++),g}a(Bo,"addListener");function Tn(g,i){--g._eventsCount===0?g._events=new Si:delete g._events[i]}a(Tn,"clearEvent");function M(){this._events=new Si,this._eventsCount=0}a(M,"EventEmitter");M.prototype.eventNames=a(function(){var i=[],t,n;if(this._eventsCount===0)return i;for(n in t=this._events)Ca.call(t,n)&&i.push(q?n.slice(1):n);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(t)):i},"eventNames");M.prototype.listeners=a(function(i){var t=q?q+i:i,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var l=0,s=n.length,c=new Array(s);l<s;l++)c[l]=n[l].fn;return c},"listeners");M.prototype.listenerCount=a(function(i){var t=q?q+i:i,n=this._events[t];return n?n.fn?1:n.length:0},"listenerCount");M.prototype.emit=a(function(i,t,n,l,s,c){var r=q?q+i:i;if(!this._events[r])return!1;var o=this._events[r],d=arguments.length,u,B;if(o.fn){switch(o.once&&this.removeListener(i,o.fn,void 0,!0),d){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,t),!0;case 3:return o.fn.call(o.context,t,n),!0;case 4:return o.fn.call(o.context,t,n,l),!0;case 5:return o.fn.call(o.context,t,n,l,s),!0;case 6:return o.fn.call(o.context,t,n,l,s,c),!0}for(B=1,u=new Array(d-1);B<d;B++)u[B-1]=arguments[B];o.fn.apply(o.context,u)}else{var b=o.length,I;for(B=0;B<b;B++)switch(o[B].once&&this.removeListener(i,o[B].fn,void 0,!0),d){case 1:o[B].fn.call(o[B].context);break;case 2:o[B].fn.call(o[B].context,t);break;case 3:o[B].fn.call(o[B].context,t,n);break;case 4:o[B].fn.call(o[B].context,t,n,l);break;default:if(!u)for(I=1,u=new Array(d-1);I<d;I++)u[I-1]=arguments[I];o[B].fn.apply(o[B].context,u)}}return!0},"emit");M.prototype.on=a(function(i,t,n){return Bo(this,i,t,n,!1)},"on");M.prototype.once=a(function(i,t,n){return Bo(this,i,t,n,!0)},"once");M.prototype.removeListener=a(function(i,t,n,l){var s=q?q+i:i;if(!this._events[s])return this;if(!t)return Tn(this,s),this;var c=this._events[s];if(c.fn)c.fn===t&&(!l||c.once)&&(!n||c.context===n)&&Tn(this,s);else{for(var r=0,o=[],d=c.length;r<d;r++)(c[r].fn!==t||l&&!c[r].once||n&&c[r].context!==n)&&o.push(c[r]);o.length?this._events[s]=o.length===1?o[0]:o:Tn(this,s)}return this},"removeListener");M.prototype.removeAllListeners=a(function(i){var t;return i?(t=q?q+i:i,this._events[t]&&Tn(this,t)):(this._events=new Si,this._eventsCount=0),this},"removeAllListeners");M.prototype.off=M.prototype.removeListener;M.prototype.addListener=M.prototype.on;M.prefixed=q;M.EventEmitter=M;typeof $l!="undefined"&&($l.exports=M)});var m={LCTRLFLAG:1,RCTRLFLAG:2,LALTFLAG:4,RALTFLAG:8,K_SHIFTFLAG:16,K_CTRLFLAG:32,K_ALTFLAG:64,K_METAFLAG:128,CAPITALFLAG:256,NOTCAPITALFLAG:512,NUMLOCKFLAG:1024,NOTNUMLOCKFLAG:2048,SCROLLFLAG:4096,NOTSCROLLFLAG:8192,ISVIRTUALKEY:16384,VIRTUALCHARKEY:32768};var Nn={K_BKSP:8,K_TAB:9,K_ENTER:13,K_SHIFT:16,K_CONTROL:17,K_ALT:18,K_PAUSE:19,K_CAPS:20,K_ESC:27,K_SPACE:32,K_PGUP:33,K_PGDN:34,K_END:35,K_HOME:36,K_LEFT:37,K_UP:38,K_RIGHT:39,K_DOWN:40,K_SEL:41,K_PRINT:42,K_EXEC:43,K_INS:45,K_DEL:46,K_HELP:47,K_0:48,K_1:49,K_2:50,K_3:51,K_4:52,K_5:53,K_6:54,K_7:55,K_8:56,K_9:57,K_A:65,K_B:66,K_C:67,K_D:68,K_E:69,K_F:70,K_G:71,K_H:72,K_I:73,K_J:74,K_K:75,K_L:76,K_M:77,K_N:78,K_O:79,K_P:80,K_Q:81,K_R:82,K_S:83,K_T:84,K_U:85,K_V:86,K_W:87,K_X:88,K_Y:89,K_Z:90,K_NP0:96,K_NP1:97,K_NP2:98,K_NP3:99,K_NP4:100,K_NP5:101,K_NP6:102,K_NP7:103,K_NP8:104,K_NP9:105,K_NPSTAR:106,K_NPPLUS:107,K_SEPARATOR:108,K_NPMINUS:109,K_NPDOT:110,K_NPSLASH:111,K_F1:112,K_F2:113,K_F3:114,K_F4:115,K_F5:116,K_F6:117,K_F7:118,K_F8:119,K_F9:120,K_F10:121,K_F11:122,K_F12:123,K_NUMLOCK:144,K_SCROLL:145,K_LSHIFT:160,K_RSHIFT:161,K_LCONTROL:162,K_RCONTROL:163,K_LALT:164,K_RALT:165,K_COLON:186,K_EQUAL:187,K_COMMA:188,K_HYPHEN:189,K_PERIOD:190,K_SLASH:191,K_BKQUOTE:192,K_LBRKT:219,K_BKSLASH:220,K_RBRKT:221,K_QUOTE:222,K_oE2:226,K_OE2:226,K_oC1:193,K_OC1:193,"K_?C1":193,"k_?C1":193,K_oDF:223,K_ODF:223,K_LOPT:50001,K_ROPT:50002,K_NUMERALS:50003,K_SYMBOLS:50004,K_CURRENCIES:50005,K_UPPER:50006,K_LOWER:50007,K_ALPHA:50008,K_SHIFTED:50009,K_ALTGR:50010,K_TABBACK:50011,K_TABFWD:50012},X=Nn,pg={2:X.K_1,3:X.K_2,4:X.K_3,5:X.K_4,6:X.K_5,7:X.K_6,8:X.K_7,9:X.K_8,10:X.K_9,11:X.K_0,12:X.K_HYPHEN,13:X.K_EQUAL,16:X.K_Q,17:X.K_W,18:X.K_E,19:X.K_R,20:X.K_T,21:X.K_Y,22:X.K_U,23:X.K_I,24:X.K_O,25:X.K_P,26:X.K_LBRKT,27:X.K_RBRKT,30:X.K_A,31:X.K_S,32:X.K_D,33:X.K_F,34:X.K_G,35:X.K_H,36:X.K_J,37:X.K_K,38:X.K_L,39:X.K_COLON,40:X.K_QUOTE,41:X.K_BKQUOTE,43:X.K_BKSLASH,44:X.K_Z,45:X.K_X,46:X.K_C,47:X.K_V,48:X.K_B,49:X.K_N,50:X.K_M,51:X.K_COMMA,52:X.K_PERIOD,53:X.K_SLASH,57:X.K_SPACE,86:X.K_oE2,115:X.K_oC1,125:X.K_oE2};var Fa={};Vi(Fa,{PRIVATE_USE_IDS:()=>ha,TouchLayoutKeySp:()=>uo});var ha=["T_*_MT_SHIFT_TO_SHIFT","T_*_MT_SHIFT_TO_CAPS","T_*_MT_SHIFT_TO_DEFAULT"],uo=(o=>(o[o.normal=0]="normal",o[o.special=1]="special",o[o.specialActive=2]="specialActive",o[o.customSpecial=3]="customSpecial",o[o.customSpecialActive=4]="customSpecialActive",o[o.deadkey=8]="deadkey",o[o.blank=9]="blank",o[o.spacer=10]="spacer",o))(uo||{});var ya=55296,ma=56319,Ga=56320,pa=57343;function Yn(g){return g>=ya&&g<=ma}a(Yn,"Uni_IsSurrogate1");function En(g){return g>=Ga&&g<=pa}a(En,"Uni_IsSurrogate2");var e={};var XX={};var S=ba(Io(),1);var bo={modifierCodes:{LCTRL:m.LCTRLFLAG,RCTRL:m.RCTRLFLAG,LALT:m.LALTFLAG,RALT:m.RALTFLAG,SHIFT:m.K_SHIFTFLAG,CTRL:m.K_CTRLFLAG,ALT:m.K_ALTFLAG,META:m.K_METAFLAG,CAPS:m.CAPITALFLAG,NO_CAPS:m.NOTCAPITALFLAG,NUM_LOCK:m.NUMLOCKFLAG,NO_NUM_LOCK:m.NOTNUMLOCKFLAG,SCROLL_LOCK:m.SCROLLFLAG,NO_SCROLL_LOCK:m.NOTSCROLLFLAG,VIRTUAL_KEY:m.ISVIRTUALKEY,VIRTUAL_CHAR_KEY:m.VIRTUALCHARKEY},modifierBitmasks:{ALL:127,ALT_GR_SIM:5,CHIRAL:31,IS_CHIRAL:15,NON_CHIRAL:112,NON_LEGACY:111},stateBitmasks:{ALL:16128,CAPS:768,NUM_LOCK:3072,SCROLL_LOCK:12288},keyCodes:G({},Nn),codesUS:[["0123456789",";=,-./`","[\\]'"],[")!@#$%^&*(",":+<_>?~",'{|}"']],isFrameKey(g){switch(g){case"K_SHIFT":case"K_LOPT":case"K_ROPT":case"K_NUMLOCK":case"K_CAPS":return!0;default:if(bo.keyCodes[g]>=5e4)return!0}return!1},getModifierState(g){var i=0;g.indexOf("shift")>=0&&(i|=m.K_SHIFTFLAG);var t=!1;g.indexOf("leftctrl")>=0&&(i|=m.LCTRLFLAG,t=!0),g.indexOf("rightctrl")>=0&&(i|=m.RCTRLFLAG,t=!0),g.indexOf("ctrl")>=0&&!t&&(i|=m.K_CTRLFLAG);var n=!1;return g.indexOf("leftalt")>=0&&(i|=m.LALTFLAG,n=!0),g.indexOf("rightalt")>=0&&(i|=m.RALTFLAG,n=!0),g.indexOf("alt")>=0&&!n&&(i|=m.K_ALTFLAG),i},getStateFromLayer(g){var i=0;return g.indexOf("caps")>=0?i|=m.CAPITALFLAG:i|=m.NOTCAPITALFLAG,i}},C=bo;var es=class es{codeForEvent(i){return C.keyCodes[i.kName]||i.Lcode}forAny(i,t,n){var l="";if((l=this.forSpecialEmulation(i))!=null)return l;if(!t&&(l=this.forNumpadKeys(i))!=null)return l;if((l=this.forUnicodeKeynames(i,n))!=null)return l;if((l=this.forBaseKeys(i,n))!=null)return l;switch(this.codeForEvent(i)){default:return null}}isCommand(i){switch(this.codeForEvent(i)){default:return!1}}applyCommand(i,t){}forSpecialEmulation(i){switch(this.codeForEvent(i)){case C.keyCodes.K_BKSP:return"\b";case C.keyCodes.K_ENTER:return`
`;default:return null}}forNumpadKeys(i){if(i.Lcode>=C.keyCodes.K_NP0&&i.Lcode<=C.keyCodes.K_NPSLASH){if(i.Lcode<106)var t=i.Lcode-48;else t=i.Lcode-64;return String._kmwFromCharCode(t)}else return null}forUnicodeKeynames(i,t){let n=i.kName;if(!n||n.substr(0,2)!="U_")return null;let l="",s=n.substr(2).split("_");for(let c of s){let r=parseInt(c,16);if(0<=r&&r<=31||128<=r&&r<=159||isNaN(r)){t&&(t.errorLog="Suppressing Unicode control code in "+n);continue}else l+=String.kmwFromCharCode(r)}return l||null}forBaseKeys(i,t){let n=i.Lcode,l=i.Lmodifiers;if(l==m.K_SHIFTFLAG)l=1;else if(l!=0)return t&&(t.warningLog="KMW only defines default key output for the 'default' and 'shift' layers!"),null;try{if(n==C.keyCodes.K_SPACE)return" ";if(n>=C.keyCodes.K_0&&n<=C.keyCodes.K_9)return C.codesUS[l][0][n-C.keyCodes.K_0];if(n>=C.keyCodes.K_A&&n<=C.keyCodes.K_Z)return String.fromCharCode(n+(l?0:32));if(n>=C.keyCodes.K_COLON&&n<=C.keyCodes.K_BKQUOTE)return C.codesUS[l][1][n-C.keyCodes.K_COLON];if(n>=C.keyCodes.K_LBRKT&&n<=C.keyCodes.K_QUOTE)return C.codesUS[l][2][n-C.keyCodes.K_LBRKT];if(n==C.keyCodes.K_oE2)return l?"|":"\\"}catch(s){t&&(t.errorLog="Error detected with default mapping for key:  code = "+n+", shift state = "+(l==1?"shift":"default"))}return null}};a(es,"DefaultRules");var Ae=es;var Ua=new Ae,Wi=class Wi{constructor(i){this.isSynthetic=!0;for(let t in i)i[t]!==void 0&&(this[t]=i[t])}static constructNullKeyEvent(i){return new Wi({Lcode:0,kName:"",device:i,Lstates:void 0,Lmodifiers:void 0,vkCode:void 0,LisVirtualKey:void 0})}get isModifier(){switch(this.Lcode){case 16:case 17:case 18:case 20:case 144:case 145:return!0;default:return!1}}setMnemonicCode(i,t){if(this.Lcode!=C.keyCodes.K_SPACE){let l=new Wi(this);for(let s in this)l[s]=this[s];l.kName="K_xxxx",l.Lmodifiers=i?16:0;var n=Ua.forAny(l,!0);this.vkCode=this.Lcode,n?this.Lcode=n.charCodeAt(0):this.isModifier||delete this.Lcode}t&&(this.Lcode>=65&&this.Lcode<=90||this.Lcode>=97&&this.Lcode<=122)&&(this.Lmodifiers^=16,this.Lcode^=32)}};a(Wi,"KeyEvent");var te=Wi;var ns=class ns{};a(ns,"KeyMap");var Ye=ns,ls=class ls{constructor(){this.FF=new Ye;this.Safari=new Ye;this.Opera=new Ye;this.FF.k61=187,this.FF.k59=186,this.FF.k173=189}};a(ls,"BrowserKeyMaps");var ts=ls,ss=class ss{constructor(){this.se=new Ye,this.se.k220=192,this.se.k187=189,this.se.k219=187,this.se.k221=219,this.se.k186=221,this.se.k191=220,this.se.k192=186,this.se.k189=191,this.uk=new Ye,this.uk.k223=192,this.uk.k192=222,this.uk.k222=226,this.uk.k220=220}};a(ss,"LanguageKeyMaps");var is=ss,Re=class Re{constructor(){}static _usCodeInit(){var i=new Ye,t=new Ye;i.k192=96,i.k49=49,i.k50=50,i.k51=51,i.k52=52,i.k53=53,i.k54=54,i.k55=55,i.k56=56,i.k57=57,i.k48=48,i.k189=45,i.k187=61,i.k81=113,i.k87=119,i.k69=101,i.k82=114,i.k84=116,i.k89=121,i.k85=117,i.k73=105,i.k79=111,i.k80=112,i.k219=91,i.k221=93,i.k220=92,i.k65=97,i.k83=115,i.k68=100,i.k70=102,i.k71=103,i.k72=104,i.k74=106,i.k75=107,i.k76=108,i.k186=59,i.k222=39,i.k90=122,i.k88=120,i.k67=99,i.k86=118,i.k66=98,i.k78=110,i.k77=109,i.k188=44,i.k190=46,i.k191=47,t.k192=126,t.k49=33,t.k50=64,t.k51=35,t.k52=36,t.k53=37,t.k54=94,t.k55=38,t.k56=42,t.k57=40,t.k48=41,t.k189=95,t.k187=43,t.k81=81,t.k87=87,t.k69=69,t.k82=82,t.k84=84,t.k89=89,t.k85=85,t.k73=73,t.k79=79,t.k80=80,t.k219=123,t.k221=125,t.k220=124,t.k65=65,t.k83=83,t.k68=68,t.k70=70,t.k71=71,t.k72=72,t.k74=74,t.k75=75,t.k76=76,t.k186=58,t.k222=34,t.k90=90,t.k88=88,t.k67=67,t.k86=86,t.k66=66,t.k78=78,t.k77=77,t.k188=60,t.k190=62,t.k191=63,Re._usCharCodes=[i,t]}static _USKeyCodeToCharCode(i){return Re.usCharCodes[i.Lmodifiers&16?1:0]["k"+i.Lcode]}static get usCharCodes(){return Re._usCharCodes||Re._usCodeInit(),Re._usCharCodes}};a(Re,"KeyMapping"),Re.browserMap=new ts,Re.languageMap=new is;var ie=Re;function oe(g){if(typeof g!="object"||!g)return g;{let i=Array.isArray(g)?[]:{},t=Object.keys(g);for(let n of t)g[n]!==void 0&&(i[n]=oe(g[n]));return i}}a(oe,"deepCopy");var Y=class Y{constructor(i,t,n,l){switch(i.toLowerCase()){case Y.Browser.Chrome:case Y.Browser.Edge:case Y.Browser.Firefox:case Y.Browser.Native:case Y.Browser.Opera:case Y.Browser.Safari:this.browser=i.toLowerCase();break;default:this.browser=Y.Browser.Other}switch(t.toLowerCase()){case Y.FormFactor.Desktop:case Y.FormFactor.Phone:case Y.FormFactor.Tablet:this.formFactor=t.toLowerCase();break;default:throw"Invalid form factor specified for device: "+t}switch(n.toLowerCase()){case Y.OperatingSystem.Windows.toLowerCase():case Y.OperatingSystem.macOS.toLowerCase():case Y.OperatingSystem.Linux.toLowerCase():case Y.OperatingSystem.Android.toLowerCase():case Y.OperatingSystem.iOS.toLowerCase():this.OS=n.toLowerCase();break;default:this.OS=Y.OperatingSystem.Other}this.touchable=l}};a(Y,"DeviceSpec");var yt=Y;(n=>{let g;(B=>(B.Chrome="chrome",B.Edge="edge",B.Firefox="firefox",B.Native="native",B.Opera="opera",B.Safari="safari",B.Other="other"))(g=n.Browser||(n.Browser={}));let i;(u=>(u.Windows="windows",u.macOS="macosx",u.Linux="linux",u.Android="android",u.iOS="ios",u.Other="other"))(i=n.OperatingSystem||(n.OperatingSystem={}));let t;(r=>(r.Desktop="desktop",r.Phone="phone",r.Tablet="tablet"))(t=n.FormFactor||(n.FormFactor={}))})(yt||(yt={}));function cs(g){return new yt(g.browser,"desktop",g.OS,!1)}a(cs,"physicalKeyDeviceAlias");var W=yt;var ae=class ae{};a(ae,"KEYMAN_VERSION"),ae.VERSION="18.0.148",ae.VERSION_RELEASE="18.0",ae.VERSION_MAJOR="18",ae.VERSION_MINOR="0",ae.VERSION_PATCH="148",ae.TIER="alpha",ae.VERSION_TAG="-alpha",ae.VERSION_WITH_TAG="18.0.148-alpha",ae.VERSION_ENVIRONMENT="alpha",ae.VERSION_GIT_TAG="release@18.0.148-alpha";var Ai=ae,tt=Ai;var be=class be{constructor(i){if(i==null){this.components=[].concat(be.DEVELOPER_VERSION_FALLBACK.components);return}if(Array.isArray(i)){let l=i;if(l.length<2)throw new Error("Version string must have at least a major and minor component!");this.components=[].concat(l);return}let t=i.split("."),n=[];if(t.length<2)throw new Error("Version string must have at least a major and minor component!");for(let l=0;l<t.length;l++){let s=parseInt(t[l],10);if(isNaN(s))throw new Error("Version string components must be numerical!");n.push(s)}this.components=n}get major(){return this.components[0]}get minor(){return this.components[1]}toString(){return this.components.join(".")}toJSON(){return this.toString()}equals(i){return this.compareTo(i)==0}precedes(i){return this.compareTo(i)<0}compareTo(i){var t=this.components.length<i.components.length,n=this.components.length<i.components.length?this.components.length:i.components.length,l;for(l=0;l<n;l++){let c=this.components[l]-i.components[l];if(c!=0)return c}var s=t?i.components:this.components;do{if(s[l]>0)return t?-1:1;l++}while(l<s.length);return 0}};a(be,"Version"),be.CURRENT=new be(tt.VERSION_RELEASE),be.DEVELOPER_VERSION_FALLBACK=new be([9,0,0]),be.NO_DEFAULT_KEYCAPS=new be([12,0]),be.MAC_POSSIBLE_IPAD_ALIAS=new be([10,15]);var K=be;function Et(){return typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof self!="undefined"?self:global}a(Et,"getGlobalObject");function Ri(){String.kmwFromCharCode=function(g){var i=[],t;for(t=0;t<arguments.length;t++){var n=Number(arguments[t]);if(!isFinite(n)||n<0||n>1114111||Math.floor(n)!==n)throw new RangeError("Invalid code point "+n);n<65536?i.push(n):(n-=65536,i.push((n>>10)+55296),i.push(n%1024+56320))}return String.fromCharCode.apply(void 0,i)},String.prototype.kmwCharCodeAt=function(g){var i=String(this),t=0;if(g<0||g>=i.length)return NaN;for(var n=0;n<g;n++)if(t=i.kmwNextChar(t),t===null)return NaN;var l=i.charCodeAt(t);if(l>=55296&&l<=56319&&i.length>t+1){var s=i.charCodeAt(t+1);if(s>=56320&&s<=57343)return(l-55296<<10)+(s-56320)+65536}return l},String.prototype.kmwIndexOf=function(g,i){var t=String(this),n=t.indexOf(g,i);if(n<0)return n;for(var l=0,s=0;s!==null&&s<n;s=t.kmwNextChar(s))l++;return l},String.prototype.kmwLastIndexOf=function(g,i){var t=String(this),n=t.lastIndexOf(g,i);if(n<0)return n;for(var l=0,s=0;s!==null&&s<n;s=t.kmwNextChar(s))l++;return l},String.prototype.kmwLength=function(){var g=String(this);if(g.length==0)return 0;for(var i=0,t=0;t!==null;i++)t=g.kmwNextChar(t);return i},String.prototype.kmwSlice=function(g,i){var t=String(this),n=t.kmwCodePointToCodeUnit(g),l=t.kmwCodePointToCodeUnit(i);return n===null||l===null?"":t.slice(n,l)},String.prototype.kmwSubstr=function(g,i){var t=String(this);g<0&&(g=t.kmwLength()+g),g<0&&(g=0);var n=t.kmwCodePointToCodeUnit(g),l=n;if(n===null)return"";if(arguments.length<2)l=t.length;else for(var s=0;s<i;s++)l=t.kmwNextChar(l);return l===null?t.substring(n):t.substring(n,l)},String.prototype.kmwSubstring=function(g,i){var t=String(this),n,l;if(typeof i=="undefined")n=t.kmwCodePointToCodeUnit(g),l=t.length;else{if(g>i){var s=g;g=i,i=s}n=t.kmwCodePointToCodeUnit(g),l=t.kmwCodePointToCodeUnit(i)}return(isNaN(n)||n===null)&&(n=0),(isNaN(l)||l===null)&&(l=t.length),t.substring(n,l)},String.prototype.kmwNextChar=function(g){var i=String(this);if(g===null||g<0||g>=i.length-1)return null;var t=i.charCodeAt(g);if(t>=55296&&t<=56319&&i.length>g+1){var n=i.charCodeAt(g+1);if(n>=56320&&n<=57343)return g==i.length-2?null:g+2}return g+1},String.prototype.kmwPrevChar=function(g){var i=String(this);if(g==null||g<=0||g>i.length)return null;var t=i.charCodeAt(g-1);if(t>=56320&&t<=57343&&g>1){var n=i.charCodeAt(g-2);if(n>=55296&&n<=56319)return g-2}return g-1},String.prototype.kmwCodePointToCodeUnit=function(g){if(g===null)return null;var i=String(this),t=0;if(g<0){t=i.length;for(var n=0;n>g;n--)t=i.kmwPrevChar(t);return t}if(g==i.kmwLength())return i.length;for(var n=0;n<g;n++)t=i.kmwNextChar(t);return t},String.prototype.kmwCodeUnitToCodePoint=function(g){var i=String(this);return g===null?null:g==0?0:g<0?i.substr(g).kmwLength():i.substr(0,g).kmwLength()},String.prototype.kmwCharAt=function(g){var i=String(this);return g>=0?i.kmwSubstr(g,1):""},String.prototype.kmwBMPNextChar=function(g){var i=String(this);return g<0||g>=i.length-1?null:g+1},String.prototype.kmwBMPPrevChar=function(g){var i=String(this);return g<=0||g>i.length?null:g-1},String.prototype.kmwBMPCodePointToCodeUnit=function(g){return g},String.prototype.kmwBMPCodeUnitToCodePoint=function(g){return g},String.prototype.kmwBMPLength=function(){var g=String(this);return g.length},String.prototype.kmwBMPSubstr=function(g,i){var t=String(this);return g>-1?t.substr(g,i):t.substr(t.length+g,-g)},String.kmwEnableSupplementaryPlane=function(g){var i=String.prototype;String._kmwFromCharCode=g?String.kmwFromCharCode:String.fromCharCode,i._kmwCharAt=g?i.kmwCharAt:i.charAt,i._kmwCharCodeAt=g?i.kmwCharCodeAt:i.charCodeAt,i._kmwIndexOf=g?i.kmwIndexOf:i.indexOf,i._kmwLastIndexOf=g?i.kmwLastIndexOf:i.lastIndexOf,i._kmwSlice=g?i.kmwSlice:i.slice,i._kmwSubstring=g?i.kmwSubstring:i.substring,i._kmwSubstr=g?i.kmwSubstr:i.kmwBMPSubstr,i._kmwLength=g?i.kmwLength:i.kmwBMPLength,i._kmwNextChar=g?i.kmwNextChar:i.kmwBMPNextChar,i._kmwPrevChar=g?i.kmwPrevChar:i.kmwBMPPrevChar,i._kmwCodePointToCodeUnit=g?i.kmwCodePointToCodeUnit:i.kmwBMPCodePointToCodeUnit,i._kmwCodeUnitToCodePoint=g?i.kmwCodeUnitToCodePoint:i.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}a(Ri,"extendString");Ri();var rs=class rs{constructor(i){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((t,n)=>{this._resolve=l=>{this._isFulfilled=!0,t(l)},this._reject=l=>{this._isRejected=!0,n(l)},i&&i(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(i,t){return this._promise.then(i,t)}catch(i){return this._promise.catch(i)}finally(i){return this._promise.finally(i)}get corePromise(){return this._promise}};a(rs,"ManagedPromise");var v=rs;var os=class os extends v{constructor(t){let n=null;super(c=>{n=setTimeout(()=>{this.isResolved||c(!0)},t)});this.timerHandle=n;let l=this._resolve;this._resolve=c=>{clearTimeout(this.timerHandle),l(c)};let s=this._reject;this._reject=c=>{clearTimeout(this.timerHandle),s(c)}}};a(os,"TimeoutPromise");var Ee=os,ge=a(g=>new Ee(g).corePromise,"timedPromise");var k=Fa.TouchLayoutKeySp;var xa=200,L=class L{static buildDefaultLayout(i,t,n){var Xi;let l=n;typeof L.dfltLayout[l]!="object"&&(l="desktop");let s=C.modifierBitmasks.NON_CHIRAL,c=K.CURRENT;t&&(s=t.modifierBitmask,c=t.compilerVersion),i||(i=this.DEFAULT_RAW_SPEC);var r=oe(L.dfltLayout[l]),o,d=r.layer,u=i.KLS,B=i.K102,b,I,F,h,y,Q,x=(s&C.modifierBitmasks.IS_CHIRAL)!=0;if(i.F){let Ne=/^(?:(?:italic|bold) )* *[0-9.eE-]+(?:[a-z]+) "(.+)"$/.exec(i.F);Ne&&(r.font=Ne[1])}var U=!(typeof u=="undefined"||!u);U||(u=i.KLS=L.processLegacyDefinitions(i.BK));var p=Object.getOwnPropertyNames(u),V=[];if(p.splice(p.indexOf("default"),1),p=["default"].concat(p),t&&t.emulatesAltGr&&(p.indexOf("leftctrl-leftalt")==-1&&p.indexOf("rightalt")!=-1&&(p.push("leftctrl-leftalt"),u["leftctrl-leftalt"]=u.rightalt),p.indexOf("leftctrl-leftalt-shift")==-1&&p.indexOf("rightalt-shift")!=-1&&(p.push("leftctrl-leftalt-shift"),u["leftctrl-leftalt-shift"]=u["rightalt-shift"])),r.displayUnderlying=t?!!t.scriptObject.KDU:!1,n=="desktop")for(V=L.generateLayerIds(x),o=0;o<V.length;o++)p.indexOf(V[o])!=-1&&V.splice(o--,1);var f=p.concat(V);if(U&&n!="desktop"){var H=null;h=d[0].row;for(var w=0;w<h.length;w++){Q=h[w].key;for(var qe=0;qe<Q.length;qe++)y=Q[qe],y.id=="K_SHIFT"&&(H=y)}if(H){H.sk=[];for(let Ne in u){if(Ne=="default"||Ne=="shift")continue;var Jn=L.modifierSpecials[Ne];let et={id:`K_${Jn}`,text:Jn,sp:1,nextlayer:Ne};H.sk.push(et)}}else console.warn("Error in default layout - cannot find default Shift key!")}for(o=0;o<f.length;o++)o>0&&(d[o]=oe(d[0])),d[o].id=f[o],d[o].nextlayer=f[o],L.formatDefaultLayer(d[o],x,n,!!B);for(o=0;o<d.length;o++){var Ce=d[o],ke,H=null,Ui=null,Ft=null,xi=null,$e=u[Ce.id],Nt=Ce.id=="shift"?1:0,Zi=Ce.id=="default"||Nt?1:0;for(h=Ce.row,b=0;b<h.length;b++)for(Q=h[b].key,I=0;I<Q.length;I++){switch(y=Q[I],ke=L.dfltCodes.indexOf(y.id),($e||Zi)&&($e&&ke>=0&&ke<$e.length&&(y.text=$e[ke]),Zi&&c.precedes(K.NO_DEFAULT_KEYCAPS)&&y.id!="K_SPACE"&&ke+65*Nt<L.dfltText.length&&y.text!==null&&(y.text=y.text||L.dfltText[ke+65*Nt])),y.text!==null&&(y.text=y.text||""),y.id){case"K_SHIFT":H=y;break;case"K_CAPS":Ui=y;break;case"K_NUMLOCK":Ft=y;break;case"K_SCROLL":xi=y;break}if(y.sk!=null){for(F=0;F<y.sk.length;F++)p.indexOf(y.sk[F].nextlayer)==-1&&y.sk.splice(F--,1);y.sk.length==0&&(y.sk=null)}}Ce.shiftKey=H,Ce.capsKey=Ui,Ce.numKey=Ft,Ce.scrollKey=xi;let et=d[o].id;n!="desktop"&&o>0&&H!=null&&(H.sp=k.specialActive,H.sk=null,H.text=(Xi=L.modifierSpecials[et])!=null?Xi:"*Shift*")}return r}static getLayerId(i){var t="";return i==0?"default":(i&m.LCTRLFLAG&&(t=(t.length>0?t+"-":"")+"leftctrl"),i&m.RCTRLFLAG&&(t=(t.length>0?t+"-":"")+"rightctrl"),i&m.LALTFLAG&&(t=(t.length>0?t+"-":"")+"leftalt"),i&m.RALTFLAG&&(t=(t.length>0?t+"-":"")+"rightalt"),i&m.K_SHIFTFLAG&&(t=(t.length>0?t+"-":"")+"shift"),i&m.K_CTRLFLAG&&(t=(t.length>0?t+"-":"")+"ctrl"),i&m.K_ALTFLAG&&(t=(t.length>0?t+"-":"")+"alt"),t)}static generateLayerIds(i){var t,n;i?(t=32,n=1):(t=8,n=16);for(var l=[],s=0;s<t;s++)l.push(L.getLayerId(s*n));return l}static formatDefaultLayer(i,t,n,l){for(var s=i.id,c=0;c<i.row.length;c++)for(var r=i.row[c],o=r.key,d=0;d<o.length;d++){var u=o[d];switch(u.id){case"K_SHIFT":case"K_LSHIFT":case"K_RSHIFT":s.indexOf("shift")!=-1&&(u.sp=k.specialActive),n!="desktop"&&(s!="default"?u.nextlayer="default":u.nextlayer="shift");break;case"K_LCTRL":case"K_LCONTROL":if(t){s.indexOf("leftctrl")!=-1&&(u.sp=k.specialActive);break}case"K_RCTRL":case"K_RCONTROL":if(t){s.indexOf("rightctrl")!=-1&&(u.sp=k.specialActive);break}case"K_CONTROL":s.indexOf("ctrl")!=-1&&(!t||s.indexOf("leftctrl")!=-1&&s.indexOf("rightctrl")!=-1)&&(u.sp=k.specialActive);break;case"K_LALT":if(t){s.indexOf("leftalt")!=-1&&(u.sp=k.specialActive);break}case"K_RALT":if(t){s.indexOf("rightalt")!=-1&&(u.sp=k.specialActive);break}case"K_ALT":s.indexOf("alt")!=-1&&(!t||s.indexOf("leftalt")!=-1&&s.indexOf("rightalt")!=-1)&&(u.sp=k.specialActive);break;case"K_oE2":(typeof l=="undefined"||!l)&&(n=="desktop"?(o.splice(d--,1),o[0].width=xa):o[d].sp=k.spacer);break}}}static processLegacyDefinitions(i){for(var t=L.generateLayerIds(!1),n={},l=0;l<t.length;l++){for(var s=t[l],c=[],r=!1,o=0;o<65;o++){var d=o+65*l;c.push(i[d]),d<i.length&&i[d]!=""&&o!=L.dfltCodes.indexOf("K_SPACE")&&(r=!0)}r&&(n[s]=c)}return(typeof n.default=="undefined"||!n.default)&&(n.default=[""]),(typeof n.shift=="undefined"||!n.shift)&&(n.shift=[""]),n}};a(L,"Layouts"),L.dfltCodes=["K_BKQUOTE","K_1","K_2","K_3","K_4","K_5","K_6","K_7","K_8","K_9","K_0","K_HYPHEN","K_EQUAL","K_*","K_*","K_*","K_Q","K_W","K_E","K_R","K_T","K_Y","K_U","K_I","K_O","K_P","K_LBRKT","K_RBRKT","K_BKSLASH","K_*","K_*","K_*","K_A","K_S","K_D","K_F","K_G","K_H","K_J","K_K","K_L","K_COLON","K_QUOTE","K_*","K_*","K_*","K_*","K_*","K_oE2","K_Z","K_X","K_C","K_V","K_B","K_N","K_M","K_COMMA","K_PERIOD","K_SLASH","K_*","K_*","K_*","K_*","K_*","K_SPACE"],L.dfltText="`1234567890-=§~~qwertyuiop[]\\~~~asdfghjkl;'~~~~~?zxcvbnm,./~~~~~ ~!@#$%^&*()_+§~~QWERTYUIOP{}\\~~~ASDFGHJKL:\"~~~~~?ZXCVBNM<>?~~~~~ ",L.DEFAULT_RAW_SPEC={F:"Tahoma",BK:L.dfltText.split("")},L.modifierSpecials={leftalt:"*LAlt*",rightalt:"*RAlt*",alt:"*Alt*",leftctrl:"*LCtrl*",rightctrl:"*RCtrl*",ctrl:"*Ctrl*","ctrl-alt":"*AltGr*","leftctrl-leftalt":"*LAltCtrl*","rightctrl-rightalt":"*RAltCtrl*","leftctrl-leftalt-shift":"*LAltCtrlShift*","rightctrl-rightalt-shift":"*RAltCtrlShift*",shift:"*Shift*","shift-alt":"*AltShift*","shift-ctrl":"*CtrlShift*","shift-ctrl-alt":"*AltCtrlShift*","leftalt-shift":"*LAltShift*","rightalt-shift":"*RAltShift*","leftctrl-shift":"*LCtrlShift*","rightctrl-shift":"*RCtrlShift*"},L.dfltShiftToCaps={id:"T_*_MT_SHIFT_TO_CAPS",text:"*ShiftLock*",sp:1,nextlayer:"caps"},L.dfltShiftToDefault={id:"T_*_MT_SHIFT_TO_DEFAULT",text:"*Shift*",sp:1,nextlayer:"default"},L.dfltShiftToShift={id:"T_*_MT_SHIFT_TO_SHIFT",text:"*Shift*",sp:1,nextlayer:"shift"},L.dfltLayout={desktop:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:1,key:[{id:"K_BKQUOTE"},{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{id:"K_BKSP",text:"*BkSp*",sp:1,width:130}]},{id:2,key:[{id:"K_TAB",text:"*Tab*",sp:1,width:130},{id:"K_Q"},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{id:"K_BKSLASH"}]},{id:3,key:[{id:"K_CAPS",text:"*Caps*",sp:1,width:165},{id:"K_A"},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_ENTER",text:"*Enter*",sp:1,width:165}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:130},{id:"K_oE2"},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_RSHIFT",text:"*Shift*",sp:1,width:130}]},{id:5,key:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:170},{id:"K_LALT",text:"*Alt*",sp:1,width:160},{id:"K_SPACE",text:"",width:770},{id:"K_RALT",text:"*Alt*",sp:1,width:160},{id:"K_RCONTROL",text:"*Ctrl*",sp:1,width:170}]}]}]},tablet:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",sp:1,width:150},{id:"K_SPACE",text:"",width:570},{id:"K_BKSP",text:"*BkSp*",sp:1,width:150},{id:"K_ENTER",text:"*Enter*",sp:1,width:200}]}]}]},phone:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",width:150,sp:1},{id:"K_SPACE",width:570,text:""},{id:"K_BKSP",text:"*BkSp*",width:150,sp:1},{id:"K_ENTER",text:"*Enter*",width:200,sp:1}]}]}]}};var E=L;function ve(g,i,t){t.enumerable=!0}a(ve,"Enumerable");var ho={id:"string",text:"string",layer:"string",nextlayer:"string",font:"string",fontsize:"string",sp:"number",pad:"number",width:"number",sk:"subkeys",flick:"flicks",multitap:"subkeys",hint:"string",default:"boolean"},Fo=["n","ne","e","se","s","sw","w","nw"];function as(g,i){let t=Object.getPrototypeOf(i);for(let n in i)if(!g.hasOwnProperty(n)){let l=Object.getOwnPropertyDescriptor(t,n);l?Object.defineProperty(g,n,l):g[n]=i[n]}return g}a(as,"assignDefaultsWithPropDefs");var $=class ${constructor(i,t,n){this.isMnemonic=!1;Object.assign(this,i),!this.text&&typeof this.id=="string"&&(this.text=ne.unicodeIDToText(this.id)),this.displayLayer=n,this.layer=this.layer||n,this._baseKeyEvent=()=>this.constructBaseKeyEvent(t,n)}get baseKeyID(){if(typeof this.id!="undefined")return this.id}get isPadding(){return this.sp==k.spacer}get coreID(){if(typeof this.id=="undefined")return;let i=this.id||"";return this.displayLayer!=this.layer&&(i=i+"+"+this.layer),i}get elementID(){if(typeof this.id!="undefined")return this.displayLayer+"-"+this.coreID}get baseKeyEvent(){let i=this._baseKeyEvent;return typeof i=="function"&&(i=i()),new te(i)}static unicodeIDToText(i,t){if(!i||i.substring(0,2)!="U_")return null;let n="",l=i.substring(2).split("_");for(let s of l){let c=parseInt(s,16);if(0<=c&&c<=31||128<=c&&c<=159||isNaN(c)){t&&t(s);continue}else n+=String.kmwFromCharCode(c)}return n||null}static sanitize(i){typeof i.width=="string"&&(i.width=parseInt(i.width,10)),i.width||(i.width=ne.DEFAULT_KEY_WIDTH),typeof i.pad=="string"&&(i.pad=parseInt(i.pad,10)),i.pad||(i.pad=ne.DEFAULT_PAD),typeof i.sp=="string"&&(i.sp=Number.parseInt(i.sp,10)),i.sp||(i.sp=ne.DEFAULT_KEY.sp);for(let t of Object.keys(ho)){let n=ho[t];switch(n){case"subkeys":let l=i[t];if(l===void 0)break;if(!Array.isArray(l))delete i[t];else for(let r=0;r<l.length;r++){let o=l[r];typeof o!="object"?l.splice(r--,1):ne.sanitize(o)}break;case"flicks":let s=i[t];if(s===void 0)break;if(typeof s!="object")delete i[t];else for(let r of Fo){let o=s[r];if(o===void 0)break;typeof o!="object"?delete s[r]:ne.sanitize(o)}break;default:let c=i[t];c!==void 0&&typeof c!=n&&delete i[t]}}i.text||(i.text=ne.DEFAULT_KEY.text)}constructBaseKeyEvent(i,t){let n=this.layer||t||"",l=this.id?this.id.toUpperCase():null,s={Lmodifiers:C.getModifierState(n),Lstates:C.getStateFromLayer(n),Lcode:l?C.keyCodes[l]:0,LisVirtualKey:!0,vkCode:0,kName:l,kLayer:n,kbdLayer:t,kNextLayer:this.nextlayer,device:null,isSynthetic:!0},c=new te(s);if(i.keyboard){let r=i.keyboard;r.isMnemonic&&!(i.isDefault&&i.formFactor!="desktop")?c.Lcode!=C.keyCodes.K_SPACE&&(c.vkCode=c.Lcode,this.isMnemonic=!0):c.vkCode=c.Lcode,r.definesPositionalOrMnemonic||(c.Lcode=ie._USKeyCodeToCharCode(c),c.LisVirtualKey=!1)}return c}};a($,"ActiveKeyBase"),$.DEFAULT_PAD=15,$.DEFAULT_RIGHT_MARGIN=15,$.DEFAULT_KEY_WIDTH=100,$.DEFAULT_KEY={text:"",width:$.DEFAULT_KEY_WIDTH,sp:k.normal,pad:$.DEFAULT_PAD},Qe([ve],$.prototype,"baseKeyID",1),Qe([ve],$.prototype,"isPadding",1),Qe([ve],$.prototype,"coreID",1),Qe([ve],$.prototype,"elementID",1),Qe([ve],$.prototype,"baseKeyEvent",1),Qe([ve],$.prototype,"constructBaseKeyEvent",1);var vi=$,Kn=class Kn extends vi{getSubkey(i){if(this.sk){for(let t of this.sk)if(t.coreID==i)return t}return null}constructor(i,t,n){super(i,t,n);let l=this.sk;if(l)for(let r=0;r<l.length;r++)l[r]=new mt(l[r],t,n);let s=this.multitap;if(s)for(let r=0;r<s.length;r++)s[r]=new mt(s[r],t,n);let c=this.flick;if(c)for(let r in c)c[r]=new mt(c[r],t,n);Kn.determineHint(this,t.defaultHint)}static determineHint(i,t){var n;if(i.hint){i.hintSrc=i;return}if(t!=null&&t.includes("flick-")){if(i.flick){let l=t.substring(6);(n=i.flick[l])!=null&&n.text&&(i.hintSrc=i.flick[l])}return}switch(t){case"none":return;case"multitap":i.multitap&&(i.hintSrc=i.multitap[0]);return;case"flick":if(i.flick){for(let l of Fo)if(i.flick[l]){i.hintSrc=i.flick[l];return}}return;case"longpress":i.sk&&(i.hintSrc=i.sk[0]);return;case"dot":default:i.sk&&(i.hint="•",i.hintSrc=i);return}}};a(Kn,"ActiveKey");var ne=Kn,gs=class gs extends vi{};a(gs,"ActiveSubKey");var mt=gs,it=class it{constructor(){}static sanitize(i){for(let t of i.key)t==null?i.key.length=i.key.length-1:ne.sanitize(t);typeof i.id=="string"&&(i.id=Number.parseInt(i.id,10))}static polyfill(i,t,n,l,s){let c=i.key,r=vi.DEFAULT_KEY;for(let b=0;b<c.length;b++){let I=c[b],F=Object.keys(r);for(let y of F){let Q=y;typeof I[Q]!="string"&&typeof I[Q]!="number"&&(I[Q]=r[Q])}switch(I.sp){case k.special:!it.SPECIAL_LABEL.test(I.text)&&I.text!=""&&(I.sp=k.customSpecial);break;case k.specialActive:!it.SPECIAL_LABEL.test(I.text)&&I.text!=""&&(I.sp=k.customSpecialActive);break}let h=new ne(I,t,n);c[b]=h}let o=a(function(b,I,F,h){b.proportionalPad=I,b.proportionalWidth=F,b.proportionalX=h+I+F/2},"setProportions"),d=0;for(let b=0;b<c.length-1;b++){let I=c[b];o(I,I.pad/l,I.width/l,d),d+=I.proportionalPad,d+=I.proportionalWidth}let u=ne.DEFAULT_RIGHT_MARGIN/l;if(c.length>0){let b=c[c.length-1];if(c.length==1&&b.pad<0){let I=b.width/l,F=1-(d+I+u);o(b,F,I,d)}else{let I=b.pad/l,F=1-(d+I+u);o(b,I,F,d)}}as(i,new it);let B=i;B.proportionalY=s}populateKeyMap(i){this.key.forEach(function(t){t.coreID&&(i[t.coreID]=t)})}};a(it,"ActiveRow"),it.SPECIAL_LABEL=/\*\w+\*/,Qe([ve],it.prototype,"populateKeyMap",1);var wn=it,Tt=class Tt{constructor(){}static sanitize(i){for(let t of i.row)wn.sanitize(t)}static polyfill(i,t){i.aligned=!1;let n=i.row,l=0;for(let r of n){let o=0,d=r.key;for(let u of d)o+=u.width+u.pad;o>l&&(l=o)}t.formFactor=="desktop"?l+=5:l+=ne.DEFAULT_RIGHT_MARGIN;let s=i.row.length;for(let r=0;r<s;r++){let o=(r+.5)/s;wn.polyfill(i.row[r],t,i.id,l,o)}as(i,new Tt);let c=i;c.totalWidth=l,c.defaultKeyProportionalWidth=ne.DEFAULT_KEY.width/l,c.rowProportionalHeight=1/s,c.keyMap=c.constructKeyMap()}constructKeyMap(){let i={};return this.row.forEach(function(t){t.populateKeyMap(i)}),i}getKey(i){i.indexOf(this.id+"-")==0&&(i=i.replace(this.id+"-",""));let t=i.split("::");return t.length>1?this.keyMap[t[0]].getSubkey(t[1]):this.keyMap[i]}};a(Tt,"ActiveLayer"),Qe([ve],Tt.prototype,"constructKeyMap",1),Qe([ve],Tt.prototype,"getKey",1);var Mn=Tt,wt=class wt{constructor(){this.hasFlicks=!1;this.hasLongpresses=!1;this.hasMultitaps=!1}getLayer(i){if(!this.layerMap[i]){let t=this.layer.find(n=>n.id==i);if(!t)return null;Mn.sanitize(t),Mn.polyfill(t,this),this.layerMap[i]=t}return this.layerMap[i]}static correctLayerEmptyRowBug(i){for(let t=0;t<i.length;t++){let l=i[t].row,s;for(s=l.length-1;s>=0;s--)(!Array.isArray(l[s].key)||l[s].key.length==0)&&l.splice(s,1)}}static sanitize(i){wt.correctLayerEmptyRowBug(i.layer)}static polyfill(i,t,n){if(i==null)throw new Error("Cannot build an ActiveLayout for a null specification.");let l={hasFlicks:!1,hasLongpresses:!1,hasMultitaps:!1};this.sanitize(i);for(let r of i.layer)for(let o of r.row)for(let d of o.key)l.hasLongpresses||(l.hasLongpresses=!!d.sk),l.hasFlicks||(l.hasFlicks=!!d.flick),l.hasMultitaps||(l.hasMultitaps=!!d.multitap);let s={};as(i,new wt);let c=i;if(c.keyboard=t,c.formFactor=n,c.layerMap=s,n!="desktop"&&i.layer.find(r=>r.id=="caps")){let r=c.getLayer("default"),o=c.getLayer("shift"),d=r.getKey("K_SHIFT"),u=o==null?void 0:o.getKey("K_SHIFT");d&&u&&!d.multitap&&!u.multitap&&!d.sk&&!u.sk&&(l.hasMultitaps=!0,d.multitap=[G({},E.dfltShiftToCaps),G({},E.dfltShiftToDefault)],u.multitap=[G({},E.dfltShiftToCaps),G({},E.dfltShiftToShift)],d.multitap.forEach((B,b)=>d.multitap[b]=new mt(B,c,"default")),u.multitap.forEach((B,b)=>u.multitap[b]=new mt(B,c,"shift")))}return c.hasFlicks=l.hasFlicks,c.hasLongpresses=l.hasLongpresses,c.hasMultitaps=l.hasMultitaps,c}};a(wt,"ActiveLayout"),Qe([ve],wt.prototype,"getLayer",1);var Mt=wt;var us=class us{constructor(){this.stores={}}};a(us,"CacheTag");var ds=us,zn=(n=>(n[n.NOT_LOADED=void 0]="NOT_LOADED",n[n.POLYFILLED=1]="POLYFILLED",n[n.CALIBRATED=2]="CALIBRATED",n))(zn||{}),Kt=class Kt{constructor(i){i?this.scriptObject=i:this.scriptObject=Kt.DEFAULT_SCRIPT_OBJECT,this.layoutStates={}}process(i,t){return this.scriptObject.gs(i,t)}processNewContextEvent(i,t){return this.scriptObject.gn?this.scriptObject.gn(i,t):!1}processPostKeystroke(i,t){return this.scriptObject.gpk?this.scriptObject.gpk(i,t):!1}get isHollow(){return this.scriptObject==Kt.DEFAULT_SCRIPT_OBJECT}get id(){return this.scriptObject.KI}get name(){return this.scriptObject.KN}get variableStores(){let i=this.scriptObject.KVS,t={};if(Array.isArray(i))for(let n of i)t[n]=this.scriptObject[n];return t}set variableStores(i){let t=this.scriptObject.KVS;if(Array.isArray(t))for(let n of t)typeof i[n]=="string"&&(this.scriptObject[n]=i[n])}get _legacyLayoutSpec(){return this.scriptObject.KV}get _layouts(){return this.scriptObject.KVKL}set _layouts(i){this.scriptObject.KVKL=i}get compilerVersion(){return new K(this.scriptObject.KVER)}get isMnemonic(){return!!this.scriptObject.KM}get definesPositionalOrMnemonic(){return typeof this.scriptObject.KM!="undefined"}get helpText(){return this.scriptObject.KH}get hasScript(){return!!this.scriptObject.KHF}embedScript(i){this.scriptObject.KHF(i)}get oskStyling(){return this.scriptObject.KCSS}get isCJK(){var i;return typeof this.scriptObject.KLC!="undefined"?i=this.scriptObject.KLC:typeof this.scriptObject.LanguageCode!="undefined"&&(i=this.scriptObject.LanguageCode),i=="cmn"||i=="jpn"||i=="kor"}get isRTL(){return!!this.scriptObject.KRTL}get modifierBitmask(){return this.scriptObject.KMBM||C.modifierBitmasks.NON_CHIRAL}get isChiral(){return!!(this.modifierBitmask&C.modifierBitmasks.IS_CHIRAL)}get desktopFont(){return this.scriptObject.KV?this.scriptObject.KV.F:null}get cacheTag(){let i=this.scriptObject._kmw;return i||(i=new ds,this.scriptObject._kmw=i),i}get explodedStores(){return this.cacheTag.stores}get emulatesAltGr(){if(!this.isChiral||this._legacyLayoutSpec==null)return!1;let i=this._legacyLayoutSpec.KLS;if(!i)return!1;var t=m.LCTRLFLAG|m.LALTFLAG,n=i[E.getLayerId(t)],l=i[E.getLayerId(m.K_SHIFTFLAG|t)];if(n!=null&&n!=i[E.getLayerId(m.RALTFLAG)]||l!=null&&l!=i[E.getLayerId(m.RALTFLAG|m.K_SHIFTFLAG)])return!1;var s=this.modifierBitmask;return(s&t)!=t||n==null&&l==null,!0}get usesSupplementaryPlaneChars(){let i=this.scriptObject;return i&&(i.KS&&i.KS==1||i.KN=="Hieroglyphic")}get version(){return this.scriptObject.KBVER||""}usesDesktopLayoutOnDevice(i){return this.scriptObject.KVKL?i.formFactor==W.FormFactor.Desktop:!0}notify(i,t,n){typeof this.scriptObject.KNS=="function"&&this.scriptObject.KNS(i,t,n)}findOrConstructLayout(i){if(this._layouts){if(this._layouts[i]!==void 0)return this._layouts[i];if(i==W.FormFactor.Phone&&this._layouts[W.FormFactor.Tablet])return this._layouts[W.FormFactor.Phone]=this._layouts[W.FormFactor.Tablet];if(i==W.FormFactor.Tablet&&this._layouts[W.FormFactor.Phone])return this._layouts[W.FormFactor.Tablet]=this._layouts[W.FormFactor.Phone]}let t=null;if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.KLS)t=this._legacyLayoutSpec;else if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.BK!=null){for(var n=this._legacyLayoutSpec.BK,l=0;l<n.length;l++)if(n[l].length>0){t=this._legacyLayoutSpec;break}}if(!t&&(this.helpText==""||i!=W.FormFactor.Desktop)&&(t={F:"Tahoma",BK:E.dfltText}),this._layouts||(this._layouts={}),t){let s=this._layouts[i]=E.buildDefaultLayout(t,this,i);return s.isDefault=!0,s}else return this._layouts[i]=null,null}layout(i){let t=this.findOrConstructLayout(i);if(t)if(this.layoutStates[i]==zn.NOT_LOADED){let n=Mt.polyfill(t,this,i);return this.layoutStates[i]=1,n}else return t;else return null}refreshLayouts(){let i=[W.FormFactor.Desktop,W.FormFactor.Phone,W.FormFactor.Tablet],t=this;i.forEach(function(n){t.layoutStates[n]=zn.NOT_LOADED})}markLayoutCalibrated(i){this.layoutStates[i]!=zn.NOT_LOADED&&(this.layoutStates[i]=2)}getLayoutState(i){return this.layoutStates[i]}constructNullKeyEvent(i,t){t=t||{K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};let n=te.constructNullKeyEvent(i);return this.setSyntheticEventDefaults(n,t),n}constructKeyEvent(i,t,n){let l=i.baseKeyEvent;l.device=t,this.isMnemonic&&l.setMnemonicCode(i.layer.indexOf("shift")!=-1,n.K_CAPS),this.setSyntheticEventDefaults(l,n);let c={K_CAPS:C.stateBitmasks.CAPS,K_NUMLOCK:C.stateBitmasks.NUM_LOCK,K_SCROLL:C.stateBitmasks.SCROLL_LOCK}[l.kName];return c&&(l.Lstates^=c,l.LmodifierChange=!0),l}setSyntheticEventDefaults(i,t){i.device.touchable||(i.Lstates=0,i.Lstates|=t.K_CAPS?m.CAPITALFLAG:m.NOTCAPITALFLAG,i.Lstates|=t.K_NUMLOCK?m.NUMLOCKFLAG:m.NOTNUMLOCKFLAG,i.Lstates|=t.K_SCROLL?m.SCROLLFLAG:m.NOTSCROLLFLAG),i.kName&&i.kName.substr(0,2)=="U_"&&(i.LisVirtualKey=!1),typeof i.Lcode=="undefined"&&(i.Lcode=this.getVKDictionaryCode(i.kName),i.Lcode||(i.Lcode=1)),(i.Lmodifiers&C.modifierBitmasks.ALT_GR_SIM)==C.modifierBitmasks.ALT_GR_SIM&&this.emulatesAltGr&&(i.Lmodifiers&=~C.modifierBitmasks.ALT_GR_SIM,i.Lmodifiers|=m.RALTFLAG)}getVKDictionaryCode(i){let t=this.scriptObject.VKDictionary||{};if(!this.scriptObject.VKDictionary){if(typeof this.scriptObject.KVKD=="string"){let s=this.scriptObject.KVKD.split(" ");for(var n=0;n<s.length;n++)t[s[n].toUpperCase()]=n+256}this.scriptObject.VKDictionary=t}let l=t[i.toUpperCase()];return l||0}};a(Kt,"Keyboard"),Kt.DEFAULT_SCRIPT_OBJECT={gs:function(i,t){return!1},KI:"",KN:"",KV:E.DEFAULT_RAW_SPEC,KM:0};var T=Kt;var Hi={osk:C},Bs=class Bs{constructor(i,t){this.loadedKeyboard=null;this._jsGlobal=i,this.keymanGlobal=t,this.install()}KR(i){if(this.loadedKeyboard)throw new Error("Unexpected state:  the most-recently loaded keyboard field was not properly reset.");this.loadedKeyboard=new T(i)}KLOAD(i,t,n){return n}install(){this._jsGlobal.KeymanWeb=this,this._jsGlobal.keyman=this.keymanGlobal}uninstall(){this._jsGlobal.KeymanWeb==this&&delete this._jsGlobal.KeymanWeb,this._jsGlobal.keyman==this.keymanGlobal&&delete this._jsGlobal.keyman}};a(Bs,"KeyboardHarness");var Gt=Bs;var hs=class hs extends Error{constructor(t,n){super(t);this.cause=n}};a(hs,"KeyboardScriptError");var pt=hs,Fs=class Fs extends Error{constructor(t,n){super(t);this.cause=n}};a(Fs,"KeyboardMissingError");var fi=Fs,ys=class ys{constructor(i){this.uri=i}missingError(i){let t=`Cannot find the keyboard at ${this.uri}.`;return new fi(t,i)}scriptError(i){let t=`Error registering the keyboard script at ${this.uri}; it may contain an error.`;return new pt(t,i)}};a(ys,"UriBasedErrorBuilder");var Is=ys,ms=class ms{constructor(i){this.stub=i}missingError(i){let t=this.stub,n=`Cannot find the ${t.name} keyboard for ${t.langName} at ${t.filename}.`;return new fi(n,i)}scriptError(i){let t=this.stub,n=`Error registering the ${t.name} keyboard for ${t.langName}; keyboard script at ${t.filename} may contain an error.`;return new pt(n,i)}};a(ms,"StubBasedErrorBuilder");var bs=ms,Gs=class Gs{get harness(){return this._harness}constructor(i){this._harness=i}loadKeyboardFromPath(i){return this.harness.install(),this.loadKeyboardInternal(i,new Is(i))}loadKeyboardFromStub(i){return this.harness.install(),this.loadKeyboardInternal(i.filename,new bs(i),i.id)}};a(Gs,"KeyboardLoaderBase");var zt=Gs;var yo=(l=>(l.KEYBOARD="keyboard",l.LANGUAGE="language",l.LANGUAGE_KEYBOARD="languageKeyboard",l.BLANK="blank",l))(yo||{}),Ue=yo;function ps(g,i){if(g)return{family:g.family,path:i,files:g.filename||g.source}}a(ps,"internalizeFont");var nt=class nt{static get spacebarTextMode(){return typeof this.spacebarTextModeSrc=="string"?this.spacebarTextModeSrc:this.spacebarTextModeSrc()}static set spacebarTextMode(i){this.spacebarTextModeSrc=i}constructor(i,t){if(typeof i!="string")if(i.KI||i.KL||i.KLC||i.KFont||i.KOskFont){let n=i;this.KI=n.KI,this.KN=n.KN,this.KL=n.KL,this.KLC=n.KLC,this.KFont=n.KFont,this.KOskFont=n.KOskFont,this._displayName=n instanceof nt?n._displayName:n.displayName}else{let n=i;n.languages||(n.languages=n.language),this.KI=n.id,this.KN=n.name,this.KL=n.languages.name,this.KLC=n.languages.id,this.KFont=ps(n.languages.font,t),this.KOskFont=ps(n.languages.oskFont,t)}else this.KI=i,this.KLC=t}static fromMultilanguageAPIStub(i){let t=[];i.languages||(i.languages=i.language);for(let n of i.languages){let l={id:i.id,name:i.name,languages:n};t.push(new nt(l))}return t}get id(){return this.KI}get name(){return this.KN}get langId(){return this.KLC}get langName(){return this.KL}get displayName(){if(this._displayName)return this._displayName;let i=this.KN,t=this.KL;switch(nt.spacebarTextMode){case Ue.KEYBOARD:return i;case Ue.LANGUAGE:return t;case Ue.LANGUAGE_KEYBOARD:return i==t?t:t+" - "+i;case Ue.BLANK:return"";default:return i}}set displayName(i){this._displayName=i}get textFont(){return this.KFont}get oskFont(){return this.KOskFont}validateForOSK(){return this.KLC?this.displayName===void 0||nt.spacebarTextMode!=Ue.BLANK&&!this.displayName?new Error("A display name is missing for this keyboard and cannot be generated under current settings."):null:this.KI||this.KN?new Error(`No language code was specified for use with the ${this.KI||this.KN} keyboard`):new Error("No language code was specified for use with the corresponding keyboard")}validateForCustomKeyboard(){return!this.KI||!this.KN||!this.KL||!this.KLC?new Error("To use a custom keyboard, you must specify keyboard id, keyboard name, language and language code."):null}};a(nt,"KeyboardProperties"),nt.spacebarTextModeSrc=Ue.KEYBOARD;var Te=nt;var mo=a(g=>g.substring(g.length-1)!="/"?g+"/":g,"addDelimiter"),Cs=class Cs{constructor(i,t){t=mo(t),this.sourcePath=t,this.protocol=t.replace(/(.{3,5}:)(.*)/,"$1"),this.updateFromOptions(i)}updateFromOptions(i){let t=this.sourcePath.replace(/(https?:\/\/)([^\/]*)(.*)/,"$1$2/");this._root=t,i.root!=""?this._root=this.fixPath(i.root):this._root=this.fixPath(t);let n=i.resources;n==""&&(n=this.sourcePath),this._resources=this.fixPath(n),this._keyboards=this.fixPath(i.keyboards),this._fonts=this.fixPath(i.fonts)}fixPath(i){return i.length==0||(i=mo(i),i.replace(/^(http)s?:.*/,"$1")=="http"||i.replace(/^(file):.*/,"$1")=="file")?i:i.substring(0,2)=="//"?this.protocol+i:i.substring(0,1)=="/"?this.root+i.substring(1):this.sourcePath+i}get fonts(){return this._fonts}updateFontPath(i){this._fonts=this.fixPath(i)}get root(){return this._root}get resources(){return this._resources}get keyboards(){return this._keyboards}};a(Cs,"PathConfiguration");var Dt=Cs;var Qs={root:"",resources:"",keyboards:"",fonts:""};var Us=class Us{constructor(i,t){this.suggestions=i,this.transcriptionID=t}};a(Us,"ReadySuggestions");var Ct=Us;var xs=class xs extends S.default{constructor(t,n){super();this.initNewContext=!0;this._currentSuggestions=[];this.swallowPrediction=!1;this.doRevert=!1;this.recentRevert=!1;this.doTryAccept=a((t,n)=>{let l=this.recentAcceptCause;if(!l&&this.selected)this.accept(this.selected),n.shouldSwallow=!this.currentTarget.getTextAfterCaret(),this.recentAcceptCause="key";else if(l&&t=="space"){if(this.recentAcceptCause=null,l=="key"){n.shouldSwallow=!1;return}n.shouldSwallow=!!this.langProcessor.wordbreaksAfterSuggestions&&!this.currentTarget.getTextAfterCaret()}else n.shouldSwallow=!1},"doTryAccept");this.doTryRevert=a(()=>{this.doRevert?(this.doRevert=!1,this.recentAcceptCause=null):this.recentAcceptCause&&(this.showRevert(),this.swallowPrediction=!0)},"doTryRevert");this.invalidateSuggestions=a(t=>{this.initNewContext=!1,this.selected=null,(!this.swallowPrediction||t=="context")&&(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1,t=="context"&&(this.swallowPrediction=!1,this.initNewContext=!0)),t!="new"&&this.clearSuggestions()},"invalidateSuggestions");this.updateSuggestions=a(t=>{let n=t.suggestions;this._currentSuggestions=n,this.selected=null,this.keepSuggestion=null;for(let l of n)l.tag=="keep"&&(this.keepSuggestion=l),l.autoAccept&&!this.selected&&(this.selected=l);this.keepSuggestion&&this._currentSuggestions.splice(this._currentSuggestions.indexOf(this.keepSuggestion),1),this.swallowPrediction?this.swallowPrediction=!1:(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1),this.sendUpdateEvent()},"updateSuggestions");this.onModelStateChange=a(t=>{(t=="configured"||t=="inactive")&&this.resetContext()},"onModelStateChange");this.langProcessor=t,this.getLayerId=n;let l=a(()=>this.currentTarget&&t.state=="configured","validSuggestionState");this.suggestionApplier=s=>l()?t.applySuggestion(s,this.currentTarget,n):null,this.suggestionReverter=s=>R(this,null,function*(){if(l()){let c=yield t.applyReversion(s,this.currentTarget);this.swallowPrediction=!0,this.updateSuggestions(new Ct(c,s.id?-s.id:void 0))}}),this.connect()}get currentTarget(){return this._currentTarget}setCurrentTarget(t){let n=this._currentTarget;return this._currentTarget=t,n!=t?this.resetContext():Promise.resolve([])}connect(){this.langProcessor.addListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.addListener("suggestionsready",this.updateSuggestions),this.langProcessor.addListener("tryaccept",this.doTryAccept),this.langProcessor.addListener("tryrevert",this.doTryRevert),this.langProcessor.addListener("statechange",this.onModelStateChange)}disconnect(){this.langProcessor.removeListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.removeListener("suggestionsready",this.updateSuggestions),this.langProcessor.removeListener("tryaccept",this.doTryAccept),this.langProcessor.removeListener("tryrevert",this.doTryRevert),this.langProcessor.removeListener("statechange",this.onModelStateChange),this.clearSuggestions()}get currentSuggestions(){let t=[],n=this.activateKeep()&&this.keepSuggestion,l=this.selected&&this.keepSuggestion!=this.selected;return n&&(l||this.keepSuggestion.matchesModel)?t.push(this.keepSuggestion):this.doRevert&&t.push(this.revertSuggestion),t.concat(this._currentSuggestions)}acceptInternal(t){return t?t.tag=="revert"?(this.suggestionReverter(t),null):this.suggestionApplier(t):null}accept(t){let n=this;return this.selected=null,this.doRevert=!1,this.revertAcceptancePromise=this.acceptInternal(t),this.revertAcceptancePromise?(this.revertAcceptancePromise.then(function(l){l&&(n.revertSuggestion=l)}),this.recentAcceptCause="banner",this.recentRevert=!1,this.swallowPrediction=!0,this.revertAcceptancePromise):(t&&t.tag=="revert"&&(this.recentAcceptCause=null,this.recentRevert=!0),Promise.resolve(null))}showRevert(){this.doRevert=!0,this.sendUpdateEvent()}clearSuggestions(){this.updateSuggestions({suggestions:[],transcriptionID:0})}activateKeep(){return!this.recentAcceptCause&&!this.recentRevert&&!this.initNewContext}sendUpdateEvent(){this.emit("update",this.currentSuggestions)}resetContext(){let t=this.currentTarget;return t?this.langProcessor.invalidateContext(t,this.getLayerId()):Promise.resolve([])}};a(xs,"PredictionContext");var Qt=xs;var Dn=class Dn{constructor(i){i.OS==W.OperatingSystem.Android?this.popupCanvasBackgroundColor="#999":this.popupCanvasBackgroundColor=Dn.prefersDarkMode()?"#0f1319":"#ffffff"}static prefersDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}};a(Dn,"StyleConstants");var Li=Dn;var Zs=class Zs{constructor(){this.touchable="ontouchstart"in window,this.OS="",this.formFactor="desktop",this.browser="",this.dyPortrait=0,this.dyLandscape=0,this.version="0",this.orientation=window.orientation}getDPI(){var i=document.createElement("DIV"),t=i.style,n=96;return document.readyState!=="complete"||(i.id="calculateDPI",t.position="absolute",t.display="block",t.visibility="hidden",t.left="10px",t.top="10px",t.width="1in",t.height="10px",document.body.appendChild(i),n=typeof window.devicePixelRatio=="undefined"?i.offsetWidth:i.offsetWidth*window.devicePixelRatio,document.body.removeChild(i)),n}detect(){var i=!1;if(navigator&&navigator.userAgent){var t=navigator.userAgent;if(t.indexOf("iPad")>=0)this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;else if(t.indexOf("iPhone")>=0)this.OS="iOS",this.formFactor="phone",this.dyPortrait=this.dyLandscape=25;else if(t.indexOf("Android")>=0){this.OS="Android",this.formFactor="phone",this.dyPortrait=75,this.dyLandscape=25;try{var n=new RegExp("(?:Android\\s+)(\\d+\\.\\d+\\.\\d+)");this.version=t.match(n)[1]}catch(d){}}else if(t.indexOf("Linux")>=0)this.OS="Linux";else if(t.indexOf("Macintosh")>=0){let u=/Intel Mac OS X (\d+(?:[_\.]\d+)+)/i.exec(t);if(!u)console.warn("KMW could not properly parse the user agent string.A suboptimal keyboard layout may result."),this.OS="MacOSX";else if(u.length>1&&u[1]){let B=u[1].replace("_","."),b=new K(B);i=K.MAC_POSSIBLE_IPAD_ALIAS.compareTo(b)<=0,this.OS="MacOSX"}}else t.indexOf("Windows NT")>=0&&(this.OS="Windows",t.indexOf("Touch")>=0&&(this.formFactor="phone"),typeof navigator.msMaxTouchPoints=="number"&&navigator.msMaxTouchPoints>0&&(this.touchable=!0))}let l=Math.min(screen.width,screen.height),s=Math.max(screen.width,screen.height),c=l/s;this.OS!="iOS"&&this.formFactor=="phone"&&(l>=600&&c>.5625||c>=.625)&&(this.formFactor="tablet");let r=navigator.platform=="Win32"||navigator.platform=="MacIntel";this.OS=="iOS"&&!("ongesturestart"in window)&&!r&&(this.OS="Android"),this.browser="web",(this.OS=="iOS"||this.OS.toLowerCase()=="macosx")&&(this.browser="safari");var o=/Firefox|Chrome|OPR|Safari|Edge/;if(o.test(navigator.userAgent)&&(navigator.userAgent.indexOf("Firefox")>=0&&"onmozorientationchange"in screen?this.browser="firefox":navigator.userAgent.indexOf("OPR")>=0?this.browser="opera":navigator.userAgent.indexOf(" Edge/")>=0?this.browser="edge":navigator.userAgent.indexOf("Chrome")>=0?this.browser="chrome":navigator.userAgent.indexOf("Safari")>=0&&(this.browser="safari")),i&&this.browser=="safari"&&window.TouchEvent){this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;let d=screen.height/screen.width;d<1&&(d=1/d),d>1.6&&(this.formFactor="phone",this.dyPortrait=this.dyLandscape=25)}return this.colorScheme=Li.prefersDarkMode()?"dark":"light",this.coreSpec}get coreSpec(){return new W(this.browser,this.formFactor,this.OS,this.touchable)}};a(Zs,"DeviceDetector");var Ut=Zs;var Vs=class Vs extends S.default{constructor(t,n){super();this.applyCacheBusting=!1;if(!n){let l=new Ut;l.detect(),n=l.coreSpec}this.sourcePath=t,this.hostDevice=n,this.deferForInitialization=new v}initialize(t){this._paths?this._paths.updateFromOptions(t):this._paths=new Dt(t,this.sourcePath),typeof t.setActiveOnRegister=="boolean"?this.activateFirstKeyboard=t.setActiveOnRegister:this.activateFirstKeyboard=!0,this._spacebarText=t.spacebarText,Te.spacebarTextMode=()=>this.spacebarText}finalizeInit(){this.deferForInitialization.resolve()}get paths(){return this._paths}get spacebarText(){return this._spacebarText}set spacebarText(t){this._spacebarText!=t&&(this._spacebarText=t,this.emit("spacebartext",t))}get softDevice(){return this.hostDevice}get hardDevice(){return cs(this.hostDevice)}get stubNamespacer(){return this._stubNamespacer}set stubNamespacer(t){this._stubNamespacer=t}debugReport(){return{hostDevice:this.hostDevice,initialized:this.deferForInitialization.isResolved}}onRuleFinalization(t,n){}};a(Vs,"EngineConfiguration");var Ji=Vs,Xs=G({setActiveOnRegister:!0,spacebarText:Ue.LANGUAGE_KEYBOARD},Qs);var ki=class ki extends S.default{constructor(t){super();this.pendingActivations=[];this.engineConfig=t}get predictionContext(){return this._predictionContext}configure(t){this._resetContext=t.resetContext,this._predictionContext=t.predictionContext,this.keyboardCache=t.keyboardCache}insertText(t,n,l){let s=this.activeTarget;return s!=null?(n!=null&&t.output(0,s,n),typeof l!="undefined"&&l!==null&&t.deadkeyOutput(0,s,l),s.invalidateSelection(),!0):!1}resetContext(){this._resetContext(this.activeTarget),this.predictionContext.resetContext()}findAndPopActivation(t){let n;for(n=0;n<this.pendingActivations.length&&this.pendingActivations[n].target!=t;n++);return n==this.pendingActivations.length?null:this.pendingActivations.splice(n,1)[0]}deferredKeyboardActivation(t,n,l){return R(this,null,function*(){let s={target:l,keyboard:t,stub:n};this.findAndPopActivation(l),this.pendingActivations.push(s),yield t;let c=this.findAndPopActivation(l);return c==s?s:(c&&this.pendingActivations.push(c),null)})}activateKeyboard(t,n,l){return R(this,null,function*(){let s=!this.activeKeyboard;this.findAndPopActivation(this.currentKeyboardSrcTarget());let c=this.prepareKeyboardForActivation(t,n),r=this.currentKeyboardSrcTarget(),o=yield c.keyboard;if(o==null&&c.metadata)return!1;this.currentKeyboardSrcTarget()==r&&this.emit("beforekeyboardchange",c.metadata);let d=null;return o&&(d={keyboard:o,metadata:c.metadata}),this.activateKeyboardForTarget(d,r),this.currentKeyboardSrcTarget()==r&&(!s||o)&&this.emit("keyboardchange",this.activeKeyboard),!0})}prepareKeyboardForActivation(t,n){var c;n||(n="");let l=null;if(t?l=this.keyboardCache.getStub(t,n):n=="",!l){if(t)throw new Error("No matching stub has been registered.");return{keyboard:Promise.resolve(null),metadata:null}}if((c=this.activeKeyboard)!=null&&c.metadata&&t==this.activeKeyboard.metadata.id){let r=this.activeKeyboard.keyboard;return{keyboard:Promise.resolve(r),metadata:l}}let s;if(s=this.keyboardCache.getKeyboardForStub(l))return{keyboard:Promise.resolve(s),metadata:l};{this.emit("beforekeyboardchange",l);let r=this.engineConfig.deferForInitialization.then(()=>{let d=new v;this.emit("keyboardasyncload",l,d.corePromise);let u=this.keyboardCache.fetchKeyboardForStub(l),B=new Promise((I,F)=>{let h=`Sorry, the ${l.name} keyboard for ${l.langName} is not currently available.`;window.setTimeout(()=>F(new Error(h)),ki.TIMEOUT_THRESHOLD)}),b=Promise.race([u,B]);return b.then(()=>{d.resolve(null),B.catch(()=>{})}),b.catch(I=>{throw d.resolve(I),I}),b});return{keyboard:this.deferredKeyboardActivation(r,l,this.currentKeyboardSrcTarget()).then(d=>R(this,null,function*(){return d?r:Promise.resolve(null)})),metadata:l}}}};a(ki,"ContextManagerBase"),ki.TIMEOUT_THRESHOLD=1e4;var Ni=ki;var Ws=class Ws extends S.default{};a(Ws,"HardKeyboard");var Ot=Ws;function Ss(g,i,t){if(i&&i.isMnemonic&&g.setMnemonicCode(!!(g.Lmodifiers&m.K_SHIFTFLAG),!!(g.Lmodifiers&m.CAPITALFLAG)),i&&!i.isMnemonic){var n=ie.languageMap[t];n&&n["k"+g.Lcode]&&(g.Lcode=n["k"+g.Lcode]),!i.definesPositionalOrMnemonic&&!(g.Lmodifiers&C.modifierBitmasks.NON_LEGACY)&&!g.isModifier&&(g=new te({Lcode:ie._USKeyCodeToCharCode(g),Lmodifiers:0,LisVirtualKey:!1,vkCode:g.Lcode,Lstates:g.Lstates,kName:"",device:g.device,isSynthetic:!1}))}return g}a(Ss,"processForMnemonicsAndLegacy");function As(g,i,t){let n=Math.min(g.length,i.length),l,s,c,r,o;for(t?(l=s=g.length-1,c=s-n,r=-1,o=i.length-g.length):(l=s=0,c=n,r=1,o=0);s!=c&&g.charAt(s)==i.charAt(s+o);s+=r);if(s!=l&&s!=c){let d=g.charCodeAt(s-r),u=g.charCodeAt(s),B=i.charCodeAt(s+o),b=t?En:Yn,I=t?Yn:En;if(b(d)&&(I(u)||I(B)))return s-r}return s}a(As,"findCommonSubstringEndIndex");var xt=class xt{constructor(i,t){this.p=i,this.d=t,this.o=xt.ordinalSeed++}match(i,t){var n=this.p==i&&this.d==t;return n}set(){this.matched=1}reset(){this.matched=0}before(i){return this.o<i.o}clone(){let i=new xt(this.p,this.d);return i.o=this.o,i}equal(i){return this.d==i.d&&this.p==i.d&&this.o==i.o}};a(xt,"Deadkey"),xt.ordinalSeed=0,xt.sortFunc=a(function(i,t){return i.p!=t.p?t.p-i.p:t.o-i.o},"sortFunc");var Yi=xt,Pn=class Pn{constructor(){this.dks=[]}toSortedArray(){return this.dks=this.dks.sort(Yi.sortFunc),[].concat(this.dks)}clone(){let i=new Pn,t=this.toSortedArray();return i.dks=[],t.forEach(function(n){i.dks.push(n.clone())}),i}isMatch(i,t,n){if(this.dks.length==0)return!1;var l=i;t=l-t;for(var s=0;s<this.dks.length;s++)if(this.dks[s].match(t,n)&&!this.dks[s].matched)return this.dks[s].set(),!0;return this.resetMatched(),!1}add(i){this.dks=this.dks.concat(i)}remove(i){var t=this.dks.indexOf(i);this.dks.splice(t,1)}clear(){this.dks=[]}resetMatched(){for(let i of this.dks)i.reset()}deleteMatched(){for(var i=0;i<this.dks.length;i++)this.dks[i].matched&&this.dks.splice(i--,1)}adjustPositions(i,t){if(t!=0)for(let n of this.dks)n.p>i&&(n.p+=t)}equal(i){if(this.dks.length!=i.dks.length)return!1;let t=i.dks,n=[];for(let l of this.dks)if(!t.find(c=>l.equal(c)))return!1;return n.length==t.length}count(){return this.dks.length}};a(Pn,"DeadkeyTracker");var On=Pn;Ri();function Zt(g){var i;return g?g.insert===""&&g.deleteLeft===0&&((i=g.deleteRight)!=null?i:0)===0:!0}a(Zt,"isEmptyTransform");var Ei=class Ei{constructor(i,t,n,l){this.insert=i,this.deleteLeft=t,this.deleteRight=n,this.erasedSelection=l}};a(Ei,"TextTransform"),Ei.nil=new Ei("",0,0,!1);var Rs=Ei,Ti=class Ti{constructor(i,t,n,l){let s=this.token=Ti.tokenSeed++;this.keystroke=i,this.transform=t,this.alternates=l,this.preInput=n,this.transform.id=this.token,l&&l.forEach(function(c){c.sample.id=s})}};a(Ti,"Transcription"),Ti.tokenSeed=0;var vs=Ti,Hs=class Hs{constructor(){this._dks=new On}get isSynthetic(){return!0}resetContext(){this.deadkeys().clear()}deadkeys(){return this._dks}hasDeadkeyMatch(i,t){return this.deadkeys().isMatch(this.getDeadkeyCaret(),i,t)}insertDeadkeyBeforeCaret(i){var t=new Yi(this.getDeadkeyCaret(),i);this.deadkeys().add(t)}adjustDeadkeys(i){this.deadkeys().adjustPositions(this.getDeadkeyCaret(),i)}setDeadkeys(i){this._dks=i.clone()}buildTransformFrom(i){let t=this.getTextBeforeCaret(),n=i.getTextBeforeCaret(),l=As(n,t,!1),s=n.substring(l)._kmwLength(),c=t.substring(l),r=this.getTextAfterCaret(),o=i.getTextAfterCaret(),d=As(o,r,!0),u=o.substring(0,d+1)._kmwLength();return new Rs(c,s,u,i.getSelectedText()&&!this.getSelectedText())}buildTranscriptionFrom(i,t,n,l){let s=this.buildTransformFrom(i);return new vs(t,s,N.from(i,n),l)}restoreTo(i){this.clearSelection(),this.setTextBeforeCaret(i.getTextBeforeCaret()),this.setTextAfterCaret(i.getTextAfterCaret()),this._dks=i._dks.clone()}apply(i){this.clearSelection(),i.deleteRight&&this.setTextAfterCaret(this.getTextAfterCaret()._kmwSubstr(i.deleteRight)),i.deleteLeft&&this.deleteCharsBeforeCaret(i.deleteLeft),i.insert&&this.insertTextBeforeCaret(i.insert),this._dks.clear()}setTextBeforeCaret(i){this.deleteCharsBeforeCaret(this.getTextBeforeCaret()._kmwLength()),this.insertTextBeforeCaret(i)}saveProperties(){}restoreProperties(){}};a(Hs,"OutputTarget");var lt=Hs;var Pt=class Pt extends lt{constructor(t,n,l){super();this.selForward=!0;this.text=t||"";var s=this.text._kmwLength();this.selStart=typeof n=="number"?n:s,this.selEnd=typeof l=="number"?l:this.selStart,this.selForward=this.selEnd>=this.selStart}static from(t,n){let l;if(t instanceof Pt){let s=t;l=new Pt(s.text,s.selStart,s.selEnd)}else{let s=t.getText(),c=s._kmwLength(),r=c,o=0;if(t.hasSelection()){let d=t.getTextBeforeCaret(),u=t.getTextAfterCaret();r=d._kmwLength(),o=c-u._kmwLength()}l=new Pt(s,r,o)}return l.setDeadkeys(t.deadkeys()),l}clearSelection(){this.text=this.getTextBeforeCaret()+this.getTextAfterCaret(),this.selEnd=this.selStart,this.selForward=!0}invalidateSelection(){}isSelectionEmpty(){return this.selStart==this.selEnd}hasSelection(){return!0}getDeadkeyCaret(){return this.selStart}setSelection(t,n){if(this.selStart=t,this.selEnd=typeof n=="number"?n:t,this.selForward=n>=t,!this.selForward){let l=this.selStart;this.selStart=this.selEnd,this.selEnd=l}}getTextBeforeCaret(){return this.text.kmwSubstr(0,this.selStart)}getSelectedText(){return this.text.kmwSubstr(this.selStart,this.selEnd-this.selStart)}getTextAfterCaret(){return this.text.kmwSubstr(this.selEnd)}getText(){return this.text}deleteCharsBeforeCaret(t){t>=0&&(t>this.selStart&&(t=this.selStart),this.adjustDeadkeys(-t),this.text=this.text.kmwSubstr(0,this.selStart-t)+this.text.kmwSubstr(this.selStart),this.selStart-=t,this.selEnd-=t)}insertTextBeforeCaret(t){this.adjustDeadkeys(t._kmwLength()),this.text=this.getTextBeforeCaret()+t+this.text.kmwSubstr(this.selStart),this.selStart+=t.kmwLength(),this.selEnd+=t.kmwLength()}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}setTextAfterCaret(t){this.text=this.getTextBeforeCaret()+t}isEqual(t){return this.text==t.text&&this.selStart==t.selStart&&this.selEnd==t.selEnd&&this.deadkeys().equal(t.deadkeys())}doInputEvent(){}};a(Pt,"Mock");var N=Pt;var fs=class fs{constructor(){this.transcription=null;this.setStore={};this.saveStore={};this.variableStores={};this.triggersDefaultCommand=!1}finalize(i,t,n){if(!this.transcription)throw"Cannot finalize a RuleBehavior with no transcription.";i.beepHandler&&this.beep&&i.beepHandler(t);for(let l in this.setStore){let s=i.keyboardInterface.systemStores[l];if(s)try{s.set(this.setStore[l])}catch(c){i.errorLogger&&i.errorLogger("Rule attempted to perform illegal operation - 'platform' may not be changed.")}else i.warningLogger&&i.warningLogger("Unknown store affected by keyboard rule: "+l)}if(i.keyboardInterface.applyVariableStores(this.variableStores),i.keyboardInterface.variableStoreSerializer)for(let l in this.saveStore)i.keyboardInterface.variableStoreSerializer.saveStore(i.activeKeyboard.id,l,this.saveStore[l]);if(this.triggersDefaultCommand){let l=this.transcription.keystroke;i.defaultRules.applyCommand(l,t)}i.warningLogger&&this.warningLog?i.warningLogger(this.warningLog):i.errorLogger&&this.errorLog&&i.errorLogger(this.errorLog)}mergeInDefaults(i){let t=this.transcription.keystroke,n=i.transcription.keystroke;if(t.Lcode!=n.Lcode||t.Lmodifiers!=n.Lmodifiers)throw"RuleBehavior default-merge not supported unless keystrokes are identical!";this.triggersDefaultCommand=this.triggersDefaultCommand||i.triggersDefaultCommand;let l=N.from(this.transcription.preInput,!1);l.apply(this.transcription.transform),l.apply(i.transcription.transform),this.transcription=l.buildTranscriptionFrom(this.transcription.preInput,t,!1,this.transcription.alternates)}};a(fs,"RuleBehavior");var le=fs;var Ls=class Ls{constructor(i){this.id=i}set(i){throw new Error("System store with ID "+this.id+" may not be directly set.")}};a(Ls,"SystemStore");var jn=Ls,Js=class Js extends jn{constructor(t,n){super(t);this.handler=null;this._value=n}get value(){return this._value}matches(t){return this._value==t}set(t){this.handler&&this.handler(this,t)||(this._value=t)}};a(Js,"MutableSystemStore");var jt=Js,ks=class ks extends jn{constructor(t){super(31);this.kbdInterface=t}matches(t){var n,l,s=t.split(" ");let c=this.kbdInterface.activeDevice;for(n=0;n<s.length;n++)switch(l=s[n].toLowerCase(),l){case"touch":case"hardware":if(c.touchable!=(l=="touch"))return!1;break;case"macos":case"mac":l="macosx";case"macosx":case"windows":case"android":case"ios":case"linux":if(c.OS!=l)return!1;break;case"tablet":case"phone":case"desktop":if(c.formFactor!=l)return!1;break;case"web":if(c.browser=="native")return!1;break;case"native":case"chrome":case"firefox":case"safari":case"edge":case"opera":if(c.browser!=l)return!1;break;default:return!1}return!0}};a(ks,"PlatformSystemStore");var _n=ks;var Ts=class Ts{};a(Ts,"KeyInformation");var Ns=Ts;var ws=class ws{reset(){this._cache=[]}get(i,t){return typeof this._cache[i]=="undefined"||typeof this._cache[i][t]=="undefined"?null:this._cache[i][t]}set(i,t,n){typeof this._cache[i]=="undefined"&&(this._cache[i]=[]),this._cache[i][t]=n}};a(ws,"CachedContext");var Ys=ws,qn=class qn{reset(){this._cache=[]}get(i,t){return typeof this._cache[i]=="undefined"||typeof this._cache[i][t]=="undefined"?null:this._cache[i][t]}set(i,t,n){typeof this._cache[i]=="undefined"&&(this._cache[i]=[]),this._cache[i][t]=n}clone(){let i=new qn;return i._cache=this._cache,i}};a(qn,"CachedContextEx");var Es=qn,wi=class wi extends Gt{constructor(t,n,l=null){super(t,n);this.cachedContext=new Ys;this.cachedContextEx=new Es;this._AnyIndices=[];this.systemStores={},this.systemStores[31]=new _n(this),this.systemStores[33]=new jt(33,"default"),this.systemStores[42]=new jt(42,""),this.systemStores[43]=new jt(43,""),this.variableStoreSerializer=l}get Codes(){return C}saveFocus(){}registerKeyboard(t){let n=new T(t);this.loadedKeyboard=n}context(t,n,l){var s=this.cachedContext.get(t,n);if(s!==null)return s;var c=this.KC_(t,n,l);return this.cachedContext.set(t,n,c),c}KC_(t,n,l){var s="";return s=l.isSelectionEmpty()?l.getTextBeforeCaret():"",s._kmwLength()<t&&(s=Array(t-s._kmwLength()+1).join("￾")+s),s._kmwSubstr(-t)._kmwSubstr(0,n)}nul(t,n){var l=this.context(t+1,1,n);return l==="￾"}contextMatch(t,n,l,s){var c=this.context(t,s,n);return c===l?!0:(n.deadkeys().resetMatched(),!1)}_BuildExtendedContext(t,n,l){var s=this.cachedContextEx.get(t,n);if(s!==null)return s;if(s=this.cachedContextEx.get(t,t),s===null){let b=l.deadkeys().toSortedArray();var c=0;for(s={valContext:[],deadContext:[]};s.valContext.length<t;){var r=l.getDeadkeyCaret(),o=r-c;if(b.length>0&&b[0].p>o){b.splice(0,1);continue}else if(b.length>0&&b[0].p==o)s.deadContext[t-s.valContext.length-1]=b[0],s.valContext=[b[0].d].concat(s.valContext),b.splice(0,1);else{var d=this.context(++c,1,l);s.valContext=[d].concat(s.valContext)}}this.cachedContextEx.set(t,t,s)}var u=s;u.valContext=u.valContext.slice(0,n);for(var B=0;B<u.valContext.length;B++)u.valContext[B]=="￾"&&(u.valContext.splice(0,1),u.deadContext.splice(0,1));return u.valContext.length==0&&(u.valContext=["￾"],u.deadContext=[]),this.cachedContextEx.set(t,n,u),u}fullContextMatch(t,n,l){var s=this._BuildExtendedContext(t,l.length,n);this.ruleContextEx=this.cachedContextEx.clone();var c=s.valContext,r=s.deadContext,o=!1;let d="￾";for(var u=a(function(Q){throw new Error("Unexpected object in fullContextMatch specification: "+Q)},"assertNever"),B=0;B<l.length;B++)if(typeof l[B]=="string"){var b=l[B];if(b!==c[B]){o=!0;break}}else{var I=l[B];switch(I.t){case"d":I.d!==c[B]?o=!0:r[B].set();break;case"a":var F;typeof c[B]=="string"?F=c[B]:F={t:"d",d:c[B]};var h=this.any(B,F,I.a);I.n?I.n&&(h||c[B]===d)&&(o=!0):h?r[B]!==void 0&&r[B].set():o=!0;break;case"i":var y=this._Index(I.i,I.o);y!==void 0&&(typeof y=="string"?y:y.d)!==c[B]?o=!0:r[B]!==void 0&&r[B].set();break;case"c":c[I.c-1]!==c[B]?o=!0:r[B]!==void 0&&r[B].set();break;case"n":c[B]!=d&&(o=!0);break;default:u(I)}}return o&&(n.deadkeys().resetMatched(),this._AnyIndices=[]),!o}isKeypress(t){return this.activeKeyboard.isMnemonic?!t.LisVirtualKey:!!ie._USKeyCodeToCharCode(t)}static matchModifiersToRuleChirality(t,n){let l=m.LALTFLAG|m.RALTFLAG,s=m.LCTRLFLAG|m.RCTRLFLAG,c=t;if(!(n&l)){let r=c&l;r&&(c^=r|m.K_ALTFLAG)}if(!(n&s)){let r=c&s;r&&(c^=r|m.K_CTRLFLAG)}return c}keyMatch(t,n,l){var s=!1,c=t.Lcode==173?189:t.Lcode;let r=this.activeKeyboard.modifierBitmask;var o=r&C.modifierBitmasks.ALL,d=r&C.stateBitmasks.ALL;let u=wi.matchModifiersToRuleChirality(t.Lmodifiers,n);return t.vkCode>255&&(c=t.vkCode),t.LisVirtualKey||c>255?((n&16384)==16384||c>255)&&(s=l==c&&(n&o)==u,s=s&&this.stateMatch(t,n&d)):n&16384||(s=c==l),s||this.activeTargetOutput.deadkeys().resetMatched(),s}stateMatch(t,n){return(n&t.Lstates)==n}keyInformation(t){var n=new Ns;return n.vk=t.LisVirtualKey,n.code=t.Lcode,n.modifiers=t.Lmodifiers,n}deadkeyMatch(t,n,l){return n.hasDeadkeyMatch(t,l)}beep(t){this.resetContextCache(),this.ruleBehavior.beep=!0}_ExplodeStore(t){if(typeof t=="string"){let s=this.activeKeyboard.explodedStores;if(s[t])return s[t];for(var n=[],l=0;l<t._kmwLength();l++)n.push(t._kmwCharAt(l));return s[t]=n,n}else return t}any(t,n,l){if(n=="")return!1;l=this._ExplodeStore(l);for(var s=-1,c=0;c<l.length;c++){let r=l[c];if(typeof r=="string"){if(l[c]==n){s=c;break}}else if(r.d===n.d){s=c;break}}return this._AnyIndices[t]=s,s>=0}_Index(t,n){return t=this._ExplodeStore(t),this._AnyIndices[n-1]<t.length?t[this._AnyIndices[n-1]]:(console.warn("Unmatched contextual index() statement detected in rule with index "+n+"!"),"")}indexOutput(t,n,l,s){this.resetContextCache();var c=a(function(o){throw new Error("Unexpected object in fullContextMatch specification: "+o)},"assertNever"),r=this._Index(n,l);if(r!=="")if(typeof r=="string")this.output(t,s,r);else if(r.t)switch(r.t){case"b":this.beep(s);break;case"d":this.deadkeyOutput(t,s,r.d);break;default:c(r)}else this.deadkeyOutput(t,s,r.d)}deleteContext(t,n){var l;if(t>0){l=this._BuildExtendedContext(t,t,n);let r=0;for(var s=0;s<l.valContext.length;s++){var c=l.deadContext[s];c?(n.deadkeys().remove(c),t--):l.valContext[s]=="￾"&&r++}let o=l.valContext.length-r;t>o&&(t=o)}n.deadkeys().resetMatched(),this.output(t,n,"")}output(t,n,l){this.resetContextCache(),n.saveProperties(),n.clearSelection(),n.deadkeys().deleteMatched(),t>=0&&n.deleteCharsBeforeCaret(t),n.insertTextBeforeCaret(l),n.restoreProperties()}contextExOutput(t,n,l,s){this.resetContextCache(),t>=0&&this.output(t,n,"");let c=this.ruleContextEx.get(l,l),r=c.deadContext[s-1],o=c.valContext[s-1];if(r)n.insertDeadkeyBeforeCaret(r.d);else if(typeof o=="string")this.output(-1,n,o);else throw new Error("contextExOutput: should never be a numeric valContext with no corresponding deadContext")}deadkeyOutput(t,n,l){this.resetContextCache(),t>=0&&this.output(t,n,""),n.insertDeadkeyBeforeCaret(l)}ifStore(t,n,l){var s=!0;let c=this.systemStores[t];return c&&(s=c.matches(n)),s}setStore(t,n,l){return this.resetContextCache(),t==33&&this.activeDevice.touchable?(this.ruleBehavior.setStore[t]=n,!0):!1}loadStore(t,n,l){return this.resetContextCache(),this.variableStoreSerializer&&this.variableStoreSerializer.loadStore(t,n)[n]||l}saveStore(t,n){this.resetContextCache();var l=this.activeKeyboard;if(!l||typeof l.id=="undefined"||l.id=="")return!1;let s={};return s[t]=n,this.ruleBehavior?this.ruleBehavior.saveStore[t]=s:this.variableStoreSerializer.saveStore(this.activeKeyboard.id,t,s),!0}resetContextCache(){this.cachedContext.reset(),this.cachedContextEx.reset()}defaultBackspace(t){t.isSelectionEmpty()?this.output(1,t,""):this.output(0,t,"")}processNewContextEvent(t,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processNewContextEvent.bind(this.activeKeyboard),t,n,!0)}processPostKeystroke(t,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processPostKeystroke.bind(this.activeKeyboard),t,n,!0)}processKeystroke(t,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.process.bind(this.activeKeyboard),t,n,!1)}process(t,n,l,s){if(n)if(this.activeKeyboard){if(!t)throw"No callee for keystroke processing!"}else throw"No active keyboard for keystroke processing!";else throw"No target specified for keyboard output!";n.invalidateSelection(),n.deadkeys().resetMatched(),this.resetContextCache();let c=N.from(n,!0),r=this.activeKeyboard.variableStores;this.ruleBehavior=new le,this.activeDevice=l.device,this.activeTargetOutput=n;var o=t(n,l);this.activeTargetOutput=null,this.ruleBehavior.transcription=n.buildTranscriptionFrom(c,l,s),this.ruleBehavior.variableStores=this.activeKeyboard.variableStores,this.activeKeyboard.variableStores=r,this.ruleBehavior.triggerKeyDefault=!o;let d=this.ruleBehavior;return this.ruleBehavior=null,d}applyVariableStores(t){this.activeKeyboard.variableStores=t}static __publishShorthandAPI(){let t=this.prototype;var n=a(function(l,s){t[s]&&(t[l]=t[s])},"exportKBCallback");n("KSF","saveFocus"),n("KBR","beepReset"),n("KT","insertText"),n("KR","registerKeyboard"),n("KRS","registerStub"),n("KC","context"),n("KN","nul"),n("KCM","contextMatch"),n("KFCM","fullContextMatch"),n("KIK","isKeypress"),n("KKM","keyMatch"),n("KSM","stateMatch"),n("KKI","keyInformation"),n("KDM","deadkeyMatch"),n("KB","beep"),n("KA","any"),n("KDC","deleteContext"),n("KO","output"),n("KDO","deadkeyOutput"),n("KCXO","contextExOutput"),n("KIO","indexOutput"),n("KIFS","ifStore"),n("KSETS","setStore"),n("KLOAD","loadStore"),n("KSAVE","saveStore")}};a(wi,"KeyboardInterface"),wi.GLOBAL_NAME="KeymanWeb";var we=wi;(function(){we.__publishShorthandAPI()})();var Xt=class Xt extends S.default{constructor(t,n){super();this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.modStateFlags=0;n||(n=Xt.DEFAULT_OPTIONS),this.contextDevice=t,this.baseLayout=n.baseLayout||Xt.DEFAULT_OPTIONS.baseLayout,this.keyboardInterface=n.keyboardInterface||new we(Et(),Hi),this.defaultRules=n.defaultOutputRules||Xt.DEFAULT_OPTIONS.defaultOutputRules}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(t){this.keyboardInterface.activeKeyboard=t,this.resetContext()}get layerStore(){return this.keyboardInterface.systemStores[33]}get newLayerStore(){return this.keyboardInterface.systemStores[42]}get oldLayerStore(){return this.keyboardInterface.systemStores[43]}get layerId(){return this.layerStore.value}set layerId(t){this.layerStore.set(t)}defaultRuleBehavior(t,n,l){let s=N.from(n,l),c=new le,r=!1;var o="",d;if(t.isSynthetic||n.isSynthetic)if(r=!0,this.defaultRules.isCommand(t))c.triggersDefaultCommand=!0;else if((d=this.defaultRules.forSpecialEmulation(t))!=null)switch(d){case"\b":this.keyboardInterface.defaultBackspace(n);break;case`
`:n.handleNewlineAtCaret();break;default:c.errorLog="Unexpected 'special emulation' character (\\u"+d.kmwCharCodeAt(0).toString(16)+") went unhandled!"}else r=!1;let u=this.activeKeyboard&&this.activeKeyboard.isMnemonic;if(!r)if((o=this.defaultRules.forAny(t,u,c))!=null)if(d=this.defaultRules.forSpecialEmulation(t),d=="\b")this.keyboardInterface.defaultBackspace(n);else{if(d||this.defaultRules.isCommand(t))return null;this.keyboardInterface.output(0,n,o)}else return null;if(c.errorLog)return c;let B=n.buildTranscriptionFrom(s,t,l);return c.transcription=B,c}processNewContextEvent(t,n){return this.activeKeyboard?this.keyboardInterface.processNewContextEvent(n,this.activeKeyboard.constructNullKeyEvent(t,this.stateKeys)):null}processPostKeystroke(t,n){return this.activeKeyboard?this.keyboardInterface.processPostKeystroke(n,this.activeKeyboard.constructNullKeyEvent(t,this.stateKeys)):null}processKeystroke(t,n){var l;let s=n.getTextBeforeCaret().kmwLength()==0&&n.isSelectionEmpty();if(this.activeKeyboard&&t.Lcode!=0&&(l=this.keyboardInterface.processKeystroke(n,t)),s&&t.Lcode==C.keyCodes.K_BKSP&&l.triggerKeyDefault)l=this.defaultRuleBehavior(t,n,!1),l.triggerKeyDefault=!0,l.transcription.transform.deleteLeft=1;else if(!l||l.triggerKeyDefault){t.Lcode=t.vkCode||t.Lcode,this.keyboardInterface.activeTargetOutput=n;let c=this.defaultRuleBehavior(t,n,!1);c&&(l?l.mergeInDefaults(c):l=c,l.triggerKeyDefault=!1),this.keyboardInterface.activeTargetOutput=null}return l}_UpdateVKShift(t){let n=0,l=["CAPS","NUM_LOCK","SCROLL_LOCK"],s=["K_CAPS","K_NUMLOCK","K_SCROLL"],c=[m.CAPITALFLAG,m.NUMLOCKFLAG,m.SCROLLFLAG];if(!this.activeKeyboard)return!0;if(t){n=t.Lmodifiers,this.activeKeyboard.isChiral&&this.activeKeyboard.emulatesAltGr&&(this.modStateFlags&C.modifierBitmasks.ALT_GR_SIM)==C.modifierBitmasks.ALT_GR_SIM&&(n|=C.modifierBitmasks.ALT_GR_SIM,n&=~m.RALTFLAG);let r=!1;for(let o=0;o<l.length;o++)t.Lstates&C.stateBitmasks[l[o]]&&(this.stateKeys[s[o]]=!!(t.Lstates&c[o]),r=!0);r&&this.emit("statekeychange",this.stateKeys)}return this.updateStates(),this.activeKeyboard.isMnemonic&&this.stateKeys.K_CAPS&&(!t||!t.isModifier)&&(n^=m.K_SHIFTFLAG),this.layerId=this.getLayerId(n),!0}updateStates(){let t=["K_CAPS","K_NUMLOCK","K_SCROLL"],n=[m.CAPITALFLAG,m.NUMLOCKFLAG,m.SCROLLFLAG],l=[m.NOTCAPITALFLAG,m.NOTNUMLOCKFLAG,m.NOTSCROLLFLAG];for(let s=0;s<t.length;s++){let c=t[s];this.stateKeys[c]?(this.modStateFlags|=n[s],this.modStateFlags&=~l[s]):(this.modStateFlags&=~n[s],this.modStateFlags|=l[s])}}getLayerId(t){return E.getLayerId(t)}selectLayer(t){let n=t.kName;var l=t.kNextLayer,s=this.activeKeyboard&&this.activeKeyboard.isChiral;if(typeof l=="number"&&(l=this.getLayerId(l*16)),!l)switch(n){case"K_LSHIFT":case"K_RSHIFT":case"K_SHIFT":l="shift";break;case"K_LCONTROL":case"K_LCTRL":if(s){l="leftctrl";break}case"K_RCONTROL":case"K_RCTRL":if(s){l="rightctrl";break}case"K_CTRL":l="ctrl";break;case"K_LMENU":case"K_LALT":if(s){l="leftalt";break}case"K_RMENU":case"K_RALT":if(s){l="rightalt";break}case"K_ALT":l="alt";break;case"K_ALTGR":s?l="leftctrl-rightalt":l="ctrl-alt";break;case"K_CURRENCIES":case"K_NUMERALS":case"K_SHIFTED":case"K_UPPER":case"K_LOWER":case"K_SYMBOLS":l="default";break}return l?(this.updateLayer(t,l),!0):!1}updateLayer(t,n){let l=this.layerId;var s=l;if(n==l&&t.device.formFactor!=W.FormFactor.Desktop)return;var c=n,r;if(t.device.formFactor==W.FormFactor.Desktop){var o=["leftctrl","rightctrl","ctrl","leftalt","rightalt","alt","shift"];for(r=0;r<o.length;r++)c=c.replace(o[r]+"-",""),c=c.replace(o[r],"");if(l=="default"||l=="numeric"||l=="symbol"||l=="currency"||c!="")s=n;else{var d=C.getModifierState(s);for(r=0;r<o.length;r++)s=s.replace(o[r]+"-",""),s=s.replace(o[r],"");switch(n){case"shift":d^=m.K_SHIFTFLAG;break;case"leftctrl":d^=m.LCTRLFLAG;break;case"rightctrl":d^=m.RCTRLFLAG;break;case"ctrl":d^=m.K_CTRLFLAG;break;case"leftalt":d^=m.LALTFLAG;break;case"rightalt":d^=m.RALTFLAG;break;case"alt":d^=m.K_ALTFLAG;break;default:s=n}s!="default"&&(s==""?s=this.getLayerId(d):s=this.getLayerId(d)+"-"+s)}s==""&&(s="default")}else s=n;this.activeKeyboard.layout(t.device.formFactor).getLayer(s)?this.layerId=s:this.layerId="default";let B=C.getModifierState(this.layerId);this.modStateFlags=B|t.Lstates}doModifierPress(t,n,l){return this.activeKeyboard?t.isModifier?(this.activeKeyboard.notify(t.Lcode,n,l?1:0),t.device.touchable?!0:this._UpdateVKShift(t)):(t.LmodifierChange&&(this.activeKeyboard.notify(0,n,1),t.device.touchable||this._UpdateVKShift(t)),!1):!1}performNewContextEvent(t){let n=this.processNewContextEvent(this.contextDevice,t);return n&&n.finalize(this,t,!0),n}resetContext(t){this.layerId="default",t==null||t.resetContext(),this.keyboardInterface.resetContextCache(),t&&this.performNewContextEvent(t),this.contextDevice.touchable||this._UpdateVKShift(null)}setNumericLayer(t){this.activeKeyboard&&this.activeKeyboard.layout(t.formFactor).getLayer("numeric")&&(this.layerId="numeric")}};a(Xt,"KeyboardProcessor"),Xt.DEFAULT_OPTIONS={baseLayout:"us",defaultOutputRules:new Ae};var _t=Xt;var $n="Keyboard_";function se(g){return g.startsWith($n)?g:$n+g}a(se,"prefixed");function Me(g){return g.startsWith($n)?g.substring($n.length):g}a(Me,"withoutPrefix");var Ms=class Ms extends S.default{constructor(t){super();this.stubSetTable={};this.keyboardTable={};this.keyboardLoader=t}getKeyboardForStub(t){return t?this.getKeyboard(t.KI):null}getKeyboard(t){if(!t)return null;let n=this.keyboardTable[se(t)];return n instanceof Promise?null:n}get defaultStub(){function t(l){let s=Object.keys(l);if(s.length!=0)return l[s[0]]}a(t,"getFirstValue");let n=t(this.stubSetTable);if(n)return t(n)}addKeyboard(t){let n=se(t.id);this.keyboardTable[n]=t,this.emit("keyboardadded",t)}fetchKeyboardForStub(t){return this.fetchKeyboard(t.KI)}isFetchingKeyboard(t){if(!t)throw new Error("Keyboard ID must be specified");return t=se(t),this.keyboardTable[t]instanceof Promise}fetchKeyboard(t){if(!t)throw new Error("Keyboard ID must be specified");if(!this.keyboardLoader)throw new Error("Cannot load keyboards; this cache was configured without a loader");t=se(t);let n=this.keyboardTable[t];if(n instanceof T)return Promise.resolve(n);if(n instanceof Promise)return n;let l=this.getStub(t,null);if(!l)throw new Error(`No stub for ${Me(t)} has been registered`);if(!l.filename)throw new Error(`The registered stub for ${Me(t)} lacks a path to the main keyboard file`);let s=this.keyboardLoader.loadKeyboardFromStub(l);return this.keyboardTable[t]=s,s.then(c=>{c.scriptObject.KI=t,this.addKeyboard(c)}).catch(c=>{throw delete this.keyboardTable[t],c}),s}addStub(t){var s;let n=se(t.KI),l=this.stubSetTable[n]=(s=this.stubSetTable[n])!=null?s:{};l[t.KLC]=t,this.emit("stubadded",t)}findMatchingStub(t){return this.getStub(t.KI,t.KLC)}getStub(t,n){var r;let l,s=n||"---";t instanceof T?l=t.id:l=t,l&&(l=se(l));let c=(r=this.stubSetTable[l])!=null?r:{};if(s!="---")return c[s];{let o=Object.keys(c);return o.length==0?null:c[o[0]]}}forgetKeyboard(t,n=!1){let l=t instanceof T?t.id:se(t);this.stubSetTable[l]&&delete this.stubSetTable[l],n&&this.keyboardTable[l]&&delete this.keyboardTable[l]}getStubList(){let t=[],n=Object.keys(this.stubSetTable);for(let l of n){let s=this.stubSetTable[l],c=Object.keys(s);for(let r of c)t.push(s[r])}return t}};a(Ms,"StubAndKeyboardCache");var qt=Ms;var Ks=["World","Africa","Asia","Europe","South America","North America","Oceania","Central America","Middle East"],zs=["un","af","as","eu","sa","na","oc","ca","me"],Za=RegExp("^(([\\.]/)|([\\.][\\.]/)|(/))|(:)");function po(g,i){return i=i||"",g&&!Za.test(g)?i+g:g}a(po,"configureFilePathing");var el=class el extends Te{constructor(t,n,l){var i=(...args)=>{super(...args)};if(typeof t!="string")if(t.id!==void 0){let s=t;s.id=se(s.id),i(s,l),this.KF=po(s.filename,n),this.mapRegion(s.languages)}else{let s=t;s.KI=se(s.KI),i(s,l),this.KF=po(s.KF,n),this.KP=s.KP,this.KR=s.KR,this.KRC=s.KRC;return}else i(se(t),n)}mapRegion(t){let n=t.region,l=0;if(typeof n=="number")n<1||n>9?l=0:l=n-1;else if(typeof n=="string"){let s=n.length==2?zs:Ks;for(let c=0;c<s.length;c++)if(n.toLowerCase()==s[c].toLowerCase()){l=c;break}}this.KR=Ks[l],this.KRC=zs[l]}get region(){return this.KR}get regionCode(){return this.KRC}get filename(){return this.KF}static toStubs(t,n,l){let s="";if(typeof t.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),t.languages||(t.languages=t.language),t?t.id?t.languages||(s="KeyboardStub has undefined languages"):s="KeyboardStub has undefined id":s="Stub undefined",s!="")return[{error:new Error(s)}];let c=[];Array.isArray(t.languages)?c=c.concat(t.languages):c.push(t.languages);let r=[];return c.forEach(o=>{let d=A(G({},t),{languages:o,language:void 0}),u=new el(d,n,l);r.push(u)}),r}merge(t){this.KL||(this.KL=t.KL),this.KR||(this.KR=t.KR),this.KRC||(this.KRC=t.KRC),this.KN||(this.KN=t.KN),this.KF||(this.KF=t.KF),this.KFont||(this.KFont=t.KFont),this.KOskFont||(this.KOskFont=t.KOskFont),t._displayName&&(this._displayName||(this._displayName=t._displayName))}validateForCustomKeyboard(){return super.validateForCustomKeyboard()||!this.KF||!this.KR?new Error("To use a custom keyboard, you must specify file name, keyboard id, keyboard name, language, language code, and region."):null}};a(el,"KeyboardStub");var ee=el;function Mi(g,i){if(i.length==0)return Promise.resolve(g);if(g.length==0)return Promise.reject(i);{let t=g;return Promise.resolve(t.concat(i))}}a(Mi,"mergeAndResolveStubPromises");var Co="The Cloud API request timed out.",Ds="Could not find a keyboard with that ID.",Qo="The Cloud API failed to find an appropriate keyboard.",Xa="Error occurred while registering keyboards: ",Va=a(function(g){return g+" keyboard not found."},"MISSING_KEYBOARD"),Ki=class Ki extends S.default{constructor(t,n){super();this.cloudResolutionPromises=new Map;this.languageFetchStarted=!1;this.registerFromCloud=a(t=>{let n=Number.parseInt(t.timerid),l;try{l=this._registerCore(t)}catch(s){l=new Error(Xa+s)}if(n){let s=this.cloudResolutionPromises.get(n);if(s)try{l instanceof Error?s.reject(l):s.resolve(l)}finally{this.cloudResolutionPromises.delete(n)}else{this.emit("unboundregister",l);return}}else{this.emit("unboundregister",l);return}},"registerFromCloud");this.requestEngine=t,this.pathConfig=n,this._languageListPromise=new v}get languageListPromise(){return this.languageFetchStarted||(this.languageFetchStarted=!0,this.keymanCloudRequest("",!0).catch(t=>{this.languageFetchStarted=!1,this._languageListPromise.reject(t),this._languageListPromise=new v})),this._languageListPromise.corePromise}keymanCloudRequest(t,n){let l="https://api.keyman.com/cloud/4.0/"+(arguments.length>1&&n?"languages":"keyboards"),s="?jsonp=keyman.register&languageidtype=bcp47&version="+K.CURRENT.toString(),c=l+s+t,{promise:r,queryId:o}=this.requestEngine.request(c);return this.cloudResolutionPromises.set(o,r),r.finally(()=>{this.cloudResolutionPromises.delete(o)}),r.corePromise}_registerCore(t){let n=t.options,l=n.fontBaseUri;if(this.pathConfig.fonts!=""?l=this.pathConfig.fonts:this.pathConfig.updateFontPath(l),typeof t.error=="string"){var s="";if(typeof t.options.keyboardid=="string"){let r=t.options.keyboardid;s=r.substring(0,1).toUpperCase()+r.substring(1)}return new Error(Va(s))}if(typeof n=="undefined"||typeof n.context=="undefined")return new Error(Ds);let c=[];if(n.context=="keyboard"){let r,o=t.keyboard;if(Array.isArray(o))for(r=0;r<o.length;r++)c=c.concat(Ki.registerLanguagesForKeyboard(o[r],n,r));else c=c.concat(Ki.registerLanguagesForKeyboard(o,n,0))}else if(n.context=="language"){let r=t.languages;return this._languageListPromise.resolve(r),r}return c}static registerLanguagesForKeyboard(t,n,l){let s="";if(typeof t=="undefined")return[];if(typeof n.keyboardid=="string"&&(s=n.keyboardid.split(",")[l]),Array.isArray(t))if(t.length==1||s.substr(-1,1)=="$"||s==""){let c=[];for(let r=0;r<t.length;r++)c=c.concat(this.registerLanguagesForKeyboard(t[r],n,l));return c}else{let c=0;for(let r=0;r<t.length;r++){let o=t[r].id.toLowerCase();if(o=="us"&&(o="english"),Array.isArray(t[r].languages)){let d=t[r].languages;for(let u=0;u<d.length;u++)if(o==d[u].name.toLowerCase()){c=r;break}}}return this.registerLanguagesForKeyboard(t[c],n,l)}else{let c=n.fontBaseUri||"",r=ee.toStubs(t,n.keyboardBaseUri,c),o=s.split("@")[1];if(r.length==1&&typeof r[0].error!="undefined")throw r[0].error;return typeof o!="string"?r:(o=o.replace(/\$$/,""),[r.find(d=>d.KLC==o)])}}fetchCloudStubs(t){return R(this,null,function*(){if(t.length==0)return Promise.resolve([]);let n="&keyboardid=",l="";for(let c=0;c<t.length;c++)n=n+l+t[c].toString(),l=",";let s=[];try{let c=yield this.keymanCloudRequest(n,!1);return Mi(c,s)}catch(c){console.error(c);let r={error:c};return s.push(r),Promise.reject(s)}})}};a(Ki,"CloudQueryEngine");var $t=Ki;var js=class js{constructor(i,t){this.id=i,this.language=t}toString(){let i=this.id;return this.language?(i=i+"@"+this.language,this.version&&(i=i+"@"+this.version)):this.version&&(i=i+"@@"+this.version),i}};a(js,"CloudRequestEntry");var Ps=js;function Os(g,i){return{keyboard:{id:g.id,name:g.name},error:typeof i=="string"?new Error(i):i}}a(Os,"convertToErrorStub");function Uo(g,i,t){let n=new Ps(g,i);return t&&(n.version=t),n}a(Uo,"toQuerySpecs");function xo(g,i,t){if(g.getStub(t.id,t.language)==null){for(let n=0;n<i.length;n++)if(i[n].id==t.id&&i[n].language==t.language)return!1;return!0}else return!1}a(xo,"isUniqueRequest");var _s=class _s{constructor(i,t,n){this.pathConfig=n,this.cache=new qt(i),this.cloudQueryEngine=new $t(t,this.pathConfig),this.cloudQueryEngine.on("unboundregister",l=>{Array.isArray(l)&&l.forEach(s=>{s instanceof ee&&this.cache.addStub(s)})})}addKeyboardArray(i){let t=[],n=[],l=[],s=[],c=[];for(let d of i)if(typeof d=="string")d.length>0&&s.push(d);else if(d.KI||d.KL||d.KLC||d.KFont||d.KOskFont)l.push(new ee(d));else{let u=d;if(typeof u.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),u.languages||(u.languages=u.language),typeof u.languages=="undefined"){let B="To use keyboard '"+u.id+"', you must specify languages.";c.push(Os(u,B))}else if(Array.isArray(u.languages)){let B=ee.toStubs(u,this.pathConfig.keyboards,this.pathConfig.fonts);for(let b of B)b instanceof ee?l.push(b):c.push(b)}else{let B=u;l.push(new ee(B,this.pathConfig.keyboards,this.pathConfig.fonts))}}for(let d of l)if(d.KF){let u=d.validateForCustomKeyboard();u?c.push(Os(d,u)):t.push(d)}else n.push(d);let r=[];for(let d of n){if(!d.KI&&!d.KLC){c.push(Os(d,"Cannot fetch keyboard information without a keyboard ID or language code."));continue}let u=Uo(Me(d.id),d.langId);xo(this.cache,r,u)&&r.push(u)}for(let d of s){let u=d.split("@"),B=[""];u[0].toLowerCase()=="english"&&(u[0]="us"),u.length>1&&(B=u[1].split(","));for(let b=0;b<B.length;b++){if(b>0&&B[b]=="")continue;let I=Uo(u[0],B[b],u[2]);xo(this.cache,r,I)&&r.push(I)}}return t.forEach(d=>this.cache.addStub(d)),this.cloudQueryEngine.fetchCloudStubs(r.map(d=>d.toString())).then(d=>{for(let u of d)u instanceof ee?(this.cache.addStub(u),t.push(u)):c.push(u);return[].concat(c).concat(t)})}addLanguageKeyboards(i){return R(this,null,function*(){let t=[],n=[];try{n=yield this.cloudQueryEngine.languageListPromise}catch(c){return console.error(c),t.push({error:c}),t}let l=n,s="";for(let c=0;c<i.length;c++){let r=i[c].toLowerCase(),o=r.substr(-1,1)=="$";o&&(r=r.substr(0,r.length-1));let d=!1;for(let u=0;u<l.length;u++)if(r==l[u].name.toLowerCase()){s!=""&&(s=s+","),s=s+"@"+l[u].id,o&&(s=s+"$"),d=!0;break}if(!d){let u={language:{name:r},error:new Error(this.alertLanguageUnavailable(r))};t.push(u)}}return s==""?Promise.reject(t):this.cloudQueryEngine.keymanCloudRequest("&keyboardid="+s,!1).then(c=>R(this,null,function*(){let r=yield Mi(c,t);for(let o of r)typeof o.error=="undefined"&&this.cache.addStub(o);return r}),c=>{console.error(c);let r={error:c};return t.push(r),Promise.reject(t)})})}fetchCloudCatalog(){return R(this,null,function*(){try{let i=yield this.cloudQueryEngine.keymanCloudRequest("",!1);return i.forEach(t=>this.cache.addStub(t)),i}catch(i){return Promise.reject([{error:i}])}})}alertLanguageUnavailable(i){return"No keyboards are available for "+i+". Does it have another language name?"}};a(_s,"KeyboardRequisitioner");var ei=_s;var qs=class qs{constructor(){this.registeredModels={};this.languageModelMap={}}modelForLanguage(i){return this.languageModelMap[i]}register(i){if(i.id=i.id.toLowerCase(),JSON.stringify(i)==JSON.stringify(this.registeredModels[i.id]))return;this.registeredModels[i.id]=i;let t=this;i.languages.forEach(function(n){if(!n){console.warn("Null / undefined language codes are not permitted for registration.");return}t.languageModelMap[n]=i})}unregister(i){let t;if(i=i.toLowerCase(),this.registeredModels[i])t=this.registeredModels[i],delete this.registeredModels[i];else return null;let n=this;return t.languages.forEach(function(l){n.languageModelMap[l].id==i&&delete n.languageModelMap[l]}),t}isRegistered(i){return!!this.registeredModels[i.id.toLowerCase()]}};a(qs,"ModelManager");var ti=qs;function tl(g){let i=[];for(let t=0;t<g.length;t++)i.push(g[t]);return i}a(tl,"arrayFromNodeList");function J(g){let i=document.createElement(g);return i.style.userSelect="none",i.style.webkitUserSelect="none",i}a(J,"createUnselectableElement");var $s=class $s{constructor(i,t){this.fontStyleDefinitions={};this.linkedSheets=[];this.fontPromises=[];if(!i){let n=document.getElementsByTagName("HEAD");n.length>0?i=n[0]:i=document.body}this.linkNode=i,this.doCacheBusting=t||!1}get sheets(){return this.linkedSheets.map(i=>i.sheet)}linkStylesheet(i){if(!(i instanceof HTMLLinkElement)&&!i.innerHTML)return;let t=new v;i instanceof HTMLLinkElement?i.onload=()=>t.resolve():t.resolve(),this.linkedSheets.push({sheet:i,load:t}),this.linkNode.appendChild(i)}allLoadedPromise(){return R(this,null,function*(){let i=this.linkedSheets.map(t=>t.load.corePromise);Promise.allSettled?yield Promise.allSettled(i):yield Promise.all(i)})}addStyleSheetForFont(i,t,n){if(!i||typeof i.files=="undefined")return null;let l=i.family,s,c,r="",o="",d=[],u="";n||(n=W.OperatingSystem.Other);let B=this.fontStyleDefinitions[n]=this.fontStyleDefinitions[n]||{};if(B[l]){let Q=B[l];return Q.parentNode||this.linkStylesheet(Q),null}for(typeof i.files=="string"?d[0]=i.files:d=i.files,c=0;c<d.length;c++)d[c].toLowerCase().indexOf("data:font")==0&&(u=d[c]),d[c].toLowerCase().indexOf(".otf")>0&&(r=d[c]),d[c].toLowerCase().indexOf(".ttf")>0&&(r=d[c]),d[c].toLowerCase().indexOf(".woff")>0&&(o=d[c]);r!=""&&r.indexOf("/")<0&&(r=t+r),o!=""&&o.indexOf("/")<0&&(o=t+o);var b=`@font-face {
font-family:`+i.family+`;
font-style:normal;
font-weight:normal;
`;if(u){let x=u.substring(10,u.indexOf(";",10));b+=`src:url('${u}'), format('${x}');`}else n==W.OperatingSystem.iOS?r!=""&&(this.doCacheBusting&&(r=this.cacheBust(r)),s="url('"+encodeURI(r)+"') format('truetype')"):(o!=""&&(s="url('"+encodeURI(o)+"') format('woff')"),r!=""&&(s="url('"+encodeURI(r)+"') format('truetype')"));if(!s)return null;b+="src:"+s+";",b=b+`
}
`;let I=st(b);B[l]=I;let h=new FontFace(i.family,s).load(),y=a(()=>{this.fontPromises=this.fontPromises.filter(Q=>Q!=h)},"clearPromise");return this.fontPromises.push(h.then(y).catch(y)),this.linkStylesheet(I),I}cacheBust(i){return i+"?v="+new Date().getTime()}linkExternalSheet(i,t){try{if(!t&&document.querySelector("link[href="+JSON.stringify(i)+"]")!=null)return null}catch(l){return null}let n=document.createElement("link");return n.type="text/css",n.rel="stylesheet",n.href=i,this.linkStylesheet(n),n}unlink(i){let t=this.linkedSheets.findIndex(n=>n.sheet==i);return t>-1?(this.linkedSheets.splice(t,1)[0].load.resolve(),i.parentNode.removeChild(i),!0):!1}unlinkAll(){for(let i of this.linkedSheets){let t=i.sheet;t.parentNode&&t.parentNode.removeChild(t),i.load.resolve()}this.linkedSheets.splice(0,this.linkedSheets.length)}};a($s,"StylesheetManager");var de=$s;function st(g){var i=document.createElement("style");return i.type="text/css",i.appendChild(document.createTextNode(g)),i}a(st,"createStyleSheet");function he(){var g;return typeof window.orientation!="undefined"?g=window.orientation:typeof window.screen.orientation!="undefined"&&(g=window.screen.orientation.angle),g!==void 0?Math.abs(g/90)==1:!1}a(he,"landscapeView");var ec=class ec{constructor(i){this.name=i}load(i){return this.loadCookie(this.name,i||(t=>t))}save(i,t){this.saveCookie(this.name,i,t||(n=>n))}_loadRawCookies(){let i={};if(typeof document.cookie!="undefined"&&document.cookie!=""){let t=document.cookie.split(/;\s*/);for(let n=0;n<t.length;n++){let l=t[n].split("=");l.length==2&&(i[l[0]]=l[1])}}return i}loadCookie(i,t){let n={},s=this._loadRawCookies()[i];if(s){let c=decodeURIComponent(s).split(";");for(let r=0;r<c.length&&!(r==c.length-1&&!c[r]);r++){let o=c[r].split("=");if(o.length>1){let[d,u]=o;n[d]=t(u,d)}else n[o[0]]=""}}return n}saveCookie(i,t,n){let l="";for(let r in t)l+=r+"="+n(t[r],r)+";";let c=" path=/; expires="+new Date(new Date().valueOf()+1e3*60*60*24*30).toUTCString();document.cookie=`${i}=${encodeURIComponent(l)}; ${c}`}};a(ec,"CookieSerializer");var ce=ec;function z(g){var i;if(!g)return 0;var t=g.offsetLeft?g.offsetLeft:0;if(i=g,i.offsetParent){for(;i.offsetParent;)i=i.offsetParent,t+=i.offsetLeft;let l=i.ownerDocument;i.style.position=="fixed"&&l&&l.scrollingElement&&(t+=l.scrollingElement.scrollLeft)}if(i&&i.ownerDocument&&g.ownerDocument!=window.document){var n=i.ownerDocument;if(n&&n.defaultView&&n.defaultView.frameElement)return t+z(n.defaultView.frameElement)-n.documentElement.scrollLeft}return t}a(z,"getAbsoluteX");function D(g){var i;if(!g)return 0;var t=g.offsetTop?g.offsetTop:0;if(i=g,i.ownerDocument&&i instanceof i.ownerDocument.defaultView.HTMLElement){for(;i.offsetParent;)i=i.offsetParent,t+=i.offsetTop;let l=i.ownerDocument;i.style.position=="fixed"&&l&&l.scrollingElement&&(t+=l.scrollingElement.scrollTop)}if(i&&i.ownerDocument&&g.ownerDocument!=window.document){var n=i.ownerDocument;if(n&&n.defaultView&&n.defaultView.frameElement)return t+D(n.defaultView.frameElement)}return t}a(D,"getAbsoluteY");var tc=class tc extends ce{constructor(i,t){super(`KeymanWeb_${i}_Option_${t}`)}load(){return super.load(decodeURIComponent)}save(i){super.save(i,encodeURIComponent)}};a(tc,"VarStoreSerializer");var il=tc,ic=class ic{loadStore(i,t){return new il(i,t).load()}saveStore(i,t,n){new il(i,t).save(n)}};a(ic,"VariableStoreCookieSerializer");var zi=ic;var nc=class nc extends we{constructor(t,n,l){super(t,n,new zi);this.insertText=a((t,n)=>{this.resetContextCache(),this.engine.contextManager.insertText(this,t,n)},"insertText");this.KT=this.insertText;this.engine=n,this.stubNamespacer=l}preserveID(t){var n;if(document.currentScript)n=document.currentScript.id;else{var l=document.getElementsByTagName("script"),s=l[l.length-1];n=s.id}if(n)n.indexOf(Me(t.KI))!=-1?t.KI=n:console.error("Error when registering keyboard:  current SCRIPT tag's ID does not match!");else return}registerKeyboard(t){super.registerKeyboard(t);let n=this.loadedKeyboard;this.preserveID(t),this.engine.config.deferForInitialization.then(()=>{this.engine.keyboardRequisitioner.cache.isFetchingKeyboard(n.id)||(this.engine.keyboardRequisitioner.cache.addKeyboard(n),this.loadedKeyboard=null)})}registerStub(t){var l;this.stubNamespacer&&this.stubNamespacer(t);let n=a(()=>{let s=this.engine.config.paths;return new ee(t,s.keyboards,s.fonts)},"buildStub");if(!this.engine.config.deferForInitialization.isResolved)this.engine.config.deferForInitialization.then(()=>this.engine.keyboardRequisitioner.cache.addStub(n()));else{let s=n();if((l=this.engine.keyboardRequisitioner)!=null&&l.cache.findMatchingStub(s))return 1;this.engine.keyboardRequisitioner.cache.addStub(s)}return null}};a(nc,"KeyboardInterface");var Vt=nc;(function(){Vt.__publishShorthandAPI()})();var lc=class lc extends zt{constructor(t,n){var i=(...args)=>{super(...args)};t&&t._jsGlobal!=window&&(t._jsGlobal.String=window.String),i(t||new Gt(window,Hi)),this.performCacheBusting=n||!1}loadKeyboardInternal(t,n,l){let s=new v;this.performCacheBusting&&(t=this.cacheBust(t));try{let c=this.harness._jsGlobal.document,r=c.createElement("script");l&&(r.id=l),c.head.appendChild(r),r.onerror=o=>{s.reject(n.missingError(o))},r.onload=()=>{if(this.harness.loadedKeyboard){let o=this.harness.loadedKeyboard;this.harness.loadedKeyboard=null,s.resolve(o)}else s.reject(n.scriptError())},s.then(()=>{r.remove()}).catch(()=>{r.remove()}),r.src=t}catch(c){return Promise.reject(c)}return s.corePromise}cacheBust(t){return t+"?v="+new Date().getTime()}};a(lc,"DOMKeyboardLoader");var nl=lc;var ll=class ll{constructor(i,t,n){this.left=i.getTextBeforeCaret(),this.startOfBuffer=this.left._kmwLength()<=t.leftContextCodePoints,this.startOfBuffer||(this.left=this.left._kmwSubstr(-t.leftContextCodePoints)),this.right=i.getTextAfterCaret(),this.endOfBuffer=this.right._kmwLength()<=t.rightContextCodePoints,this.endOfBuffer||(this.right=this.right._kmwSubstr(0,t.rightContextCodePoints)),this.casingForm=n=="shift"?"initial":n=="caps"?"upper":null}toMock(){let i=this.left._kmwLength();return new N(this.left+(this.right||""),i)}};a(ll,"ContextWindow"),ll.ENGINE_RULE_WINDOW={leftContextCodePoints:64,rightContextCodePoints:32};var xe=ll;var sc=class sc{constructor(){this._promises=new Map}get length(){return this._promises.size}make(i,t,n){if(this._promises.has(i))return n(`Existing request with token ${i}`);this._promises.set(i,{reject:n,resolve:t})}keep(i,t){let n=this._promises.get(i);if(!n)throw new Error(`No promise associated with token: ${i}`);let l=n.resolve;return this._promises.delete(i),l(t)}break(i,t){let n=this._promises.get(i);if(!n)throw new Error(`No promise associated with token: ${i}`);this._promises.delete(i),n.reject(t)}};a(sc,"PromiseStore");var ct=sc;var cc=class cc{constructor(i,t,n){this._worker=t,this._worker.onmessage=this.onMessage.bind(this),this._declareLMLayerReady=null,this._predictPromises=new ct,this._wordbreakPromises=new ct,this._acceptPromises=new ct,this._revertPromises=new ct,this._nextToken=Number.MIN_SAFE_INTEGER,this.sendConfig(i,!!n)}sendConfig(i,t){this._worker.postMessage({message:"config",capabilities:i,testMode:t})}loadModel(i,t="file"){return new Promise((n,l)=>{this._declareLMLayerReady=n;let s={type:t};t=="file"?s.file=i:s.code=i,this._worker.postMessage({message:"load",source:s})})}unloadModel(){this._worker.postMessage({message:"unload"})}predict(i,t){let n=this._nextToken++;return new Promise((l,s)=>{this._predictPromises.make(n,l,s),this._worker.postMessage({message:"predict",token:n,transform:i,context:t})})}wordbreak(i){let t=this._nextToken++;return new Promise((n,l)=>{this._wordbreakPromises.make(t,n,l),this._worker.postMessage({message:"wordbreak",token:t,context:i})})}acceptSuggestion(i,t,n){let l=this._nextToken++;return new Promise((s,c)=>{this._acceptPromises.make(l,s,c),this._worker.postMessage({message:"accept",token:l,suggestion:i,context:t,postTransform:n})})}revertSuggestion(i,t){let n=this._nextToken++;return new Promise((l,s)=>{this._revertPromises.make(n,l,s),this._worker.postMessage({message:"revert",token:n,reversion:i,context:t})})}resetContext(i){this._worker.postMessage({message:"reset-context",context:i})}onMessage(i){let t=i.data;if(t.message==="error")console.error(t.log),t.error&&console.error(t.error);else if(t.message==="ready")this._declareLMLayerReady(i.data.configuration);else if(t.message==="suggestions")this._predictPromises.keep(t.token,t.suggestions);else if(t.message==="currentword")this._wordbreakPromises.keep(t.token,t.word);else if(t.message==="postaccept")this._acceptPromises.keep(t.token,t.reversion);else if(t.message==="postrevert")this._revertPromises.keep(t.token,t.suggestions);else throw new Error(`Message not implemented: ${t.message}`)}shutdown(){this._worker.terminate()}};a(cc,"LMLayer");var ii=cc;function sl(g){return g}a(sl,"unwrap");var Zo=`"use strict";(()=>{var Re=Object.defineProperty,Qt=Object.defineProperties;var Vt=Object.getOwnPropertyDescriptors;var gt=Object.getOwnPropertySymbols;var Ht=Object.prototype.hasOwnProperty,zt=Object.prototype.propertyIsEnumerable;var xt=(s,t)=>{if(t=Symbol[s])return t;throw Error("Symbol."+s+" is not defined")};var Tt=(s,t,r)=>t in s?Re(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,O=(s,t)=>{for(var r in t||(t={}))Ht.call(t,r)&&Tt(s,r,t[r]);if(gt)for(var r of gt(t))zt.call(t,r)&&Tt(s,r,t[r]);return s},De=(s,t)=>Qt(s,Vt(t)),d=(s,t)=>Re(s,"name",{value:t,configurable:!0});var _e=(s,t)=>{for(var r in t)Re(s,r,{get:t[r],enumerable:!0})};var U=(s,t,r)=>new Promise((n,i)=>{var o=l=>{try{u(r.next(l))}catch(c){i(c)}},a=l=>{try{u(r.throw(l))}catch(c){i(c)}},u=l=>l.done?n(l.value):Promise.resolve(l.value).then(o,a);u((r=r.apply(s,t)).next())}),ye=function(s,t){this[0]=s,this[1]=t},Ct=(s,t,r)=>{var n=(a,u,l,c)=>{try{var p=r[a](u),h=(u=p.value)instanceof ye,g=p.done;Promise.resolve(h?u[0]:u).then(m=>h?n(a==="return"?a:"next",u[1]?{done:m.done,value:m.value}:m,l,c):l({value:m,done:g})).catch(m=>n("throw",m,l,c))}catch(m){c(m)}},i=a=>o[a]=u=>new Promise((l,c)=>n(a,u,l,c)),o={};return r=r.apply(s,t),o[Symbol.asyncIterator]=()=>o,i("next"),i("throw"),i("return"),o};var St=(s,t,r)=>(t=s[xt("asyncIterator")])?t.call(s):(s=s[xt("iterator")](),t={},r=(n,i)=>(i=s[n])&&(t[n]=o=>new Promise((a,u,l)=>(o=i.call(s,o),l=o.done,Promise.resolve(o.value).then(c=>a({value:c,done:l}),u)))),r("next"),r("return"),t);function R(){String.kmwFromCharCode=function(s){var t=[],r;for(r=0;r<arguments.length;r++){var n=Number(arguments[r]);if(!isFinite(n)||n<0||n>1114111||Math.floor(n)!==n)throw new RangeError("Invalid code point "+n);n<65536?t.push(n):(n-=65536,t.push((n>>10)+55296),t.push(n%1024+56320))}return String.fromCharCode.apply(void 0,t)},String.prototype.kmwCharCodeAt=function(s){var t=String(this),r=0;if(s<0||s>=t.length)return NaN;for(var n=0;n<s;n++)if(r=t.kmwNextChar(r),r===null)return NaN;var i=t.charCodeAt(r);if(i>=55296&&i<=56319&&t.length>r+1){var o=t.charCodeAt(r+1);if(o>=56320&&o<=57343)return(i-55296<<10)+(o-56320)+65536}return i},String.prototype.kmwIndexOf=function(s,t){var r=String(this),n=r.indexOf(s,t);if(n<0)return n;for(var i=0,o=0;o!==null&&o<n;o=r.kmwNextChar(o))i++;return i},String.prototype.kmwLastIndexOf=function(s,t){var r=String(this),n=r.lastIndexOf(s,t);if(n<0)return n;for(var i=0,o=0;o!==null&&o<n;o=r.kmwNextChar(o))i++;return i},String.prototype.kmwLength=function(){var s=String(this);if(s.length==0)return 0;for(var t=0,r=0;r!==null;t++)r=s.kmwNextChar(r);return t},String.prototype.kmwSlice=function(s,t){var r=String(this),n=r.kmwCodePointToCodeUnit(s),i=r.kmwCodePointToCodeUnit(t);return n===null||i===null?"":r.slice(n,i)},String.prototype.kmwSubstr=function(s,t){var r=String(this);s<0&&(s=r.kmwLength()+s),s<0&&(s=0);var n=r.kmwCodePointToCodeUnit(s),i=n;if(n===null)return"";if(arguments.length<2)i=r.length;else for(var o=0;o<t;o++)i=r.kmwNextChar(i);return i===null?r.substring(n):r.substring(n,i)},String.prototype.kmwSubstring=function(s,t){var r=String(this),n,i;if(typeof t=="undefined")n=r.kmwCodePointToCodeUnit(s),i=r.length;else{if(s>t){var o=s;s=t,t=o}n=r.kmwCodePointToCodeUnit(s),i=r.kmwCodePointToCodeUnit(t)}return(isNaN(n)||n===null)&&(n=0),(isNaN(i)||i===null)&&(i=r.length),r.substring(n,i)},String.prototype.kmwNextChar=function(s){var t=String(this);if(s===null||s<0||s>=t.length-1)return null;var r=t.charCodeAt(s);if(r>=55296&&r<=56319&&t.length>s+1){var n=t.charCodeAt(s+1);if(n>=56320&&n<=57343)return s==t.length-2?null:s+2}return s+1},String.prototype.kmwPrevChar=function(s){var t=String(this);if(s==null||s<=0||s>t.length)return null;var r=t.charCodeAt(s-1);if(r>=56320&&r<=57343&&s>1){var n=t.charCodeAt(s-2);if(n>=55296&&n<=56319)return s-2}return s-1},String.prototype.kmwCodePointToCodeUnit=function(s){if(s===null)return null;var t=String(this),r=0;if(s<0){r=t.length;for(var n=0;n>s;n--)r=t.kmwPrevChar(r);return r}if(s==t.kmwLength())return t.length;for(var n=0;n<s;n++)r=t.kmwNextChar(r);return r},String.prototype.kmwCodeUnitToCodePoint=function(s){var t=String(this);return s===null?null:s==0?0:s<0?t.substr(s).kmwLength():t.substr(0,s).kmwLength()},String.prototype.kmwCharAt=function(s){var t=String(this);return s>=0?t.kmwSubstr(s,1):""},String.prototype.kmwBMPNextChar=function(s){var t=String(this);return s<0||s>=t.length-1?null:s+1},String.prototype.kmwBMPPrevChar=function(s){var t=String(this);return s<=0||s>t.length?null:s-1},String.prototype.kmwBMPCodePointToCodeUnit=function(s){return s},String.prototype.kmwBMPCodeUnitToCodePoint=function(s){return s},String.prototype.kmwBMPLength=function(){var s=String(this);return s.length},String.prototype.kmwBMPSubstr=function(s,t){var r=String(this);return s>-1?r.substr(s,t):r.substr(r.length+s,-s)},String.kmwEnableSupplementaryPlane=function(s){var t=String.prototype;String._kmwFromCharCode=s?String.kmwFromCharCode:String.fromCharCode,t._kmwCharAt=s?t.kmwCharAt:t.charAt,t._kmwCharCodeAt=s?t.kmwCharCodeAt:t.charCodeAt,t._kmwIndexOf=s?t.kmwIndexOf:t.indexOf,t._kmwLastIndexOf=s?t.kmwLastIndexOf:t.lastIndexOf,t._kmwSlice=s?t.kmwSlice:t.slice,t._kmwSubstring=s?t.kmwSubstring:t.substring,t._kmwSubstr=s?t.kmwSubstr:t.kmwBMPSubstr,t._kmwLength=s?t.kmwLength:t.kmwBMPLength,t._kmwNextChar=s?t.kmwNextChar:t.kmwBMPNextChar,t._kmwPrevChar=s?t.kmwPrevChar:t.kmwBMPPrevChar,t._kmwCodePointToCodeUnit=s?t.kmwCodePointToCodeUnit:t.kmwBMPCodePointToCodeUnit,t._kmwCodeUnitToCodePoint=s?t.kmwCodeUnitToCodePoint:t.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}d(R,"extendString");R();var Ue=class Ue{constructor(t){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((r,n)=>{this._resolve=i=>{this._isFulfilled=!0,r(i)},this._reject=i=>{this._isRejected=!0,n(i)},t&&t(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(t,r){return this._promise.then(t,r)}catch(t){return this._promise.catch(t)}finally(t){return this._promise.finally(t)}get corePromise(){return this._promise}};d(Ue,"ManagedPromise");var ie=Ue;var We=class We extends ie{constructor(r){let n=null;super(a=>{n=setTimeout(()=>{this.isResolved||a(!0)},r)});this.timerHandle=n;let i=this._resolve;this._resolve=a=>{clearTimeout(this.timerHandle),i(a)};let o=this._reject;this._reject=a=>{clearTimeout(this.timerHandle),o(a)}}};d(We,"TimeoutPromise");var oe=We,Fe=d(s=>new oe(s).corePromise,"timedPromise");var A=class A{constructor(t,r){if(typeof t!="function"){this.comparator=t.comparator,this.heap=[].concat(t.heap);return}let n=t;this.comparator=n,this.heap=(r!=null?r:[]).slice(0),this.heapify()}static leftChildIndex(t){return t*2+1}static rightChildIndex(t){return t*2+2}static parentIndex(t){return Math.floor((t-1)/2)}heapify(t,r){if(t==null||r==null){this.heapify(0,this.count-1);return}let n=[],i=-1;for(let o=r;o>=t;o--){let a=A.parentIndex(o);this.siftDown(o)&&a<t&&i!=a&&(n.push(a),i=a)}for(i=-1;n.length>0;){let o=n.shift(),a=A.parentIndex(o);this.siftDown(o)&&a>=0&&i!=a&&(n.push(a),i=a)}}get count(){return this.heap.length}peek(){return this.heap[0]}enqueue(t){let r=this.heap.length;this.heap.push(t);let n=A.parentIndex,i=n(r);for(;r!==0&&this.comparator(this.heap[r],this.heap[i])<0;){let o=this.heap[r];this.heap[r]=this.heap[i],this.heap[i]=o,r=i,i=n(r)}}enqueueAll(t){if(t.length==0)return;let r=this.count;this.heap=this.heap.concat(t);let n=A.parentIndex(r);this.heapify(n>=0?n:0,A.parentIndex(this.count-1))}dequeue(){if(this.count==0)return;let t=this.heap[0],r=this.heap.pop();return this.heap.length>0&&(this.heap[0]=r,this.siftDown(0)),t}siftDown(t){let r=A.leftChildIndex(t),n=A.rightChildIndex(t),i=t;if(r<this.heap.length&&this.comparator(this.heap[r],this.heap[i])<0&&(i=r),n<this.heap.length&&this.comparator(this.heap[n],this.heap[i])<0&&(i=n),i!=t){let o=this.heap[t];return this.heap[t]=this.heap[i],this.heap[i]=o,this.siftDown(i),!0}else return!1}toArray(){return this.heap.slice(0)}};d(A,"PriorityQueue");var k=A;var ve={};_e(ve,{DummyModel:()=>Pt,QuoteBehavior:()=>X,SENTINEL_CODE_UNIT:()=>N,TrieModel:()=>ce,applyTransform:()=>x,buildMergedTransform:()=>F,defaultApplyCasing:()=>Me,getLastPreCaretToken:()=>le,isHighSurrogate:()=>W,isLowSurrogate:()=>qe,isSentinel:()=>ke,tokenize:()=>ae,transformToSuggestion:()=>q,wordbreak:()=>Y});var e={};R();var N="﷐";function x(s,t){var p,h;let r=t.left||"",n=r.kmwLength(),i=n<s.deleteLeft?n:s.deleteLeft,o=r.kmwSubstr(0,n-i)+(s.insert||""),a=t.right||"",u=a.kmwLength(),l=u<((p=s.deleteRight)!=null?p:0)?u:(h=s.deleteRight)!=null?h:0,c=a.kmwSubstr(l);return{left:o,right:c,startOfBuffer:t.startOfBuffer,endOfBuffer:t.endOfBuffer,casingForm:t.casingForm}}d(x,"applyTransform");function F(s,t){let r=s.insert,n=t.deleteLeft;if(t.deleteLeft){let i=s.insert.kmwLength();i<=t.deleteLeft?(r="",n=t.deleteLeft-i):(r=s.insert.kmwSubstr(0,i-t.deleteLeft),n=0)}return{insert:r+t.insert,deleteLeft:s.deleteLeft+n,deleteRight:(s.deleteRight||0)+(t.deleteRight||0)}}d(F,"buildMergedTransform");function W(s){return typeof s=="string"&&(s=s.charCodeAt(0)),s>=55296&&s<=56319}d(W,"isHighSurrogate");function qe(s){return typeof s=="string"&&(s=s.charCodeAt(0)),s>=56320&&s<=57343}d(qe,"isLowSurrogate");function ke(s){return s==N}d(ke,"isSentinel");function q(s,t){let r={transform:s,displayAs:s.insert};return s.id!==void 0&&(r.transformId=s.id),(t===0||t)&&(r.p=t),r}d(q,"transformToSuggestion");function Me(s,t){switch(s){case"lower":return t.toLowerCase();case"upper":return t.toUpperCase();case"initial":let r=1;return t.length>1&&W(t.charAt(0))&&qe(t.charCodeAt(1))&&(r=2),t.substring(0,r).toUpperCase().concat(t.substring(r))}}d(Me,"defaultApplyCasing");var se=(n=>(n.noQuotes="no-quotes",n.useQuotes="use-quotes",n.default="default-quotes",n))(se||{});(t=>{function s(r,n,i,o){if(o=="default-quotes"||!o)throw"Specified quote behavior may be ambiguous - default behavior not specified (may not be .default)";switch(r=="default-quotes"&&(r=o),r){case"no-quotes":return n;case"use-quotes":let{open:a,close:u}=i.quotesForKeepSuggestion;return a+n+u;default:throw"Unsupported quote behavior state detected; implementation missing!"}}t.apply=s,d(s,"apply")})(se||(se={}));var X=se;function ae(s,t,r){let n=(r==null?void 0:r.rejoins)||["'"];t=t||{left:void 0,startOfBuffer:void 0,endOfBuffer:void 0};let i=s(t.left||"")||[],o=s(t.right||"")||[],a={left:[],right:[],caretSplitsToken:!1},u=0;for(;i.length>0;){let p=i[0];if(Math.max(p.start,u)!=u){let h=Math.max(u,p.start);a.left.push({text:t.left.substring(u,h),isWhitespace:!0}),u=h}else i.shift(),a.left.push({text:p.text}),u=Math.max(u,p.end)}if(t.left!=null&&u!=t.left.length){let p=Math.max(u,t.left.length);a.left.push({text:t.left.substring(u,p),isWhitespace:!0}),u=p}let l=a.left.length;if(l>1){let p=a.left[l-2],h=a.left[l-1];!p.isWhitespace&&!h.isWhitespace&&n.indexOf(h.text)!=-1&&(a.left.pop(),a.left.pop(),a.left.push({text:p.text+h.text}),l--)}u=0;let c=!0;for(;o.length>0;){let p=o[0];if(Math.max(p.start,u)!=u){let h=Math.max(u,p.start);a.right.push({text:t.right.substring(u,h),isWhitespace:!0}),u=h}else{let h=a.left[l-1];h&&c&&!h.isWhitespace&&s(h.text+p.text).length==1&&(a.caretSplitsToken=!0),o.shift(),a.right.push({text:p.text}),u=Math.max(u,p.end)}c=!1}if(t.right&&u!=t.right.length){let p=Math.max(u,t.right.length);a.right.push({text:t.right.substring(u,p),isWhitespace:!0}),u=p}return a}d(ae,"tokenize");function le(s,t){let r=ae(s,t);if(r.left.length>0){let n=r.left.pop();return n.isWhitespace?"":n.text}return""}d(le,"getLastPreCaretToken");function Y(s,t){return le(s,t)}d(Y,"wordbreak");var ue={};_e(ue,{ascii:()=>Qe,default:()=>D,defaultWordbreaker:()=>D,placeholder:()=>Be});function Be(s){let t=0;return s.split(/\\s+/).map(r=>{let n={start:t,end:t+r.length,text:r,length:r.length};return t=n.end,n})}d(Be,"placeholder");function Qe(s){let t=/[A-Za-z0-9']+/g,r=[],n;for(;(n=t.exec(s))!==null;)r.push(new Ke(n[0],n.index));return r}d(Qe,"ascii");var Ve=class Ve{constructor(t,r){this.text=t,this.start=r}get length(){return this.text.length}get end(){return this.start+this.text.length}};d(Ve,"RegExpDerivedSpan");var Ke=Ve;var bt=["Other","LF","Newline","CR","WSegSpace","Double_Quote","Single_Quote","MidNum","MidNumLet","Numeric","MidLetter","ALetter","ExtendNumLet","Format","Extend","Hebrew_Letter","ZWJ","Katakana","Regional_Indicator","sot","eot"],yt=\`\\0 
!\\v"
#  $! "%# '&( ,'- .(/ 0):*;'< A+[ _,\\\` a+{ " ª+« ­-® µ+¶ ·*¸ º+» À+× Ø+÷ ø+˘ ˞+̀.Ͱ+͵ Ͷ+͸ ͺ+;'Ϳ+΀ Ά+·*Έ+΋ Ό+΍ Ύ+΢ Σ+϶ Ϸ+҂ ҃.Ҋ+԰ Ա+՗ ՙ+՝ ՞+՟*ՠ+։'֊+֋ ֑.־ ֿ.׀ ׁ.׃ ׄ.׆ ׇ.׈ א/׫ ׯ/׳+״*׵ ؀)؆ ،'؎ ؐ.؛ ؜-؝ ؠ+ً.٠)٪ ٫)٬'٭ ٮ+ٰ.ٱ+۔ ە+ۖ.۝)۞ ۟.ۥ+ۧ.۩ ۪.ۮ+۰)ۺ+۽ ۿ+܀ ܏+ܑ.ܒ+ܰ.݋ ݍ+ަ.ޱ+޲ ߀)ߊ+߫.ߴ+߶ ߸'߹ ߺ+߻ ߽.߾ ࠀ+ࠖ.ࠚ+ࠛ.ࠤ+ࠥ.ࠨ+ࠩ.࠮ ࡀ+࡙.࡜ ࡠ+࡫ ࡰ+࢈ ࢉ+࢏ ࢐)࢒ ࢗ.ࢠ+࣊.࣢)ࣣ.ऄ+ऺ.ऽ+ा.ॐ+॑.क़+ॢ.। ०)॰ ॱ+ঁ.঄ অ+঍ এ+঑ ও+঩ প+঱ ল+঳ শ+঺ ়.ঽ+া.৅ ে.৉ ো.ৎ+৏ ৗ.৘ ড়+৞ য়+ৢ.৤ ০)ৰ+৲ ৼ+৽ ৾.৿ ਁ.਄ ਅ+਋ ਏ+਑ ਓ+਩ ਪ+਱ ਲ+਴ ਵ+਷ ਸ+਺ ਼.਽ ਾ.੃ ੇ.੉ ੋ.੎ ੑ.੒ ਖ਼+੝ ਫ਼+੟ ੦)ੰ.ੲ+ੵ.੶ ઁ.઄ અ+઎ એ+઒ ઓ+઩ પ+઱ લ+઴ વ+઺ ઼.ઽ+ા.૆ ે.૊ ો.૎ ૐ+૑ ૠ+ૢ.૤ ૦)૰ ૹ+ૺ.଀ ଁ.଄ ଅ+଍ ଏ+଑ ଓ+଩ ପ+଱ ଲ+଴ ଵ+଺ ଼.ଽ+ା.୅ େ.୉ ୋ.୎ ୕.୘ ଡ଼+୞ ୟ+ୢ.୤ ୦)୰ ୱ+୲ ஂ.ஃ+஄ அ+஋ எ+஑ ஒ+஖ ங+஛ ஜ+஝ ஞ+஠ ண+஥ ந+஫ ம+஺ ா.௃ ெ.௉ ொ.௎ ௐ+௑ ௗ.௘ ௦)௰ ఀ.అ+఍ ఎ+఑ ఒ+఩ ప+఺ ఼.ఽ+ా.౅ ె.౉ ొ.౎ ౕ.౗ ౘ+౛ ౝ+౞ ౠ+ౢ.౤ ౦)౰ ಀ+ಁ.಄ ಅ+಍ ಎ+಑ ಒ+಩ ಪ+಴ ವ+಺ ಼.ಽ+ಾ.೅ ೆ.೉ ೊ.೎ ೕ.೗ ೝ+೟ ೠ+ೢ.೤ ೦)೰ ೱ+ೳ.೴ ഀ.ഄ+഍ എ+഑ ഒ+഻.ഽ+ാ.൅ െ.൉ ൊ.ൎ+൏ ൔ+ൗ.൘ ൟ+ൢ.൤ ൦)൰ ൺ+඀ ඁ.඄ අ+඗ ක+඲ ඳ+඼ ල+඾ ව+෇ ්.෋ ා.෕ ූ.෗ ෘ.෠ ෦)෰ ෲ.෴ ั.า ิ.฻ ็.๏ ๐)๚ ັ.າ ິ.ຽ ່.໏ ໐)໚ ༀ+༁ ༘.༚ ༠)༪ ༵.༶ ༷.༸ ༹.༺ ༾.ཀ+཈ ཉ+཭ ཱ.྅ ྆.ྈ+ྍ.྘ ྙ.྽ ࿆.࿇ ါ.ဿ ၀)၊ ၖ.ၚ ၞ.ၡ ၢ.ၥ ၧ.ၮ ၱ.ၵ ႂ.ႎ ႏ.႐)ႚ.႞ Ⴀ+჆ Ⴧ+჈ Ⴭ+჎ ა+჻ ჼ+቉ ቊ+቎ ቐ+቗ ቘ+቙ ቚ+቞ በ+኉ ኊ+኎ ነ+኱ ኲ+኶ ኸ+኿ ዀ+዁ ዂ+዆ ወ+዗ ዘ+጑ ጒ+጖ ጘ+፛ ፝.፠ ᎀ+᎐ Ꭰ+᏶ ᏸ+᏾ ᐁ+᙭ ᙯ+ $ᚁ+᚛ ᚠ+᛫ ᛮ+᛹ ᜀ+ᜒ.᜖ ᜟ+ᜲ.᜵ ᝀ+ᝒ.᝔ ᝠ+᝭ ᝮ+᝱ ᝲ.᝴ ឴.។ ៝.៞ ០)៪ ᠋.᠎-᠏.᠐)᠚ ᠠ+᡹ ᢀ+ᢅ.ᢇ+ᢩ.ᢪ+᢫ ᢰ+᣶ ᤀ+᤟ ᤠ.᤬ ᤰ.᤼ ᥆)ᥐ ᧐)᧛ ᨀ+ᨗ.᨜ ᩕ.᩟ ᩠.᩽ ᩿.᪀)᪊ ᪐)᪚ ᪰.᫏ ᬀ.ᬅ+᬴.ᭅ+᭍ ᭐)᭚ ᭫.᭴ ᮀ.ᮃ+ᮡ.ᮮ+᮰)ᮺ+᯦.᯴ ᰀ+ᰤ.᰸ ᱀)᱊ ᱍ+᱐)ᱚ+᱾ ᲀ+᲋ Ა+᲻ Ჽ+᳀ ᳐.᳓ ᳔.ᳩ+᳭.ᳮ+᳴.ᳵ+᳷.ᳺ+᳻ ᴀ+᷀.Ḁ+἖ Ἐ+἞ ἠ+὆ Ὀ+὎ ὐ+὘ Ὑ+὚ Ὓ+὜ Ὕ+὞ Ὗ+὾ ᾀ+᾵ ᾶ+᾽ ι+᾿ ῂ+῅ ῆ+῍ ῐ+῔ ῖ+῜ ῠ+῭ ῲ+῵ ῶ+´  $   $​ ‌.‍0‎-‐ ‘(‚ ․(‥ ‧*\\u2028"‪- ,‰ ‿,⁁ ⁄'⁅ ⁔,⁕  $⁠-⁥ ⁦-⁰ ⁱ+⁲ ⁿ+₀ ₐ+₝ ⃐.⃱ ℂ+℃ ℇ+℈ ℊ+℔ ℕ+№ ℙ+℞ ℤ+℥ Ω+℧ ℨ+℩ K+℮ ℯ+℺ ℼ+⅀ ⅅ+⅊ ⅎ+⅏ Ⅰ+↉ Ⓐ+⓪ Ⰰ+⳥ Ⳬ+⳯.Ⳳ+⳴ ⴀ+⴦ ⴧ+⴨ ⴭ+⴮ ⴰ+⵨ ⵯ+⵰ ⵿.ⶀ+⶗ ⶠ+⶧ ⶨ+⶯ ⶰ+⶷ ⶸ+⶿ ⷀ+⷇ ⷈ+⷏ ⷐ+⷗ ⷘ+⷟ ⷠ.⸀ ⸯ+⸰ 　$、 々+〆 〪.〰 〱1〶 〻+〽 ゙.゛1ゝ ゠1・ ー1㄀ ㄅ+㄰ ㄱ+㆏ ㆠ+㇀ ㇰ1㈀ ㋐1㋿ ㌀1㍘ ꀀ+꒍ ꓐ+꓾ ꔀ+꘍ ꘐ+꘠)ꘪ+꘬ Ꙁ+꙯.꙳ ꙴ.꙾ ꙿ+ꚞ.ꚠ+꛰.꛲ ꜈+꟎ Ꟑ+꟒ ꟓ+꟔ ꟕ+꟝ ꟲ+ꠂ.ꠃ+꠆.ꠇ+ꠋ.ꠌ+ꠣ.꠨ ꠬.꠭ ꡀ+꡴ ꢀ.ꢂ+ꢴ.꣆ ꣐)꣚ ꣠.ꣲ+꣸ ꣻ+꣼ ꣽ+ꣿ.꤀)ꤊ+ꤦ.꤮ ꤰ+ꥇ.꥔ ꥠ+꥽ ꦀ.ꦄ+꦳.꧁ ꧏ+꧐)꧚ ꧥ.ꧦ ꧰)ꧺ ꨀ+ꨩ.꨷ ꩀ+ꩃ.ꩄ+ꩌ.꩎ ꩐)꩚ ꩻ.ꩾ ꪰ.ꪱ ꪲ.ꪵ ꪷ.ꪹ ꪾ.ꫀ ꫁.ꫂ ꫠ+ꫫ.꫰ ꫲ+ꫵ.꫷ ꬁ+꬇ ꬉ+꬏ ꬑ+꬗ ꬠ+꬧ ꬨ+꬯ ꬰ+꭪ ꭰ+ꯣ.꯫ ꯬.꯮ ꯰)꯺ 가+힤 ힰ+퟇ ퟋ+퟼ ﬀ+﬇ ﬓ+﬘ יִ/ﬞ.ײַ/﬩ שׁ/﬷ טּ/﬽ מּ/﬿ נּ/﭂ ףּ/﭅ צּ/ﭐ+﮲ ﯓ+﴾ ﵐ+﶐ ﶒ+﷈ ﷰ+﷼ ︀.︐ ︓*︔ ︠.︰ ︳,︵ ﹍,﹐'﹑ ﹒(﹓ ﹔'﹕*﹖ ﹰ+﹵ ﹶ+﻽ \\uFEFF-＀ ＇(（ ，'－ ．(／ ０)：*；'＜ Ａ+［ ＿,｀ ａ+｛ ｦ1ﾞ.ﾠ+﾿ ￂ+￈ ￊ+￐ ￒ+￘ ￚ+￝ ￹-￼ ￿ \`,kt="𐀀+𐀌 𐀍+𐀧 𐀨+𐀻 𐀼+𐀾 𐀿+𐁎 𐁐+𐁞 𐂀+𐃻 𐅀+𐅵 𐇽.𐇾 𐊀+𐊝 𐊠+𐋑 𐋠.𐋡 𐌀+𐌠 𐌭+𐍋 𐍐+𐍶.𐍻 𐎀+𐎞 𐎠+𐏄 𐏈+𐏐 𐏑+𐏖 𐐀+𐒞 𐒠)𐒪 𐒰+𐓔 𐓘+𐓼 𐔀+𐔨 𐔰+𐕤 𐕰+𐕻 𐕼+𐖋 𐖌+𐖓 𐖔+𐖖 𐖗+𐖢 𐖣+𐖲 𐖳+𐖺 𐖻+𐖽 𐗀+𐗴 𐘀+𐜷 𐝀+𐝖 𐝠+𐝨 𐞀+𐞆 𐞇+𐞱 𐞲+𐞻 𐠀+𐠆 𐠈+𐠉 𐠊+𐠶 𐠷+𐠹 𐠼+𐠽 𐠿+𐡖 𐡠+𐡷 𐢀+𐢟 𐣠+𐣳 𐣴+𐣶 𐤀+𐤖 𐤠+𐤺 𐦀+𐦸 𐦾+𐧀 𐨀+𐨁.𐨄 𐨅.𐨇 𐨌.𐨐+𐨔 𐨕+𐨘 𐨙+𐨶 𐨸.𐨻 𐨿.𐩀 𐩠+𐩽 𐪀+𐪝 𐫀+𐫈 𐫉+𐫥.𐫧 𐬀+𐬶 𐭀+𐭖 𐭠+𐭳 𐮀+𐮒 𐰀+𐱉 𐲀+𐲳 𐳀+𐳳 𐴀+𐴤.𐴨 𐴰)𐴺 𐵀)𐵊+𐵦 𐵩.𐵮 𐵯+𐶆 𐺀+𐺪 𐺫.𐺭 𐺰+𐺲 𐻂+𐻅 𐻼.𐼀+𐼝 𐼧+𐼨 𐼰+𐽆.𐽑 𐽰+𐾂.𐾆 𐾰+𐿅 𐿠+𐿷 𑀀.𑀃+𑀸.𑁇 𑁦)𑁰.𑁱+𑁳.𑁵+𑁶 𑁿.𑂃+𑂰.𑂻 𑂽)𑂾 𑃂.𑃃 𑃍)𑃎 𑃐+𑃩 𑃰)𑃺 𑄀.𑄃+𑄧.𑄵 𑄶)𑅀 𑅄+𑅅.𑅇+𑅈 𑅐+𑅳.𑅴 𑅶+𑅷 𑆀.𑆃+𑆳.𑇁+𑇅 𑇉.𑇍 𑇎.𑇐)𑇚+𑇛 𑇜+𑇝 𑈀+𑈒 𑈓+𑈬.𑈸 𑈾.𑈿+𑉁.𑉂 𑊀+𑊇 𑊈+𑊉 𑊊+𑊎 𑊏+𑊞 𑊟+𑊩 𑊰+𑋟.𑋫 𑋰)𑋺 𑌀.𑌄 𑌅+𑌍 𑌏+𑌑 𑌓+𑌩 𑌪+𑌱 𑌲+𑌴 𑌵+𑌺 𑌻.𑌽+𑌾.𑍅 𑍇.𑍉 𑍋.𑍎 𑍐+𑍑 𑍗.𑍘 𑍝+𑍢.𑍤 𑍦.𑍭 𑍰.𑍵 𑎀+𑎊 𑎋+𑎌 𑎎+𑎏 𑎐+𑎶 𑎷+𑎸.𑏁 𑏂.𑏃 𑏅.𑏆 𑏇.𑏋 𑏌.𑏑+𑏒.𑏓+𑏔 𑏡.𑏣 𑐀+𑐵.𑑇+𑑋 𑑐)𑑚 𑑞.𑑟+𑑢 𑒀+𑒰.𑓄+𑓆 𑓇+𑓈 𑓐)𑓚 𑖀+𑖯.𑖶 𑖸.𑗁 𑗘+𑗜.𑗞 𑘀+𑘰.𑙁 𑙄+𑙅 𑙐)𑙚 𑚀+𑚫.𑚸+𑚹 𑛀)𑛊 𑛐)𑛤 𑜝.𑜬 𑜰)𑜺 𑠀+𑠬.𑠻 𑢠+𑣠)𑣪 𑣿+𑤇 𑤉+𑤊 𑤌+𑤔 𑤕+𑤗 𑤘+𑤰.𑤶 𑤷.𑤹 𑤻.𑤿+𑥀.𑥁+𑥂.𑥄 𑥐)𑥚 𑦠+𑦨 𑦪+𑧑.𑧘 𑧚.𑧡+𑧢 𑧣+𑧤.𑧥 𑨀+𑨁.𑨋+𑨳.𑨺+𑨻.𑨿 𑩇.𑩈 𑩐+𑩑.𑩜+𑪊.𑪚 𑪝+𑪞 𑪰+𑫹 𑯀+𑯡 𑯰)𑯺 𑰀+𑰉 𑰊+𑰯.𑰷 𑰸.𑱀+𑱁 𑱐)𑱚 𑱲+𑲐 𑲒.𑲨 𑲩.𑲷 𑴀+𑴇 𑴈+𑴊 𑴋+𑴱.𑴷 𑴺.𑴻 𑴼.𑴾 𑴿.𑵆+𑵇.𑵈 𑵐)𑵚 𑵠+𑵦 𑵧+𑵩 𑵪+𑶊.𑶏 𑶐.𑶒 𑶓.𑶘+𑶙 𑶠)𑶪 𑻠+𑻳.𑻷 𑼀.𑼂+𑼃.𑼄+𑼑 𑼒+𑼴.𑼻 𑼾.𑽃 𑽐)𑽚.𑽛 𑾰+𑾱 𒀀+𒎚 𒐀+𒑯 𒒀+𒕄 𒾐+𒿱 𓀀+𓐰-𓑀.𓑁+𓑇.𓑖 𓑠+𔏻 𔐀+𔙇 𖄀+𖄞.𖄰)𖄺 𖠀+𖨹 𖩀+𖩟 𖩠)𖩪 𖩰+𖪿 𖫀)𖫊 𖫐+𖫮 𖫰.𖫵 𖬀+𖬰.𖬷 𖭀+𖭄 𖭐)𖭚 𖭣+𖭸 𖭽+𖮐 𖵀+𖵭 𖵰)𖵺 𖹀+𖺀 𖼀+𖽋 𖽏.𖽐+𖽑.𖾈 𖾏.𖾓+𖾠 𖿠+𖿢 𖿣+𖿤.𖿥 𖿰.𖿲 𚿰1𚿴 𚿵1𚿼 𚿽1𚿿 𛀀1𛀁 𛄠1𛄣 𛅕1𛅖 𛅤1𛅨 𛰀+𛱫 𛱰+𛱽 𛲀+𛲉 𛲐+𛲚 𛲝.𛲟 𛲠-𛲤 𜳰)𜳺 𜼀.𜼮 𜼰.𜽇 𝅥.𝅪 𝅭.𝅳-𝅻.𝆃 𝆅.𝆌 𝆪.𝆮 𝉂.𝉅 𝐀+𝑕 𝑖+𝒝 𝒞+𝒠 𝒢+𝒣 𝒥+𝒧 𝒩+𝒭 𝒮+𝒺 𝒻+𝒼 𝒽+𝓄 𝓅+𝔆 𝔇+𝔋 𝔍+𝔕 𝔖+𝔝 𝔞+𝔺 𝔻+𝔿 𝕀+𝕅 𝕆+𝕇 𝕊+𝕑 𝕒+𝚦 𝚨+𝛁 𝛂+𝛛 𝛜+𝛻 𝛼+𝜕 𝜖+𝜵 𝜶+𝝏 𝝐+𝝯 𝝰+𝞉 𝞊+𝞩 𝞪+𝟃 𝟄+𝟌 𝟎)𝠀 𝨀.𝨷 𝨻.𝩭 𝩵.𝩶 𝪄.𝪅 𝪛.𝪠 𝪡.𝪰 𝼀+𝼟 𝼥+𝼫 𞀀.𞀇 𞀈.𞀙 𞀛.𞀢 𞀣.𞀥 𞀦.𞀫 𞀰+𞁮 𞂏.𞂐 𞄀+𞄭 𞄰.𞄷+𞄾 𞅀)𞅊 𞅎+𞅏 𞊐+𞊮.𞊯 𞋀+𞋬.𞋰)𞋺 𞓐+𞓬.𞓰)𞓺 𞗐+𞗮.𞗰+𞗱)𞗻 𞟠+𞟧 𞟨+𞟬 𞟭+𞟯 𞟰+𞟿 𞠀+𞣅 𞣐.𞣗 𞤀+𞥄.𞥋+𞥌 𞥐)𞥚 𞸀+𞸄 𞸅+𞸠 𞸡+𞸣 𞸤+𞸥 𞸧+𞸨 𞸩+𞸳 𞸴+𞸸 𞸹+𞸺 𞸻+𞸼 𞹂+𞹃 𞹇+𞹈 𞹉+𞹊 𞹋+𞹌 𞹍+𞹐 𞹑+𞹓 𞹔+𞹕 𞹗+𞹘 𞹙+𞹚 𞹛+𞹜 𞹝+𞹞 𞹟+𞹠 𞹡+𞹣 𞹤+𞹥 𞹧+𞹫 𞹬+𞹳 𞹴+𞹸 𞹹+𞹽 𞹾+𞹿 𞺀+𞺊 𞺋+𞺜 𞺡+𞺤 𞺥+𞺪 𞺫+𞺼 🄰+🅊 🅐+🅪 🅰+🆊 🇦2🈀 🏻.🐀 🯰)🯺 󠀁-󠀂 󠀠.󠂀 󠄀.󠇰 ";function Mt(s){let t=s<=65535?2:3,r=t==2?yt:kt;return He(r,s,t,0,r.length/t-1)-32}d(Mt,"searchForProperty");function He(s,t,r,n,i){if(i<n)return 0;let o=n+~~((i-n)/2),a=s.codePointAt(r*o),u=s.codePointAt(r*(o+1)),l=isNaN(u)?1/0:u;return t<a?He(s,t,r,n,o-1):t>=l?He(s,t,r,o+1,i):s.charCodeAt(r*(o+1)-1)}d(He,"_searchForProperty");function D(s,t){let r=Xt(s,t);if(r.length==0)return[];let n=[];for(let i=0;i<r.length-1;i++){let o=r[i],a=r[i+1],u=new Le(s,o,a);jt(u.text,t)?n.push(u):i==r.length-2&&(u=new Le(s,a,a),n.push(u))}return n}d(D,"default_");var je=class je{constructor(t,r,n){this._source=t,this.start=r,this.end=n}get text(){return this._source.substring(this.start,this.end)}get length(){return this.end-this.start}};d(je,"LazySpan");var Le=je,$=class \${constructor(t,r,n,i,o,a){this.lookbehind=19;this.left=19;this.right=19;this.text=t,this.options=r,arguments.length==3?this.lookahead=this.wordbreakPropertyAt(n):(this.lookbehind=n,this.left=i,this.right=o,this.lookahead=a)}next(t){let r=this.wordbreakPropertyAt(t);return new $(this.text,this.options,this.left,this.right,this.lookahead,r)}ignoringRight(t){let r=this.wordbreakPropertyAt(t);return new $(this.text,this.options,this.lookbehind,this.left,this.lookahead,r)}ignoringLookahead(t){let r=this.wordbreakPropertyAt(t);return new $(this.text,this.options,this.lookbehind,this.left,this.right,r)}wordbreakPropertyAt(t){return t<0?19:t>=this.text.length?20:Lt(this.text[t])?Ge(this.text[t]+this.text[t+1]):Ge(this.text[t],this.options)}match(t,r,n,i){var a,u,l,c;let o=(a=t==null?void 0:t.includes(this.lookbehind))!=null?a:!0;return o=o&&((u=r==null?void 0:r.includes(this.left))!=null?u:!0),o=o&&((l=n==null?void 0:n.includes(this.right))!=null?l:!0),o&&((c=i==null?void 0:i.includes(this.lookahead))!=null?c:!0)}propertyMatch(t,r,n,i){let o=d(a=>vt(a,this.options),"propMapper");return this.match(t==null?void 0:t.map(o),r==null?void 0:r.map(o),n==null?void 0:n.map(o),i==null?void 0:i.map(o))}};d($,"BreakerContext");var ze=$;function jt(s,t){return!s.split("").map(r=>Ge(r,t)).every(r=>r===3||r===1||r===2||r===4)}d(jt,"isNonSpace");function Xt(s,t){if(s.length===0)return[];t&&!t.rules&&(t.rules=[]);let r=[],n,i=0,o=new ze(s,t,i),a=0;do{if(n=i,i=u(i),o=o.next(i),o.match(null,[19],null,null)){r.push(n);continue}if(o.match(null,null,[20],null)){r.push(n);break}if(o.match(null,[3],[1],null))continue;let l=[2,3,1];if(o.match(null,l,null,null)){r.push(n);continue}if(o.match(null,null,l,null)){r.push(n);continue}if(o.match(null,[4],[4],null))continue;let c=[13,14,16];for(;o.match(null,null,c,null);)[n,i]=[i,u(i)],o=o.ignoringRight(i);if(o.right===20){r.push(n);break}for(;o.match(null,null,null,c);)i=u(i),o=o.ignoringLookahead(i);let p=[11,15],h=[8,6];if(t!=null&&t.rules){let b=!1;for(let f of t.rules)if(b=f.match(o),b){f.breakIfMatch&&r.push(n);break}if(b)continue}if(o.match(null,p,p,null))continue;let g=[10].concat(h);if(o.match(null,p,g,p)||o.match(p,g,p,null)||o.match(null,[15],[6],null)||o.match(null,[15],[5],[15])||o.match([15],[5],[15],null)||o.match(null,[9],[9],null)||o.match(null,p,[9],null)||o.match(null,[9],p,null))continue;let m=[7].concat(h);if(o.match([9],m,[9],null)||o.match(null,[9],m,[9])||o.match(null,[17],[17],null))continue;let C=[17,9].concat(p);if(!o.match(null,C,[12],null)&&!o.match(null,[12],[12],null)&&!o.match(null,[12],C,null)){if(o.right===18){if(a+=1,a%2==1)continue}else a=0;r.push(n)}}while(n<s.length);return r;function u(l){return l>=s.length?s.length:Lt(s[l])?l+2:l+1}}d(Xt,"findBoundaries");function Lt(s){let t=s.charCodeAt(0);return t>=55296&&t<=56319}d(Lt,"isStartOfSurrogatePair");function Ge(s,t){if(t!=null&&t.propertyMapping){let n=t.propertyMapping(s);if(n)return vt(n,t)}let r=s.codePointAt(0);return Mt(r)}d(Ge,"property");function vt(s,t){var i,o;let r=d(a=>a.toLowerCase()==s.toLowerCase(),"matcher"),n=(o=(i=t==null?void 0:t.customProperties)==null?void 0:i.findIndex(r))!=null?o:-1;return n!=-1?-n-1:bt.findIndex(r)}d(vt,"propertyVal");R();var Et=12,_=class _{constructor(t,r,n){this.root=t,this.prefix=r,this.totalWeight=n}child(t){if(t=="")return this;let r=t.split(""),n=this;for(;r.length>0&&n;){let i=r.shift();n=n._child(i)}return n}_child(t){let r=this.root,n=this.totalWeight,i=this.prefix+t;if(r.type=="internal"){let o=r.children[t];return o?new _(o,i,n):void 0}else return r.entries.filter(function(a){return a.key.indexOf(i)==0}).length?new _(r,i,n):void 0}*children(){let t=this.root,r=this.totalWeight;if(t.type=="internal"){for(let n of t.values){let i=t.children[n];if(W(n))if(i.type=="internal"){let o=i;for(let a of o.values){let u=this.prefix+n+a;yield{char:n+a,traversal:function(){return new _(o.children[a],u,r)}}}}else{let o=i.entries[0].key;n=n+o[this.prefix.length+1];let a=this.prefix+n;yield{char:n,traversal:function(){return new _(i,a,r)}}}else{if(ke(n))continue;if(n){let o=this.prefix+n;yield{char:n,traversal:function(){return new _(i,o,r)}}}else continue}}return}else{let n=this.prefix,i=t.entries.filter(function(o){return o.key!=n&&n.length<o.key.length});for(let{key:o}of i){let a=o[n.length];W(a)&&(a=a+o[n.length+1]),yield{char:a,traversal:function(){return new _(t,n+a,r)}}}return}}get entries(){let t=d(r=>({text:r.content,p:r.weight/this.totalWeight}),"entryMapper");if(this.root.type=="leaf"){let r=this.prefix;return this.root.entries.filter(function(i){return i.key==r}).map(t)}else{let r=this.root.children[N];return r&&r.type=="leaf"?r.entries.map(t):[]}}get p(){return this.root.weight/this.totalWeight}};d(_,"Traversal");var Xe=_,$e=class $e{constructor(t,r={}){this.languageUsesCasing=r.languageUsesCasing,this.applyCasing=r.applyCasing,this._trie=new Ye(t.root,t.totalWeight,r.searchTermToKey||Yt),this.breakWords=r.wordBreaker||D,this.punctuation=r.punctuation}configure(t){var r;return this.configuration={leftContextCodePoints:t.maxLeftContextCodePoints,rightContextCodePoints:(r=t.maxRightContextCodePoints)!=null?r:0}}toKey(t){return this._trie.toKey(t)}predict(t,r){if(!t.insert&&!r.left&&!r.right&&r.startOfBuffer&&r.endOfBuffer)return a(this._trie.firstN(Et).map(({text:u,p:l})=>({transform:{insert:u,deleteLeft:0},displayAs:u,p:l})));let n=x(t,r),i=t.deleteLeft-t.insert.kmwLength(),o=le(this.breakWords,n);return a(this._trie.lookup(o).map(({text:u,p:l})=>q({insert:u,deleteLeft:i+o.kmwLength()},l)));function a(u){let l=[];for(let c of u)l.push({sample:c,p:c.p});return l}}get wordbreaker(){return this.breakWords}traverseFromRoot(){return this._trie.traverseFromRoot()}};d($e,"TrieModel");var ce=$e,Je=class Je{constructor(t,r,n){this.root=t,this.toKey=n,this.totalWeight=r}traverseFromRoot(){return new Xe(this.root,"",this.totalWeight)}lookup(t){let r=this.toKey(t),n=this.traverseFromRoot().child(r);if(!n)return[];let i=n.entries,o={};for(let l of i)o[l.text]=l.text;let u=wt(n).filter(l=>!o[l.text]);return i.concat(u)}firstN(t){return wt(this.traverseFromRoot(),t)}};d(Je,"Trie");var Ye=Je;function wt(s,t=Et){let r=new k(function(i,o){return(o?o.p:0)-(i?i.p:0)}),n=[];for(r.enqueue(s);r.count>0;){let i=r.dequeue();if(i.text!==void 0){let o=i;if(n.push(o),n.length>=t)return n}else{let o=i;r.enqueueAll(o.entries);let a=[];for(let u of o.children())a.push(u.traversal());r.enqueueAll(a)}}return n}d(wt,"getSortedResults");function Yt(s){return s.normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").toLowerCase()}d(Yt,"defaultSearchTermToKey");var tt=class tt{constructor(t){t=t||{},this._futureSuggestions=t.futureSuggestions?t.futureSuggestions.slice():[],t.punctuation&&(this.punctuation=t.punctuation),this.toKey=t.toKey,this.wordbreaker=t.wordbreaker,this.applyCasing=t.applyCasing,this.languageUsesCasing=t.languageUsesCasing}configure(t){return this.configuration={leftContextCodePoints:t.maxLeftContextCodePoints,rightContextCodePoints:t.maxRightContextCodePoints},this.configuration}predict(t,r,n){let i=d(function(a){let u=[];for(let l of a)u.push({sample:l,p:l.p!==void 0?l.p:1});return u},"makeUniformDistribution");if(n)return i(n);let o=this._futureSuggestions.shift();return o?i(o):[]}};d(tt,"DummyModel");var et=tt,Pt=et;var Ce={};_e(Ce,{ClassicalDistanceCalculation:()=>Q,ContextTracker:()=>Te,ExecutionBucket:()=>pe,ExecutionSpan:()=>V,ExecutionTimer:()=>de,QUEUE_NODE_COMPARATOR:()=>Ee,STANDARD_TIME_BETWEEN_DEFERS:()=>we,SearchNode:()=>Pe,SearchResult:()=>me,SearchSpace:()=>v,TrackedContextState:()=>z,TrackedContextSuggestion:()=>ut,TrackedContextToken:()=>G});var T=class T{constructor(t){this.diagonalWidth=2;this.inputSequence=[];this.matchSequence=[];if(t){let r=t.resolvedDistances.length;this.resolvedDistances=Array(r);for(let n=0;n<r;n++)this.resolvedDistances[n]=t.resolvedDistances[n].slice(0);this.inputSequence=t.inputSequence.slice(0),this.matchSequence=t.matchSequence.slice(0),this.diagonalWidth=t.diagonalWidth}else this.resolvedDistances=[]}getTrueIndex(t,r,n){let i={row:t,col:r-t+n,sparse:!1};return(i.col<0||i.col>2*n)&&(i.sparse=!0),i}getCostAt(t,r,n=this.diagonalWidth){if(t<0||r<0)return t==-1&&r>=-1?r+1:r==-1&&t>=-1?t+1:Number.MAX_VALUE;let i=this.getTrueIndex(t,r,n);return i.sparse?Number.MAX_VALUE:this.resolvedDistances[i.row][i.col]}getFinalCost(){let t=this,r=t.getHeuristicFinalCost();for(;r>t.diagonalWidth;)t=t.increaseMaxDistance(),r=t.getHeuristicFinalCost();return r}getHeuristicFinalCost(){return this.getCostAt(this.inputSequence.length-1,this.matchSequence.length-1)}hasFinalCostWithin(t){let r=this,n=r.getHeuristicFinalCost(),i=this.diagonalWidth;do{if(n<=t)return!0;if(i<t)r=r.increaseMaxDistance(),i++,n=r.getHeuristicFinalCost();else break}while(!0);return!1}editPath(t=this.inputSequence.length-1,r=this.matchSequence.length-1){let n=this.getCostAt(t,r),i=null,o=null,a=this.getCostAt(t,r-1),u=this.getCostAt(t-1,r),l=this.getCostAt(t-1,r-1),[c,p]=T.getTransposeParent(this,t,r);if(c>=0&&p>=0){let h=1;if(i=["transpose-start"],c!=t-1){let g=t-c-1;i=i.concat(Array(g).fill("transpose-delete")),h+=g}else{let g=r-p-1;i=i.concat(Array(g).fill("transpose-insert")),h+=g}i.push("transpose-end"),this.getCostAt(c-1,p-1)!=n-h&&(i=null),o=[c-1,p-1]}return i||(l==n-1?(i=["substitute"],o=[t-1,r-1]):a==n-1?(i=["insert"],o=[t,r-1]):u==n-1?(i=["delete"],o=[t-1,r]):(i=["match"],o=[t-1,r-1])),o[0]>=0&&o[1]>=0?this.editPath(o[0],o[1]).concat(i):o[0]>-1?Array(o[0]+1).fill("delete").concat(i):o[1]>-1?Array(o[1]+1).fill("insert").concat(i):i}static getTransposeParent(t,r,n){if(r<0||n<0||t.inputSequence[r].key==t.matchSequence[n].key)return[-1,-1];let i=-1;for(let a=r-1;a>=0;a--)if(t.inputSequence[a].key==t.matchSequence[n].key){i=a;break}let o=-1;for(let a=n-1;a>=0;a--)if(t.matchSequence[a].key==t.inputSequence[r].key){o=a;break}return[i,o]}static initialCostAt(t,r,n,i,o){var a=t.inputSequence[r].key==t.matchSequence[n].key?0:1,u=t.getCostAt(r-1,n-1)+a,l=i||t.getCostAt(r,n-1)+1,c=o||t.getCostAt(r-1,n)+1,p=Number.MAX_VALUE;if(r>0&&n>0){let[h,g]=T.getTransposeParent(t,r,n);p=t.getCostAt(h-1,g-1)+(r-h-1)+1+(n-g-1)}return Math.min(u,c,l,p)}getSubset(t,r){let n=new T(this);if(t>this.inputSequence.length||r>this.matchSequence.length)throw"Invalid dimensions specified for trim operation";n.inputSequence.splice(t),n.matchSequence.splice(r),n.resolvedDistances.splice(t);let i=this.getTrueIndex(t-1,r-1,this.diagonalWidth);for(let o=i.col;o<=2*this.diagonalWidth;o++){let a=i.row-(o-i.col);if(a<0)break;if(o<0)n.resolvedDistances[a]=Array(2*n.diagonalWidth+1).fill(Number.MAX_VALUE);else{let u=2*this.diagonalWidth-o,l=n.resolvedDistances[a].splice(0,o+1),c=Array(u).fill(Number.MAX_VALUE);n.resolvedDistances[a]=l.concat(c)}}return n}static forDiagonalOfAxis(t,r,n,i){let o=n-r<t?n-r+t:2*t,a=r-t,u=a<0?0:a;for(let l=u-a;l<=o;l++)i(a+l,l)}addInputChar(t){let r=new T(this),n=r.inputSequence.length;r.inputSequence.push(t);let i=Array(2*r.diagonalWidth+1).fill(Number.MAX_VALUE);return r.resolvedDistances[n]=i,r.matchSequence.length==0||T.forDiagonalOfAxis(r.diagonalWidth,n,r.matchSequence.length-1,function(o,a){i[a]=T.initialCostAt(r,n,o)}),r}addMatchChar(t){let r=new T(this),n=r.matchSequence.length;return r.matchSequence.push(t),r.inputSequence.length==0||T.forDiagonalOfAxis(r.diagonalWidth,n,r.inputSequence.length-1,function(i,o){var a=r.resolvedDistances[i];a[2*r.diagonalWidth-o]=T.initialCostAt(r,i,n)}),r}increaseMaxDistance(){let t=new T(this);if(t.diagonalWidth++,t.inputSequence.length<1||t.matchSequence.length<1)return t;function r(i,o,a,u){let l=2*(t.diagonalWidth-1),c=a.length-1;l=l<c-i?l:c-i;for(let p=0;p<=l;p++)o==a[i+p].key&&u(i+p,p)}d(r,"forPossibleTranspositionsInDiagonal");for(let i=0;i<t.inputSequence.length;i++){let o=Number.MAX_VALUE,a=i-t.diagonalWidth;if(a>=0){let l=a==0?i+2:Number.MAX_VALUE;o=T.initialCostAt(t,i,a,l,void 0);let c=o;if(a<t.matchSequence.length-1){T.propagateUpdateFrom(t,i,a+1,c+1,0);let p=i+2;if(i+2<this.inputSequence.length){let h=t.inputSequence[i+1].key;r(a+3,h,t.matchSequence,function(g,m){T.propagateUpdateFrom(t,p,g,c+m+2,m)})}}}let u=Number.MAX_VALUE;if(a=i+t.diagonalWidth,a<t.matchSequence.length){let l=i==0?a+2:Number.MAX_VALUE;var n=t.getCostAt(i,a-1,this.diagonalWidth)+1;u=T.initialCostAt(t,i,a,n,l);let c=u;if(i<t.inputSequence.length-1){T.propagateUpdateFrom(t,i+1,a,c+1,2*this.diagonalWidth);let p=a+2;if(a+2<this.matchSequence.length){let h=t.matchSequence[i+1].key;r(i+3,h,t.inputSequence,function(g,m){let C=2*(t.diagonalWidth-1)-m;T.propagateUpdateFrom(t,g,p,c+m+2,C)})}}}t.resolvedDistances[i]=[o].concat(t.resolvedDistances[i],u)}return t}static propagateUpdateFrom(t,r,n,i,o){if(i<t.resolvedDistances[r][o])t.resolvedDistances[r][o]=i;else return;let a=r<t.inputSequence.length-1,u=n<t.matchSequence.length-1;if(o<2*(t.diagonalWidth-1)&&u){let l=i+1;this.propagateUpdateFrom(t,r,n+1,l,o+1)}if(o>0&&a){let l=i+1;this.propagateUpdateFrom(t,r+1,n,l,o-1)}if(a&&u){let l=i+(t.inputSequence[r+1].key==t.matchSequence[n+1].key?0:1);this.propagateUpdateFrom(t,r+1,n+1,l,o);let c=-1;for(let h=r+2;h<t.inputSequence.length;h++)if(t.inputSequence[h].key==t.matchSequence[n+1].key){c=h;break}let p=-1;for(let h=n+2;h<t.matchSequence.length;h++)if(t.matchSequence[h].key==t.inputSequence[r+1].key){p=h;break}if(c>0&&p>0){let h=i+(c-r-2)+1+(p-n-2);this.propagateUpdateFrom(t,c,p,h,t.diagonalWidth-1+p-c)}}}get mapKey(){let t=this.inputSequence.map(n=>n.key).join(""),r=this.matchSequence.map(n=>n.key).join("");return t+N+r+N+this.diagonalWidth}get lastInputEntry(){return this.inputSequence[this.inputSequence.length-1]}get lastMatchEntry(){return this.matchSequence[this.matchSequence.length-1]}static computeDistance(t,r,n=1){let i=new T;n=n||1,i.diagonalWidth=n;for(let o=0;o<t.length;o++)i=i.addInputChar(t[o]);for(let o=0;o<r.length;o++)i=i.addMatchChar(r[o]);return i}};d(T,"ClassicalDistanceCalculation");var Q=T;var $t=1,It=5,we=5,rt=class rt{constructor(t){this.timeSpent=0;this.eventCount=0;this.timeSquared=0;this.nearOutliers=[];this.outliers=[];this.preventOutliers=!1;this.preventOutliers=!!t}add(t){if(t<0)throw new Error("time may not be negative");this.eventCount++,this.timeSpent+=t,this.timeSquared+=t*t,t>=$t&&(this.nearOutliers.length<It||this.nearOutliers[It-1]<t)&&(this.nearOutliers.push(t),this.nearOutliers.sort((r,n)=>n-r)),this.checkForOutlier()}checkForOutlier(){if(this.preventOutliers||this.eventCount<4||this.nearOutliers.length==0)return;let t=this.nearOutliers[0];this.timeSpent-=t,this.timeSquared-=t*t,this.eventCount--;let r=this.average,n=t-r,i=this.variance,o=n*n/i;o>=49||this.eventCount>=8&&o>=9?(this.nearOutliers.shift(),this.outliers.push(t)):(this.timeSpent+=t,this.timeSquared+=t*t,this.eventCount++)}get average(){return this.timeSpent/this.eventCount}get variance(){let t=this.eventCount;return t<=1?NaN:this.timeSquared/t-this.timeSpent*this.timeSpent/(t*t)}get outlierTime(){let t=0;for(let r=0;r<this.outliers.length;r++)t+=this.outliers[r];return t}};d(rt,"ExecutionBucket");var pe=rt,nt=class nt{constructor(t,r){this.bucket=t,this.finalizer=r,this.start=performance.now()}end(){var t,r;this.finish=performance.now(),(t=this.bucket)==null||t.add(this.duration),(r=this.finalizer)==null||r.call(this)}get duration(){var t;return((t=this.finish)!=null?t:performance.now())-this.start}};d(nt,"ExecutionSpan");var V=nt,it=class it{constructor(t,r){this.buckets={};this.deferBucket=new pe(!0);this.activeSpan=null;this.spanSinceLastDefer=null;this.trueStart=performance.now(),this.maxExecutionTime=t,this.maxTrueTime=r,this.spanSinceLastDefer=new V}validateStart(){if(this.activeSpan)throw new Error("illegal state - span-based timer still pending")}getBucket(t){t!=null||(t=-1);let r=this.buckets[t];return r||(r=this.buckets[t]=new pe),r}get executionTime(){let t=Object.values(this.buckets),r=0;for(let n of t)r+=n.timeSpent;return r}get deferredTime(){let t=Object.values(this.buckets),r=0;for(let n of t)r+=n.outlierTime;return r+=this.deferBucket.timeSpent,r}time(t,r){this.validateStart();let n=performance.now(),i=t(),o=performance.now()-n;return this.getBucket(r).add(o),i}defer(t){return U(this,null,function*(){this.validateStart(),t!=null||(t=0),this.activeSpan=new V(this.deferBucket,()=>this.activeSpan=null),yield Fe(t),this.activeSpan.end(),this.spanSinceLastDefer=new V})}get timeSinceLastDefer(){return this.spanSinceLastDefer.duration}start(t){this.validateStart();let r=this.getBucket(t);return this.activeSpan=new V(r,()=>{this.activeSpan=null}),this.activeSpan}terminate(){this.maxTrueTime=0}get elapsed(){return performance.now()-this.trueStart>=this.maxTrueTime?!0:this.executionTime>=this.maxExecutionTime}};d(it,"ExecutionTimer");var de=it;var Ee=d(function(s,t){return s.currentCost-t.currentCost},"QUEUE_NODE_COMPARATOR");var H=class H{constructor(t,r){this.toKey=d(t=>t,"toKey");if(r=r||(n=>n),t instanceof H){let n=t;this.calculation=n.calculation,this.currentTraversal=n.currentTraversal,this.priorInput=n.priorInput,this.toKey=n.toKey}else this.calculation=new Q,this.currentTraversal=t,this.priorInput=[],this.toKey=r}get knownCost(){return this.calculation.getHeuristicFinalCost()}get inputSamplingCost(){if(this._inputCost!==void 0)return this._inputCost;{let t=v.MIN_KEYSTROKE_PROBABILITY;return this._inputCost=this.priorInput.map(r=>r.p>t?r.p:t).reduce((r,n)=>r-Math.log(n),0),this._inputCost}}get currentCost(){return v.EDIT_DISTANCE_COST_SCALE*this.knownCost+this.inputSamplingCost}buildInsertionEdges(){let t=[];for(let r of this.currentTraversal.children()){let n=r.traversal(),i={key:r.char,traversal:n},o=this.calculation.addMatchChar(i),a=new H(this);a.calculation=o,a.priorInput=this.priorInput,a.currentTraversal=n,t.push(a)}return t}buildDeletionEdges(t){let r=[];for(let n of t){if(n.p<t[0].p*Math.exp(-v.EDIT_DISTANCE_COST_SCALE))break;let i=this.calculation,o=n.sample;o.deleteLeft&&(i=i.getSubset(i.inputSequence.length-o.deleteLeft,i.matchSequence.length));let a=this.priorInput.slice(0);a.push(n);for(let l=0;l<o.insert.length;l++){let c=o.insert[l];W(c)&&(l++,c=c+o.insert[l]);let p=this.toKey(c);p&&(i=i.addInputChar({key:p}))}let u=new H(this);u.calculation=i,u.priorInput=a,r.push(u)}return r}buildSubstitutionEdges(t){let r=this.buildDeletionEdges(t),n=[];for(let i of this.currentTraversal.children())for(let o of r){let a=i.traversal(),u={key:i.char,traversal:a},l=o.calculation.addMatchChar(u),c=new H(this);c.calculation=l,c.priorInput=o.priorInput,c.currentTraversal=a,n.push(c)}return n}get pathKey(){let t=this.priorInput.map(n=>"+"+n.sample.insert+"-"+n.sample.deleteLeft).join(""),r=this.calculation.matchSequence.map(n=>n.key).join("");return t+N+r}get resultKey(){return this.calculation.matchSequence.map(t=>t.key).join("")}get isFullReplacement(){return this.knownCost&&this.knownCost==this.priorInput.length}};d(H,"SearchNode");var Pe=H,ot=class ot{constructor(t,r){this.processed=[];if(typeof t=="number"){this.index=t,this.correctionQueue=new k(Ee,r);return}else this.index=t.index,this.processed=[].concat(t.processed),this.correctionQueue=new k(t.correctionQueue)}increaseMaxEditDistance(){let t=this.correctionQueue.toArray();t.forEach(function(r){r.calculation=r.calculation.increaseMaxDistance()}),this.correctionQueue=new k(Ee,t)}};d(ot,"SearchSpaceTier");var he=ot,st=class st{constructor(t){this.resultNode=t}get inputSequence(){return this.resultNode.priorInput}get matchSequence(){return this.resultNode.calculation.matchSequence}get matchString(){return this.resultNode.resultKey}get knownCost(){return this.resultNode.knownCost}get inputSamplingCost(){return this.resultNode.inputSamplingCost}get totalCost(){return this.resultNode.currentCost}get finalTraversal(){return this.resultNode.currentTraversal}};d(st,"SearchResult");var me=st,B=class B{constructor(t){this.tierOrdering=[];this.inputSequence=[];this.minInputCost=[];this.returnedValues={};this.processedEdgeSet={};if(this.buildQueueSpaceComparator(),t instanceof B){this.inputSequence=[].concat(t.inputSequence),this.minInputCost=[].concat(t.minInputCost),this.rootNode=t.rootNode,this.completedPaths=[].concat(t.completedPaths),this.returnedValues=O({},t.returnedValues),this.processedEdgeSet=O({},t.processedEdgeSet),this.tierOrdering=t.tierOrdering.map(i=>new he(i)),this.selectionQueue=new k(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering);return}let r=t;if(r){if(!r.traverseFromRoot)throw"The provided model does not implement the \`traverseFromRoot\` function, which is needed to support robust correction searching."}else throw"The LexicalModel parameter must not be null / undefined.";this.selectionQueue=new k(this.QUEUE_SPACE_COMPARATOR),this.rootNode=new Pe(r.traverseFromRoot(),r.toKey?r.toKey.bind(r):null),this.completedPaths=[this.rootNode];let n=new he(0,[this.rootNode]);this.tierOrdering.push(n),this.selectionQueue.enqueue(n)}buildQueueSpaceComparator(){let t=this;this.QUEUE_SPACE_COMPARATOR=function(r,n){let i=r.correctionQueue.peek(),o=n.correctionQueue.peek(),a=r.index,u=n.index,l=0,c=1;if(u<a){let p=u;u=a,a=p,c=-1}for(let p=a;p<u;p++)l=l+t.minInputCost[p];return i&&o?i.currentCost-o.currentCost+c*l:o?1:-1}}increaseMaxEditDistance(){this.tierOrdering.forEach(function(t){t.increaseMaxEditDistance()})}addInput(t){this.inputSequence.push(t),this.minInputCost.push(-Math.log(t[0].p));let r=[],n=this.completedPaths.map(function(o){let a=o.buildDeletionEdges(t),u=o.buildSubstitutionEdges(t);return a.concat(u)});this.completedPaths=[],this.returnedValues={},n.forEach(function(o){r=r.concat(o)});let i=new he(this.tierOrdering.length,r);this.tierOrdering.push(i),this.selectionQueue.enqueue(i)}removeLastInput(){}hasNextMatchEntry(){let t=this.selectionQueue.peek();return t?t.correctionQueue.count>0:!1}handleNextNode(){if(!this.hasNextMatchEntry())return{type:"none"};let t=this.selectionQueue.dequeue(),r=t.correctionQueue.dequeue(),n={type:"intermediate",cost:r.currentCost};if(this.processedEdgeSet[r.pathKey])return this.selectionQueue.enqueue(t),n;this.processedEdgeSet[r.pathKey]=!0;let i=!1;if(r.knownCost>2)return n;r.knownCost==2&&(i=!0);let o=0;for(let a=0;a<=t.index;a++)o+=this.minInputCost[a];if(r.currentCost>o+2.5*B.EDIT_DISTANCE_COST_SCALE)return n;if(!i){let a=r.buildInsertionEdges();t.correctionQueue.enqueueAll(a)}if(t.index==this.tierOrdering.length-1)return this.completedPaths.push(r),this.selectionQueue.enqueue(t),{type:"complete",cost:r.currentCost,finalNode:r};{let a=this.tierOrdering[t.index+1],u=a.index,l=[];i||(l=r.buildDeletionEdges(this.inputSequence[u-1]));let c=r.buildSubstitutionEdges(this.inputSequence[u-1]);a.correctionQueue.enqueueAll(l.concat(c)),this.selectionQueue=new k(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering)}return n}getBestMatches(t){return Ct(this,null,function*(){let r={},n=Object.values(this.returnedValues);if(n.length>0){let i=new k(Ee,n);for(;i.count>0;){let o=t.time(()=>{let a=i.dequeue();return a.isFullReplacement?null:(r[a.resultKey]=a,new me(a))},0);if(o){let a=t.start(1);yield o,a.end(),t.timeSinceLastDefer>we&&(yield new ye(t.defer()))}}}do{let i=t.time(()=>{var a,u;let o=this.handleNextNode();if(o.type=="none")return null;if(o.type=="complete"){if(o.finalNode.isFullReplacement)return null;let c=o.finalNode;if(((u=(a=r[c.resultKey])==null?void 0:a.currentCost)!=null?u:Number.MAX_VALUE)>c.currentCost)return r[c.resultKey]=c,this.returnedValues[c.resultKey]=c,new me(c)}return null},2);if(i){let o=t.start(1);yield i,o.end()}t.timeSinceLastDefer>we&&(yield new ye(t.defer()))}while(!t.elapsed&&this.hasNextMatchEntry());return null})}};d(B,"SearchSpace"),B.EDIT_DISTANCE_COST_SCALE=5,B.MIN_KEYSTROKE_PROBABILITY=1e-4,B.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL=33;var v=B;var at=class at{static isWhitespace(t){let r=/^[\\u0009\\u000A\\u000D\\u0020\\u00a0\\u1680\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u200b\\u2028\\u2029\\u202f\\u205f\\u3000]+$/i;return t.insert.match(r)!=null}static isBackspace(t){return t.insert==""&&t.deleteLeft>0&&!t.deleteRight}static isEmpty(t){return t.insert==""&&t.deleteLeft==0&&!t.deleteRight}};d(at,"TransformUtils");var M=at;var Jt={quotesForKeepSuggestion:{open:"“",close:"”"},insertAfterWord:" "};function fe(s){let t=Jt;if(!s.punctuation)return t;let r=s.punctuation,n=r.insertAfterWord;n!==""&&!n&&(n=t.insertAfterWord);let i=r.quotesForKeepSuggestion;i||(i=t.quotesForKeepSuggestion);let o=r.isRTL;return{insertAfterWord:n,quotesForKeepSuggestion:i,isRTL:o}}d(fe,"determinePunctuationFromModel");function K(s){return t=>{if(s.wordbreaker||!s.wordbreak){let r=s.wordbreaker||D;return Y(r,t)}else return s.wordbreak(t)}}d(K,"determineModelWordbreaker");function J(s){return t=>s.wordbreaker?ae(s.wordbreaker,t):null}d(J,"determineModelTokenizer");function At(s,t){var o;let r=s,i=K(s)(t);if(!r.languageUsesCasing)throw"Invalid attempt to detect casing: languageUsesCasing is set to false";if(!r.applyCasing)throw"Invalid LMLayer state:  languageUsesCasing is set to true, but no applyCasing function exists";return t.casingForm=="upper"||t.casingForm=="initial"?t.casingForm:r.applyCasing("lower",i)==i?"lower":r.applyCasing("upper",i)==i?i.kmwLength()>1?"upper":"initial":r.applyCasing("initial",i)==i?"initial":(o=t.casingForm)!=null?o:null}d(At,"detectCurrentCasing");function lt(s,t,r){let n=x(r,t),i=s(n).left,o=r.insert,a=[];for(let u=i.length-1;u>=0;u--){let l=i[u],c=l.text.length;if(c<o.length)a.unshift({insert:l.text,deleteLeft:0}),o=o.substring(0,o.length-c);else{a.unshift({insert:o,deleteLeft:r.deleteLeft});break}}return a}d(lt,"tokenizeTransform");function Nt(s,t,r){return r.map(n=>({sample:lt(s,t,n.sample),p:n.p}))}d(Nt,"tokenizeTransformDistribution");function Ot(s,t){let r=[];for(let n=0;n<s.kmwLength();n++){let o={insert:s.kmwCharAt(n),deleteLeft:0,id:t};r.push(o)}return r}d(Ot,"textToCharTransforms");var pt=class pt{};d(pt,"TrackedContextSuggestion");var ut=pt,dt=class dt{constructor(){this.transformDistributions=[];this.activeReplacementId=-1}get currentText(){return this.replacementText===void 0||this.replacementText===null?this.raw:this.replacementText}get replacement(){let t=this.activeReplacementId;return this.replacements.find(function(r){return r.suggestion.id==t})}revert(){delete this.activeReplacementId}updateWithBackspace(t,r){let n=Ot(t,r).map(function(i){return[{sample:i,p:1}]});this.raw=t,this.transformDistributions=n}update(t,r){r=r||(r===""?"":this.raw),(t==null?void 0:t.length)>0&&this.transformDistributions.push(t),this.raw=r}};d(dt,"TrackedContextToken");var G=dt,Ie=class Ie{constructor(t){this.searchSpace=[];if(t instanceof Ie){let r=t;this.tokens=r.tokens.map(function(i){let o=new G;return o.raw=i.raw,o.replacements=[].concat(i.replacements),o.activeReplacementId=i.activeReplacementId,o.transformDistributions=[].concat(i.transformDistributions),i.replacementText&&(o.replacementText=i.replacementText),o}),this.indexOffset=0;let n=this.model=t.model;this.taggedContext=t.taggedContext,n!=null&&n.traverseFromRoot&&(this.searchSpace=t.searchSpace.map(i=>new v(i)))}else{let r=t;this.tokens=[],this.indexOffset=Number.MIN_SAFE_INTEGER,this.model=r,r&&r.traverseFromRoot&&(this.searchSpace=[new v(r)])}}get head(){return this.tokens[0]}get tail(){return this.tokens[this.tokens.length-1]}popHead(){this.tokens.splice(0,1),this.indexOffset-=1}pushTail(t){this.model&&this.model.traverseFromRoot?this.searchSpace=[new v(this.model)]:this.searchSpace=[],this.tokens.push(t);let r=this;r.searchSpace.length>0&&t.transformDistributions.forEach(n=>r.searchSpace[0].addInput(n))}toRawTokenization(){let t=[];for(let r of this.tokens)r.currentText!==null&&t.push(r.currentText);return t}};d(Ie,"TrackedContextState");var z=Ie,ge=class ge{constructor(t=ge.DEFAULT_ARRAY_SIZE){this.currentHead=0;this.currentTail=0;this.circle=Array(t)}get count(){let t=this.currentHead-this.currentTail;return t<0&&(t=t+this.circle.length),t}get maxCount(){return this.circle.length}get oldest(){if(this.count!=0)return this.item(0)}get newest(){if(this.count!=0)return this.item(this.count-1)}enqueue(t){var r=null;let n=(this.currentHead+1)%this.maxCount;return n==this.currentTail&&(r=this.circle[this.currentTail],this.currentTail=(this.currentTail+1)%this.maxCount),this.circle[this.currentHead]=t,this.currentHead=n,r}dequeue(){if(this.currentTail==this.currentHead)return null;{let t=this.circle[this.currentTail];return this.currentTail=(this.currentTail+1)%this.maxCount,t}}popNewest(){if(this.currentTail==this.currentHead)return null;{let t=this.circle[this.currentHead];return this.currentHead=(this.currentHead-1+this.maxCount)%this.maxCount,t}}item(t){if(t>=this.count)return;let r=(this.currentTail+t)%this.maxCount;return this.circle[r]}};d(ge,"CircularArray"),ge.DEFAULT_ARRAY_SIZE=5;var ct=ge,xe=class xe extends ct{static attemptMatchContext(t,r,n){var C,b;let i=r.toRawTokenization(),a=Q.computeDistance(i.map(f=>({key:f})),t.map(f=>({key:f.text})),3).editPath();a.length==2&&a[0]=="insert"&&a[1]=="substitute"&&(a[0]="substitute",a[1]="insert");let u=a.indexOf("match"),l=a.lastIndexOf("match");if(a.length>=2&&a[a.length-2]=="substitute"&&a[a.length-1]=="match"&&(l=a.lastIndexOf("match",a.length-2)),u){for(let f=u+1;f<l;f++)if(a[f]!="match")return null}if(u==0&&l==a.length-1)return{state:r,baseState:r};let c=r,p,h=0;for(let f=0;f<u;f++)switch(a[f]){case"delete":if(p&&p!="delete")return null;c==r&&(c=new z(c)),c.popHead(),h++;break;case"substitute":break;default:return null}let g=n&&Array.isArray(n);p=void 0;let m;for(let f=l+1;f<a.length;f++){let y=f==a.length-1;if(!g)return null;let L=f-(l+1),E=n.map(j=>({sample:j.sample[L],p:j.p})),w=g?(C=E[0])==null?void 0:C.sample:null;w&&w.insert==""&&w.deleteLeft==0&&!w.deleteRight&&(w=null),y||(m=m?F(m,w):w);let Bt=w&&M.isBackspace(w),re=t[f-h];switch(a[f]){case"substitute":y&&(c=new z(c));let j=c.tokens[f-h],S=r.tokens[f];Bt?(j.updateWithBackspace(re.text,w.id),y&&(c.tokens.pop(),c.pushTail(j))):(j.update(E,re.text),y&&((b=c.searchSpace[0])==null||b.addInput(E))),c!=r&&!y&&(S.replacementText=re.text);break;case"insert":if(p&&p!="substitute"&&p!="match"&&p!="insert")return null;m||(m={insert:"",deleteLeft:0}),c==r&&(c=new z(c));let P=new G;P.raw=re.text,w&&(P.transformDistributions=E?[E]:[]),P.isWhitespace=re.isWhitespace,c.pushTail(P);break;case"match":if(p=="substitute"&&t[t.length-1].text=="")continue;default:return null}p=a[f]}return{state:c,baseState:r,preservationTransform:m}}static modelContextState(t,r){let n=t.map(function(o){let a=new G;return a.raw=o.text,o.isWhitespace&&(a.isWhitespace=!0),a.raw?a.transformDistributions=Ot(a.raw).map(function(u){return[{sample:u,p:1}]}):a.transformDistributions=[],a}),i=new z(r);for(;n.length>0;)n.length==1&&n[0].updateWithBackspace(n[0].raw,null),i.pushTail(n.splice(0,1)[0]);if(i.tokens.length==0){let o=new G;o.raw="",i.pushTail(o)}return i}analyzeState(t,r,n){if(!t.traverseFromRoot)throw"This lexical model does not provide adequate data for correction algorithms and context reuse";let i=J(t),o=n==null?void 0:n[0],a=0,u=null;o&&(a=lt(i,r,o.sample).length,u=Nt(i,r,n),r=x(o.sample,r),u=u.filter(p=>p.sample.length==a));let l=i(r);if(l.left.length>0)for(let p=this.count-1;p>=0;p--){let h=this.item(p),g=h.taggedContext;if(g&&n&&n.length>0){if(x(n[0].sample,g).left!=r.left)continue}else if((g==null?void 0:g.left)!=r.left)continue;let m=xe.attemptMatchContext(l.left,this.item(p),u);if(m!=null&&m.state)return this.newest!=m.state&&this.newest!=h&&this.enqueue(h),m.state.taggedContext=r,m.state!=this.item(p)&&this.enqueue(m.state),m}let c=xe.modelContextState(l.left,t);return c.taggedContext=r,this.enqueue(c),{state:c,baseState:null}}clearCache(){for(;this.count>0;)this.dequeue()}};d(xe,"ContextTracker");var Te=xe;var Zt=.66,Rt={MAX_SEARCH_THRESHOLD:8,REPLACEMENT_SEARCH_THRESHOLD:4};function ht(s,t){let r=t.matchLevel-s.matchLevel;return r!=0?r:t.totalProb-s.totalProb}d(ht,"tupleDisplayOrderSort");function _t(s,t,r,n,i){return U(this,null,function*(){let o=K(t),a=n[0].sample,u=x(a,i),l=[];if(!s){let S,P=M.isWhitespace(a),Oe=M.isBackspace(a);return P?S=[{sample:a,p:1}]:S=n.map(I=>{let Se=I.sample;return M.isWhitespace(Se)&&!P||M.isBackspace(Se)&&!Oe?null:I}),S=S.filter(I=>!!I),l=Dt(t,S,i),P&&l.forEach(I=>I.preservationTransform=a),{postContextState:null,rawPredictions:l}}let{state:c}=s.analyzeState(t,i,null),p=s.analyzeState(t,i,M.isEmpty(a)?null:n),h=p.state,g=h.searchSpace[0],m=0,C=h.tokens,b=C.length-c.tokens.length;p.preservationTransform?(m=0,i=x(p.preservationTransform,i)):b<0?m=o(u).kmwLength()+a.deleteLeft:m=o(i).kmwLength();let f=C[C.length-1];f.raw==""&&(m=0);let y=f.transformDistributions.length<=1,L,E={};try{for(var w=St(g.getBestMatches(r)),Bt,re,j;Bt=!(re=yield w.next()).done;Bt=!1){let S=re.value;let P=S.matchString;if(S.matchSequence.length==0&&S.inputSequence.length!=0||S.matchSequence.length!=0&&S.matchSequence.length==S.knownCost)continue;let Oe={insert:P,deleteLeft:m,id:a.id},I=S.totalCost;y&&(I*=Z.SINGLE_CHAR_KEY_PROB_EXPONENT);let Se={sample:Oe,p:Math.exp(-I)},be=Dt(t,[Se],i);be.forEach(ne=>ne.preservationTransform=p.preservationTransform),be.length>0&&L===void 0&&(L=I);let ft=E[S.matchString];if(ft&&(l=l.filter(ne=>!ft.find(Kt=>ne.prediction.sample==Kt.sample))),E[S.matchString]=be.map(ne=>ne.prediction),l=l.concat(be),er(L,S.totalCost,l))break}}catch(re){j=[re]}finally{try{Bt&&(re=w.return)&&(yield re.call(w))}finally{if(j)throw j[0]}}return{postContextState:h,rawPredictions:l}})}d(_t,"correctAndEnumerate");function er(s,t,r){if(t>=s+Rt.MAX_SEARCH_THRESHOLD)return!0;if(r.length>=Z.MAX_SUGGESTIONS){if(t>=s+Rt.REPLACEMENT_SEARCH_THRESHOLD)return!0;if(r.sort(ht),r[Z.MAX_SUGGESTIONS-1].totalProb>Math.exp(-t))return!0}return!1}d(er,"shouldStopSearchingEarly");function Dt(s,t,r){let n=[],i=K(s);for(let o of t){let a=s.predict(o.sample,r),{sample:u,p:l}=o,c=i(x(o.sample,r)),p=a.map(h=>(u.id!==void 0&&(h.sample.transformId=u.id),{prediction:h,correction:{sample:c,p:l},totalProb:h.p*l,matchLevel:0}));n=n.concat(p)}return n}d(Dt,"predictFromCorrections");function Ut(s,t,r){let n=K(s),i={},o=[];for(let a of t){let u=n(x(a.prediction.sample.transform,r)),l=i[u];l?l.totalProb+=a.totalProb:i[u]=a}for(let a in i){let u=i[a];o.push(u)}return o}d(Ut,"dedupeSuggestions");function Ft(s,t,r,n){let{sample:i,p:o}=n,a=K(s),u=x(i,r),l=a(u),c=d(f=>s.toKey?s.toKey(f):f,"keyed"),p=d(f=>s.applyCasing?s.applyCasing("lower",f):f,"keyCased"),h=c(l),g=p(l),m;for(let f of t){i.id!==void 0&&(f.prediction.sample.transformId=i.id);let y=a(x(f.prediction.sample.transform,r));c(f.correction.sample)==h?y==l?(f.matchLevel=3,m=Ae(s,f.prediction.sample,"keep",X.noQuotes),m.matchesModel=!0,Object.assign(f.prediction.sample,m),m=f.prediction.sample):p(y)==g?f.matchLevel=2:c(y)==h?f.matchLevel=1:f.matchLevel=0:f.matchLevel=0}if(m||l=="")return;let C=O({},i),b=q(C,1);b.displayAs=l,m=Ae(s,b,"keep"),i.id!==void 0&&(m.transformId=i.id),m.matchesModel=!1,t.unshift({totalProb:m.p,prediction:{sample:m,p:m.p},correction:{sample:l,p:o},matchLevel:3})}d(Ft,"processSimilarity");function Wt(s){if(s.length==0)return;let t=s[0].prediction.sample;if(t.tag=="keep"&&t.matchesModel){t.autoAccept=!0;return}else if(s.length==1)return;if(s=s.slice(1),s.length==1){s[0].prediction.sample.autoAccept=!0;return}let r=s[0];if(r.correction.sample.length==0||s.reduce((l,c)=>(l==null?void 0:l.correction.p)>c.correction.p?l:c,null).correction.p>r.correction.p)return;let o=r.matchLevel,a=s.reduce((l,c)=>l+(c.matchLevel==o?c.totalProb:0),0);r.totalProb/a<Zt||(r.prediction.sample.autoAccept=!0)}d(Wt,"predictionAutoSelect");function qt(s,t,r,n,i){let o=fe(s),a=J(s),u=t.map(l=>{let c=l.prediction;if(l.preservationTransform){let p=F(l.preservationTransform,c.sample.transform);p.id=c.sample.transformId;let h=c.sample;h.transform=p}return i?De(O({},c.sample),{p:l.totalProb,"lexical-p":c.p,"correction-p":l.correction.p}):De(O({},c.sample),{p:l.totalProb})});return u.forEach(l=>{let c=a(r);c&&c.caretSplitsToken?l.transform.insert+=o.insertAfterWord:r.right?o.insertAfterWord!=""&&r.right.indexOf(o.insertAfterWord)!=0&&(l.transform.insert+=o.insertAfterWord):l.transform.insert+=o.insertAfterWord}),u}d(qt,"finalizeSuggestions");function Ae(s,t,r,n=X.default){let i=X,o=fe(s),a=i.noQuotes;(r=="keep"||r=="revert")&&(a=i.useQuotes);let u={transform:t.transform,displayAs:i.apply(n,t.displayAs,o,a),tag:r,p:t.p};return t.transformId!==void 0&&(u.transformId=t.transformId),u}d(Ae,"toAnnotatedSuggestion");var ee=class ee{constructor(t,r){this.SUGGESTION_ID_SEED=0;this.testMode=!1;this.verbose=!0;this.lexicalModel=t,t.traverseFromRoot&&(this.contextTracker=new Te),this.punctuation=fe(t),this.testMode=!!r}predict(t,r){return U(this,null,function*(){var y;let n=this.lexicalModel;(y=this.activeTimer)==null||y.terminate(),t instanceof Array?t.length==0&&t.push({sample:{insert:"",deleteLeft:0},p:1}):t=[{sample:t,p:1}],t.sort(function(L,E){return E.p-L.p});let i=t[0].sample,o=M.isBackspace(i),a=M.isWhitespace(i),u=x(i,r),l=this.wordbreak(u),c=o||a?l:this.wordbreak(r),p=n.languageUsesCasing?At(n,u):null,h=v.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL,g=this.activeTimer=new de(this.testMode?Number.MAX_VALUE:h,this.testMode?Number.MAX_VALUE:h*1.5),{postContextState:m,rawPredictions:C}=yield _t(this.contextTracker,this.lexicalModel,g,t,r);this.activeTimer==g&&(this.activeTimer=null);for(let L of C)p&&p!="lower"&&this.applySuggestionCasing(L.prediction.sample,c,p);let b=Ut(this.lexicalModel,C,r);Ft(this.lexicalModel,b,r,t[0]),b.sort(ht),Wt(b);let f=qt(this.lexicalModel,b.splice(0,ee.MAX_SUGGESTIONS),r,i,this.verbose);return f.forEach(L=>{L.id=this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++}),m&&(m.tail.replacements=f.map(function(L){return{suggestion:L,tokenWidth:1}})),f})}applySuggestionCasing(t,r,n){let i=r.kmwLength()-t.transform.deleteLeft;i>0&&(t.transform.deleteLeft+=i,t.transform.insert=r.kmwSubstr(0,i)+t.transform.insert),t.transform.insert=this.lexicalModel.applyCasing(n,t.transform.insert),t.displayAs=this.lexicalModel.applyCasing(n,t.displayAs)}acceptSuggestion(t,r,n){let i=t.transform,o=r.left.kmwSubstr(-i.deleteLeft,i.deleteLeft),a=i.insert.kmwLength(),u={insert:o,deleteLeft:a},l=r;n&&(u=F(u,n),l=x(n,l));let c,p=this.tokenize(l);if(p){let m=p.left[p.left.length-1];c=m&&!m.isWhitespace?m.text:"",c+=p.caretSplitsToken?p.right[0].text:""}else c=this.wordbreak(l);let h=q(u);h.displayAs=c;let g=Ae(this.lexicalModel,h,"revert");if(t.transformId!=null&&(g.transformId=-t.transformId),t.id!=null?g.id=-t.id:(g.id=-this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++),this.contextTracker){let m=this.contextTracker.newest;m||(m=this.contextTracker.analyzeState(this.lexicalModel,r).state),m.tail.activeReplacementId=t.id;let C=x(t.transform,r);this.contextTracker.analyzeState(this.lexicalModel,C)}return g}applyReversion(t,r){return U(this,null,function*(){let n=this,i=d(function(){return U(this,null,function*(){let u=x(t.transform,r),l=yield n.predict({insert:"",deleteLeft:0},u);return l.forEach(function(c){c.transformId=-t.transformId,c.autoAccept=!1}),l})},"fallbackSuggestions");if(!this.contextTracker)return i();let o=!1;for(let u=this.contextTracker.count-1;u>=0;u--)if(this.contextTracker.item(u).tail.activeReplacementId==-t.id){o=!0;break}if(!o)return i();for(;this.contextTracker.newest.tail.activeReplacementId!=-t.id;)this.contextTracker.popNewest();this.contextTracker.newest.tail.revert();let a=this.contextTracker.newest.tail.replacements.map(function(u){return u.suggestion});return a.forEach(function(u){u.transformId=-t.transformId,u.autoAccept=!1}),a})}wordbreak(t){return K(this.lexicalModel)(t)}tokenize(t){return J(this.lexicalModel)(t)}resetContext(t){var r;(r=this.activeTimer)==null||r.terminate(),this.contextTracker&&(this.contextTracker.clearCache(),this.contextTracker.analyzeState(this.lexicalModel,t,null))}};d(ee,"ModelCompositor"),ee.MAX_SUGGESTIONS=12,ee.SINGLE_CHAR_KEY_PROB_EXPONENT=16;var mt=ee,Z=mt;R();var Ne=class Ne{constructor(t={importScripts:null,postMessage:null}){this._testMode=!1;this._postMessage=t.postMessage||postMessage,this._importScripts=t.importScripts||importScripts,this.setupConfigState()}error(t,r){this.cast("error",{log:t,error:r&&r.stack?r.stack:void 0})}onMessage(t){let{message:r}=t.data;if(!r)throw new Error(\`Missing required 'message' property: \${t.data}\`);let n=t.data;if(n.message=="load"){let i=n,o=!1;if(this._currentModelSource&&i.source.type==this._currentModelSource.type&&(i.source.type=="file"&&i.source.file==this._currentModelSource.file||i.source.type=="raw"&&i.source.code==this._currentModelSource.code)&&(o=!0),o){typeof console!="undefined"&&console.warn("Duplicate model load message detected - squashing!");return}else this._currentModelSource=i.source}else n.message=="unload"&&(this._currentModelSource=null);this.state.handleMessage(n)}cast(t,r){let n=this._postMessage;n(O({message:t},r))}loadModel(t){try{let r=t.configure(this._platformCapabilities);r.leftContextCodePoints||(r.leftContextCodePoints=r.leftContextCodeUnits),r.rightContextCodePoints||(r.rightContextCodePoints=r.rightContextCodeUnits),r.leftContextCodePoints||(r.leftContextCodePoints=this._platformCapabilities.maxLeftContextCodePoints),r.rightContextCodePoints||(r.rightContextCodePoints=this._platformCapabilities.maxRightContextCodePoints||0),t.languageUsesCasing&&!t.applyCasing&&(t.applyCasing=Me);let n=this.transitionToReadyState(t);r.wordbreaksAfterSuggestions===void 0&&(r.wordbreaksAfterSuggestions=n.punctuation.insertAfterWord!=""),this.cast("ready",{configuration:r})}catch(r){this.error("loadModel failed!",r)}}loadModelFile(t){try{this._importScripts(t)}catch(r){this.error("Error occurred when attempting to load dictionary",r)}}unloadModel(){this.transitionToLoadingState()}setupConfigState(){this.state={name:"unconfigured",handleMessage:t=>{if(t.message!=="config")throw new Error(\`invalid message; expected 'config' but got \${t.message}\`);this._platformCapabilities=t.capabilities,this._testMode=!!t.testMode,this.transitionToLoadingState()}}}transitionToLoadingState(){let t=this;this.state={name:"modelless",handleMessage:r=>{if(r.message!=="load")throw new Error(\`invalid message; expected 'load' but got \${r.message}\`);if(r.source.type=="file")t.loadModelFile(r.source.file);else{let n=r.source.code;new Function("LMLayerWorker","models","correction","wordBreakers",n)(t,ve,Ce,ue)}}}}transitionToReadyState(t){let r=new Z(t,this._testMode);return this.state={name:"ready",handleMessage:n=>{switch(n.message){case"predict":var{transform:i,context:l}=n;r.predict(i,l).then(p=>{this.cast("suggestions",{token:n.token,suggestions:p})});break;case"wordbreak":let c=Y(t.wordbreaker||D,n.context);this.cast("currentword",{token:n.token,word:c});break;case"unload":this.unloadModel();break;case"accept":var{suggestion:o,context:l,postTransform:a}=n,u=r.acceptSuggestion(o,l,a);this.cast("postaccept",{token:n.token,reversion:u});break;case"revert":var{reversion:u,context:l}=n;r.applyReversion(u,l).then(p=>{this.cast("postrevert",{token:n.token,suggestions:p})});break;case"reset-context":var{context:l}=n;r.resetContext(l);break;default:throw new Error(\`invalid message; expected one of {'predict', 'wordbreak', 'accept', 'revert', 'reset-context', 'unload'} but got \${n.message}\`)}},compositor:r},r}static install(t){let r=new Ne({postMessage:t.postMessage,importScripts:t.importScripts.bind(t)});return t.onmessage=r.onMessage.bind(r),r.self=t,t.LMLayerWorker=r,t.models=ve,t.correction=Ce,t.wordBreakers=ue,r}};d(Ne,"LMLayerWorker");var te=Ne;typeof self!="undefined"&&"postMessage"in self&&"importScripts"in self?te.install(self):window.LMLayerWorker=te;})();
//# sourceMappingURL=worker-main.min.js.map
`,Xo="";var rc=class rc{static constructInstance(){return new Worker(this.asBlobURI(Zo))}static asBlobURI(i){let t=sl(i);t+=`
`+Xo;let n=new Blob([t],{type:"text/javascript"});return URL.createObjectURL(n)}};a(rc,"DefaultWorker");var ni=rc;var oc=class oc extends S.default{constructor(t,n,l=!1){super();this._mayPredict=!0;this._mayCorrect=!0;this._state="inactive";this.recentTranscriptions=n;let s={maxLeftContextCodePoints:64,maxRightContextCodePoints:l?0:64};t&&(this.lmEngine=new ii(s,t))}get activeModel(){return this.currentModel}get isConfigured(){return!!this.configuration}get state(){return this._state}unloadModel(){this.lmEngine.unloadModel(),delete this.currentModel,delete this.configuration,this._state="inactive",this.emit("statechange","inactive")}loadModel(t){if(!t)throw new Error("Null reference not allowed.");let n=t.path?"file":"raw",l=n=="file"?t.path:t.code;return this.currentModel=t,this.mayPredict&&(this._state="active",this.emit("statechange","active")),this.lmEngine.loadModel(l,n).then(s=>{this.configuration=s,this.mayPredict&&(this._state="configured",this.emit("statechange","configured"))}).catch(s=>{let c;s instanceof Error?c=s.message:c=String(s),console.error("Could not load model '"+t.id+"': "+c),this.currentModel=null,this._state="inactive",this.emit("statechange","inactive")})}invalidateContext(t,n){if(this.emit("invalidatesuggestions","context"),!this.currentModel||!this.configuration)return Promise.resolve([]);if(this.isActive)if(t){let l=t.buildTranscriptionFrom(t,null,!1);return this.predict_internal(l,!0,n)}else return Promise.resolve([]);else return Promise.resolve([])}wordbreak(t,n){if(!this.isActive)return null;let l=new xe(N.from(t,!1),this.configuration,n);return this.lmEngine.wordbreak(l)}predict(t,n){return!this.isActive||!this.currentModel||!this.configuration?null:(this.emit("invalidatesuggestions","new"),this.predict_internal(t,!1,n))}applySuggestion(t,n,l){if(!n)throw"Accepting suggestions requires a destination OutputTarget instance.";if(!this.isConfigured)return console.warn("Could not apply suggestion; the corresponding model has been unloaded"),null;let s=this.getPredictionState(t.transformId);if(s){let c=N.from(s.preInput,!1);c.apply(t.transform);let r=c.buildTransformFrom(n);n.apply(r),this.emit("suggestionapplied",n),N.from(s.preInput,!1).apply(s.transform);let d=new xe(s.preInput,this.configuration,l()),u=this.lmEngine.acceptSuggestion(t,d,s.transform);return u=u.then(B=>{let b={transform:s.transform,transformId:-s.token,displayAs:B.displayAs,id:B.id,tag:B.tag};return this.predictFromTarget(n,l()),b}),u}else return console.warn("Could not apply the Suggestion!"),null}applyReversion(t,n){if(!n)throw"Accepting suggestions requires a destination OutputTarget instance.";let l=this.getPredictionState(-t.transformId);if(!l)return console.warn("Could not apply the Suggestion!"),Promise.resolve([]);let s=N.from(l.preInput,!1);s.apply(t.transform);let c=s.buildTransformFrom(n);n.apply(c);let r=this.currentPromise=this.lmEngine.revertSuggestion(t,new xe(l.preInput,this.configuration,null));return r.then(()=>this.currentPromise=this.currentPromise==r?null:this.currentPromise),r}predictFromTarget(t,n){if(!t)return null;let l=t.buildTranscriptionFrom(t,null,!1);return this.predict(l,n)}predict_internal(t,n,l){if(!t)return null;let s=new xe(t.preInput,this.configuration,l);this.recordTranscription(t),n&&this.lmEngine.resetContext(s);let c=t.alternates;(!c||c.length==0)&&(c=[{sample:t.transform,p:1}]);let r=t.transform;var o=this.currentPromise=this.lmEngine.predict(c,s);return o.then(d=>{if(o==this.currentPromise){let u=new Ct(d,r.id);this.emit("suggestionsready",u),this.currentPromise=null}return d})}recordTranscription(t){this.recentTranscriptions.save(t)}getPredictionState(t){return this.recentTranscriptions.get(t)}shutdown(){this.lmEngine.shutdown(),this.removeAllListeners()}get isActive(){return this.canEnable()?(this.activeModel||!1)&&this._mayPredict:(this._mayPredict=!1,!1)}canEnable(){return!!this.lmEngine}get mayPredict(){return this._mayPredict}set mayPredict(t){if(!this.canEnable())return;let n=this._mayPredict;if(this._mayPredict=t,n!=t&&this.activeModel){let l=t?"active":"inactive";this._state=l,this.emit("statechange",l),t&&this.isConfigured&&(this._state="configured",this.emit("statechange","configured"))}}get mayCorrect(){return this._mayCorrect}set mayCorrect(t){this._mayCorrect=t}get wordbreaksAfterSuggestions(){return this.configuration.wordbreaksAfterSuggestions}tryAcceptSuggestion(t){var l;let n={shouldSwallow:!1};return this.emit("tryaccept",t,n),(l=n.shouldSwallow)!=null?l:!1}tryRevertSuggestion(){return this.emit("tryrevert"),!1}};a(oc,"LanguageProcessor");var Di=oc;var Sa=10,ac=class ac{constructor(){this.map=new Map}get(i){let t=this.map.get(i);return t&&this.save(t),t}save(i){let t=i.token>=0?i.token:-i.token;this.map.delete(t),this.map.set(t,i),this.map.size>Sa&&this.map.delete(this.map.keys().next().value)}};a(ac,"TranscriptionCache");var Oi=ac;var Pi=class Pi{constructor(i,t,n){this.contextCache=new Oi;if(!i)throw new Error("device must be defined");n||(n=Pi.DEFAULT_OPTIONS),this.contextDevice=i,this.kbdProcessor=new _t(i,n),this.lngProcessor=new Di(t,this.contextCache)}get languageProcessor(){return this.lngProcessor}get keyboardProcessor(){return this.kbdProcessor}get keyboardInterface(){return this.keyboardProcessor.keyboardInterface}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(i){this.keyboardInterface.activeKeyboard=i,this.resetContext()}get activeModel(){return this.languageProcessor.activeModel}processKeyEvent(i,t){let n=i.srcKeyboard&&this.activeKeyboard!=i.srcKeyboard,l=this.activeKeyboard;try{if(n&&(this.keyboardInterface.activeKeyboard=i.srcKeyboard),i.baseTranscriptionToken){let s=this.contextCache.get(i.baseTranscriptionToken);s?(!Zt(s.transform)||!s.preInput.isEqual(N.from(t)))&&t.restoreTo(s.preInput):console.warn("The base context for the multitap could not be found")}return this._processKeyEvent(i,t)}finally{n&&(this.keyboardInterface.activeKeyboard=l)}}_processKeyEvent(i,t){var b;let n=i.device.formFactor,l=i.isSynthetic;if((n==W.FormFactor.Desktop||!this.activeKeyboard||this.activeKeyboard.usesDesktopLayoutOnDevice(i.device))&&l&&this.keyboardProcessor.selectLayer(i))return new le;if(this.keyboardProcessor.doModifierPress(i,t,!l)&&!l)return new le;if(this.languageProcessor.isActive){if((i.kName=="K_BKSP"||i.Lcode==C.keyCodes.K_BKSP)&&this.languageProcessor.tryRevertSuggestion())return new le;if((i.kName=="K_SPACE"||i.Lcode==C.keyCodes.K_SPACE)&&this.languageProcessor.tryAcceptSuggestion("space"))return new le}let s=N.from(t,!0),c=this.keyboardProcessor.layerId,r=this.keyboardProcessor.processKeystroke(i,t);i.kNextLayer&&this.keyboardProcessor.selectLayer(i);let o=C.isFrameKey(i.kName);Zt((b=r==null?void 0:r.transcription)==null?void 0:b.transform)&&i.kNextLayer&&(o=!0);let d=r!=null;if(d){let I=o?null:this.buildAlternates(r,i,s);r.finalize(this.keyboardProcessor,t,!1),I&&I.length>0&&(r.transcription.alternates=I)}else r=new le,r.transcription=t.buildTranscriptionFrom(t,null,!1),r.triggersDefaultCommand=!0;this.contextCache.save(r.transcription);let u=r.setStore[33]||i.kNextLayer;this.keyboardProcessor.newLayerStore.set(u?this.keyboardProcessor.layerId:""),this.keyboardProcessor.oldLayerStore.set(u?c:"");let B=this.keyboardProcessor.processPostKeystroke(this.contextDevice,t);return B&&B.finalize(this.keyboardProcessor,t,!0),r.predictionPromise=this.languageProcessor.predict(r.transcription,this.keyboardProcessor.layerId),r.triggersDefaultCommand||t.doInputEvent(),d?r:null}buildAlternates(i,t,n){let l;if(this.languageProcessor.isActive&&!i.triggersDefaultCommand){let s=t.keyDistribution,r=new xe(n,xe.ENGINE_RULE_WINDOW,this.keyboardProcessor.layerId).toMock();if(this.languageProcessor.isActive&&s&&t.kbdLayer){let o=Number.MAX_VALUE,d=Et(),u;d.performance&&d.performance.now&&(u=a(function(){return d.performance.now()},"timer"),o=u()+16);let B=Math.exp(-5);s.sort((I,F)=>F.p-I.p),l=[];let b=0;for(let I of s){if(I.p<B){b+=I.p;break}else if(u&&u()>=o)break;let F=N.from(r,!1),h=I.keySpec;if(!h){console.warn("Internal error:  failed to properly filter set of keys for corrections");continue}let y=this.keyboardProcessor.activeKeyboard.constructKeyEvent(h,t.device,this.keyboardProcessor.stateKeys),Q=this.keyboardProcessor.processKeystroke(y,F);if(Q&&!Q.beep&&I.p>0){let x=Q.transcription.transform;x.id=i.transcription.token,l.push({sample:x,p:I.p}),b+=I.p}}l.forEach(function(I){I.p/=b})}}return l}resetContext(i){this.keyboardProcessor.resetContext(i),this.languageProcessor.invalidateContext(i,this.keyboardProcessor.layerId)}};a(Pi,"InputProcessor"),Pi.DEFAULT_OPTIONS={baseLayout:"us"};var ji=Pi;var gc=class gc{constructor(i,t,n,l){this.Pelem=i,this.Peventname=t.toLowerCase(),this.Phandler=n,this.PuseCapture=l}equals(i){return this.Pelem==i.Pelem&&this.Peventname==i.Peventname&&this.Phandler==i.Phandler&&this.PuseCapture==i.PuseCapture}};a(gc,"DomEventTracking");var cl=gc,dc=class dc{constructor(){this.domEvents=[]}attachDOMEvent(i,t,n,l){this.detachDOMEvent(i,t,n,l),i.addEventListener(t,n,!!l);var s=new cl(i,t,n,l);this.domEvents.push(s)}detachDOMEvent(i,t,n,l){i.removeEventListener(t,n,l);for(var s=new cl(i,t,n,l),c=0;c<this.domEvents.length;c++)if(this.domEvents[c].equals(s)){this.domEvents.splice(c,1);break}}shutdown(){for(let i of this.domEvents)this.detachDOMEvent(i.Pelem,i.Peventname,i.Phandler,i.PuseCapture)}};a(dc,"DomEventTracker");var Ze=dc;var uc=class uc extends S.default{constructor(i){super(),i instanceof S.default?(i.on=this.listenerRegistrationSpy("listeneradded",i,i.on),i.addListener=this.listenerRegistrationSpy("listeneradded",i,i.addListener),i.off=this.listenerRegistrationSpy("listenerremoved",i,i.off),i.removeListener=this.listenerRegistrationSpy("listenerremoved",i,i.off)):(i.addEventListener=this.listenerRegistrationSpy("listeneradded",i,i.addEventListener),i.removeEventListener=this.listenerRegistrationSpy("listenerremoved",i,i.removeEventListener))}listenerRegistrationSpy(i,t,n){return(l,s)=>{let c=n.apply(t,[l,s]);return this.emit(i,l),c}}};a(uc,"EmitterListenerSpy");var li=uc;var Bc=class Bc{constructor(){this.events={};this.currentEvents=[]}addEventListener(i,t){return this._removeEventListener(i,t),this.events[i].push(t),!0}removeEventListener(i,t){return this._removeEventListener(i,t)}_removeEventListener(i,t){typeof this.events[i]=="undefined"&&(this.events[i]=[]);for(var n=0;n<this.events[i].length;n++)if(this.events[i][n]==t)return this.events[i].splice(n,1),!0;return!1}callEvent(i,t){if(typeof this.events[i]=="undefined")return!0;if(this.currentEvents.indexOf(i)!=-1)return!1;this.currentEvents.push(i);for(var n=0;n<this.events[i].length;n++){var l=this.events[i][n],s=!1;try{s=l(t)}catch(c){console.error(c),s=!1}if(s===!1)return this.currentEvents.pop(),!1}return this.currentEvents.pop(),!0}listenerCount(i){let t=this.events[i];return t?t.length:0}shutdown(){this.events={}}};a(Bc,"LegacyEventEmitter");var si=Bc;var Ic=class Ic{constructor(i=!1){this.fileLocal=i}request(i){let t=new v,n=window.setTimeout(()=>{t.reject(new Error(Co))},1e4),l="&timerid="+n,s=i+l,c=document.createElement("script");c.onload=r=>{window.clearTimeout(n),t.isResolved||t.reject(new Error(Qo))},c.onerror=(r,o,d,u,B)=>{window.clearTimeout(n);let b=Ds;B&&(b=b+": "+B.message),t.reject(new Error(b))},this.fileLocal?c.src=i:c.src=s;try{document.body.appendChild(c)}catch(r){document.getElementsByTagName("head")[0].appendChild(c)}return t.finally(()=>{clearTimeout(n)}),{promise:t,queryId:n}}};a(Ic,"DOMCloudRequester");var _i=Ic;function Wa(){return typeof window.KeymanWeb_BaseLayout!="undefined"?window.KeymanWeb_BaseLayout:"us"}a(Wa,"determineBaseLayout");var bc=class bc{constructor(i,t,n,l){this.legacyAPIEvents=new si;this.keyEventListener=a((i,t)=>{var s;let n=this.contextManager.activeTarget;if(!this.contextManager.activeKeyboard||!n){t&&t(null,null);return}if(this.core.languageProcessor.mayCorrect||(i.keyDistribution=[]),this.keyEventRefocus&&this.keyEventRefocus(),n.invalidateSelection(),n.deadkeys().deleteMatched(),i.isSynthetic){let c=this.osk.vkbd.layerId;c&&c!=this.core.keyboardProcessor.layerId&&(this.core.keyboardProcessor.layerId=c)}let l=this.core.processKeyEvent(i,n);l&&((s=l.transcription)!=null&&s.transform)&&this.config.onRuleFinalization(l,this.contextManager.activeTarget),t&&t(l,null)},"keyEventListener");this.config=t,this.contextManager=n;let s=l(this);s.baseLayout=Wa(),this.interface=s.keyboardInterface,this.core=new ji(t.hostDevice,i,s),this.core.languageProcessor.on("statechange",c=>{var r,o;(r=this.osk)==null||r.bannerController.selectBanner(c),(o=this.osk)==null||o.refreshLayout()}),this.core.keyboardProcessor.on("statekeychange",c=>{var r,o;(o=(r=this.osk)==null?void 0:r.vkbd)==null||o.updateStateKeys(c)}),this.contextManager.on("beforekeyboardchange",c=>{this.legacyAPIEvents.callEvent("beforekeyboardchange",{internalName:c==null?void 0:c.id,languageCode:c==null?void 0:c.langId})}),this.contextManager.on("keyboardchange",c=>{c||this.osk.startHide(!1);let r=a(()=>{var o,d;this.refreshModel(),this.core.activeKeyboard=c==null?void 0:c.keyboard,this.legacyAPIEvents.callEvent("keyboardchange",{internalName:(o=c==null?void 0:c.metadata.id)!=null?o:"",languageCode:(d=c==null?void 0:c.metadata.langId)!=null?d:""})},"prepareKeyboardSwap");this.osk?this.osk.batchLayoutAfter(()=>{r(),this.osk.activeKeyboard=c,this.contextManager.resetContext(),this.osk.present()}):(r(),this.contextManager.resetContext())}),this.contextManager.on("keyboardasyncload",c=>{var r,o;this.config.hostDevice.touchable&&((r=this.osk)!=null&&r.activationModel)&&(this.osk.activationModel.enabled=!0),(o=this.osk)==null||o.startHide(!1)})}init(i){return R(this,null,function*(){let t=this.config;if(t.deferForInitialization.isResolved)return Promise.resolve();t.initialize(i),String.kmwEnableSupplementaryPlane(!0);let n=new nl(this.interface,t.applyCacheBusting);this.keyboardRequisitioner=new ei(n,new _i,this.config.paths),this.modelCache=new ti;let l=this.keyboardRequisitioner.cache,s=this.core.keyboardProcessor,c=new Qt(this.core.languageProcessor,()=>s.layerId);this.contextManager.configure({resetContext:r=>{this.osk?this.osk.batchLayoutAfter(()=>{this.core.resetContext(r)}):this.core.resetContext(r)},predictionContext:c,keyboardCache:this.keyboardRequisitioner.cache}),this.core.languageProcessor.on("suggestionapplied",()=>{var r;s.newLayerStore.set(""),s.oldLayerStore.set(""),(r=s.processPostKeystroke(s.contextDevice,c.currentTarget))==null||r.finalize(s,c.currentTarget,!0)}),this.config.on("spacebartext",()=>{var r;(r=this.osk)==null||r.refreshLayout()}),l.on("stubadded",r=>{let o=a(()=>{this.legacyAPIEvents.callEvent("keyboardregistered",{internalName:r.KI,language:r.KL,keyboardName:r.KN,languageCode:r.KLC,package:r.KP}),this.config.activateFirstKeyboard&&this.keyboardRequisitioner.cache.defaultStub==r&&this.contextManager.activateKeyboard(r.id,r.langId,!0)},"eventRaiser");this.config.deferForInitialization.isResolved?o():this.config.deferForInitialization.then(o)}),l.on("keyboardadded",r=>{let o=a(()=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:r.id})},"eventRaiser");this.config.deferForInitialization.isResolved?o():this.config.deferForInitialization.then(o)}),this.keyboardRequisitioner.cache.on("keyboardadded",r=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:r.id})})})}get build(){return Number.parseInt(tt.VERSION_PATCH,10)}get version(){return tt.VERSION_RELEASE}get hardKeyboard(){return this._hardKeyboard}set hardKeyboard(i){this._hardKeyboard&&this._hardKeyboard.off("keyevent",this.keyEventListener),this._hardKeyboard=i,i.on("keyevent",this.keyEventListener)}get osk(){return this._osk}set osk(i){var t;this._osk&&(this._osk.off("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=this.osk.layerChangeHandler),this._osk=i,this.core.keyboardProcessor.contextDevice=(t=i==null?void 0:i.targetDevice)!=null?t:this.config.softDevice,i&&(this.contextManager.activeKeyboard&&(i.activeKeyboard=this.contextManager.activeKeyboard),i.on("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=i.layerChangeHandler)}getDebugInfo(){var n,l,s,c,r,o,d,u,B,b,I,F,h,y;let i=(n=this.contextManager)==null?void 0:n.activeKeyboard;return{configReport:(l=this.config)==null?void 0:l.debugReport(),keyboard:{id:Me((c=(s=i==null?void 0:i.metadata)==null?void 0:s.id)!=null?c:""),langId:((r=i==null?void 0:i.metadata)==null?void 0:r.langId)||"",version:(d=(o=i==null?void 0:i.keyboard)==null?void 0:o.version)!=null?d:""},model:{id:((B=(u=this.core)==null?void 0:u.activeModel)==null?void 0:B.id)||""},osk:{banner:(F=(I=(b=this.osk)==null?void 0:b.banner)==null?void 0:I.banner.type)!=null?F:"",layer:((y=(h=this.osk)==null?void 0:h.vkbd)==null?void 0:y.layerId)||""}}}refreshModel(){let i=this.contextManager.activeKeyboard,t=this.modelCache.modelForLanguage(i==null?void 0:i.metadata.langId);return this.core.activeModel!=t&&(this.core.activeModel&&this.core.languageProcessor.unloadModel(),t)?this.core.languageProcessor.loadModel(t).then(()=>t):Promise.resolve(t)}addEventListener(i,t){this.legacyAPIEvents.addEventListener(i,t)}removeEventListener(i,t){this.legacyAPIEvents.removeEventListener(i,t)}shutdown(){var i;this.legacyAPIEvents.shutdown(),(i=this.osk)==null||i.shutdown()}addModel(i){var n;this.modelCache.register(i);let t=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata;return t&&i.languages.indexOf(t.langId)!=-1?this.refreshModel().then(()=>{}):Promise.resolve()}removeModel(i){this.modelCache.unregister(i),this.core.activeModel&&this.core.activeModel.id==i&&this.core.languageProcessor.unloadModel()}setActiveKeyboard(i,t){return R(this,null,function*(){return this.contextManager.activateKeyboard(i,t,!0)})}getActiveKeyboard(){var i,t;return(t=(i=this.contextManager.activeKeyboard)==null?void 0:i.metadata.id)!=null?t:""}getActiveLanguage(i){var n,l,s;let t=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata;return i?(s=t==null?void 0:t.langName)!=null?s:"":(l=t==null?void 0:t.langId)!=null?l:""}isChiral(i){let t;if(i){if(typeof i=="string"){let n=this.keyboardRequisitioner.cache.getKeyboard(i);if(n)i=n;else throw new Error(`Keyboard '${i}' has not been loaded.`)}t=i}else t=this.core.activeKeyboard;return t.isChiral}resetContext(){this.contextManager.resetContext()}setNumericLayer(){this.core.keyboardProcessor.setNumericLayer(this.config.softDevice)}};a(bc,"KeymanEngine");var ci=bc;var rt=class rt{get height(){return this._height}set height(i){this._height=i>0?i:0,this.update()}get width(){return this._width}set width(i){this._width=i,this.update()}update(){let i=this.div.style,t=i.height,n=i.display;return this._height>0?(i.height=this._height+"px",i.display="block"):(i.height="0px",i.display="none"),t!==i.height||n!==i.display}constructor(i){let t=J("div");t.id=rt.BANNER_ID,t.className=rt.BANNER_CLASS,this.div=t,this.height=i,this.update()}appendStyleSheet(){}getDiv(){return this.div}configureForKeyboard(i,t){}shutdown(){}};a(rt,"Banner"),rt.DEFAULT_HEIGHT=37,rt.BANNER_CLASS="kmw-banner-bar",rt.BANNER_ID="kmw-banner-bar";var ue=rt;var Ke=class Ke{constructor(i){let t=typeof i=="string"?Ke.parseLengthStyle(i):i;this.val=t.val,this.absolute=t.absolute,t.special&&(this.special=t.special)}get styleString(){return this.absolute?this.val+"px":this.special?this.val+this.special:this.val*100+"%"}scaledBy(i){return new Ke({val:i*this.val,absolute:this.absolute})}static inPixels(i){return new Ke({val:i,absolute:!0})}static inPercent(i){return new Ke({val:i/100,absolute:!1})}static forScalar(i){return new Ke({val:i,absolute:!1})}static special(i,t){return new Ke({val:i,absolute:!1,special:t})}static parseLengthStyle(i){if(i=="")return Vo;let t=parseFloat(i);return isNaN(t)?(console.error("Could not properly parse specified length style info: '"+i+"'."),Vo):i.indexOf("px")!=-1?{val:t,absolute:!0}:i.indexOf("pt")!=-1?{val:4*t/3,absolute:!0}:i.indexOf("%")!=-1?{val:t/100,absolute:!1}:i.indexOf("rem")!=-1?{val:t,absolute:!1,special:"rem"}:i.indexOf("em")!=-1?{val:t,absolute:!1,special:"em"}:{val:4*t/3,absolute:!0}}};a(Ke,"ParsedLengthStyle");var Z=Ke,Vo=new Z("1em");var hc=class hc extends ue{constructor(){super(0);this.type="blank"}};a(hc,"BlankBanner");var ot=hc;var Fc=class Fc{constructor(){this._activeBannerHeight=ue.DEFAULT_HEIGHT;this.events=new S.default;this.constructContainer()}constructContainer(){let i=J("div");return i.id="keymanweb_banner_container",i.className="kmw-banner-container",this.bannerContainer=i}get element(){return this.bannerContainer}appendStyles(){this.currentBanner&&this.currentBanner.appendStyleSheet()}get banner(){return this.currentBanner}set banner(i){if(this.currentBanner){if(i==this.currentBanner)return;{let t=this.currentBanner;this.currentBanner=i,this.bannerContainer.replaceChild(i.getDiv(),t.getDiv()),t.shutdown()}}else this.currentBanner=i,i&&this.bannerContainer.appendChild(i.getDiv());i instanceof ot||(i.height=this.activeBannerHeight),this.events.emit("bannerchange")}get height(){return this.currentBanner?this.currentBanner.height:0}get activeBannerHeight(){return this._activeBannerHeight}set activeBannerHeight(i){this._activeBannerHeight=i,this.currentBanner&&!(this.currentBanner instanceof ot)&&(this.currentBanner.height=i)}get layoutHeight(){return Z.inPixels(this.height)}get width(){var i;return(i=this.currentBanner)==null?void 0:i.width}set width(i){this.currentBanner&&(this.currentBanner.width=i)}refreshLayout(){var i,t;(t=(i=this.currentBanner).refreshLayout)==null||t.call(i)}};a(Fc,"BannerView");var rl=Fc;var yc=class yc extends ue{constructor(t,n){var i=(...args)=>{super(...args)};t.length>0?(i(),n&&(this.height=n)):i(0),this.type="image",t.indexOf("base64")>=0?console.log("Loading img from base64 data"):console.log("Loading img with src '"+t+"'"),this.img=document.createElement("img"),this.img.setAttribute("src",t);let l=this.img.style;l.width="100%",l.height="100%",this.getDiv().appendChild(this.img),console.log("Image loaded.")}setImagePath(t){this.img&&this.img.setAttribute("src",t)}};a(yc,"ImageBanner");var ol=yc;function He(g,i){i instanceof Error?console.error(`${g}: ${i.message}

${i.stack}`):(console.error(g),console.error(i))}a(He,"reportError");var mc=class mc{constructor(i){this.queue=[],this.defaultWaitFactory=i||(()=>ge(0))}get defaultWait(){return this.defaultWaitFactory()}get ready(){return this.queue.length==0&&!this.waitLock}triggerNextClosure(){return R(this,null,function*(){if(this.queue.length==0)return;let i=this.queue.shift();this.waitLock=Promise.resolve();let t;try{t=i()}catch(n){He("Error from queued closure",n)}t=t!=null?t:this.defaultWaitFactory(),this.waitLock=t;try{yield t}catch(n){He("Async error from queued closure",n)}this.waitLock=null,this.triggerNextClosure()})}runAsync(i){let t=this.ready;this.queue.push(i),t&&this.triggerNextClosure()}};a(mc,"AsyncClosureDispatchQueue");var al=mc;function So(g){return"targetX"in g&&"targetY"in g&&"t"in g}a(So,"isAnInputSample");var at=class at{constructor(i){this.rawLinearSums={x:0,y:0,t:0};this.coordArcSum=0;this._sampleCount=0;if(i)if(i instanceof at)Object.assign(this,i),this.rawLinearSums=G({},i.rawLinearSums);else if(So(i))Object.assign(this,this.extend(i));else throw new Error("A constructor for this input pattern has not yet been implemented")}extend(i){return this._extend(new at(this),i)}_extend(i,t){i._initialSample||(i._initialSample=t,i.baseSample=t);let n=i.baseSample;this.followingSample=t;let l=t.targetX-n.targetX,s=t.targetY-n.targetY,c=t.t-n.t;if(i.rawLinearSums.x+=l,i.rawLinearSums.y+=s,i.rawLinearSums.t+=c,this.lastSample){let r=t.targetX-this.lastSample.targetX,o=t.targetY-this.lastSample.targetY,d=r*r+o*o,u=Math.sqrt(d);i.coordArcSum+=u}return i._lastSample=t,i.sampleCount=this.sampleCount+1,i}deaccumulate(i){let t=new at(this);return this._deaccumulate(t,i)}_deaccumulate(i,t){if(!t)return i;if(!t.followingSample||!t.lastSample)throw"Invalid argument:  stats missing necessary tracking variable.";for(let n in i.rawLinearSums){let l=n;i.rawLinearSums[l]-=t.rawLinearSums[l]}if(t.followingSample&&t.lastSample){let n=t.followingSample.targetX-t.lastSample.targetX,l=t.followingSample.targetY-t.lastSample.targetY,s=n*n+l*l,c=Math.sqrt(s);i.coordArcSum-=c,i.coordArcSum-=t.coordArcSum}return i.sampleCount-=t.sampleCount,i._initialSample=t.followingSample,i}translateCoordSystem(i){let t=new at(this);return this._translateCoordSystem(t,i)}_translateCoordSystem(i,t){if(this.sampleCount==0)return i;let n=i.initialSample==i.lastSample;return i._initialSample=t(i.initialSample),i.baseSample=t(i.baseSample),i._lastSample=n?i._initialSample:t(i.lastSample),i}replaceInitialSample(i){let t=new at(this);return this._replaceInitialSample(t,i)}_replaceInitialSample(i,t){if(this.sampleCount==0)throw new Error("no sample available to replace");let n=i.initialSample;if(i._initialSample=t,this.sampleCount>1){let l=t.targetX-n.targetX,s=t.targetY-n.targetY,c=t.t-n.t;i.rawLinearSums.x+=l,i.rawLinearSums.y+=s,i.rawLinearSums.t+=c;let r=l*l+s*s,o=Math.sqrt(r);i.coordArcSum+=o}else i._lastSample=t;return i}get lastSample(){return this._lastSample}get lastTimestamp(){var i;return(i=this.lastSample)==null?void 0:i.t}get sampleCount(){return this._sampleCount}set sampleCount(i){this._sampleCount=i}get initialSample(){return this._initialSample}mappingConstant(i){if(this.baseSample)return i=="t"?this.baseSample.t:i=="x"?this.baseSample.targetX:i=="y"?this.baseSample.targetY:0}mean(i){return this.rawLinearSums[i]/this.sampleCount+this.mappingConstant(i)}get netDistance(){if(!this.lastSample||!this.initialSample)return 0;let i=this.lastSample.targetX-this.initialSample.targetX,t=this.lastSample.targetY-this.initialSample.targetY;return Math.sqrt(i*i+t*t)}get duration(){return!this.lastSample||!this.initialSample?0:this.lastSample.t-this.initialSample.t}get angle(){if(this.sampleCount==1||!this.lastSample||!this.initialSample)return;if(this.netDistance<1)return;let i=this.lastSample.targetX-this.initialSample.targetX,t=this.lastSample.targetY-this.initialSample.targetY,n=Math.acos(-t/this.netDistance);return i<0?2*Math.PI-n:n}get angleInDegrees(){return this.angle*180/Math.PI}get cardinalDirection(){if(this.sampleCount==1||!this.lastSample||!this.initialSample||isNaN(this.angle)||this.angle===null||this.angle===void 0)return;let i=["n","ne","e","se","s","sw","w","nw","n"],t=Math.ceil((this.angleInDegrees-22.5)/45);return i[t]}get speed(){return this.duration?this.netDistance/this.duration:0}get rawDistance(){return this.coordArcSum}toJSON(){return{angle:this.angle,cardinal:this.cardinalDirection,netDistance:this.netDistance,duration:this.duration,sampleCount:this.sampleCount,rawDistance:this.rawDistance}}};a(at,"CumulativePathStats");var fe=at;function St(g,i){let t=g.gestures.find(n=>n.id==i);if(!t)throw new Error(`Could not find spec for gesture with id '${i}'`);return t}a(St,"getGestureModel");function Gc(g,i){let t=g.sets[i];if(!t)throw new Error(`Could not find a defined gesture-set with id '${i}'`);let n=g.gestures.filter(s=>!!t.find(c=>s.id==c)),l=t.filter(s=>!n.find(c=>c.id==s));if(l.length>0)throw new Error(`Set '${i}' cannot find definitions for gestures with ids ${l}`);return n}a(Gc,"getGestureModelSet");var pc={gestures:[],sets:{default:[]}};var Cc=class Cc{constructor(){}getBoundingClientRect(){return new DOMRect(0,0,Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),Math.max(document.documentElement.clientHeight||0,window.innerHeight||0))}};a(Cc,"ViewportZoneSource");var gl=Cc;var Qc=class Qc{get edgePadding(){return this._edgePadding}constructor(i,t){Array.isArray(i)&&(t=i,i=new gl),this.root=i,t=t||[0,0,0,0],this.updatePadding(t)}updatePadding(i){switch(i.length){case 1:let t=i[0];this._edgePadding={x:t,y:t,w:2*t,h:2*t};break;case 2:this._edgePadding={x:i[1],y:i[0],w:2*i[1],h:2*i[0]};break;case 3:this._edgePadding={x:i[1],y:i[0],w:2*i[1],h:i[0]+i[2]};break;case 4:this._edgePadding={x:i[3],y:i[0],w:i[1]+i[3],h:i[0]+i[2]};break;default:throw new Error("Invalid values for PaddedZoneSource's edgePadding - must be between 1 to 4 `number` values.")}}getBoundingClientRect(){let i=this.root.getBoundingClientRect();return new DOMRect(i.left+this.edgePadding.x,i.top+this.edgePadding.y,i.width-this.edgePadding.w,i.height-this.edgePadding.h)}};a(Qc,"PaddedZoneSource");var Be=Qc;function dl(g){var t,n,l,s,c,r,o;let i=G({},g);if(i.mouseEventRoot=(t=i.mouseEventRoot)!=null?t:i.targetRoot,i.touchEventRoot=(n=i.touchEventRoot)!=null?n:i.targetRoot,i.inputStartBounds=(l=i.inputStartBounds)!=null?l:i.targetRoot,i.maxRoamingBounds=(s=i.maxRoamingBounds)!=null?s:i.targetRoot,i.safeBounds=(c=i.safeBounds)!=null?c:new Be([2]),i.itemIdentifier=(r=i.itemIdentifier)!=null?r:()=>null,i.recordingMode=!!i.recordingMode,i.historyLength=((o=i.historyLength)!=null?o:0)>0?i.historyLength:0,g.paddedSafeBounds)delete i.safeBoundPadding;else{let d=g.safeBoundPadding;typeof d=="number"&&(d=[d]),d=d!=null?d:[3],i.paddedSafeBounds=new Be(i.safeBounds,d)}return i}a(dl,"preprocessRecognizerConfig");var ul=class ul extends S.default{constructor(){super();this._isComplete=!1;this._stats=new fe}get stats(){return this._stats}clone(){let t=new ul;return t._isComplete=this._isComplete,t._wasCancelled=this._wasCancelled,t._stats=new fe(this._stats),t}get isComplete(){return this._isComplete}get wasCancelled(){return this._wasCancelled}translateCoordSystem(t){this._stats=this._stats.translateCoordSystem(t)}replaceInitialSample(t){this._stats=this._stats.replaceInitialSample(t)}extend(t){if(this._isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this._stats=this._stats.extend(t),this.emit("step",t)}terminate(t=!1){this._isComplete||(this._wasCancelled=t,this._isComplete=!0,t?this.emit("invalidated"):this.emit("complete"),this.removeAllListeners())}toJSON(){return{stats:this.stats,wasCancelled:this.wasCancelled}}};a(ul,"GesturePath");var ri=ul;var qi=class qi extends ri{constructor(){super(...arguments);this.samples=[]}clone(){let t=new qi;return t.samples=[].concat(this.samples),t._isComplete=this._isComplete,t._wasCancelled=this._wasCancelled,t._stats=new fe(this._stats),t}static deserialize(t){let n=new qi;n.samples=[].concat(t.coords.map(s=>G({},s))),n._isComplete=!0,n._wasCancelled=t.wasCancelled;let l=n.samples.reduce((s,c)=>s.extend(c),new fe);return n._stats=l,n}extend(t){if(this.isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this.samples.push(t),super.extend(t)}translateCoordSystem(t){super.translateCoordSystem(t);for(let n=0;n<this.samples.length;n++)this.samples[n]=t(this.samples[n])}get coords(){return this.samples}toJSON(){let t={coords:[].concat(this.samples.map(n=>({targetX:n.targetX,targetY:n.targetY,t:n.t,item:n.item}))),wasCancelled:this.wasCancelled,stats:this.stats};for(let n of t.coords)delete n.clientX,delete n.clientY,n.item===void 0&&delete n.item;return t}};a(qi,"GestureDebugPath");var gt=qi;var Uc=class Uc{constructor(i,t,n,l){this.stateToken=null;this.rawIdentifier=i,this.isFromTouch=n,this._path=l?new l:new ri,this.recognizerConfigStack=Array.isArray(t)?t:[t]}get path(){return this._path}setGestureMatchInspector(i){if(this._matchInspectionClosure)throw new Error("Invalid state:  the match-inspection closure has already been set");this._matchInspectionClosure=i}update(i){this.path.extend(i),this._baseItem||(this._baseItem=i.item)}get baseItem(){return this._baseItem}set baseItem(i){this._baseItem=i}get currentSample(){return this.path.stats.lastSample}get potentialModelMatchIds(){return this._matchInspectionClosure(this)}constructSubview(i,t,n){return new re(this,this.recognizerConfigStack,i,t,n)}terminate(i){this.path.terminate(i)}get isPathComplete(){return this.path.isComplete}get identifier(){return`${this.isFromTouch?"touch":"mouse"}:${this.rawIdentifier}`}pushRecognizerConfig(i){let t=A(G({},i),{mouseEventRoot:this.recognizerConfigStack[0].mouseEventRoot,touchEventRoot:this.recognizerConfigStack[0].touchEventRoot});this.recognizerConfigStack.push(dl(t))}popRecognizerConfig(){if(this.recognizerConfigStack.length==1)throw new Error("Cannot 'pop' the original recognizer-configuration for this GestureSource.");return this.recognizerConfigStack.pop()}get currentRecognizerConfig(){return this.recognizerConfigStack[this.recognizerConfigStack.length-1]}toJSON(){return{identifier:this.identifier,isFromTouch:this.isFromTouch,path:this.path.toJSON(),stateToken:this.stateToken}}};a(Uc,"GestureSource");var Fe=Uc,$i=class $i extends Fe{constructor(t,n,l,s,c){let r=0,o=t.path.stats.sampleCount;t instanceof $i&&(r=t._baseStartIndex);super(t.rawIdentifier,n,t.isFromTouch,Object.getPrototypeOf(t.path).constructor);let d=this._baseSource=t instanceof $i?t._baseSource:t;this.stateToken=c!=null?c:t.stateToken;let u=a(h=>{let y=this.recognizerTranslation,Q=A(G({},h),{targetX:h.targetX-y.x,targetY:h.targetY-y.y});return this.stateToken&&(Q.stateToken=this.stateToken),(this.stateToken!=d.stateToken||this.stateToken!=t.stateToken)&&(Q.item=this.currentRecognizerConfig.itemIdentifier(Q,null)),Q},"translateSample"),B=t.path.stats.lastSample;l?(this._baseStartIndex=r=Math.max(r+o-1,0),o=o>0?1:0):this._baseStartIndex=r,l?t.path.stats.sampleCount&&this._path.extend(t.path.stats.lastSample):this._path=t.path.clone(),this._path.translateCoordSystem(u),s?this._baseItem=t.baseItem:this._baseItem=B==null?void 0:B.item;let b=a(()=>this.path.terminate(!1),"completeHook"),I=a(()=>this.path.terminate(!0),"invalidatedHook"),F=a(h=>{super.update(u(h))},"stepHook");d.path.on("complete",b),d.path.on("invalidated",I),d.path.on("step",F),this.subviewDisconnector=()=>{d.path.off("complete",b),d.path.off("invalidated",I),d.path.off("step",F)},d.isPathComplete&&(this.path.terminate(d.path.wasCancelled),this.disconnect())}get recognizerTranslation(){if(this.recognizerConfigStack.length==1||!this.currentRecognizerConfig)return{x:0,y:0};let n=this.currentRecognizerConfig.targetRoot.getBoundingClientRect(),l=this.recognizerConfigStack[0].targetRoot.getBoundingClientRect();return{x:n.left-l.left,y:n.top-l.top}}get baseSource(){return this._baseSource}disconnect(){this.subviewDisconnector&&(this.subviewDisconnector(),this.subviewDisconnector=null)}pushRecognizerConfig(t){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}popRecognizerConfig(){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}update(t){throw new Error("Updates should be provided through the base GestureSource.")}terminate(t){this.baseSource.terminate(t)}};a($i,"GestureSourceSubview");var re=$i;var Il=class Il extends Fe{constructor(t,n,l){super(t,n,l,gt);this.stateToken=null}initPath(){return new gt}static deserialize(t,n){let l=n!==void 0?n:this._jsonIdSeed++,s=t.isFromTouch,c=gt.deserialize(t.path),r=new Il(l,null,s);return r._path=c,r}};a(Il,"GestureDebugSource");var Bl=Il;var en=class en extends S.default{constructor(t){var n;super();this._activeTouchpoints=[];this.identifierMap={};this.config=t,this.sourceConstructor=(n=t==null?void 0:t.recordingMode)==null||n?Bl:Fe}createTouchpoint(t,n){let l=en.IDENTIFIER_SEED++;this.identifierMap[t]=l;let s=new this.sourceConstructor(l,this.config,n);return s.stateToken=this.stateToken,s}fulfillInputStart(t){}maintainTouchpoints(t){t||(t=[]),this._activeTouchpoints.filter(n=>!t.includes(n)).forEach(n=>n.terminate(!0))}hasActiveTouchpoint(t){return this.identifierMap[t]!==void 0}getTouchpointWithId(t){let n=this.identifierMap[t];return this._activeTouchpoints.find(l=>l.rawIdentifier==n)}getConfigForId(t){return this.getTouchpointWithId(t).currentRecognizerConfig}getStateTokenForId(t){var n;return(n=this.getTouchpointWithId(t).stateToken)!=null?n:null}dropTouchpoint(t){let n=t.rawIdentifier;this._activeTouchpoints=this._activeTouchpoints.filter(l=>t!=l);for(let l of Object.keys(this.identifierMap)){let s=Number.parseInt(l,10);this.identifierMap[s]==n&&delete this.identifierMap[s]}}addTouchpoint(t){this._activeTouchpoints.push(t)}get activeSources(){return[].concat(this._activeTouchpoints)}};a(en,"InputEngineBase"),en.IDENTIFIER_SEED=0;var bl=en;function xc(g,i,t){let n=g.targetRoot.getBoundingClientRect();return{clientX:i,clientY:t,targetX:i-n.left,targetY:t-n.top}}a(xc,"processSampleClientCoords");var Zc=class Zc extends bl{buildSampleFor(i,t,n,l,s){var d,u;let c=A(G({},xc(this.config,i,t)),{t:l,stateToken:(d=s==null?void 0:s.stateToken)!=null?d:this.stateToken}),o=((u=s==null?void 0:s.currentRecognizerConfig.itemIdentifier)!=null?u:this.config.itemIdentifier)(c,n);return c.item=o,c}onInputStart(i,t,n,l){let s=this.createTouchpoint(i,l);s.update(t),this.addTouchpoint(s),s.path.on("invalidated",()=>{this.dropTouchpoint(s)}),s.path.on("complete",()=>{this.dropTouchpoint(s)});try{this.emit("pointstart",s)}catch(c){He("Engine-internal error while initializing gesture matching for new source",c)}return s}onInputMove(i,t,n){if(i)try{i.update(t)}catch(l){He("Error occurred while updating source",l)}}onInputMoveCancel(i,t,n){if(i)try{i.update(t),i.path.terminate(!0)}catch(l){He("Error occurred while cancelling further input for source",l)}}onInputEnd(i,t){if(i)try{i.path.terminate(!1)}catch(n){He("Error occurred while finalizing input for source",n)}}};a(Zc,"InputEventEngine");var oi=Zc;var Xe=class Xe{constructor(){}static getCoordZoneBitmask(i,t){let n=t.getBoundingClientRect(),l=0;return l|=i.clientX<n.left?Xe.FAR_LEFT:0,l|=i.clientX>n.right?Xe.FAR_RIGHT:0,l|=i.clientY<n.top?Xe.FAR_TOP:0,l|=i.clientY>n.bottom?Xe.FAR_BOTTOM:0,l}static inputStartOutOfBoundsCheck(i,t){return!!this.getCoordZoneBitmask(i,t.inputStartBounds)}static inputStartSafeBoundProximityCheck(i,t){return this.getCoordZoneBitmask(i,t.paddedSafeBounds)}static inputMoveCancellationCheck(i,t,n){return n=n||0,this.getCoordZoneBitmask(i,t.maxRoamingBounds)?!0:!!(this.getCoordZoneBitmask(i,t.safeBounds)&~n)}};a(Xe,"ZoneBoundaryChecker"),Xe.FAR_TOP=8,Xe.FAR_LEFT=4,Xe.FAR_BOTTOM=2,Xe.FAR_RIGHT=1;var Le=Xe;var Xc=class Xc extends oi{constructor(t){super(t);this.hasActiveClick=!1;this.disabledSafeBounds=0;this.currentSource=null;this.activeIdentifier=0;this._mouseStart=n=>this.onMouseStart(n),this._mouseMove=n=>this.onMouseMove(n),this._mouseEnd=n=>this.onMouseEnd(n)}get eventRoot(){return this.config.mouseEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("mousedown",this._mouseStart,!0),this.eventRoot.addEventListener("mousemove",this._mouseMove,!1),this.eventRoot.addEventListener("mouseup",this._mouseEnd,!0)}unregisterEventHandlers(){this.eventRoot.removeEventListener("mousedown",this._mouseStart,!0),this.eventRoot.removeEventListener("mousemove",this._mouseMove,!1),this.eventRoot.removeEventListener("mouseup",this._mouseEnd,!0)}preventPropagation(t){t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,typeof t.stopImmediatePropagation=="function"?t.stopImmediatePropagation():typeof t.stopPropagation=="function"&&t.stopPropagation()}buildSampleFromEvent(t){return this.buildSampleFor(t.clientX,t.clientY,t.target,performance.now(),this.currentSource)}onMouseStart(t){if(!this.config.targetRoot.contains(t.target))return;this.preventPropagation(t);let n=this.buildSampleFromEvent(t);Le.inputStartOutOfBoundsCheck(n,this.config)||(this.disabledSafeBounds=Le.inputStartSafeBoundProximityCheck(n,this.config));let l=this.onInputStart(this.activeIdentifier,n,t.target,!1);this.currentSource=l;let s=a(()=>{this.currentSource=null},"cleanup");l.path.on("complete",s),l.path.on("invalidated",s)}onMouseMove(t){let n=this.currentSource;if(!n)return;let l=this.buildSampleFromEvent(t);if(!t.buttons){this.hasActiveClick&&(this.hasActiveClick=!1,this.onInputMoveCancel(n,l,t.target));return}this.preventPropagation(t);let s=n.currentRecognizerConfig;Le.inputMoveCancellationCheck(l,s,this.disabledSafeBounds)?this.onInputMoveCancel(n,l,t.target):this.onInputMove(n,l,t.target)}onMouseEnd(t){let n=this.currentSource;n&&(t.buttons||(this.hasActiveClick=!1),this.onInputEnd(n,t.target))}};a(Xc,"MouseEventEngine");var hl=Xc;function Wo(g){let i=[];for(let t=0;t<g.length;t++)i.push(g.item(t));return i}a(Wo,"touchListToArray");var Vc=class Vc extends oi{constructor(t){super(t);this.eventDispatcher=new al;this.safeBoundMaskMap={};this.pendingSourcePromises=new Map;this.inputStartSignalMap=new Map;this._touchStart=n=>this.onTouchStart(n),this._touchMove=n=>this.onTouchMove(n),this._touchEnd=n=>this.onTouchEnd(n)}get eventRoot(){return this.config.touchEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("touchstart",this._touchStart,{capture:!0,passive:!1}),this.eventRoot.addEventListener("touchmove",this._touchMove,{capture:!1,passive:!1}),this.eventRoot.addEventListener("touchend",this._touchEnd,{capture:!0,passive:!1})}unregisterEventHandlers(){this.eventRoot.removeEventListener("touchstart",this._touchStart,!0),this.eventRoot.removeEventListener("touchmove",this._touchMove,!1),this.eventRoot.removeEventListener("touchend",this._touchEnd,!0)}preventPropagation(t){t.cancelable&&t.preventDefault(),typeof t.stopImmediatePropagation=="function"?t.stopImmediatePropagation():typeof t.stopPropagation=="function"&&t.stopPropagation()}dropTouchpoint(t){super.dropTouchpoint(t);for(let n of Object.keys(this.safeBoundMaskMap)){let l=Number.parseInt(n,10);this.getTouchpointWithId(l)==t&&delete this.safeBoundMaskMap[l]}}fulfillInputStart(t){let n=this.inputStartSignalMap.get(t);n&&(this.inputStartSignalMap.delete(t),n.resolve())}hasActiveTouchpoint(t){return super.hasActiveTouchpoint(t)||!!this.pendingSourcePromises.has(t)}buildSampleFromTouch(t,n,l){return this.buildSampleFor(t.clientX,t.clientY,t.target,n,l)}onTouchStart(t){if(!this.config.targetRoot.contains(t.target))return;this.preventPropagation(t);let n=Wo(t.touches),l=Wo(t.changedTouches),c=n.filter(o=>l.findIndex(d=>o.identifier==d.identifier)==-1).map(o=>this.pendingSourcePromises.get(o.identifier));this.eventDispatcher.runAsync(()=>R(this,null,function*(){let o=yield Promise.all(c);return this.maintainTouchpoints(o),this.eventDispatcher.defaultWait}));let r=new Map;for(let o=0;o<t.changedTouches.length;o++){let d=t.changedTouches.item(o),u=new v;this.pendingSourcePromises.set(d.identifier,u),r.set(d.identifier,u)}this.eventDispatcher.runAsync(()=>{let o=performance.now(),d=null;for(let u=0;u<t.changedTouches.length;u++){let B=t.changedTouches.item(u),b=B.identifier,I=this.buildSampleFromTouch(B,o,null);if(!Le.inputStartOutOfBoundsCheck(I,this.config))this.safeBoundMaskMap[b]=Le.inputStartSafeBoundProximityCheck(I,this.config);else{r.get(b).resolve(null);continue}d=this.onInputStart(b,I,t.target,!0);let F=r.get(b);F.resolve(d);let h=a(()=>{this.pendingSourcePromises.get(b)==F&&this.pendingSourcePromises.delete(b)},"cleanup");d.path.on("complete",h),d.path.on("invalidated",h)}if(d){let u=new v;return this.inputStartSignalMap.set(d,u),u.corePromise}else return Promise.resolve()})}onTouchMove(t){var l;for(let s=0;s<t.touches.length;s++){let c=t.touches.item(s);if(this.hasActiveTouchpoint(c.identifier)){this.preventPropagation(t);break}}let n=new Map;for(let s=0;s<t.touches.length;s++){let c=t.touches.item(s).identifier;n.set(c,(l=this.pendingSourcePromises.get(c))==null?void 0:l.corePromise)}this.eventDispatcher.runAsync(()=>R(this,null,function*(){let s=yield Promise.all(n.values());return this.maintainTouchpoints(s),this.eventDispatcher.defaultWait})),this.eventDispatcher.runAsync(()=>R(this,null,function*(){let s=performance.now();for(let c=0;c<t.touches.length;c++){let r=t.touches.item(c),o=r.identifier,d=yield n.get(o);if(!d||d.isPathComplete)continue;let u=d.currentRecognizerConfig,B=this.buildSampleFromTouch(r,s,d);Le.inputMoveCancellationCheck(B,u,this.safeBoundMaskMap[o])?this.onInputMoveCancel(d,B,r.target):this.onInputMove(d,B,r.target)}return this.eventDispatcher.defaultWait}))}onTouchEnd(t){var l;for(let s=0;s<t.changedTouches.length;s++){let c=t.changedTouches.item(s);if(this.hasActiveTouchpoint(c.identifier)){this.preventPropagation(t);break}}let n=new Map;for(let s=0;s<t.changedTouches.length;s++){let c=t.changedTouches.item(s).identifier,r=(l=this.pendingSourcePromises.get(c))==null?void 0:l.corePromise;n.set(c,r)}this.eventDispatcher.runAsync(()=>R(this,null,function*(){for(let s=0;s<t.changedTouches.length;s++){let c=t.changedTouches.item(s),r=yield n.get(c.identifier);!r||r.isPathComplete||this.onInputEnd(r,t.target)}return this.eventDispatcher.defaultWait}))}};a(Vc,"TouchEventEngine");var Fl=Vc;var Sc=class Sc{get promise(){return this.publishedPromise.corePromise}constructor(i,t,n){if(!i||!t)throw new Error("A gesture-path source and contact-path model must be specified.");if(this.model=i,this.publishedPromise=new v,this.source=t,this.inheritedStats=n,this.lastStats=null,i.timer){let l=i.timer.inheritElapsed?Math.min(t.path.stats.duration,i.timer.duration):0;this.timerPromise=new Ee(i.timer.duration-l),this.publishedPromise.then(()=>{this.timerPromise.resolve(!1)}),this.timerPromise.then(s=>{let c=t instanceof re?t.baseSource:t,r=performance.now();!c.isPathComplete&&c.currentSample.t!=r&&c.path.extend(A(G({},c.currentSample),{t:r})),s!=i.timer.expectedResult&&this.finalize(!1,"timer"),this.finalize(!0,"timer")})}}finalize(i,t){if(this.publishedPromise.isFulfilled)return this._result;let n=this.model;n.validateItem&&i&&(i=n.validateItem(this.source.path.stats.lastSample.item,this.baseItem));let l;return i?l={type:n.pathResolutionAction,cause:t}:l={type:"reject",cause:t},this.publishedPromise.resolve(l),this._result=l,l}get stats(){return this.source.path.stats}get baseItem(){return this.source.baseItem}get lastItem(){return this.source.currentSample.item}update(){let i=this.model,t=this.source;if(t.path.wasCancelled)return this.finalize(!1,"path");if(i.itemChangeAction&&t.path.stats.sampleCount>0&&t.currentSample.item!=t.baseItem){let n=i.itemChangeAction=="resolve";return this.finalize(n,"item")}else{let n=i.pathModel.evaluate(t.path,this.lastStats,t.baseItem,this.inheritedStats)||"continue";return this.lastStats=t.path.stats,n!="continue"?this.finalize(n=="resolve","path"):t.path.isComplete?this.finalize(!1,"path"):{type:"continue"}}}};a(Sc,"PathMatcher");var ai=Sc;var Wc=class Wc{constructor(i,t){this._isCancelled=!1;var r;if(!i||!t)throw new Error("Construction of GestureMatcher requires a gesture-model spec and a source for related contact points.");if(!i.sustainTimer&&!t)throw new Error("If the provided gesture-model spec lacks a sustain timer, there must be an active contact point.");let n=t instanceof Fe?null:t,l=n?null:t;this.predecessor=n,this.publishedPromise=new v,this.model=i,i.sustainTimer&&(this.sustainTimerPromise=new Ee(i.sustainTimer.duration),this.sustainTimerPromise.then(o=>{let d=i.sustainTimer.expectedResult==o;this.finalize(d,"timer")})),this.pathMatchers=[];let c=(l?[l]:n.sources).map(o=>l&&o==l?l:o.isPathComplete?null:o).reduce((o,d)=>d?o.concat(d):o,[]);if(i.sustainTimer&&c.length>0){this.finalize(!1,"path");return}else!i.sustainTimer&&c.length==0&&this.finalize(!1,"path");for(let o=0;o<c.length;o++){let d=c[o];d instanceof re&&d.disconnect();let u=i.contacts[o];if(!u)throw new Error(`No contact model for inherited path: gesture "${i.id}', entry ${o}`);let B=(r=u==null?void 0:u.model.pathInheritance)!=null?r:"chop",b=!1,I;switch(B){case"reject":this.finalize(!1,"path");return;case"full":I=d.constructSubview(!1,!0),this.addContactInternal(I,d.path.stats,!0);continue;case"partial":b=!0;case"chop":I=d.constructSubview(!0,b),this.addContactInternal(I,d.path.stats,!0);break}}}get sources(){return this.pathMatchers.map((i,t)=>{if(!this.model.contacts[t].resetOnInstantFulfill)return i.source}).filter(i=>!!i)}get promise(){return this.publishedPromise.corePromise}cancel(){this._isCancelled=!0,this._result||this.finalize(!1,"cancelled")}get isCancelled(){return this._isCancelled}finalize(i,t){var n,l;if(this.publishedPromise.isFulfilled)return this._result;try{let s;i?s=this.model.resolutionAction:(t!="cancelled"&&((n=this.model.rejectionActions)!=null&&n[t])&&(s=this.model.rejectionActions[t],s.item="none"),s=s||{type:"none",item:"none"});let c;switch((l=s.item)!=null?l:"current"){case"none":c=null;break;case"base":c=this.primaryPath.baseItem;break;case"current":c=this.primaryPath.currentSample.item;break}let o={matched:i,action:A(G({},s),{item:c})};return this.publishedPromise.resolve(o),this._result=o,o}catch(s){return this.publishedPromise.reject(s),{matched:!1,action:{type:"none",item:null}}}}finalizeSources(){if(!this._result)throw Error("Invalid state for source-finalization - the matcher's evaluation of the gesture model is not yet complete");let i=this._result.matched;for(let t=0;t<this.pathMatchers.length;t++){let n=this.pathMatchers[t],l=this.model.contacts[t];n.source.isPathComplete||(i&&l.endOnResolve||!i&&l.endOnReject)&&n.source.terminate(!1)}}get primaryPath(){let i,t=Number.NEGATIVE_INFINITY;for(let n of this.pathMatchers)n.model.itemPriority>t&&(t=n.model.itemPriority,i=n);return!i&&this.predecessor?this.predecessor.primaryPath:i==null?void 0:i.source}get baseItem(){return this.primaryPath.baseItem}get currentItem(){return this.primaryPath.currentSample.item}get allSourceIds(){let i=this.sources.map(n=>n.identifier),t=this.predecessor?this.predecessor.allSourceIds:[];return i=i.filter(n=>t.indexOf(n)==-1),i.concat(t)}mayAddContact(){return this.pathMatchers.length<this.model.contacts.length}addContact(i){let t=this.pathMatchers.length;if(!this.mayAddContact())throw new Error(`The specified gesture model does not support more than ${t} contact points.`);this.addContactInternal(i.constructSubview(!1,!0),null)}get result(){return this._result}addContactInternal(i,t,n){var u;let l=this.pathMatchers.length,s=this.model.contacts[l],c=new ai(s.model,i,new fe(t));this.pathMatchers.push(c);let r=null,o=null;if(!l&&this.predecessor&&this.model.sustainTimer){r=this.predecessor.primaryPath;let B=(u=this.model.sustainTimer.baseItem)!=null?u:"result",b;switch(B){case"none":o=null;break;case"base":o=this.predecessor.primaryPath.baseItem,b=this.predecessor.primaryPath.stateToken;break;case"result":o=this.predecessor.result.action.item,b=this.predecessor.primaryPath.currentSample.stateToken;break}i.baseItem=o!=null?o:i.baseItem,i.stateToken=b,i.currentSample.stateToken=b,i.currentRecognizerConfig&&(i.currentSample.item=i.currentRecognizerConfig.itemIdentifier(i.currentSample,null))}else o=this.primaryPath.baseItem,r=this.primaryPath;if(s.model.baseCoordReplacer){let B=i.path.stats,b=s.model.baseCoordReplacer(B,o);if(b){let I=A(G({},xc(i.currentRecognizerConfig,b.clientX,b.clientY)),{t:b.t||b.t===0?b.t:B.initialSample.t,item:o,stateToken:i.stateToken});i.path.replaceInitialSample(I)}}if(s.model.allowsInitialState&&!s.model.allowsInitialState(i.currentSample,r.currentSample,o,r.stateToken)){this.pathMatchers.pop(),this.finalize(!1,"cancelled");return}let d=c.update();if((d==null?void 0:d.type)=="reject"){this.finalize(!1,n?"cancelled":"path");return}c.promise.then(B=>{this.finalize(B.type=="resolve",B.cause)})}update(){this.pathMatchers.forEach(i=>{try{i.update()}catch(t){console.error(t),this.finalize(!1,"cancelled")}})}};a(Wc,"GestureMatcher");var Wt=Wc;var Ac=class Ac extends S.default{constructor(t){super();this._sourceSelector=[];this.potentialMatchers=[];this.sustainMode=!1;this.attemptSynchronousUpdate=a(()=>{let n=this._sourceSelector.filter(s=>!s.source.isPathComplete).map(s=>s.source.currentSample.t),l=n[0];n.find(s=>l!=s)||this.potentialMatchers.forEach(s=>s.update())},"attemptSynchronousUpdate");this.baseGestureSetId=t||"default"}potentialMatchersForSource(t){return this.potentialMatchers.filter(n=>n.allSourceIds.find(l=>l==t.identifier))}cascadeTermination(){let t=this.potentialMatchers,n=t.filter(r=>!r.model.sustainWhenNested),l=t.filter(r=>r.model.sustainWhenNested);this.potentialMatchers=l;let s=l.map(r=>r.allSourceIds).reduce((r,o)=>{for(let d of o)r.indexOf(d)==-1&&r.push(d);return r},[]);return this._sourceSelector.filter(r=>!s.find(o=>o==r.source.identifier)).forEach(r=>{r.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}});let o=this._sourceSelector.indexOf(r);o>-1&&this._sourceSelector.splice(o,1)}),n.forEach(r=>r.cancel()),this.sustainMode=!0,this._sourceSelector.map(r=>r.source)}matchGesture(t,n){return R(this,null,function*(){let l=t instanceof Fe,s=a(I=>{let F=I.sources.map(h=>h.baseSource);return F&&F.length>0?F:I.predecessor?s(I.predecessor):[]},"determinePredecessorSources"),c=l?[t instanceof re?t.baseSource:t]:s(t),r=l?t:null,o=l?null:t;if(this.pendingMatchSetup){let I=this.pendingMatchSetup,F=new v;this.pendingMatchSetup=F.corePromise,yield I,this.pendingMatchSetup==F.corePromise&&(this.pendingMatchSetup=null),F.resolve()}l&&r.path.on("invalidated",()=>{this.dropSourcesWithIds([r.identifier])});let d=new v,u=c.map(I=>{let F={source:I,matchPromise:d,preserve:!0};return this._sourceSelector.push(F),F}),B=u.map(I=>I.matchPromise);if(l){let I=this.potentialMatchers.filter(F=>F.mayAddContact());if(I.forEach(F=>{F.addContact(r),F.promise.then(this.matcherSelectionFilter(F,B))}),I.length>0){let F=this.stateToken,h=new v;this.pendingMatchSetup=h.corePromise,yield ge(0),yield ge(0),this.pendingMatchSetup==h.corePromise&&(this.pendingMatchSetup=null),h.resolve();let y=this.stateToken;if(F!=y){let x=r.currentSample;r.stateToken=y,x.stateToken=y,x.item=t.currentRecognizerConfig.itemIdentifier(x,null),r.baseItem=x.item}let Q=I.find(x=>x.result);if(Q&&Q.allSourceIds.includes(t.identifier))return d.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:d.corePromise}}}if(u.forEach(I=>{I.preserve=!1}),this.sustainMode&&r)return d.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:d.corePromise,sustainModeWithoutMatch:!0};let b=n.map(I=>{try{return new Wt(I,r||o)}catch(F){return console.error(F),null}}).filter(I=>!!I);b=b.filter(I=>!I.result||I.result.matched!==!1);for(let I of b)I.promise.then(this.matcherSelectionFilter(I,B));return b.length>0?this.potentialMatchers=this.potentialMatchers.concat(b):d.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),this.potentialMatchers.sort((I,F)=>F.model.resolutionPriority-I.model.resolutionPriority),this.resetSourceHooks(),{selectionPromise:d.corePromise}})}resetSourceHooks(){let t=a(n=>{let l=n;l.path.off("step",this.attemptSynchronousUpdate),l.path.off("complete",this.attemptSynchronousUpdate),l.path.off("invalidated",this.attemptSynchronousUpdate),l.path.on("step",this.attemptSynchronousUpdate),l.path.on("complete",this.attemptSynchronousUpdate),l.path.on("invalidated",this.attemptSynchronousUpdate)},"resetHooks");this._sourceSelector.forEach(n=>t(n.source))}dropSourcesWithIds(t){for(let n of t){let l=this._sourceSelector.findIndex(s=>s.source.identifier==n);l>-1&&this._sourceSelector.splice(l,1)[0].matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"none",item:null}}})}}matchersForSource(t){return this.potentialMatchers.filter(n=>!!n.sources.find(l=>l.identifier==t.identifier))}matcherSelectionFilter(t,n){return l=>R(this,null,function*(){t.isCancelled?l={matched:!1,action:{type:"none",item:null}}:t.finalizeSources();let c=t.allSourceIds.map(o=>this._sourceSelector.find(d=>d.source.identifier==o)).filter(o=>!!o),r=this.potentialMatchers.indexOf(t);if(r!=-1){if(this.potentialMatchers.splice(r,1),l.action.type=="none"){this.finalizeMatcherlessTrackers(c);return}if(l.matched)for(let o of c){let d=this.matchersForSource(o.source);this.potentialMatchers=this.potentialMatchers.filter(u=>!d.find(B=>u==B)),d.forEach(u=>{u.cancel()}),this._sourceSelector=this._sourceSelector.filter(u=>!c.find(B=>u==B)),o.matchPromise.resolve({matcher:t,result:l})}else{let o=a(d=>{if(this.sustainMode&&!d.sustainWhenNested){this.finalizeMatcherlessTrackers(c);return}let u=new Wt(d,t);if(u.result&&u.result.matched==!1){this.finalizeMatcherlessTrackers(c);return}u.promise.then(this.matcherSelectionFilter(u,c.map(B=>B.matchPromise))),this.potentialMatchers.push(u),this.resetSourceHooks()},"replacer");this.emit("rejectionwithaction",{matcher:t,result:l},o);return}}})}finalizeMatcherlessTrackers(t){let n=t.map(l=>({tracker:l,pendingCount:this.potentialMatchers.filter(s=>!!s.allSourceIds.find(c=>l.source.identifier==c)).length}));for(let l of n)l.pendingCount==0&&!l.tracker.preserve&&l.tracker.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}})}};a(Ac,"MatcherSelector");var dt=Ac;var vc=class vc{constructor(i,t){var s,c;let{matcher:n,result:l}=i;this.gestureSetId=t,this.matchedId=n==null?void 0:n.model.id,this.linkType=l.action.type,this.item=l.action.item,this.sources=n==null?void 0:n.sources,(s=this.sources)==null||s.forEach(r=>r.disconnect()),(c=this.sources)==null||c.sort((r,o)=>(n==null?void 0:n.primaryPath)==r?-1:(n==null?void 0:n.primaryPath)==o?1:0),this.allSourceIds=(n==null?void 0:n.allSourceIds)||[]}};a(vc,"GestureStageReport");var tn=vc,Hc=class Hc extends S.default{constructor(t,n,l,s){super();this.markedComplete=!1;this.selectionHandler=a(t=>R(this,null,function*(){var u,B,b,I,F,h,y,Q,x,U;let n=((u=this.pushedSelector)==null?void 0:u.baseGestureSetId)||((B=this.selector)==null?void 0:B.baseGestureSetId),l=new tn(t,n);t.matcher&&this.stageReports.push(l);let s=(b=t.matcher)!=null?b:this.stageReports[this.stageReports.length-1],c=(I=s==null?void 0:s.sources.map(p=>p instanceof re?p.baseSource:p))!=null?I:[],r=t.result.action.type;if((r=="complete"||r=="none")&&(c.forEach(p=>{p.isPathComplete||p.terminate(r=="none")}),!t.result.matched)){this.markedComplete||(this.markedComplete=!0,this.emit("complete"));return}if(r=="complete"&&this.touchpointCoordinator&&this.pushedSelector){let V=((F=this.touchpointCoordinator)==null?void 0:F.sustainSelectorSubstack(this.pushedSelector)).map(f=>{let H=new v;return f.path.on("invalidated",()=>H.resolve()),f.path.on("complete",()=>H.resolve()),H.corePromise});V.length>0&&t.result.action.awaitNested&&(yield Promise.all(V),yield ge(0)),(h=this.touchpointCoordinator)==null||h.popSelector(this.pushedSelector),this.pushedSelector=null}this.emit("stage",l,p=>{p.type=="pop"?c.forEach(V=>V.popRecognizerConfig()):c.forEach(V=>V.pushRecognizerConfig(p.config))});let o=!1;this.touchpointCoordinator&&(o=!this.touchpointCoordinator.selectorStackIncludes(this.selector));let d=Rc(t.result.action,this.gestureConfig,this.baseGestureSetId);if(o&&(d=d.filter(p=>p.sustainWhenNested)),d.length>0){if(!(r=="chain"&&t.result.action.selectionMode==((y=this.pushedSelector)==null?void 0:y.baseGestureSetId))){if(this.pushedSelector&&(this.pushedSelector.off("rejectionwithaction",this.modelResetHandler),(Q=this.touchpointCoordinator)==null||Q.popSelector(this.pushedSelector),this.pushedSelector=null),r=="chain"){let f=t.result.action.selectionMode;if(f){let H=new dt(f);H.on("rejectionwithaction",this.modelResetHandler),this.pushedSelector=H,(x=this.touchpointCoordinator)==null||x.pushSelector(H)}}}((U=this.pushedSelector)!=null?U:this.selector).matchGesture(t.matcher,d).then(f=>R(this,null,function*(){return this.selectionHandler(yield f.selectionPromise)}))}else this.markedComplete||(this.markedComplete=!0,this.emit("complete"))}),"selectionHandler");this.modelResetHandler=a((t,n)=>{let l=t.matcher.allSourceIds;if(!this.allSourceIds.find(s=>l.indexOf(s)==-1))if(t.result.action.type=="replace")n(St(this.gestureConfig,t.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.stageReports=[],this.selector=l,this.selector.on("rejectionwithaction",this.modelResetHandler),this.once("complete",()=>{var c;this.pushedSelector&&((c=this.touchpointCoordinator)==null||c.popSelector(this.pushedSelector),this.pushedSelector=null),this.selector.off("rejectionwithaction",this.modelResetHandler),this.selector.dropSourcesWithIds(this.allSourceIds),this.selector=null}),this.gestureConfig=n,this.touchpointCoordinator=s,Promise.resolve().then(()=>this.selectionHandler(t))}get allSourceIds(){var t,n;return(n=(t=this.stageReports[this.stageReports.length-1])==null?void 0:t.allSourceIds)!=null?n:[]}get baseGestureSetId(){var t,n;return(n=(t=this.selector)==null?void 0:t.baseGestureSetId)!=null?n:null}get potentialModelMatchIds(){if(!this.selector)return[];let t=[this.selector];return this.pushedSelector&&t.push(this.pushedSelector),this.stageReports[this.stageReports.length-1].sources.map(c=>t.map(r=>r.potentialMatchersForSource(c).map(o=>o.model.id))).reduce((c,r)=>c.concat(r)).reduce((c,r)=>{for(let o of r)c.indexOf(o)==-1&&c.push(o);return c},[])}cancel(){this.stageReports[this.stageReports.length-1].sources.forEach(n=>n.baseSource.isPathComplete||n.baseSource.terminate(!0)),this.markedComplete||(this.markedComplete=!0,this.emit("complete"))}toJSON(){return this.stageReports}};a(Hc,"GestureSequence");var gi=Hc;function Rc(g,i,t){switch(g.type){case"none":case"complete":return[];case"replace":return[St(i,g.replace)];case"chain":return[St(i,g.next)];default:throw new Error("Unexpected case arose within `processGestureAction` method")}}a(Rc,"modelSetForAction");var fc=class fc extends S.default{constructor(t,n,l){super();this.selectorStack=[new dt];this._activeSources=[];this._activeGestures=[];this._history=[];this.modelResetHandler=a((t,n)=>{let l=t.matcher.allSourceIds;if(!this.activeGestures.find(s=>s.allSourceIds.find(c=>l.indexOf(c)!=-1)))if(t.result.action.type=="replace")n(St(this.gestureModelDefinitions,t.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.onNewTrackedPath=a(t=>R(this,null,function*(){this.addSimpleSourceHooks(t);let n=this.gestureModelDefinitions,l,s;do{l=this.currentSelector;let b=yield l.matchGesture(t,Gc(n,l.baseGestureSetId));if(b.sustainModeWithoutMatch){let I=a(F=>{F.stateToken=this.stateToken,F.item=t.currentRecognizerConfig.itemIdentifier(F,null)},"correctSample");t.path instanceof gt&&t.path.coords.forEach(I),t.stateToken=this.stateToken,t.baseItem=t.path.stats.initialSample.item,I(t.path.stats.initialSample),I(t.path.stats.lastSample);continue}else{s=b.selectionPromise;break}}while(l!=this.currentSelector);let c=this.currentSelector;t.setGestureMatchInspector(this.buildGestureMatchInspector(c));let r=a(()=>{this.recordHistory(t)},"preGestureScribe");try{t.path.on("invalidated",r),this.emit("inputstart",t)}catch(B){He("Error from 'inputstart' event listener",B)}this.inputEngines.forEach(B=>{B.fulfillInputStart(t)});let o=yield s;if(!o||o.result.matched==!1)return;let d=o.matcher.allSourceIds;for(let B of this._activeGestures)if(B.allSourceIds.find(b=>!!d.find(I=>b==I)))return;let u=new gi(o,n,this.currentSelector,this);this._activeGestures.push(u),u.on("complete",()=>{let B=this._activeGestures.indexOf(u);B!=-1&&this._activeGestures.splice(B,1)}),t.path.wasCancelled||(t.path.off("invalidated",r),u.on("complete",()=>this.recordHistory(u))),this.emit("recognizedgesture",u)}),"onNewTrackedPath");if(this.historyMax=l>0?l:0,this.gestureModelDefinitions=t,this.inputEngines=[],n)for(let s of n)this.addEngine(s);this.selectorStack[0].on("rejectionwithaction",this.modelResetHandler)}pushSelector(t){this.selectorStack.push(t),t.on("rejectionwithaction",this.modelResetHandler)}sustainSelectorSubstack(t){if(!t)return[];let n=this.selectorStack.indexOf(t);if(n==-1)return[];if(this.selectorStack.length<=1)throw new Error("May not force the original, base gesture selector into sustain mode.");let l=[];for(let s=n;s<this.selectorStack.length;s++)t=this.selectorStack[s],l=l.concat(t.cascadeTermination());return l}popSelector(t){if(!t)return;let n=this.selectorStack.indexOf(t);if(n!=-1){if(this.selectorStack.length<=1)throw new Error("May not pop the original, base gesture selector.");for(;n<this.selectorStack.length;)t=this.selectorStack[n],t.off("rejectionwithaction",this.modelResetHandler),this.selectorStack.splice(n,1);this.currentSelector.stateToken=this.stateToken}}selectorStackIncludes(t){return this.selectorStack.includes(t)}get currentSelector(){return this.selectorStack[this.selectorStack.length-1]}buildGestureMatchInspector(t){return n=>{let l=this.selectorStack.indexOf(t);return this.selectorStack.slice(l).map(c=>c.potentialMatchersForSource(n).map(r=>r.model.id)).reduce((c,r)=>c.concat(r))}}addEngine(t){t.on("pointstart",this.onNewTrackedPath),this.inputEngines.push(t)}recordHistory(t){let n=this.historyMax;n>0&&(this._history.length==n&&this._history.shift(),this._history.push(t))}get activeGestures(){return[].concat(this._activeGestures)}get activeSources(){return[].concat(this.inputEngines.map(t=>t.activeSources).reduce((t,n)=>t.concat(n),[]))}get history(){return this._history}get historyJSON(){let t=a(function(n,l){return n=="item"?l==null?void 0:l.id:l},"sanitizingReplacer");return JSON.stringify(this.history,t,2)}get stateToken(){return this._stateToken}set stateToken(t){this._stateToken=t,this.inputEngines.forEach(n=>n.stateToken=t),this.currentSelector.stateToken=t}addSimpleSourceHooks(t){t.path.on("invalidated",()=>{let n=this.activeGestures.find(s=>s.allSourceIds.includes(t.identifier));n&&n.cancel();let l=this._activeSources.indexOf(t);this._activeSources=this._activeSources.splice(l,1)}),t.path.on("complete",()=>{let n=this._activeSources.indexOf(t);this._activeSources=this._activeSources.splice(n,1)})}};a(fc,"TouchpointCoordinator");var yl=fc;var ml={};Vi(ml,{EMPTY_GESTURE_DEFS:()=>pc,getGestureModel:()=>St,getGestureModelSet:()=>Gc});var Lc=class Lc extends yl{constructor(t,n){let l=dl(n);t=t||pc;super(t,null,l.historyLength);this.config=l,this.mouseEngine=new hl(this.config),this.touchEngine=new Fl(this.config),this.mouseEngine.registerEventHandlers(),this.touchEngine.registerEventHandlers(),this.addEngine(this.mouseEngine),this.addEngine(this.touchEngine)}destroy(){this.activeGestures.forEach(t=>t.cancel()),this.activeSources.forEach(t=>t.terminate(!0)),this.mouseEngine.unregisterEventHandlers(),this.touchEngine.unregisterEventHandlers(),this.mouseEngine=null,this.touchEngine=null}};a(Lc,"GestureRecognizer");var At=Lc;var Jc={};Vi(Jc,{matchers:()=>Gl,specs:()=>ml});var Gl={};Vi(Gl,{GestureMatcher:()=>Wt,GestureSequence:()=>gi,GestureStageReport:()=>tn,MatcherSelector:()=>dt,PathMatcher:()=>ai,modelSetForAction:()=>Rc});function pl(g,i){let t=new Map;return i.keys.forEach(n=>{let l=Math.abs(g.x-n.centerX),s=Math.abs(g.y-n.centerY),c,r;l>.5*n.width?(c=l-.5*n.width,l=.5):(c=0,l/=n.width),s>.5*n.height?(r=s-.5*n.height,s=.5):(r=0,s/=n.height),c*=i.kbdScaleRatio,c+=l*n.height,r+=s*n.height;let o=c*c+r*r;t.set(n.keySpec,o)}),t}a(pl,"keyTouchDistances");function ut(g){var l;let i=new Map,t=0;Array.isArray(g)||(g=[g]);for(let s of g)for(let c of s.keys()){let r=1/(Math.pow(s.get(c),2)+3e-5);t+=r,i.set(c,(l=i.get(c))!=null?l:0+r)}let n=[];for(let s of i.keys())n.push({keySpec:s,p:i.get(s)/t});return n.sort(function(s,c){return c.p-s.p})}a(ut,"distributionFromDistanceMaps");var kc=["n","ne","e","se","s","sw","w","nw"],Ao=Math.PI,Nc=(()=>{let g=new Map,i=Ao/4;for(let t=0;t<kc.length;t++)g.set(kc[t],[i*t,1]);return g})();function Cl(g){return Math.PI/4*kc.indexOf(g)}a(Cl,"lockedAngleForDir");function ln(g,i){let t=Cl(i),n=g.initialSample,l=g.lastSample.targetX-n.targetX,s=g.lastSample.targetY-n.targetY,c=Math.max(0,-s*Math.cos(t));return Math.max(0,l*Math.sin(t))+c}a(ln,"calcLockedDistance");function Aa(g,i,t,n){return l=>{let s=Cl(i),c=n.flick.triggerDist-n.flick.dirLockDist,r=Math.max(0,ln(g.path.stats,i)-n.flick.dirLockDist),d=Math.min(1,.7*r/c),u=Math.sin(s)*d,B=-Math.cos(s)*d;t==null||t.scrollFlickPreview(u,B)}}a(Aa,"buildFlickScroller");var Ql=Math.PI/3,Yc=class Yc{constructor(i,t,n,l,s,c){this.directlyEmitsKeys=!0;this.sequence=i,this.gestureParams=s,this.baseSpec=l.key.spec,this.baseKeyDistances=n.getSimpleTapCorrectionDistances(i.stageReports[0].sources[0].path.stats.initialSample,this.baseSpec);let r=i.stageReports[0].sources[0].baseSource,o=r;i.on("complete",()=>{c==null||c.cancel()}),this.sequence.on("stage",u=>{var F;let B=o.path.stats;this.computedFlickDistribution=this.flickDistribution(B,!0);let b=this.computedFlickDistribution[0].keySpec;if(u.matchedId=="flick-restart"){o.path.replaceInitialSample(u.sources[0].path.stats.initialSample);return}if(u.matchedId=="flick-reset-centering"){o=r.constructSubview(!0,!0);return}else if(u.matchedId=="flick-reset-end"){this.emitKey(n,this.baseSpec,o.path.stats);return}else if(u.matchedId=="flick-reset"){this.flickScroller&&(this.flickScroller(o.currentSample),o.path.off("step",this.flickScroller)),this.lockedDir=null,this.lockedSelectable=null,o instanceof re&&o.disconnect();return}else if(u.matchedId=="flick-mid"){if(b==this.baseSpec)return;let h=Object.keys(this.baseSpec.flick).find(y=>this.baseSpec.flick[y]==b);this.lockedDir=h,this.lockedSelectable=b,this.flickScroller&&o.path.off("step",this.flickScroller),this.flickScroller=Aa(o,h,c,this.gestureParams),this.flickScroller(o.currentSample),o.path.on("step",this.flickScroller);return}let I=(F=this.lockedSelectable)!=null?F:b;this.emitKey(n,I,B)});let d=this.buildPopupRecognitionConfig(n);t({type:"push",config:d})}emitKey(i,t,n){let l;ln(n,this.lockedDir)>this.gestureParams.flick.triggerDist?l=i.keyEventFromSpec(t):l=i.keyEventFromSpec(this.baseSpec),l.keyDistribution=this.currentStageKeyDistribution(this.baseKeyDistances),i.raiseKeyEvent(l,null)}buildPopupRecognitionConfig(i){let t={getBoundingClientRect(){let n=Number.MAX_SAFE_INTEGER;return new DOMRect(-n,-n,2*n,2*n)}};return A(G({},i.gestureEngine.config),{maxRoamingBounds:t,safeBounds:t})}cancel(){}flickDistribution(i,t){let n=this.baseSpec.flick,l=[{spec:this.baseSpec,coord:[NaN,0]}];l=l.concat(Object.keys(n).map(b=>({spec:n[b],coord:Nc.get(b)})));let s=i.angle,c=this.gestureParams.flick.triggerDist,o=Math.min(c,t?c:i.netDistance)/c,d=0,u=l.map(b=>{let I=0,F=b.coord;if(!isNaN(F[0])){let x=s-F[0],U=2*Ao+F[0]-s;I=Math.min(x*x,U*U)}let h=Ql*(F[1]-o),y=h*h,Q=1/(I+y+1e-6);return d+=Q,{keySpec:b.spec,p:Q}}),B=1/d;return u.forEach(b=>b.p*=B),u.sort((b,I)=>I.p-b.p)}currentStageKeyDistribution(i){let t=this.baseSpec,n=this.baseKeyDistances,l=this.computedFlickDistribution;if(!n.get(t))return[{keySpec:l[0].keySpec,p:1}];let c=l.findIndex(d=>d.keySpec==t),r=l.splice(c,1)[0].p,o=ut(n);return l.concat(o.map(d=>({keySpec:d.keySpec,p:d.p*r})))}};a(Yc,"Flick");var nn=Yc;var Ul=Fa.TouchLayoutKeySp,sn={longpress:{flickDistStart:8,flickDistFinal:40,waitLength:500,noiseTolerance:10},multitap:{waitLength:300,holdLength:150},flick:{startDist:10,dirLockDist:25,triggerDist:40}};function Ro(g){let i=g.getBoundingClientRect();return{clientX:i.left+i.width/2,clientY:i.top+i.height/2}}a(Ro,"getKeyCentroid");function vo(g){let i=Ro(g);return t=>{let n=t.lastSample.clientX-i.clientX,l=t.lastSample.clientY-i.clientY;return Math.sqrt(n*n+l*l)}}a(vo,"buildDistFromKeyCentroidFunctor");function cn(g){let i=g.key.spec;if(i.sk)return!1;let t=["K_SHIFT","K_ALT","K_CTRL","K_NUMERALS","K_SYMBOLS","K_CURRENCIES"];for(let n of t)if(i.id==n)return!0;if(i.nextlayer)switch(i.sp){case Ul.special:case Ul.specialActive:case Ul.customSpecial:case Ul.customSpecialActive:return!0;default:return!1}else return!1}a(cn,"keySupportsModipress");function Ec(g,i){let t=a((h,y)=>{if(!h)return!1;let Q=h.key.spec;switch(y){case"modipress-start":return cn(h);case"special-key-start":return["K_LOPT","K_ROPT","K_BKSP"].indexOf(Q.baseKeyID)!=-1;case"longpress":return!0;case"multitap-start":case"modipress-multitap-start":return g.hasMultitaps?!!Q.multitap:!1;case"flick-start":return!!Q.flick;default:return!0}},"gestureKeyFilter"),n=i;n.longpress.permitsFlick=h=>{let y=h==null?void 0:h.key.spec.flick;return!y||!(y.n||y.nw||y.ne)};let l=n.roamingEnabled=!g.hasFlicks,s=oe(l?ja(n):No(n)),c=oe(l?wc(n):Yo(n)),r=u(oe(Jo(n,!0,l)),0),o=u(Oa(n),0),d=u(ig(n),0);Object.defineProperty(r.contacts[0].model.timer,"duration",{get:()=>n.longpress.waitLength}),Object.defineProperty(o.sustainTimer,"duration",{get:()=>n.multitap.waitLength}),Object.defineProperty(d.sustainTimer,"duration",{get:()=>n.multitap.waitLength});function u(h,y){h=oe(h);let Q=h.id;return typeof y=="number"&&(y=[y]),h.contacts.forEach((x,U)=>{var p;if(y.indexOf(U)!=-1){let V=(p=x.model.allowsInitialState)!=null?p:()=>!0;x.model=A(G({},x.model),{allowsInitialState:(f,H,w)=>t(w,Q)&&V(f,H,w)})}}),h}a(u,"withKeySpecFiltering");let B=ka(),b=qa(),I=[r,o,Pa(n),s,c,u(B,0),Na(n),_a(),u(b,0),$a(n),tg(),eg(),d,ng(n),lg()],F=[r.id,s.id,b.id,B.id];return l?(I.push(u(Ya(n),0)),I.push(Ea())):(I.push(u(ko(n),0)),I.push(wa(n)),I.push(Ma(n)),I.push(Ka(n)),I.push(Ta(n)),I.push(za()),I.push(Da(n)),F.push("flick-start")),{gestures:I,sets:{default:F,modipress:F.filter(h=>h!=b.id),none:[]}}}a(Ec,"gestureSetForLayout");function Tc(){return{itemPriority:0,pathResolutionAction:"reject",pathModel:{evaluate:g=>"resolve"}}}a(Tc,"instantContactRejectionModel");function ze(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:g=>"resolve"}}}a(ze,"instantContactResolutionModel");function Ra(g){let i=g.flick;return{itemPriority:1,pathModel:{evaluate:(t,n,l)=>{let s=t.stats,c=l==null?void 0:l.key.spec;if(c&&c.sk){let r=c.flick;if(!(r.nw||r.n||r.ne)){let d=s.netDistance,u=s.angle;if(d*Math.cos(u)>g.longpress.flickDistStart)return"reject"}}return s.netDistance>i.startDist?"resolve":null}},pathResolutionAction:"resolve",pathInheritance:"partial"}}a(Ra,"flickStartContactModel");function Ho(g,i){let t=i.key.spec.flick,n=Object.keys(t),l,s=0;for(let c of n){let r=ln(g,c);r>s&&(s=r,l=c)}return{dir:l,dist:s}}a(Ho,"determineLockFromStats");function va(g){return{itemPriority:1,pathModel:{evaluate:(i,t,n)=>{let{dir:l,dist:s}=Ho(i.stats,n);if(s>g.flick.dirLockDist){let c=i.stats.angle,r=Cl(l),o=Math.abs(c-r),d=Math.abs(2*Math.PI+r-c);if(o<=Ql||d<=Ql)return"resolve"}else if(i.isComplete)return"reject"}},pathResolutionAction:"resolve",pathInheritance:"full"}}a(va,"flickMidContactModel");function Ha(g){return{itemPriority:1,pathModel:{evaluate:(i,t,n,l)=>{if(i.isComplete)return"resolve";{let{dir:s}=Ho(l,n);if(ln(i.stats,s)<g.flick.dirLockDist)return"reject"}}},pathResolutionAction:"resolve",pathInheritance:"full"}}a(Ha,"flickEndContactModel");function fa(g,i,t){let n=g.longpress;return{itemPriority:0,pathResolutionAction:"resolve",timer:{get duration(){return n.waitLength},expectedResult:!0},validateItem:(l,s)=>!!(s!=null&&s.key.spec.sk),pathModel:{evaluate:l=>{var c;let s=l.stats;if(i&&n.permitsFlick(s.lastSample.item)&&((c=s.cardinalDirection)==null?void 0:c.indexOf("n"))!=-1){let r=s.netDistance,o=s.angle;if(r*Math.cos(o)>n.flickDistFinal)return"resolve"}else if(t){if(s.rawDistance>n.noiseTolerance||s.lastSample.item!=s.initialSample.item)return"reject"}else if(s.lastSample.item!=s.initialSample.item)return"reject";return l.isComplete?"reject":null}}}}a(fa,"longpressContactModel");function fo(){return{itemPriority:-1,pathResolutionAction:"resolve",pathModel:{evaluate:g=>"resolve"}}}a(fo,"modipressContactStartModel");function La(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:g=>{if(g.isComplete)return"reject"}}}}a(La,"modipressContactHoldModel");function Lo(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:g=>{if(g.isComplete)return"resolve"}}}}a(Lo,"modipressContactEndModel");function xl(g,i){var n;let t=(n=g==null?void 0:g.roamingEnabled)!=null?n:!0;return{itemPriority:0,itemChangeAction:t?"reject":void 0,pathResolutionAction:"resolve",pathInheritance:!t&&i?"full":"chop",pathModel:{evaluate:l=>{if(l.isComplete&&!l.wasCancelled)return"resolve"}}}}a(xl,"simpleTapContactModel");function Ja(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:g=>{if(g.isComplete&&!g.wasCancelled)return"resolve"}}}}a(Ja,"subkeySelectContactModel");function ka(){return{id:"special-key-start",resolutionPriority:0,contacts:[{model:G({},ze()),endOnResolve:!1}],resolutionAction:{type:"chain",next:"special-key-end",item:"current"}}}a(ka,"specialKeyStartModel");function Na(g){return{id:"special-key-end",resolutionPriority:0,contacts:[{model:A(G({},xl(g)),{itemChangeAction:"resolve"}),endOnResolve:!0}],resolutionAction:{type:"complete",item:"none"}}}a(Na,"specialKeyEndModel");function Jo(g,i,t){let n={id:"longpress",resolutionPriority:4,contacts:[{model:A(G({},fa(g,i,t)),{itemPriority:1,pathInheritance:"chop"}),endOnResolve:!1},{model:Tc(),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"subkey-select",selectionMode:"none",item:"none"}};return t?A(G({},n),{rejectionActions:{path:{type:"replace",replace:"longpress-roam"},timer:{type:"replace",replace:"longpress-roam-restore"}}}):n}a(Jo,"longpressModel");function Ya(g){let i=Jo(g,!1,!0);return A(G({},i),{id:"longpress-roam"})}a(Ya,"longpressModelAfterRoaming");function Ea(){return{id:"longpress-roam-restore",contacts:[{model:{pathModel:{evaluate:g=>null},itemChangeAction:"reject",pathInheritance:"full",pathResolutionAction:"reject",itemPriority:0}}],resolutionPriority:-1,rejectionActions:{item:{type:"replace",replace:"longpress-roam"}},resolutionAction:{type:"chain",next:"longpress-roam"}}}a(Ea,"longpressRoamRestoration");function ko(g){return{id:"flick-start",resolutionPriority:3,contacts:[{model:Ra(g)}],resolutionAction:{type:"chain",item:"none",next:"flick-mid"}}}a(ko,"flickStartModel");function Ta(g){let i=ko(g);return A(G({},i),{contacts:[A(G({},i.contacts[0]),{model:A(G({},i.contacts[0].model),{baseCoordReplacer:(t,n)=>{let l=Ro(n),s=vo(n),c=t.initialSample,r=s(t);if(r>g.flick.triggerDist)return l;let o=g.flick.dirLockDist;if(r<o)return c;let d=o/r,u=c.clientX-l.clientX,B=c.clientY-l.clientY;return{clientX:l.clientX+u*d,clientY:l.clientY+B*d}}})})],id:"flick-restart",sustainWhenNested:!0,rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}}})}a(Ta,"flickRestartModel");function wa(g){return{id:"flick-mid",resolutionPriority:0,contacts:[{model:va(g),endOnReject:!0},{model:Tc(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}},resolutionAction:{type:"chain",item:"none",next:"flick-end"},sustainWhenNested:!0}}a(wa,"flickMidModel");function Ma(g){return{id:"flick-reset",resolutionPriority:1,contacts:[{model:A(G({},ze()),{pathInheritance:"partial"})}],resolutionAction:{type:"chain",next:"flick-reset-centering"},sustainWhenNested:!0}}a(Ma,"flickResetModel");function Ka(g){return{id:"flick-reset-centering",resolutionPriority:1,contacts:[{model:{pathModel:{evaluate(i,t,n){t||(t=i.stats);let l=vo(n),s=l(i.stats);if(l(t)<s)return"resolve"}},itemPriority:0,pathResolutionAction:"resolve",pathInheritance:"full"}}],resolutionAction:{type:"chain",next:"flick-restart"},sustainWhenNested:!0}}a(Ka,"flickResetCenteringModel");function za(){return{id:"flick-reset-end",resolutionPriority:1,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"complete",item:"base"},sustainWhenNested:!0}}a(za,"flickResetEndModel");function Da(g){return{id:"flick-end",resolutionPriority:0,contacts:[{model:Ha(g)},{model:ze(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset"}},resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}a(Da,"flickEndModel");function Oa(g){return{id:"multitap-start",resolutionPriority:2,contacts:[{model:A(G({},ze()),{itemPriority:1,pathInheritance:"reject",allowsInitialState(i,t,n){return i.item==n}})}],sustainTimer:{duration:g.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"multitap-end",item:"current"}}}a(Oa,"multitapStartModel");function Pa(g){return{id:"multitap-end",resolutionPriority:2,contacts:[{model:A(G({},xl(g)),{itemPriority:1,timer:{duration:g.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:ze(),resetOnInstantFulfill:!0}],rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"none"}}}a(Pa,"multitapEndModel");function No(g){return{id:"initial-tap",resolutionPriority:1,contacts:[{model:A(G({},xl(g)),{pathInheritance:"chop",itemPriority:1,timer:{duration:g.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:ze(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"base"}}}a(No,"initialTapModel");function Yo(g){return{id:"simple-tap",resolutionPriority:1,contacts:[{model:A(G({},xl(g,!0)),{itemPriority:1}),endOnResolve:!0},{model:ze(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,resolutionAction:{type:"complete",item:"base"}}}a(Yo,"simpleTapModel");function ja(g){let i=No(g);return A(G({},i),{rejectionActions:A(G({},i.rejectionActions),{item:{type:"replace",replace:"initial-tap"}})})}a(ja,"initialTapModelWithReset");function wc(g){let i=Yo(g);return A(G({},i),{rejectionActions:A(G({},i.rejectionActions),{item:{type:"replace",replace:"simple-tap"}})})}a(wc,"simpleTapModelWithReset");function _a(){return{id:"subkey-select",resolutionPriority:0,contacts:[{model:A(G({},Ja()),{pathInheritance:"full",itemPriority:1}),endOnResolve:!0,endOnReject:!0}],resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}a(_a,"subkeySelectModel");function qa(){return{id:"modipress-start",resolutionPriority:5,contacts:[{model:A(G({},fo()),{allowsInitialState(g,i,t){return cn(t)},itemChangeAction:"reject",itemPriority:1})}],resolutionAction:{type:"chain",next:"modipress-hold",selectionMode:"modipress",item:"current"}}}a(qa,"modipressStartModel");function $a(g){return{id:"modipress-hold",resolutionPriority:5,contacts:[{model:A(G({},La()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:g.multitap.holdLength,expectedResult:!0,inheritElapsed:!0}})},{model:G({},ze()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"},rejectionActions:{path:{type:"replace",replace:"modipress-end-multitap-transition"}}}}a($a,"modipressHoldModel");function eg(){return{id:"modipress-end-multitap-transition",resolutionPriority:5,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"}}}a(eg,"modipressMultitapTransitionModel");function tg(){return{id:"modipress-end",resolutionPriority:5,contacts:[{model:A(G({},Lo()),{itemChangeAction:"reject",pathInheritance:"full"})}],resolutionAction:{type:"complete",item:"none",awaitNested:!0}}}a(tg,"modipressEndModel");function ig(g){return{id:"modipress-multitap-start",resolutionPriority:6,contacts:[{model:A(G({},fo()),{pathInheritance:"reject",allowsInitialState(i,t,n){return i.item!=n?!1:cn(n)},itemChangeAction:"reject",itemPriority:1})}],sustainTimer:{duration:g.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"modipress-multitap-end",selectionMode:"modipress",item:"current"}}}a(ig,"modipressMultitapStartModel");function ng(g){return{id:"modipress-multitap-end",resolutionPriority:5,contacts:[{model:A(G({},Lo()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:g.multitap.holdLength,expectedResult:!1}})},{model:G({},Tc()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"},rejectionActions:{timer:{type:"replace",replace:"modipress-multitap-lock-transition"},path:{type:"replace",replace:"modipress-multitap-lock-transition"}}}}a(ng,"modipressMultitapEndModel");function lg(){return{id:"modipress-multitap-lock-transition",resolutionPriority:5,contacts:[{model:A(G({},ze()),{pathResolutionAction:"resolve"})}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"}}}a(lg,"modipressMultitapLockModel");var Eo=A(G({},oe(wc(null))),{resolutionAction:{type:"complete",item:"current"}}),To={gestures:[Eo],sets:{default:[Eo.id]}};function Zl(g){var i;return typeof g=="string"?i=g:(i=g.style.fontSize,i||(i=getComputedStyle(g).fontSize)),new Z(i)}a(Zl,"getFontSizeStyle");function wo(g,i,t){if(g.touchable){let n=g.formFactor=="phone"?1.6*(t?.65:.6)*1.2:2;return Z.special(n,"em")}else return i?Z.inPixels(i/8):void 0}a(wo,"defaultFontSize");var rn;function Xl(g,i,t){t={fontFamily:t.fontFamily,fontSize:t.fontSize},t.fontFamily||(t.fontFamily=getComputedStyle(document.body).fontFamily),(!t.fontSize||t.fontSize=="")&&(t.fontSize="1em");let n=t.fontFamily,l=Zl(t.fontSize);var s;l.absolute?s=l.val+"px":s=l.val*i+"px",rn=rn!=null?rn:document.createElement("canvas");var c=rn.getContext("2d");c.font=s+" "+n;var r=c.measureText(g);return r}a(Xl,"getTextMetrics");var sg=10,Mc=class Mc{constructor(i,t){this.totalLength=0;this.baseCoord=i,this.curCoord=i,this.baseScrollLeft=t,this.totalLength=0}updateTo(i){let t=this.curCoord;this.curCoord=i;let n=this.baseCoord.targetX-this.curCoord.targetX+this.baseScrollLeft;return this.totalLength+=Math.abs(this.curCoord.targetX-t.targetX),n}get hasScrolled(){return this.totalLength>sg}};a(Mc,"BannerScrollState");var Vl=Mc;var Mo="kmw-suggest-touched",cg="kmw-suggest-banner-scroller",Ko=.666,zo="swallow-fade-transition",on=class on{constructor(i,t){this.index=i,this.rtl=t!=null?t:!1,this.constructRoot();let n=this.display=J("span");n.className="kmw-suggestion-text",this.container.appendChild(n)}get computedStyle(){return getComputedStyle(this.display)}constructRoot(){let i=this.div=J("div");i.className="kmw-suggest-option",i.id=on.BASE_ID+this.index,this.div.suggestion=this;let t=this.container=document.createElement("div");t.className="kmw-suggestion-container";let l=(100-Je.MARGIN*(Je.LONG_SUGGESTION_DISPLAY_LIMIT-1))/Je.LONG_SUGGESTION_DISPLAY_LIMIT;t.style.minWidth=l+"%",i.appendChild(t)}matchKeyboardProperties(i){let t=this.div;if(i){i.KLC&&(t.lang=i.KLC);let n=i.KFont;n&&n.family&&n.family!=""&&(t.style.fontFamily=n.family)}}get suggestion(){return this._suggestion}update(i,t){this._suggestion=i;let n=this.generateSuggestionText(this.rtl);if(this.container.replaceChild(n,this.display),this.display=n,t.minWidth!==void 0&&(this._minWidth=t.minWidth),this._paddingWidth=t.paddingWidth,this._collapsedWidth=t.collapsedWidth,i&&i.displayAs){let l=Xl(i.displayAs,t.emSize,t.styleForFont);this._textWidth=l.width}else this._textWidth=0;this.currentWidth=this.collapsedWidth,this.highlight(i==null?void 0:i.autoAccept),this.updateLayout()}updateLayout(){if(!this.suggestion&&this.index!=0){this.div.style.width="0px";return}else this.div.style.width="";let i=this.container.style;i.minWidth=this.collapsedWidth+"px",this.rtl?i.marginRight=this.collapsedWidth-this.expandedWidth+"px":i.marginLeft=this.collapsedWidth-this.expandedWidth+"px",this.updateFade()}updateFade(){this.div.classList.add(zo),window.requestAnimationFrame(()=>{this.div.classList.remove(zo)}),this.div.classList.add(`kmw-hide-fade-${this.rtl?"left":"right"}`);let i=`kmw-hide-fade-${this.rtl?"right":"left"}`;this.expandedWidth-this.collapsedWidth?this.div.classList.remove(i):this.div.classList.add(i)}get targetCollapsedWidth(){return this._collapsedWidth}get textWidth(){return this._textWidth}get paddingWidth(){return this._paddingWidth}get minWidth(){return this._minWidth}set minWidth(i){this._minWidth=i}get expandedWidth(){return this.minWidth>this.spanWidth?this.minWidth:this.spanWidth}get spanWidth(){var t,n;let i=(t=this.textWidth)!=null?t:0;return i&&(i+=(n=this.paddingWidth)!=null?n:0),i}get collapsedWidth(){let i=this.spanWidth<this.targetCollapsedWidth?this.spanWidth:this.targetCollapsedWidth,t=i<this.expandedWidth?i:this.expandedWidth;return this.minWidth>t?this.minWidth:t}get currentWidth(){return this.div.offsetWidth}set currentWidth(i){i<this.collapsedWidth?i=this.collapsedWidth:i>this.expandedWidth&&(i=this.expandedWidth),this.rtl?this.container.style.marginRight=`${i-this.expandedWidth}px`:this.container.style.marginLeft=`${i-this.expandedWidth}px`}highlight(i){let t=this.div;i?t.classList.add(Mo):t.classList.remove(Mo)}isEmpty(){return!this._suggestion}generateSuggestionText(i){let t=this._suggestion;var n,l=J("span");if(l.className="kmw-suggestion-text",t==null)return l;if(t.displayAs==null||t.displayAs=="")n=" ";else{let s=i?8238:8237;n=String.fromCharCode(s)+t.displayAs}return l.innerHTML=n,l}};a(on,"BannerSuggestion"),on.BASE_ID="kmw-suggestion-";var Kc=on,O=class O extends ue{constructor(t,n){super(n||ue.DEFAULT_HEIGHT);this.type="suggestion";this.currentSuggestions=[];this.options=[];this.separators=[];this.isRTL=!1;this.onSuggestionUpdate=a(t=>{var b;this.currentSuggestions=t,(b=this.highlightAnimation)==null||b.cancel();let n=this.options[0].computedStyle,l={fontSize:n.fontSize,fontFamily:n.fontFamily},s=getComputedStyle(document.body).fontSize,c=Zl(s).val,r=getComputedStyle(this.options[0].container.firstChild),o=this.width/O.LONG_SUGGESTION_DISPLAY_LIMIT,d=new Z(r.paddingLeft||"4px"),u=new Z(r.paddingRight||"4px"),B={paddingWidth:d.val+u.val,emSize:c,styleForFont:l,collapsedWidth:o,minWidth:0};for(let I=0;I<O.SUGGESTION_LIMIT;I++){let F=this.options[I];if(t.length>I){let h=t[I];F.update(h,B)}else F.update(null,B)}this.refreshLayout()},"onSuggestionUpdate");this.refreshLayout=a(()=>{let t=[],n=0,l=Math.min(this.currentSuggestions.length,8);for(let s=0;s<l;s++){let c=this.options[s];c.minWidth=0,n+=c.collapsedWidth,c.collapsedWidth<c.expandedWidth&&t.push(c)}if(l=l||1,n<this.width){let s=this.width*.01*(l-1);for(;n<this.width&&t.length>0;){let r=(this.width-n-s)/t.length;t.sort((B,b)=>B.expandedWidth-b.expandedWidth);let o=t[0],d=o.expandedWidth-o.collapsedWidth,u=Math.min(d,r);u>0&&(t.forEach(B=>B.minWidth=B.collapsedWidth+u),n+=u*t.length),t.splice(0,1)}let c=(this.width-n-s)/l;for(let r=0;r<l;r++){let o=this.options[r];o.minWidth=o.collapsedWidth+c,o.updateLayout()}}for(let s=0;s<O.SUGGESTION_LIMIT-1;s++)this.separators[s].style.display=s<l-1?"":"none"},"refreshLayout");this.getDiv().className=this.getDiv().className+" "+O.BANNER_CLASS,this.container=document.createElement("div"),this.container.className=cg,this.getDiv().appendChild(this.container),this.buildInternals(!1),this.gestureEngine=this.setupInputHandling()}shutdown(){this.gestureEngine.destroy()}buildInternals(t){this.isRTL=t,this.options.length>0&&(this.options=[],this.separators=[]);for(var n=0;n<O.SUGGESTION_LIMIT;n++){let l=new Kc(n,t);this.options[n]=l}for(var n=0;n<O.SUGGESTION_LIMIT;n++){let s=t?O.SUGGESTION_LIMIT-n-1:n;if(this.container.appendChild(this.options[s].div),t&&(this.container.scrollLeft=this.container.scrollWidth),n!=O.SUGGESTION_LIMIT-1){let c=J("div");c.className="kmw-banner-separator";let r=c.style;r.marginLeft=`calc(${O.MARGIN/2}% - 0.5px)`,r.marginRight=`calc(${O.MARGIN/2}% - 0.5px)`,this.container.appendChild(c),this.separators[s-(t?1:0)]=c}}}setupInputHandling(){let t=new Be(this.getDiv(),[-Number.MAX_SAFE_INTEGER]);this.selectionBounds=new Be(this.getDiv(),[-Ko*this.height,-Number.MAX_SAFE_INTEGER]);let n={targetRoot:this.getDiv(),maxRoamingBounds:t,safeBounds:t,itemIdentifier:o=>{let d=this.selectionBounds.getBoundingClientRect();if(o.clientX<d.left||o.clientX>d.right||o.clientY<d.top||o.clientY>d.bottom)return null;let u=null,B=Number.MAX_VALUE;for(let b of this.options){let I=b.div.getBoundingClientRect();if(I.left<=o.clientX&&o.clientX<I.right)return b.suggestion?b:null;{let F=(o.clientX<I.left?-1:1)*(o.clientX-I.left);F<B&&(B=F,u=b)}}return u.suggestion?u:null}},l=new At(To,n),s={source:null,scrollingHandler:null,suggestion:null},c=a(o=>{o.highlight(!0),this.highlightAnimation&&(this.highlightAnimation.cancel(),this.highlightAnimation.decouple()),this.highlightAnimation=new Sl(this.container,o,!1),this.highlightAnimation.expand()},"markSelection"),r=a(o=>{o.highlight(!1),this.highlightAnimation||(this.highlightAnimation=new Sl(this.container,o,!1)),this.highlightAnimation.collapse()},"clearSelection");return l.on("inputstart",o=>{if(s.source){o.terminate(!0);return}let d=this._predictionContext.selected;this._predictionContext.selected=null,d&&this.options.forEach(b=>{b.suggestion==d&&b.highlight(!1)}),this.scrollState=new Vl(o.currentSample,this.container.scrollLeft);let u=o.baseItem;s.source=o,s.scrollingHandler=b=>{var h;let I=this.scrollState.updateTo(b);(h=this.highlightAnimation)==null||h.setBaseScroll(I);let F=b.item?u:null;F!=s.suggestion&&(s.suggestion&&r(s.suggestion),s.suggestion=F,F&&c(F))},s.suggestion=o.currentSample.item,s.suggestion&&c(s.suggestion);let B=a(()=>{let b=this.currentSuggestions;ge(0).then(()=>R(this,null,function*(){if(b==this.currentSuggestions&&(this._predictionContext.selected=d,d)){for(let I of this.options)if(I.suggestion==d){I.highlight(!0);break}}})),s.suggestion&&(r(s.suggestion),s.suggestion=null),s.source=null,s.scrollingHandler=null},"terminationHandler");o.path.on("complete",B),o.path.on("invalidated",B),o.path.on("step",s.scrollingHandler)}),l.on("recognizedgesture",o=>{o.once("stage",d=>{let u=d.item;u&&!this.scrollState.hasScrolled&&this.currentSuggestions.length>0&&(this.currentSuggestions=[],this.predictionContext.accept(u.suggestion).then(()=>{this.container.scrollLeft=this.isRTL?this.container.scrollWidth:0})),this.scrollState=null})}),l}update(){var n;let t=super.update();return(n=this.selectionBounds)==null||n.updatePadding([-Ko*this.height,-Number.MAX_SAFE_INTEGER]),t}configureForKeyboard(t,n){let l=t.isRTL;this.container.textContent="",this.buildInternals(l),this.options.forEach(s=>s.matchKeyboardProperties(n)),this.onSuggestionUpdate(this.currentSuggestions)}get predictionContext(){return this._predictionContext}set predictionContext(t){this._predictionContext&&this._predictionContext.off("update",this.onSuggestionUpdate),this._predictionContext=t,t&&(t.on("update",this.onSuggestionUpdate),this.onSuggestionUpdate(t.currentSuggestions))}};a(O,"SuggestionBanner"),O.SUGGESTION_LIMIT=8,O.LONG_SUGGESTION_DISPLAY_LIMIT=3,O.MARGIN=1;var Je=O,ye=class ye{constructor(i,t,n){this.setScrollOffset=a(()=>{if(!this.scrollContainer)return;let i=this.option.currentWidth-this.option.collapsedWidth,t=this.option.rtl,n=Math.max(this.rootScrollOffset-this.option.div.offsetLeft,0),l=Math.max(this.option.div.offsetLeft+this.option.collapsedWidth-(this.rootScrollOffset+this.scrollContainer.offsetWidth)),s=Math.max(t?l:n,0),c=Math.max(this.collapsedScrollOffset+(t?0:1)*i,0)+(t?0:-1)*s,r=Math.max(this.rootScrollOffset+(t?0:1)*i,0)+(t?0:-1)*s,o=t?Math.max(c,r):Math.min(c,r),d=Math.max(t?this.option.div.offsetLeft+this.option.currentWidth-(o+this.scrollContainer.offsetWidth):o-this.option.div.offsetLeft,0),u=Math.min(i,d),B=c+(t?1:-1)*u+(t?0:1)*s;if(this.scrollContainer.scrollLeft=B,this.pendingAnimation){let b=this.scrollContainer.scrollLeft-B;this.option.currentWidth+=b}},"setScrollOffset");this._expand=a(i=>{if(this.startTimestamp===void 0)return;let t=i-this.startTimestamp,n=t>ye.TRANSITION_TIME;n&&(t=ye.TRANSITION_TIME);let l=this.option.expandedWidth-this.option.collapsedWidth,s=t/ye.TRANSITION_TIME,c=l*s;this.option.currentWidth=c+this.option.collapsedWidth,n?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._expand),this.setScrollOffset()},"_expand");this._collapse=a(i=>{if(this.startTimestamp===void 0)return;let t=i-this.startTimestamp,n=t>ye.TRANSITION_TIME;n&&(t=ye.TRANSITION_TIME);let l=this.option.expandedWidth-this.option.collapsedWidth,s=1-t/ye.TRANSITION_TIME,c=l*s;this.option.currentWidth=c+this.option.collapsedWidth,n?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._collapse),this.setScrollOffset()},"_collapse");this.scrollContainer=i,this.option=t,this.collapsedScrollOffset=i.scrollLeft,this.rootScrollOffset=i.scrollLeft}setBaseScroll(i){this.collapsedScrollOffset=i,this.option.rtl?i>this.rootScrollOffset&&(this.rootScrollOffset=i):i<this.rootScrollOffset&&(this.rootScrollOffset=i),window.requestAnimationFrame(this.setScrollOffset)}decouple(){this.cancel(),this.scrollContainer=null}clear(){this.startTimestamp=null,window.cancelAnimationFrame(this.pendingAnimation),this.pendingAnimation=null}cancel(){this.clear(),this.option.currentWidth=this.option.collapsedWidth}expand(){this.clear(),this.startTimestamp=performance.now();let i=this.option.currentWidth-this.option.collapsedWidth,t=this.option.expandedWidth-this.option.collapsedWidth;i!=0&&(this.startTimestamp-=i/t*ye.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._expand)}collapse(){this.clear(),this.startTimestamp=performance.now();let i=this.option.expandedWidth-this.option.currentWidth,t=this.option.expandedWidth-this.option.collapsedWidth;i!=0&&(this.startTimestamp-=i/t*ye.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._collapse)}};a(ye,"SuggestionExpandContractAnimation"),ye.TRANSITION_TIME=250;var Sl=ye;var zc=class zc extends ue{constructor(t){super();this.type="html";let n=this.getDiv(),l=document.createElement("div");l.style.userSelect="none",l.style.height="100%",l.style.width="100%",n.appendChild(l),this.container=l.attachShadow?l.attachShadow({mode:"closed"}):l,this.container.innerHTML=t}get innerHTML(){return this.container.innerHTML}set innerHTML(t){this.container.innerHTML=t}};a(zc,"HTMLBanner");var Wl=zc;var Dc=class Dc{constructor(i,t,n){this.ImageBanner=ol;this.HTMLBanner=Wl;this.hostDevice=t,this.container=i,this.predictionContext=n,this.inactiveBanner=new ot}get inactiveBanner(){return this._inactiveBanner}set inactiveBanner(i){this._inactiveBanner=i!=null?i:new ot,this.container.banner instanceof Je||(this.container.banner=this._inactiveBanner)}activateBanner(i){let t=this.container.banner;if(t instanceof Je&&(t.predictionContext=null),!i)this.container.banner=this.inactiveBanner;else{let n=new Je(this.hostDevice,this.container.activeBannerHeight);n.predictionContext=this.predictionContext,this.container.banner=n}}selectBanner(i){this.activateBanner(i=="active"||i=="configured"),this.keyboard&&this.container.banner.configureForKeyboard(this.keyboard,this.keyboardStub)}configureForKeyboard(i,t){this.keyboard=i,this.keyboardStub=t,this.container.banner.configureForKeyboard(i,t)}shutdown(){this.container.banner instanceof Je&&(this.container.banner.predictionContext=null)}};a(Dc,"BannerController");var an=Dc;var Oc=class Oc{constructor(){let i=this.element=document.createElement("div");i.style.userSelect="none",i.className="kmw-osk-none"}postInsert(){}updateState(){}refreshLayout(){}get layoutHeight(){return Z.inPixels(0)}};a(Oc,"EmptyView");var Rt=Oc;var di=class di{constructor(i){this.kbd=i;var t=this.element=document.createElement("div");t.style.userSelect="none",t.className="kmw-osk-static",t.id=di.ID,t.innerHTML=i.helpText}postInsert(){if(!this.element.parentElement||!document.getElementById(di.ID))throw new Error("The HelpPage root element has not yet been inserted into the DOM.");this.kbd.hasScript&&this.kbd.embedScript(this.element.parentElement)}updateState(){}refreshLayout(){}get layoutHeight(){return Z.inPercent(100)}};a(di,"HelpPageView"),di.ID="kmw-osk-help-page";var gn=di;var jc=class jc{constructor(i,t,n){this.keySpec=n,this.centerX=n.proportionalX,this.centerY=t.proportionalY,this.width=n.proportionalWidth,this.height=i.rowProportionalHeight}};a(jc,"CorrectiveBaseKeyLayout");var Pc=jc;function rg(g){return g.baseKeyID?C.isFrameKey(g.baseKeyID)?!1:!g.isPadding:!1}a(rg,"correctionKeyFilter");function Do(g,i){return{keys:g.row.map(t=>t.key.map(n=>new Pc(g,t,n))).reduce((t,n)=>t.concat(n),[]).filter(t=>rg(t.keySpec)),kbdScaleRatio:i}}a(Do,"buildCorrectiveLayout");var og={"*Shift*":8,"*Enter*":5,"*Tab*":6,"*BkSp*":4,"*Menu*":11,"*Hide*":10,"*Alt*":25,"*Ctrl*":1,"*Caps*":3,"*ABC*":16,"*abc*":17,"*123*":19,"*Symbol*":21,"*Currency*":20,"*Shifted*":9,"*AltGr*":2,"*TabLeft*":7,"*LAlt*":86,"*RAlt*":87,"*LCtrl*":88,"*RCtrl*":89,"*LAltCtrl*":96,"*RAltCtrl*":97,"*LAltCtrlShift*":98,"*RAltCtrlShift*":99,"*AltShift*":100,"*CtrlShift*":101,"*AltCtrlShift*":102,"*LAltShift*":103,"*RAltShift*":104,"*LCtrlShift*":105,"*RCtrlShift*":112,"*LTREnter*":5,"*LTRBkSp*":4,"*RTLEnter*":113,"*RTLBkSp*":114,"*ShiftLock*":115,"*ShiftedLock*":116,"*ZWNJ*":117,"*ZWNJiOS*":117,"*ZWNJAndroid*":118,"*ZWNJGeneric*":121,"*Sp*":128,"*NBSp*":130,"*NarNBSp*":131,"*EnQ*":132,"*EmQ*":133,"*EnSp*":134,"*EmSp*":135,"*PunctSp*":140,"*ThSp*":141,"*HSp*":142,"*ZWSp*":129,"*ZWJ*":119,"*WJ*":120,"*CGJ*":122,"*LTRM*":144,"*RTLM*":145,"*SH*":161,"*HTab*":162},_c=og;var ag=["default","shift","shift-on","special","special-on","","","","deadkey","blank","hidden"],vt=ag;function Ht(g,i){switch(g){case"*ZWNJ*":g=i.device.OS==W.OperatingSystem.Android?"*ZWNJAndroid*":"*ZWNJiOS*";break;case"*Enter*":g=i.isRTL?"*RTLEnter*":"*LTREnter*";break;case"*BkSp*":g=i.isRTL?"*RTLBkSp*":"*LTRBkSp*";break;default:}let t=_c[g],n=57344+t;return t?String.fromCharCode(n):g}a(Ht,"renameSpecialKey");var De=class De{constructor(i,t){this.spec=i,this.layer=t}setButtonClass(){var l;let i=this.spec,t=this.btn;var n=0;typeof i.dk=="string"&&i.dk=="1"&&(n=8),n=(l=i.sp)!=null?l:n,(n<0||n>10)&&(n=0),t.className="kmw-key kmw-key-"+vt[n]}setToggleState(i){let t;switch(t=this.spec.sp,vt[t]){case"shift":case"shift-on":i===void 0&&(i=vt[t]=="shift"),this.spec.sp=1+(i?1:0);break;case"special":case"special-on":i===void 0&&(i=vt[t]=="special"),this.spec.sp=3+(i?1:0);break;default:return}this.setButtonClass()}isFrameKey(){let i=this.spec.sp||0;switch(vt[i]){case"default":case"deadkey":return!1;default:return!0}}allowsKeyTip(){return this.isFrameKey()?!1:!this.btn.classList.contains("kmw-spacebar")}highlight(i){var t=this.btn.classList;i?t.contains(De.HIGHLIGHT_CLASS)||t.add(De.HIGHLIGHT_CLASS):t.remove(De.HIGHLIGHT_CLASS)}getIdealFontSize(i,t,n){if(!this._fontFamily)return new Z("1em");n!=null||(n=1);let l=t.keyWidth,s=t.keyHeight,c=t.baseEmFontSize.scaledBy(t.layoutFontSize.val),r=this._fontSize;r.absolute||(r=c.scaledBy(r.val));let o={fontFamily:this._fontFamily,fontSize:r.styleString,height:t.keyHeight},d=Xl(i,c.scaledBy(n).val,o),u=.9,B=.9,b=2;var I;d.fontBoundingBoxAscent&&(I=d.fontBoundingBoxAscent+d.fontBoundingBoxDescent);let F=I!=null?I:0,h=l*u/(d.width+b),y=F&&s?s*B/F:void 0;var Q=h;return y&&y<h&&(Q=y),Z.forScalar(n*Math.min(Q,1))}get keyText(){let i=this.spec,t=" ",n=null;return i.text==null||i.text==""?n=t:(n=i.text,n=="*Tab*"&&this.layer=="shift"&&(n="*TabLeft*")),n}generateKeyText(i){let t=this.spec,n=document.createElement("span"),l=n.style;n.className="kmw-key-text";let s=this.keyText,c=Ht(s,i);c!=s&&(s=c,t.font="SpecialOSK"),typeof t.font=="string"&&t.font!=""&&(l.fontFamily=t.font),typeof t.fontsize=="string"&&t.fontsize!=""&&(l.fontSize=t.fontsize);let r={fontSize:l.fontSize};return l.fontFamily?r.fontFamily=l.fontFamily:r.fontFamily=i.fontFamily,i.isRTL&&(s="‏"+s),n.innerText=s,n}resetFontPrecalc(){this._fontFamily=void 0,this._fontSize=void 0,this.label.style.fontSize=""}detectStyles(i){if(!(this.spec.sp==k.spacer||this.spec.sp==k.blank)&&this._fontFamily===void 0){let t=getComputedStyle(this.label);if(!t.fontFamily)return;this._fontFamily=t.fontFamily;let n=new Z(t.fontSize),l=i.layoutFontSize;if(l.absolute)this._fontSize=n;else{let s=i.baseEmFontSize,c=l.scaledBy(s.val),r=n.val/c.val;this._fontSize=Z.forScalar(r)}}}refreshLayout(i){if(this.label)if(this.label.classList.contains("kmw-spacebar-caption")){let t=this.getIdealFontSize(this.keyText,i);this.label.style.setProperty("font-size",t.styleString,"important")}else{let t=this.label.textContent,n=this.getIdealFontSize(t,i);this.label.style.fontSize=n.styleString}}};a(De,"OSKKey"),De.specialCharacters=_c,De.BUTTON_CLASSES=vt,De.HIGHLIGHT_CLASS="kmw-key-touched";var Ve=De;var qc=class qc{constructor(i,t){this.key=i,this.keyId=t}};a(qc,"KeyData");var ui=qc;function Al(g,i){let t=g;for(let n in i)t.hasOwnProperty(n)||(t[n]=i[n]);return t}a(Al,"link");function gg(g){return g&&"key"in g&&g.key instanceof Ve}a(gg,"isKey");function Rl(g){return gg(g)?g:null}a(Rl,"getKeyFrom");var $c=class $c extends Ve{constructor(t,n,l){super(t,n);this.row=l}getId(){return this.spec.elementID}getCoreId(){return this.spec.coreID}getBaseId(){return this.spec.baseKeyID}generateKeyCapLabel(){var t=C.keyCodes[this.spec.baseKeyID];switch(t){case 186:t=59;break;case 187:t=61;break;case 188:t=44;break;case 189:t=45;break;case 190:t=46;break;case 191:t=47;break;case 192:t=96;break;case 219:t=91;break;case 220:t=92;break;case 221:t=93;break;case 222:t=39;break;default:(t<48||t>90)&&(t=0)}let n=document.createElement("div");return n.className="kmw-key-label",t>0&&(n.innerText=String.fromCharCode(t)),n}processSubkeys(t,n){var l,s=t.subKeys=this.spec.sk;for(l=0;l<s.length;l++){if(s[l].sp==1||s[l].sp==2){var c=s[l].text;s[l].text=Ht(c,n)}s[l].layer||(s[l].layer=t.key.layer)}}construct(t){let n=this.spec,l=document.createElement("div");l.className="kmw-key-square";let s=document.createElement("div"),c=this.btn=Al(s,new ui(this,n.id));this.setButtonClass();let r=this.capLabel=this.generateKeyCapLabel();c.appendChild(r),c.id=this.getId(),c.appendChild(this.label=this.generateKeyText(t)),typeof n.sk!="undefined"&&n.sk!=null?this.processSubkeys(c,t):c.subKeys=null;let o=this.generateHint(t);return c.appendChild(o),l.appendChild(c),this.preview=document.createElement("div"),this.preview.style.display="none",c.appendChild(this.preview),this.square=l}generateHint(t){let n=document.createElement("div");n.className="kmw-key-popup-icon";let l=this.spec.hintSrc;if(!l)return n;if(l.font&&l.font!="SpecialOSK"?n.style.fontFamily=l.font:n.classList.add("kmw-key-text"),l.fontsize){let r=new Z(l.fontsize);n.style.fontSize=r.scaledBy(.5).styleString}let s=l==this.spec?this.spec.hint:l.text,c=Ht(s,t);return c=="•"&&(n.style.fontWeight="bold"),s!=c&&(n.style.fontFamily="SpecialOSK"),n.textContent=c,n}setPreview(t){let n=this.preview;t?(this.previewHost=t,this.preview=this.previewHost.element):(this.previewHost=null,this.preview=document.createElement("div"),this.preview.style.display="none"),t==null||t.setCancellationHandler(()=>{this.setPreview(null)}),this.btn.replaceChild(this.preview,n)}refreshLayout(t){super.refreshLayout(t),t.baseEmFontSize.val<12?this.capLabel.style.fontSize="6px":this.capLabel.style.fontSize=Z.forScalar(.5).styleString}get displaysKeyCap(){return this.capLabel&&this.capLabel.style.display=="block"}set displaysKeyCap(t){if(!this.capLabel)throw new Error("Key element not yet constructed; cannot display key cap");this.capLabel.style.display=t?"block":"none"}};a($c,"OSKBaseKey");var dn=$c;var vl=.15,er=class er{constructor(i,t,n){let l=this.element=document.createElement("div");l.className="kmw-key-row",this.heightFraction=1/t.row.length;let s=n.key;this.spec=n,this.keys=[];for(let o=0;o<s.length;o++){let d=s[o];var c=new dn(d,t.id,this),r=c.construct(i);this.keys.push(c),l.appendChild(r)}}get displaysKeyCaps(){if(this.keys.length>0)return this.keys[0].displaysKeyCap}set displaysKeyCaps(i){for(let t of this.keys)t.displaysKeyCap=i}refreshLayout(i){let t=this.element.style,n=i.heightStyle.scaledBy(this.heightFraction);t.maxHeight=t.lineHeight=t.height=n.styleString;let l=i.heightStyle.absolute?n:Z.forScalar(1),s=l.scaledBy(vl/2),c=l.scaledBy(1-vl);this.keys.forEach(r=>{let o=r.square,d=r.btn,u=o.style;u.height=u.minHeight=l.styleString;let B=d.style;B.top=s.styleString,B.height=B.lineHeight=B.minHeight=c.styleString})}buildKeyLayout(i,t){let n=i.widthStyle.scaledBy(t.spec.proportionalWidth),l=i.heightStyle.scaledBy(this.heightFraction).scaledBy(1-vl);return{keyWidth:n.val*(n.absolute?1:i.keyboardWidth),keyHeight:l.val*(l.absolute?1:i.keyboardHeight),baseEmFontSize:i.baseEmFontSize,layoutFontSize:i.layoutFontSize}}detectStyles(i){this.keys.forEach(t=>{t.detectStyles(this.buildKeyLayout(i,t))})}refreshKeyLayouts(i){this.keys.forEach(t=>{var B;let n=t.btn,l=i.widthStyle,s=i.heightStyle,c=l.scaledBy(t.spec.proportionalWidth),r=l.scaledBy(t.spec.proportionalPad),o=s.scaledBy(this.heightFraction).scaledBy(1-vl),d=s.absolute?o.styleString:"100%",u=this.buildKeyLayout(i,t);(B=n.key)==null||B.refreshLayout(u),t.square.style.width=c.styleString,t.square.style.marginLeft=r.styleString,t.btn.style.width=l.absolute?c.styleString:"100%",t.square.style.height=d})}};a(er,"OSKRow");var un=er;var tr=class tr{get rowHeight(){return this._rowHeight}get id(){return this.spec.id}constructor(i,t,n){this.spec=n;let l=this.element=document.createElement("div"),s=l.style;l.className="kmw-key-layer";var c=n.row.length;c>4&&i.device.formFactor=="phone"&&(l.className=l.className+" kmw-5rows"),s.fontFamily="font"in t?t.font:"",this.nextlayer=n.id,l.layer=n.id,typeof n.nextlayer=="string"&&(l.nextLayer=this.nextlayer=n.nextlayer);let r=n.row;this.rows=[];for(let o=0;o<r.length;o++){let d=new un(i,n,r[o]);d.displaysKeyCaps=t.displayUnderlying,l.appendChild(d.element),this.rows.push(d)}if(i.device.touchable&&(this.globeKey=this.findKey("K_LOPT"),this.hideKey=this.findKey("K_ROPT")),this.spaceBarKey=this.findKey("K_SPACE"),this.capsKey=this.findKey("K_CAPS"),this.numKey=this.findKey("K_NUMLOCK"),this.scrollKey=this.findKey("K_SCROLL"),this.spaceBarKey){let o=this.spaceBarKey.label,d=this.spaceBarKey.btn;typeof d.className=="undefined"||d.className==""?d.className="kmw-spacebar":d.className.indexOf("kmw-spacebar")==-1&&(d.className+=" kmw-spacebar"),o.className!="kmw-spacebar-caption"&&(o.className="kmw-spacebar-caption")}}findKey(i){for(let t of this.rows)for(let n of t.keys)if(n.getBaseId()==i)return n;return null}showLanguage(i){if(this.spaceBarKey)try{let t=this.spaceBarKey.label;this.spaceBarKey.spec.text=i,(t.innerText!=i||i=="")&&(t.innerText=i)}catch(t){}}refreshLayout(i){this.rows.forEach(c=>c.detectStyles(i));let t=i.keyboardHeight,n=this.rows.length,l=this._rowHeight=Math.floor(t/(n==0?1:n)),s=i.widthStyle.absolute;s&&(this.element.style.height=t+"px"),this.showLanguage(i.spacebarText);for(let c=0;c<n;c++){let r=this.rows[c],o=(n-c-1)*l+1;s&&(this.spec.row[c].proportionalY=(t-o-l/2)/t),r.refreshLayout(i),c==n-1&&(r.element.style.bottom="1px")}for(let c of this.rows)c.refreshKeyLayouts(i)}};a(tr,"OSKLayer");var Bn=tr;var dg=.06,ir=class ir{constructor(i,t,n){this._layers={};this._activeLayerId="default";let l=t.layout(n);this.spec=l,this.vkbd=i;let s=this.element=document.createElement("div"),c=s.style;if(s.className="kmw-key-layer-group",l==null)return;let r=l.fontsize;typeof r=="undefined"||r==null||r==""?c.fontSize="1em":c.fontSize=l.fontsize,c.width="100%",c.height="100%",this.activeLayerId="default"}buildLayer(i){let t=this.spec,n=t.getLayer(i);if(!n)return null;let l=new Bn(this.vkbd,t,n);return this._layers[i]=l,this.element.appendChild(l.element),l}getLayer(i){let t=this._layers[i];return t||(t=this.buildLayer(i),t&&(this._layers[i]=t,t.element.style.display="none")),t}get activeLayer(){return this.activeLayerId?this._layers[this.activeLayerId]:null}get layers(){let t=this.spec.layer.map(n=>n.id);for(let n of t)this.buildLayer(n);return this._layers}get activeLayerId(){return this._activeLayerId}set activeLayerId(i){this._activeLayerId=i,this.getLayer(i);for(let t of Object.keys(this._layers)){let n=this._layers[t],l=n.element;n.id==i?l.style.display="block":l.style.display="none"}}findNearestKey(i){if(!i)return null;let t=i.stateToken;if(!t)throw new Error("Layer id not set for input coordinate");let n=this._layers[t];if(!n)throw new Error(`Layer id ${t} could not be found`);return this.nearestKey(i,n)}blinkLayer(i){if(typeof i=="string"){let n=i;if(i=this.getLayer(n),!i)throw new Error(`Layer id ${n} could not be found`)}let t=i;if(t.element.style.display!="block")for(let n in this._layers){if(this._layers[n].element.style.display=="block"){let l=this._layers[n];l.element.style.display="none"}this._layers[n].element.style.display="none"}t.element.style.display="block",Promise.resolve().then(()=>{let n=this._layers[this._activeLayerId];(t.element.style.display=="block"||n.element.style.display!="block")&&(t.element.style.display="none",n.element.style.display="block")})}nearestKey(i,t){if(t.rows.length==0)return null;let n={x:i.targetX/this.computedWidth,y:i.targetY/this.computedHeight};if(!isFinite(n.x)||!isFinite(n.y))return null;let l=Math.max(0,Math.min(t.rows.length-1,Math.floor(n.y*t.rows.length))),s=t.rows[l],c=null,r=Number.MAX_VALUE;for(let o of s.keys){let d=o.spec;if(d.sp==k.blank||d.sp==k.spacer)continue;let u=d.proportionalWidth/2,B=Math.abs(n.x-d.proportionalX);if(B-u<=0)return o.btn;{let b=B-u;b<r&&(r=b,c=o)}}return r<=dg?c.btn:null}resetPrecalcFontSizes(){for(let i of Object.values(this._layers))for(let t of i.rows)for(let n of t.keys)n.resetFontPrecalc();this._heightPadding=void 0}refreshLayout(i){if(!(isNaN(i.keyboardWidth)||isNaN(i.keyboardHeight))){if(this.computedWidth=i.keyboardWidth,this.computedHeight=i.keyboardHeight,this._heightPadding===void 0){let t=getComputedStyle(this.element),n=parseInt(t.paddingTop,10)||0,l=parseInt(t.paddingBottom,10)||0;this._heightPadding=n+l}this.activeLayer&&this.activeLayer.refreshLayout(i)}}get verticalPadding(){var i;return(i=this._heightPadding)!=null?i:0}};a(ir,"OSKLayerGroup");var In=ir;var Oo="kmw-",Po="top",nr=class nr{constructor(i,t){this.state=!1;this.orientation=Po;this.vkbd=i;let n=this.element=document.createElement("div");n.className="kmw-keytip",n.id="kmw-keytip",n.style.pointerEvents="none",n.style.display="none",n.appendChild(this.tip=document.createElement("div")),n.appendChild(this.cap=document.createElement("div")),this.tip.appendChild(this.preview=document.createElement("div")),this.tip.className="kmw-keytip-tip",this.cap.className="kmw-keytip-cap",this.constrain=t,this.reorient=l=>{this.orientation=l,this.show(this.key,this.state,this.previewHost)}}show(i,t,n){var r;let l=this.vkbd;if(t&&l.layerGroup.blinkLayer(i.key.spec.displayLayer),t&&i.offsetParent){let o=i.key.row.element,d=i.getClientRects()[0],u=o.getClientRects()[0],B=d.left-u.left,b=d.width,I=d.height,F=1.8,h=this.element.style,Q=l.topContainer.getBoundingClientRect(),x=i.getBoundingClientRect(),U,p=this.orientation,V=x.bottom-Q.top;U=V+(p=="top"?1:-1);let f=U-Math.floor(U),H=b+Math.ceil(b*.3)*2,w=Math.ceil(2.3*I)+f;p=="bottom"&&(U+=w-I),h.top="auto";let qe=p=="top"?"bottom":"top";this.tip.classList.remove(`${Oo}${qe}`),this.tip.classList.add(`${Oo}${p}`),h.bottom=Math.floor(Q.height-U)+"px",h.textAlign="center",h.overflow="visible",h.width=H+"px",h.height=w+"px";let Jn=this.vkbd.currentLayer.element.style.fontFamily,Ce=getComputedStyle(l.element);h.fontFamily=i.key.spec.font||Jn||Ce.fontFamily;var s=parseInt(Ce.fontSize,10);if(s==Number.NaN&&(s=0),s!=0){let et={keyWidth:1.6*b,keyHeight:1.6*I,baseEmFontSize:l.getKeyEmFontSize(),layoutFontSize:new Z(l.kbdDiv.style.fontSize)};h.fontSize=i.key.getIdealFontSize(i.key.keyText,et,F).styleString}var c=(H-b)/2;B<c?(this.cap.style.left="1px",B+=c-1):B>window.innerWidth-b-c?(this.cap.style.left=H-b-1+"px",B-=c-1):this.cap.style.left=c+"px",h.left=B-c+"px";let ke=getComputedStyle(this.element),Ui=Q.height,Ft=parseFloat(ke.bottom),xi=parseFloat(ke.height),$e=Math.ceil(w/2);this.cap.style.width=b+"px",this.tip.style.height=$e+"px";let Nt=3,Zi=$e-Nt+"px";p=="top"?(this.cap.style.top=Zi,this.cap.style.bottom=""):(this.cap.style.top="",this.cap.style.bottom=Zi);let Xi=V-Math.floor(U)+w-(p=="top"?$e:-Nt*2);if(this.cap.style.height=Xi+"px",this.constrain&&xi+Ft>Ui){let et=xi+Ft-Ui;h.height=w-et+"px";let ca=Math.max(0,w-et-w/2+2);this.cap.style.height=ca+"px"}else Ft<0&&(h.bottom="0px",this.cap.style.height=Math.max(0,Xi+Ft)+"px");if(h.display="block",this.previewHost==n)return;let Ne=this.preview;this.previewHost&&this.previewHost.off("preferredOrientation",this.reorient),this.previewHost=n,n&&(this.previewHost.on("preferredOrientation",this.reorient),this.preview=this.previewHost.element,this.tip.replaceChild(this.preview,Ne),n.setCancellationHandler(()=>this.show(null,!1,null)),n.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",(r=this.previewHost)==null||r.off("preferredOrientation",this.reorient),this.previewHost=null;let o=this.preview;this.preview=document.createElement("div"),this.tip.replaceChild(this.preview,o),this.element.classList.remove("kmw-preview-fade"),this.orientation=Po}this.key=i,this.state=t}};a(nr,"KeyTip");var bn=nr;var lr="kmw-keypreview",ug="kmw-preview-overlay",Bg="kmw-keytip",sr=class sr{constructor(i){this.state=!1;this.vkbd=i;let t=this.element=document.createElement("div");t.className=lr,t.id="kmw-keytip",t.style.pointerEvents="none",t.style.display="none",this.preview=document.createElement("div"),t.appendChild(this.preview)}show(i,t,n){let l=this.vkbd,s=i==null?void 0:i.key.spec.displayLayer;if(t&&l.layerGroup.blinkLayer(s),t&&(i!=null&&i.offsetParent)){let c=this.vkbd.topContainer.getBoundingClientRect(),r=i.getBoundingClientRect(),o=s!=l.layerId?ug:"";this.element.className=`${lr} ${i.className} ${o}`,this.element.id=`${Bg}-${i.id}`;let d=this.element.style,u=this.vkbd.currentLayer.element.style.fontFamily;if(d.fontFamily=i.key.spec.font||u,d.left=r.left-c.left+"px",d.top=r.top-c.top+"px",d.width=r.width+"px",d.height=r.height+"px",this.element.style.display="block",this.previewHost==n)return;let B=this.preview;this.previewHost=n,n&&(this.preview=this.previewHost.element,this.element.replaceChild(this.preview,B),n.setCancellationHandler(()=>this.show(null,!1,null)),n.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",this.element.className=lr,this.previewHost=null;let c=this.preview;this.preview=document.createElement("div"),this.element.replaceChild(this.preview,c),this.element.classList.remove("kmw-preview-fade")}this.key=i,this.state=t}};a(sr,"TabletKeyTip");var Hl=sr;function Se(g){try{if(g=="desktop")return 1;var i=document.documentElement.clientWidth;if(screen.width>i)return 1;var t=screen.width;return he()?screen.width<screen.height&&(t=screen.height):screen.width>screen.height&&(t=screen.height),Math.round(100*t/i)/100}catch(n){return 1}}a(Se,"getViewportScale");var ft=class ft{constructor(i,t){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.deleteRepeater=a(()=>{this.repeatClosure(),this.timerHandle=window.setTimeout(this.deleteRepeater,ft.REPEAT_DELAY)},"deleteRepeater");this.source=i;let n=i.stageReports[0].item;n.key.highlight(!0),this.repeatClosure=()=>{t(),n.key.highlight(!0)},this.timerHandle=window.setTimeout(this.deleteRepeater,ft.INITIAL_DELAY),this.source.on("complete",()=>{window.clearTimeout(this.timerHandle),this.timerHandle=void 0,n.key.highlight(!1)})}cancel(){this.deleteRepeater(),this.source.cancel()}currentStageKeyDistribution(){return null}};a(ft,"HeldRepeater"),ft.INITIAL_DELAY=500,ft.REPEAT_DELAY=100;var fl=ft;var cr=class cr extends Ve{constructor(i,t){if(typeof t!="string"||t=="")throw"The 'layer' parameter for subkey construction must be properly defined.";super(i,t)}getId(){return"popup-"+this.spec.elementID}construct(i,t,n,l){let s=this.spec,c=document.createElement("div"),r=c.style;c.className="kmw-key-square-ex",l&&(r.marginTop="5px"),r.width=n+"px",r.height=t.offsetHeight+"px";let o=document.createElement("div"),d=this.btn=Al(o,new ui(this,s.id));this.setButtonClass(),d.id=this.getId();let u=d.style;return u.height=r.height,u.lineHeight=t.style.lineHeight,u.width=r.width,u.position="absolute",d.appendChild(this.label=this.generateKeyText(i)),c.appendChild(d),this.square=c}allowsKeyTip(){return!1}};a(cr,"OSKSubKey");var hn=cr;var jo=.2,Ig=1.2,qo=3,Bi=5,_o=6+qo,rr=class rr{constructor(i,t,n,l,s){this.directlyEmitsKeys=!0;this.shouldLockLayer=!1;var x;this.baseKey=l,this.source=i,this.gestureParams=s,n.layerLocked&&(this.shouldLockLayer=!0),i.on("complete",()=>{var U;(U=this.currentSelection)==null||U.key.highlight(!1),this.clear()}),i.on("stage",()=>{let U=this.currentSelection;if(U){let p=n.keyEventFromSpec(U.key.spec);p.keyDistribution=this.currentStageKeyDistribution(),n.raiseKeyEvent(p,U)}});let c=i.stageReports[0].sources[0].constructSubview(!0,!1);c.path.on("step",U=>{var p,V;c.path.stats.netDistance>=4&&((p=this.currentSelection)==null||p.key.highlight(!1),(V=U.item)==null||V.key.highlight(!0),this.currentSelection=U.item)}),this.currentSelection=l,l.key.highlight(!0);let r=l.subKeys,o=this.element=document.createElement("div");o.id="kmw-popup-keys";var d=o.style;d.fontFamily=n.fontFamily;let u=getComputedStyle(l);d.fontSize=u.fontSize,d.visibility="hidden";let B=l.key.layer;(typeof B!="string"||B=="")&&(B=n.layerId);let b=r.length,I=Math.ceil(b/9),F=Math.ceil(b/I);this.subkeys=[];let h=Bi,y=0;for(let U=0,p=0;U<b;U++,p++){let V=typeof r[U].width!="undefined"?r[U].width*l.offsetWidth/100:l.offsetWidth;V>n.width-2*Bi&&(V=n.width-2*Bi),(h+V+Bi>n.width||p>=F)&&(y++,p=0,h=Bi);let H=new hn(r[U],B).construct(n,l,V,y>0);h+=V+Bi,this.menuWidth=Math.max((x=this.menuWidth)!=null?x:0,h),this.subkeys.push(H.firstChild),o.appendChild(H)}d.width=this.menuWidth+"px",this.shim=document.createElement("div"),this.shim.id="kmw-popup-shim",n.device.formFactor==W.FormFactor.Phone&&this.selectDefaultSubkey(l,o),n.element.appendChild(this.element),n.topContainer.appendChild(this.shim),this.reposition(n);let Q=this.buildPopupRecognitionConfig(n);t({type:"push",config:Q})}buildPopupRecognitionConfig(i){let t=this.element.getBoundingClientRect(),n=this.baseKey.getBoundingClientRect(),l=this.subkeys[0].style,c=-.666*Number.parseInt(l.height,10),r=3,o=n.bottom-t.bottom,d=new Be(this.element,[c*r,c,-o<c?-o:c]),u={getBoundingClientRect(){let B=Number.MAX_SAFE_INTEGER;return new DOMRect(-B,-B,2*B,2*B)}};return{targetRoot:this.element,inputStartBounds:i.element,maxRoamingBounds:u,safeBounds:u,itemIdentifier:(B,b)=>{let I=d.getBoundingClientRect(),F=null,h=Number.MAX_VALUE,y=Number.MAX_VALUE;if(B.clientX<I.left||B.clientX>I.right||B.clientY<I.top||B.clientY>I.bottom)return null;for(let Q of this.subkeys){let x=Q.getBoundingClientRect(),U=Number.MAX_VALUE,p=Number.MAX_VALUE;if(x.left<=B.clientX&&B.clientX<x.right?U=0:U=x.left>=B.clientX?x.left-B.clientX:B.clientX-x.right,x.top<=B.clientY&&B.clientY<x.bottom?p=0:p=x.top>=B.clientY?x.top-B.clientY:B.clientY-x.bottom,U==0&&p==0)return Q;(U<y||U==y&&p<h)&&(y=U,F=Q,h=p)}return F}}}reposition(i){let t=this.element,n=this.baseKey,l=i.topContainer,s=n.key.row.element,c=t.style,r=n.offsetParent?n.offsetParent.offsetLeft:0;var o=n.offsetLeft+r+.5*(n.offsetWidth-t.offsetWidth),d=i.width-t.offsetWidth;o>d&&(o=d),o<0&&(o=0),c.left=o+"px";let u=l.getBoundingClientRect(),B=s.getBoundingClientRect();c.top=B.top-u.top-t.offsetHeight-qo+"px",c.visibility="visible";let b=i.isEmbedded,I=getComputedStyle(t),F=parseFloat(I.top),h=0,y=0;F<h&&b&&(y=h-F,c.top=h+"px"),this.callout=this.addCallout(n,y,i.element,i.topContainer,i.device.formFactor=="tablet")}addCallout(i,t,n,l,s){t=t||0;let c=getComputedStyle(this.element),r=Math.max(Number.parseInt(c.borderRadius),0),o=i.getBoundingClientRect(),d=l.getBoundingClientRect(),u=Math.floor(Number.parseInt(c.top,10)+Number.parseInt(c.height,10)+Number.parseInt(c.paddingTop,10)/2+Number.parseInt(c.paddingBottom,10)),B=jo*(o.height-t),b=jo*o.height,I=B+_o,F=I/(b+_o),h=o.bottom-d.top-u-1,y=h<I?h:I;if(y>0){let Q=document.createElement("div"),x=Q.style;Q.id="kmw-popup-callout",n.appendChild(Q),x.top=u+"px",x.borderTopWidth=y+"px";let U=Ig*F,p=o.width*U,V=this.menuWidth-2*r,f=V<p?V:p,H=o.left-d.left-(f-o.width)/2,w=Math.max(0,H+f-(d.right-r)),qe=Math.max(0,r-H);return x.left=o.left-d.left-(f-o.width)/2+qe+"px",x.borderLeftWidth=f/2-qe+"px",x.borderRightWidth=f/2-w+"px",Q}else return null}selectDefaultSubkey(i,t){var s;var n;let l=i.subKeys;for(let c=0;c<l.length;c++){let r=l[c],o=t.childNodes[c].firstChild;if(r.default){n=o;break}else if(!i.key||!i.key.spec)continue;r.elementID==i.key.spec.elementID&&(n=o)}n&&((s=this.currentSelection)==null||s.key.highlight(!1),this.currentSelection=n,n.key.highlight(!0))}get hasModalVisualization(){return this.element.style.visibility=="visible"}buildCorrectiveLayout(){let i=this.element.getBoundingClientRect(),t=i.width/i.height;return{keys:this.subkeys.map(l=>{let s=l.getBoundingClientRect();return{keySpec:l.key.spec,centerX:(s.right-s.width/2-i.left)/i.width,centerY:(s.bottom-s.height/2-i.top)/i.height,width:s.width/i.width,height:s.height/i.height}}),kbdScaleRatio:t}}currentStageKeyDistribution(){let i=this.source.stageReports[this.source.stageReports.length-1],t=this.source.stageReports[0],n=i.sources[0],l=n.currentSample,s=this.element.getBoundingClientRect(),c={x:l.targetX/s.width,y:l.targetY/s.height};c.x=c.x<0?0:c.x>1?1:c.x,c.y=c.y<0?0:c.y>1?1:c.y;let r=pl(c,this.buildCorrectiveLayout()),o=r.get(l.item.key.spec),d=Math.min(n.path.stats.duration-t.sources[0].path.stats.duration,this.gestureParams.longpress.waitLength)/(2*this.gestureParams.longpress.waitLength),u=Math.min(n.path.stats.rawDistance,this.gestureParams.longpress.noiseTolerance*4)/(this.gestureParams.longpress.noiseTolerance*8),B=Math.min(d*d,u*u),b=o+B,I=new Map,F=this.subkeys.find(h=>h.keyId==this.baseKey.keyId);return F?I.set(F.key.spec,b):I.set(this.baseKey.key.spec,b),ut([r,I])}cancel(){this.clear(),this.source.cancel()}clear(){this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.shim.parentNode&&this.shim.parentNode.removeChild(this.shim),this.callout&&this.callout.parentNode&&this.callout.parentNode.removeChild(this.callout)}};a(rr,"SubkeyPopup");var Ii=rr;var or=class or{constructor(i,t,n){this.directlyEmitsKeys=!0;this.shouldRestore=!1;this.hasModalVisualization=!1;let l=i.stageReports[0];this.originalLayer=l.sources[0].stateToken,this.source=i,this.completionCallback=()=>{t.lockLayer(!1),this.shouldRestore&&(t.layerId=this.originalLayer,t.updateState()),n==null||n()},t.lockLayer(!0),i.on("stage",s=>{let c=s.matchedId;c.includes("modipress")&&c.includes("-end")?this.clear():c.includes("modipress")&&c.includes("-hold")&&(this.shouldRestore=!0)}),i.on("complete",()=>this.cancel())}get isLocked(){return this.shouldRestore}setLocked(){this.shouldRestore=!0}get completed(){return this.completionCallback===null}clear(){let i=this.completionCallback;this.completionCallback=null,i==null||i()}cancel(){this.clear(),this.source.cancel()}currentStageKeyDistribution(i){return null}};a(or,"Modipress");var Bt=or;var ar=class ar{constructor(i,t,n,l,s){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.tapIndex=0;this.baseKey=n,this.baseContextToken=l,this.multitaps=[n.key.spec].concat(n.key.spec.multitap),this.sequence=i;let c=a(B=>{var I;(I=this.modipress)==null||I.clear();let b=new Bt(i,t,()=>{this.modipress=t.activeModipress=null});this.modipress=t.activeModipress=b},"startModipress");this.originalLayer=t.layerId;let r=a(B=>(this.tapIndex+B)%this.multitaps.length,"tapLookahead"),o=a(()=>{s==null||s.setMultitapHint(this.multitaps[r(0)],this.multitaps[r(1)],t)},"updatePreview");i.on("complete",()=>{var B;(B=this.modipress)==null||B.cancel(),this.clear()});let d=a(B=>{var y;switch(B.matchedId){case"modipress-hold":this.clear(),i.off("stage",d);return;case"modipress-end-multitap-transition":case"modipress-multitap-end":case"modipress-end":case"multitap-end":case"simple-tap":return;case"modipress-multitap-lock-transition":(y=this.modipress)==null||y.setLocked();return;case"modipress-multitap-start":case"multitap-start":break;default:throw new Error(`Unsupported gesture state encountered during multitap: ${B.matchedId}`)}this.tapIndex=r(1);let b=this.multitaps[this.tapIndex];o();let I=t.keyEventFromSpec(b);I.baseTranscriptionToken=this.baseContextToken;let F=B.sources[0].currentSample,h=t.getSimpleTapCorrectionDistances(F,this.baseKey.key.spec);if(F.stateToken!=t.layerId&&!B.matchedId.includes("modipress")){let Q=t.layerGroup.findNearestKey(A(G({},F),{stateToken:t.layerId})),x=h.get(Q.key.spec);x==null&&console.warn("Could not find current layer's key"),h.delete(Q.key.spec),h.set(F.item.key.spec,x)}I.keyDistribution=this.currentStageKeyDistribution(h),I.kNextLayer||(I.kNextLayer=this.originalLayer),t.raiseKeyEvent(I,null),B.matchedId=="modipress-multitap-start"&&c(B)},"stageHandler");i.on("stage",d),i.stageReports[0].matchedId=="modipress-start"&&c(i.stageReports[0]),o()}currentStageKeyDistribution(i){let t=ut(i),n=t.findIndex(o=>o.keySpec==this.baseKey.key.spec);if(n==-1)return cn(this.baseKey)||console.warn("Could not find base key's probability for multitap correction"),t;let l=t.splice(n,1)[0].p,s=0,c=[];for(let o=0;o<this.multitaps.length;o++){let d=this.multitaps[o],u=Math.abs(o-this.tapIndex)%this.multitaps.length,B=(o+this.multitaps.length-this.tapIndex)%this.multitaps.length,b=u<B?u:B,I=1/((1+b)*(1+b));s+=I,c.push({keySpec:d,p:I})}let r=l/s;return c.forEach(o=>{o.p=r*o.p}),t.concat(c).sort((o,d)=>d.p-o.p)}cancel(){this.clear(),this.sequence.cancel()}clear(){}};a(ar,"Multitap");var Fn=ar;var yn=1.4142,gr=a(g=>Math.abs(g)<1e-10?0:g,"coerceZeroes"),dr=class dr extends S.default{constructor(t,n,l,s){var b;super();this.flickPreviews=new Map;this.orientation="top";let c=t.key.spec,r=this.flickEdgeLength=Math.max(l,s),o=this.div=document.createElement("div");o.className=o.id="kmw-gesture-preview",o.style.pointerEvents="none";let d=this.previewImgContainer=document.createElement("div");this.previewImgContainer.id="kmw-preview-img-container";let u=this.label=document.createElement("span");if(u.className="kmw-gesture-base-label kmw-key-text",u.id="kmw-gesture-base-label",d.appendChild(u),u.textContent=t.key.label.textContent,this.div.appendChild(this.previewImgContainer),c.flick){let I=c.flick||{};Object.keys(I).forEach(F=>{let h=document.createElement("div");h.className="kmw-flick-preview kmw-key-text",h.textContent=I[F].text;let y=h.style,Q=Nc.get(F),x=gr(-Math.sin(Q[0])),U=gr(Math.cos(Q[0]));y.width="100%",y.textAlign="center",x<0?y.right=-x*yn*r+"px":x>0?y.left=x*yn*r+"px":y.left="0px",y.height="100%",y.lineHeight="100%",U<0?y.bottom=-U*yn*r+"px":U>0?y.top=U*yn*r+"px":y.top="0px",this.flickPreviews.set(F,h),d.appendChild(h)})}let B=this.hintLabel=document.createElement("div");B.className="kmw-key-popup-icon",n||(B.textContent=c==c.hintSrc?c.hint:(b=c.hintSrc)==null?void 0:b.text,B.style.fontWeight=B.textContent=="•"?"bold":""),o.appendChild(B)}get element(){return this.div}refreshLayout(){let t=getComputedStyle(this.div),n=Number.parseInt(t.height,10);this.flickPreviews.forEach(l=>{l.style.lineHeight=l.style.height=`${n}px`})}cancel(){var t;(t=this.onCancel)==null||t.call(this),this.onCancel=null}setCancellationHandler(t){this.onCancel=t}setMultitapHint(t,n,l){var r,o;let s=Ht(t.text,l),c=Ht(n.text,l);this.label.textContent=s,this.hintLabel.textContent=c,this.label.style.fontFamily=s!=t.text?"SpecialOSK":(r=t.font)!=null?r:this.label.style.fontFamily,this.hintLabel.style.fontFamily=c!=n.text?"SpecialOSK":(o=n.font)!=null?o:this.hintLabel.style.fontFamily,this.emit("startFade"),this.clearFlick()}scrollFlickPreview(t,n){this.clearHint();let l=this.previewImgContainer.style,s=this.flickEdgeLength*yn;l.marginLeft=`${s*t}px`,l.marginTop=`${s*n}px`;let c=gr(n)<0?"bottom":"top";this.orientation!=c&&(this.orientation=c,this.emit("preferredOrientation",c))}clearFlick(){this.previewImgContainer.style.marginTop="0px",this.previewImgContainer.style.marginLeft="0px",this.previewImgContainer.classList.add("kmw-flick-clear")}clearHint(){this.hintLabel.classList.add("kmw-hint-clear")}clearAll(){this.clearFlick()}};a(dr,"GesturePreviewHost");var Ll=dr;var $o=tt.TIER!="stable"||tt.VERSION_ENVIRONMENT!="",bg=$o?10:0,mn=class mn extends S.default{constructor(t){var d,u,B;super();this.layerLocked=!1;this.layerIndex=0;this.isStatic=!1;this._fixedWidthScaling=!1;this._fixedHeightScaling=!0;this._borderWidth=0;this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.activeGestures=[];this.activeModipress=null;this.repeatDelete=function(){this.deleting&&(this.modelKeyClick(this.deleteKey),this.deleting=window.setTimeout(this.repeatDelete,100))}.bind(this);this.config=t,this.config.device=t.device||t.hostDevice,this.config.isEmbedded=t.isEmbedded||!1,t.isStatic&&(this.isStatic=t.isStatic),(d=this.config).gestureParams||(d.gestureParams=G({},sn)),this._fixedWidthScaling=this.device.touchable&&!this.isStatic,this._fixedHeightScaling=this.device.touchable&&!this.isStatic;var n=document.createElement("div");this.config.styleSheetManager=t.styleSheetManager||new de(n);let l;if(t.keyboard)l=this.kbdLayout=t.keyboard.layout(t.device.formFactor),this.layoutKeyboardProperties=t.keyboardMetadata,this.isRTL=t.keyboard.isRTL;else{let b=E.buildDefaultLayout(null,null,t.device.formFactor);l=this.kbdLayout=Mt.polyfill(b,null,t.device.formFactor),this.layoutKeyboardProperties=null,this.isRTL=!1}"font"in l?this.fontFamily=l.font:this.fontFamily="";let s=t.device.formFactor;this.layoutKeyboard=t.keyboard,this.layoutKeyboard||(this.layoutKeyboard=new T(null)),this.layerGroup=new In(this,this.layoutKeyboard,s),this.layoutKeyboard.markLayoutCalibrated(s),n.appendChild(this.layerGroup.element),this.kbdDiv=n,this.isStatic||(this.gestureEngine=this.constructGestureEngine()),n.classList.add(t.device.formFactor,"kmw-osk-inner-frame");let c=(B=(u=this.layoutKeyboard)==null?void 0:u.id.replace("Keyboard_",""))!=null?B:"",r=c.indexOf("::");r!=-1&&(c=c.substring(r+2));let o="kmw-keyboard-"+c;this.element.classList.add(o)}get gestureParams(){return this.config.gestureParams}get layerId(){var t,n;return(n=(t=this.layerGroup)==null?void 0:t.activeLayerId)!=null?n:"default"}set layerId(t){let n=t!=this.layerId;if(this.layerGroup.getLayer(t))this.layerGroup.activeLayerId=t,this.gestureEngine&&(this.gestureEngine.stateToken=t);else throw new Error(`Keyboard ${this.layoutKeyboard.id} does not have a layer with id ${t}`);n&&!this.deferLayout&&(this.updateState(),this.layerGroup.refreshLayout(this.constructLayoutParams()))}get currentLayer(){var t;return(t=this.layerGroup)==null?void 0:t.activeLayer}get lgKey(){var t,n;return(n=(t=this.currentLayer)==null?void 0:t.globeKey)==null?void 0:n.btn}get hkKey(){var t,n;return(n=(t=this.currentLayer)==null?void 0:t.hideKey)==null?void 0:n.btn}get spaceBar(){var t,n;return(n=(t=this.currentLayer)==null?void 0:t.spaceBarKey)==null?void 0:n.btn}constructGestureEngine(){let t={targetRoot:this.element,mouseEventRoot:document.body,maxRoamingBounds:new Be(this.topContainer,[NaN]),itemIdentifier:(r,o)=>this.layerGroup.findNearestKey(r),recordingMode:$o,historyLength:bg},n=new At(Ec(this.kbdLayout,this.gestureParams),t);n.stateToken=this.layerId;let l={},s=a(r=>{for(let o of Object.keys(l)){if(o==r)continue;l[o].source.terminate(!0)}},"clearActiveGestures"),c=new Map;return n.on("inputstart",r=>{var B;let o=this.highlightKey(r.currentSample.item,!0);o&&((B=this.gesturePreviewHost)==null||B.cancel(),this.gesturePreviewHost=o),l[r.identifier]={source:r,roamingHighlightHandler:null,key:r.currentSample.item,previewHost:o};let d=l[r.identifier],u=a(()=>{ge(0).then(()=>{let b=d.previewHost;b&&(b.cancel(),this.gesturePreviewHost=null,d.previewHost=null),d.key&&(this.highlightKey(d.key,!1),d.key=null)})},"endHighlighting");d.roamingHighlightHandler=b=>{var h;let I=b.item,F=l[r.identifier].key;if(!this.kbdLayout.hasFlicks&&I!=F){this.highlightKey(F,!1),(h=this.gesturePreviewHost)==null||h.cancel(),this.gesturePreviewHost=null,d.previewHost=null;let y=this.highlightKey(I,!0);y&&(this.gesturePreviewHost=y,d.previewHost=y),l[r.identifier].key=I}},r.path.on("invalidated",u),r.path.on("complete",u),r.path.on("step",d.roamingHighlightHandler)}),n.on("recognizedgesture",r=>{var o;(o=this.activeModipress)==null||o.setLocked(),r.on("complete",()=>{var d;for(let u of r.allSourceIds)(d=l[u])!=null&&d.previewHost&&(this.gesturePreviewHost=null,l[u].previewHost.cancel()),delete l[u]}),r.on("stage",(d,u)=>{let B=r.allSourceIds.map(p=>{var V;return(V=l[p])==null?void 0:V.previewHost}).find(p=>!!p),b=a(()=>{B&&(B.cancel(),this.gesturePreviewHost=null)},"clearPreviewHost"),I=c.get(r);!I&&B&&!d.matchedId.includes("flick")&&B.clearFlick();let F;for(let p of d.allSourceIds){let V=a(f=>{f.key&&(this.highlightKey(f.key,!1),f.key=null),f.source.path.off("step",f.roamingHighlightHandler)},"clearRoaming");if(F=l[p],F)V(F);else{let f=p;ge(0).then(()=>{let H=l[f];H&&V(H)})}}let h=d.item,y=d.sources[0],Q=y?y.currentSample:null,x=null;if(h&&!(I&&I[0].directlyEmitsKeys)){let p,V=this.getSimpleTapCorrectionDistances(y.currentSample,h.key.spec);I&&(p=I[0].currentStageKeyDistribution(V)),p||(p=ut(V));let f=!this.layerLocked&&I&&I[0]instanceof Ii&&I[0].shouldLockLayer;try{f&&this.lockLayer(!0),x=this.modelKeyClick(d.item,Q,p)}finally{f&&this.lockLayer(!1)}}if(r.stageReports.length>1&&d.matchedId!="modipress-end")return;let U=r.stageReports[0].item;if(d.matchedId=="special-key-start")h.key.spec.baseKeyID=="K_BKSP"?(b(),I=[new fl(r,()=>this.modelKeyClick(h,Q))]):h.key.spec.baseKeyID=="K_LOPT"&&(r.on("complete",()=>{h.key.highlight(!1),this.emit("globekey",h,!1)}),s(y.identifier),h.key.highlight(!0));else if(d.matchedId.indexOf("longpress")>-1)b(),I=[new Ii(r,u,this,r.stageReports[0].sources[0].baseItem,this.gestureParams)];else if(U!=null&&U.key.spec.multitap&&(d.matchedId=="initial-tap"||d.matchedId=="multitap"||d.matchedId=="modipress-start"))F.previewHost=null,r.on("complete",()=>{b()}),I=[new Fn(r,this,U,x.contextToken,B)];else if(d.matchedId.indexOf("flick")>-1)I=[new nn(r,u,this,r.stageReports[0].sources[0].baseItem,this.gestureParams,B)];else if(d.matchedId.includes("modipress")&&d.matchedId.includes("-start"))if(b(),this.layerLocked)console.warn("Unexpected state:  modipress start attempt during an active modipress");else{I||(I=[]);let p=new Bt(r,this,()=>{let V=I.indexOf(p);V>-1&&I.splice(V,1),this.activeModipress=null});I.push(p),this.activeModipress=p}else b();I&&(this.activeGestures=this.activeGestures.concat(I),c.set(r,I),r.on("complete",()=>{let p=this.activeGestures.filter(V=>I.includes(V));this.activeGestures=this.activeGestures.filter(V=>!I.includes(V)),p.forEach(V=>{V instanceof Bt&&V.cancel()})}))})}),n}get element(){return this.kbdDiv}get device(){return this.config.device}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get styleSheetManager(){return this.config.styleSheetManager}get topContainer(){return this.config.topContainer}get isEmbedded(){return this.config.isEmbedded}postInsert(){}get width(){return this._width}get height(){return this._height}get layoutWidth(){if(this.usesFixedWidthScaling){let t=this.width;return t-=this._borderWidth*2,Z.inPixels(t)}else return Z.forScalar(1)}get layoutHeight(){if(this.usesFixedHeightScaling){let t=this.height;return t-=this._borderWidth*2,Z.inPixels(t)}else return Z.forScalar(1)}get internalHeight(){return this.usesFixedHeightScaling?Z.inPixels(this.layoutHeight.val-this._borderWidth*2-this.layerGroup.verticalPadding):Z.forScalar(1)}get fontSize(){return this._fontSize||(this._fontSize=new Z("1em")),this._fontSize}set fontSize(t){this._fontSize=t,this.kbdDiv.style.fontSize=t.styleString}get usesFixedWidthScaling(){return this._fixedWidthScaling}set usesFixedWidthScaling(t){this._fixedWidthScaling=t}get usesFixedHeightScaling(){return this._fixedHeightScaling}set usesFixedHeightScaling(t){this._fixedHeightScaling=t}get usesFixedPositioning(){let t=this.element;for(;t;){if(getComputedStyle(t).position=="fixed")return!0;t=t.offsetParent}return!1}setSize(t,n,l){this._width=t,this._height=n,this.kbdDiv&&(this.kbdDiv.style.width=t?this._width+"px":"",this.kbdDiv.style.height=n?this._height+"px":"",!this.device.touchable&&n&&(this.fontSize=new Z(this._height/8+"px")),l||this.refreshLayout())}getTouchCoordinatesOnKeyboard(t){let n={x:t.targetX,y:t.targetY};return n.x/=this.layerGroup.element.offsetWidth,n.y/=this.kbdDiv.offsetHeight,n}getSimpleTapCorrectionDistances(t,n){let l=this.getTouchCoordinatesOnKeyboard(t),c=this.layerGroup.element.offsetWidth,r=this.kbdDiv.offsetHeight;if(!c||!r)return new Map;let o=c/r,d=Do(this.kbdLayout.getLayer(this.layerId),o);return pl(l,d)}keyTarget(t){let n=t;try{if(n){if(n.classList.contains("kmw-key"))return Rl(n);if(n.parentNode&&n.parentNode.classList.contains("kmw-key"))return Rl(n.parentNode);if(n.firstChild&&n.firstChild.classList.contains("kmw-key"))return Rl(n.firstChild)}}catch(l){}return null}cancelDelete(){this.deleting&&window.clearTimeout(this.deleting),this.deleting=0}modelKeyClick(t,n,l){let s=this.initKeyEvent(t);return n&&(s.source=n),l&&(s.keyDistribution=l),this.raiseKeyEvent(s,t)}initKeyEvent(t){this.highlightKey(t,!1);let n=t.key?t.key.spec:null;return n?this.keyEventFromSpec(n):null}keyEventFromSpec(t){let n=this.layoutKeyboard.constructKeyEvent(t,this.device,this.stateKeys);return n.srcKeyboard=this.layoutKeyboard,n}_UpdateVKShiftStyle(t){var r;var n;t||(t=this.layerId);let l=this.layerGroup.getLayer(t);if(!l||(this.gestureEngine&&(this.gestureEngine.stateToken=t),!((r=this.layoutKeyboard)!=null&&r.usesDesktopLayoutOnDevice(this.device))))return;let s=["K_CAPS","K_NUMLOCK","K_SCROLL"],c=[l.capsKey,l.numKey,l.scrollKey];for(n=0;n<c.length;n++)c[n]!=null&&c[n].setToggleState(this.stateKeys[s[n]])}updateStateKeys(t){for(let n of Object.keys(this.stateKeys))this.stateKeys[n]=t[n];this._UpdateVKShiftStyle()}highlightKey(t,n){if(!t||!t.key||t.className==""||t.className.indexOf("kmw-key-row")>=0)return null;let l=t.key.allowsKeyTip();return n=this.activeGestures.find(c=>c.hasModalVisualization)?!1:n,t.key.highlight(n),n&&l?this.gesturePreviewHost?null:this.showGesturePreview(t):null}getKeyEmFontSize(){if(!this.fontSize)return new Z("0px");if(this.device.formFactor=="desktop"){let t=.8;return this.fontSize.scaledBy(t)}else{let t=getComputedStyle(document.body).fontSize,n=new Z(t),l=1;if(!this.isStatic){if(this.fontSize.absolute)return this.fontSize;l=this.fontSize.val}return n.scaledBy(l)}}updateState(){this.currentLayer&&(this.nextLayer=this.layerId,this.currentLayer.nextlayer&&(this.nextLayer=this.currentLayer.nextlayer),this.layerGroup.activeLayerId=this.layerId,this._UpdateVKShiftStyle())}refreshLayout(){if(this.deferLayout)return;let t=this.device;var n=1;t.OS==W.OperatingSystem.iOS&&!this.isEmbedded&&(n=n/Se(this.device.formFactor));let l=this.kbdDiv.style;this.usesFixedHeightScaling&&this.height&&(l.height=l.maxHeight=this.height+"px"),l.fontSize=this.fontSize.scaledBy(n).styleString;let s=this.width&&this.height,c=getComputedStyle(this.kbdDiv),r=getComputedStyle(this.layerGroup.element),o=c.height!=""&&c.height!="auto",d=r.height!=""&&r.height!="auto";if(c.border&&(this._borderWidth=new Z(c.borderWidth).val),s)this._computedWidth=this.width,this._computedHeight=this.height;else if(o)this._computedWidth=parseInt(c.width,10),this._computedHeight=parseInt(c.height,10);else if(d)this._computedWidth=parseInt(r.width,10),this._computedHeight=parseInt(r.height,10);else return;this.layerGroup.refreshLayout(this.constructLayoutParams()),this.isStatic||(this.gestureEngine.config.maxRoamingBounds.updatePadding([-.333*this.currentLayer.rowHeight]),this.gestureParams.longpress.flickDistStart=.24*this.currentLayer.rowHeight,this.gestureParams.flick.startDist=.3*this.currentLayer.rowHeight,this.gestureParams.flick.dirLockDist=.35*this.currentLayer.rowHeight,this.gestureParams.flick.triggerDist=.75*this.currentLayer.rowHeight,this.gestureParams.longpress.flickDistFinal=.75*this.currentLayer.rowHeight)}constructLayoutParams(){var t,n;return{keyboardWidth:this._computedWidth-2*this._borderWidth,keyboardHeight:this._computedHeight-2*this._borderWidth-this.layerGroup.verticalPadding,widthStyle:this.layoutWidth,heightStyle:this.internalHeight,baseEmFontSize:this.getKeyEmFontSize(),layoutFontSize:new Z(this.layerGroup.element.style.fontSize),spacebarText:(n=(t=this.layoutKeyboardProperties)==null?void 0:t.displayName)!=null?n:"(System keyboard)"}}computedAdjustedOskHeight(t){if(!this.layerGroup)return t;let n=this.layerGroup.spec.layer,l=0;for(let r in n){let d=n[r].row.length,u=Math.floor(t/(d==0?1:d)),B=d*u;B>l&&(l=B)}return l+0}appendStyleSheet(){var t=this.layoutKeyboard,n=this.layoutKeyboardProperties;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet);var l=n==null?void 0:n.textFont,s=n==null?void 0:n.oskFont;this.styleSheetManager.addStyleSheetForFont(l,this.fontRootPath,this.device.OS),this.styleSheetManager.addStyleSheetForFont(s,this.fontRootPath,this.device.OS),this.config.specialFont&&this.styleSheetManager.addStyleSheetForFont(this.config.specialFont,"",this.device.OS);var c=this.addFontStyle(l,s);t!=null&&typeof t.oskStyling=="string"&&(c=c+t.oskStyling),c&&(this.styleSheet=st(c),this.styleSheetManager.linkStylesheet(this.styleSheet)),this.styleSheetManager.allLoadedPromise().then(()=>{this.layerGroup.resetPrecalcFontSizes(),this.refreshLayout()})}addFontStyle(t,n){let l="",s=a(c=>c.family.replace(/\u0022/g,"").replace(/,/g,'","'),"family");return(t||n)&&(l=`
.kmw-key-text {
  font-family: "${s(n||t)}";
}

.kmw-suggestion-text {
  font-family: "${s(t||n)}";
}
`),l}static buildDocumentationKeyboard(t,n,l,s,c,r){if(!t)return null;var o=typeof s=="undefined"?"desktop":s,d=typeof c=="undefined"?"default":c,u={};u.formFactor=o,o!="desktop"?(u.OS=W.OperatingSystem.iOS,u.touchable=!0):(u.OS=W.OperatingSystem.Windows,u.touchable=!1);let B=t.layout(o),b=new W("other",u.formFactor,u.OS,u.touchable),I=new mn({keyboard:t,keyboardMetadata:n,hostDevice:b,isStatic:!0,topContainer:null,pathConfig:l,styleSheetManager:null,specialFont:{family:"SpecialOSK",files:[`${l.resources}/osk/keymanweb-osk.ttf`],path:""}});I.layerGroup.element.className=I.kbdDiv.className,I.layerGroup.element.classList.add(u.formFactor+"-static");let F=I.kbdDiv.childNodes[0],h=document.createElement("div");h.classList.add(u.OS.toLowerCase(),u.formFactor),B!=null?(I.layerId=d,I.layerGroup.activeLayerId=d,I.setSize(800,r),I.fontSize=wo(b,r,!1),h.style.fontSize=I.element.style.fontSize,I.refreshLayout(),F.style.height=I.kbdDiv.style.height,F.style.maxHeight=I.kbdDiv.style.maxHeight):F.innerHTML="<p style='color:#c40; font-size:0.5em;margin:10px;'>No "+o+" layout is defined for "+t.name+".</p>",F.style.border="1px solid #ccc",I.updateState();let y=a(()=>R(this,null,function*(){if(document.contains(F))try{yield I.styleSheetManager.allLoadedPromise();let x=I.styleSheet;x&&F.appendChild(x);let U=[].concat(I.styleSheetManager.sheets);for(let p of U)p!=x&&(p.href||(I.styleSheetManager.unlink(p),document.head.appendChild(p)));I.refreshLayout(),I.styleSheet=null,I.shutdown()}finally{Q.disconnect()}}),"detectAndHandleInsertion"),Q=new MutationObserver(y);Q.observe(document.body,{childList:!0,subtree:!0}),h.append(F);for(let x of Ge.STYLESHEET_FILES){let U=`${l.resources}/osk/${x}`,p=I.styleSheetManager.linkExternalSheet(U,!0);p.parentNode.removeChild(p),h.appendChild(p)}return I.appendStyleSheet(),delete I._width,delete I._height,h}onHide(){this.hkKey&&this.highlightKey(this.hkKey,!1)}optionKey(t,n,l){n.indexOf("K_LOPT")>=0?this.emit("globekey",t,l):n.indexOf("K_ROPT")>=0&&l&&this.emit("hiderequested",t)}showGesturePreview(t){let n=this.keytip,l=this.constructLayoutParams(),s=l.keyboardWidth*t.key.spec.proportionalWidth,c=l.keyboardHeight/this.currentLayer.rows.length,r=new Ll(t,this.device.formFactor=="phone",s,c);return n==null?t.key.setPreview(r):n.show(t,!0,r),r.refreshLayout(),r}createKeyTip(){if(this.keytip==null)if(this.device.formFactor=="phone"){let t=this.isEmbedded;this.keytip=new bn(this,t)}else this.keytip=new Hl(this);this.keytip&&this.keytip.element&&this.element.appendChild(this.keytip.element)}createGlobeHint(){return this.config.embeddedGestureConfig.createGlobeHint?this.config.embeddedGestureConfig.createGlobeHint(this):null}shutdown(){var t;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet),this.activeGestures.forEach(n=>n.cancel()),this.gestureEngine&&this.gestureEngine.destroy(),this.deleting&&window.clearTimeout(this.deleting),(t=this.keytip)==null||t.show(null,!1,null)}lockLayer(t){this.layerLocked=t}raiseKeyEvent(t,n){if(t.kName=="K_LOPT"||t.kName=="K_ROPT")return this.optionKey(n,t.kName,!0),{};let l={},s=a((c,r)=>{var d,u;l.contextToken=(d=c==null?void 0:c.transcription)==null?void 0:d.token;let o=(u=c==null?void 0:c.transcription)==null?void 0:u.transform;l.alteredText=c&&(!o||Zt(o))},"keyEventCallback");return this.layerLocked&&(t.kNextLayer=this.layerId),this.emit("keyevent",t,s),l}};a(mn,"VisualKeyboard"),mn.specialCharacters=Ve.specialCharacters;var me=mn;var ur=class ur extends S.default{};a(ur,"Activator");var Oe=ur,Br=class Br extends Oe{get enabled(){return!0}set enabled(i){}get activate(){return!0}get conditionsMet(){return!0}};a(Br,"StaticActivator");var Lt=Br;var Ir=class Ir{constructor(){this.map=new Map}promiseForTouchpoint(i){return this.map.get(i)||this.map.set(i,new v),this.map.get(i)}maintainTouches(i){let t=Array.from(this.map.keys());for(let n=0;n<i.length;n++){let l=t.indexOf(i.item(n).identifier);l!=-1&&t.splice(l,1)}for(let n of t)this.map.get(n).resolve(),this.map.delete(n)}};a(Ir,"TouchEventPromiseMap");var Gn=Ir;function ea(g){let i="osk/";return g.isEmbedded&&(i=""),`${g.pathConfig.resources}/${i}`}a(ea,"getResourcePath");var bi=class bi extends S.default{constructor(t){var l;super();this.legacyEvents=new si;this.needsLayout=!0;this.touchEventPromiseManager=new Gn;this.activationListener=a(t=>{if(!this.mayDisable&&!this.activationModel.enabled){this.activationModel.off("activate",this.activationListener);try{this.activationModel.enabled=!0}finally{this.activationModel.on("activate",this.activationListener)}}this.commonCheckAndDisplay()},"activationListener");this.layerChangeHandler=a((t,n)=>{var l,s;return this.vkbd&&this.vkbd._UpdateVKShiftStyle(n),(this.vkbd&&this.vkbd.layerId!=n||t.value!=n)&&(l=this.vkbd)!=null&&l.layerGroup.getLayer(n)&&!((s=this.vkbd)!=null&&s.layerLocked)&&(this.vkbd.layerId=n),!1},"layerChangeHandler");this._Visible=!1;this.config=t=G({},t),(l=this.config).gestureParams||(l.gestureParams=sn),this.config.allowHideAnimations===void 0&&(this.config.allowHideAnimations=!0),this.config.device=t.device||t.hostDevice,this.config.isEmbedded=t.isEmbedded||!1,this.config.embeddedGestureConfig=t.embeddedGestureConfig||{},this.config.activator.on("activate",this.activationListener),this._Box=J("div"),this.kbdStyleSheetManager=new de(this._Box,this.config.doCacheBusting||!1),this.uiStyleSheetManager=new de(this._Box),this.bannerView=new rl,this.bannerView.events.on("bannerchange",()=>this.refreshLayout()),this._Box.appendChild(this.bannerView.element),this._bannerController=new an(this.bannerView,this.hostDevice,this.config.predictionContextManager),this.keyboardView=this._GenerateKeyboardView(null,null),this._Box.appendChild(this.keyboardView.element);let n=ea(this.config);for(let s of bi.STYLESHEET_FILES){let c=`${n}${s}`;this.uiStyleSheetManager.linkExternalSheet(c)}this.setBaseMouseEventListeners(),this.hostDevice.touchable&&this.setBaseTouchEventListeners(),this._Box.style.display="none"}get keyCodes(){return C.keyCodes}get modifierCodes(){return C.modifierCodes}get modifierBitmasks(){return C.modifierBitmasks}get stateBitmasks(){return C.stateBitmasks}get gestureParams(){return this.config.gestureParams}get configuration(){return this.config}get bannerController(){return this._bannerController}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get isEmbedded(){return this.config.isEmbedded}setBaseMouseEventListeners(){this._Box.onmouseenter=t=>{this.mouseEnterPromise&&this.mouseEnterPromise.resolve(),this.mouseEnterPromise=new v,this.emit("pointerinteraction",this.mouseEnterPromise.corePromise)},this._Box.onmouseleave=t=>{this.mouseEnterPromise.resolve(),this.mouseEnterPromise=null}}removeBaseMouseEventListeners(){this._Box.onmouseenter=null,this._Box.onmouseleave=null}setBaseTouchEventListeners(){let t=a(function(n){return n.cancelable&&n.preventDefault(),n.stopPropagation(),!1},"commonPrevention");this._boxBaseTouchEventCancel=n=>(this.touchEventPromiseManager.maintainTouches(n.touches),t(n)),this._boxBaseTouchStart=n=>{for(let l=0;l<n.changedTouches.length;l++){let s=this.touchEventPromiseManager.promiseForTouchpoint(n.changedTouches[l].identifier);this.emit("pointerinteraction",s.corePromise)}return this.touchEventPromiseManager.maintainTouches(n.touches),t(n)},this._Box.addEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.addEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchcancel",this._boxBaseTouchEventCancel,!1)}removeBaseTouchEventListeners(){this._boxBaseTouchEventCancel&&(this._Box.removeEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.removeEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchcancel",this._boxBaseTouchEventCancel,!1),this._boxBaseTouchEventCancel=null,this._boxBaseTouchStart=null)}get targetDevice(){return this.config.device}set targetDevice(t){this.allowsDeviceChange(t)?(this.config.device=t,this.loadActiveKeyboard()):console.error("May not change target device for this OSKView type.")}allowsDeviceChange(t){return!1}get activationModel(){return this.config.activator}set activationModel(t){if(!t)throw new Error("The activation model may not be set to null or undefined!");this.config.activator.off("activate",this.activationListener),t.on("activate",this.activationListener),this.config.activator=t,this.commonCheckAndDisplay()}get mayDisable(){var t;return!(this.hostDevice.touchable||(t=this.activeKeyboard)!=null&&t.keyboard.isCJK)}get displayIfActive(){return this.activationModel.enabled}commonCheckAndDisplay(){this.activationModel.activate&&this.activeKeyboard?this.present():this.startHide(!1)}get vkbd(){return this.keyboardView instanceof me?this.keyboardView:null}get banner(){return this.bannerView}get width(){return this._width}get height(){return this._height}get computedWidth(){return this.needsLayout&&this.refreshLayout(),this._computedWidth}get computedHeight(){return this.needsLayout&&this.refreshLayout(),this._computedHeight}get baseFontSize(){var t;return((t=this.parsedBaseFontSize)==null?void 0:t.styleString)||""}get parsedBaseFontSize(){return this._baseFontSize||(this._baseFontSize=bi.defaultFontSize(this.targetDevice,this.computedHeight,this.isEmbedded)),this._baseFontSize}static defaultFontSize(t,n,l){if(t.touchable){let s=t.formFactor=="phone"?1.6*(l?.65:.6)*1.2:2;return Z.special(s,"em")}else return n?Z.inPixels(n/8):void 0}get activeKeyboard(){return this.keyboardData}set activeKeyboard(t){var n;this.keyboardData=t,this.loadActiveKeyboard(),(n=this.keyboardData)!=null&&n.keyboard.isCJK&&(this.activationModel.enabled=!0)}computeFrameHeight(){var t,n;return(((t=this.headerView)==null?void 0:t.layoutHeight.val)||0)+(((n=this.footerView)==null?void 0:n.layoutHeight.val)||0)}setSize(t,n,l){let s=!1,c,r;!t&&t!==0||!n&&n!==0||(Number.isFinite(t)?c=Z.inPixels(t):c=new Z(t),Number.isFinite(n)?r=Z.inPixels(n):r=new Z(n),t&&n&&(s=!this._width||!this._height,s=s||c.styleString!=this._width.styleString,s=s||r.styleString!=this._height.styleString,this._width=c,this._height=r),this.needsLayout=this.needsLayout||s,this.refreshLayoutIfNeeded(l))}setNeedsLayout(){this.needsLayout=!0}batchLayoutAfter(t){if(this.deferLayout){t();return}try{this.deferLayout=!0,this.vkbd&&(this.vkbd.deferLayout=!0),t()}finally{this.deferLayout=!1,this.vkbd&&(this.vkbd.deferLayout=!1),this.refreshLayout()}}refreshLayout(t){var r,o;if(!this.keyboardView||this.deferLayout||!(this.width&&this.height))return;let l=this.width.absolute&&this.height.absolute,s=getComputedStyle(this._Box),c=s.height!=""&&s.height!="auto";if(l)this._computedWidth=this.width.val,this._computedHeight=this.height.val;else if(c){let d=this._Box.parentElement;this._computedWidth=this.width.val*(this.width.absolute?1:d.offsetWidth),this._computedHeight=this.height.val*(this.height.absolute?1:d.offsetHeight)}else{console.warn("Unable to properly perform layout - specification uses a relative spec, thus relies upon insertion into the DOM for layout.");return}if(this.needsLayout=!1,this.banner.element.style.fontSize=this.baseFontSize,this.vkbd&&(this.vkbd.fontSize=this.parsedBaseFontSize),t||((r=this.headerView)==null||r.refreshLayout(),this.bannerView.width=this.computedWidth,this.bannerView.refreshLayout(),(o=this.footerView)==null||o.refreshLayout()),this.vkbd){let d=this.computedHeight-this.computeFrameHeight();this.bannerView.height>0&&(d-=this.bannerView.height+5),this.vkbd.setSize(this.computedWidth,d,t);let u=this._Box.style;u.width=u.maxWidth=this.computedWidth+"px",u.height=u.maxHeight=this.computedHeight+"px"}else{let d=this._Box.style;d.width="auto",d.height="auto",d.maxWidth=d.maxHeight=""}}refreshLayoutIfNeeded(t){this.needsLayout&&this.refreshLayout(t)}postKeyboardLoad(){this._Visible=!1,this.postKeyboardAdjustments(),this.displayIfActive&&this.present()}loadActiveKeyboard(){var s,c,r,o,d;this.setBoxStyling(),this.needsLayout=!0;let t=this.keyboardView,n=this.kbdStyleSheetManager;this.kbdStyleSheetManager=new de(this._Box,this.config.doCacheBusting||!1);let l=this.keyboardView=this._GenerateKeyboardView((s=this.keyboardData)==null?void 0:s.keyboard,(c=this.keyboardData)==null?void 0:c.metadata);if(this._Box.replaceChild(l.element,t.element),l.postInsert(),(d=this.bannerController)==null||d.configureForKeyboard((r=this.keyboardData)==null?void 0:r.keyboard,(o=this.keyboardData)==null?void 0:o.metadata),t instanceof me&&t.shutdown(),n.unlinkAll(),this.banner.appendStyles(),this.vkbd){this.vkbd.createKeyTip();let u=this.vkbd.createGlobeHint();u&&this._Box.appendChild(u.element),this.vkbd.appendStyleSheet()}this.postKeyboardLoad()}_GenerateKeyboardView(t,n){let l=this.targetDevice;return this._Box.className="",t==null&&!l.touchable?new Rt:t&&t.layout(l.formFactor)?this._GenerateVisualKeyboard(t,n):!t||!n?this._GenerateVisualKeyboard(null,null):new gn(t)}_GenerateVisualKeyboard(t,n){let l=this.targetDevice,s=ea(this.config),c=new me({keyboard:t,keyboardMetadata:n,device:l,hostDevice:this.hostDevice,topContainer:this._Box,styleSheetManager:this.kbdStyleSheetManager,pathConfig:this.config.pathConfig,embeddedGestureConfig:this.config.embeddedGestureConfig,isEmbedded:this.config.isEmbedded,specialFont:{family:"SpecialOSK",files:[`${s}/keymanweb-osk.ttf`],path:""},gestureParams:this.config.gestureParams});return c.on("keyevent",(r,o)=>this.emit("keyevent",r,o)),c.on("globekey",(r,o)=>this.emit("globekey",r,o)),c.on("hiderequested",r=>{this.doHide(!0),this.emit("hiderequested",r)}),this._Box.className=l.formFactor+" "+l.OS.toLowerCase()+" kmw-osk-frame",c}present(){if(this.mayShow()){if(this.keyboardView.updateState(),this._Box.style.display="block",this.refreshLayoutIfNeeded(),this._Visible=!0,this._Box.style.opacity="1",this._Box.style.visibility=="hidden"){let t=this;window.setTimeout(function(){t._Box.style.visibility="visible"},0)}this.setDisplayPositioning()}}startHide(t){if(!this.mayHide(t))return;t&&(this.activationModel.enabled=!!(this.keyboardData.keyboard.isCJK||this.hostDevice.touchable));let n=null;this._Box&&this.hostDevice.touchable&&!(this.keyboardView instanceof Rt)&&this.config.allowHideAnimations?n=this.useHideAnimation():n=Promise.resolve(!0);let l=this;n.then(function(s){s&&l.finalizeHide()}),this.doHide(t)}finalizeHide(){if(!(document.body.className.indexOf("osk-always-visible")>=0&&this.hostDevice.formFactor=="desktop")){if(this._Box){let t=this._Box.style;t.display="none",t.transition="",t.opacity="1",this._Visible=!1}this.vkbd&&this.vkbd.onHide()}}mayShow(){return!(!this.activationModel.conditionsMet||!this.keyboardView||this.keyboardView instanceof Rt||!this.activationModel.enabled||!this._Box)}mayHide(t){return!(this.activationModel.conditionsMet&&!this.mayDisable||this.activationModel instanceof Lt||!t&&this.hostDevice.formFactor=="desktop"&&document.body.className.indexOf("osk-always-visible")>=0)}useHideAnimation(){let t=this._Box.style,n=this;return new Promise(function(l){let s=a(function(){return n._Box.removeEventListener("transitionend",s,!1),n._Box.removeEventListener("webkitTransitionEnd",s,!1),n._Box.removeEventListener("transitioncancel",s,!1),n._Box.removeEventListener("webkitTransitionCancel",s,!1),n._animatedHideTimeout!=0&&window.clearTimeout(n._animatedHideTimeout),n._animatedHideTimeout=0,n._Visible&&n.activationModel.conditionsMet?(t.transition="",t.opacity="1",l(!1),!1):(l(!0),!0)},"cleanup"),c=a(function(){n._Box.removeEventListener("transitionrun",c,!1),n._Box.removeEventListener("webkitTransitionRun",c,!1),n._Box.addEventListener("transitionend",s,!1),n._Box.addEventListener("webkitTransitionEnd",s,!1),n._Box.addEventListener("transitioncancel",s,!1),n._Box.addEventListener("webkitTransitionCancel",s,!1)},"startup");n._Box.addEventListener("transitionrun",c,!1),n._Box.addEventListener("webkitTransitionRun",c,!1),t.transition="opacity 0.5s linear 0",t.opacity="0",n._animatedHideTimeout=window.setTimeout(s,200)})}hideNow(){if(!this.mayHide(!1)||!this._Box)return;this._animatedHideTimeout&&(window.clearTimeout(this._animatedHideTimeout),this._animatedHideTimeout=0);let t=this._Box.style;t.transition="",t.opacity="0",this.finalizeHide()}shutdown(){this.removeBaseMouseEventListeners(),this.removeBaseTouchEventListeners();var t=this._Box;t.parentElement&&t.parentElement.removeChild(t),this.kbdStyleSheetManager.unlinkAll(),this.uiStyleSheetManager.unlinkAll(),this.bannerController.shutdown()}getRect(){var t={};return t.left=t.left=z(this._Box),t.top=t.top=D(this._Box),t.width=this.computedWidth,t.height=this.computedHeight,t}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}hide(){this.activationModel.enabled=!1,this.startHide(!0)}show(t){arguments.length>0?this.activationModel.enabled=t:this.activationModel.conditionsMet&&(this.activationModel.enabled=!this.activationModel.enabled)}doShow(t){this.legacyEvents.callEvent("show",t)}doHide(t){let n={HiddenByUser:t};this.legacyEvents.callEvent("hide",n)}addEventListener(t,n){this.legacyEvents.addEventListener(t,n)}removeEventListener(t,n){this.legacyEvents.removeEventListener(t,n)}};a(bi,"OSKView"),bi.STYLESHEET_FILES=["kmwosk.css","globe-hint.css"];var Ge=bi;var pn=class pn extends S.default{constructor(t){super();this.mouseCancellingHandler=a(function(t){return t.preventDefault(),t.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildTitleBar(),this.helpEnabled=!1,this.configEnabled=!1,t&&(this.element.onmousedown=t.mouseDownHandler)}get helpEnabled(){return this._helpEnabled}set helpEnabled(t){this._helpEnabled=t,this._helpButton.style.display=t?"inline":"none"}get configEnabled(){return this._configEnabled}set configEnabled(t){this._configEnabled=t,this._configButton.style.display=t?"inline":"none"}get layoutHeight(){return pn.DISPLAY_HEIGHT}get element(){return this._element}setPinCJKOffset(){this._unpinButton.style.left="15px"}showPin(t){this._unpinButton.style.display=t?"block":"none"}setTitle(t){this._caption.innerHTML=t}setTitleFromKeyboard(t){let n="<span style='font-weight:bold'>"+(t==null?void 0:t.name)+"</span>";this._caption.innerHTML=n}buildTitleBar(){let t=J("div");t.id="keymanweb_title_bar",t.className="kmw-title-bar";var n=this._caption=J("span");n.className="kmw-title-bar-caption",n.style.color="#fff",t.appendChild(n);var l=this._closeButton=this.buildCloseButton();return this._closeButton.onclick=()=>(this.emit("close"),!1),t.appendChild(l),l=this._helpButton=this.buildHelpButton(),this._helpButton.onclick=()=>(this.emit("help"),!1),t.appendChild(l),l=this._configButton=this.buildConfigButton(),this._configButton.onclick=()=>(this.emit("config"),!1),t.appendChild(l),l=this._unpinButton=this.buildUnpinButton(),this._unpinButton.onclick=()=>(this.emit("unpin"),!1),t.appendChild(l),t}buildCloseButton(){var t=J("div");return t.id="kmw-close-button",t.className="kmw-title-bar-image",t.onmousedown=this.mouseCancellingHandler,t}buildHelpButton(){let t=J("div");return t.id="kmw-help-image",t.className="kmw-title-bar-image",t.title="KeymanWeb Help",t.onmousedown=this.mouseCancellingHandler,t}buildConfigButton(){let t=J("div");return t.id="kmw-config-image",t.className="kmw-title-bar-image",t.title="KeymanWeb Configuration Options",t.onmousedown=this.mouseCancellingHandler,t}buildUnpinButton(){let t=J("div");return t.id="kmw-pin-image",t.className="kmw-title-bar-image",t.title="Pin the On Screen Keyboard to its default location on the active text box",t.onmousedown=this.mouseCancellingHandler,t}refreshLayout(){}};a(pn,"TitleBar"),pn.DISPLAY_HEIGHT=Z.inPixels(20);var hi=pn;var Cn=class Cn extends S.default{constructor(t){super();this.mouseCancellingHandler=a(function(t){return t.preventDefault(),t.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildResizeBar(),t&&(this._resizeHandle.onmousedown=t.mouseDownHandler)}get layoutHeight(){return Cn.DISPLAY_HEIGHT}get element(){return this._element}get handle(){return this._resizeHandle}allowResizing(t){this._resizeHandle.style.display=t?"block":"none"}buildResizeBar(){var t=J("div");t.className="kmw-footer",t.onmousedown=this.mouseCancellingHandler;var n=J("div");n.className="kmw-footer-caption",n.innerHTML='<a href="https://keyman.com/developer/keymanweb/">KeymanWeb</a>',n.id="keymanweb-osk-footer-caption",n.addEventListener("dblclick",s=>(this.emit("showbuild"),!1),!1),t.appendChild(n);var l=J("div");return l.className="kmw-footer-resize",t.appendChild(l),this._resizeHandle=l,t}refreshLayout(){}};a(Cn,"ResizeBar"),Cn.DISPLAY_HEIGHT=Z.inPixels(16);var Qn=Cn;var Fi=class Fi{constructor(i,t,n){this.x=i,this.y=t}static fromEvent(i){let t;if(window.TouchEvent&&i instanceof TouchEvent||i.changedTouches?t=i.changedTouches[0]:t=i,t.pageX)return new Fi(t.pageX,t.pageY,i);if(t.clientX){let n=t.clientX+document.body.scrollLeft,l=t.clientY+document.body.scrollTop;return new Fi(n,l,i)}else return new Fi(null,null,i)}};a(Fi,"InputEventCoordinate");var Jl=Fi,hr=class hr{constructor(i){this._VPreviousMouseMove=document.onmousemove,this._VPreviousMouseUp=document.onmouseup,this._VPreviousCursor=document.body.style.cursor,this._VPreviousMouseButton=typeof i.which=="undefined"?i.button:i.which}restore(){document.onmousemove=this._VPreviousMouseMove,document.onmouseup=this._VPreviousMouseUp,document.body.style.cursor&&(document.body.style.cursor=this._VPreviousCursor)}matchesCausingClick(i){return this._VPreviousMouseButton==(typeof i.which=="undefined"?i.button:i.which)}};a(hr,"MouseStartSnapshot");var br=hr,Fr=class Fr{constructor(i){this.startHandler=this._VMoveMouseDown.bind(this),this.cursorType=i}get enabled(){return this._enabled}set enabled(i){this._enabled=i}get isActive(){return!!this._mouseStartSnapshot}get mouseDownHandler(){return this.startHandler}_VMoveMouseDown(i){return!i||!this._enabled?!0:(this._mouseStartSnapshot||(this._mouseStartSnapshot=new br(i)),this._startCoord=Jl.fromEvent(i),document.onmousemove=this._VMoveMouseMove.bind(this),document.onmouseup=this._VMoveMouseUp.bind(this),document.body.style.cursor&&(document.body.style.cursor=this.cursorType),i.preventDefault(),i.cancelBubble=!0,this.onDragStart(),!1)}_VMoveMouseMove(i){if(!i||!this.enabled)return!0;if(i.preventDefault(),i.cancelBubble=!0,this._mouseStartSnapshot.matchesCausingClick(i)){let t=Jl.fromEvent(i),n=t.x-this._startCoord.x,l=t.y-this._startCoord.y;return this.onDragMove(n,l),!1}else return this._VMoveMouseUp(i)}_VMoveMouseUp(i){return i?(this._mouseStartSnapshot.restore(),this._mouseStartSnapshot=null,i.preventDefault(),i.cancelBubble=!0,this.onDragRelease(),!1):!0}};a(Fr,"MouseDragOperation");var yi=Fr;var yr=class yr extends Oe{constructor(){super(...arguments);this._enabled=!0;this.actValue=null}get activate(){return this._enabled&&!!this.actValue}checkState(t){this.activate!=t&&this.emit("activate",this.activate)}get enabled(){return this._enabled}set enabled(t){let n=this.activate;this._enabled=t,this.checkState(n)}get activationTrigger(){return this.actValue}set activationTrigger(t){let n=this.activate,l=this.actValue;this.actValue=t,this.checkState(n),l!=t&&this.emit("triggerchange",t)}get conditionsMet(){return!!this.activationTrigger}};a(yr,"TwoStateActivator");var It=yr;var mr=class mr extends ce{constructor(){super("KeymanWeb_OnScreenKeyboard")}loadWithDefaults(i){return G(G({},i),this.load())}load(){let i=super.load((t,n)=>{switch(n){case"version":return t;default:return Number.parseInt(t,10)}});return i.width||delete i.width,i.height||delete i.height,i}save(i){super.save(i)}};a(mr,"FloatingOSKCookieSerializer");var kl=mr;var Gr=class Gr extends Ge{constructor(t){t.activator=t.activator||new It;super(t);this.userPositioned=!1;this.specifiedPosition=!1;this.noDrag=!1;this.layoutSerializer=new kl;this.restorePosition=function(t){let n=this._Visible,l=new v;this.emit("dragmove",l.corePromise),this.loadPersistedLayout(),this.userPositioned=!1,t||(delete this.dfltX,delete this.dfltY),this.savePersistedLayout(),n&&this.present(),this.titleBar.showPin(!1),l.resolve(),this.doResizeMove()}.bind(this);this.typedActivationModel.on("triggerchange",()=>this.setDisplayPositioning()),document.body.appendChild(this._Box),this.titleBar=new hi(this.titleDragHandler),this.titleBar.on("help",()=>{this.legacyEvents.callEvent("helpclick",{})}),this.titleBar.on("config",()=>{this.legacyEvents.callEvent("configclick",{})}),this.titleBar.on("close",()=>this.startHide(!0)),this.titleBar.on("unpin",()=>this.restorePosition(!0)),this.resizeBar=new Qn(this.resizeDragHandler),this.resizeBar.on("showbuild",()=>this.emit("showbuild")),this.headerView=this.titleBar,this._Box.insertBefore(this.headerView.element,this._Box.firstChild);let n=a(c=>{let r=this.headerView;if(r&&r instanceof hi)switch(c){case"configclick":r.configEnabled=this.legacyEvents.listenerCount("configclick")>0;break;case"helpclick":r.helpEnabled=this.legacyEvents.listenerCount("helpclick")>0;break;default:return}},"onListenedEvent"),l=new li(this),s=new li(this.legacyEvents);for(let c of[l,s])c.on("listeneradded",n),c.on("listenerremoved",n);this.activeKeyboard&&this.postKeyboardAdjustments(),this.loadPersistedLayout()}get typedActivationModel(){return this.activationModel}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.zIndex="9999",t.display="none",t.width="auto",t.position="absolute"}postKeyboardAdjustments(){this.titleBar&&(this.enableMoveResizeHandlers(),this.activeKeyboard&&this.titleBar.setTitleFromKeyboard(this.activeKeyboard.keyboard),this.vkbd?(this.footerView=this.resizeBar,this._Box.appendChild(this.footerView.element)):(this.footerView&&this._Box.removeChild(this.footerView.element),this.footerView=null),this.loadPersistedLayout(),this.setNeedsLayout())}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}savePersistedLayout(){var t=this.getPos();let n={visible:this.displayIfActive?1:0,userSet:this.userPositioned?1:0,left:t.left,top:t.top,_version:K.CURRENT.toString()};this.vkbd&&(n.width=this.width.val,n.height=this.height.val),this.layoutSerializer.save(n)}loadPersistedLayout(){let t=this.layoutSerializer.loadWithDefaults({visible:1,userSet:0,left:-1,top:-1,_version:void 0,width:.3*screen.width,height:.15*screen.height});this.activationModel.enabled=t.visible==1,this.userPositioned=t.userSet==1,this.x=t.left,this.y=t.top;let n=t._version,l=n===void 0,s=t.width,c=t.height;s<.2*screen.width&&(s=.2*screen.width),c<.1*screen.height&&(c=.1*screen.height),s>.9*screen.width&&(s=.9*screen.width),c>.5*screen.height&&(c=.5*screen.height),(l||!n)&&(this.headerView&&this.headerView.layoutHeight.absolute&&(c+=this.headerView.layoutHeight.val),this.footerView&&this.footerView.layoutHeight.absolute&&(c+=this.footerView.layoutHeight.val)),this.setSize(s,c),(this.x==-1||this.y==-1||!this._Box)&&(this.userPositioned=!1),this.x<window.pageXOffset-.8*s&&(this.x=window.pageXOffset-.8*s),this.y<0&&(this.x=-1,this.y=-1,this.userPositioned=!1),this.userPositioned&&this._Box&&this.setPos({left:this.x,top:this.y})}getDefaultKeyboardHeight(){if(this.configuration.heightOverride)return this.configuration.heightOverride();var t=Math.floor(Math.min(screen.availHeight,screen.availWidth)/2),n=t;if(this.targetDevice.formFactor=="phone"){var l=Math.min(screen.height,screen.width),s=Math.max(screen.height,screen.width);he()?n=n*(s/l)/1.6:n=Math.floor(Math.max(screen.availHeight,screen.availWidth)/3)}return this.targetDevice.OS==W.OperatingSystem.iOS&&(n=n/Se(this.targetDevice.formFactor)),n}getDefaultWidth(){if(this.configuration.widthOverride)return this.configuration.widthOverride();var t;if(this.targetDevice.OS==W.OperatingSystem.iOS)t=window.innerWidth;else if(this.targetDevice.OS==W.OperatingSystem.Android)try{t=document.documentElement.clientWidth}catch(n){t=screen.availWidth}else t=screen.width;return t}doResizeMove(t){this.legacyEvents.callEvent("resizemove",t)}setRect(t){if(!(this._Box==null||this.targetDevice.formFactor!="desktop")){var n=this._Box,l=n.style;if("left"in t&&(this.x=t.left-z(n)+n.offsetLeft,l.left=this.x+"px",this.dfltX=l.left),"top"in t&&(this.y=t.top-D(n)+n.offsetTop,l.top=this.y+"px",this.dfltY=l.top),this.vkbd!=null){var s=this.vkbd.kbdDiv,c=s.style;if("width"in t){var r=t.width-(n.offsetWidth-s.offsetWidth);r<.2*screen.width&&(r=.2*screen.width),r>.9*screen.width&&(r=.9*screen.width),c.width=r+"px",this.setSize(r,this.computedHeight,!0)}if("height"in t){var o=t.height-(n.offsetHeight-s.offsetHeight);o<.1*screen.height&&(o=.1*screen.height),o>.5*screen.height&&(o=.5*screen.height),c.height=o+"px",c.fontSize=o/8+"px",this.setSize(this.computedWidth,o,!0)}"nosize"in t&&(this.resizingEnabled=!t.nosize)}"nomove"in t&&(this.noDrag=t.nomove,this.movementEnabled=!this.noDrag),this.savePersistedLayout()}}getPos(){var t=this._Box,n={left:this._Visible?t.offsetLeft:this.x,top:this._Visible?t.offsetTop:this.y};return n}setPos(t){if(typeof this._Box!="undefined"){if(this.userPositioned){var n=t.left,l=t.top;typeof n!="undefined"&&(n<-.8*this._Box.offsetWidth&&(n=-.8*this._Box.offsetWidth),this.userPositioned&&(this._Box.style.left=n+"px",this.x=n)),typeof l!="undefined"&&(l<0&&(l=0),this.userPositioned&&(this._Box.style.top=l+"px",this.y=l))}this.titleBar.showPin(this.userPositioned)}}setDisplayPositioning(){var t=this._Box.style;if(t.position="absolute",this.activationModel.activate&&(t.display="block"),t.left="0px",this.specifiedPosition||this.userPositioned)t.left=this.x+"px",t.top=this.y+"px";else{let n=this.typedActivationModel.activationTrigger||null;this.dfltX?t.left=this.dfltX:typeof n!="undefined"&&n!=null&&(t.left=z(n)+"px"),this.dfltY?t.top=this.dfltY:typeof n!="undefined"&&n!=null&&(t.top=D(n)+n.offsetHeight+"px")}this.specifiedPosition=!1}presentAtPosition(t,n){this.mayShow()&&(this.specifiedPosition=t>=0||n>=0,this.specifiedPosition&&(this.x=t,this.y=n),this.specifiedPosition=this.specifiedPosition||this.userPositioned,this.present())}present(){this.mayShow()&&(this.titleBar.showPin(this.userPositioned),super.present(),this.doShow({x:this._Box.offsetLeft,y:this._Box.offsetTop,userLocated:this.userPositioned}))}startHide(t){super.startHide(t),t&&this.savePersistedLayout()}show(t){t!==void 0?super.show(t):super.show(),this.savePersistedLayout()}userLocated(){return this.userPositioned}get movementEnabled(){return this.titleDragHandler.enabled}set movementEnabled(t){this.titleDragHandler.enabled=t,this.titleBar.showPin(t&&this.userPositioned)}get resizingEnabled(){return this.resizeDragHandler.enabled}set resizingEnabled(t){this.resizeDragHandler.enabled=t,this.resizeBar.allowResizing(t)}get isBeingMoved(){return this.titleDragHandler.isActive}get isBeingResized(){return this.resizeDragHandler.isActive}enableMoveResizeHandlers(){this.titleDragHandler.enabled=!this.noDrag,this.resizeDragHandler.enabled=!0}get titleDragHandler(){let t=this;return this._moveHandler?this._moveHandler:(this._moveHandler=new class extends yi{constructor(){super("move")}onDragStart(){this.startX=t._Box.offsetLeft,this.startY=t._Box.offsetTop,t.activeKeyboard.keyboard.isCJK&&t.titleBar.setPinCJKOffset(),this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new v,t.emit("dragmove",this.dragPromise.corePromise)}onDragMove(l,s){t.titleBar.showPin(!0),t.userPositioned=!0,t._Box.style.left=this.startX+l+"px",t._Box.style.top=this.startY+s+"px";var c=t.getRect();t.setSize(c.width,c.height,!0),t.x=c.left,t.y=c.top}onDragRelease(){t.vkbd&&(t.vkbd.currentKey=null),this.dragPromise.resolve(),this.dragPromise.then(()=>{t.userPositioned=!0,t.doResizeMove(),t.savePersistedLayout()}),this.dragPromise=null}},this._moveHandler)}get resizeDragHandler(){let t=this;return this._resizeHandler?this._resizeHandler:(this._resizeHandler=new class extends yi{constructor(){super("se-resize")}onDragStart(){this.startWidth=t.computedWidth,this.startHeight=t.computedHeight,this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new v,t.emit("resizemove",this.dragPromise.corePromise)}onDragMove(l,s){let c=this.startWidth+l,r=this.startHeight+s;c<.2*screen.width&&(c=.2*screen.width),r<.1*screen.height&&(r=.1*screen.height),c>.9*screen.width&&(c=.9*screen.width),r>.5*screen.height&&(r=.5*screen.height),t.setSize(c,r,!0)}onDragRelease(){t.vkbd&&(t.vkbd.currentKey=null),t.vkbd&&(this.startWidth=t.computedWidth,this.startHeight=t.computedHeight),t.refreshLayout(),this.dragPromise.resolve(),this.dragPromise.then(()=>{t.doResizeMove(),t.savePersistedLayout()}),this.dragPromise=null}},this._resizeHandler)}};a(Gr,"FloatingOSKView");var Pe=Gr;var pr=class pr extends Ge{constructor(t){t.isEmbedded?t.activator=t.activator||new Lt:t.activator=t.activator||new It;super(t);this.isResizing=!1;this.restorePosition=function(t){}.bind(this);document.body.appendChild(this._Box)}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.zIndex="9999",t.display="none",t.width="100%",t.position="fixed"}refreshLayout(t){if(!this.isResizing){try{this.isResizing=!0,this.doResize()}finally{this.isResizing=!1}super.refreshLayout(t)}}doResize(){if(this.vkbd){let t=this.getDefaultKeyboardHeight();this.setSize(this.getDefaultWidth(),t+this.banner.height)}}postKeyboardAdjustments(){this.doResize()}getDefaultKeyboardHeight(){var r,o;let t=this.targetDevice;if(this.configuration.heightOverride)return this.configuration.heightOverride();let n=(r=document==null?void 0:document.documentElement)==null?void 0:r.clientWidth,l=(o=document==null?void 0:document.documentElement)==null?void 0:o.clientHeight;if(typeof n=="undefined"&&(n=Math.min(screen.height,screen.width),l=Math.max(screen.height,screen.width),he())){let d=n;n=l,l=d}var s=Math.floor(Math.min(l,n)/2),c=s;return t.formFactor=="phone"&&(he()?c=Math.floor(l/1.6):c=Math.floor(l/2.4)),this.targetDevice.OS==W.OperatingSystem.iOS&&(c=c/Se(this.targetDevice.formFactor)),c}getDefaultWidth(){var l;let t=this.targetDevice;if(this.configuration.widthOverride)return this.configuration.widthOverride();var n;return n=(l=document==null?void 0:document.documentElement)==null?void 0:l.clientWidth,typeof n=="undefined"&&(this.targetDevice.OS==W.OperatingSystem.iOS?n=window.innerWidth:t.OS==W.OperatingSystem.Android?n=screen.availWidth:n=screen.width),n}setRect(t){}getPos(){var t=this._Box,n={left:this._Visible?t.offsetLeft:this.x,top:this._Visible?t.offsetTop:this.y};return n}setPos(t){}setDisplayPositioning(){let t=this._Box.style;this.vkbd&&(t.position="fixed",t.left=t.bottom="0px",t.border="none",t.borderTop="1px solid gray")}present(){super.present(),this.legacyEvents.callEvent("show",{})}};a(pr,"AnchoredOSKView");var mi=pr;var Cr=class Cr extends Oe{constructor(){super(...arguments);this.flag=!0}get enabled(){return this.flag}set enabled(t){this.activate=t}get activate(){return this.flag}set activate(t){this.flag!=t&&(this.flag=t,this.emit("activate",t))}get conditionsMet(){return!0}};a(Cr,"SimpleActivator");var Gi=Cr;var Qr=class Qr extends Ge{constructor(t){t.activator=t.activator||new Gi;super(t);this.restorePosition=function(t){}.bind(this)}get element(){return this._Box}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.display="none",t.position="relative"}postKeyboardAdjustments(){}getDefaultKeyboardHeight(){return this.keyboardView instanceof me?this.keyboardView.height:this.computedHeight}getDefaultWidth(){return this.computedWidth}setRect(t){}getPos(){var t=this._Box,n={left:this._Visible?t.offsetLeft:void 0,top:this._Visible?t.offsetTop:void 0};return n}setPos(t){}present(){super.present(),this.legacyEvents.callEvent("show",{})}setDisplayPositioning(){}allowsDeviceChange(t){return!0}};a(Qr,"InlinedOSKView");var pi=Qr;var Zr={};Vi(Zr,{AnchoredOSKView:()=>Un,FloatingOSKView:()=>xn,InlinedOSKView:()=>Ur});function xr(g){return{hostDevice:g.config.hostDevice,pathConfig:g.config.paths,predictionContextManager:g.contextManager.predictionContext,isEmbedded:!1}}a(xr,"buildBaseOskConfiguration");var Xr=class Xr extends mi{constructor(i,t){let n=G(G({},xr(i)),t||{});super(n)}};a(Xr,"PublishedAnchoredOSKView");var Un=Xr,Vr=class Vr extends Pe{constructor(i,t){let n=G(G({},xr(i)),t||{});super(n)}};a(Vr,"PublishedFloatingOSKView");var xn=Vr,Sr=class Sr extends pi{constructor(i,t){let n=G(G({},xr(i)),t||{});super(n)}};a(Sr,"PublishedInlineOSKView");var Ur=Sr;var Wr=class Wr extends lt{constructor(){super(...arguments);this.events=new S.default;this.changed=!1}focus(){let t=this.getElement();t.focus&&t.focus()}isForcingScroll(){return!1}dispatchInputEventOn(t){let n;window.InputEvent&&(n=new InputEvent("input",{bubbles:!0,cancelable:!1})),t&&n&&t.dispatchEvent(n)}};a(Wr,"OutputTarget");var P=Wr;var Ar=class Ar extends P{constructor(t){super();this.root=t,this._cachedSelectionStart=-1}get isSynthetic(){return!1}static isSupportedType(t){return t=="email"||t=="search"||t=="text"||t=="url"}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(t){this.setSelection(t,t,"none")}setSelection(t,n,l){let s=this.root.value._kmwCodePointToCodeUnit(t),c=this.root.value._kmwCodePointToCodeUnit(n);this.root.setSelectionRange(s,c,l),this.processedSelectionStart=t,this.processedSelectionEnd=n,this.forceScroll(),this.root.setSelectionRange(s,c,l)}forceScroll(){let t=this.getElement(),n=t.selectionStart,l=t.selectionEnd;this._activeForcedScroll=!0;try{t.blur(),t.focus()}finally{t.selectionStart=n,t.selectionEnd=l,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}setTextBeforeCaret(t){this.getCaret();let n=this.processedSelectionEnd-this.processedSelectionStart,l=this.getSelectionDirection(),s=t._kmwLength();this.root.value=t+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(s,s+n,l)}setTextAfterCaret(t){let n=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+t,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,n)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(t){if(t>0){let n=this.getTextBeforeCaret(),l=this.processedSelectionStart;t>l&&(t=l),this.adjustDeadkeys(-t),this.setTextBeforeCaret(n.kmwSubstring(0,l-t)),this.setCaret(l-t)}}insertTextBeforeCaret(t){if(!t)return;let n=this.getCaret(),l=this.getTextBeforeCaret(),s=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(t._kmwLength()),this.root.value=l+t+s,this.setCaret(n+t._kmwLength())}handleNewlineAtCaret(){let t=this.root;t&&(t.type=="search"||t.type=="submit")?(t.disabled=!1,t.form.submit()):this.events.emit("unhandlednewline",t)}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Ar,"Input");var je=Ar;var Rr=class Rr extends P{constructor(t){super();this.root=t,this._cachedSelectionStart=-1}get isSynthetic(){return!1}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(t){this.setSelection(t,t,"none")}setSelection(t,n,l){let s=this.root.value._kmwCodePointToCodeUnit(t),c=this.root.value._kmwCodePointToCodeUnit(n);this.root.setSelectionRange(s,c,l),this.processedSelectionStart=t,this.processedSelectionEnd=n,this.forceScroll(),this.root.setSelectionRange(s,c,l)}forceScroll(){let t=this.getElement(),n=t.selectionStart,l=t.selectionEnd;this._activeForcedScroll=!0;try{t.blur(),t.focus()}finally{t.selectionStart=n,t.selectionEnd=l,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}setTextBeforeCaret(t){this.getCaret();let n=this.processedSelectionEnd-this.processedSelectionStart,l=this.getSelectionDirection(),s=t._kmwLength();this.root.value=t+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(s,s+n,l)}setTextAfterCaret(t){let n=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+t,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,n)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(t){if(t>0){let n=this.getTextBeforeCaret(),l=this.processedSelectionStart;t>l&&(t=l),this.adjustDeadkeys(-t),this.setTextBeforeCaret(n.kmwSubstring(0,l-t)),this.setCaret(l-t)}}insertTextBeforeCaret(t){if(!t)return;let n=this.getCaret(),l=this.getTextBeforeCaret(),s=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(t._kmwLength()),this.root.value=l+t+s,this.setCaret(n+t._kmwLength())}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Rr,"TextArea");var Ci=Rr;var vr=class vr{constructor(i,t){this.node=i,this.offset=t}};a(vr,"SelectionCaret");var Zn=vr,Hr=class Hr{constructor(i,t){this.start=i,this.end=t}};a(Hr,"SelectionRange");var Xn=Hr,fr=class fr{constructor(i,t){this.cmd=i,this.stateType=t}};a(fr,"StyleCommand");var Ie=fr,Lr=class Lr extends P{constructor(t){super();if(this.root=t,t.contentWindow&&t.contentWindow.document&&t.contentWindow.document.designMode=="on")this.doc=t.contentWindow.document,this.docRoot=t.contentWindow.document.documentElement;else throw"Specified IFrame is not in design-mode!"}get isSynthetic(){return!1}getElement(){return this.root}focus(){this.doc.defaultView.focus()}isSelectionEmpty(){return this.hasSelection()?this.doc.getSelection().isCollapsed:!0}hasSelection(){let t=this.doc.getSelection(),n=document.getSelection();return n.anchorNode==t.anchorNode&&n.focusNode==t.focusNode,!0}clearSelection(){if(this.hasSelection()){let t=this.doc.getSelection();t.isCollapsed||t.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let t=this.doc.getSelection(),n=t.anchorNode.compareDocumentPosition(t.focusNode);if(t.isCollapsed){let l=new Zn(t.anchorNode,t.anchorOffset);return new Xn(l,l)}else{let l=new Zn(t.anchorNode,t.anchorOffset),s=new Zn(t.focusNode,t.focusOffset);return l.node==s.node&&(n=s.offset-l.offset>0?2:4),n&2?new Xn(l,s):new Xn(s,l)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let t=this.getCarets().start;return t.node.nodeType!=3?"":t.node.textContent.substr(0,t.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let t=this.getCarets().end;return t.node.nodeType!=3?"":t.node.textContent.substr(t.offset)}getText(){return this.docRoot.innerText}deleteCharsBeforeCaret(t){if(!this.hasSelection()||t<=0)return;let n=this.getCarets().start;if(t>n.offset&&(t=n.offset),n.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let l=this.doc.createRange(),s=n.offset-n.node.nodeValue.substr(0,n.offset)._kmwSubstr(-t).length;l.setStart(n.node,s),l.setEnd(n.node,n.offset),this.adjustDeadkeys(-t),l.deleteContents()}insertTextBeforeCaret(t){if(!this.hasSelection())return;let n=this.getCarets().start,l=t._kmwLength(),s=this.doc.getSelection();if(l==0)return;this.adjustDeadkeys(l);let c=this.root.ownerDocument.createRange();if(n.node.nodeType==3){let o=n.node;o.insertData(n.offset,t),c.setStart(o,n.offset+t.length)}else{var r=this.doc.createTextNode(t);let o=this.doc.createRange();o.setStart(n.node,n.offset),o.collapse(!0),o.insertNode(r),c.setStart(r,t.length)}c.collapse(!0),s.removeAllRanges();try{s.addRange(c)}catch(o){n.node.parentElement.scrollIntoView(),s.addRange(c)}s.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(t){if(!this.hasSelection())return;let n=this.getCarets().end;if(t._kmwLength()!=0)if(n.node.nodeType==3){let c=n.node;c.replaceData(n.offset,c.length,t)}else{var s=n.node.ownerDocument.createTextNode(t);let c=this.root.ownerDocument.createRange();c.setStart(n.node,n.offset),c.collapse(!0),c.insertNode(s)}}saveProperties(){var t=[new Ie("backcolor",1),new Ie("fontname",1),new Ie("fontsize",1),new Ie("forecolor",1),new Ie("bold",0),new Ie("italic",0),new Ie("strikethrough",0),new Ie("subscript",0),new Ie("superscript",0),new Ie("underline",0)];this.doc.defaultView&&t.push(new Ie("hilitecolor",1));for(var n=0;n<t.length;n++){let l=t[n];l.stateType==1?l.cache=this.doc.queryCommandValue(l.cmd):l.cache=this.doc.queryCommandState(l.cmd)}this.commandCache=t}restoreProperties(t){this.commandCache||console.error("No command cache exists to restore!");for(var n=0;n<this.commandCache.length;n++){let l=this.commandCache[n];l.stateType==1?this.doc.queryCommandValue(l.cmd)!=l.cache&&(t&&t(),this.doc.execCommand(l.cmd,!1,l.cache)):this.doc.queryCommandState(l.cmd)!=l.cache&&(t&&t(),this.doc.execCommand(l.cmd,!1,null))}}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Lr,"DesignIFrame");var j=Lr;var Jr=class Jr{constructor(i,t){this.node=i,this.offset=t}};a(Jr,"SelectionCaret");var Vn=Jr,kr=class kr{constructor(i,t){this.start=i,this.end=t}};a(kr,"SelectionRange");var Sn=kr,Nr=class Nr extends P{constructor(t){var i=(...args)=>{super(...args)};if(t.isContentEditable)i(),this.root=t;else throw"Specified element is not already content-editable!"}get isSynthetic(){return!1}getElement(){return this.root}isSelectionEmpty(){return this.hasSelection()?this.root.ownerDocument.getSelection().isCollapsed:!0}hasSelection(){let t=this.root.ownerDocument.getSelection();return!(this.root!=t.anchorNode&&!this.root.contains(t.anchorNode)||this.root!=t.focusNode&&!this.root.contains(t.focusNode))}clearSelection(){if(this.hasSelection()){let t=this.root.ownerDocument.getSelection();t.isCollapsed||t.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let t=this.root.ownerDocument.getSelection(),n=t.anchorNode.compareDocumentPosition(t.focusNode);if(t.isCollapsed){let l=new Vn(t.anchorNode,t.anchorOffset);return new Sn(l,l)}else{let l=new Vn(t.anchorNode,t.anchorOffset),s=new Vn(t.focusNode,t.focusOffset);return l.node==s.node&&(n=s.offset-l.offset>0?2:4),n&2?new Sn(l,s):new Sn(s,l)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let t=this.getCarets().start;return t.node.nodeType!=3?"":t.node.textContent.substr(0,t.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let t=this.getCarets().end;return t.node.nodeType!=3?"":t.node.textContent.substr(t.offset)}getText(){return this.root.innerText}deleteCharsBeforeCaret(t){if(!this.hasSelection()||t<=0)return;let n=this.getCarets().start;if(t>n.offset&&(t=n.offset),n.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let l=this.root.ownerDocument.createRange(),s=n.offset-n.node.nodeValue.substr(0,n.offset)._kmwSubstr(-t).length;l.setStart(n.node,s),l.setEnd(n.node,n.offset),this.adjustDeadkeys(-t),l.deleteContents()}insertTextBeforeCaret(t){if(!this.hasSelection())return;let n=this.getCarets().start,l=t._kmwLength(),s=this.root.ownerDocument.getSelection();if(l==0)return;this.adjustDeadkeys(l);let c=this.root.ownerDocument.createRange();if(n.node.nodeType==3){let o=n.node;o.insertData(n.offset,t),c.setStart(o,n.offset+t.length)}else{var r=n.node.ownerDocument.createTextNode(t);let o=this.root.ownerDocument.createRange();o.setStart(n.node,n.offset),o.collapse(!0),o.insertNode(r),c.setStart(r,t.length)}c.collapse(!0),s.removeAllRanges();try{s.addRange(c)}catch(o){n.node.parentElement.scrollIntoView(),s.addRange(c)}s.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(t){if(!this.hasSelection())return;let n=this.getCarets().end;if(t._kmwLength()!=0)if(n.node.nodeType==3){let c=n.node;c.replaceData(n.offset,c.length,t)}else{var s=n.node.ownerDocument.createTextNode(t);let c=this.root.ownerDocument.createRange();c.setStart(n.node,n.offset),c.collapse(!0),c.insertNode(s)}}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Nr,"ContentEditable");var Jt=Nr;function _(g,i){var t;return g?g.Window?i=="Window":(g.defaultView?t=g.defaultView[i]:g.ownerDocument&&(t=g.ownerDocument.defaultView[i]),t?g instanceof t:!1):!1}a(_,"nestedInstanceOf");function Nl(g){if(_(g,"HTMLInputElement"))return new je(g);if(_(g,"HTMLTextAreaElement"))return new Ci(g);if(_(g,"HTMLIFrameElement")){let i=g;return i.contentWindow&&i.contentWindow.document&&i.contentWindow.document.designMode=="on"?new j(i):g.isContentEditable?new Jt(g):null}else if(g.isContentEditable)return new Jt(g);return null}a(Nl,"wrapElement");var Yr=class Yr{constructor(){this.pending=!1;let i=this.bg=document.createElement("div"),t=document.createElement("div"),n=this.lt=document.createElement("div"),l=this.gr=document.createElement("div"),s=this.bx=document.createElement("div");i.className="kmw-wait-background",t.className="kmw-wait-box",this.dismiss=null,n.className="kmw-wait-text",l.className="kmw-wait-graphic",s.className="kmw-alert-close";let c=t.onmousedown=t.onclick=o=>{s.style.display=="block"&&(i.style.display="none",this.dismiss&&this.dismiss())};t.addEventListener("touchstart",c,!1);let r=i.onmousedown=i.onclick=o=>{o.preventDefault(),o.stopPropagation()};i.addEventListener("touchstart",r,!1),t.appendChild(s),t.appendChild(n),t.appendChild(l),i.appendChild(t),document.body.appendChild(i)}get rootElement(){return this.bg}wait(i){let t=this.bg;typeof t=="undefined"||t==null||(i?(this.pending=!0,window.setTimeout(()=>{this.pending&&(window.scrollTo(0,0),this.bx.style.display="none",this.lt.className="kmw-wait-text",this.lt.innerHTML=i,this.gr.style.display="block",t.style.display="block")},1e3)):this.pending&&(this.lt.innerHTML="",this.pending=!1,t.style.display="none"))}alert(i,t){let n=this.bg;this.bx.style.display="block",this.lt.className="kmw-alert-text",this.lt.innerHTML=i,this.gr.style.display="none",n.style.display="block",this.dismiss=arguments.length>1?t:null}shutdown(){this.bg.parentNode.removeChild(this.bg)}};a(Yr,"AlertHost");var bt=Yr;function Wn(){return document.readyState==="complete"?Promise.resolve():new Promise((g,i)=>{let t=a(()=>{window.removeEventListener("load",t),g()},"loadHandler");window.addEventListener("load",t)})}a(Wn,"whenDocumentReady");var Er=class Er extends Ji{initialize(t){this._options?this._options=G(G({},this._options),t):this._options=G({},t),super.initialize(t),this._options=t,this._ui=t.ui,this._attachType=t.attachType,Wn().then(()=>{var n;t.useAlerts&&!this.alertHost?this._alertHost=new bt:!t.useAlerts&&this.alertHost&&((n=this._alertHost)==null||n.shutdown(),this._alertHost=null)})}get options(){return this._options}get attachType(){return this._attachType}get alertHost(){return this._alertHost}set signalUser(t){(!t||t!=this.alertHost)&&this.alertHost.shutdown(),this._alertHost=t}debugReport(){let t=super.debugReport();return t.attachType=this.attachType,t.ui=this._ui,t.keymanEngine="app/browser",t}onRuleFinalization(t,n){let l=t.transcription.transform;Zt(l)||n instanceof P&&(n.changed=!0)}};a(Er,"BrowserConfiguration");var Yl=Er,ta=G({ui:"",attachType:"",useAlerts:!0},Xs);var Tr=class Tr{constructor(i,t,n){this.interface=i,this.keyboard=t}};a(Tr,"AttachmentInfo");var An=Tr;function _e(g){let i=g==null?void 0:g.target;return We(i)}a(_e,"eventOutputTarget");function We(g){var i;if(g==null)return null;if(g.body&&(g=g.body),g.nodeType==3&&(g=g.parentNode),_(g,"HTMLInputElement")){let t=g.type.toLowerCase();if(!(t=="text"||t=="search"))return null}return(i=g._kmwAttachment)==null?void 0:i.interface}a(We,"outputTargetForElement");var El=class El extends S.default{constructor(t,n){if(!t)throw new Error("Cannot attach to a null/undefined document");super();this.baseFont="";this.appliedFont="";this.embeddedPageContexts=[];this._inputList=[];this._sortedInputs=[];this._InputModeObserverCore=a(t=>{this.disableInputModeObserver();try{for(let n of t){let l=n.target;this.isAttached(l)&&(l._kmwAttachment.inputMode=l.inputMode,this.device.touchable&&(l.inputMode="none"))}}finally{this.enableInputModeObserver()}},"_InputModeObserverCore");this._EnablementMutationObserverCore=a(t=>{for(var n=0;n<t.length;n++){var l=t[n],s=l.oldValue?l.oldValue.indexOf("kmw-disabled")>=0:!1,c=l.target.className.indexOf("kmw-disabled")>=0;if(s&&!c?this._EnableControl(l.target):!s&&c&&this._DisableControl(l.target),!c&&l.attributeName=="readonly"){var r=l.oldValue?l.oldValue!=null:!1,o=l.target;if(o instanceof o.ownerDocument.defaultView.HTMLInputElement||o instanceof o.ownerDocument.defaultView.HTMLTextAreaElement){var d=o.readOnly;r&&!d?this._EnableControl(l.target):!r&&d&&this._DisableControl(l.target)}}}},"_EnablementMutationObserverCore");this._AutoAttachObserverCore=a(t=>{for(var n=[],l=[],s=0;s<t.length;s++){let o=t[s];for(var c=0;c<o.addedNodes.length;c++)n=n.concat(this._GetDocumentEditables(o.addedNodes[c]));for(c=0;c<o.removedNodes.length;c++)l=l.concat(this._GetDocumentEditables(o.removedNodes[c]))}for(var r=0;r<n.length;r++)this.isKMWInput(n[r])&&this._MutationAdditionObserved(n[r]);for(r=0;r<l.length;r++){let o=!1,d=l[r];if(d instanceof d.ownerDocument.defaultView.HTMLIFrameElement){for(let u=0;u<this.embeddedPageContexts.length;u++)if(this.embeddedPageContexts[u].options.owner==d){this.embeddedPageContexts[u].shutdown(),this.embeddedPageContexts.splice(u,1),o=!0;break}if(!o){for(let u=0;u<this._inputList.length;u++)if(this._inputList[u]==d){this.detachFromControl(d),this._inputList[u]==d&&this._inputList.splice(u,1);break}}}else this.isKMWInput(d)&&this._MutationRemovalObserved(d)}(n.length||l.length)&&(this.device.touchable?this.device.touchable&&window.setTimeout(()=>{this.listInputs()},1):this.listInputs())},"_AutoAttachObserverCore");this._MutationAdditionObserved=a(t=>{if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement){let n=a(()=>{window.setTimeout(()=>{this.attachToControl(t)},1)},"attachFunctor");t.addEventListener("load",n)}else this.attachToControl(t)},"_MutationAdditionObserved");this._MutationRemovalObserved=a(t=>{this.detachFromControl(t)},"_MutationRemovalObserved");this.options=n,this.document=t,this.stylesheetManager=new de(this.document.body)}get device(){return this.options.hostDevice}get window(){return this.document.defaultView}get inputList(){let t=this.embeddedPageContexts.map(n=>n.inputList).reduce((n,l)=>n.concat(l),[]);return[].concat(this._inputList).concat(t)}get sortedInputs(){return this._sortedInputs}install(t){this.manualAttach=t,this.baseFont=this.getBaseFont(),this.manualAttach||(this._SetupDocument(this.document.documentElement),this.listInputs()),this.options.owner||this.initMutationObservers(this.document,t)}setupElementAttachment(t){if(!t._kmwAttachment){let n=Nl(t);n||_(t,"HTMLIFrameElement")||console.warn("Could not create processing interface for newly-attached element!"),t._kmwAttachment=new An(n,null,this.device.touchable)}}clearElementAttachment(t){t._kmwAttachment=null}isKMWInput(t){if(t instanceof t.ownerDocument.defaultView.HTMLTextAreaElement)return!0;if(t instanceof t.ownerDocument.defaultView.HTMLInputElement){if(je.isSupportedType(t.type))return!0}else if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)try{if(t.contentWindow){let n=t.contentWindow.document;if(n)return!(this.device.touchable&&n.designMode.toLowerCase()=="on")}else return!!t._kmwAttachment}catch(n){console.warn("Error during attachment to / detachment from iframe: "),console.warn(n)}else if(t.isContentEditable)return!0;return!1}isAttached(t){if(t._kmwAttachment)return!0;if(_(t,"HTMLIFrameElement")){if(t.contentDocument==this.document)return!0;for(let l of this.embeddedPageContexts)if(l.isAttached(t))return!0}return!1}isKMWDisabled(t){let n=t.className;return t.readOnly?!0:!!(n&&n.indexOf("kmw-disabled")>=0)}enableInputElement(t){var n;this.isKMWDisabled(t)||(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement?this._AttachToIframe(t):(this.setupElementAttachment(t),t._kmwAttachment.inputMode=(n=t.inputMode)!=null?n:"text",this.disableInputModeObserver(),t.inputMode="none",this.enableInputModeObserver(),t.classList.add("keymanweb-font"),this._inputList.push(t),this.emit("enabled",t)))}disableInputElement(t){var l;if(t)if(t.ownerDocument.defaultView&&t instanceof t.ownerDocument.defaultView.HTMLIFrameElement||t instanceof HTMLIFrameElement)this._DetachFromIframe(t);else{if(this.isAttached(t)){let c=(l=t._kmwAttachment)==null?void 0:l.inputMode;this.disableInputModeObserver(),t.inputMode=c,this.enableInputModeObserver()}t.className.indexOf("keymanweb-font")>=0&&(t.className=t.className.replace("keymanweb-font","").trim());var n=this.inputList.indexOf(t);n>-1&&this._inputList.splice(n,1),this.emit("disabled",t)}}enableTouchElement(t){return this.isKMWDisabled(t)?(this.emit("disabled",t),!1):(this.isAttached(t)||this.setupElementAttachment(t),this.enableInputElement(t),!0)}disableTouchElement(t){if(this.isAttached(t)){let n=t._kmwAttachment.inputMode;this.disableInputModeObserver(),t.inputMode=n,this.enableInputModeObserver()}}_AttachToIframe(t){try{let n=t.contentWindow.document;if(n){if(n.designMode.toLowerCase()=="on")this.setupElementAttachment(t),n.body._kmwAttachment=t._kmwAttachment,this._inputList.push(t),this.emit("enabled",t);else if(this.embeddedPageContexts.filter(l=>l.document==n).length==0){let l=new El(n,A(G({},this.options),{owner:t}));this.embeddedPageContexts.push(l),l.on("enabled",s=>this.emit("enabled",s)),l.on("disabled",s=>this.emit("disabled",s)),l.install(this.manualAttach)}}}catch(n){}}_DetachFromIframe(t){let n=a(()=>{this.clearElementAttachment(t);let l=this._inputList.indexOf(t);l!=-1&&this._inputList.splice(l,1),this.emit("disabled",t)},"detachFromDesignIframe");try{let l=t.contentWindow.document;if(l){if(l.designMode.toLowerCase()=="on")l.body._kmwAttachment=null,n();else for(let s=0;s<this.embeddedPageContexts.length;s++)if(this.embeddedPageContexts[s].document==l){let c=this.embeddedPageContexts.splice(s,1)[0];c._ClearDocument(l.body),c.shutdown(),this.embeddedPageContexts.splice(s,1);break}}}catch(l){t._kmwAttachment&&n()}}attachToControl(t){var n=this.device.touchable;this.isAttached(t)&&!(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)||(this.isKMWInput(t)?this.isKMWDisabled(t)?this.emit("disabled",t):n?this.enableTouchElement(t):this.enableInputElement(t):n&&this.emit("disabled",t))}detachFromControl(t){(this.isAttached(t)||t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)&&(this.isKMWInput(t)&&(this.isKMWDisabled(t)||this._DisableControl(t)),this.clearElementAttachment(t))}_DisableControl(t){(this.isAttached(t)||t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)&&(this.device.touchable&&this.disableTouchElement(t),this.listInputs(),this.disableInputElement(t))}_EnableControl(t){this.isAttached(t)?(this.device.touchable?this.enableTouchElement(t):this.enableInputElement(t),this.listInputs()):_(t,"HTMLIFrameElement")&&this._AttachToIframe(t)}disableControl(t){this.isAttached(t)||console.warn("KeymanWeb is not attached to element "+t);var n=t.className;n.indexOf("kmw-disabled")<0&&(t.className=n?n+" kmw-disabled":"kmw-disabled")}enableControl(t){!this.isAttached(t)&&!_(t,"HTMLIFrameElement")&&console.warn("KeymanWeb is not attached to element "+t);var n=t.className,l=n.indexOf("kmw-disabled");l>=0&&(t.className=n.replace("kmw-disabled","").trim())}listInputs(){let t=[],n=document.getElementsByTagName("input"),l=document.getElementsByTagName("textarea");for(let c=0;c<n.length;c++)je.isSupportedType(n[c].type)&&n[c].className.indexOf("kmw-disabled")<0&&t.push({ip:n[c],x:z(n[c]),y:D(n[c])});for(let c=0;c<l.length;c++)l[c].className.indexOf("kmw-disabled")<0&&t.push({ip:l[c],x:z(l[c]),y:D(l[c])});t.sort((c,r)=>c.y!=r.y?c.y-r.y:c.x-r.x);let s=[];for(let c=0;c<t.length;c++)s.push(t[c].ip);this._sortedInputs=s}findNeighboringInput(t,n){var l,s=this.sortedInputs;if(s.length==0)return null;for(l=0;l<s.length&&s[l]!=t;l++);return l==s.length&&!n&&l--,l=n?l-1:l+1,l=l>=s.length?l-s.length:l,l=l<0?l+s.length:l,s[l]}_GetDocumentEditables(t){let n=[];if(t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement){let s=t.ownerDocument.defaultView;(t instanceof s.HTMLInputElement||t instanceof s.HTMLTextAreaElement||t instanceof s.HTMLIFrameElement)&&n.push(t)}if(t.getElementsByTagName){var l=a(function(s){return tl(t.getElementsByTagName(s))},"LiTmp");n=n.concat(l("INPUT"),l("TEXTAREA"),l("IFRAME"))}return t.querySelectorAll&&(n=n.concat(tl(t.querySelectorAll("[contenteditable]")))),t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement&&t.isContentEditable&&n.push(t),n}_SetupDocument(t){let n=this._GetDocumentEditables(t);for(var l=0;l<n.length;l++)this.attachToControl(n[l])}_ClearDocument(t){let n=this._GetDocumentEditables(t);for(var l=0;l<n.length;l++)this.detachFromControl(n[l])}initMutationObservers(t,n){if(typeof MutationObserver=="function"){var l=t.querySelector("body"),s;n||(s={childList:!0,subtree:!0},this.attachmentObserver=new MutationObserver(this._AutoAttachObserverCore),this.attachmentObserver.observe(l,s)),s={subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["class","readonly"]},this.enablementObserver=new MutationObserver(this._EnablementMutationObserverCore),this.enablementObserver.observe(l,s),this.inputModeObserver=new MutationObserver(this._InputModeObserverCore),this.enableInputModeObserver()}else console.warn("Your browser is outdated and does not support MutationObservers, a web feature needed by KeymanWeb to support dynamically-added elements.")}enableInputModeObserver(){var l;let t=document.querySelector("body"),n={subtree:!0,attributes:!0,attributeFilter:["inputmode"]};(l=this.inputModeObserver)==null||l.observe(t,n)}disableInputModeObserver(){var t;(t=this.inputModeObserver)==null||t.disconnect()}getBaseFont(){var t=document.getElementsByTagName("input"),n=document.getElementsByTagName("textarea"),l=0,s,c="Arial,sans-serif";if(t.length==0&&n.length==0)l=0;else if(t.length>0&&n.length==0)l=1;else if(t.length==0&&n.length>0)l=2;else{var r=t[0],o=n[0];r.offsetTop<o.offsetTop?l=1:r.offsetTop>o.offsetTop?l=2:r.offsetLeft<o.offsetLeft?l=1:r.offsetLeft>o.offsetLeft&&(l=2)}switch(l){case 0:s=c;break;case 1:s=getComputedStyle(t[0]).fontFamily||"";break;case 2:s=getComputedStyle(n[0]).fontFamily||"";break}return(typeof s=="undefined"||s=="monospace")&&(s=c),s}buildAttachmentFontStyle(t){let n=t,l=this.baseFont;n&&typeof n.family!="undefined"&&(l=n.family),l=l.replace(/\u0022/g,"");var s=new RegExp("\\s?"+l+",?"),c=this.appliedFont.replace(/\u0022/g,"");c=c.replace(s,""),c=c.replace(/,$/,""),c==""?c=l:c=l+","+c,c='"'+c.replace(/\,\s?/g,'","')+'"';let r=`.keymanweb-font{
font-family:`+c+` !important;
}
`;return this.appliedFont=c,r}setAttachmentFont(t,n,l){this.stylesheetManager.unlinkAll(),this.stylesheetManager.addStyleSheetForFont(t,n,l),this.stylesheetManager.linkStylesheet(st(this.buildAttachmentFontStyle(t)))}shutdown(){var t,n,l,s;try{(t=this.enablementObserver)==null||t.disconnect(),(n=this.attachmentObserver)==null||n.disconnect(),(l=this.inputModeObserver)==null||l.disconnect(),(s=this.stylesheetManager)==null||s.unlinkAll(),this.inputModeObserver=null,this.embeddedPageContexts.forEach(c=>{try{c.shutdown()}catch(r){}});for(let c of this.inputList)try{this.detachFromControl(c)}catch(r){this.emit("disabled",c)}this._inputList=[]}catch(c){console.error("Error occurred during shutdown"),console.error(c)}}};a(El,"PageContextAttachment");var Rn=El;var Mr=class Mr{constructor(i,t){this.activationPending=i,this.activated=t}};a(Mr,"FocusStateAPIObject");var wr=Mr,Kr=class Kr extends S.default{constructor(t){super();this._maintainingFocus=!1;this.restoringFocus=!1;this._IgnoreNextSelChange=0;this.isTargetForcingScroll=t}get maintainingFocus(){return this._maintainingFocus}set maintainingFocus(t){let n=this._maintainingFocus;this._maintainingFocus=t,n&&!t&&this.emit("maintainingfocusend")}getUIState(){return new wr(this.maintainingFocus,this.restoringFocus)}setMaintainingFocus(t){this.maintainingFocus=!!t}setFocusTimer(){this.focusing=!0,this.focusTimer=window.setTimeout(()=>{this.focusing=!1},50)}};a(Kr,"FocusAssistant");var Tl=Kr;function ia(g,i){let t=i!=null&&i.isRTL?"rtl":"ltr";g&&(g instanceof g.ownerDocument.defaultView.HTMLInputElement||g instanceof g.ownerDocument.defaultView.HTMLTextAreaElement?g.value.length==0&&(g.dir=t):typeof g.textContent=="string"&&g.textContent.length==0&&(g.dir=t))}a(ia,"_SetTargDir");var wl=class wl extends Ni{constructor(t,n){super(t);this.cookieManager=new ce("KeymanWeb_Keyboard");this.focusAssistant=new Tl(()=>{var t;return(t=this.activeTarget)==null?void 0:t.isForcingScroll()});this.domEventTracker=new Ze;this._ControlFocus=a(t=>{let n=_e(t);return n&&this.setActiveTarget(n,!0),!0},"_ControlFocus");this._ControlBlur=a(t=>{if(this.focusAssistant._IgnoreNextSelChange)return this.focusAssistant._IgnoreNextSelChange--,t.cancelBubble=!0,t.stopPropagation(),!0;if(this.focusAssistant.isTargetForcingScroll())return t.cancelBubble=!0,t.stopPropagation(),!0;let n=_e(t);if(n==null)return!0;this.lastActiveTarget&&this._BlurKeyboardSettings(this.lastActiveTarget.getElement());let l=this.activeTarget;this.currentTarget=null,(l||this.lastActiveTarget)&&(this.mostRecentTarget=n),this.focusAssistant.restoringFocus=!1;let s=this.activeKeyboard,c=this.focusAssistant.maintainingFocus;return!c&&s&&s.keyboard.notify(0,n,0),l&&!this.activeTarget&&this.emit("targetchange",null),this.apiEvents.callEvent("controlblurred",{target:n.getElement(),event:t,isActivating:c}),this.doChangeEvent(n),this.resetContext(),!0},"_ControlBlur");this._Click=a(t=>(this.resetContext(),!0),"_Click");this.nonKMWTouchHandler=a(t=>{this.focusAssistant.focusing=!1,clearTimeout(this.focusAssistant.focusTimer),this.forgetActiveTarget()},"nonKMWTouchHandler");this._eventsObj=n,this.page=new Rn(window.document,{hostDevice:this.engineConfig.hostDevice}),this.focusAssistant.on("maintainingfocusend",()=>{!this.activeTarget&&this.mostRecentTarget&&this.emit("targetchange",this.activeTarget)})}get apiEvents(){return this._eventsObj()}initialize(){this.on("keyboardasyncload",(t,n)=>{var l;(l=this.engineConfig.alertHost)==null||l.wait("Installing keyboard<br/>"+t.name),n.then(()=>{var s;(s=this.engineConfig.alertHost)==null||s.wait()})}),this.engineConfig.deferForInitialization.then(()=>{let t=this.engineConfig.hostDevice,n=a(l=>l.stopPropagation(),"noPropagation");this.page.on("enabled",l=>{if(!(l._kmwAttachment.interface instanceof j))t.touchable&&(this.domEventTracker.detachDOMEvent(l,"touchstart",this.nonKMWTouchHandler),this.domEventTracker.attachDOMEvent(l,"touchmove",n,!1),this.domEventTracker.attachDOMEvent(l,"touchend",n,!1)),this.domEventTracker.attachDOMEvent(l,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(l,"blur",this._ControlBlur),this.domEventTracker.attachDOMEvent(l,"click",this._Click);else{var s=l.contentWindow.document;t.browser=="firefox"?(this.domEventTracker.attachDOMEvent(s,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s,"blur",this._ControlBlur)):(this.domEventTracker.attachDOMEvent(s.body,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s.body,"blur",this._ControlBlur))}l.ownerDocument.activeElement==l&&this.setActiveTarget(We(l),!0)}),this.page.on("disabled",l=>{var c;if(!_(l,"HTMLIFrameElement"))t.touchable&&this.domEventTracker.attachDOMEvent(l,"touchstart",this.nonKMWTouchHandler,!1),this.domEventTracker.detachDOMEvent(l,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(l,"blur",this._ControlBlur),this.domEventTracker.detachDOMEvent(l,"click",this._Click);else{let r=l.contentWindow.document;t.browser=="firefox"?(this.domEventTracker.detachDOMEvent(r,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(r,"blur",this._ControlBlur)):(this.domEventTracker.detachDOMEvent(r.body,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(r.body,"blur",this._ControlBlur))}var s=(c=this.mostRecentTarget)==null?void 0:c.getElement();s&&s==l&&this.forgetActiveTarget()}),this.page.install(this.engineConfig.attachType=="manual")})}get activeTarget(){let t=this.focusAssistant.maintainingFocus;return this.currentTarget||(t?this.mostRecentTarget:null)}get lastActiveTarget(){return this.mostRecentTarget}deactivateCurrentTarget(){let t=this.activeTarget||this.lastActiveTarget;t&&this.page.isAttached(t.getElement())&&this._BlurKeyboardSettings(t.getElement()),this.activeTarget||this.setActiveTarget(null,!0)}forgetActiveTarget(){this.focusAssistant.maintainingFocus=!1,this.focusAssistant.restoringFocus=!1;let t=this.activeTarget||this.mostRecentTarget;t&&this._BlurKeyboardSettings(t.getElement()),this.setActiveTarget(null,!0),t==this.lastActiveTarget&&(this.mostRecentTarget=null)}setActiveTarget(t,n){var o;let l=this.mostRecentTarget,s=this.activeTarget;if(t==s){s&&(this.currentTarget=s);return}let c=!!l;if(this.currentTarget=this.mostRecentTarget=t,this.predictionContext.setCurrentTarget(t),this.focusAssistant.restoringFocus?this._BlurKeyboardSettings(t.getElement()):t&&this._FocusKeyboardSettings(t.getElement(),!c),this._CommonFocusHelper(t))return;let r=t==null?void 0:t.getElement();if(t instanceof j&&(r=t.docRoot),r&&r.ownerDocument&&r instanceof r.ownerDocument.defaultView.HTMLElement&&ia(r,(o=this.activeKeyboard)==null?void 0:o.keyboard),t!=s&&this.emit("targetchange",t),n){let d=l==null?void 0:l.getElement();l instanceof j&&(d=l.docRoot),r?this.apiEvents.callEvent("controlfocused",{target:r,activeControl:d}):d&&this.apiEvents.callEvent("controlblurred",{target:d,event:null,isActivating:this.focusAssistant.maintainingFocus})}}get activeKeyboard(){return this._activeKeyboard}restoreLastActiveTarget(){this.mostRecentTarget&&(this.focusAssistant.restoringFocus=!0,this.mostRecentTarget.focus(),this.focusAssistant.restoringFocus=!1)}insertText(t,n,l){this.restoreLastActiveTarget();let s=this.activeTarget;return s==null&&this.mostRecentTarget&&(s=this.activeTarget),s!=null?super.insertText(t,n,l):!1}currentKeyboardSrcTarget(){let t=this.currentTarget||this.mostRecentTarget;return this.isTargetKeyboardIndependent(t)?t:null}isTargetKeyboardIndependent(t){let n=t==null?void 0:t.getElement()._kmwAttachment;return!!(n!=null&&n.keyboard||(n==null?void 0:n.keyboard)==="")}activateKeyboardForTarget(t,n){var s,c;let l=n==null?void 0:n.getElement()._kmwAttachment;if(l?(l.keyboard=(s=t==null?void 0:t.metadata.id)!=null?s:"",l.languageCode=(c=t==null?void 0:t.metadata.langId)!=null?c:""):this.globalKeyboard=t,this.currentKeyboardSrcTarget()==n){this._activeKeyboard=t;let r=t==null?void 0:t.metadata;this.page.setAttachmentFont(r==null?void 0:r.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS)}}setKeyboardForTarget(t,n,l){if(t instanceof j){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}let s=t.getElement()._kmwAttachment,c=this.currentKeyboardSrcTarget()==t;if(s){if(s.keyboard=n||null,s.languageCode=l||null,c||this.currentKeyboardSrcTarget()==t){let r=this.globalKeyboard.metadata;this.activateKeyboard(s.keyboard||r.id,s.languageCode||r.langId,!0)}}else return}getKeyboardStubForTarget(t){if(this.isTargetKeyboardIndependent(t)){let n=t.getElement()._kmwAttachment;return this.keyboardCache.getStub(n.keyboard,n.languageCode)}else return this.globalKeyboard.metadata}getFallbackStubKey(){let t={id:"",langId:""};return this.engineConfig.hostDevice.touchable&&this.keyboardCache.defaultStub||t}activateKeyboard(t,n,l){return R(this,null,function*(){var c,r,o,d,u,B;l||(l=!1);let s=this.currentKeyboardSrcTarget();this.engineConfig.deferForInitialization.isFulfilled||(yield this.engineConfig.deferForInitialization.corePromise),t||(t=this.getFallbackStubKey().id,n=this.getFallbackStubKey().langId);try{let b=yield kn(wl.prototype,this,"activateKeyboard").call(this,t,n,l);return(c=this.engineConfig.alertHost)==null||c.wait(),l&&!s&&this.cookieManager.save({current:`${t}:${n}`}),s==this.currentKeyboardSrcTarget()&&(ia((r=this.currentTarget)==null?void 0:r.getElement(),this.keyboardCache.getKeyboard(t)),this.page.setAttachmentFont((d=(o=this.activeKeyboard)==null?void 0:o.metadata)==null?void 0:d.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS),this.restoreLastActiveTarget()),b}catch(b){let I=a(()=>R(this,null,function*(){let h=this.getFallbackStubKey();h.id!=t&&(yield this.activateKeyboard(h.id,h.langId,!0).catch(()=>{}))}),"fallback");(u=this.engineConfig.alertHost)==null||u.wait();let F=(b==null?void 0:b.message)||"Sorry, the "+t+" keyboard for "+n+" is not currently available.";throw b instanceof pt?console.error(b||F):console.warn(b||F),this.engineConfig.alertHost?(B=this.engineConfig.alertHost)==null||B.alert(F,I):yield I(),b}})}_BlurKeyboardSettings(t,n,l){var r;var s=this.activeKeyboard?this.activeKeyboard.keyboard.id:"",c=(r=this.activeKeyboard)==null?void 0:r.metadata.langId;n!==void 0&&l!==void 0&&(s=n,c=l),t&&t._kmwAttachment.keyboard!=null?(t._kmwAttachment.keyboard=s,t._kmwAttachment.languageCode=c):this.globalKeyboard=this.activeKeyboard}_FocusKeyboardSettings(t,n){var c;let l=t._kmwAttachment,s=this.globalKeyboard;l.keyboard!=null?this.activateKeyboard(l.keyboard,l.languageCode,!0):!n&&(s==null?void 0:s.metadata)!=((c=this._activeKeyboard)==null?void 0:c.metadata)&&this.activateKeyboard(s==null?void 0:s.metadata.id,s==null?void 0:s.metadata.langId,!0)}_CommonFocusHelper(t){var s;let n=this.focusAssistant,l=(s=this.activeKeyboard)==null?void 0:s.keyboard;return n.restoringFocus||(t==null||t.deadkeys().clear(),l==null||l.notify(0,t,1)),!n.restoringFocus&&this.mostRecentTarget!=t&&(n.maintainingFocus=!1),n.restoringFocus=!1,this.resetContext(),!1}doChangeEvent(t){if(t.changed){let n=new Event("change",{bubbles:!0,cancelable:!1});t.getElement().dispatchEvent(n)}t.changed=!1}getSavedKeyboardRaw(){var n=new ce("KeymanWeb_Keyboard").load(decodeURIComponent);return typeof n.current!="string"||n.current=="Keyboard_us:eng"?"Keyboard_us:en":n.current}getSavedKeyboard(){let t=this.getSavedKeyboardRaw(),n=this.keyboardCache.getStubList(),l;for(let s=0;s<n.length;s++)if(l=n[s].KI+":"+n[s].KLC,l==t)return l;for(let s=0;s<n.length;s++)if(l=n[s].KI+":"+n[s].KLC,l=="Keyboard_us:en")return l;return n.length>0?n[0].KI+":"+n[0].KLC:"Keyboard_us:en"}restoreSavedKeyboard(t){let l=t.split(":");l.length<2&&(l[1]=""),(this.keyboardCache.getStub(l[0],l[1])||this.keyboardCache.defaultStub)&&this.activateKeyboard(l[0],l[1])}shutdown(){this.page.shutdown(),this.domEventTracker.shutdown()}};a(wl,"ContextManager");var vn=wl;var zr=class zr extends Ae{constructor(t){super();this.contextManager=t}isCommand(t){switch(this.codeForEvent(t)){case C.keyCodes.K_TAB:case C.keyCodes.K_TABBACK:case C.keyCodes.K_TABFWD:return!0;default:return super.isCommand(t)}}applyCommand(t,n){let l=this.codeForEvent(t),s=a(c=>{var u;let r=this.contextManager,o=(u=r.activeTarget)==null?void 0:u.getElement(),d=r.page.findNeighboringInput(o,c);d==null||d.focus()},"moveToNext");switch(l){case C.keyCodes.K_TAB:s((t.Lmodifiers&m.K_SHIFTFLAG)!=0);break;case C.keyCodes.K_TABBACK:s(!0);break;case C.keyCodes.K_TABFWD:s(!1);break}super.applyCommand(t,n)}};a(zr,"DefaultBrowserRules");var Hn=zr;function Dr(g){return g.keyCode?g.keyCode:g.which?g.which:null}a(Dr,"_GetEventKeyCode");function Ml(g,i,t){if(g.cancelBubble===!0)return null;let n=Dr(g);if(n==null)return null;var l=i.modStateFlags,s=0,c=!1,r=!1;let o=C.keyCodes;switch(n){case o.K_CTRL:case o.K_LCTRL:case o.K_RCTRL:case o.K_CONTROL:case o.K_LCONTROL:case o.K_RCONTROL:c=!0;break;case o.K_LMENU:case o.K_RMENU:case o.K_ALT:case o.K_LALT:case o.K_RALT:r=!0;break}s|=g.getModifierState("Shift")?16:0,g.getModifierState("Control")&&(s|=g.location!=0&&c?g.location==1?m.LCTRLFLAG:m.RCTRLFLAG:l&3),g.getModifierState("Alt")&&(s|=g.location!=0&&r?g.location==1?m.LALTFLAG:m.RALTFLAG:l&12);let d=0;d|=g.getModifierState("CapsLock")?m.CAPITALFLAG:m.NOTCAPITALFLAG,d|=g.getModifierState("NumLock")?m.NUMLOCKFLAG:m.NOTNUMLOCKFLAG,d|=g.getModifierState("ScrollLock")?m.SCROLLFLAG:m.NOTSCROLLFLAG,s|=d;let u=i.modStateFlags!=s;i.modStateFlags=s;let B=m.RALTFLAG|m.LCTRLFLAG;(l&B)==B&&(s&B)!=B&&(s&=~B),s&m.RALTFLAG&&(s&=~m.LCTRLFLAG);let b=C.modifierBitmasks,I=i.activeKeyboard,F;I&&I.isChiral?(F=s&b.CHIRAL,I.emulatesAltGr&&(F&b.ALT_GR_SIM)==b.ALT_GR_SIM&&(F^=b.ALT_GR_SIM,F|=m.RALTFLAG)):F=s&16|(s&(m.LCTRLFLAG|m.RCTRLFLAG)?32:0)|(s&(m.LALTFLAG|m.RALTFLAG)?64:0),F|=g.metaKey?m.K_METAFLAG:0,t.browser==W.Browser.Firefox&&ie.browserMap.FF["k"+n]&&(n=ie.browserMap.FF["k"+n]);let h=new te({device:t,kName:"",Lcode:n,Lmodifiers:F,Lstates:d,LmodifierChange:u,isSynthetic:!1}),y=typeof g.charCode!="undefined"&&g.charCode!=null&&(g.charCode==0||(F&111)!=0);h.LisVirtualKey=y||g.type!="keypress",h=Ss(h,I,i.baseLayout);let Q=new te(h);return Q.source=g,Q}a(Ml,"preprocessKeyboardEvent");var Or=class Or extends Ot{constructor(t,n,l){super();this.domEventTracker=new Ze;this.swallowKeypress=!1;this._KeyDown=a(t=>{var c;let n=this.contextManager.activeKeyboard,l=_e(t);if(!l||n==null)return!0;let s=l.getElement();return((c=s==null?void 0:s.getAttribute("class"))==null?void 0:c.indexOf("kmw-disabled"))>=0?!0:this.keyDown(t)},"_KeyDown");this._KeyPress=a(t=>{var l;return!_e(t)||((l=this.contextManager.activeKeyboard)==null?void 0:l.keyboard)==null?!0:this.keyPress(t)},"_KeyPress");this._KeyUp=a(t=>{let n=_e(t);var l=Ml(t,this.processor,this.hardDevice);if(l==null||n==null)return!0;var s=n.getElement();if(l.Lcode==13){var c=!1;if(_(s,"HTMLTextAreaElement")&&(c=!0),!c)return s instanceof s.ownerDocument.defaultView.HTMLInputElement&&(s.form&&(s.type=="search"||s.type=="submit")?s.form.submit():this.contextManager.page.findNeighboringInput(s,!1).focus()),!0}return this.keyUp(t)},"_KeyUp");this.hardDevice=t,this.contextManager=l,this.processor=n;let s=l.page,c=this.domEventTracker;s.on("enabled",r=>{let o=We(r);if(!(o instanceof j))c.attachDOMEvent(r,"keypress",this._KeyPress),c.attachDOMEvent(r,"keydown",this._KeyDown),c.attachDOMEvent(r,"keyup",this._KeyUp);else{let d=o.getElement().contentDocument;c.attachDOMEvent(d.body,"keydown",this._KeyDown),c.attachDOMEvent(d.body,"keypress",this._KeyPress),c.attachDOMEvent(d.body,"keyup",this._KeyUp)}}),s.on("disabled",r=>{let o=We(r);if(!(o instanceof j))c.detachDOMEvent(r,"keypress",this._KeyPress),c.detachDOMEvent(r,"keydown",this._KeyDown),c.detachDOMEvent(r,"keyup",this._KeyUp);else{let d=o.getElement().contentDocument;c.detachDOMEvent(d.body,"keydown",this._KeyDown),c.detachDOMEvent(d.body,"keypress",this._KeyPress),c.detachDOMEvent(d.body,"keyup",this._KeyUp)}})}keyDown(t){this.swallowKeypress=!1;var n=Ml(t,this.processor,this.hardDevice);if(n==null)return!0;let l={LeventMatched:!1};return this.emit("keyevent",n,(s,c)=>{l.LeventMatched=s&&!s.triggerKeyDefault,l.LeventMatched?(t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation()),this.swallowKeypress=!!n.Lcode,n.Lcode==8&&(this.swallowKeypress=!1)):this.swallowKeypress=!1}),!l.LeventMatched}keyUp(t){var n=Ml(t,this.processor,this.hardDevice);if(n==null)return!0;let l=_e(t);return this.processor.doModifierPress(n,l,!1)}keyPress(t){var s;var n=Ml(t,this.processor,this.hardDevice);if(n==null||n.LisVirtualKey)return!0;if(!((s=this.contextManager.activeKeyboard)!=null&&s.keyboard.isMnemonic))return!this.swallowKeypress||n.Lcode<32||this.hardDevice.browser==W.Browser.Safari&&n.Lcode>63232&&n.Lcode<63744;let l={};return this.swallowKeypress||this.emit("keyevent",n,(c,r)=>{l.preventDefaultKeystroke=!!c}),this.swallowKeypress||l.preventDefaultKeystroke?(this.swallowKeypress=!1,t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation()),!1):(this.swallowKeypress=!1,!0)}shutdown(){this.domEventTracker.shutdown()}};a(Or,"HardwareEventKeyboard");var fn=Or;var Pr=class Pr{constructor(){this.innerWidth=window.innerWidth,this.innerHeight=window.innerHeight}equals(i){return this.innerWidth==i.innerWidth&&this.innerHeight==i.innerHeight}};a(Pr,"RotationState");var Kl=Pr,ht=class ht{constructor(i){this.idlePermutationCounter=ht.IDLE_PERMUTATION_CAP;this.keyman=i}resolve(){var n;var i=this.keyman.osk;(n=this.keyman.touchLanguageMenu)==null||n.hide(),this.keyman.touchLanguageMenu=null,i.setNeedsLayout(),this.oskVisible&&i.present(),this.isActive=!1,this.updateTimer&&(window.clearInterval(this.updateTimer),this.rotState=null);let t=this.keyman.contextManager.activeTarget;t&&window.setTimeout(()=>{this.keyman.ensureElementVisibility(t.getElement())},0)}initNewRotation(){this.oskVisible=this.keyman.osk.isVisible(),this.keyman.osk.hideNow(),this.isActive=!0}init(){var i=this.keyman.config.hostDevice.OS,t=this.keyman.util;i=="ios"?(t.attachDOMEvent(window,"orientationchange",()=>(this.iOSEventHandler(),!1)),t.attachDOMEvent(window,"resize",()=>(this.iOSEventHandler(),!1))):i=="android"&&("onmozorientationchange"in screen?t.attachDOMEvent(screen,"mozorientationchange",()=>(this.initNewRotation(),!1)):t.attachDOMEvent(window,"orientationchange",()=>(this.initNewRotation(),!1)),t.attachDOMEvent(window,"resize",()=>(this.resolve(),!1)))}iOSEventHandler(){this.isActive||(this.initNewRotation(),this.rotState=new Kl,this.updateTimer=window.setInterval(this.iOSEventUpdate.bind(this),ht.UPDATE_INTERVAL)),this.idlePermutationCounter=0}iOSEventUpdate(){var i=new Kl;this.rotState.equals(i)?++this.idlePermutationCounter==ht.IDLE_PERMUTATION_CAP&&this.resolve():(this.rotState=i,this.idlePermutationCounter=0)}};a(ht,"RotationProcessor"),ht.IDLE_PERMUTATION_CAP=15,ht.UPDATE_INTERVAL=20;var zl=ht;var jr=class jr{constructor(i,t){this.domEventTracker=new Ze;this.suppressFocusCheck=a(i=>(this.focusAssistant.isTargetForcingScroll()&&(i.stopPropagation(),i.cancelBubble=!0),!0),"suppressFocusCheck");this.pageFocusHandler=a(()=>{var i;return!this.focusAssistant.maintainingFocus&&((i=this.engine.osk)!=null&&i.vkbd)&&(this.engine.contextManager.deactivateCurrentTarget(),this.engine.contextManager.resetContext()),!1},"pageFocusHandler");this.touchStartActivationHandler=a(i=>{var l,s;let t=this.engine.osk;if(!t)return!1;let n=this.engine.config.hostDevice;if(this.deactivateOnRelease=!0,this.touchY=i.touches[0].screenY,this.deactivateOnScroll=!1,n.OS=="android"&&n.browser=="chrome"){if(typeof t._Box=="undefined"||typeof t._Box.style=="undefined")return!1;let c=i.target.parentElement;if(typeof c!="undefined"&&c!=null&&(((l=c.getAttribute("class"))==null?void 0:l.indexOf("kmw-key-"))>=0||typeof c.parentElement!="undefined"&&c.parentElement!=null&&(c=c.parentElement,((s=c.getAttribute("class"))==null?void 0:s.indexOf("kmw-key-"))>=0)))return!1;this.deactivateOnScroll=!0}return!1},"touchStartActivationHandler");this.touchMoveActivationHandler=a(i=>{this.deactivateOnScroll&&(this.focusAssistant.focusing=!1,this.engine.contextManager.deactivateCurrentTarget());let t=i.touches[0].screenY,n=this.touchY;return(t-n>5||n-t<5)&&(this.deactivateOnRelease=!1),!1},"touchMoveActivationHandler");this.touchEndActivationHandler=a(i=>(this.deactivateOnRelease&&!this.engine.touchLanguageMenu&&!this.focusAssistant.focusing&&this.engine.contextManager.deactivateCurrentTarget(),this.deactivateOnRelease=!1,!1),"touchEndActivationHandler");this._WindowLoad=a(()=>{document.body.scrollTop=0,typeof document.documentElement!="undefined"&&(document.documentElement.scrollTop=0)},"_WindowLoad");this._WindowUnload=a(()=>{this.engine.shutdown()},"_WindowUnload");this.window=i,this.engine=t,this.attachHandlers(),t.config.hostDevice.touchable&&(this.buildPageTrailer(),this.rotationProcessor=new zl(this.engine),this.rotationProcessor.init())}buildPageTrailer(){let i=this.mobilePageTrailer=document.createElement("div"),t=i.style;t.width="100%",t.height=screen.width/2+"px",document.body.appendChild(i)}get focusAssistant(){return this.engine.contextManager.focusAssistant}attachHandlers(){let i=this.domEventTracker,t=this.engine.config.hostDevice,n=this.window.document.body;i.attachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),i.attachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),i.attachDOMEvent(n,"focus",this.suppressFocusCheck,!0),i.attachDOMEvent(n,"blur",this.suppressFocusCheck,!0),t.touchable&&(i.attachDOMEvent(n,"touchstart",this.touchStartActivationHandler,!1),i.attachDOMEvent(n,"touchmove",this.touchMoveActivationHandler,!1),i.attachDOMEvent(n,"touchend",this.touchEndActivationHandler,!1)),i.attachDOMEvent(window,"load",this._WindowLoad,!1),i.attachDOMEvent(window,"unload",this._WindowUnload,!1),i.attachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}shutdown(){var l;let i=this.domEventTracker,t=this.engine.config.hostDevice,n=this.window.document.body;i.detachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),i.detachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),i.detachDOMEvent(n,"focus",this.suppressFocusCheck,!0),i.detachDOMEvent(n,"blur",this.suppressFocusCheck,!0),t.touchable&&(i.detachDOMEvent(n,"touchstart",this.touchStartActivationHandler,!1),i.detachDOMEvent(n,"touchmove",this.touchMoveActivationHandler,!1),i.detachDOMEvent(n,"touchend",this.touchEndActivationHandler,!1),(l=this.mobilePageTrailer)==null||l.parentElement.removeChild(this.mobilePageTrailer)),i.detachDOMEvent(window,"load",this._WindowLoad,!1),i.detachDOMEvent(window,"unload",this._WindowUnload,!1),i.detachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}};a(jr,"PageIntegrationHandlers");var Dl=jr;function pe(g){let i=document.createElement(g);return i.style.userSelect="none",i.style.MozUserSelect="none",i.style.KhtmlUserSelect="none",i.style.UserSelect="none",i.style.WebkitUserSelect="none",i}a(pe,"_CreateElement");function kt(g,i){try{if(g&&typeof window.getComputedStyle!="undefined")return window.getComputedStyle(g,"").getPropertyValue(i)}catch(t){}return""}a(kt,"getStyleValue");var _r=class _r{constructor(i){this.keyman=i,this.scrolling=!1,this.shim=this.constructShim()}constructShim(){let i=this,t=pe("div"),n=this.keyman.osk;return t.id="kmw-language-menu-background",t.addEventListener("touchstart",l=>{if(l.preventDefault(),i.hide(),l.touches.length>2){var s=l.touches[1].pageX,c=l.touches[1].pageY;let r=n.vkbd.spaceBar;s>r.offsetLeft&&s<r.offsetLeft+r.offsetWidth&&c>r.offsetTop&&c<r.offsetTop+r.offsetHeight&&this.keyman.osk.emit("showbuild")}},!1),t}show(){let i=this.keyman.config.hostDevice,t=this.keyman.keyboardRequisitioner.cache.getStubList();if(t.length<1)return;var l=this.lgList=pe("div");this.lgList.id="kmw-language-menu";let s=this;document.body.appendChild(this.shim);var c=pe("div"),r=c.style,o=pe("div");c.id="kmw-menu-scroll-container",o.id="kmw-menu-scroller","WebkitOverflowScrolling"in r&&(r.WebkitOverflowScrolling="touch"),c.appendChild(o),l.appendChild(c);let d,u=pe("div");u.id="kmw-menu-index";for(let U=1;U<=26;U++)d=pe("p"),d.innerHTML=String.fromCharCode(U+64),u.appendChild(d);if(u.addEventListener("touchstart",function(U){s.scrollToLanguage(U,c,o)},!1),u.addEventListener("touchend",function(U){U.stopPropagation()},!1),l.appendChild(u),l.addEventListener("scroll",function(U){s.scrolling=!0},!1),c.addEventListener("scroll",function(U){c.scrollTop<1&&(c.scrollTop=1),c.scrollTop>c.scrollHeight-c.offsetHeight-1&&(c.scrollTop=c.scrollHeight-c.offsetHeight-1)},!1),this.activeLgNo=this.addLanguages(o,t),this.lgList.style.visibility="hidden",document.body.appendChild(this.lgList),i.OS=="android"&&"devicePixelRatio"in window&&(this.lgList.style.fontSize=2/window.devicePixelRatio+"em"),i.OS=="android"&&i.formFactor=="tablet"&&"devicePixelRatio"in window){var B=parseInt(kt(l,"width"),10),b=l.style;isNaN(B)||(b.width=b.maxWidth=2*B/window.devicePixelRatio+"px"),B=parseInt(kt(c,"width"),10),b=c.style,isNaN(B)||(b.width=b.maxWidth=2*B/window.devicePixelRatio+"px"),B=parseInt(kt(o,"width"),10),b=o.style,isNaN(B)||(b.width=b.maxWidth=2*B/window.devicePixelRatio+"px")}this.adjust(0);var I=u.childNodes[1].offsetTop-u.childNodes[0].offsetTop,F=Math.floor(l.offsetHeight/26),h=Math.round(100*F/I)/100,y=h>.6?1:2;h>1.25&&(h=1.25);for(let U=0;U<26;U++){var Q=u.childNodes[U].style;y==2&&U%2==1?Q.display="none":(Q.fontSize=h*y+"em",Q.lineHeight=F*y+"px")}var x=c.offsetWidth;c.scrollHeight>c.offsetHeight+3?x=x+u.offsetWidth:u.style.display="none",l.style.width=x+"px",this.lgList.style.visibility="",this.scrollToIndex(this.activeLgNo,c,o)}adjust(i){let t=this.keyman.osk,n=this.keyman.config.hostDevice;var l=this.lgList,s=l.firstChild,c=s.firstChild,r=0,o=l.style,d=l.childNodes[1],u=window.innerHeight-t.vkbd.lgKey.offsetHeight-16,B=c.childNodes.length+i-1,b=c.firstChild.firstChild.offsetHeight,I=B*b;n.OS=="ios"&&(n.formFactor=="phone"?(r=he()?36:0,u=(window.innerHeight-r-16)*Se(n.formFactor)):n.formFactor=="tablet"&&(r=he()?16:0,u=u-r)),o.left=z(t.vkbd.lgKey)+"px",I>u&&(I=u),o.height=I+"px",o.bottom="0px",d.style.height=s.style.height=o.height}scrollToLanguage(i,t,n){i.stopImmediatePropagation(),i.stopPropagation(),i.preventDefault();let l=i.touches[0].target;if(l.nodeName=="P"){var s,c,r=l.innerHTML.charCodeAt(0),o=n.childNodes;try{for(s=0;s<o.length-1&&(c=o[s].firstChild.innerHTML.toUpperCase().charCodeAt(0),!(c>=r));s++);}catch(d){}this.scrollToIndex(s,t,n)}}scrollToIndex(i,t,n){let l;try{l=n.firstChild.getBoundingClientRect().height*(i-.5)+1,t.scrollTop=l}catch(c){l=0}try{t.scrollTop<0&&(t.scrollTop=0),t.scrollTop>t.scrollHeight-t.offsetHeight-1&&(t.scrollTop=t.scrollHeight-t.offsetHeight-1)}catch(c){}}addLanguages(i,t){var u;var n=t.length;let l=this.keyman.config.hostDevice,s=[];for(let B=0;B<n;B++){let b=t[B].KL;s.indexOf(b)==-1&&s.push(b)}s.sort();var c=Math.round(100/Se(l.formFactor))/100;let r=-1;for(let B=0;B<s.length;B++){let b=pe("div");b.className="kbd-list-closed";let I=pe("p");I.kList=[];for(let h=0;h<n;h++)t[h].KL==s[B]&&I.kList.push(t[h]);l.OS=="ios"&&(I.style.fontSize=c+"em"),b.appendChild(I),i.appendChild(b),s[B]==((u=this.keyman.contextManager.activeKeyboard)==null?void 0:u.metadata.langName)&&(r=B);let F=this;if(I.kList.length>1){I.className="kbd-list",I.innerHTML=s[B]+"...",I.scrolled=!1,I.ontouchend=h=>{h.stopPropagation(),I.scrolled?I.scrolled=!1:I.parentElement.className=I.parentElement.className=="kbd-list-closed"?"kbd-list-open":"kbd-list-closed",F.adjust(I.parentElement.className=="kbd-list-closed"?0:I.kList.length)},I.addEventListener("touchstart",function(h){h.stopPropagation()},!1),I.addEventListener("touchmove",function(h){I.scrolled=!0,h.stopPropagation()},!1);for(let h=0;h<I.kList.length;h++){let y=pe("p");y.className="kbd-list-entry",l.OS=="ios"&&(y.style.fontSize=c+"em"),this.addKeyboard(I.kList[h],y,!1),b.appendChild(y)}}else I.innerHTML=s[B],I.className="kbd-single-entry",this.addKeyboard(I.kList[0],I,!0);B==r&&(I.className=I.className+" current")}var o=pe("div");o.id="kmw-menu-footer";var d=a(function(B){B.cancelable&&B.preventDefault(),B.stopPropagation()},"cancelTouch");return o.addEventListener("touchstart",d,!1),o.addEventListener("touchmove",d,!1),o.addEventListener("touchend",d,!1),i.appendChild(o),r}addKeyboard(i,t,n){t.kn=i.KI,t.kc=i.KLC,t.innerHTML=n?i.KL:i.KN.replace(" Keyboard","");let l=this,s=a(()=>{if(this.originalBodyStyle)return console.error("Unexpected state:  `originalBodyStyle` was not cleared by a previous `unlockBodyScroll()` call"),!1;this.originalBodyStyle={};let B=this.originalBodyStyle,b=document.body.style;return B.overflowY=b.overflowY,B.height=b.height,b.overflowY="hidden",b.height="100%",!0},"lockBodyScroll"),c=a(()=>{if(!this.originalBodyStyle){console.error("Unexpected state:  `originalBodyStyle` is unset; cannot restore original body style");return}let B=this.originalBodyStyle,b=document.body.style;b.overflowY=B.overflowY,b.height=B.height,this.originalBodyStyle=null},"unlockBodyScroll"),r=a(function(B){B.stopPropagation(),this.className.indexOf("selected")<=0&&(this.className=this.className+" selected"),l.scrolling=!1,l.y0=B.touches[0].pageY,s()},"touchStart"),o=a(function(B){B.stopImmediatePropagation();var b=l.lgList.childNodes[0],I=b.scrollHeight-b.offsetHeight,F,h;if(typeof B.pageY!="undefined")F=B.pageY;else if(typeof B.touches!="undefined")F=B.touches[0].pageY;else return!1;if(h=F-l.y0,h<0)b.scrollTop>=I-1&&(l.y0=F);else if(h>0)b.scrollTop<2&&(l.y0=F);else return!1;return(h<-5||h>5)&&(l.scrolling=!0,this.className=this.className.replace(/\s*selected/,""),l.y0=F),!0},"touchMove"),d=a(function(B){let b=this;return typeof B.stopImmediatePropagation!="undefined"?B.stopImmediatePropagation():B.stopPropagation(),l.scrolling?this.className=this.className.replace(/\s*selected/,""):(l.keyman.contextManager.focusAssistant.setFocusTimer(),l.lgList.style.display="none",l.keyman.contextManager.activateKeyboard(b.kn,b.kc,!0),l.keyman.contextManager.restoreLastActiveTarget(),l.hide()),c(),!0},"touchEnd"),u=a(function(B){c()},"touchCancel");t.addEventListener("touchstart",r,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",d,!1),t.addEventListener("touchcancel",u,!1)}hide(){let i=this.keyman.osk;this.lgList&&(i.vkbd.highlightKey(i.vkbd.lgKey,!1),this.lgList.style.visibility="hidden",window.setTimeout(()=>{this.shim.parentElement&&(document.body.removeChild(this.shim),document.body.removeChild(this.lgList))},500)),this.keyman.touchLanguageMenu=null}};a(_r,"LanguageMenu");var Ol=_r;function na(g,i,t){let n=t.focusAssistant;i.on("globekey",(l,s)=>{s&&i.hostDevice.touchable&&(g.touchLanguageMenu=new Ol(g),g.touchLanguageMenu.show()),i.vkbd&&i.vkbd.highlightKey(l,!1)}),i.on("hiderequested",l=>{i&&(i.startHide(!0),t.forgetActiveTarget())}),i.addEventListener("hide",l=>{var s;l!=null&&l.HiddenByUser&&((s=t.activeTarget)==null||s.focus())}),i.on("showbuild",()=>{var l;(l=g.config.alertHost)==null||l.alert("KeymanWeb Version "+Ai.VERSION+'<br /><br /><span style="font-size:0.8em">Copyright &copy; 2007-2023 SIL International</span>')}),i.on("dragmove",l=>R(this,null,function*(){n.restoringFocus=!0,yield l,t.restoreLastActiveTarget(),n.restoringFocus=!1,n.setMaintainingFocus(!1)})),i.on("resizemove",l=>R(this,null,function*(){n.restoringFocus=!0,yield l,t.restoreLastActiveTarget(),n.restoringFocus=!1,n.setMaintainingFocus(!1)})),i.on("pointerinteraction",l=>R(this,null,function*(){n.setMaintainingFocus(!0),yield l,n.setMaintainingFocus(!1)}))}a(na,"setupOskListeners");function Fg(g){let i=document.createElement(g);return i.style.userSelect="none",i}a(Fg,"createUnselectableElement");var qr=class qr{constructor(i){this.getAbsoluteX=z;this.getAbsoluteY=D;this._GetAbsoluteX=z;this._GetAbsoluteY=D;this._GetAbsolute=this.getAbsolute;this.toNzString=this.nzString;this.createElement=Fg;this.getStyleValue=kt;this.config=i,this.stylesheetManager=new de(document.body,i.applyCacheBusting),this.domEventTracker=new Ze}isTouchDevice(){return this.config.hostDevice.touchable}getAbsolute(i){return{x:z(i),y:D(i)}}getOption(i,t){return i in this.config.paths?this.config.paths[i]:i in this.config.options?this.config.options[i]:arguments.length>1?t:""}setOption(i,t){switch(i){case"attachType":break;case"ui":break;case"useAlerts":this.config.signalUser=t?new bt:null;break;case"setActiveOnRegister":this.config.activateFirstKeyboard=!!t;break;case"spacebarText":this.config.spacebarText=t;break;default:throw new Error("Path-related options may not be changed after the engine has initialized.")}}loadCookie(i){return new ce(i).load(decodeURIComponent)}saveCookie(i,t){new ce(i).save(t,encodeURIComponent)}addStyleSheet(i){let t=st(i);return this.stylesheetManager.linkStylesheet(t),t}removeStyleSheet(i){return this.stylesheetManager.unlink(i)}linkStyleSheet(i){this.stylesheetManager.linkExternalSheet(i)}getLanguageCodes(i){return i.indexOf("-")==-1?[i]:i.split("-")}attachDOMEvent(i,t,n,l){this.domEventTracker.attachDOMEvent(i,t,n,l)}detachDOMEvent(i,t,n,l){this.domEventTracker.detachDOMEvent(i,t,n,l)}get alertHost(){return this.config.alertHost?this.config.alertHost:(this._alertHost||(this._alertHost=new bt),this._alertHost)}alert(i,t){this.alertHost.alert(i,t)}nzString(i,t){let n="";return arguments.length>1&&(n=t),typeof i=="undefined"||i==null||i==0||i==""?n:""+i}toNumber(i,t){let n=parseInt(i,10);return isNaN(n)?t:n}toFloat(i,t){let n=parseFloat(i);return isNaN(n)?t:n}rgba(i,t,n,l,s){let c="transparent";try{c="rgba("+t+","+n+","+l+","+s+")"}catch(r){c="rgb("+t+","+n+","+l+")"}return c}shutdown(){var i,t,n;(i=this.stylesheetManager)==null||i.unlinkAll(),(t=this.domEventTracker)==null||t.shutdown(),(n=this._alertHost)==null||n.shutdown()}};a(qr,"UtilApiEndpoint");var Pl=qr;var eo=class eo{constructor(i,t,n){this.code=i,this.shift=t,this.handler=n}matches(i,t){return this.code==i&&this.shift==t}};a(eo,"Hotkey");var $r=eo,to=class to{constructor(){this.hotkeys=[];this._Process=a(i=>{i||(i=window.event);var t=Dr(i);if(t==null)return!1;for(var n=(i.shiftKey?16:0)|(i.ctrlKey?32:0)|(i.altKey?64:0),l=0;l<this.hotkeys.length;l++)if(this.hotkeys[l].matches(t,n))return this.hotkeys[l].handler(),i.returnValue=!1,i&&i.preventDefault&&i.preventDefault(),i.cancelBubble=!0,!1;return!0},"_Process")}addHotKey(i,t,n){for(var l=0;l<this.hotkeys.length;l++)if(this.hotkeys[l].code==i&&this.hotkeys[l].shift==t){this.hotkeys[l].handler=n;return}this.hotkeys.push(new $r(i,t,n))}removeHotkey(i,t){for(var n=0;n<this.hotkeys.length;n++)if(this.hotkeys[n].matches(i,t)){this.hotkeys.splice(n,1);return}}};a(to,"HotkeyManager");var jl=to;var no=class no{constructor(i){this.e=i,this.c=i.style.backgroundColor}reset(){this.e.style.backgroundColor=this.c}};a(no,"BeepData");var io=no,lo=class lo{constructor(i){this._BeepObjects=[];this._BeepTimeout=0;this.reset=a(()=>{this.keyboardInterface.resetContextCache();var i;for(this._BeepTimeout=0,i=0;i<this._BeepObjects.length;i++)this._BeepObjects[i].reset();this._BeepObjects=[]},"reset");this.keyboardInterface=i}beep(i){if(i instanceof P){var t=i.getElement();if(i instanceof j&&(t=i.docRoot),!!t&&!(!t.style||typeof t.style.backgroundColor=="undefined")){for(var n=0;n<this._BeepObjects.length;n++)if(this._BeepObjects[n].e==t)return;this._BeepObjects.push(new io(t)),t.style.backgroundColor="#000000",this._BeepTimeout==0&&(this._BeepTimeout=1,window.setTimeout(this.reset,50))}}}};a(lo,"BeepHandler");var _l=lo;var so=class so extends Vt{constructor(t,n){super(t,n);this.GetLastActiveElement=this.getLastActiveElement;this.FocusLastActiveElement=this.focusLastActiveElement;this.HideHelp=this.hideHelp;this.ShowHelp=this.showHelp;this.ShowPinnedHelp=this.showPinnedHelp}saveFocus(){this.engine.contextManager.focusAssistant._IgnoreNextSelChange=1}getLastActiveElement(){return this.engine.contextManager.lastActiveTarget}focusLastActiveElement(){this.engine.contextManager.restoreLastActiveTarget()}hideHelp(){this.engine.osk.startHide(!0)}showHelp(t,n){let l=this.engine.osk;l instanceof Pe?l.presentAtPosition(t,n):l.present()}showPinnedHelp(){let t=this.engine.osk;t instanceof Pe&&(!t.activeKeyboard.keyboard.isCJK||!this.ruleBehavior)&&(t.userPositioned=!0),t.present()}};a(so,"KeyboardInterface");var Qi=so;(function(){Qi.__publishShorthandAPI()})();var ql=class ql extends ci{constructor(t,n){let l=new Yl(n);super(t,l,new vn(l,()=>this.legacyAPIEvents),s=>({keyboardInterface:new Qi(window,s),defaultOutputRules:new Hn(s.contextManager)}));this._initialized=0;this.hotkeyManager=new jl;this.getOskHeight=null;this.getOskWidth=null;this.helpURL="https://help.keyman.com/go";this.keyEventRefocus=a(()=>{this.contextManager.restoreLastActiveTarget()},"keyEventRefocus");this._GetKeyboardDetail=a(function(t,n){return{Name:t.KN,InternalName:t.KI,LanguageName:t.KL,LanguageCode:t.KLC,RegionName:t.KR,RegionCode:t.KRC,CountryName:t.KC,CountryCode:t.KCC,KeyboardID:t.KD,Font:t.KFont,OskFont:t.KOskFont,HasLoaded:!!n,IsRTL:n?n.isRTL:null}},"_GetKeyboardDetail");this._util=new Pl(l),this.beepHandler=new _l(this.core.keyboardInterface),this.core.keyboardProcessor.beepHandler=()=>this.beepHandler.beep(this.contextManager.activeTarget),this.hardKeyboard=new fn(l.hardDevice,this.core.keyboardProcessor,this.contextManager),this.contextManager.on("targetchange",s=>{let c=s==null?void 0:s.getElement();this.osk&&(this.osk.activationModel.activationTrigger=c),this.config.hostDevice.touchable&&s&&this.ensureElementVisibility(c)})}ensureElementVisibility(t){if(!t||!this.osk)return;let n=D(t),l=window.pageYOffset,s=n-l;n>=l&&(s-=window.innerHeight-this.osk._Box.offsetHeight-t.offsetHeight-2,s<0&&(s=0)),s!=0&&window.scrollTo(0,s+l)}get util(){return this._util}get views(){return Zr}get initialized(){return this._initialized}get ui(){return this._ui}set ui(t){this._ui&&this._ui.shutdown(),this._ui=t,this.config.deferForInitialization.isFulfilled&&t.initialize()}init(t){return R(this,null,function*(){let l=new Ut().detect(),s=G(G({},ta),t);if(this.config.hostDevice=l,this.config.initialize(s),this._initialized=1,yield Wn(),this.config.deferForInitialization.isResolved)return Promise.resolve();yield kn(ql.prototype,this,"init").call(this,s),this.keyboardRequisitioner.cloudQueryEngine.once("unboundregister",()=>{var r;(r=this.contextManager.activeKeyboard)!=null&&r.keyboard||this.setActiveKeyboard("","")}),this.contextManager.initialize();let c=this.contextManager.getSavedKeyboardRaw();l.touchable?this.osk=new Un(this):this.osk=new xn(this),na(this,this.osk,this.contextManager),this.pageIntegration=new Dl(window,this),this.config.finalizeInit(),this.ui&&(this.ui.initialize(),this.legacyAPIEvents.callEvent("loaduserinterface",{})),this._initialized=2,yield Promise.resolve(),this.contextManager.restoreSavedKeyboard(c),yield Promise.resolve()})}get register(){return this.keyboardRequisitioner.cloudQueryEngine.registerFromCloud}getUIState(){return this.contextManager.focusAssistant.getUIState()}activatingUI(t){this.contextManager.focusAssistant.setMaintainingFocus(!!t)}setKeyboardForControl(t,n,l){if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}if(!this.isAttached(t)){console.error("KeymanWeb is not attached to element "+t);return}let s=null;if(n&&(s=this.keyboardRequisitioner.cache.getStub(n,l),!s))throw new Error(`No keyboard has been registered with id ${n} and language code ${l}.`);this.contextManager.setKeyboardForTarget(t._kmwAttachment.interface,n,l)}getKeyboardForControl(t){let n=We(t);return this.contextManager.getKeyboardStubForTarget(n).id}getLanguageForControl(t){let n=We(t);return this.contextManager.getKeyboardStubForTarget(n).langId}isAttached(t){return this.contextManager.page.isAttached(t)}addKeyboards(...t){return this.config.deferForInitialization.then(()=>{if(!t||!t[0]||t[0].length==0)return this.keyboardRequisitioner.fetchCloudCatalog().catch(n=>(console.error(n[0].error),n));{let n=[];return Array.isArray(t[0])?n=n.concat(t[0]):Array.isArray(t)&&(n=n.concat(t)),this.keyboardRequisitioner.addKeyboardArray(n)}})}addKeyboardsForLanguage(t){return this.config.deferForInitialization.then(()=>typeof t=="string"?this.keyboardRequisitioner.addLanguageKeyboards(t.split(",").map(n=>n.trim())):this.keyboardRequisitioner.addLanguageKeyboards(t))}isCJK(t){let n;if(t){let l=t;l.KeyboardID?n=this.keyboardRequisitioner.cache.getKeyboard(l.KeyboardID):n=new T(t)}else n=this.core.activeKeyboard;return n&&n.isCJK}getKeyboard(t,n){let l=this.keyboardRequisitioner.cache.getStub(t,n),s=this.keyboardRequisitioner.cache.getKeyboardForStub(l);return l&&this._GetKeyboardDetail(l,s)}getKeyboards(){let t=[],n=this.keyboardRequisitioner.cache,l=n.getStubList();for(let s=0;s<l.length;s++){let c=l[s],r=n.getKeyboardForStub(c),o=this._GetKeyboardDetail(c,r);t.push(o)}return t}removeKeyboards(...t){var n;for(let l=0;l<t.length;l++)this.keyboardRequisitioner.cache.forgetKeyboard(t[l],!0),((n=this.contextManager.activeKeyboard)==null?void 0:n.metadata.id)==se(t[l])&&this.contextManager.activateKeyboard("","");return!0}getSavedKeyboard(){return this.contextManager.getSavedKeyboard()}focusLastActiveElement(){var t;(t=this.contextManager.lastActiveTarget)==null||t.focus()}getLastActiveElement(){var t;return(t=this.contextManager.lastActiveTarget)==null?void 0:t.getElement()}setActiveElement(t,n){if(typeof t=="string"){let s=t;if(t=document.getElementById(t),!t)throw new Error(`Could not find the specified element (id: ${s}`)}let l=We(t);if(!l)throw new Error(`KMW is not attached to the specified element (id: ${t.id}).`);this.contextManager.setActiveTarget(l,n)}moveToElement(t){typeof t=="string"&&(t=document.getElementById(t)),t.focus()}addHotKey(t,n,l){this.hotkeyManager.addHotKey(t,n,l)}removeHotKey(t,n){this.hotkeyManager.removeHotkey(t,n)}attachToControl(t){this.contextManager.page.attachToControl(t)}detachFromControl(t){this.contextManager.page.detachFromControl(t)}disableControl(t){this.contextManager.page.disableControl(t)}enableControl(t){this.contextManager.page.enableControl(t)}BuildVisualKeyboard(t,n,l,s){let c=null;t!=null&&(c=this.keyboardRequisitioner.cache.getKeyboard(t)),c=c||this.core.activeKeyboard;let r=this.keyboardRequisitioner.cache.getStub(c),o=this.getOskHeight,d=(typeof o=="function"?o():null)||this.osk.computedHeight||200;return me.buildDocumentationKeyboard(c,r,this.config.paths,l,s,d)}shutdown(){var t,n;this.pageIntegration.shutdown(),this.contextManager.shutdown(),(t=this.osk)==null||t.shutdown(),this.core.languageProcessor.shutdown(),this.hardKeyboard.shutdown(),this.util.shutdown(),this.legacyAPIEvents.callEvent("unloaduserinterface",{}),(n=this.ui)==null||n.shutdown()}};a(ql,"KeymanEngine");var Ln=ql;var la=document.getElementsByTagName("script"),sa=la[la.length-1].src,yg=sa.substr(0,sa.lastIndexOf("/")+1);window.keyman=new Ln(ni.constructInstance(),yg);})();
//# sourceMappingURL=keymanweb.js.map
