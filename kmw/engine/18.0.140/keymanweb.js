"use strict";(()=>{var ra=Object.create;var Nt=Object.defineProperty,ca=Object.defineProperties,co=Object.getOwnPropertyDescriptor,oa=Object.getOwnPropertyDescriptors,aa=Object.getOwnPropertyNames,lo=Object.getOwnPropertySymbols,oo=Object.getPrototypeOf,ao=Object.prototype.hasOwnProperty,ga=Object.prototype.propertyIsEnumerable,da=Reflect.get;var ro=(a,t,e)=>t in a?Nt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,y=(a,t)=>{for(var e in t||(t={}))ao.call(t,e)&&ro(a,e,t[e]);if(lo)for(var e of lo(t))ga.call(t,e)&&ro(a,e,t[e]);return a},A=(a,t)=>ca(a,oa(t)),o=(a,t)=>Nt(a,"name",{value:t,configurable:!0});var ua=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports),Sn=(a,t)=>{for(var e in t)Nt(a,e,{get:t[e],enumerable:!0})},Ba=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of aa(t))!ao.call(a,i)&&i!==e&&Nt(a,i,{get:()=>t[i],enumerable:!(n=co(t,i))||n.enumerable});return a};var Ia=(a,t,e)=>(e=a!=null?ra(oo(a)):{},Ba(t||!a||!a.__esModule?Nt(e,"default",{value:a,enumerable:!0}):e,a));var Ge=(a,t,e,n)=>{for(var i=n>1?void 0:n?co(t,e):t,s=a.length-1,l;s>=0;s--)(l=a[s])&&(i=(n?l(t,e,i):l(i))||i);return n&&i&&Nt(t,e,i),i};var Ji=(a,t,e)=>da(oo(a),e,t);var W=(a,t,e)=>new Promise((n,i)=>{var s=c=>{try{r(e.next(c))}catch(g){i(g)}},l=c=>{try{r(e.throw(c))}catch(g){i(g)}},r=c=>c.done?n(c.value):Promise.resolve(c.value).then(s,l);r((e=e.apply(a,t)).next())});var Bo=ua((Ag,qs)=>{"use strict";var Ca=Object.prototype.hasOwnProperty,_="~";function Vn(){}o(Vn,"Events");Object.create&&(Vn.prototype=Object.create(null),new Vn().__proto__||(_=!1));function Ga(a,t,e){this.fn=a,this.context=t,this.once=e||!1}o(Ga,"EE");function uo(a,t,e,n,i){if(typeof e!="function")throw new TypeError("The listener must be a function");var s=new Ga(e,n||a,i),l=_?_+t:t;return a._events[l]?a._events[l].fn?a._events[l]=[a._events[l],s]:a._events[l].push(s):(a._events[l]=s,a._eventsCount++),a}o(uo,"addListener");function Yi(a,t){--a._eventsCount===0?a._events=new Vn:delete a._events[t]}o(Yi,"clearEvent");function w(){this._events=new Vn,this._eventsCount=0}o(w,"EventEmitter");w.prototype.eventNames=o(function(){var t=[],e,n;if(this._eventsCount===0)return t;for(n in e=this._events)Ca.call(e,n)&&t.push(_?n.slice(1):n);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t},"eventNames");w.prototype.listeners=o(function(t){var e=_?_+t:t,n=this._events[e];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,s=n.length,l=new Array(s);i<s;i++)l[i]=n[i].fn;return l},"listeners");w.prototype.listenerCount=o(function(t){var e=_?_+t:t,n=this._events[e];return n?n.fn?1:n.length:0},"listenerCount");w.prototype.emit=o(function(t,e,n,i,s,l){var r=_?_+t:t;if(!this._events[r])return!1;var c=this._events[r],g=arguments.length,d,u;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),g){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,i),!0;case 5:return c.fn.call(c.context,e,n,i,s),!0;case 6:return c.fn.call(c.context,e,n,i,s,l),!0}for(u=1,d=new Array(g-1);u<g;u++)d[u-1]=arguments[u];c.fn.apply(c.context,d)}else{var I=c.length,B;for(u=0;u<I;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),g){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,n);break;case 4:c[u].fn.call(c[u].context,e,n,i);break;default:if(!d)for(B=1,d=new Array(g-1);B<g;B++)d[B-1]=arguments[B];c[u].fn.apply(c[u].context,d)}}return!0},"emit");w.prototype.on=o(function(t,e,n){return uo(this,t,e,n,!1)},"on");w.prototype.once=o(function(t,e,n){return uo(this,t,e,n,!0)},"once");w.prototype.removeListener=o(function(t,e,n,i){var s=_?_+t:t;if(!this._events[s])return this;if(!e)return Yi(this,s),this;var l=this._events[s];if(l.fn)l.fn===e&&(!i||l.once)&&(!n||l.context===n)&&Yi(this,s);else{for(var r=0,c=[],g=l.length;r<g;r++)(l[r].fn!==e||i&&!l[r].once||n&&l[r].context!==n)&&c.push(l[r]);c.length?this._events[s]=c.length===1?c[0]:c:Yi(this,s)}return this},"removeListener");w.prototype.removeAllListeners=o(function(t){var e;return t?(e=_?_+t:t,this._events[e]&&Yi(this,e)):(this._events=new Vn,this._eventsCount=0),this},"removeAllListeners");w.prototype.off=w.prototype.removeListener;w.prototype.addListener=w.prototype.on;w.prefixed=_;w.EventEmitter=w;typeof qs!="undefined"&&(qs.exports=w)});var m={LCTRLFLAG:1,RCTRLFLAG:2,LALTFLAG:4,RALTFLAG:8,K_SHIFTFLAG:16,K_CTRLFLAG:32,K_ALTFLAG:64,K_METAFLAG:128,CAPITALFLAG:256,NOTCAPITALFLAG:512,NUMLOCKFLAG:1024,NOTNUMLOCKFLAG:2048,SCROLLFLAG:4096,NOTSCROLLFLAG:8192,ISVIRTUALKEY:16384,VIRTUALCHARKEY:32768};var ki={K_BKSP:8,K_TAB:9,K_ENTER:13,K_SHIFT:16,K_CONTROL:17,K_ALT:18,K_PAUSE:19,K_CAPS:20,K_ESC:27,K_SPACE:32,K_PGUP:33,K_PGDN:34,K_END:35,K_HOME:36,K_LEFT:37,K_UP:38,K_RIGHT:39,K_DOWN:40,K_SEL:41,K_PRINT:42,K_EXEC:43,K_INS:45,K_DEL:46,K_HELP:47,K_0:48,K_1:49,K_2:50,K_3:51,K_4:52,K_5:53,K_6:54,K_7:55,K_8:56,K_9:57,K_A:65,K_B:66,K_C:67,K_D:68,K_E:69,K_F:70,K_G:71,K_H:72,K_I:73,K_J:74,K_K:75,K_L:76,K_M:77,K_N:78,K_O:79,K_P:80,K_Q:81,K_R:82,K_S:83,K_T:84,K_U:85,K_V:86,K_W:87,K_X:88,K_Y:89,K_Z:90,K_NP0:96,K_NP1:97,K_NP2:98,K_NP3:99,K_NP4:100,K_NP5:101,K_NP6:102,K_NP7:103,K_NP8:104,K_NP9:105,K_NPSTAR:106,K_NPPLUS:107,K_SEPARATOR:108,K_NPMINUS:109,K_NPDOT:110,K_NPSLASH:111,K_F1:112,K_F2:113,K_F3:114,K_F4:115,K_F5:116,K_F6:117,K_F7:118,K_F8:119,K_F9:120,K_F10:121,K_F11:122,K_F12:123,K_NUMLOCK:144,K_SCROLL:145,K_LSHIFT:160,K_RSHIFT:161,K_LCONTROL:162,K_RCONTROL:163,K_LALT:164,K_RALT:165,K_COLON:186,K_EQUAL:187,K_COMMA:188,K_HYPHEN:189,K_PERIOD:190,K_SLASH:191,K_BKQUOTE:192,K_LBRKT:219,K_BKSLASH:220,K_RBRKT:221,K_QUOTE:222,K_oE2:226,K_OE2:226,K_oC1:193,K_OC1:193,"K_?C1":193,"k_?C1":193,K_oDF:223,K_ODF:223,K_LOPT:50001,K_ROPT:50002,K_NUMERALS:50003,K_SYMBOLS:50004,K_CURRENCIES:50005,K_UPPER:50006,K_LOWER:50007,K_ALPHA:50008,K_SHIFTED:50009,K_ALTGR:50010,K_TABBACK:50011,K_TABFWD:50012},Z=ki,pg={2:Z.K_1,3:Z.K_2,4:Z.K_3,5:Z.K_4,6:Z.K_5,7:Z.K_6,8:Z.K_7,9:Z.K_8,10:Z.K_9,11:Z.K_0,12:Z.K_HYPHEN,13:Z.K_EQUAL,16:Z.K_Q,17:Z.K_W,18:Z.K_E,19:Z.K_R,20:Z.K_T,21:Z.K_Y,22:Z.K_U,23:Z.K_I,24:Z.K_O,25:Z.K_P,26:Z.K_LBRKT,27:Z.K_RBRKT,30:Z.K_A,31:Z.K_S,32:Z.K_D,33:Z.K_F,34:Z.K_G,35:Z.K_H,36:Z.K_J,37:Z.K_K,38:Z.K_L,39:Z.K_COLON,40:Z.K_QUOTE,41:Z.K_BKQUOTE,43:Z.K_BKSLASH,44:Z.K_Z,45:Z.K_X,46:Z.K_C,47:Z.K_V,48:Z.K_B,49:Z.K_N,50:Z.K_M,51:Z.K_COMMA,52:Z.K_PERIOD,53:Z.K_SLASH,57:Z.K_SPACE,86:Z.K_oE2,115:Z.K_oC1,125:Z.K_oE2};var ha={};Sn(ha,{PRIVATE_USE_IDS:()=>ba,TouchLayoutKeySp:()=>go});var ba=["T_*_MT_SHIFT_TO_SHIFT","T_*_MT_SHIFT_TO_CAPS","T_*_MT_SHIFT_TO_DEFAULT"],go=(c=>(c[c.normal=0]="normal",c[c.special=1]="special",c[c.specialActive=2]="specialActive",c[c.customSpecial=3]="customSpecial",c[c.customSpecialActive=4]="customSpecialActive",c[c.deadkey=8]="deadkey",c[c.blank=9]="blank",c[c.spacer=10]="spacer",c))(go||{});var Fa=55296,ma=56319,ya=56320,pa=57343;function Ni(a){return a>=Fa&&a<=ma}o(Ni,"Uni_IsSurrogate1");function Ei(a){return a>=ya&&a<=pa}o(Ei,"Uni_IsSurrogate2");var QX={};var S=Ia(Bo(),1);var Io={modifierCodes:{LCTRL:m.LCTRLFLAG,RCTRL:m.RCTRLFLAG,LALT:m.LALTFLAG,RALT:m.RALTFLAG,SHIFT:m.K_SHIFTFLAG,CTRL:m.K_CTRLFLAG,ALT:m.K_ALTFLAG,META:m.K_METAFLAG,CAPS:m.CAPITALFLAG,NO_CAPS:m.NOTCAPITALFLAG,NUM_LOCK:m.NUMLOCKFLAG,NO_NUM_LOCK:m.NOTNUMLOCKFLAG,SCROLL_LOCK:m.SCROLLFLAG,NO_SCROLL_LOCK:m.NOTSCROLLFLAG,VIRTUAL_KEY:m.ISVIRTUALKEY,VIRTUAL_CHAR_KEY:m.VIRTUALCHARKEY},modifierBitmasks:{ALL:127,ALT_GR_SIM:5,CHIRAL:31,IS_CHIRAL:15,NON_CHIRAL:112,NON_LEGACY:111},stateBitmasks:{ALL:16128,CAPS:768,NUM_LOCK:3072,SCROLL_LOCK:12288},keyCodes:y({},ki),codesUS:[["0123456789",";=,-./`","[\\]'"],[")!@#$%^&*(",":+<_>?~",'{|}"']],isFrameKey(a){switch(a){case"K_SHIFT":case"K_LOPT":case"K_ROPT":case"K_NUMLOCK":case"K_CAPS":return!0;default:if(Io.keyCodes[a]>=5e4)return!0}return!1},getModifierState(a){var t=0;a.indexOf("shift")>=0&&(t|=m.K_SHIFTFLAG);var e=!1;a.indexOf("leftctrl")>=0&&(t|=m.LCTRLFLAG,e=!0),a.indexOf("rightctrl")>=0&&(t|=m.RCTRLFLAG,e=!0),a.indexOf("ctrl")>=0&&!e&&(t|=m.K_CTRLFLAG);var n=!1;return a.indexOf("leftalt")>=0&&(t|=m.LALTFLAG,n=!0),a.indexOf("rightalt")>=0&&(t|=m.RALTFLAG,n=!0),a.indexOf("alt")>=0&&!n&&(t|=m.K_ALTFLAG),t},getStateFromLayer(a){var t=0;return a.indexOf("caps")>=0?t|=m.CAPITALFLAG:t|=m.NOTCAPITALFLAG,t}},C=Io;var $s=class $s{codeForEvent(t){return C.keyCodes[t.kName]||t.Lcode}forAny(t,e,n){var i="";if((i=this.forSpecialEmulation(t))!=null)return i;if(!e&&(i=this.forNumpadKeys(t))!=null)return i;if((i=this.forUnicodeKeynames(t,n))!=null)return i;if((i=this.forBaseKeys(t,n))!=null)return i;switch(this.codeForEvent(t)){default:return null}}isCommand(t){switch(this.codeForEvent(t)){default:return!1}}applyCommand(t,e){}forSpecialEmulation(t){switch(this.codeForEvent(t)){case C.keyCodes.K_BKSP:return"\b";case C.keyCodes.K_ENTER:return`
`;default:return null}}forNumpadKeys(t){if(t.Lcode>=C.keyCodes.K_NP0&&t.Lcode<=C.keyCodes.K_NPSLASH){if(t.Lcode<106)var e=t.Lcode-48;else e=t.Lcode-64;return String._kmwFromCharCode(e)}else return null}forUnicodeKeynames(t,e){let n=t.kName;if(!n||n.substr(0,2)!="U_")return null;let i="",s=n.substr(2).split("_");for(let l of s){let r=parseInt(l,16);if(0<=r&&r<=31||128<=r&&r<=159||isNaN(r)){e&&(e.errorLog="Suppressing Unicode control code in "+n);continue}else i+=String.kmwFromCharCode(r)}return i||null}forBaseKeys(t,e){let n=t.Lcode,i=t.Lmodifiers;if(i==m.K_SHIFTFLAG)i=1;else if(i!=0)return e&&(e.warningLog="KMW only defines default key output for the 'default' and 'shift' layers!"),null;try{if(n==C.keyCodes.K_SPACE)return" ";if(n>=C.keyCodes.K_0&&n<=C.keyCodes.K_9)return C.codesUS[i][0][n-C.keyCodes.K_0];if(n>=C.keyCodes.K_A&&n<=C.keyCodes.K_Z)return String.fromCharCode(n+(i?0:32));if(n>=C.keyCodes.K_COLON&&n<=C.keyCodes.K_BKQUOTE)return C.codesUS[i][1][n-C.keyCodes.K_COLON];if(n>=C.keyCodes.K_LBRKT&&n<=C.keyCodes.K_QUOTE)return C.codesUS[i][2][n-C.keyCodes.K_LBRKT];if(n==C.keyCodes.K_oE2)return i?"|":"\\"}catch(s){e&&(e.errorLog="Error detected with default mapping for key:  code = "+n+", shift state = "+(i==1?"shift":"default"))}return null}};o($s,"DefaultRules");var Ae=$s;var Qa=new Ae,An=class An{constructor(t){this.isSynthetic=!0;for(let e in t)t[e]!==void 0&&(this[e]=t[e])}static constructNullKeyEvent(t){return new An({Lcode:0,kName:"",device:t,Lstates:void 0,Lmodifiers:void 0,vkCode:void 0,LisVirtualKey:void 0})}get isModifier(){switch(this.Lcode){case 16:case 17:case 18:case 20:case 144:case 145:return!0;default:return!1}}setMnemonicCode(t,e){if(this.Lcode!=C.keyCodes.K_SPACE){let i=new An(this);for(let s in this)i[s]=this[s];i.kName="K_xxxx",i.Lmodifiers=t?16:0;var n=Qa.forAny(i,!0);this.vkCode=this.Lcode,n?this.Lcode=n.charCodeAt(0):this.isModifier||delete this.Lcode}e&&(this.Lcode>=65&&this.Lcode<=90||this.Lcode>=97&&this.Lcode<=122)&&(this.Lmodifiers^=16,this.Lcode^=32)}};o(An,"KeyEvent");var ee=An;var nl=class nl{};o(nl,"KeyMap");var Ne=nl,il=class il{constructor(){this.FF=new Ne;this.Safari=new Ne;this.Opera=new Ne;this.FF.k61=187,this.FF.k59=186,this.FF.k173=189}};o(il,"BrowserKeyMaps");var el=il,sl=class sl{constructor(){this.se=new Ne,this.se.k220=192,this.se.k187=189,this.se.k219=187,this.se.k221=219,this.se.k186=221,this.se.k191=220,this.se.k192=186,this.se.k189=191,this.uk=new Ne,this.uk.k223=192,this.uk.k192=222,this.uk.k222=226,this.uk.k220=220}};o(sl,"LanguageKeyMaps");var tl=sl,We=class We{constructor(){}static _usCodeInit(){var t=new Ne,e=new Ne;t.k192=96,t.k49=49,t.k50=50,t.k51=51,t.k52=52,t.k53=53,t.k54=54,t.k55=55,t.k56=56,t.k57=57,t.k48=48,t.k189=45,t.k187=61,t.k81=113,t.k87=119,t.k69=101,t.k82=114,t.k84=116,t.k89=121,t.k85=117,t.k73=105,t.k79=111,t.k80=112,t.k219=91,t.k221=93,t.k220=92,t.k65=97,t.k83=115,t.k68=100,t.k70=102,t.k71=103,t.k72=104,t.k74=106,t.k75=107,t.k76=108,t.k186=59,t.k222=39,t.k90=122,t.k88=120,t.k67=99,t.k86=118,t.k66=98,t.k78=110,t.k77=109,t.k188=44,t.k190=46,t.k191=47,e.k192=126,e.k49=33,e.k50=64,e.k51=35,e.k52=36,e.k53=37,e.k54=94,e.k55=38,e.k56=42,e.k57=40,e.k48=41,e.k189=95,e.k187=43,e.k81=81,e.k87=87,e.k69=69,e.k82=82,e.k84=84,e.k89=89,e.k85=85,e.k73=73,e.k79=79,e.k80=80,e.k219=123,e.k221=125,e.k220=124,e.k65=65,e.k83=83,e.k68=68,e.k70=70,e.k71=71,e.k72=72,e.k74=74,e.k75=75,e.k76=76,e.k186=58,e.k222=34,e.k90=90,e.k88=88,e.k67=67,e.k86=86,e.k66=66,e.k78=78,e.k77=77,e.k188=60,e.k190=62,e.k191=63,We._usCharCodes=[t,e]}static _USKeyCodeToCharCode(t){return We.usCharCodes[t.Lmodifiers&16?1:0]["k"+t.Lcode]}static get usCharCodes(){return We._usCharCodes||We._usCodeInit(),We._usCharCodes}};o(We,"KeyMapping"),We.browserMap=new el,We.languageMap=new tl;var te=We;function ce(a){if(typeof a!="object"||!a)return a;{let t=Array.isArray(a)?[]:{},e=Object.keys(a);for(let n of e)a[n]!==void 0&&(t[n]=ce(a[n]));return t}}o(ce,"deepCopy");var N=class N{constructor(t,e,n,i){switch(t.toLowerCase()){case N.Browser.Chrome:case N.Browser.Edge:case N.Browser.Firefox:case N.Browser.Native:case N.Browser.Opera:case N.Browser.Safari:this.browser=t.toLowerCase();break;default:this.browser=N.Browser.Other}switch(e.toLowerCase()){case N.FormFactor.Desktop:case N.FormFactor.Phone:case N.FormFactor.Tablet:this.formFactor=e.toLowerCase();break;default:throw"Invalid form factor specified for device: "+e}switch(n.toLowerCase()){case N.OperatingSystem.Windows.toLowerCase():case N.OperatingSystem.macOS.toLowerCase():case N.OperatingSystem.Linux.toLowerCase():case N.OperatingSystem.Android.toLowerCase():case N.OperatingSystem.iOS.toLowerCase():this.OS=n.toLowerCase();break;default:this.OS=N.OperatingSystem.Other}this.touchable=i}};o(N,"DeviceSpec");var Ft=N;(n=>{let a;(u=>(u.Chrome="chrome",u.Edge="edge",u.Firefox="firefox",u.Native="native",u.Opera="opera",u.Safari="safari",u.Other="other"))(a=n.Browser||(n.Browser={}));let t;(d=>(d.Windows="windows",d.macOS="macosx",d.Linux="linux",d.Android="android",d.iOS="ios",d.Other="other"))(t=n.OperatingSystem||(n.OperatingSystem={}));let e;(r=>(r.Desktop="desktop",r.Phone="phone",r.Tablet="tablet"))(e=n.FormFactor||(n.FormFactor={}))})(Ft||(Ft={}));function ll(a){return new Ft(a.browser,"desktop",a.OS,!1)}o(ll,"physicalKeyDeviceAlias");var V=Ft;var oe=class oe{};o(oe,"KEYMAN_VERSION"),oe.VERSION="18.0.140",oe.VERSION_RELEASE="18.0",oe.VERSION_MAJOR="18",oe.VERSION_MINOR="0",oe.VERSION_PATCH="140",oe.TIER="alpha",oe.VERSION_TAG="-alpha",oe.VERSION_WITH_TAG="18.0.140-alpha",oe.VERSION_ENVIRONMENT="alpha",oe.VERSION_GIT_TAG="release@18.0.140-alpha";var Wn=oe,et=Wn;var Ie=class Ie{constructor(t){if(t==null){this.components=[].concat(Ie.DEVELOPER_VERSION_FALLBACK.components);return}if(Array.isArray(t)){let i=t;if(i.length<2)throw new Error("Version string must have at least a major and minor component!");this.components=[].concat(i);return}let e=t.split("."),n=[];if(e.length<2)throw new Error("Version string must have at least a major and minor component!");for(let i=0;i<e.length;i++){let s=parseInt(e[i],10);if(isNaN(s))throw new Error("Version string components must be numerical!");n.push(s)}this.components=n}get major(){return this.components[0]}get minor(){return this.components[1]}toString(){return this.components.join(".")}toJSON(){return this.toString()}equals(t){return this.compareTo(t)==0}precedes(t){return this.compareTo(t)<0}compareTo(t){var e=this.components.length<t.components.length,n=this.components.length<t.components.length?this.components.length:t.components.length,i;for(i=0;i<n;i++){let l=this.components[i]-t.components[i];if(l!=0)return l}var s=e?t.components:this.components;do{if(s[i]>0)return e?-1:1;i++}while(i<s.length);return 0}};o(Ie,"Version"),Ie.CURRENT=new Ie(et.VERSION_RELEASE),Ie.DEVELOPER_VERSION_FALLBACK=new Ie([9,0,0]),Ie.NO_DEFAULT_KEYCAPS=new Ie([12,0]),Ie.MAC_POSSIBLE_IPAD_ALIAS=new Ie([10,15]);var M=Ie;function Et(){return typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof self!="undefined"?self:global}o(Et,"getGlobalObject");function fn(){String.kmwFromCharCode=function(a){var t=[],e;for(e=0;e<arguments.length;e++){var n=Number(arguments[e]);if(!isFinite(n)||n<0||n>1114111||Math.floor(n)!==n)throw new RangeError("Invalid code point "+n);n<65536?t.push(n):(n-=65536,t.push((n>>10)+55296),t.push(n%1024+56320))}return String.fromCharCode.apply(void 0,t)},String.prototype.kmwCharCodeAt=function(a){var t=String(this),e=0;if(a<0||a>=t.length)return NaN;for(var n=0;n<a;n++)if(e=t.kmwNextChar(e),e===null)return NaN;var i=t.charCodeAt(e);if(i>=55296&&i<=56319&&t.length>e+1){var s=t.charCodeAt(e+1);if(s>=56320&&s<=57343)return(i-55296<<10)+(s-56320)+65536}return i},String.prototype.kmwIndexOf=function(a,t){var e=String(this),n=e.indexOf(a,t);if(n<0)return n;for(var i=0,s=0;s!==null&&s<n;s=e.kmwNextChar(s))i++;return i},String.prototype.kmwLastIndexOf=function(a,t){var e=String(this),n=e.lastIndexOf(a,t);if(n<0)return n;for(var i=0,s=0;s!==null&&s<n;s=e.kmwNextChar(s))i++;return i},String.prototype.kmwLength=function(){var a=String(this);if(a.length==0)return 0;for(var t=0,e=0;e!==null;t++)e=a.kmwNextChar(e);return t},String.prototype.kmwSlice=function(a,t){var e=String(this),n=e.kmwCodePointToCodeUnit(a),i=e.kmwCodePointToCodeUnit(t);return n===null||i===null?"":e.slice(n,i)},String.prototype.kmwSubstr=function(a,t){var e=String(this);a<0&&(a=e.kmwLength()+a),a<0&&(a=0);var n=e.kmwCodePointToCodeUnit(a),i=n;if(n===null)return"";if(arguments.length<2)i=e.length;else for(var s=0;s<t;s++)i=e.kmwNextChar(i);return i===null?e.substring(n):e.substring(n,i)},String.prototype.kmwSubstring=function(a,t){var e=String(this),n,i;if(typeof t=="undefined")n=e.kmwCodePointToCodeUnit(a),i=e.length;else{if(a>t){var s=a;a=t,t=s}n=e.kmwCodePointToCodeUnit(a),i=e.kmwCodePointToCodeUnit(t)}return(isNaN(n)||n===null)&&(n=0),(isNaN(i)||i===null)&&(i=e.length),e.substring(n,i)},String.prototype.kmwNextChar=function(a){var t=String(this);if(a===null||a<0||a>=t.length-1)return null;var e=t.charCodeAt(a);if(e>=55296&&e<=56319&&t.length>a+1){var n=t.charCodeAt(a+1);if(n>=56320&&n<=57343)return a==t.length-2?null:a+2}return a+1},String.prototype.kmwPrevChar=function(a){var t=String(this);if(a==null||a<=0||a>t.length)return null;var e=t.charCodeAt(a-1);if(e>=56320&&e<=57343&&a>1){var n=t.charCodeAt(a-2);if(n>=55296&&n<=56319)return a-2}return a-1},String.prototype.kmwCodePointToCodeUnit=function(a){if(a===null)return null;var t=String(this),e=0;if(a<0){e=t.length;for(var n=0;n>a;n--)e=t.kmwPrevChar(e);return e}if(a==t.kmwLength())return t.length;for(var n=0;n<a;n++)e=t.kmwNextChar(e);return e},String.prototype.kmwCodeUnitToCodePoint=function(a){var t=String(this);return a===null?null:a==0?0:a<0?t.substr(a).kmwLength():t.substr(0,a).kmwLength()},String.prototype.kmwCharAt=function(a){var t=String(this);return a>=0?t.kmwSubstr(a,1):""},String.prototype.kmwBMPNextChar=function(a){var t=String(this);return a<0||a>=t.length-1?null:a+1},String.prototype.kmwBMPPrevChar=function(a){var t=String(this);return a<=0||a>t.length?null:a-1},String.prototype.kmwBMPCodePointToCodeUnit=function(a){return a},String.prototype.kmwBMPCodeUnitToCodePoint=function(a){return a},String.prototype.kmwBMPLength=function(){var a=String(this);return a.length},String.prototype.kmwBMPSubstr=function(a,t){var e=String(this);return a>-1?e.substr(a,t):e.substr(e.length+a,-a)},String.kmwEnableSupplementaryPlane=function(a){var t=String.prototype;String._kmwFromCharCode=a?String.kmwFromCharCode:String.fromCharCode,t._kmwCharAt=a?t.kmwCharAt:t.charAt,t._kmwCharCodeAt=a?t.kmwCharCodeAt:t.charCodeAt,t._kmwIndexOf=a?t.kmwIndexOf:t.indexOf,t._kmwLastIndexOf=a?t.kmwLastIndexOf:t.lastIndexOf,t._kmwSlice=a?t.kmwSlice:t.slice,t._kmwSubstring=a?t.kmwSubstring:t.substring,t._kmwSubstr=a?t.kmwSubstr:t.kmwBMPSubstr,t._kmwLength=a?t.kmwLength:t.kmwBMPLength,t._kmwNextChar=a?t.kmwNextChar:t.kmwBMPNextChar,t._kmwPrevChar=a?t.kmwPrevChar:t.kmwBMPPrevChar,t._kmwCodePointToCodeUnit=a?t.kmwCodePointToCodeUnit:t.kmwBMPCodePointToCodeUnit,t._kmwCodeUnitToCodePoint=a?t.kmwCodeUnitToCodePoint:t.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}o(fn,"extendString");fn();var rl=class rl{constructor(t){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((e,n)=>{this._resolve=i=>{this._isFulfilled=!0,e(i)},this._reject=i=>{this._isRejected=!0,n(i)},t&&t(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(t,e){return this._promise.then(t,e)}catch(t){return this._promise.catch(t)}finally(t){return this._promise.finally(t)}get corePromise(){return this._promise}};o(rl,"ManagedPromise");var f=rl;var cl=class cl extends f{constructor(e){let n=null;super(l=>{n=setTimeout(()=>{this.isResolved||l(!0)},e)});this.timerHandle=n;let i=this._resolve;this._resolve=l=>{clearTimeout(this.timerHandle),i(l)};let s=this._reject;this._reject=l=>{clearTimeout(this.timerHandle),s(l)}}};o(cl,"TimeoutPromise");var Ee=cl,ae=o(a=>new Ee(a).corePromise,"timedPromise");var J=ha.TouchLayoutKeySp;var Ua=200,v=class v{static buildDefaultLayout(t,e,n){var Xn;let i=n;typeof v.dfltLayout[i]!="object"&&(i="desktop");let s=C.modifierBitmasks.NON_CHIRAL,l=M.CURRENT;e&&(s=e.modifierBitmask,l=e.compilerVersion),t||(t=this.DEFAULT_RAW_SPEC);var r=ce(v.dfltLayout[i]),c,g=r.layer,d=t.KLS,u=t.K102,I,B,h,b,F,G,U=(s&C.modifierBitmasks.IS_CHIRAL)!=0;if(t.F){let ke=/^(?:(?:italic|bold) )* *[0-9.eE-]+(?:[a-z]+) "(.+)"$/.exec(t.F);ke&&(r.font=ke[1])}var Q=!(typeof d=="undefined"||!d);Q||(d=t.KLS=v.processLegacyDefinitions(t.BK));var p=Object.getOwnPropertyNames(d),X=[];if(p.splice(p.indexOf("default"),1),p=["default"].concat(p),e&&e.emulatesAltGr&&(p.indexOf("leftctrl-leftalt")==-1&&p.indexOf("rightalt")!=-1&&(p.push("leftctrl-leftalt"),d["leftctrl-leftalt"]=d.rightalt),p.indexOf("leftctrl-leftalt-shift")==-1&&p.indexOf("rightalt-shift")!=-1&&(p.push("leftctrl-leftalt-shift"),d["leftctrl-leftalt-shift"]=d["rightalt-shift"])),r.displayUnderlying=e?!!e.scriptObject.KDU:!1,n=="desktop")for(X=v.generateLayerIds(U),c=0;c<X.length;c++)p.indexOf(X[c])!=-1&&X.splice(c--,1);var R=p.concat(X);if(Q&&n!="desktop"){var L=null;b=g[0].row;for(var T=0;T<b.length;T++){G=b[T].key;for(var _e=0;_e<G.length;_e++)F=G[_e],F.id=="K_SHIFT"&&(L=F)}if(L){L.sk=[];for(let ke in d){if(ke=="default"||ke=="shift")continue;var Hi=v.modifierSpecials[ke];let $e={id:`K_${Hi}`,text:Hi,sp:1,nextlayer:ke};L.sk.push($e)}}else console.warn("Error in default layout - cannot find default Shift key!")}for(c=0;c<R.length;c++)c>0&&(g[c]=ce(g[0])),g[c].id=R[c],g[c].nextlayer=R[c],v.formatDefaultLayer(g[c],U,n,!!u);for(c=0;c<g.length;c++){var Ce=g[c],Je,L=null,Un=null,ht=null,xn=null,qe=d[Ce.id],kt=Ce.id=="shift"?1:0,Zn=Ce.id=="default"||kt?1:0;for(b=Ce.row,I=0;I<b.length;I++)for(G=b[I].key,B=0;B<G.length;B++){switch(F=G[B],Je=v.dfltCodes.indexOf(F.id),(qe||Zn)&&(qe&&Je>=0&&Je<qe.length&&(F.text=qe[Je]),Zn&&l.precedes(M.NO_DEFAULT_KEYCAPS)&&F.id!="K_SPACE"&&Je+65*kt<v.dfltText.length&&F.text!==null&&(F.text=F.text||v.dfltText[Je+65*kt])),F.text!==null&&(F.text=F.text||""),F.id){case"K_SHIFT":L=F;break;case"K_CAPS":Un=F;break;case"K_NUMLOCK":ht=F;break;case"K_SCROLL":xn=F;break}if(F.sk!=null){for(h=0;h<F.sk.length;h++)p.indexOf(F.sk[h].nextlayer)==-1&&F.sk.splice(h--,1);F.sk.length==0&&(F.sk=null)}}Ce.shiftKey=L,Ce.capsKey=Un,Ce.numKey=ht,Ce.scrollKey=xn;let $e=g[c].id;n!="desktop"&&c>0&&L!=null&&(L.sp=J.specialActive,L.sk=null,L.text=(Xn=v.modifierSpecials[$e])!=null?Xn:"*Shift*")}return r}static getLayerId(t){var e="";return t==0?"default":(t&m.LCTRLFLAG&&(e=(e.length>0?e+"-":"")+"leftctrl"),t&m.RCTRLFLAG&&(e=(e.length>0?e+"-":"")+"rightctrl"),t&m.LALTFLAG&&(e=(e.length>0?e+"-":"")+"leftalt"),t&m.RALTFLAG&&(e=(e.length>0?e+"-":"")+"rightalt"),t&m.K_SHIFTFLAG&&(e=(e.length>0?e+"-":"")+"shift"),t&m.K_CTRLFLAG&&(e=(e.length>0?e+"-":"")+"ctrl"),t&m.K_ALTFLAG&&(e=(e.length>0?e+"-":"")+"alt"),e)}static generateLayerIds(t){var e,n;t?(e=32,n=1):(e=8,n=16);for(var i=[],s=0;s<e;s++)i.push(v.getLayerId(s*n));return i}static formatDefaultLayer(t,e,n,i){for(var s=t.id,l=0;l<t.row.length;l++)for(var r=t.row[l],c=r.key,g=0;g<c.length;g++){var d=c[g];switch(d.id){case"K_SHIFT":case"K_LSHIFT":case"K_RSHIFT":s.indexOf("shift")!=-1&&(d.sp=J.specialActive),n!="desktop"&&(s!="default"?d.nextlayer="default":d.nextlayer="shift");break;case"K_LCTRL":case"K_LCONTROL":if(e){s.indexOf("leftctrl")!=-1&&(d.sp=J.specialActive);break}case"K_RCTRL":case"K_RCONTROL":if(e){s.indexOf("rightctrl")!=-1&&(d.sp=J.specialActive);break}case"K_CONTROL":s.indexOf("ctrl")!=-1&&(!e||s.indexOf("leftctrl")!=-1&&s.indexOf("rightctrl")!=-1)&&(d.sp=J.specialActive);break;case"K_LALT":if(e){s.indexOf("leftalt")!=-1&&(d.sp=J.specialActive);break}case"K_RALT":if(e){s.indexOf("rightalt")!=-1&&(d.sp=J.specialActive);break}case"K_ALT":s.indexOf("alt")!=-1&&(!e||s.indexOf("leftalt")!=-1&&s.indexOf("rightalt")!=-1)&&(d.sp=J.specialActive);break;case"K_oE2":(typeof i=="undefined"||!i)&&(n=="desktop"?(c.splice(g--,1),c[0].width=Ua):c[g].sp=J.spacer);break}}}static processLegacyDefinitions(t){for(var e=v.generateLayerIds(!1),n={},i=0;i<e.length;i++){for(var s=e[i],l=[],r=!1,c=0;c<65;c++){var g=c+65*i;l.push(t[g]),g<t.length&&t[g]!=""&&c!=v.dfltCodes.indexOf("K_SPACE")&&(r=!0)}r&&(n[s]=l)}return(typeof n.default=="undefined"||!n.default)&&(n.default=[""]),(typeof n.shift=="undefined"||!n.shift)&&(n.shift=[""]),n}};o(v,"Layouts"),v.dfltCodes=["K_BKQUOTE","K_1","K_2","K_3","K_4","K_5","K_6","K_7","K_8","K_9","K_0","K_HYPHEN","K_EQUAL","K_*","K_*","K_*","K_Q","K_W","K_E","K_R","K_T","K_Y","K_U","K_I","K_O","K_P","K_LBRKT","K_RBRKT","K_BKSLASH","K_*","K_*","K_*","K_A","K_S","K_D","K_F","K_G","K_H","K_J","K_K","K_L","K_COLON","K_QUOTE","K_*","K_*","K_*","K_*","K_*","K_oE2","K_Z","K_X","K_C","K_V","K_B","K_N","K_M","K_COMMA","K_PERIOD","K_SLASH","K_*","K_*","K_*","K_*","K_*","K_SPACE"],v.dfltText="`1234567890-=ยง~~qwertyuiop[]\\~~~asdfghjkl;'~~~~~?zxcvbnm,./~~~~~ ~!@#$%^&*()_+ยง~~QWERTYUIOP{}\\~~~ASDFGHJKL:\"~~~~~?ZXCVBNM<>?~~~~~ ",v.DEFAULT_RAW_SPEC={F:"Tahoma",BK:v.dfltText.split("")},v.modifierSpecials={leftalt:"*LAlt*",rightalt:"*RAlt*",alt:"*Alt*",leftctrl:"*LCtrl*",rightctrl:"*RCtrl*",ctrl:"*Ctrl*","ctrl-alt":"*AltGr*","leftctrl-leftalt":"*LAltCtrl*","rightctrl-rightalt":"*RAltCtrl*","leftctrl-leftalt-shift":"*LAltCtrlShift*","rightctrl-rightalt-shift":"*RAltCtrlShift*",shift:"*Shift*","shift-alt":"*AltShift*","shift-ctrl":"*CtrlShift*","shift-ctrl-alt":"*AltCtrlShift*","leftalt-shift":"*LAltShift*","rightalt-shift":"*RAltShift*","leftctrl-shift":"*LCtrlShift*","rightctrl-shift":"*RCtrlShift*"},v.dfltShiftToCaps={id:"T_*_MT_SHIFT_TO_CAPS",text:"*ShiftLock*",sp:1,nextlayer:"caps"},v.dfltShiftToDefault={id:"T_*_MT_SHIFT_TO_DEFAULT",text:"*Shift*",sp:1,nextlayer:"default"},v.dfltShiftToShift={id:"T_*_MT_SHIFT_TO_SHIFT",text:"*Shift*",sp:1,nextlayer:"shift"},v.dfltLayout={desktop:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:1,key:[{id:"K_BKQUOTE"},{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{id:"K_BKSP",text:"*BkSp*",sp:1,width:130}]},{id:2,key:[{id:"K_TAB",text:"*Tab*",sp:1,width:130},{id:"K_Q"},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{id:"K_BKSLASH"}]},{id:3,key:[{id:"K_CAPS",text:"*Caps*",sp:1,width:165},{id:"K_A"},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_ENTER",text:"*Enter*",sp:1,width:165}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:130},{id:"K_oE2"},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_RSHIFT",text:"*Shift*",sp:1,width:130}]},{id:5,key:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:170},{id:"K_LALT",text:"*Alt*",sp:1,width:160},{id:"K_SPACE",text:"",width:770},{id:"K_RALT",text:"*Alt*",sp:1,width:160},{id:"K_RCONTROL",text:"*Ctrl*",sp:1,width:170}]}]}]},tablet:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",sp:1,width:150},{id:"K_SPACE",text:"",width:570},{id:"K_BKSP",text:"*BkSp*",sp:1,width:150},{id:"K_ENTER",text:"*Enter*",sp:1,width:200}]}]}]},phone:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",width:150,sp:1},{id:"K_SPACE",width:570,text:""},{id:"K_BKSP",text:"*BkSp*",width:150,sp:1},{id:"K_ENTER",text:"*Enter*",width:200,sp:1}]}]}]}};var E=v;function fe(a,t,e){e.enumerable=!0}o(fe,"Enumerable");var bo={id:"string",text:"string",layer:"string",nextlayer:"string",font:"string",fontsize:"string",sp:"number",pad:"number",width:"number",sk:"subkeys",flick:"flicks",multitap:"subkeys",hint:"string",default:"boolean"},ho=["n","ne","e","se","s","sw","w","nw"];function ol(a,t){let e=Object.getPrototypeOf(t);for(let n in t)if(!a.hasOwnProperty(n)){let i=Object.getOwnPropertyDescriptor(e,n);i?Object.defineProperty(a,n,i):a[n]=t[n]}return a}o(ol,"assignDefaultsWithPropDefs");var q=class q{constructor(t,e,n){this.isMnemonic=!1;Object.assign(this,t),!this.text&&typeof this.id=="string"&&(this.text=ne.unicodeIDToText(this.id)),this.displayLayer=n,this.layer=this.layer||n,this._baseKeyEvent=()=>this.constructBaseKeyEvent(e,n)}get baseKeyID(){if(typeof this.id!="undefined")return this.id}get isPadding(){return this.sp==J.spacer}get coreID(){if(typeof this.id=="undefined")return;let t=this.id||"";return this.displayLayer!=this.layer&&(t=t+"+"+this.layer),t}get elementID(){if(typeof this.id!="undefined")return this.displayLayer+"-"+this.coreID}get baseKeyEvent(){let t=this._baseKeyEvent;return typeof t=="function"&&(t=t()),new ee(t)}static unicodeIDToText(t,e){if(!t||t.substring(0,2)!="U_")return null;let n="",i=t.substring(2).split("_");for(let s of i){let l=parseInt(s,16);if(0<=l&&l<=31||128<=l&&l<=159||isNaN(l)){e&&e(s);continue}else n+=String.kmwFromCharCode(l)}return n||null}static sanitize(t){typeof t.width=="string"&&(t.width=parseInt(t.width,10)),t.width||(t.width=ne.DEFAULT_KEY_WIDTH),typeof t.pad=="string"&&(t.pad=parseInt(t.pad,10)),t.pad||(t.pad=ne.DEFAULT_PAD),typeof t.sp=="string"&&(t.sp=Number.parseInt(t.sp,10)),t.sp||(t.sp=ne.DEFAULT_KEY.sp);for(let e of Object.keys(bo)){let n=bo[e];switch(n){case"subkeys":let i=t[e];if(i===void 0)break;if(!Array.isArray(i))delete t[e];else for(let r=0;r<i.length;r++){let c=i[r];typeof c!="object"?i.splice(r--,1):ne.sanitize(c)}break;case"flicks":let s=t[e];if(s===void 0)break;if(typeof s!="object")delete t[e];else for(let r of ho){let c=s[r];if(c===void 0)break;typeof c!="object"?delete s[r]:ne.sanitize(c)}break;default:let l=t[e];l!==void 0&&typeof l!=n&&delete t[e]}}t.text||(t.text=ne.DEFAULT_KEY.text)}constructBaseKeyEvent(t,e){let n=this.layer||e||"",i=this.id?this.id.toUpperCase():null,s={Lmodifiers:C.getModifierState(n),Lstates:C.getStateFromLayer(n),Lcode:i?C.keyCodes[i]:0,LisVirtualKey:!0,vkCode:0,kName:i,kLayer:n,kbdLayer:e,kNextLayer:this.nextlayer,device:null,isSynthetic:!0},l=new ee(s);if(t.keyboard){let r=t.keyboard;r.isMnemonic&&!(t.isDefault&&t.formFactor!="desktop")?l.Lcode!=C.keyCodes.K_SPACE&&(l.vkCode=l.Lcode,this.isMnemonic=!0):l.vkCode=l.Lcode,r.definesPositionalOrMnemonic||(l.Lcode=te._USKeyCodeToCharCode(l),l.LisVirtualKey=!1)}return l}};o(q,"ActiveKeyBase"),q.DEFAULT_PAD=15,q.DEFAULT_RIGHT_MARGIN=15,q.DEFAULT_KEY_WIDTH=100,q.DEFAULT_KEY={text:"",width:q.DEFAULT_KEY_WIDTH,sp:J.normal,pad:q.DEFAULT_PAD},Ge([fe],q.prototype,"baseKeyID",1),Ge([fe],q.prototype,"isPadding",1),Ge([fe],q.prototype,"coreID",1),Ge([fe],q.prototype,"elementID",1),Ge([fe],q.prototype,"baseKeyEvent",1),Ge([fe],q.prototype,"constructBaseKeyEvent",1);var Ln=q,Mi=class Mi extends Ln{getSubkey(t){if(this.sk){for(let e of this.sk)if(e.coreID==t)return e}return null}constructor(t,e,n){super(t,e,n);let i=this.sk;if(i)for(let r=0;r<i.length;r++)i[r]=new mt(i[r],e,n);let s=this.multitap;if(s)for(let r=0;r<s.length;r++)s[r]=new mt(s[r],e,n);let l=this.flick;if(l)for(let r in l)l[r]=new mt(l[r],e,n);Mi.determineHint(this,e.defaultHint)}static determineHint(t,e){var n;if(t.hint){t.hintSrc=t;return}if(e!=null&&e.includes("flick-")){if(t.flick){let i=e.substring(6);(n=t.flick[i])!=null&&n.text&&(t.hintSrc=t.flick[i])}return}switch(e){case"none":return;case"multitap":t.multitap&&(t.hintSrc=t.multitap[0]);return;case"flick":if(t.flick){for(let i of ho)if(t.flick[i]){t.hintSrc=t.flick[i];return}}return;case"longpress":t.sk&&(t.hintSrc=t.sk[0]);return;case"dot":default:t.sk&&(t.hint="โข",t.hintSrc=t);return}}};o(Mi,"ActiveKey");var ne=Mi,al=class al extends Ln{};o(al,"ActiveSubKey");var mt=al,tt=class tt{constructor(){}static sanitize(t){for(let e of t.key)e==null?t.key.length=t.key.length-1:ne.sanitize(e);typeof t.id=="string"&&(t.id=Number.parseInt(t.id,10))}static polyfill(t,e,n,i,s){let l=t.key,r=Ln.DEFAULT_KEY;for(let I=0;I<l.length;I++){let B=l[I],h=Object.keys(r);for(let F of h){let G=F;typeof B[G]!="string"&&typeof B[G]!="number"&&(B[G]=r[G])}switch(B.sp){case J.special:!tt.SPECIAL_LABEL.test(B.text)&&B.text!=""&&(B.sp=J.customSpecial);break;case J.specialActive:!tt.SPECIAL_LABEL.test(B.text)&&B.text!=""&&(B.sp=J.customSpecialActive);break}let b=new ne(B,e,n);l[I]=b}let c=o(function(I,B,h,b){I.proportionalPad=B,I.proportionalWidth=h,I.proportionalX=b+B+h/2},"setProportions"),g=0;for(let I=0;I<l.length-1;I++){let B=l[I];c(B,B.pad/i,B.width/i,g),g+=B.proportionalPad,g+=B.proportionalWidth}let d=ne.DEFAULT_RIGHT_MARGIN/i;if(l.length>0){let I=l[l.length-1];if(l.length==1&&I.pad<0){let B=I.width/i,h=1-(g+B+d);c(I,h,B,g)}else{let B=I.pad/i,h=1-(g+B+d);c(I,B,h,g)}}ol(t,new tt);let u=t;u.proportionalY=s}populateKeyMap(t){this.key.forEach(function(e){e.coreID&&(t[e.coreID]=e)})}};o(tt,"ActiveRow"),tt.SPECIAL_LABEL=/\*\w+\*/,Ge([fe],tt.prototype,"populateKeyMap",1);var Ti=tt,Yt=class Yt{constructor(){}static sanitize(t){for(let e of t.row)Ti.sanitize(e)}static polyfill(t,e){t.aligned=!1;let n=t.row,i=0;for(let r of n){let c=0,g=r.key;for(let d of g)c+=d.width+d.pad;c>i&&(i=c)}e.formFactor=="desktop"?i+=5:i+=ne.DEFAULT_RIGHT_MARGIN;let s=t.row.length;for(let r=0;r<s;r++){let c=(r+.5)/s;Ti.polyfill(t.row[r],e,t.id,i,c)}ol(t,new Yt);let l=t;l.totalWidth=i,l.defaultKeyProportionalWidth=ne.DEFAULT_KEY.width/i,l.rowProportionalHeight=1/s,l.keyMap=l.constructKeyMap()}constructKeyMap(){let t={};return this.row.forEach(function(e){e.populateKeyMap(t)}),t}getKey(t){t.indexOf(this.id+"-")==0&&(t=t.replace(this.id+"-",""));let e=t.split("::");return e.length>1?this.keyMap[e[0]].getSubkey(e[1]):this.keyMap[t]}};o(Yt,"ActiveLayer"),Ge([fe],Yt.prototype,"constructKeyMap",1),Ge([fe],Yt.prototype,"getKey",1);var wi=Yt,Tt=class Tt{constructor(){this.hasFlicks=!1;this.hasLongpresses=!1;this.hasMultitaps=!1}getLayer(t){if(!this.layerMap[t]){let e=this.layer.find(n=>n.id==t);if(!e)return null;wi.sanitize(e),wi.polyfill(e,this),this.layerMap[t]=e}return this.layerMap[t]}static correctLayerEmptyRowBug(t){for(let e=0;e<t.length;e++){let i=t[e].row,s;for(s=i.length-1;s>=0;s--)(!Array.isArray(i[s].key)||i[s].key.length==0)&&i.splice(s,1)}}static sanitize(t){Tt.correctLayerEmptyRowBug(t.layer)}static polyfill(t,e,n){if(t==null)throw new Error("Cannot build an ActiveLayout for a null specification.");let i={hasFlicks:!1,hasLongpresses:!1,hasMultitaps:!1};this.sanitize(t);for(let r of t.layer)for(let c of r.row)for(let g of c.key)i.hasLongpresses||(i.hasLongpresses=!!g.sk),i.hasFlicks||(i.hasFlicks=!!g.flick),i.hasMultitaps||(i.hasMultitaps=!!g.multitap);let s={};ol(t,new Tt);let l=t;if(l.keyboard=e,l.formFactor=n,l.layerMap=s,n!="desktop"&&t.layer.find(r=>r.id=="caps")){let r=l.getLayer("default"),c=l.getLayer("shift"),g=r.getKey("K_SHIFT"),d=c==null?void 0:c.getKey("K_SHIFT");g&&d&&!g.multitap&&!d.multitap&&!g.sk&&!d.sk&&(i.hasMultitaps=!0,g.multitap=[y({},E.dfltShiftToCaps),y({},E.dfltShiftToDefault)],d.multitap=[y({},E.dfltShiftToCaps),y({},E.dfltShiftToShift)],g.multitap.forEach((u,I)=>g.multitap[I]=new mt(u,l,"default")),d.multitap.forEach((u,I)=>d.multitap[I]=new mt(u,l,"shift")))}return l.hasFlicks=i.hasFlicks,l.hasLongpresses=i.hasLongpresses,l.hasMultitaps=i.hasMultitaps,l}};o(Tt,"ActiveLayout"),Ge([fe],Tt.prototype,"getLayer",1);var wt=Tt;var dl=class dl{constructor(){this.stores={}}};o(dl,"CacheTag");var gl=dl,Ki=(n=>(n[n.NOT_LOADED=void 0]="NOT_LOADED",n[n.POLYFILLED=1]="POLYFILLED",n[n.CALIBRATED=2]="CALIBRATED",n))(Ki||{}),Mt=class Mt{constructor(t){t?this.scriptObject=t:this.scriptObject=Mt.DEFAULT_SCRIPT_OBJECT,this.layoutStates={}}process(t,e){return this.scriptObject.gs(t,e)}processNewContextEvent(t,e){return this.scriptObject.gn?this.scriptObject.gn(t,e):!1}processPostKeystroke(t,e){return this.scriptObject.gpk?this.scriptObject.gpk(t,e):!1}get isHollow(){return this.scriptObject==Mt.DEFAULT_SCRIPT_OBJECT}get id(){return this.scriptObject.KI}get name(){return this.scriptObject.KN}get variableStores(){let t=this.scriptObject.KVS,e={};if(Array.isArray(t))for(let n of t)e[n]=this.scriptObject[n];return e}set variableStores(t){let e=this.scriptObject.KVS;if(Array.isArray(e))for(let n of e)typeof t[n]=="string"&&(this.scriptObject[n]=t[n])}get _legacyLayoutSpec(){return this.scriptObject.KV}get _layouts(){return this.scriptObject.KVKL}set _layouts(t){this.scriptObject.KVKL=t}get compilerVersion(){return new M(this.scriptObject.KVER)}get isMnemonic(){return!!this.scriptObject.KM}get definesPositionalOrMnemonic(){return typeof this.scriptObject.KM!="undefined"}get helpText(){return this.scriptObject.KH}get hasScript(){return!!this.scriptObject.KHF}embedScript(t){this.scriptObject.KHF(t)}get oskStyling(){return this.scriptObject.KCSS}get isCJK(){var t;return typeof this.scriptObject.KLC!="undefined"?t=this.scriptObject.KLC:typeof this.scriptObject.LanguageCode!="undefined"&&(t=this.scriptObject.LanguageCode),t=="cmn"||t=="jpn"||t=="kor"}get isRTL(){return!!this.scriptObject.KRTL}get modifierBitmask(){return this.scriptObject.KMBM||C.modifierBitmasks.NON_CHIRAL}get isChiral(){return!!(this.modifierBitmask&C.modifierBitmasks.IS_CHIRAL)}get desktopFont(){return this.scriptObject.KV?this.scriptObject.KV.F:null}get cacheTag(){let t=this.scriptObject._kmw;return t||(t=new gl,this.scriptObject._kmw=t),t}get explodedStores(){return this.cacheTag.stores}get emulatesAltGr(){if(!this.isChiral||this._legacyLayoutSpec==null)return!1;let t=this._legacyLayoutSpec.KLS;if(!t)return!1;var e=m.LCTRLFLAG|m.LALTFLAG,n=t[E.getLayerId(e)],i=t[E.getLayerId(m.K_SHIFTFLAG|e)];if(n!=null&&n!=t[E.getLayerId(m.RALTFLAG)]||i!=null&&i!=t[E.getLayerId(m.RALTFLAG|m.K_SHIFTFLAG)])return!1;var s=this.modifierBitmask;return(s&e)!=e||n==null&&i==null,!0}get usesSupplementaryPlaneChars(){let t=this.scriptObject;return t&&(t.KS&&t.KS==1||t.KN=="Hieroglyphic")}get version(){return this.scriptObject.KBVER||""}usesDesktopLayoutOnDevice(t){return this.scriptObject.KVKL?t.formFactor==V.FormFactor.Desktop:!0}notify(t,e,n){typeof this.scriptObject.KNS=="function"&&this.scriptObject.KNS(t,e,n)}findOrConstructLayout(t){if(this._layouts){if(this._layouts[t]!==void 0)return this._layouts[t];if(t==V.FormFactor.Phone&&this._layouts[V.FormFactor.Tablet])return this._layouts[V.FormFactor.Phone]=this._layouts[V.FormFactor.Tablet];if(t==V.FormFactor.Tablet&&this._layouts[V.FormFactor.Phone])return this._layouts[V.FormFactor.Tablet]=this._layouts[V.FormFactor.Phone]}let e=null;if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.KLS)e=this._legacyLayoutSpec;else if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.BK!=null){for(var n=this._legacyLayoutSpec.BK,i=0;i<n.length;i++)if(n[i].length>0){e=this._legacyLayoutSpec;break}}if(!e&&(this.helpText==""||t!=V.FormFactor.Desktop)&&(e={F:"Tahoma",BK:E.dfltText}),this._layouts||(this._layouts={}),e){let s=this._layouts[t]=E.buildDefaultLayout(e,this,t);return s.isDefault=!0,s}else return this._layouts[t]=null,null}layout(t){let e=this.findOrConstructLayout(t);if(e)if(this.layoutStates[t]==Ki.NOT_LOADED){let n=wt.polyfill(e,this,t);return this.layoutStates[t]=1,n}else return e;else return null}refreshLayouts(){let t=[V.FormFactor.Desktop,V.FormFactor.Phone,V.FormFactor.Tablet],e=this;t.forEach(function(n){e.layoutStates[n]=Ki.NOT_LOADED})}markLayoutCalibrated(t){this.layoutStates[t]!=Ki.NOT_LOADED&&(this.layoutStates[t]=2)}getLayoutState(t){return this.layoutStates[t]}constructNullKeyEvent(t,e){e=e||{K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};let n=ee.constructNullKeyEvent(t);return this.setSyntheticEventDefaults(n,e),n}constructKeyEvent(t,e,n){let i=t.baseKeyEvent;i.device=e,this.isMnemonic&&i.setMnemonicCode(t.layer.indexOf("shift")!=-1,n.K_CAPS),this.setSyntheticEventDefaults(i,n);let l={K_CAPS:C.stateBitmasks.CAPS,K_NUMLOCK:C.stateBitmasks.NUM_LOCK,K_SCROLL:C.stateBitmasks.SCROLL_LOCK}[i.kName];return l&&(i.Lstates^=l,i.LmodifierChange=!0),i}setSyntheticEventDefaults(t,e){t.device.touchable||(t.Lstates=0,t.Lstates|=e.K_CAPS?m.CAPITALFLAG:m.NOTCAPITALFLAG,t.Lstates|=e.K_NUMLOCK?m.NUMLOCKFLAG:m.NOTNUMLOCKFLAG,t.Lstates|=e.K_SCROLL?m.SCROLLFLAG:m.NOTSCROLLFLAG),t.kName&&t.kName.substr(0,2)=="U_"&&(t.LisVirtualKey=!1),typeof t.Lcode=="undefined"&&(t.Lcode=this.getVKDictionaryCode(t.kName),t.Lcode||(t.Lcode=1)),(t.Lmodifiers&C.modifierBitmasks.ALT_GR_SIM)==C.modifierBitmasks.ALT_GR_SIM&&this.emulatesAltGr&&(t.Lmodifiers&=~C.modifierBitmasks.ALT_GR_SIM,t.Lmodifiers|=m.RALTFLAG)}getVKDictionaryCode(t){let e=this.scriptObject.VKDictionary||{};if(!this.scriptObject.VKDictionary){if(typeof this.scriptObject.KVKD=="string"){let s=this.scriptObject.KVKD.split(" ");for(var n=0;n<s.length;n++)e[s[n].toUpperCase()]=n+256}this.scriptObject.VKDictionary=e}let i=e[t.toUpperCase()];return i||0}};o(Mt,"Keyboard"),Mt.DEFAULT_SCRIPT_OBJECT={gs:function(t,e){return!1},KI:"",KN:"",KV:E.DEFAULT_RAW_SPEC,KM:0};var Y=Mt;var Rn={osk:C},ul=class ul{constructor(t,e){this.loadedKeyboard=null;this._jsGlobal=t,this.keymanGlobal=e,this.install()}KR(t){if(this.loadedKeyboard)throw new Error("Unexpected state:  the most-recently loaded keyboard field was not properly reset.");this.loadedKeyboard=new Y(t)}KLOAD(t,e,n){return n}install(){this._jsGlobal.KeymanWeb=this,this._jsGlobal.keyman=this.keymanGlobal}uninstall(){this._jsGlobal.KeymanWeb==this&&delete this._jsGlobal.KeymanWeb,this._jsGlobal.keyman==this.keymanGlobal&&delete this._jsGlobal.keyman}};o(ul,"KeyboardHarness");var yt=ul;var bl=class bl extends Error{constructor(e,n){super(e);this.cause=n}};o(bl,"KeyboardScriptError");var pt=bl,hl=class hl extends Error{constructor(e,n){super(e);this.cause=n}};o(hl,"KeyboardMissingError");var vn=hl,Fl=class Fl{constructor(t){this.uri=t}missingError(t){let e=`Cannot find the keyboard at ${this.uri}.`;return new vn(e,t)}scriptError(t){let e=`Error registering the keyboard script at ${this.uri}; it may contain an error.`;return new pt(e,t)}};o(Fl,"UriBasedErrorBuilder");var Bl=Fl,ml=class ml{constructor(t){this.stub=t}missingError(t){let e=this.stub,n=`Cannot find the ${e.name} keyboard for ${e.langName} at ${e.filename}.`;return new vn(n,t)}scriptError(t){let e=this.stub,n=`Error registering the ${e.name} keyboard for ${e.langName}; keyboard script at ${e.filename} may contain an error.`;return new pt(n,t)}};o(ml,"StubBasedErrorBuilder");var Il=ml,yl=class yl{get harness(){return this._harness}constructor(t){this._harness=t}loadKeyboardFromPath(t){return this.harness.install(),this.loadKeyboardInternal(t,new Bl(t))}loadKeyboardFromStub(t){return this.harness.install(),this.loadKeyboardInternal(t.filename,new Il(t),t.id)}};o(yl,"KeyboardLoaderBase");var Kt=yl;var Fo=(i=>(i.KEYBOARD="keyboard",i.LANGUAGE="language",i.LANGUAGE_KEYBOARD="languageKeyboard",i.BLANK="blank",i))(Fo||{}),Qe=Fo;function pl(a,t){if(a)return{family:a.family,path:t,files:a.filename||a.source}}o(pl,"internalizeFont");var nt=class nt{static get spacebarTextMode(){return typeof this.spacebarTextModeSrc=="string"?this.spacebarTextModeSrc:this.spacebarTextModeSrc()}static set spacebarTextMode(t){this.spacebarTextModeSrc=t}constructor(t,e){if(typeof t!="string")if(t.KI||t.KL||t.KLC||t.KFont||t.KOskFont){let n=t;this.KI=n.KI,this.KN=n.KN,this.KL=n.KL,this.KLC=n.KLC,this.KFont=n.KFont,this.KOskFont=n.KOskFont,this._displayName=n instanceof nt?n._displayName:n.displayName}else{let n=t;n.languages||(n.languages=n.language),this.KI=n.id,this.KN=n.name,this.KL=n.languages.name,this.KLC=n.languages.id,this.KFont=pl(n.languages.font,e),this.KOskFont=pl(n.languages.oskFont,e)}else this.KI=t,this.KLC=e}static fromMultilanguageAPIStub(t){let e=[];t.languages||(t.languages=t.language);for(let n of t.languages){let i={id:t.id,name:t.name,languages:n};e.push(new nt(i))}return e}get id(){return this.KI}get name(){return this.KN}get langId(){return this.KLC}get langName(){return this.KL}get displayName(){if(this._displayName)return this._displayName;let t=this.KN,e=this.KL;switch(nt.spacebarTextMode){case Qe.KEYBOARD:return t;case Qe.LANGUAGE:return e;case Qe.LANGUAGE_KEYBOARD:return t==e?e:e+" - "+t;case Qe.BLANK:return"";default:return t}}set displayName(t){this._displayName=t}get textFont(){return this.KFont}get oskFont(){return this.KOskFont}validateForOSK(){return this.KLC?this.displayName===void 0||nt.spacebarTextMode!=Qe.BLANK&&!this.displayName?new Error("A display name is missing for this keyboard and cannot be generated under current settings."):null:this.KI||this.KN?new Error(`No language code was specified for use with the ${this.KI||this.KN} keyboard`):new Error("No language code was specified for use with the corresponding keyboard")}validateForCustomKeyboard(){return!this.KI||!this.KN||!this.KL||!this.KLC?new Error("To use a custom keyboard, you must specify keyboard id, keyboard name, language and language code."):null}};o(nt,"KeyboardProperties"),nt.spacebarTextModeSrc=Qe.KEYBOARD;var Ye=nt;var mo=o(a=>a.substring(a.length-1)!="/"?a+"/":a,"addDelimiter"),Cl=class Cl{constructor(t,e){e=mo(e),this.sourcePath=e,this.protocol=e.replace(/(.{3,5}:)(.*)/,"$1"),this.updateFromOptions(t)}updateFromOptions(t){let e=this.sourcePath.replace(/(https?:\/\/)([^\/]*)(.*)/,"$1$2/");this._root=e,t.root!=""?this._root=this.fixPath(t.root):this._root=this.fixPath(e);let n=t.resources;n==""&&(n=this.sourcePath),this._resources=this.fixPath(n),this._keyboards=this.fixPath(t.keyboards),this._fonts=this.fixPath(t.fonts)}fixPath(t){return t.length==0||(t=mo(t),t.replace(/^(http)s?:.*/,"$1")=="http"||t.replace(/^(file):.*/,"$1")=="file")?t:t.substring(0,2)=="//"?this.protocol+t:t.substring(0,1)=="/"?this.root+t.substring(1):this.sourcePath+t}get fonts(){return this._fonts}updateFontPath(t){this._fonts=this.fixPath(t)}get root(){return this._root}get resources(){return this._resources}get keyboards(){return this._keyboards}};o(Cl,"PathConfiguration");var zt=Cl;var Gl={root:"",resources:"",keyboards:"",fonts:""};var Ql=class Ql{constructor(t,e){this.suggestions=t,this.transcriptionID=e}};o(Ql,"ReadySuggestions");var Ct=Ql;var Ul=class Ul extends S.default{constructor(e,n){super();this.initNewContext=!0;this._currentSuggestions=[];this.swallowPrediction=!1;this.doRevert=!1;this.recentRevert=!1;this.doTryAccept=o((e,n)=>{let i=this.recentAcceptCause;if(!i&&this.selected)this.accept(this.selected),n.shouldSwallow=!this.currentTarget.getTextAfterCaret(),this.recentAcceptCause="key";else if(i&&e=="space"){if(this.recentAcceptCause=null,i=="key"){n.shouldSwallow=!1;return}n.shouldSwallow=!!this.langProcessor.wordbreaksAfterSuggestions&&!this.currentTarget.getTextAfterCaret()}else n.shouldSwallow=!1},"doTryAccept");this.doTryRevert=o(()=>{this.doRevert?(this.doRevert=!1,this.recentAcceptCause=null):this.recentAcceptCause&&(this.showRevert(),this.swallowPrediction=!0)},"doTryRevert");this.invalidateSuggestions=o(e=>{this.initNewContext=!1,this.selected=null,(!this.swallowPrediction||e=="context")&&(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1,e=="context"&&(this.swallowPrediction=!1,this.initNewContext=!0)),e!="new"&&this.clearSuggestions()},"invalidateSuggestions");this.updateSuggestions=o(e=>{let n=e.suggestions;this._currentSuggestions=n,this.selected=null,this.keepSuggestion=null;for(let i of n)i.tag=="keep"&&(this.keepSuggestion=i),i.autoAccept&&!this.selected&&(this.selected=i);this.keepSuggestion&&this._currentSuggestions.splice(this._currentSuggestions.indexOf(this.keepSuggestion),1),this.swallowPrediction?this.swallowPrediction=!1:(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1),this.sendUpdateEvent()},"updateSuggestions");this.onModelStateChange=o(e=>{(e=="configured"||e=="inactive")&&this.resetContext()},"onModelStateChange");this.langProcessor=e,this.getLayerId=n;let i=o(()=>this.currentTarget&&e.state=="configured","validSuggestionState");this.suggestionApplier=s=>i()?e.applySuggestion(s,this.currentTarget,n):null,this.suggestionReverter=s=>W(this,null,function*(){if(i()){let l=yield e.applyReversion(s,this.currentTarget);this.swallowPrediction=!0,this.updateSuggestions(new Ct(l,s.id?-s.id:void 0))}}),this.connect()}get currentTarget(){return this._currentTarget}setCurrentTarget(e){let n=this._currentTarget;return this._currentTarget=e,n!=e?this.resetContext():Promise.resolve([])}connect(){this.langProcessor.addListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.addListener("suggestionsready",this.updateSuggestions),this.langProcessor.addListener("tryaccept",this.doTryAccept),this.langProcessor.addListener("tryrevert",this.doTryRevert),this.langProcessor.addListener("statechange",this.onModelStateChange)}disconnect(){this.langProcessor.removeListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.removeListener("suggestionsready",this.updateSuggestions),this.langProcessor.removeListener("tryaccept",this.doTryAccept),this.langProcessor.removeListener("tryrevert",this.doTryRevert),this.langProcessor.removeListener("statechange",this.onModelStateChange),this.clearSuggestions()}get currentSuggestions(){let e=[],n=this.activateKeep()&&this.keepSuggestion,i=this.selected&&this.keepSuggestion!=this.selected;return n&&(i||this.keepSuggestion.matchesModel)?e.push(this.keepSuggestion):this.doRevert&&e.push(this.revertSuggestion),e.concat(this._currentSuggestions)}acceptInternal(e){return e?e.tag=="revert"?(this.suggestionReverter(e),null):this.suggestionApplier(e):null}accept(e){let n=this;return this.selected=null,this.doRevert=!1,this.revertAcceptancePromise=this.acceptInternal(e),this.revertAcceptancePromise?(this.revertAcceptancePromise.then(function(i){i&&(n.revertSuggestion=i)}),this.recentAcceptCause="banner",this.recentRevert=!1,this.swallowPrediction=!0,this.revertAcceptancePromise):(e&&e.tag=="revert"&&(this.recentAcceptCause=null,this.recentRevert=!0),Promise.resolve(null))}showRevert(){this.doRevert=!0,this.sendUpdateEvent()}clearSuggestions(){this.updateSuggestions({suggestions:[],transcriptionID:0})}activateKeep(){return!this.recentAcceptCause&&!this.recentRevert&&!this.initNewContext}sendUpdateEvent(){this.emit("update",this.currentSuggestions)}resetContext(){let e=this.currentTarget;return e?this.langProcessor.invalidateContext(e,this.getLayerId()):Promise.resolve([])}};o(Ul,"PredictionContext");var Gt=Ul;var zi=class zi{constructor(t){t.OS==V.OperatingSystem.Android?this.popupCanvasBackgroundColor="#999":this.popupCanvasBackgroundColor=zi.prefersDarkMode()?"#0f1319":"#ffffff"}static prefersDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}};o(zi,"StyleConstants");var Hn=zi;var xl=class xl{constructor(){this.touchable="ontouchstart"in window,this.OS="",this.formFactor="desktop",this.browser="",this.dyPortrait=0,this.dyLandscape=0,this.version="0",this.orientation=window.orientation}getDPI(){var t=document.createElement("DIV"),e=t.style,n=96;return document.readyState!=="complete"||(t.id="calculateDPI",e.position="absolute",e.display="block",e.visibility="hidden",e.left="10px",e.top="10px",e.width="1in",e.height="10px",document.body.appendChild(t),n=typeof window.devicePixelRatio=="undefined"?t.offsetWidth:t.offsetWidth*window.devicePixelRatio,document.body.removeChild(t)),n}detect(){var t=!1;if(navigator&&navigator.userAgent){var e=navigator.userAgent;if(e.indexOf("iPad")>=0)this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;else if(e.indexOf("iPhone")>=0)this.OS="iOS",this.formFactor="phone",this.dyPortrait=this.dyLandscape=25;else if(e.indexOf("Android")>=0){this.OS="Android",this.formFactor="phone",this.dyPortrait=75,this.dyLandscape=25;try{var n=new RegExp("(?:Android\\s+)(\\d+\\.\\d+\\.\\d+)");this.version=e.match(n)[1]}catch(g){}}else if(e.indexOf("Linux")>=0)this.OS="Linux";else if(e.indexOf("Macintosh")>=0){let d=/Intel Mac OS X (\d+(?:[_\.]\d+)+)/i.exec(e);if(!d)console.warn("KMW could not properly parse the user agent string.A suboptimal keyboard layout may result."),this.OS="MacOSX";else if(d.length>1&&d[1]){let u=d[1].replace("_","."),I=new M(u);t=M.MAC_POSSIBLE_IPAD_ALIAS.compareTo(I)<=0,this.OS="MacOSX"}}else e.indexOf("Windows NT")>=0&&(this.OS="Windows",e.indexOf("Touch")>=0&&(this.formFactor="phone"),typeof navigator.msMaxTouchPoints=="number"&&navigator.msMaxTouchPoints>0&&(this.touchable=!0))}let i=Math.min(screen.width,screen.height),s=Math.max(screen.width,screen.height),l=i/s;this.OS!="iOS"&&this.formFactor=="phone"&&(i>=600&&l>.5625||l>=.625)&&(this.formFactor="tablet");let r=navigator.platform=="Win32"||navigator.platform=="MacIntel";this.OS=="iOS"&&!("ongesturestart"in window)&&!r&&(this.OS="Android"),this.browser="web",(this.OS=="iOS"||this.OS.toLowerCase()=="macosx")&&(this.browser="safari");var c=/Firefox|Chrome|OPR|Safari|Edge/;if(c.test(navigator.userAgent)&&(navigator.userAgent.indexOf("Firefox")>=0&&"onmozorientationchange"in screen?this.browser="firefox":navigator.userAgent.indexOf("OPR")>=0?this.browser="opera":navigator.userAgent.indexOf(" Edge/")>=0?this.browser="edge":navigator.userAgent.indexOf("Chrome")>=0?this.browser="chrome":navigator.userAgent.indexOf("Safari")>=0&&(this.browser="safari")),t&&this.browser=="safari"&&window.TouchEvent){this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;let g=screen.height/screen.width;g<1&&(g=1/g),g>1.6&&(this.formFactor="phone",this.dyPortrait=this.dyLandscape=25)}return this.colorScheme=Hn.prefersDarkMode()?"dark":"light",this.coreSpec}get coreSpec(){return new V(this.browser,this.formFactor,this.OS,this.touchable)}};o(xl,"DeviceDetector");var Qt=xl;var Xl=class Xl extends S.default{constructor(e,n){super();this.applyCacheBusting=!1;if(!n){let i=new Qt;i.detect(),n=i.coreSpec}this.sourcePath=e,this.hostDevice=n,this.deferForInitialization=new f}initialize(e){this._paths?this._paths.updateFromOptions(e):this._paths=new zt(e,this.sourcePath),typeof e.setActiveOnRegister=="boolean"?this.activateFirstKeyboard=e.setActiveOnRegister:this.activateFirstKeyboard=!0,this._spacebarText=e.spacebarText,Ye.spacebarTextMode=()=>this.spacebarText}finalizeInit(){this.deferForInitialization.resolve()}get paths(){return this._paths}get spacebarText(){return this._spacebarText}set spacebarText(e){this._spacebarText!=e&&(this._spacebarText=e,this.emit("spacebartext",e))}get softDevice(){return this.hostDevice}get hardDevice(){return ll(this.hostDevice)}get stubNamespacer(){return this._stubNamespacer}set stubNamespacer(e){this._stubNamespacer=e}debugReport(){return{hostDevice:this.hostDevice,initialized:this.deferForInitialization.isResolved}}onRuleFinalization(e,n){}};o(Xl,"EngineConfiguration");var Jn=Xl,Zl=y({setActiveOnRegister:!0,spacebarText:Qe.LANGUAGE_KEYBOARD},Gl);var kn=class kn extends S.default{constructor(e){super();this.pendingActivations=[];this.engineConfig=e}get predictionContext(){return this._predictionContext}configure(e){this._resetContext=e.resetContext,this._predictionContext=e.predictionContext,this.keyboardCache=e.keyboardCache}insertText(e,n,i){let s=this.activeTarget;return s!=null?(n!=null&&e.output(0,s,n),typeof i!="undefined"&&i!==null&&e.deadkeyOutput(0,s,i),s.invalidateSelection(),!0):!1}resetContext(){this._resetContext(this.activeTarget),this.predictionContext.resetContext()}findAndPopActivation(e){let n;for(n=0;n<this.pendingActivations.length&&this.pendingActivations[n].target!=e;n++);return n==this.pendingActivations.length?null:this.pendingActivations.splice(n,1)[0]}deferredKeyboardActivation(e,n,i){return W(this,null,function*(){let s={target:i,keyboard:e,stub:n};this.findAndPopActivation(i),this.pendingActivations.push(s),yield e;let l=this.findAndPopActivation(i);return l==s?s:(l&&this.pendingActivations.push(l),null)})}activateKeyboard(e,n,i){return W(this,null,function*(){let s=!this.activeKeyboard;this.findAndPopActivation(this.currentKeyboardSrcTarget());let l=this.prepareKeyboardForActivation(e,n),r=this.currentKeyboardSrcTarget(),c=yield l.keyboard;if(c==null&&l.metadata)return!1;this.currentKeyboardSrcTarget()==r&&this.emit("beforekeyboardchange",l.metadata);let g=null;return c&&(g={keyboard:c,metadata:l.metadata}),this.activateKeyboardForTarget(g,r),this.currentKeyboardSrcTarget()==r&&(!s||c)&&this.emit("keyboardchange",this.activeKeyboard),!0})}prepareKeyboardForActivation(e,n){var l;n||(n="");let i=null;if(e?i=this.keyboardCache.getStub(e,n):n=="",!i){if(e)throw new Error("No matching stub has been registered.");return{keyboard:Promise.resolve(null),metadata:null}}if((l=this.activeKeyboard)!=null&&l.metadata&&e==this.activeKeyboard.metadata.id){let r=this.activeKeyboard.keyboard;return{keyboard:Promise.resolve(r),metadata:i}}let s;if(s=this.keyboardCache.getKeyboardForStub(i))return{keyboard:Promise.resolve(s),metadata:i};{this.emit("beforekeyboardchange",i);let r=this.engineConfig.deferForInitialization.then(()=>{let g=new f;this.emit("keyboardasyncload",i,g.corePromise);let d=this.keyboardCache.fetchKeyboardForStub(i),u=new Promise((B,h)=>{let b=`Sorry, the ${i.name} keyboard for ${i.langName} is not currently available.`;window.setTimeout(()=>h(new Error(b)),kn.TIMEOUT_THRESHOLD)}),I=Promise.race([d,u]);return I.then(()=>{g.resolve(null),u.catch(()=>{})}),I.catch(B=>{throw g.resolve(B),B}),I});return{keyboard:this.deferredKeyboardActivation(r,i,this.currentKeyboardSrcTarget()).then(g=>W(this,null,function*(){return g?r:Promise.resolve(null)})),metadata:i}}}};o(kn,"ContextManagerBase"),kn.TIMEOUT_THRESHOLD=1e4;var Nn=kn;var Vl=class Vl extends S.default{};o(Vl,"HardKeyboard");var Dt=Vl;function Sl(a,t,e){if(t&&t.isMnemonic&&a.setMnemonicCode(!!(a.Lmodifiers&m.K_SHIFTFLAG),!!(a.Lmodifiers&m.CAPITALFLAG)),t&&!t.isMnemonic){var n=te.languageMap[e];n&&n["k"+a.Lcode]&&(a.Lcode=n["k"+a.Lcode]),!t.definesPositionalOrMnemonic&&!(a.Lmodifiers&C.modifierBitmasks.NON_LEGACY)&&!a.isModifier&&(a=new ee({Lcode:te._USKeyCodeToCharCode(a),Lmodifiers:0,LisVirtualKey:!1,vkCode:a.Lcode,Lstates:a.Lstates,kName:"",device:a.device,isSynthetic:!1}))}return a}o(Sl,"processForMnemonicsAndLegacy");function Al(a,t,e){let n=Math.min(a.length,t.length),i,s,l,r,c;for(e?(i=s=a.length-1,l=s-n,r=-1,c=t.length-a.length):(i=s=0,l=n,r=1,c=0);s!=l&&a.charAt(s)==t.charAt(s+c);s+=r);if(s!=i&&s!=l){let g=a.charCodeAt(s-r),d=a.charCodeAt(s),u=t.charCodeAt(s+c),I=e?Ei:Ni,B=e?Ni:Ei;if(I(g)&&(B(d)||B(u)))return s-r}return s}o(Al,"findCommonSubstringEndIndex");var Ut=class Ut{constructor(t,e){this.p=t,this.d=e,this.o=Ut.ordinalSeed++}match(t,e){var n=this.p==t&&this.d==e;return n}set(){this.matched=1}reset(){this.matched=0}before(t){return this.o<t.o}clone(){let t=new Ut(this.p,this.d);return t.o=this.o,t}equal(t){return this.d==t.d&&this.p==t.d&&this.o==t.o}};o(Ut,"Deadkey"),Ut.ordinalSeed=0,Ut.sortFunc=o(function(t,e){return t.p!=e.p?e.p-t.p:e.o-t.o},"sortFunc");var En=Ut,Oi=class Oi{constructor(){this.dks=[]}toSortedArray(){return this.dks=this.dks.sort(En.sortFunc),[].concat(this.dks)}clone(){let t=new Oi,e=this.toSortedArray();return t.dks=[],e.forEach(function(n){t.dks.push(n.clone())}),t}isMatch(t,e,n){if(this.dks.length==0)return!1;var i=t;e=i-e;for(var s=0;s<this.dks.length;s++)if(this.dks[s].match(e,n)&&!this.dks[s].matched)return this.dks[s].set(),!0;return this.resetMatched(),!1}add(t){this.dks=this.dks.concat(t)}remove(t){var e=this.dks.indexOf(t);this.dks.splice(e,1)}clear(){this.dks=[]}resetMatched(){for(let t of this.dks)t.reset()}deleteMatched(){for(var t=0;t<this.dks.length;t++)this.dks[t].matched&&this.dks.splice(t--,1)}adjustPositions(t,e){if(e!=0)for(let n of this.dks)n.p>t&&(n.p+=e)}equal(t){if(this.dks.length!=t.dks.length)return!1;let e=t.dks,n=[];for(let i of this.dks)if(!e.find(l=>i.equal(l)))return!1;return n.length==e.length}count(){return this.dks.length}};o(Oi,"DeadkeyTracker");var Di=Oi;fn();function xt(a){var t;return a?a.insert===""&&a.deleteLeft===0&&((t=a.deleteRight)!=null?t:0)===0:!0}o(xt,"isEmptyTransform");var Yn=class Yn{constructor(t,e,n,i){this.insert=t,this.deleteLeft=e,this.deleteRight=n,this.erasedSelection=i}};o(Yn,"TextTransform"),Yn.nil=new Yn("",0,0,!1);var Wl=Yn,Tn=class Tn{constructor(t,e,n,i){let s=this.token=Tn.tokenSeed++;this.keystroke=t,this.transform=e,this.alternates=i,this.preInput=n,this.transform.id=this.token,i&&i.forEach(function(l){l.sample.id=s})}};o(Tn,"Transcription"),Tn.tokenSeed=0;var fl=Tn,Ll=class Ll{constructor(){this._dks=new Di}get isSynthetic(){return!0}resetContext(){this.deadkeys().clear()}deadkeys(){return this._dks}hasDeadkeyMatch(t,e){return this.deadkeys().isMatch(this.getDeadkeyCaret(),t,e)}insertDeadkeyBeforeCaret(t){var e=new En(this.getDeadkeyCaret(),t);this.deadkeys().add(e)}adjustDeadkeys(t){this.deadkeys().adjustPositions(this.getDeadkeyCaret(),t)}setDeadkeys(t){this._dks=t.clone()}buildTransformFrom(t){let e=this.getTextBeforeCaret(),n=t.getTextBeforeCaret(),i=Al(n,e,!1),s=n.substring(i)._kmwLength(),l=e.substring(i),r=this.getTextAfterCaret(),c=t.getTextAfterCaret(),g=Al(c,r,!0),d=c.substring(0,g+1)._kmwLength();return new Wl(l,s,d,t.getSelectedText()&&!this.getSelectedText())}buildTranscriptionFrom(t,e,n,i){let s=this.buildTransformFrom(t);return new fl(e,s,k.from(t,n),i)}restoreTo(t){this.clearSelection(),this.setTextBeforeCaret(t.getTextBeforeCaret()),this.setTextAfterCaret(t.getTextAfterCaret()),this._dks=t._dks.clone()}apply(t){this.clearSelection(),t.deleteRight&&this.setTextAfterCaret(this.getTextAfterCaret()._kmwSubstr(t.deleteRight)),t.deleteLeft&&this.deleteCharsBeforeCaret(t.deleteLeft),t.insert&&this.insertTextBeforeCaret(t.insert),this._dks.clear()}setTextBeforeCaret(t){this.deleteCharsBeforeCaret(this.getTextBeforeCaret()._kmwLength()),this.insertTextBeforeCaret(t)}saveProperties(){}restoreProperties(){}};o(Ll,"OutputTarget");var it=Ll;var Ot=class Ot extends it{constructor(e,n,i){super();this.selForward=!0;this.text=e||"";var s=this.text._kmwLength();this.selStart=typeof n=="number"?n:s,this.selEnd=typeof i=="number"?i:this.selStart,this.selForward=this.selEnd>=this.selStart}static from(e,n){let i;if(e instanceof Ot){let s=e;i=new Ot(s.text,s.selStart,s.selEnd)}else{let s=e.getText(),l=s._kmwLength(),r=l,c=0;if(e.hasSelection()){let g=e.getTextBeforeCaret(),d=e.getTextAfterCaret();r=g._kmwLength(),c=l-d._kmwLength()}i=new Ot(s,r,c)}return i.setDeadkeys(e.deadkeys()),i}clearSelection(){this.text=this.getTextBeforeCaret()+this.getTextAfterCaret(),this.selEnd=this.selStart,this.selForward=!0}invalidateSelection(){}isSelectionEmpty(){return this.selStart==this.selEnd}hasSelection(){return!0}getDeadkeyCaret(){return this.selStart}setSelection(e,n){if(this.selStart=e,this.selEnd=typeof n=="number"?n:e,this.selForward=n>=e,!this.selForward){let i=this.selStart;this.selStart=this.selEnd,this.selEnd=i}}getTextBeforeCaret(){return this.text.kmwSubstr(0,this.selStart)}getSelectedText(){return this.text.kmwSubstr(this.selStart,this.selEnd-this.selStart)}getTextAfterCaret(){return this.text.kmwSubstr(this.selEnd)}getText(){return this.text}deleteCharsBeforeCaret(e){e>=0&&(e>this.selStart&&(e=this.selStart),this.adjustDeadkeys(-e),this.text=this.text.kmwSubstr(0,this.selStart-e)+this.text.kmwSubstr(this.selStart),this.selStart-=e,this.selEnd-=e)}insertTextBeforeCaret(e){this.adjustDeadkeys(e._kmwLength()),this.text=this.getTextBeforeCaret()+e+this.text.kmwSubstr(this.selStart),this.selStart+=e.kmwLength(),this.selEnd+=e.kmwLength()}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}setTextAfterCaret(e){this.text=this.getTextBeforeCaret()+e}isEqual(e){return this.text==e.text&&this.selStart==e.selStart&&this.selEnd==e.selEnd&&this.deadkeys().equal(e.deadkeys())}doInputEvent(){}};o(Ot,"Mock");var k=Ot;var Rl=class Rl{constructor(){this.transcription=null;this.setStore={};this.saveStore={};this.variableStores={};this.triggersDefaultCommand=!1}finalize(t,e,n){if(!this.transcription)throw"Cannot finalize a RuleBehavior with no transcription.";t.beepHandler&&this.beep&&t.beepHandler(e);for(let i in this.setStore){let s=t.keyboardInterface.systemStores[i];if(s)try{s.set(this.setStore[i])}catch(l){t.errorLogger&&t.errorLogger("Rule attempted to perform illegal operation - 'platform' may not be changed.")}else t.warningLogger&&t.warningLogger("Unknown store affected by keyboard rule: "+i)}if(t.keyboardInterface.applyVariableStores(this.variableStores),t.keyboardInterface.variableStoreSerializer)for(let i in this.saveStore)t.keyboardInterface.variableStoreSerializer.saveStore(t.activeKeyboard.id,i,this.saveStore[i]);if(this.triggersDefaultCommand){let i=this.transcription.keystroke;t.defaultRules.applyCommand(i,e)}t.warningLogger&&this.warningLog?t.warningLogger(this.warningLog):t.errorLogger&&this.errorLog&&t.errorLogger(this.errorLog)}mergeInDefaults(t){let e=this.transcription.keystroke,n=t.transcription.keystroke;if(e.Lcode!=n.Lcode||e.Lmodifiers!=n.Lmodifiers)throw"RuleBehavior default-merge not supported unless keystrokes are identical!";this.triggersDefaultCommand=this.triggersDefaultCommand||t.triggersDefaultCommand;let i=k.from(this.transcription.preInput,!1);i.apply(this.transcription.transform),i.apply(t.transcription.transform),this.transcription=i.buildTranscriptionFrom(this.transcription.preInput,e,!1,this.transcription.alternates)}};o(Rl,"RuleBehavior");var ie=Rl;var vl=class vl{constructor(t){this.id=t}set(t){throw new Error("System store with ID "+this.id+" may not be directly set.")}};o(vl,"SystemStore");var Pi=vl,Hl=class Hl extends Pi{constructor(e,n){super(e);this.handler=null;this._value=n}get value(){return this._value}matches(e){return this._value==e}set(e){this.handler&&this.handler(this,e)||(this._value=e)}};o(Hl,"MutableSystemStore");var Pt=Hl,Jl=class Jl extends Pi{constructor(e){super(31);this.kbdInterface=e}matches(e){var n,i,s=e.split(" ");let l=this.kbdInterface.activeDevice;for(n=0;n<s.length;n++)switch(i=s[n].toLowerCase(),i){case"touch":case"hardware":if(l.touchable!=(i=="touch"))return!1;break;case"macos":case"mac":i="macosx";case"macosx":case"windows":case"android":case"ios":case"linux":if(l.OS!=i)return!1;break;case"tablet":case"phone":case"desktop":if(l.formFactor!=i)return!1;break;case"web":if(l.browser=="native")return!1;break;case"native":case"chrome":case"firefox":case"safari":case"edge":case"opera":if(l.browser!=i)return!1;break;default:return!1}return!0}};o(Jl,"PlatformSystemStore");var ji=Jl;var Yl=class Yl{};o(Yl,"KeyInformation");var kl=Yl;var Tl=class Tl{reset(){this._cache=[]}get(t,e){return typeof this._cache[t]=="undefined"||typeof this._cache[t][e]=="undefined"?null:this._cache[t][e]}set(t,e,n){typeof this._cache[t]=="undefined"&&(this._cache[t]=[]),this._cache[t][e]=n}};o(Tl,"CachedContext");var Nl=Tl,_i=class _i{reset(){this._cache=[]}get(t,e){return typeof this._cache[t]=="undefined"||typeof this._cache[t][e]=="undefined"?null:this._cache[t][e]}set(t,e,n){typeof this._cache[t]=="undefined"&&(this._cache[t]=[]),this._cache[t][e]=n}clone(){let t=new _i;return t._cache=this._cache,t}};o(_i,"CachedContextEx");var El=_i,wn=class wn extends yt{constructor(e,n,i=null){super(e,n);this.cachedContext=new Nl;this.cachedContextEx=new El;this._AnyIndices=[];this.systemStores={},this.systemStores[31]=new ji(this),this.systemStores[33]=new Pt(33,"default"),this.systemStores[42]=new Pt(42,""),this.systemStores[43]=new Pt(43,""),this.variableStoreSerializer=i}get Codes(){return C}saveFocus(){}registerKeyboard(e){let n=new Y(e);this.loadedKeyboard=n}context(e,n,i){var s=this.cachedContext.get(e,n);if(s!==null)return s;var l=this.KC_(e,n,i);return this.cachedContext.set(e,n,l),l}KC_(e,n,i){var s="";return s=i.isSelectionEmpty()?i.getTextBeforeCaret():"",s._kmwLength()<e&&(s=Array(e-s._kmwLength()+1).join("๏ฟพ")+s),s._kmwSubstr(-e)._kmwSubstr(0,n)}nul(e,n){var i=this.context(e+1,1,n);return i==="๏ฟพ"}contextMatch(e,n,i,s){var l=this.context(e,s,n);return l===i?!0:(n.deadkeys().resetMatched(),!1)}_BuildExtendedContext(e,n,i){var s=this.cachedContextEx.get(e,n);if(s!==null)return s;if(s=this.cachedContextEx.get(e,e),s===null){let I=i.deadkeys().toSortedArray();var l=0;for(s={valContext:[],deadContext:[]};s.valContext.length<e;){var r=i.getDeadkeyCaret(),c=r-l;if(I.length>0&&I[0].p>c){I.splice(0,1);continue}else if(I.length>0&&I[0].p==c)s.deadContext[e-s.valContext.length-1]=I[0],s.valContext=[I[0].d].concat(s.valContext),I.splice(0,1);else{var g=this.context(++l,1,i);s.valContext=[g].concat(s.valContext)}}this.cachedContextEx.set(e,e,s)}var d=s;d.valContext=d.valContext.slice(0,n);for(var u=0;u<d.valContext.length;u++)d.valContext[u]=="๏ฟพ"&&(d.valContext.splice(0,1),d.deadContext.splice(0,1));return d.valContext.length==0&&(d.valContext=["๏ฟพ"],d.deadContext=[]),this.cachedContextEx.set(e,n,d),d}fullContextMatch(e,n,i){var s=this._BuildExtendedContext(e,i.length,n);this.ruleContextEx=this.cachedContextEx.clone();var l=s.valContext,r=s.deadContext,c=!1;let g="๏ฟพ";for(var d=o(function(G){throw new Error("Unexpected object in fullContextMatch specification: "+G)},"assertNever"),u=0;u<i.length;u++)if(typeof i[u]=="string"){var I=i[u];if(I!==l[u]){c=!0;break}}else{var B=i[u];switch(B.t){case"d":B.d!==l[u]?c=!0:r[u].set();break;case"a":var h;typeof l[u]=="string"?h=l[u]:h={t:"d",d:l[u]};var b=this.any(u,h,B.a);B.n?B.n&&(b||l[u]===g)&&(c=!0):b?r[u]!==void 0&&r[u].set():c=!0;break;case"i":var F=this._Index(B.i,B.o);F!==void 0&&(typeof F=="string"?F:F.d)!==l[u]?c=!0:r[u]!==void 0&&r[u].set();break;case"c":l[B.c-1]!==l[u]?c=!0:r[u]!==void 0&&r[u].set();break;case"n":l[u]!=g&&(c=!0);break;default:d(B)}}return c&&(n.deadkeys().resetMatched(),this._AnyIndices=[]),!c}isKeypress(e){return this.activeKeyboard.isMnemonic?!e.LisVirtualKey:!!te._USKeyCodeToCharCode(e)}static matchModifiersToRuleChirality(e,n){let i=m.LALTFLAG|m.RALTFLAG,s=m.LCTRLFLAG|m.RCTRLFLAG,l=e;if(!(n&i)){let r=l&i;r&&(l^=r|m.K_ALTFLAG)}if(!(n&s)){let r=l&s;r&&(l^=r|m.K_CTRLFLAG)}return l}keyMatch(e,n,i){var s=!1,l=e.Lcode==173?189:e.Lcode;let r=this.activeKeyboard.modifierBitmask;var c=r&C.modifierBitmasks.ALL,g=r&C.stateBitmasks.ALL;let d=wn.matchModifiersToRuleChirality(e.Lmodifiers,n);return e.vkCode>255&&(l=e.vkCode),e.LisVirtualKey||l>255?((n&16384)==16384||l>255)&&(s=i==l&&(n&c)==d,s=s&&this.stateMatch(e,n&g)):n&16384||(s=l==i),s||this.activeTargetOutput.deadkeys().resetMatched(),s}stateMatch(e,n){return(n&e.Lstates)==n}keyInformation(e){var n=new kl;return n.vk=e.LisVirtualKey,n.code=e.Lcode,n.modifiers=e.Lmodifiers,n}deadkeyMatch(e,n,i){return n.hasDeadkeyMatch(e,i)}beep(e){this.resetContextCache(),this.ruleBehavior.beep=!0}_ExplodeStore(e){if(typeof e=="string"){let s=this.activeKeyboard.explodedStores;if(s[e])return s[e];for(var n=[],i=0;i<e._kmwLength();i++)n.push(e._kmwCharAt(i));return s[e]=n,n}else return e}any(e,n,i){if(n=="")return!1;i=this._ExplodeStore(i);for(var s=-1,l=0;l<i.length;l++){let r=i[l];if(typeof r=="string"){if(i[l]==n){s=l;break}}else if(r.d===n.d){s=l;break}}return this._AnyIndices[e]=s,s>=0}_Index(e,n){return e=this._ExplodeStore(e),this._AnyIndices[n-1]<e.length?e[this._AnyIndices[n-1]]:(console.warn("Unmatched contextual index() statement detected in rule with index "+n+"!"),"")}indexOutput(e,n,i,s){this.resetContextCache();var l=o(function(c){throw new Error("Unexpected object in fullContextMatch specification: "+c)},"assertNever"),r=this._Index(n,i);if(r!=="")if(typeof r=="string")this.output(e,s,r);else if(r.t)switch(r.t){case"b":this.beep(s);break;case"d":this.deadkeyOutput(e,s,r.d);break;default:l(r)}else this.deadkeyOutput(e,s,r.d)}deleteContext(e,n){var i;if(e>0){i=this._BuildExtendedContext(e,e,n);let r=0;for(var s=0;s<i.valContext.length;s++){var l=i.deadContext[s];l?(n.deadkeys().remove(l),e--):i.valContext[s]=="๏ฟพ"&&r++}let c=i.valContext.length-r;e>c&&(e=c)}n.deadkeys().resetMatched(),this.output(e,n,"")}output(e,n,i){this.resetContextCache(),n.saveProperties(),n.clearSelection(),n.deadkeys().deleteMatched(),e>=0&&n.deleteCharsBeforeCaret(e),n.insertTextBeforeCaret(i),n.restoreProperties()}contextExOutput(e,n,i,s){this.resetContextCache(),e>=0&&this.output(e,n,"");let l=this.ruleContextEx.get(i,i),r=l.deadContext[s-1],c=l.valContext[s-1];if(r)n.insertDeadkeyBeforeCaret(r.d);else if(typeof c=="string")this.output(-1,n,c);else throw new Error("contextExOutput: should never be a numeric valContext with no corresponding deadContext")}deadkeyOutput(e,n,i){this.resetContextCache(),e>=0&&this.output(e,n,""),n.insertDeadkeyBeforeCaret(i)}ifStore(e,n,i){var s=!0;let l=this.systemStores[e];return l&&(s=l.matches(n)),s}setStore(e,n,i){return this.resetContextCache(),e==33&&this.activeDevice.touchable?(this.ruleBehavior.setStore[e]=n,!0):!1}loadStore(e,n,i){return this.resetContextCache(),this.variableStoreSerializer&&this.variableStoreSerializer.loadStore(e,n)[n]||i}saveStore(e,n){this.resetContextCache();var i=this.activeKeyboard;if(!i||typeof i.id=="undefined"||i.id=="")return!1;let s={};return s[e]=n,this.ruleBehavior?this.ruleBehavior.saveStore[e]=s:this.variableStoreSerializer.saveStore(this.activeKeyboard.id,e,s),!0}resetContextCache(){this.cachedContext.reset(),this.cachedContextEx.reset()}defaultBackspace(e){e.isSelectionEmpty()?this.output(1,e,""):this.output(0,e,"")}processNewContextEvent(e,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processNewContextEvent.bind(this.activeKeyboard),e,n,!0)}processPostKeystroke(e,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processPostKeystroke.bind(this.activeKeyboard),e,n,!0)}processKeystroke(e,n){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.process.bind(this.activeKeyboard),e,n,!1)}process(e,n,i,s){if(n)if(this.activeKeyboard){if(!e)throw"No callee for keystroke processing!"}else throw"No active keyboard for keystroke processing!";else throw"No target specified for keyboard output!";n.invalidateSelection(),n.deadkeys().resetMatched(),this.resetContextCache();let l=k.from(n,!0),r=this.activeKeyboard.variableStores;this.ruleBehavior=new ie,this.activeDevice=i.device,this.activeTargetOutput=n;var c=e(n,i);this.activeTargetOutput=null,this.ruleBehavior.transcription=n.buildTranscriptionFrom(l,i,s),this.ruleBehavior.variableStores=this.activeKeyboard.variableStores,this.activeKeyboard.variableStores=r,this.ruleBehavior.triggerKeyDefault=!c;let g=this.ruleBehavior;return this.ruleBehavior=null,g}applyVariableStores(e){this.activeKeyboard.variableStores=e}static __publishShorthandAPI(){let e=this.prototype;var n=o(function(i,s){e[s]&&(e[i]=e[s])},"exportKBCallback");n("KSF","saveFocus"),n("KBR","beepReset"),n("KT","insertText"),n("KR","registerKeyboard"),n("KRS","registerStub"),n("KC","context"),n("KN","nul"),n("KCM","contextMatch"),n("KFCM","fullContextMatch"),n("KIK","isKeypress"),n("KKM","keyMatch"),n("KSM","stateMatch"),n("KKI","keyInformation"),n("KDM","deadkeyMatch"),n("KB","beep"),n("KA","any"),n("KDC","deleteContext"),n("KO","output"),n("KDO","deadkeyOutput"),n("KCXO","contextExOutput"),n("KIO","indexOutput"),n("KIFS","ifStore"),n("KSETS","setStore"),n("KLOAD","loadStore"),n("KSAVE","saveStore")}};o(wn,"KeyboardInterface"),wn.GLOBAL_NAME="KeymanWeb";var Te=wn;(function(){Te.__publishShorthandAPI()})();var Zt=class Zt extends S.default{constructor(e,n){super();this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.modStateFlags=0;n||(n=Zt.DEFAULT_OPTIONS),this.contextDevice=e,this.baseLayout=n.baseLayout||Zt.DEFAULT_OPTIONS.baseLayout,this.keyboardInterface=n.keyboardInterface||new Te(Et(),Rn),this.defaultRules=n.defaultOutputRules||Zt.DEFAULT_OPTIONS.defaultOutputRules}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(e){this.keyboardInterface.activeKeyboard=e,this.resetContext()}get layerStore(){return this.keyboardInterface.systemStores[33]}get newLayerStore(){return this.keyboardInterface.systemStores[42]}get oldLayerStore(){return this.keyboardInterface.systemStores[43]}get layerId(){return this.layerStore.value}set layerId(e){this.layerStore.set(e)}defaultRuleBehavior(e,n,i){let s=k.from(n,i),l=new ie,r=!1;var c="",g;if(e.isSynthetic||n.isSynthetic)if(r=!0,this.defaultRules.isCommand(e))l.triggersDefaultCommand=!0;else if((g=this.defaultRules.forSpecialEmulation(e))!=null)switch(g){case"\b":this.keyboardInterface.defaultBackspace(n);break;case`
`:n.handleNewlineAtCaret();break;default:l.errorLog="Unexpected 'special emulation' character (\\u"+g.kmwCharCodeAt(0).toString(16)+") went unhandled!"}else r=!1;let d=this.activeKeyboard&&this.activeKeyboard.isMnemonic;if(!r)if((c=this.defaultRules.forAny(e,d,l))!=null)if(g=this.defaultRules.forSpecialEmulation(e),g=="\b")this.keyboardInterface.defaultBackspace(n);else{if(g||this.defaultRules.isCommand(e))return null;this.keyboardInterface.output(0,n,c)}else return null;if(l.errorLog)return l;let u=n.buildTranscriptionFrom(s,e,i);return l.transcription=u,l}processNewContextEvent(e,n){return this.activeKeyboard?this.keyboardInterface.processNewContextEvent(n,this.activeKeyboard.constructNullKeyEvent(e,this.stateKeys)):null}processPostKeystroke(e,n){return this.activeKeyboard?this.keyboardInterface.processPostKeystroke(n,this.activeKeyboard.constructNullKeyEvent(e,this.stateKeys)):null}processKeystroke(e,n){var i;let s=n.getTextBeforeCaret().kmwLength()==0&&n.isSelectionEmpty();if(this.activeKeyboard&&e.Lcode!=0&&(i=this.keyboardInterface.processKeystroke(n,e)),s&&e.Lcode==C.keyCodes.K_BKSP&&i.triggerKeyDefault)i=this.defaultRuleBehavior(e,n,!1),i.triggerKeyDefault=!0,i.transcription.transform.deleteLeft=1;else if(!i||i.triggerKeyDefault){e.Lcode=e.vkCode||e.Lcode,this.keyboardInterface.activeTargetOutput=n;let l=this.defaultRuleBehavior(e,n,!1);l&&(i?i.mergeInDefaults(l):i=l,i.triggerKeyDefault=!1),this.keyboardInterface.activeTargetOutput=null}return i}_UpdateVKShift(e){let n=0,i=["CAPS","NUM_LOCK","SCROLL_LOCK"],s=["K_CAPS","K_NUMLOCK","K_SCROLL"],l=[m.CAPITALFLAG,m.NUMLOCKFLAG,m.SCROLLFLAG];if(!this.activeKeyboard)return!0;if(e){n=e.Lmodifiers,this.activeKeyboard.isChiral&&this.activeKeyboard.emulatesAltGr&&(this.modStateFlags&C.modifierBitmasks.ALT_GR_SIM)==C.modifierBitmasks.ALT_GR_SIM&&(n|=C.modifierBitmasks.ALT_GR_SIM,n&=~m.RALTFLAG);let r=!1;for(let c=0;c<i.length;c++)e.Lstates&C.stateBitmasks[i[c]]&&(this.stateKeys[s[c]]=!!(e.Lstates&l[c]),r=!0);r&&this.emit("statekeychange",this.stateKeys)}return this.updateStates(),this.activeKeyboard.isMnemonic&&this.stateKeys.K_CAPS&&(!e||!e.isModifier)&&(n^=m.K_SHIFTFLAG),this.layerId=this.getLayerId(n),!0}updateStates(){let e=["K_CAPS","K_NUMLOCK","K_SCROLL"],n=[m.CAPITALFLAG,m.NUMLOCKFLAG,m.SCROLLFLAG],i=[m.NOTCAPITALFLAG,m.NOTNUMLOCKFLAG,m.NOTSCROLLFLAG];for(let s=0;s<e.length;s++){let l=e[s];this.stateKeys[l]?(this.modStateFlags|=n[s],this.modStateFlags&=~i[s]):(this.modStateFlags&=~n[s],this.modStateFlags|=i[s])}}getLayerId(e){return E.getLayerId(e)}selectLayer(e){let n=e.kName;var i=e.kNextLayer,s=this.activeKeyboard&&this.activeKeyboard.isChiral;if(typeof i=="number"&&(i=this.getLayerId(i*16)),!i)switch(n){case"K_LSHIFT":case"K_RSHIFT":case"K_SHIFT":i="shift";break;case"K_LCONTROL":case"K_LCTRL":if(s){i="leftctrl";break}case"K_RCONTROL":case"K_RCTRL":if(s){i="rightctrl";break}case"K_CTRL":i="ctrl";break;case"K_LMENU":case"K_LALT":if(s){i="leftalt";break}case"K_RMENU":case"K_RALT":if(s){i="rightalt";break}case"K_ALT":i="alt";break;case"K_ALTGR":s?i="leftctrl-rightalt":i="ctrl-alt";break;case"K_CURRENCIES":case"K_NUMERALS":case"K_SHIFTED":case"K_UPPER":case"K_LOWER":case"K_SYMBOLS":i="default";break}return i?(this.updateLayer(e,i),!0):!1}updateLayer(e,n){let i=this.layerId;var s=i;if(n==i&&e.device.formFactor!=V.FormFactor.Desktop)return;var l=n,r;if(e.device.formFactor==V.FormFactor.Desktop){var c=["leftctrl","rightctrl","ctrl","leftalt","rightalt","alt","shift"];for(r=0;r<c.length;r++)l=l.replace(c[r]+"-",""),l=l.replace(c[r],"");if(i=="default"||i=="numeric"||i=="symbol"||i=="currency"||l!="")s=n;else{var g=C.getModifierState(s);for(r=0;r<c.length;r++)s=s.replace(c[r]+"-",""),s=s.replace(c[r],"");switch(n){case"shift":g^=m.K_SHIFTFLAG;break;case"leftctrl":g^=m.LCTRLFLAG;break;case"rightctrl":g^=m.RCTRLFLAG;break;case"ctrl":g^=m.K_CTRLFLAG;break;case"leftalt":g^=m.LALTFLAG;break;case"rightalt":g^=m.RALTFLAG;break;case"alt":g^=m.K_ALTFLAG;break;default:s=n}s!="default"&&(s==""?s=this.getLayerId(g):s=this.getLayerId(g)+"-"+s)}s==""&&(s="default")}else s=n;this.activeKeyboard.layout(e.device.formFactor).getLayer(s)?this.layerId=s:this.layerId="default";let u=C.getModifierState(this.layerId);this.modStateFlags=u|e.Lstates}doModifierPress(e,n,i){return this.activeKeyboard?e.isModifier?(this.activeKeyboard.notify(e.Lcode,n,i?1:0),e.device.touchable?!0:this._UpdateVKShift(e)):(e.LmodifierChange&&(this.activeKeyboard.notify(0,n,1),e.device.touchable||this._UpdateVKShift(e)),!1):!1}performNewContextEvent(e){let n=this.processNewContextEvent(this.contextDevice,e);return n&&n.finalize(this,e,!0),n}resetContext(e){this.layerId="default",e==null||e.resetContext(),this.keyboardInterface.resetContextCache(),e&&this.performNewContextEvent(e),this.contextDevice.touchable||this._UpdateVKShift(null)}setNumericLayer(e){this.activeKeyboard&&this.activeKeyboard.layout(e.formFactor).getLayer("numeric")&&(this.layerId="numeric")}};o(Zt,"KeyboardProcessor"),Zt.DEFAULT_OPTIONS={baseLayout:"us",defaultOutputRules:new Ae};var jt=Zt;var qi="Keyboard_";function se(a){return a.startsWith(qi)?a:qi+a}o(se,"prefixed");function we(a){return a.startsWith(qi)?a.substring(qi.length):a}o(we,"withoutPrefix");var wl=class wl extends S.default{constructor(e){super();this.stubSetTable={};this.keyboardTable={};this.keyboardLoader=e}getKeyboardForStub(e){return e?this.getKeyboard(e.KI):null}getKeyboard(e){if(!e)return null;let n=this.keyboardTable[se(e)];return n instanceof Promise?null:n}get defaultStub(){function e(i){let s=Object.keys(i);if(s.length!=0)return i[s[0]]}o(e,"getFirstValue");let n=e(this.stubSetTable);if(n)return e(n)}addKeyboard(e){let n=se(e.id);this.keyboardTable[n]=e,this.emit("keyboardadded",e)}fetchKeyboardForStub(e){return this.fetchKeyboard(e.KI)}isFetchingKeyboard(e){if(!e)throw new Error("Keyboard ID must be specified");return e=se(e),this.keyboardTable[e]instanceof Promise}fetchKeyboard(e){if(!e)throw new Error("Keyboard ID must be specified");if(!this.keyboardLoader)throw new Error("Cannot load keyboards; this cache was configured without a loader");e=se(e);let n=this.keyboardTable[e];if(n instanceof Y)return Promise.resolve(n);if(n instanceof Promise)return n;let i=this.getStub(e,null);if(!i)throw new Error(`No stub for ${we(e)} has been registered`);if(!i.filename)throw new Error(`The registered stub for ${we(e)} lacks a path to the main keyboard file`);let s=this.keyboardLoader.loadKeyboardFromStub(i);return this.keyboardTable[e]=s,s.then(l=>{l.scriptObject.KI=e,this.addKeyboard(l)}).catch(l=>{throw delete this.keyboardTable[e],l}),s}addStub(e){var s;let n=se(e.KI),i=this.stubSetTable[n]=(s=this.stubSetTable[n])!=null?s:{};i[e.KLC]=e,this.emit("stubadded",e)}findMatchingStub(e){return this.getStub(e.KI,e.KLC)}getStub(e,n){var r;let i,s=n||"---";e instanceof Y?i=e.id:i=e,i&&(i=se(i));let l=(r=this.stubSetTable[i])!=null?r:{};if(s!="---")return l[s];{let c=Object.keys(l);return c.length==0?null:l[c[0]]}}forgetKeyboard(e,n=!1){let i=e instanceof Y?e.id:se(e);this.stubSetTable[i]&&delete this.stubSetTable[i],n&&this.keyboardTable[i]&&delete this.keyboardTable[i]}getStubList(){let e=[],n=Object.keys(this.stubSetTable);for(let i of n){let s=this.stubSetTable[i],l=Object.keys(s);for(let r of l)e.push(s[r])}return e}};o(wl,"StubAndKeyboardCache");var _t=wl;var Ml=["World","Africa","Asia","Europe","South America","North America","Oceania","Central America","Middle East"],Kl=["un","af","as","eu","sa","na","oc","ca","me"],xa=RegExp("^(([\\.]/)|([\\.][\\.]/)|(/))|(:)");function po(a,t){return t=t||"",a&&!xa.test(a)?t+a:a}o(po,"configureFilePathing");var $i=class $i extends Ye{constructor(e,n,i){var t=(...args)=>{super(...args)};if(typeof e!="string")if(e.id!==void 0){let s=e;s.id=se(s.id),t(s,i),this.KF=po(s.filename,n),this.mapRegion(s.languages)}else{let s=e;s.KI=se(s.KI),t(s,i),this.KF=po(s.KF,n),this.KP=s.KP,this.KR=s.KR,this.KRC=s.KRC;return}else t(se(e),n)}mapRegion(e){let n=e.region,i=0;if(typeof n=="number")n<1||n>9?i=0:i=n-1;else if(typeof n=="string"){let s=n.length==2?Kl:Ml;for(let l=0;l<s.length;l++)if(n.toLowerCase()==s[l].toLowerCase()){i=l;break}}this.KR=Ml[i],this.KRC=Kl[i]}get region(){return this.KR}get regionCode(){return this.KRC}get filename(){return this.KF}static toStubs(e,n,i){let s="";if(typeof e.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),e.languages||(e.languages=e.language),e?e.id?e.languages||(s="KeyboardStub has undefined languages"):s="KeyboardStub has undefined id":s="Stub undefined",s!="")return[{error:new Error(s)}];let l=[];Array.isArray(e.languages)?l=l.concat(e.languages):l.push(e.languages);let r=[];return l.forEach(c=>{let g=A(y({},e),{languages:c,language:void 0}),d=new $i(g,n,i);r.push(d)}),r}merge(e){this.KL||(this.KL=e.KL),this.KR||(this.KR=e.KR),this.KRC||(this.KRC=e.KRC),this.KN||(this.KN=e.KN),this.KF||(this.KF=e.KF),this.KFont||(this.KFont=e.KFont),this.KOskFont||(this.KOskFont=e.KOskFont),e._displayName&&(this._displayName||(this._displayName=e._displayName))}validateForCustomKeyboard(){return super.validateForCustomKeyboard()||!this.KF||!this.KR?new Error("To use a custom keyboard, you must specify file name, keyboard id, keyboard name, language, language code, and region."):null}};o($i,"KeyboardStub");var $=$i;function Mn(a,t){if(t.length==0)return Promise.resolve(a);if(a.length==0)return Promise.reject(t);{let e=a;return Promise.resolve(e.concat(t))}}o(Mn,"mergeAndResolveStubPromises");var Co="The Cloud API request timed out.",zl="Could not find a keyboard with that ID.",Go="The Cloud API failed to find an appropriate keyboard.",Za="Error occurred while registering keyboards: ",Xa=o(function(a){return a+" keyboard not found."},"MISSING_KEYBOARD"),Kn=class Kn extends S.default{constructor(e,n){super();this.cloudResolutionPromises=new Map;this.languageFetchStarted=!1;this.registerFromCloud=o(e=>{let n=Number.parseInt(e.timerid),i;try{i=this._registerCore(e)}catch(s){i=new Error(Za+s)}if(n){let s=this.cloudResolutionPromises.get(n);if(s)try{i instanceof Error?s.reject(i):s.resolve(i)}finally{this.cloudResolutionPromises.delete(n)}else{this.emit("unboundregister",i);return}}else{this.emit("unboundregister",i);return}},"registerFromCloud");this.requestEngine=e,this.pathConfig=n,this._languageListPromise=new f}get languageListPromise(){return this.languageFetchStarted||(this.languageFetchStarted=!0,this.keymanCloudRequest("",!0).catch(e=>{this.languageFetchStarted=!1,this._languageListPromise.reject(e),this._languageListPromise=new f})),this._languageListPromise.corePromise}keymanCloudRequest(e,n){let i="https://api.keyman.com/cloud/4.0/"+(arguments.length>1&&n?"languages":"keyboards"),s="?jsonp=keyman.register&languageidtype=bcp47&version="+M.CURRENT.toString(),l=i+s+e,{promise:r,queryId:c}=this.requestEngine.request(l);return this.cloudResolutionPromises.set(c,r),r.finally(()=>{this.cloudResolutionPromises.delete(c)}),r.corePromise}_registerCore(e){let n=e.options,i=n.fontBaseUri;if(this.pathConfig.fonts!=""?i=this.pathConfig.fonts:this.pathConfig.updateFontPath(i),typeof e.error=="string"){var s="";if(typeof e.options.keyboardid=="string"){let r=e.options.keyboardid;s=r.substring(0,1).toUpperCase()+r.substring(1)}return new Error(Xa(s))}if(typeof n=="undefined"||typeof n.context=="undefined")return new Error(zl);let l=[];if(n.context=="keyboard"){let r,c=e.keyboard;if(Array.isArray(c))for(r=0;r<c.length;r++)l=l.concat(Kn.registerLanguagesForKeyboard(c[r],n,r));else l=l.concat(Kn.registerLanguagesForKeyboard(c,n,0))}else if(n.context=="language"){let r=e.languages;return this._languageListPromise.resolve(r),r}return l}static registerLanguagesForKeyboard(e,n,i){let s="";if(typeof e=="undefined")return[];if(typeof n.keyboardid=="string"&&(s=n.keyboardid.split(",")[i]),Array.isArray(e))if(e.length==1||s.substr(-1,1)=="$"||s==""){let l=[];for(let r=0;r<e.length;r++)l=l.concat(this.registerLanguagesForKeyboard(e[r],n,i));return l}else{let l=0;for(let r=0;r<e.length;r++){let c=e[r].id.toLowerCase();if(c=="us"&&(c="english"),Array.isArray(e[r].languages)){let g=e[r].languages;for(let d=0;d<g.length;d++)if(c==g[d].name.toLowerCase()){l=r;break}}}return this.registerLanguagesForKeyboard(e[l],n,i)}else{let l=n.fontBaseUri||"",r=$.toStubs(e,n.keyboardBaseUri,l),c=s.split("@")[1];if(r.length==1&&typeof r[0].error!="undefined")throw r[0].error;return typeof c!="string"?r:(c=c.replace(/\$$/,""),[r.find(g=>g.KLC==c)])}}fetchCloudStubs(e){return W(this,null,function*(){if(e.length==0)return Promise.resolve([]);let n="&keyboardid=",i="";for(let l=0;l<e.length;l++)n=n+i+e[l].toString(),i=",";let s=[];try{let l=yield this.keymanCloudRequest(n,!1);return Mn(l,s)}catch(l){console.error(l);let r={error:l};return s.push(r),Promise.reject(s)}})}};o(Kn,"CloudQueryEngine");var qt=Kn;var Pl=class Pl{constructor(t,e){this.id=t,this.language=e}toString(){let t=this.id;return this.language?(t=t+"@"+this.language,this.version&&(t=t+"@"+this.version)):this.version&&(t=t+"@@"+this.version),t}};o(Pl,"CloudRequestEntry");var Ol=Pl;function Dl(a,t){return{keyboard:{id:a.id,name:a.name},error:typeof t=="string"?new Error(t):t}}o(Dl,"convertToErrorStub");function Qo(a,t,e){let n=new Ol(a,t);return e&&(n.version=e),n}o(Qo,"toQuerySpecs");function Uo(a,t,e){if(a.getStub(e.id,e.language)==null){for(let n=0;n<t.length;n++)if(t[n].id==e.id&&t[n].language==e.language)return!1;return!0}else return!1}o(Uo,"isUniqueRequest");var jl=class jl{constructor(t,e,n){this.pathConfig=n,this.cache=new _t(t),this.cloudQueryEngine=new qt(e,this.pathConfig),this.cloudQueryEngine.on("unboundregister",i=>{Array.isArray(i)&&i.forEach(s=>{s instanceof $&&this.cache.addStub(s)})})}addKeyboardArray(t){let e=[],n=[],i=[],s=[],l=[];for(let g of t)if(typeof g=="string")g.length>0&&s.push(g);else if(g.KI||g.KL||g.KLC||g.KFont||g.KOskFont)i.push(new $(g));else{let d=g;if(typeof d.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),d.languages||(d.languages=d.language),typeof d.languages=="undefined"){let u="To use keyboard '"+d.id+"', you must specify languages.";l.push(Dl(d,u))}else if(Array.isArray(d.languages)){let u=$.toStubs(d,this.pathConfig.keyboards,this.pathConfig.fonts);for(let I of u)I instanceof $?i.push(I):l.push(I)}else{let u=d;i.push(new $(u,this.pathConfig.keyboards,this.pathConfig.fonts))}}for(let g of i)if(g.KF){let d=g.validateForCustomKeyboard();d?l.push(Dl(g,d)):e.push(g)}else n.push(g);let r=[];for(let g of n){if(!g.KI&&!g.KLC){l.push(Dl(g,"Cannot fetch keyboard information without a keyboard ID or language code."));continue}let d=Qo(we(g.id),g.langId);Uo(this.cache,r,d)&&r.push(d)}for(let g of s){let d=g.split("@"),u=[""];d[0].toLowerCase()=="english"&&(d[0]="us"),d.length>1&&(u=d[1].split(","));for(let I=0;I<u.length;I++){if(I>0&&u[I]=="")continue;let B=Qo(d[0],u[I],d[2]);Uo(this.cache,r,B)&&r.push(B)}}return e.forEach(g=>this.cache.addStub(g)),this.cloudQueryEngine.fetchCloudStubs(r.map(g=>g.toString())).then(g=>{for(let d of g)d instanceof $?(this.cache.addStub(d),e.push(d)):l.push(d);return[].concat(l).concat(e)})}addLanguageKeyboards(t){return W(this,null,function*(){let e=[],n=[];try{n=yield this.cloudQueryEngine.languageListPromise}catch(l){return console.error(l),e.push({error:l}),e}let i=n,s="";for(let l=0;l<t.length;l++){let r=t[l].toLowerCase(),c=r.substr(-1,1)=="$";c&&(r=r.substr(0,r.length-1));let g=!1;for(let d=0;d<i.length;d++)if(r==i[d].name.toLowerCase()){s!=""&&(s=s+","),s=s+"@"+i[d].id,c&&(s=s+"$"),g=!0;break}if(!g){let d={language:{name:r},error:new Error(this.alertLanguageUnavailable(r))};e.push(d)}}return s==""?Promise.reject(e):this.cloudQueryEngine.keymanCloudRequest("&keyboardid="+s,!1).then(l=>W(this,null,function*(){let r=yield Mn(l,e);for(let c of r)typeof c.error=="undefined"&&this.cache.addStub(c);return r}),l=>{console.error(l);let r={error:l};return e.push(r),Promise.reject(e)})})}fetchCloudCatalog(){return W(this,null,function*(){try{let t=yield this.cloudQueryEngine.keymanCloudRequest("",!1);return t.forEach(e=>this.cache.addStub(e)),t}catch(t){return Promise.reject([{error:t}])}})}alertLanguageUnavailable(t){return"No keyboards are available for "+t+". Does it have another language name?"}};o(jl,"KeyboardRequisitioner");var $t=jl;var _l=class _l{constructor(){this.registeredModels={};this.languageModelMap={}}modelForLanguage(t){return this.languageModelMap[t]}register(t){if(t.id=t.id.toLowerCase(),JSON.stringify(t)==JSON.stringify(this.registeredModels[t.id]))return;this.registeredModels[t.id]=t;let e=this;t.languages.forEach(function(n){if(!n){console.warn("Null / undefined language codes are not permitted for registration.");return}e.languageModelMap[n]=t})}unregister(t){let e;if(t=t.toLowerCase(),this.registeredModels[t])e=this.registeredModels[t],delete this.registeredModels[t];else return null;let n=this;return e.languages.forEach(function(i){n.languageModelMap[i].id==t&&delete n.languageModelMap[i]}),e}isRegistered(t){return!!this.registeredModels[t.id.toLowerCase()]}};o(_l,"ModelManager");var en=_l;function es(a){let t=[];for(let e=0;e<a.length;e++)t.push(a[e]);return t}o(es,"arrayFromNodeList");function H(a){let t=document.createElement(a);return t.style.userSelect="none",t.style.webkitUserSelect="none",t}o(H,"createUnselectableElement");var ql=class ql{constructor(t,e){this.fontStyleDefinitions={};this.linkedSheets=[];this.fontPromises=[];if(!t){let n=document.getElementsByTagName("HEAD");n.length>0?t=n[0]:t=document.body}this.linkNode=t,this.doCacheBusting=e||!1}get sheets(){return this.linkedSheets.map(t=>t.sheet)}linkStylesheet(t){if(!(t instanceof HTMLLinkElement)&&!t.innerHTML)return;let e=new f;t instanceof HTMLLinkElement?t.onload=()=>e.resolve():e.resolve(),this.linkedSheets.push({sheet:t,load:e}),this.linkNode.appendChild(t)}allLoadedPromise(){return W(this,null,function*(){let t=this.linkedSheets.map(e=>e.load.corePromise);Promise.allSettled?yield Promise.allSettled(t):yield Promise.all(t)})}addStyleSheetForFont(t,e,n){if(!t||typeof t.files=="undefined")return null;let i=t.family,s,l,r="",c="",g=[],d="";n||(n=V.OperatingSystem.Other);let u=this.fontStyleDefinitions[n]=this.fontStyleDefinitions[n]||{};if(u[i]){let G=u[i];return G.parentNode||this.linkStylesheet(G),null}for(typeof t.files=="string"?g[0]=t.files:g=t.files,l=0;l<g.length;l++)g[l].toLowerCase().indexOf("data:font")==0&&(d=g[l]),g[l].toLowerCase().indexOf(".otf")>0&&(r=g[l]),g[l].toLowerCase().indexOf(".ttf")>0&&(r=g[l]),g[l].toLowerCase().indexOf(".woff")>0&&(c=g[l]);r!=""&&r.indexOf("/")<0&&(r=e+r),c!=""&&c.indexOf("/")<0&&(c=e+c);var I=`@font-face {
font-family:`+t.family+`;
font-style:normal;
font-weight:normal;
`;if(d){let U=d.substring(10,d.indexOf(";",10));I+=`src:url('${d}'), format('${U}');`}else n==V.OperatingSystem.iOS?r!=""&&(this.doCacheBusting&&(r=this.cacheBust(r)),s="url('"+encodeURI(r)+"') format('truetype')"):(c!=""&&(s="url('"+encodeURI(c)+"') format('woff')"),r!=""&&(s="url('"+encodeURI(r)+"') format('truetype')"));if(!s)return null;I+="src:"+s+";",I=I+`
}
`;let B=st(I);u[i]=B;let b=new FontFace(t.family,s).load(),F=o(()=>{this.fontPromises=this.fontPromises.filter(G=>G!=b)},"clearPromise");return this.fontPromises.push(b.then(F).catch(F)),this.linkStylesheet(B),B}cacheBust(t){return t+"?v="+new Date().getTime()}linkExternalSheet(t,e){try{if(!e&&document.querySelector("link[href="+JSON.stringify(t)+"]")!=null)return null}catch(i){return null}let n=document.createElement("link");return n.type="text/css",n.rel="stylesheet",n.href=t,this.linkStylesheet(n),n}unlink(t){let e=this.linkedSheets.findIndex(n=>n.sheet==t);return e>-1?(this.linkedSheets.splice(e,1)[0].load.resolve(),t.parentNode.removeChild(t),!0):!1}unlinkAll(){for(let t of this.linkedSheets){let e=t.sheet;e.parentNode&&e.parentNode.removeChild(e),t.load.resolve()}this.linkedSheets.splice(0,this.linkedSheets.length)}};o(ql,"StylesheetManager");var ge=ql;function st(a){var t=document.createElement("style");return t.type="text/css",t.appendChild(document.createTextNode(a)),t}o(st,"createStyleSheet");function be(){var a;return typeof window.orientation!="undefined"?a=window.orientation:typeof window.screen.orientation!="undefined"&&(a=window.screen.orientation.angle),a!==void 0?Math.abs(a/90)==1:!1}o(be,"landscapeView");var $l=class $l{constructor(t){this.name=t}load(t){return this.loadCookie(this.name,t||(e=>e))}save(t,e){this.saveCookie(this.name,t,e||(n=>n))}_loadRawCookies(){let t={};if(typeof document.cookie!="undefined"&&document.cookie!=""){let e=document.cookie.split(/;\s*/);for(let n=0;n<e.length;n++){let i=e[n].split("=");i.length==2&&(t[i[0]]=i[1])}}return t}loadCookie(t,e){let n={},s=this._loadRawCookies()[t];if(s){let l=decodeURIComponent(s).split(";");for(let r=0;r<l.length&&!(r==l.length-1&&!l[r]);r++){let c=l[r].split("=");if(c.length>1){let[g,d]=c;n[g]=e(d,g)}else n[c[0]]=""}}return n}saveCookie(t,e,n){let i="";for(let r in e)i+=r+"="+n(e[r],r)+";";let l=" path=/; expires="+new Date(new Date().valueOf()+1e3*60*60*24*30).toUTCString();document.cookie=`${t}=${encodeURIComponent(i)}; ${l}`}};o($l,"CookieSerializer");var le=$l;function K(a){var t;if(!a)return 0;var e=a.offsetLeft?a.offsetLeft:0;if(t=a,t.offsetParent){for(;t.offsetParent;)t=t.offsetParent,e+=t.offsetLeft;let i=t.ownerDocument;t.style.position=="fixed"&&i&&i.scrollingElement&&(e+=i.scrollingElement.scrollLeft)}if(t&&t.ownerDocument&&a.ownerDocument!=window.document){var n=t.ownerDocument;if(n&&n.defaultView&&n.defaultView.frameElement)return e+K(n.defaultView.frameElement)-n.documentElement.scrollLeft}return e}o(K,"getAbsoluteX");function z(a){var t;if(!a)return 0;var e=a.offsetTop?a.offsetTop:0;if(t=a,t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement){for(;t.offsetParent;)t=t.offsetParent,e+=t.offsetTop;let i=t.ownerDocument;t.style.position=="fixed"&&i&&i.scrollingElement&&(e+=i.scrollingElement.scrollTop)}if(t&&t.ownerDocument&&a.ownerDocument!=window.document){var n=t.ownerDocument;if(n&&n.defaultView&&n.defaultView.frameElement)return e+z(n.defaultView.frameElement)}return e}o(z,"getAbsoluteY");var er=class er extends le{constructor(t,e){super(`KeymanWeb_${t}_Option_${e}`)}load(){return super.load(decodeURIComponent)}save(t){super.save(t,encodeURIComponent)}};o(er,"VarStoreSerializer");var ts=er,tr=class tr{loadStore(t,e){return new ts(t,e).load()}saveStore(t,e,n){new ts(t,e).save(n)}};o(tr,"VariableStoreCookieSerializer");var zn=tr;var nr=class nr extends Te{constructor(e,n,i){super(e,n,new zn);this.insertText=o((e,n)=>{this.resetContextCache(),this.engine.contextManager.insertText(this,e,n)},"insertText");this.KT=this.insertText;this.engine=n,this.stubNamespacer=i}preserveID(e){var n;if(document.currentScript)n=document.currentScript.id;else{var i=document.getElementsByTagName("script"),s=i[i.length-1];n=s.id}if(n)n.indexOf(we(e.KI))!=-1?e.KI=n:console.error("Error when registering keyboard:  current SCRIPT tag's ID does not match!");else return}registerKeyboard(e){super.registerKeyboard(e);let n=this.loadedKeyboard;this.preserveID(e),this.engine.config.deferForInitialization.then(()=>{this.engine.keyboardRequisitioner.cache.isFetchingKeyboard(n.id)||(this.engine.keyboardRequisitioner.cache.addKeyboard(n),this.loadedKeyboard=null)})}registerStub(e){var i;this.stubNamespacer&&this.stubNamespacer(e);let n=o(()=>{let s=this.engine.config.paths;return new $(e,s.keyboards,s.fonts)},"buildStub");if(!this.engine.config.deferForInitialization.isResolved)this.engine.config.deferForInitialization.then(()=>this.engine.keyboardRequisitioner.cache.addStub(n()));else{let s=n();if((i=this.engine.keyboardRequisitioner)!=null&&i.cache.findMatchingStub(s))return 1;this.engine.keyboardRequisitioner.cache.addStub(s)}return null}};o(nr,"KeyboardInterface");var Xt=nr;(function(){Xt.__publishShorthandAPI()})();var ir=class ir extends Kt{constructor(e,n){var t=(...args)=>{super(...args)};e&&e._jsGlobal!=window&&(e._jsGlobal.String=window.String),t(e||new yt(window,Rn)),this.performCacheBusting=n||!1}loadKeyboardInternal(e,n,i){let s=new f;this.performCacheBusting&&(e=this.cacheBust(e));try{let l=this.harness._jsGlobal.document,r=l.createElement("script");i&&(r.id=i),l.head.appendChild(r),r.onerror=c=>{s.reject(n.missingError(c))},r.onload=()=>{if(this.harness.loadedKeyboard){let c=this.harness.loadedKeyboard;this.harness.loadedKeyboard=null,s.resolve(c)}else s.reject(n.scriptError())},s.then(()=>{r.remove()}).catch(()=>{r.remove()}),r.src=e}catch(l){return Promise.reject(l)}return s.corePromise}cacheBust(e){return e+"?v="+new Date().getTime()}};o(ir,"DOMKeyboardLoader");var ns=ir;var is=class is{constructor(t,e,n){this.left=t.getTextBeforeCaret(),this.startOfBuffer=this.left._kmwLength()<=e.leftContextCodePoints,this.startOfBuffer||(this.left=this.left._kmwSubstr(-e.leftContextCodePoints)),this.right=t.getTextAfterCaret(),this.endOfBuffer=this.right._kmwLength()<=e.rightContextCodePoints,this.endOfBuffer||(this.right=this.right._kmwSubstr(0,e.rightContextCodePoints)),this.casingForm=n=="shift"?"initial":n=="caps"?"upper":null}toMock(){let t=this.left._kmwLength();return new k(this.left+(this.right||""),t)}};o(is,"ContextWindow"),is.ENGINE_RULE_WINDOW={leftContextCodePoints:64,rightContextCodePoints:32};var Ue=is;var sr=class sr{constructor(){this._promises=new Map}get length(){return this._promises.size}make(t,e,n){if(this._promises.has(t))return n(`Existing request with token ${t}`);this._promises.set(t,{reject:n,resolve:e})}keep(t,e){let n=this._promises.get(t);if(!n)throw new Error(`No promise associated with token: ${t}`);let i=n.resolve;return this._promises.delete(t),i(e)}break(t,e){let n=this._promises.get(t);if(!n)throw new Error(`No promise associated with token: ${t}`);this._promises.delete(t),n.reject(e)}};o(sr,"PromiseStore");var lt=sr;var lr=class lr{constructor(t,e,n){this._worker=e,this._worker.onmessage=this.onMessage.bind(this),this._declareLMLayerReady=null,this._predictPromises=new lt,this._wordbreakPromises=new lt,this._acceptPromises=new lt,this._revertPromises=new lt,this._nextToken=Number.MIN_SAFE_INTEGER,this.sendConfig(t,!!n)}sendConfig(t,e){this._worker.postMessage({message:"config",capabilities:t,testMode:e})}loadModel(t,e="file"){return new Promise((n,i)=>{this._declareLMLayerReady=n;let s={type:e};e=="file"?s.file=t:s.code=t,this._worker.postMessage({message:"load",source:s})})}unloadModel(){this._worker.postMessage({message:"unload"})}predict(t,e){let n=this._nextToken++;return new Promise((i,s)=>{this._predictPromises.make(n,i,s),this._worker.postMessage({message:"predict",token:n,transform:t,context:e})})}wordbreak(t){let e=this._nextToken++;return new Promise((n,i)=>{this._wordbreakPromises.make(e,n,i),this._worker.postMessage({message:"wordbreak",token:e,context:t})})}acceptSuggestion(t,e,n){let i=this._nextToken++;return new Promise((s,l)=>{this._acceptPromises.make(i,s,l),this._worker.postMessage({message:"accept",token:i,suggestion:t,context:e,postTransform:n})})}revertSuggestion(t,e){let n=this._nextToken++;return new Promise((i,s)=>{this._revertPromises.make(n,i,s),this._worker.postMessage({message:"revert",token:n,reversion:t,context:e})})}resetContext(t){this._worker.postMessage({message:"reset-context",context:t})}onMessage(t){let e=t.data;if(e.message==="error")console.error(e.log),e.error&&console.error(e.error);else if(e.message==="ready")this._declareLMLayerReady(t.data.configuration);else if(e.message==="suggestions")this._predictPromises.keep(e.token,e.suggestions);else if(e.message==="currentword")this._wordbreakPromises.keep(e.token,e.word);else if(e.message==="postaccept")this._acceptPromises.keep(e.token,e.reversion);else if(e.message==="postrevert")this._revertPromises.keep(e.token,e.suggestions);else throw new Error(`Message not implemented: ${e.message}`)}shutdown(){this._worker.terminate()}};o(lr,"LMLayer");var tn=lr;function ss(a){return a}o(ss,"unwrap");var xo=`"use strict";(()=>{var Oe=Object.defineProperty,Kt=Object.defineProperties;var Qt=Object.getOwnPropertyDescriptors;var ft=Object.getOwnPropertySymbols;var Ht=Object.prototype.hasOwnProperty,Vt=Object.prototype.propertyIsEnumerable;var gt=(o,e)=>{if(e=Symbol[o])return e;throw Error("Symbol."+o+" is not defined")};var Tt=(o,e,t)=>e in o?Oe(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,A=(o,e)=>{for(var t in e||(e={}))Ht.call(e,t)&&Tt(o,t,e[t]);if(ft)for(var t of ft(e))Vt.call(e,t)&&Tt(o,t,e[t]);return o},Re=(o,e)=>Kt(o,Qt(e)),h=(o,e)=>Oe(o,"name",{value:e,configurable:!0});var _e=(o,e)=>{for(var t in e)Oe(o,t,{get:e[t],enumerable:!0})};var D=(o,e,t)=>new Promise((r,n)=>{var i=a=>{try{l(t.next(a))}catch(u){n(u)}},s=a=>{try{l(t.throw(a))}catch(u){n(u)}},l=a=>a.done?r(a.value):Promise.resolve(a.value).then(i,s);l((t=t.apply(o,e)).next())}),be=function(o,e){this[0]=o,this[1]=e},Ct=(o,e,t)=>{var r=(s,l,a,u)=>{try{var c=t[s](l),p=(l=c.value)instanceof be,f=c.done;Promise.resolve(p?l[0]:l).then(d=>p?r(s==="return"?s:"next",l[1]?{done:d.done,value:d.value}:d,a,u):a({value:d,done:f})).catch(d=>r("throw",d,a,u))}catch(d){u(d)}},n=s=>i[s]=l=>new Promise((a,u)=>r(s,l,a,u)),i={};return t=t.apply(o,e),i[Symbol.asyncIterator]=()=>i,n("next"),n("throw"),n("return"),i};var St=(o,e,t)=>(e=o[gt("asyncIterator")])?e.call(o):(o=o[gt("iterator")](),e={},t=(r,n)=>(n=o[r])&&(e[r]=i=>new Promise((s,l,a)=>(i=n.call(o,i),a=i.done,Promise.resolve(i.value).then(u=>s({value:u,done:a}),l)))),t("next"),t("return"),e);function O(){String.kmwFromCharCode=function(o){var e=[],t;for(t=0;t<arguments.length;t++){var r=Number(arguments[t]);if(!isFinite(r)||r<0||r>1114111||Math.floor(r)!==r)throw new RangeError("Invalid code point "+r);r<65536?e.push(r):(r-=65536,e.push((r>>10)+55296),e.push(r%1024+56320))}return String.fromCharCode.apply(void 0,e)},String.prototype.kmwCharCodeAt=function(o){var e=String(this),t=0;if(o<0||o>=e.length)return NaN;for(var r=0;r<o;r++)if(t=e.kmwNextChar(t),t===null)return NaN;var n=e.charCodeAt(t);if(n>=55296&&n<=56319&&e.length>t+1){var i=e.charCodeAt(t+1);if(i>=56320&&i<=57343)return(n-55296<<10)+(i-56320)+65536}return n},String.prototype.kmwIndexOf=function(o,e){var t=String(this),r=t.indexOf(o,e);if(r<0)return r;for(var n=0,i=0;i!==null&&i<r;i=t.kmwNextChar(i))n++;return n},String.prototype.kmwLastIndexOf=function(o,e){var t=String(this),r=t.lastIndexOf(o,e);if(r<0)return r;for(var n=0,i=0;i!==null&&i<r;i=t.kmwNextChar(i))n++;return n},String.prototype.kmwLength=function(){var o=String(this);if(o.length==0)return 0;for(var e=0,t=0;t!==null;e++)t=o.kmwNextChar(t);return e},String.prototype.kmwSlice=function(o,e){var t=String(this),r=t.kmwCodePointToCodeUnit(o),n=t.kmwCodePointToCodeUnit(e);return r===null||n===null?"":t.slice(r,n)},String.prototype.kmwSubstr=function(o,e){var t=String(this);o<0&&(o=t.kmwLength()+o),o<0&&(o=0);var r=t.kmwCodePointToCodeUnit(o),n=r;if(r===null)return"";if(arguments.length<2)n=t.length;else for(var i=0;i<e;i++)n=t.kmwNextChar(n);return n===null?t.substring(r):t.substring(r,n)},String.prototype.kmwSubstring=function(o,e){var t=String(this),r,n;if(typeof e=="undefined")r=t.kmwCodePointToCodeUnit(o),n=t.length;else{if(o>e){var i=o;o=e,e=i}r=t.kmwCodePointToCodeUnit(o),n=t.kmwCodePointToCodeUnit(e)}return(isNaN(r)||r===null)&&(r=0),(isNaN(n)||n===null)&&(n=t.length),t.substring(r,n)},String.prototype.kmwNextChar=function(o){var e=String(this);if(o===null||o<0||o>=e.length-1)return null;var t=e.charCodeAt(o);if(t>=55296&&t<=56319&&e.length>o+1){var r=e.charCodeAt(o+1);if(r>=56320&&r<=57343)return o==e.length-2?null:o+2}return o+1},String.prototype.kmwPrevChar=function(o){var e=String(this);if(o==null||o<=0||o>e.length)return null;var t=e.charCodeAt(o-1);if(t>=56320&&t<=57343&&o>1){var r=e.charCodeAt(o-2);if(r>=55296&&r<=56319)return o-2}return o-1},String.prototype.kmwCodePointToCodeUnit=function(o){if(o===null)return null;var e=String(this),t=0;if(o<0){t=e.length;for(var r=0;r>o;r--)t=e.kmwPrevChar(t);return t}if(o==e.kmwLength())return e.length;for(var r=0;r<o;r++)t=e.kmwNextChar(t);return t},String.prototype.kmwCodeUnitToCodePoint=function(o){var e=String(this);return o===null?null:o==0?0:o<0?e.substr(o).kmwLength():e.substr(0,o).kmwLength()},String.prototype.kmwCharAt=function(o){var e=String(this);return o>=0?e.kmwSubstr(o,1):""},String.prototype.kmwBMPNextChar=function(o){var e=String(this);return o<0||o>=e.length-1?null:o+1},String.prototype.kmwBMPPrevChar=function(o){var e=String(this);return o<=0||o>e.length?null:o-1},String.prototype.kmwBMPCodePointToCodeUnit=function(o){return o},String.prototype.kmwBMPCodeUnitToCodePoint=function(o){return o},String.prototype.kmwBMPLength=function(){var o=String(this);return o.length},String.prototype.kmwBMPSubstr=function(o,e){var t=String(this);return o>-1?t.substr(o,e):t.substr(t.length+o,-o)},String.kmwEnableSupplementaryPlane=function(o){var e=String.prototype;String._kmwFromCharCode=o?String.kmwFromCharCode:String.fromCharCode,e._kmwCharAt=o?e.kmwCharAt:e.charAt,e._kmwCharCodeAt=o?e.kmwCharCodeAt:e.charCodeAt,e._kmwIndexOf=o?e.kmwIndexOf:e.indexOf,e._kmwLastIndexOf=o?e.kmwLastIndexOf:e.lastIndexOf,e._kmwSlice=o?e.kmwSlice:e.slice,e._kmwSubstring=o?e.kmwSubstring:e.substring,e._kmwSubstr=o?e.kmwSubstr:e.kmwBMPSubstr,e._kmwLength=o?e.kmwLength:e.kmwBMPLength,e._kmwNextChar=o?e.kmwNextChar:e.kmwBMPNextChar,e._kmwPrevChar=o?e.kmwPrevChar:e.kmwBMPPrevChar,e._kmwCodePointToCodeUnit=o?e.kmwCodePointToCodeUnit:e.kmwBMPCodePointToCodeUnit,e._kmwCodeUnitToCodePoint=o?e.kmwCodeUnitToCodePoint:e.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}h(O,"extendString");O();var De=class De{constructor(e){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((t,r)=>{this._resolve=n=>{this._isFulfilled=!0,t(n)},this._reject=n=>{this._isRejected=!0,r(n)},e&&e(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}finally(e){return this._promise.finally(e)}get corePromise(){return this._promise}};h(De,"ManagedPromise");var ne=De;var Fe=class Fe extends ne{constructor(t){let r=null;super(s=>{r=setTimeout(()=>{this.isResolved||s(!0)},t)});this.timerHandle=r;let n=this._resolve;this._resolve=s=>{clearTimeout(this.timerHandle),n(s)};let i=this._reject;this._reject=s=>{clearTimeout(this.timerHandle),i(s)}}};h(Fe,"TimeoutPromise");var ie=Fe,Ue=h(o=>new ie(o).corePromise,"timedPromise");var I=class I{constructor(e,t){if(typeof e!="function"){this.comparator=e.comparator,this.heap=[].concat(e.heap);return}let r=e;this.comparator=r,this.heap=(t!=null?t:[]).slice(0),this.heapify()}static leftChildIndex(e){return e*2+1}static rightChildIndex(e){return e*2+2}static parentIndex(e){return Math.floor((e-1)/2)}heapify(e,t){if(e==null||t==null){this.heapify(0,this.count-1);return}let r=[],n=-1;for(let i=t;i>=e;i--){let s=I.parentIndex(i);this.siftDown(i)&&s<e&&n!=s&&(r.push(s),n=s)}for(n=-1;r.length>0;){let i=r.shift(),s=I.parentIndex(i);this.siftDown(i)&&s>=0&&n!=s&&(r.push(s),n=s)}}get count(){return this.heap.length}peek(){return this.heap[0]}enqueue(e){let t=this.heap.length;this.heap.push(e);let r=I.parentIndex,n=r(t);for(;t!==0&&this.comparator(this.heap[t],this.heap[n])<0;){let i=this.heap[t];this.heap[t]=this.heap[n],this.heap[n]=i,t=n,n=r(t)}}enqueueAll(e){if(e.length==0)return;let t=this.count;this.heap=this.heap.concat(e);let r=I.parentIndex(t);this.heapify(r>=0?r:0,I.parentIndex(this.count-1))}dequeue(){if(this.count==0)return;let e=this.heap[0],t=this.heap.pop();return this.heap.length>0&&(this.heap[0]=t,this.siftDown(0)),e}siftDown(e){let t=I.leftChildIndex(e),r=I.rightChildIndex(e),n=e;if(t<this.heap.length&&this.comparator(this.heap[t],this.heap[n])<0&&(n=t),r<this.heap.length&&this.comparator(this.heap[r],this.heap[n])<0&&(n=r),n!=e){let i=this.heap[e];return this.heap[e]=this.heap[n],this.heap[n]=i,this.siftDown(n),!0}else return!1}toArray(){return this.heap.slice(0)}};h(I,"PriorityQueue");var k=I;var ve={};_e(ve,{DummyModel:()=>Et,QuoteBehavior:()=>j,SENTINEL_CODE_UNIT:()=>N,TrieModel:()=>ue,applyTransform:()=>g,buildMergedTransform:()=>U,defaultApplyCasing:()=>we,getLastPreCaretToken:()=>ae,isHighSurrogate:()=>F,isLowSurrogate:()=>We,isSentinel:()=>ke,tokenize:()=>se,transformToSuggestion:()=>W,wordbreak:()=>X});O();var N="๏ท";function g(o,e){var c,p;let t=e.left||"",r=t.kmwLength(),n=r<o.deleteLeft?r:o.deleteLeft,i=t.kmwSubstr(0,r-n)+(o.insert||""),s=e.right||"",l=s.kmwLength(),a=l<((c=o.deleteRight)!=null?c:0)?l:(p=o.deleteRight)!=null?p:0,u=s.kmwSubstr(a);return{left:i,right:u,startOfBuffer:e.startOfBuffer,endOfBuffer:e.endOfBuffer,casingForm:e.casingForm}}h(g,"applyTransform");function U(o,e){let t=o.insert,r=e.deleteLeft;if(e.deleteLeft){let n=o.insert.kmwLength();n<=e.deleteLeft?(t="",r=e.deleteLeft-n):(t=o.insert.kmwSubstr(0,n-e.deleteLeft),r=0)}return{insert:t+e.insert,deleteLeft:o.deleteLeft+r,deleteRight:(o.deleteRight||0)+(e.deleteRight||0)}}h(U,"buildMergedTransform");function F(o){return typeof o=="string"&&(o=o.charCodeAt(0)),o>=55296&&o<=56319}h(F,"isHighSurrogate");function We(o){return typeof o=="string"&&(o=o.charCodeAt(0)),o>=56320&&o<=57343}h(We,"isLowSurrogate");function ke(o){return o==N}h(ke,"isSentinel");function W(o,e){let t={transform:o,displayAs:o.insert};return o.id!==void 0&&(t.transformId=o.id),(e===0||e)&&(t.p=e),t}h(W,"transformToSuggestion");function we(o,e){switch(o){case"lower":return e.toLowerCase();case"upper":return e.toUpperCase();case"initial":let t=1;return e.length>1&&F(e.charAt(0))&&We(e.charCodeAt(1))&&(t=2),e.substring(0,t).toUpperCase().concat(e.substring(t))}}h(we,"defaultApplyCasing");var oe=(r=>(r.noQuotes="no-quotes",r.useQuotes="use-quotes",r.default="default-quotes",r))(oe||{});(e=>{function o(t,r,n,i){if(i=="default-quotes"||!i)throw"Specified quote behavior may be ambiguous - default behavior not specified (may not be .default)";switch(t=="default-quotes"&&(t=i),t){case"no-quotes":return r;case"use-quotes":let{open:s,close:l}=n.quotesForKeepSuggestion;return s+r+l;default:throw"Unsupported quote behavior state detected; implementation missing!"}}e.apply=o,h(o,"apply")})(oe||(oe={}));var j=oe;function se(o,e,t){let r=(t==null?void 0:t.rejoins)||["'"];e=e||{left:void 0,startOfBuffer:void 0,endOfBuffer:void 0};let n=o(e.left||"")||[],i=o(e.right||"")||[],s={left:[],right:[],caretSplitsToken:!1},l=0;for(;n.length>0;){let c=n[0];if(Math.max(c.start,l)!=l){let p=Math.max(l,c.start);s.left.push({text:e.left.substring(l,p),isWhitespace:!0}),l=p}else n.shift(),s.left.push({text:c.text}),l=Math.max(l,c.end)}if(e.left!=null&&l!=e.left.length){let c=Math.max(l,e.left.length);s.left.push({text:e.left.substring(l,c),isWhitespace:!0}),l=c}let a=s.left.length;if(a>1){let c=s.left[a-2],p=s.left[a-1];!c.isWhitespace&&!p.isWhitespace&&r.indexOf(p.text)!=-1&&(s.left.pop(),s.left.pop(),s.left.push({text:c.text+p.text}),a--)}l=0;let u=!0;for(;i.length>0;){let c=i[0];if(Math.max(c.start,l)!=l){let p=Math.max(l,c.start);s.right.push({text:e.right.substring(l,p),isWhitespace:!0}),l=p}else{let p=s.left[a-1];p&&u&&!p.isWhitespace&&o(p.text+c.text).length==1&&(s.caretSplitsToken=!0),i.shift(),s.right.push({text:c.text}),l=Math.max(l,c.end)}u=!1}if(e.right&&l!=e.right.length){let c=Math.max(l,e.right.length);s.right.push({text:e.right.substring(l,c),isWhitespace:!0}),l=c}return s}h(se,"tokenize");function ae(o,e){let t=se(o,e);if(t.left.length>0){let r=t.left.pop();return r.isWhitespace?"":r.text}return""}h(ae,"getLastPreCaretToken");function X(o,e){return ae(o,e)}h(X,"wordbreak");var le={};_e(le,{ascii:()=>Ke,default:()=>R,defaultWordbreaker:()=>R,placeholder:()=>qe});function qe(o){let e=0;return o.split(/\\s+/).map(t=>{let r={start:e,end:e+t.length,text:t,length:t.length};return e=r.end,r})}h(qe,"placeholder");function Ke(o){let e=/[A-Za-z0-9']+/g,t=[],r;for(;(r=e.exec(o))!==null;)t.push(new Be(r[0],r.index));return t}h(Ke,"ascii");var Qe=class Qe{constructor(e,t){this.text=e,this.start=t}get length(){return this.text.length}get end(){return this.start+this.text.length}};h(Qe,"RegExpDerivedSpan");var Be=Qe;var xt=["Other","LF","Newline","CR","WSegSpace","Double_Quote","Single_Quote","MidNum","MidNumLet","Numeric","MidLetter","ALetter","ExtendNumLet","Format","Extend","Hebrew_Letter","ZWJ","Katakana","Regional_Indicator","sot","eot"],bt=\`\\0 
!\\v"
#  $! "%# '&( ,'- .(/ 0):*;'< A+[ _,\\\` a+{ ย"ย ยช+ยซ ยญ-ยฎ ยต+ยถ ยท*ยธ ยบ+ยป ร+ร ร+รท รธ+ห ห+ฬ.อฐ+อต อถ+อธ อบ+อพ'อฟ+ฮ ฮ+ฮ*ฮ+ฮ ฮ+ฮ ฮ+ฮข ฮฃ+ฯถ ฯท+า า.า+ิฐ ิฑ+ี ี+ี ี+ี*ี+ึ'ึ+ึ ึ.ึพ ึฟ.ื ื.ื ื.ื ื.ื ื/ืซ ืฏ/ืณ+ืด*ืต ุ)ุ ุ'ุ ุ.ุ ุ-ุ ุ+ู.ู)ูช ูซ)ูฌ'ูญ ูฎ+ูฐ.ูฑ+ +.) .ฅ+ง.ฉ ช.ฎ+ฐ)บ+ฝ ฟ+ +.+ฐ. +ฆ.ฑ+ฒ ฿)฿+฿ซ.฿ด+฿ถ ฿ธ'฿น ฿บ+฿ป ฿ฝ.฿พ เ+เ.เ+เ.เค+เฅ.เจ+เฉ.เฎ เก+เก.เก เก+เกซ เกฐ+เข เข+เข เข)เข เข.เข+เฃ.เฃข)เฃฃ.เค+เคบ.เคฝ+เคพ.เฅ+เฅ.เฅ+เฅข.เฅค เฅฆ)เฅฐ เฅฑ+เฆ.เฆ เฆ+เฆ เฆ+เฆ เฆ+เฆฉ เฆช+เฆฑ เฆฒ+เฆณ เฆถ+เฆบ เฆผ.เฆฝ+เฆพ.เง เง.เง เง.เง+เง เง.เง เง+เง เง+เงข.เงค เงฆ)เงฐ+เงฒ เงผ+เงฝ เงพ.เงฟ เจ.เจ เจ+เจ เจ+เจ เจ+เจฉ เจช+เจฑ เจฒ+เจด เจต+เจท เจธ+เจบ เจผ.เจฝ เจพ.เฉ เฉ.เฉ เฉ.เฉ เฉ.เฉ เฉ+เฉ เฉ+เฉ เฉฆ)เฉฐ.เฉฒ+เฉต.เฉถ เช.เช เช+เช เช+เช เช+เชฉ เชช+เชฑ เชฒ+เชด เชต+เชบ เชผ.เชฝ+เชพ.เซ เซ.เซ เซ.เซ เซ+เซ เซ+เซข.เซค เซฆ)เซฐ เซน+เซบ.เฌ เฌ.เฌ เฌ+เฌ เฌ+เฌ เฌ+เฌฉ เฌช+เฌฑ เฌฒ+เฌด เฌต+เฌบ เฌผ.เฌฝ+เฌพ.เญ เญ.เญ เญ.เญ เญ.เญ เญ+เญ เญ+เญข.เญค เญฆ)เญฐ เญฑ+เญฒ เฎ.เฎ+เฎ เฎ+เฎ เฎ+เฎ เฎ+เฎ เฎ+เฎ เฎ+เฎ เฎ+เฎ เฎฃ+เฎฅ เฎจ+เฎซ เฎฎ+เฎบ เฎพ.เฏ เฏ.เฏ เฏ.เฏ เฏ+เฏ เฏ.เฏ เฏฆ)เฏฐ เฐ.เฐ+เฐ เฐ+เฐ เฐ+เฐฉ เฐช+เฐบ เฐผ.เฐฝ+เฐพ.เฑ เฑ.เฑ เฑ.เฑ เฑ.เฑ เฑ+เฑ เฑ+เฑ เฑ+เฑข.เฑค เฑฆ)เฑฐ เฒ+เฒ.เฒ เฒ+เฒ เฒ+เฒ เฒ+เฒฉ เฒช+เฒด เฒต+เฒบ เฒผ.เฒฝ+เฒพ.เณ เณ.เณ เณ.เณ เณ.เณ เณ+เณ เณ+เณข.เณค เณฆ)เณฐ เณฑ+เณณ.เณด เด.เด+เด เด+เด เด+เดป.เดฝ+เดพ.เต เต.เต เต.เต+เต เต+เต.เต เต+เตข.เตค เตฆ)เตฐ เตบ+เถ เถ.เถ เถ+เถ เถ+เถฒ เถณ+เถผ เถฝ+เถพ เท+เท เท.เท เท.เท เท.เท เท.เท เทฆ)เทฐ เทฒ.เทด เธฑ.เธฒ เธด.เธป เน.เน เน)เน เบฑ.เบฒ เบด.เบฝ เป.เป เป)เป เผ+เผ เผ.เผ เผ)เผช เผต.เผถ เผท.เผธ เผน.เผบ เผพ.เฝ+เฝ เฝ+เฝญ เฝฑ.เพ เพ.เพ+เพ.เพ เพ.เพฝ เฟ.เฟ แซ.แฟ แ)แ แ.แ แ.แก แข.แฅ แง.แฎ แฑ.แต แ.แ แ.แ)แ.แ แ+แ แ+แ แ+แ แ+แป แผ+แ แ+แ แ+แ แ+แ แ+แ แ+แ แ+แ แ+แฑ แฒ+แถ แธ+แฟ แ+แ แ+แ แ+แ แ+แ แ+แ แ+แ แ.แ แ+แ แ+แถ แธ+แพ แ+แญ แฏ+แ$แ+แ แ+แซ แฎ+แน แ+แ.แ แ+แฒ.แต แ+แ.แ แ+แญ แฎ+แฑ แฒ.แด แด.แ แ.แ แ)แช แ.แ-แ.แ)แ แ+แกน แข+แข.แข+แขฉ.แขช+แขซ แขฐ+แฃถ แค+แค แค.แคฌ แคฐ.แคผ แฅ)แฅ แง)แง แจ+แจ.แจ แฉ.แฉ แฉ.แฉฝ แฉฟ.แช)แช แช)แช แชฐ.แซ แฌ.แฌ+แฌด.แญ+แญ แญ)แญ แญซ.แญด แฎ.แฎ+แฎก.แฎฎ+แฎฐ)แฎบ+แฏฆ.แฏด แฐ+แฐค.แฐธ แฑ)แฑ แฑ+แฑ)แฑ+แฑพ แฒ+แฒ แฒ+แฒป แฒฝ+แณ แณ.แณ แณ.แณฉ+แณญ.แณฎ+แณด.แณต+แณท.แณบ+แณป แด+แท.แธ+แผ แผ+แผ แผ+แฝ แฝ+แฝ แฝ+แฝ แฝ+แฝ แฝ+แฝ แฝ+แฝ แฝ+แฝพ แพ+แพต แพถ+แพฝ แพพ+แพฟ แฟ+แฟ แฟ+แฟ แฟ+แฟ แฟ+แฟ แฟ+แฟญ แฟฒ+แฟต แฟถ+แฟฝ โ$โ โ$โ โ.โ0โ-โ โ(โ โค(โฅ โง*\\u2028"โช-โฏ,โฐ โฟ,โ โ'โ โ,โ โ$โ-โฅ โฆ-โฐ โฑ+โฒ โฟ+โ โ+โ โ.โฑ โ+โ โ+โ โ+โ โ+โ โ+โ โค+โฅ โฆ+โง โจ+โฉ โช+โฎ โฏ+โบ โผ+โ โ+โ โ+โ โ+โ โถ+โช โฐ+โณฅ โณซ+โณฏ.โณฒ+โณด โด+โดฆ โดง+โดจ โดญ+โดฎ โดฐ+โตจ โตฏ+โตฐ โตฟ.โถ+โถ โถ+โถง โถจ+โถฏ โถฐ+โถท โถธ+โถฟ โท+โท โท+โท โท+โท โท+โท โท.โธ โธฏ+โธฐ ใ$ใ ใ+ใ ใช.ใฐ ใฑ1ใถ ใป+ใฝ ใ.ใ1ใ ใ1ใป ใผ1ใ ใ+ใฐ ใฑ+ใ ใ+ใ ใฐ1ใ ใ1ใฟ ใ1ใ ๊+๊ ๊+๊พ ๊+๊ ๊+๊)๊ช+๊ฌ ๊+๊ฏ.๊ณ ๊ด.๊พ ๊ฟ+๊.๊+๊ฐ.๊ฒ ๊+๊ ๊+๊ ๊+๊ ๊+๊ ๊ฒ+๊.๊+๊.๊+๊.๊+๊ฃ.๊จ ๊ฌ.๊ญ ๊ก+๊กด ๊ข.๊ข+๊ขด.๊ฃ ๊ฃ)๊ฃ ๊ฃ.๊ฃฒ+๊ฃธ ๊ฃป+๊ฃผ ๊ฃฝ+๊ฃฟ.๊ค)๊ค+๊คฆ.๊คฎ ๊คฐ+๊ฅ.๊ฅ ๊ฅ+๊ฅฝ ๊ฆ.๊ฆ+๊ฆณ.๊ง ๊ง+๊ง)๊ง ๊งฅ.๊งฆ ๊งฐ)๊งบ ๊จ+๊จฉ.๊จท ๊ฉ+๊ฉ.๊ฉ+๊ฉ.๊ฉ ๊ฉ)๊ฉ ๊ฉป.๊ฉพ ๊ชฐ.๊ชฑ ๊ชฒ.๊ชต ๊ชท.๊ชน ๊ชพ.๊ซ ๊ซ.๊ซ ๊ซ+๊ซซ.๊ซฐ ๊ซฒ+๊ซต.๊ซท ๊ฌ+๊ฌ ๊ฌ+๊ฌ ๊ฌ+๊ฌ ๊ฌ+๊ฌง ๊ฌจ+๊ฌฏ ๊ฌฐ+๊ญช ๊ญฐ+๊ฏฃ.๊ฏซ ๊ฏฌ.๊ฏฎ ๊ฏฐ)๊ฏบ ๊ฐ+ํค ํฐ+ํ ํ+ํผ ๏ฌ+๏ฌ ๏ฌ+๏ฌ ๏ฌ/๏ฌ.๏ฌ/๏ฌฉ ๏ฌช/๏ฌท ๏ฌธ/๏ฌฝ ๏ฌพ/๏ฌฟ ๏ญ/๏ญ ๏ญ/๏ญ ๏ญ/๏ญ+๏ฎฒ ๏ฏ+๏ดพ ๏ต+๏ถ ๏ถ+๏ท ๏ทฐ+๏ทผ ๏ธ.๏ธ ๏ธ*๏ธ ๏ธ.๏ธฐ ๏ธณ,๏ธต ๏น,๏น'๏น ๏น(๏น ๏น'๏น*๏น ๏นฐ+๏นต ๏นถ+๏ปฝ \\uFEFF-๏ผ ๏ผ(๏ผ ๏ผ'๏ผ ๏ผ(๏ผ ๏ผ)๏ผ*๏ผ'๏ผ ๏ผก+๏ผป ๏ผฟ,๏ฝ ๏ฝ+๏ฝ ๏ฝฆ1๏พ.๏พ+๏พฟ ๏ฟ+๏ฟ ๏ฟ+๏ฟ ๏ฟ+๏ฟ ๏ฟ+๏ฟ ๏ฟน-๏ฟผ ๏ฟฟ \`,kt="๐+๐ ๐+๐ง ๐จ+๐ป ๐ผ+๐พ ๐ฟ+๐ ๐+๐ ๐+๐ป ๐+๐ต ๐ฝ.๐พ ๐+๐ ๐+๐ ๐.๐ก ๐+๐ ๐ญ+๐ ๐+๐ถ.๐ป ๐+๐ ๐+๐ ๐+๐ ๐+๐ ๐+๐ ๐)๐ช ๐ฐ+๐ ๐+๐ผ ๐+๐จ ๐ฐ+๐ค ๐ฐ+๐ป ๐ผ+๐ ๐+๐ ๐+๐ ๐+๐ข ๐ฃ+๐ฒ ๐ณ+๐บ ๐ป+๐ฝ ๐+๐ด ๐+๐ท ๐+๐ ๐+๐จ ๐+๐ ๐+๐ฑ ๐ฒ+๐ป ๐+๐ ๐+๐ ๐+๐ถ ๐ท+๐น ๐ผ+๐ฝ ๐ฟ+๐ก ๐ก+๐กท ๐ข+๐ข ๐ฃ+๐ฃณ ๐ฃด+๐ฃถ ๐ค+๐ค ๐ค+๐คบ ๐ฆ+๐ฆธ ๐ฆพ+๐ง ๐จ+๐จ.๐จ ๐จ.๐จ ๐จ.๐จ+๐จ ๐จ+๐จ ๐จ+๐จถ ๐จธ.๐จป ๐จฟ.๐ฉ ๐ฉ+๐ฉฝ ๐ช+๐ช ๐ซ+๐ซ ๐ซ+๐ซฅ.๐ซง ๐ฌ+๐ฌถ ๐ญ+๐ญ ๐ญ+๐ญณ ๐ฎ+๐ฎ ๐ฐ+๐ฑ ๐ฒ+๐ฒณ ๐ณ+๐ณณ ๐ด+๐ดค.๐ดจ ๐ดฐ)๐ดบ ๐ต)๐ต+๐ตฆ ๐ตฉ.๐ตฎ ๐ตฏ+๐ถ ๐บ+๐บช ๐บซ.๐บญ ๐บฐ+๐บฒ ๐ป+๐ป ๐ปผ.๐ผ+๐ผ ๐ผง+๐ผจ ๐ผฐ+๐ฝ.๐ฝ ๐ฝฐ+๐พ.๐พ ๐พฐ+๐ฟ ๐ฟ+๐ฟท ๐.๐+๐ธ.๐ ๐ฆ)๐ฐ.๐ฑ+๐ณ.๐ต+๐ถ ๐ฟ.๐+๐ฐ.๐ป ๐ฝ)๐พ ๐.๐ ๐)๐ ๐+๐ฉ ๐ฐ)๐บ ๐.๐+๐ง.๐ต ๐ถ)๐ ๐+๐.๐+๐ ๐+๐ณ.๐ด ๐ถ+๐ท ๐.๐+๐ณ.๐+๐ ๐.๐ ๐.๐)๐+๐ ๐+๐ ๐+๐ ๐+๐ฌ.๐ธ ๐พ.๐ฟ+๐.๐ ๐+๐ ๐+๐ ๐+๐ ๐+๐ ๐+๐ฉ ๐ฐ+๐.๐ซ ๐ฐ)๐บ ๐.๐ ๐+๐ ๐+๐ ๐+๐ฉ ๐ช+๐ฑ ๐ฒ+๐ด ๐ต+๐บ ๐ป.๐ฝ+๐พ.๐ ๐.๐ ๐.๐ ๐+๐ ๐.๐ ๐+๐ข.๐ค ๐ฆ.๐ญ ๐ฐ.๐ต ๐+๐ ๐+๐ ๐+๐ ๐+๐ถ ๐ท+๐ธ.๐ ๐.๐ ๐.๐ ๐.๐ ๐.๐+๐.๐+๐ ๐ก.๐ฃ ๐+๐ต.๐+๐ ๐)๐ ๐.๐+๐ข ๐+๐ฐ.๐+๐ ๐+๐ ๐)๐ ๐+๐ฏ.๐ถ ๐ธ.๐ ๐+๐.๐ ๐+๐ฐ.๐ ๐+๐ ๐)๐ ๐+๐ซ.๐ธ+๐น ๐)๐ ๐)๐ค ๐.๐ฌ ๐ฐ)๐บ ๐+๐ฌ.๐ป ๐ข+๐ฃ)๐ฃช ๐ฃฟ+๐ค ๐ค+๐ค ๐ค+๐ค ๐ค+๐ค ๐ค+๐คฐ.๐คถ ๐คท.๐คน ๐คป.๐คฟ+๐ฅ.๐ฅ+๐ฅ.๐ฅ ๐ฅ)๐ฅ ๐ฆ+๐ฆจ ๐ฆช+๐ง.๐ง ๐ง.๐งก+๐งข ๐งฃ+๐งค.๐งฅ ๐จ+๐จ.๐จ+๐จณ.๐จบ+๐จป.๐จฟ ๐ฉ.๐ฉ ๐ฉ+๐ฉ.๐ฉ+๐ช.๐ช ๐ช+๐ช ๐ชฐ+๐ซน ๐ฏ+๐ฏก ๐ฏฐ)๐ฏบ ๐ฐ+๐ฐ ๐ฐ+๐ฐฏ.๐ฐท ๐ฐธ.๐ฑ+๐ฑ ๐ฑ)๐ฑ ๐ฑฒ+๐ฒ ๐ฒ.๐ฒจ ๐ฒฉ.๐ฒท ๐ด+๐ด ๐ด+๐ด ๐ด+๐ดฑ.๐ดท ๐ดบ.๐ดป ๐ดผ.๐ดพ ๐ดฟ.๐ต+๐ต.๐ต ๐ต)๐ต ๐ต+๐ตฆ ๐ตง+๐ตฉ ๐ตช+๐ถ.๐ถ ๐ถ.๐ถ ๐ถ.๐ถ+๐ถ ๐ถ)๐ถช ๐ป+๐ปณ.๐ปท ๐ผ.๐ผ+๐ผ.๐ผ+๐ผ ๐ผ+๐ผด.๐ผป ๐ผพ.๐ฝ ๐ฝ)๐ฝ.๐ฝ ๐พฐ+๐พฑ ๐+๐ ๐+๐ฏ ๐+๐ ๐พ+๐ฟฑ ๐+๐ฐ-๐.๐+๐.๐ ๐+๐ป ๐+๐ ๐+๐.๐ฐ)๐บ ๐+๐จน ๐ฉ+๐ฉ ๐ฉ)๐ฉช ๐ฉฐ+๐ชฟ ๐ซ)๐ซ ๐ซ+๐ซฎ ๐ซฐ.๐ซต ๐ฌ+๐ฌฐ.๐ฌท ๐ญ+๐ญ ๐ญ)๐ญ ๐ญฃ+๐ญธ ๐ญฝ+๐ฎ ๐ต+๐ตญ ๐ตฐ)๐ตบ ๐น+๐บ ๐ผ+๐ฝ ๐ฝ.๐ฝ+๐ฝ.๐พ ๐พ.๐พ+๐พ ๐ฟ+๐ฟข ๐ฟฃ+๐ฟค.๐ฟฅ ๐ฟฐ.๐ฟฒ ๐ฟฐ1๐ฟด ๐ฟต1๐ฟผ ๐ฟฝ1๐ฟฟ ๐1๐ ๐1๐ฃ ๐1๐ ๐ค1๐จ ๐ฐ+๐ฑซ ๐ฑฐ+๐ฑฝ ๐ฒ+๐ฒ ๐ฒ+๐ฒ ๐ฒ.๐ฒ ๐ฒ-๐ฒค ๐ณฐ)๐ณบ ๐ผ.๐ผฎ ๐ผฐ.๐ฝ ๐ฅ.๐ช ๐ญ.๐ณ-๐ป.๐ ๐.๐ ๐ช.๐ฎ ๐.๐ ๐+๐ ๐+๐ ๐+๐ ๐ข+๐ฃ ๐ฅ+๐ง ๐ฉ+๐ญ ๐ฎ+๐บ ๐ป+๐ผ ๐ฝ+๐ ๐+๐ ๐+๐ ๐+๐ ๐+๐ ๐+๐บ ๐ป+๐ฟ ๐+๐ ๐+๐ ๐+๐ ๐+๐ฆ ๐จ+๐ ๐+๐ ๐+๐ป ๐ผ+๐ ๐+๐ต ๐ถ+๐ ๐+๐ฏ ๐ฐ+๐ ๐+๐ฉ ๐ช+๐ ๐+๐ ๐)๐ ๐จ.๐จท ๐จป.๐ฉญ ๐ฉต.๐ฉถ ๐ช.๐ช ๐ช.๐ช ๐ชก.๐ชฐ ๐ผ+๐ผ ๐ผฅ+๐ผซ ๐.๐ ๐.๐ ๐.๐ข ๐ฃ.๐ฅ ๐ฆ.๐ซ ๐ฐ+๐ฎ ๐.๐ ๐+๐ญ ๐ฐ.๐ท+๐พ ๐)๐ ๐+๐ ๐+๐ฎ.๐ฏ ๐+๐ฌ.๐ฐ)๐บ ๐+๐ฌ.๐ฐ)๐บ ๐+๐ฎ.๐ฐ+๐ฑ)๐ป ๐+๐ง ๐จ+๐ฌ ๐ญ+๐ฏ ๐ฐ+๐ฟ ๐+๐ฃ ๐ฃ.๐ฃ ๐ค+๐ฅ.๐ฅ+๐ฅ ๐ฅ)๐ฅ ๐ธ+๐ธ ๐ธ+๐ธ ๐ธก+๐ธฃ ๐ธค+๐ธฅ ๐ธง+๐ธจ ๐ธฉ+๐ธณ ๐ธด+๐ธธ ๐ธน+๐ธบ ๐ธป+๐ธผ ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐น+๐น ๐นก+๐นฃ ๐นค+๐นฅ ๐นง+๐นซ ๐นฌ+๐นณ ๐นด+๐นธ ๐นน+๐นฝ ๐นพ+๐นฟ ๐บ+๐บ ๐บ+๐บ ๐บก+๐บค ๐บฅ+๐บช ๐บซ+๐บผ ๐ฐ+๐ ๐+๐ช ๐ฐ+๐ ๐ฆ2๐ ๐ป.๐ ๐ฏฐ)๐ฏบ ๓-๓ ๓.๓ ๓.๓ฐ ";function wt(o){let e=o<=65535?2:3,t=e==2?bt:kt;return He(t,o,e,0,t.length/e-1)-32}h(wt,"searchForProperty");function He(o,e,t,r,n){if(n<r)return 0;let i=r+~~((n-r)/2),s=o.codePointAt(t*i),l=o.codePointAt(t*(i+1)),a=isNaN(l)?1/0:l;return e<s?He(o,e,t,r,i-1):e>=a?He(o,e,t,i+1,n):o.charCodeAt(t*(i+1)-1)}h(He,"_searchForProperty");function R(o,e){let t=jt(o,e);if(t.length==0)return[];let r=[];for(let n=0;n<t.length-1;n++){let i=t[n],s=t[n+1],l=new ye(o,i,s);Gt(l.text,e)?r.push(l):n==t.length-2&&(l=new ye(o,s,s),r.push(l))}return r}h(R,"default_");var Ge=class Ge{constructor(e,t,r){this._source=e,this.start=t,this.end=r}get text(){return this._source.substring(this.start,this.end)}get length(){return this.end-this.start}};h(Ge,"LazySpan");var ye=Ge,Y=class Y{constructor(e,t,r,n,i,s){this.lookbehind=19;this.left=19;this.right=19;this.text=e,this.options=t,arguments.length==3?this.lookahead=this.wordbreakPropertyAt(r):(this.lookbehind=r,this.left=n,this.right=i,this.lookahead=s)}next(e){let t=this.wordbreakPropertyAt(e);return new Y(this.text,this.options,this.left,this.right,this.lookahead,t)}ignoringRight(e){let t=this.wordbreakPropertyAt(e);return new Y(this.text,this.options,this.lookbehind,this.left,this.lookahead,t)}ignoringLookahead(e){let t=this.wordbreakPropertyAt(e);return new Y(this.text,this.options,this.lookbehind,this.left,this.right,t)}wordbreakPropertyAt(e){return e<0?19:e>=this.text.length?20:yt(this.text[e])?ze(this.text[e]+this.text[e+1]):ze(this.text[e],this.options)}match(e,t,r,n){var s,l,a,u;let i=(s=e==null?void 0:e.includes(this.lookbehind))!=null?s:!0;return i=i&&((l=t==null?void 0:t.includes(this.left))!=null?l:!0),i=i&&((a=r==null?void 0:r.includes(this.right))!=null?a:!0),i&&((u=n==null?void 0:n.includes(this.lookahead))!=null?u:!0)}propertyMatch(e,t,r,n){let i=h(s=>vt(s,this.options),"propMapper");return this.match(e==null?void 0:e.map(i),t==null?void 0:t.map(i),r==null?void 0:r.map(i),n==null?void 0:n.map(i))}};h(Y,"BreakerContext");var Ve=Y;function Gt(o,e){return!o.split("").map(t=>ze(t,e)).every(t=>t===3||t===1||t===2||t===4)}h(Gt,"isNonSpace");function jt(o,e){if(o.length===0)return[];e&&!e.rules&&(e.rules=[]);let t=[],r,n=0,i=new Ve(o,e,n),s=0;do{if(r=n,n=l(n),i=i.next(n),i.match(null,[19],null,null)){t.push(r);continue}if(i.match(null,null,[20],null)){t.push(r);break}if(i.match(null,[3],[1],null))continue;let a=[2,3,1];if(i.match(null,a,null,null)){t.push(r);continue}if(i.match(null,null,a,null)){t.push(r);continue}if(i.match(null,[4],[4],null))continue;let u=[13,14,16];for(;i.match(null,null,u,null);)[r,n]=[n,l(n)],i=i.ignoringRight(n);if(i.right===20){t.push(r);break}for(;i.match(null,null,null,u);)n=l(n),i=i.ignoringLookahead(n);let c=[11,15],p=[8,6];if(e!=null&&e.rules){let x=!1;for(let m of e.rules)if(x=m.match(i),x){m.breakIfMatch&&t.push(r);break}if(x)continue}if(i.match(null,c,c,null))continue;let f=[10].concat(p);if(i.match(null,c,f,c)||i.match(c,f,c,null)||i.match(null,[15],[6],null)||i.match(null,[15],[5],[15])||i.match([15],[5],[15],null)||i.match(null,[9],[9],null)||i.match(null,c,[9],null)||i.match(null,[9],c,null))continue;let d=[7].concat(p);if(i.match([9],d,[9],null)||i.match(null,[9],d,[9])||i.match(null,[17],[17],null))continue;let C=[17,9].concat(c);if(!i.match(null,C,[12],null)&&!i.match(null,[12],[12],null)&&!i.match(null,[12],C,null)){if(i.right===18){if(s+=1,s%2==1)continue}else s=0;t.push(r)}}while(r<o.length);return t;function l(a){return a>=o.length?o.length:yt(o[a])?a+2:a+1}}h(jt,"findBoundaries");function yt(o){let e=o.charCodeAt(0);return e>=55296&&e<=56319}h(yt,"isStartOfSurrogatePair");function ze(o,e){if(e!=null&&e.propertyMapping){let r=e.propertyMapping(o);if(r)return vt(r,e)}let t=o.codePointAt(0);return wt(t)}h(ze,"property");function vt(o,e){var n,i;let t=h(s=>s.toLowerCase()==o.toLowerCase(),"matcher"),r=(i=(n=e==null?void 0:e.customProperties)==null?void 0:n.findIndex(t))!=null?i:-1;return r!=-1?-r-1:xt.findIndex(t)}h(vt,"propertyVal");O();var Lt=12,_=class _{constructor(e,t,r){this.root=e,this.prefix=t,this.totalWeight=r}child(e){if(e=="")return this;let t=e.split(""),r=this;for(;t.length>0&&r;){let n=t.shift();r=r._child(n)}return r}_child(e){let t=this.root,r=this.totalWeight,n=this.prefix+e;if(t.type=="internal"){let i=t.children[e];return i?new _(i,n,r):void 0}else return t.entries.filter(function(s){return s.key.indexOf(n)==0}).length?new _(t,n,r):void 0}*children(){let e=this.root,t=this.totalWeight;if(e.type=="internal"){for(let r of e.values){let n=e.children[r];if(F(r))if(n.type=="internal"){let i=n;for(let s of i.values){let l=this.prefix+r+s;yield{char:r+s,traversal:function(){return new _(i.children[s],l,t)}}}}else{let i=n.entries[0].key;r=r+i[this.prefix.length+1];let s=this.prefix+r;yield{char:r,traversal:function(){return new _(n,s,t)}}}else{if(ke(r))continue;if(r){let i=this.prefix+r;yield{char:r,traversal:function(){return new _(n,i,t)}}}else continue}}return}else{let r=this.prefix,n=e.entries.filter(function(i){return i.key!=r&&r.length<i.key.length});for(let{key:i}of n){let s=i[r.length];F(s)&&(s=s+i[r.length+1]),yield{char:s,traversal:function(){return new _(e,r+s,t)}}}return}}get entries(){let e=h(t=>({text:t.content,p:t.weight/this.totalWeight}),"entryMapper");if(this.root.type=="leaf"){let t=this.prefix;return this.root.entries.filter(function(n){return n.key==t}).map(e)}else{let t=this.root.children[N];return t&&t.type=="leaf"?t.entries.map(e):[]}}get p(){return this.root.weight/this.totalWeight}};h(_,"Traversal");var je=_,Ye=class Ye{constructor(e,t={}){this.languageUsesCasing=t.languageUsesCasing,this.applyCasing=t.applyCasing,this._trie=new Xe(e.root,e.totalWeight,t.searchTermToKey||Xt),this.breakWords=t.wordBreaker||R,this.punctuation=t.punctuation}configure(e){var t;return this.configuration={leftContextCodePoints:e.maxLeftContextCodePoints,rightContextCodePoints:(t=e.maxRightContextCodePoints)!=null?t:0}}toKey(e){return this._trie.toKey(e)}predict(e,t){if(!e.insert&&!t.left&&!t.right&&t.startOfBuffer&&t.endOfBuffer)return s(this._trie.firstN(Lt).map(({text:l,p:a})=>({transform:{insert:l,deleteLeft:0},displayAs:l,p:a})));let r=g(e,t),n=e.deleteLeft-e.insert.kmwLength(),i=ae(this.breakWords,r);return s(this._trie.lookup(i).map(({text:l,p:a})=>W({insert:l,deleteLeft:n+i.kmwLength()},a)));function s(l){let a=[];for(let u of l)a.push({sample:u,p:u.p});return a}}get wordbreaker(){return this.breakWords}traverseFromRoot(){return this._trie.traverseFromRoot()}};h(Ye,"TrieModel");var ue=Ye,$e=class $e{constructor(e,t,r){this.root=e,this.toKey=r,this.totalWeight=t}traverseFromRoot(){return new je(this.root,"",this.totalWeight)}lookup(e){let t=this.toKey(e),r=this.traverseFromRoot().child(t);if(!r)return[];let n=r.entries,i={};for(let a of n)i[a.text]=a.text;let l=Mt(r).filter(a=>!i[a.text]);return n.concat(l)}firstN(e){return Mt(this.traverseFromRoot(),e)}};h($e,"Trie");var Xe=$e;function Mt(o,e=Lt){let t=new k(function(n,i){return(i?i.p:0)-(n?n.p:0)}),r=[];for(t.enqueue(o);t.count>0;){let n=t.dequeue();if(n.text!==void 0){let i=n;if(r.push(i),r.length>=e)return r}else{let i=n;t.enqueueAll(i.entries);let s=[];for(let l of i.children())s.push(l.traversal());t.enqueueAll(s)}}return r}h(Mt,"getSortedResults");function Xt(o){return o.normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").toLowerCase()}h(Xt,"defaultSearchTermToKey");var et=class et{constructor(e){e=e||{},this._futureSuggestions=e.futureSuggestions?e.futureSuggestions.slice():[],e.punctuation&&(this.punctuation=e.punctuation),this.toKey=e.toKey,this.wordbreaker=e.wordbreaker,this.applyCasing=e.applyCasing,this.languageUsesCasing=e.languageUsesCasing}configure(e){return this.configuration={leftContextCodePoints:e.maxLeftContextCodePoints,rightContextCodePoints:e.maxRightContextCodePoints},this.configuration}predict(e,t,r){let n=h(function(s){let l=[];for(let a of s)l.push({sample:a,p:a.p!==void 0?a.p:1});return l},"makeUniformDistribution");if(r)return n(r);let i=this._futureSuggestions.shift();return i?n(i):[]}};h(et,"DummyModel");var Je=et,Et=Je;var Ce={};_e(Ce,{ClassicalDistanceCalculation:()=>K,ContextTracker:()=>Te,ExecutionBucket:()=>ce,ExecutionSpan:()=>Q,ExecutionTimer:()=>he,QUEUE_NODE_COMPARATOR:()=>Le,STANDARD_TIME_BETWEEN_DEFERS:()=>Me,SearchNode:()=>Ee,SearchResult:()=>de,SearchSpace:()=>v,TrackedContextState:()=>V,TrackedContextSuggestion:()=>lt,TrackedContextToken:()=>z});var T=class T{constructor(e){this.diagonalWidth=2;this.inputSequence=[];this.matchSequence=[];if(e){let t=e.resolvedDistances.length;this.resolvedDistances=Array(t);for(let r=0;r<t;r++)this.resolvedDistances[r]=e.resolvedDistances[r].slice(0);this.inputSequence=e.inputSequence.slice(0),this.matchSequence=e.matchSequence.slice(0),this.diagonalWidth=e.diagonalWidth}else this.resolvedDistances=[]}getTrueIndex(e,t,r){let n={row:e,col:t-e+r,sparse:!1};return(n.col<0||n.col>2*r)&&(n.sparse=!0),n}getCostAt(e,t,r=this.diagonalWidth){if(e<0||t<0)return e==-1&&t>=-1?t+1:t==-1&&e>=-1?e+1:Number.MAX_VALUE;let n=this.getTrueIndex(e,t,r);return n.sparse?Number.MAX_VALUE:this.resolvedDistances[n.row][n.col]}getFinalCost(){let e=this,t=e.getHeuristicFinalCost();for(;t>e.diagonalWidth;)e=e.increaseMaxDistance(),t=e.getHeuristicFinalCost();return t}getHeuristicFinalCost(){return this.getCostAt(this.inputSequence.length-1,this.matchSequence.length-1)}hasFinalCostWithin(e){let t=this,r=t.getHeuristicFinalCost(),n=this.diagonalWidth;do{if(r<=e)return!0;if(n<e)t=t.increaseMaxDistance(),n++,r=t.getHeuristicFinalCost();else break}while(!0);return!1}editPath(e=this.inputSequence.length-1,t=this.matchSequence.length-1){let r=this.getCostAt(e,t),n=null,i=null,s=this.getCostAt(e,t-1),l=this.getCostAt(e-1,t),a=this.getCostAt(e-1,t-1),[u,c]=T.getTransposeParent(this,e,t);if(u>=0&&c>=0){let p=1;if(n=["transpose-start"],u!=e-1){let f=e-u-1;n=n.concat(Array(f).fill("transpose-delete")),p+=f}else{let f=t-c-1;n=n.concat(Array(f).fill("transpose-insert")),p+=f}n.push("transpose-end"),this.getCostAt(u-1,c-1)!=r-p&&(n=null),i=[u-1,c-1]}return n||(a==r-1?(n=["substitute"],i=[e-1,t-1]):s==r-1?(n=["insert"],i=[e,t-1]):l==r-1?(n=["delete"],i=[e-1,t]):(n=["match"],i=[e-1,t-1])),i[0]>=0&&i[1]>=0?this.editPath(i[0],i[1]).concat(n):i[0]>-1?Array(i[0]+1).fill("delete").concat(n):i[1]>-1?Array(i[1]+1).fill("insert").concat(n):n}static getTransposeParent(e,t,r){if(t<0||r<0||e.inputSequence[t].key==e.matchSequence[r].key)return[-1,-1];let n=-1;for(let s=t-1;s>=0;s--)if(e.inputSequence[s].key==e.matchSequence[r].key){n=s;break}let i=-1;for(let s=r-1;s>=0;s--)if(e.matchSequence[s].key==e.inputSequence[t].key){i=s;break}return[n,i]}static initialCostAt(e,t,r,n,i){var s=e.inputSequence[t].key==e.matchSequence[r].key?0:1,l=e.getCostAt(t-1,r-1)+s,a=n||e.getCostAt(t,r-1)+1,u=i||e.getCostAt(t-1,r)+1,c=Number.MAX_VALUE;if(t>0&&r>0){let[p,f]=T.getTransposeParent(e,t,r);c=e.getCostAt(p-1,f-1)+(t-p-1)+1+(r-f-1)}return Math.min(l,u,a,c)}getSubset(e,t){let r=new T(this);if(e>this.inputSequence.length||t>this.matchSequence.length)throw"Invalid dimensions specified for trim operation";r.inputSequence.splice(e),r.matchSequence.splice(t),r.resolvedDistances.splice(e);let n=this.getTrueIndex(e-1,t-1,this.diagonalWidth);for(let i=n.col;i<=2*this.diagonalWidth;i++){let s=n.row-(i-n.col);if(s<0)break;if(i<0)r.resolvedDistances[s]=Array(2*r.diagonalWidth+1).fill(Number.MAX_VALUE);else{let l=2*this.diagonalWidth-i,a=r.resolvedDistances[s].splice(0,i+1),u=Array(l).fill(Number.MAX_VALUE);r.resolvedDistances[s]=a.concat(u)}}return r}static forDiagonalOfAxis(e,t,r,n){let i=r-t<e?r-t+e:2*e,s=t-e,l=s<0?0:s;for(let a=l-s;a<=i;a++)n(s+a,a)}addInputChar(e){let t=new T(this),r=t.inputSequence.length;t.inputSequence.push(e);let n=Array(2*t.diagonalWidth+1).fill(Number.MAX_VALUE);return t.resolvedDistances[r]=n,t.matchSequence.length==0||T.forDiagonalOfAxis(t.diagonalWidth,r,t.matchSequence.length-1,function(i,s){n[s]=T.initialCostAt(t,r,i)}),t}addMatchChar(e){let t=new T(this),r=t.matchSequence.length;return t.matchSequence.push(e),t.inputSequence.length==0||T.forDiagonalOfAxis(t.diagonalWidth,r,t.inputSequence.length-1,function(n,i){var s=t.resolvedDistances[n];s[2*t.diagonalWidth-i]=T.initialCostAt(t,n,r)}),t}increaseMaxDistance(){let e=new T(this);if(e.diagonalWidth++,e.inputSequence.length<1||e.matchSequence.length<1)return e;function t(n,i,s,l){let a=2*(e.diagonalWidth-1),u=s.length-1;a=a<u-n?a:u-n;for(let c=0;c<=a;c++)i==s[n+c].key&&l(n+c,c)}h(t,"forPossibleTranspositionsInDiagonal");for(let n=0;n<e.inputSequence.length;n++){let i=Number.MAX_VALUE,s=n-e.diagonalWidth;if(s>=0){let a=s==0?n+2:Number.MAX_VALUE;i=T.initialCostAt(e,n,s,a,void 0);let u=i;if(s<e.matchSequence.length-1){T.propagateUpdateFrom(e,n,s+1,u+1,0);let c=n+2;if(n+2<this.inputSequence.length){let p=e.inputSequence[n+1].key;t(s+3,p,e.matchSequence,function(f,d){T.propagateUpdateFrom(e,c,f,u+d+2,d)})}}}let l=Number.MAX_VALUE;if(s=n+e.diagonalWidth,s<e.matchSequence.length){let a=n==0?s+2:Number.MAX_VALUE;var r=e.getCostAt(n,s-1,this.diagonalWidth)+1;l=T.initialCostAt(e,n,s,r,a);let u=l;if(n<e.inputSequence.length-1){T.propagateUpdateFrom(e,n+1,s,u+1,2*this.diagonalWidth);let c=s+2;if(s+2<this.matchSequence.length){let p=e.matchSequence[n+1].key;t(n+3,p,e.inputSequence,function(f,d){let C=2*(e.diagonalWidth-1)-d;T.propagateUpdateFrom(e,f,c,u+d+2,C)})}}}e.resolvedDistances[n]=[i].concat(e.resolvedDistances[n],l)}return e}static propagateUpdateFrom(e,t,r,n,i){if(n<e.resolvedDistances[t][i])e.resolvedDistances[t][i]=n;else return;let s=t<e.inputSequence.length-1,l=r<e.matchSequence.length-1;if(i<2*(e.diagonalWidth-1)&&l){let a=n+1;this.propagateUpdateFrom(e,t,r+1,a,i+1)}if(i>0&&s){let a=n+1;this.propagateUpdateFrom(e,t+1,r,a,i-1)}if(s&&l){let a=n+(e.inputSequence[t+1].key==e.matchSequence[r+1].key?0:1);this.propagateUpdateFrom(e,t+1,r+1,a,i);let u=-1;for(let p=t+2;p<e.inputSequence.length;p++)if(e.inputSequence[p].key==e.matchSequence[r+1].key){u=p;break}let c=-1;for(let p=r+2;p<e.matchSequence.length;p++)if(e.matchSequence[p].key==e.inputSequence[t+1].key){c=p;break}if(u>0&&c>0){let p=n+(u-t-2)+1+(c-r-2);this.propagateUpdateFrom(e,u,c,p,e.diagonalWidth-1+c-u)}}}get mapKey(){let e=this.inputSequence.map(r=>r.key).join(""),t=this.matchSequence.map(r=>r.key).join("");return e+N+t+N+this.diagonalWidth}get lastInputEntry(){return this.inputSequence[this.inputSequence.length-1]}get lastMatchEntry(){return this.matchSequence[this.matchSequence.length-1]}static computeDistance(e,t,r=1){let n=new T;r=r||1,n.diagonalWidth=r;for(let i=0;i<e.length;i++)n=n.addInputChar(e[i]);for(let i=0;i<t.length;i++)n=n.addMatchChar(t[i]);return n}};h(T,"ClassicalDistanceCalculation");var K=T;var Yt=1,Pt=5,Me=5,tt=class tt{constructor(e){this.timeSpent=0;this.eventCount=0;this.timeSquared=0;this.nearOutliers=[];this.outliers=[];this.preventOutliers=!1;this.preventOutliers=!!e}add(e){if(e<0)throw new Error("time may not be negative");this.eventCount++,this.timeSpent+=e,this.timeSquared+=e*e,e>=Yt&&(this.nearOutliers.length<Pt||this.nearOutliers[Pt-1]<e)&&(this.nearOutliers.push(e),this.nearOutliers.sort((t,r)=>r-t)),this.checkForOutlier()}checkForOutlier(){if(this.preventOutliers||this.eventCount<4||this.nearOutliers.length==0)return;let e=this.nearOutliers[0];this.timeSpent-=e,this.timeSquared-=e*e,this.eventCount--;let t=this.average,r=e-t,n=this.variance,i=r*r/n;i>=49||this.eventCount>=8&&i>=9?(this.nearOutliers.shift(),this.outliers.push(e)):(this.timeSpent+=e,this.timeSquared+=e*e,this.eventCount++)}get average(){return this.timeSpent/this.eventCount}get variance(){let e=this.eventCount;return e<=1?NaN:this.timeSquared/e-this.timeSpent*this.timeSpent/(e*e)}get outlierTime(){let e=0;for(let t=0;t<this.outliers.length;t++)e+=this.outliers[t];return e}};h(tt,"ExecutionBucket");var ce=tt,rt=class rt{constructor(e,t){this.bucket=e,this.finalizer=t,this.start=performance.now()}end(){var e,t;this.finish=performance.now(),(e=this.bucket)==null||e.add(this.duration),(t=this.finalizer)==null||t.call(this)}get duration(){var e;return((e=this.finish)!=null?e:performance.now())-this.start}};h(rt,"ExecutionSpan");var Q=rt,nt=class nt{constructor(e,t){this.buckets={};this.deferBucket=new ce(!0);this.activeSpan=null;this.spanSinceLastDefer=null;this.trueStart=performance.now(),this.maxExecutionTime=e,this.maxTrueTime=t,this.spanSinceLastDefer=new Q}validateStart(){if(this.activeSpan)throw new Error("illegal state - span-based timer still pending")}getBucket(e){e!=null||(e=-1);let t=this.buckets[e];return t||(t=this.buckets[e]=new ce),t}get executionTime(){let e=Object.values(this.buckets),t=0;for(let r of e)t+=r.timeSpent;return t}get deferredTime(){let e=Object.values(this.buckets),t=0;for(let r of e)t+=r.outlierTime;return t+=this.deferBucket.timeSpent,t}time(e,t){this.validateStart();let r=performance.now(),n=e(),i=performance.now()-r;return this.getBucket(t).add(i),n}defer(e){return D(this,null,function*(){this.validateStart(),e!=null||(e=0),this.activeSpan=new Q(this.deferBucket,()=>this.activeSpan=null),yield Ue(e),this.activeSpan.end(),this.spanSinceLastDefer=new Q})}get timeSinceLastDefer(){return this.spanSinceLastDefer.duration}start(e){this.validateStart();let t=this.getBucket(e);return this.activeSpan=new Q(t,()=>{this.activeSpan=null}),this.activeSpan}terminate(){this.maxTrueTime=0}get elapsed(){return performance.now()-this.trueStart>=this.maxTrueTime?!0:this.executionTime>=this.maxExecutionTime}};h(nt,"ExecutionTimer");var he=nt;var Le=h(function(o,e){return o.currentCost-e.currentCost},"QUEUE_NODE_COMPARATOR");var H=class H{constructor(e,t){this.toKey=h(e=>e,"toKey");if(t=t||(r=>r),e instanceof H){let r=e;this.calculation=r.calculation,this.currentTraversal=r.currentTraversal,this.priorInput=r.priorInput,this.toKey=r.toKey}else this.calculation=new K,this.currentTraversal=e,this.priorInput=[],this.toKey=t}get knownCost(){return this.calculation.getHeuristicFinalCost()}get inputSamplingCost(){if(this._inputCost!==void 0)return this._inputCost;{let e=v.MIN_KEYSTROKE_PROBABILITY;return this._inputCost=this.priorInput.map(t=>t.p>e?t.p:e).reduce((t,r)=>t-Math.log(r),0),this._inputCost}}get currentCost(){return v.EDIT_DISTANCE_COST_SCALE*this.knownCost+this.inputSamplingCost}buildInsertionEdges(){let e=[];for(let t of this.currentTraversal.children()){let r=t.traversal(),n={key:t.char,traversal:r},i=this.calculation.addMatchChar(n),s=new H(this);s.calculation=i,s.priorInput=this.priorInput,s.currentTraversal=r,e.push(s)}return e}buildDeletionEdges(e){let t=[];for(let r of e){if(r.p<e[0].p*Math.exp(-v.EDIT_DISTANCE_COST_SCALE))break;let n=this.calculation,i=r.sample;i.deleteLeft&&(n=n.getSubset(n.inputSequence.length-i.deleteLeft,n.matchSequence.length));let s=this.priorInput.slice(0);s.push(r);for(let a=0;a<i.insert.length;a++){let u=i.insert[a];F(u)&&(a++,u=u+i.insert[a]);let c=this.toKey(u);c&&(n=n.addInputChar({key:c}))}let l=new H(this);l.calculation=n,l.priorInput=s,t.push(l)}return t}buildSubstitutionEdges(e){let t=this.buildDeletionEdges(e),r=[];for(let n of this.currentTraversal.children())for(let i of t){let s=n.traversal(),l={key:n.char,traversal:s},a=i.calculation.addMatchChar(l),u=new H(this);u.calculation=a,u.priorInput=i.priorInput,u.currentTraversal=s,r.push(u)}return r}get pathKey(){let e=this.priorInput.map(r=>"+"+r.sample.insert+"-"+r.sample.deleteLeft).join(""),t=this.calculation.matchSequence.map(r=>r.key).join("");return e+N+t}get resultKey(){return this.calculation.matchSequence.map(e=>e.key).join("")}get isFullReplacement(){return this.knownCost&&this.knownCost==this.priorInput.length}};h(H,"SearchNode");var Ee=H,it=class it{constructor(e,t){this.processed=[];if(typeof e=="number"){this.index=e,this.correctionQueue=new k(Le,t);return}else this.index=e.index,this.processed=[].concat(e.processed),this.correctionQueue=new k(e.correctionQueue)}increaseMaxEditDistance(){let e=this.correctionQueue.toArray();e.forEach(function(t){t.calculation=t.calculation.increaseMaxDistance()}),this.correctionQueue=new k(Le,e)}};h(it,"SearchSpaceTier");var pe=it,ot=class ot{constructor(e){this.resultNode=e}get inputSequence(){return this.resultNode.priorInput}get matchSequence(){return this.resultNode.calculation.matchSequence}get matchString(){return this.resultNode.resultKey}get knownCost(){return this.resultNode.knownCost}get inputSamplingCost(){return this.resultNode.inputSamplingCost}get totalCost(){return this.resultNode.currentCost}get finalTraversal(){return this.resultNode.currentTraversal}};h(ot,"SearchResult");var de=ot,q=class q{constructor(e){this.tierOrdering=[];this.inputSequence=[];this.minInputCost=[];this.returnedValues={};this.processedEdgeSet={};if(this.buildQueueSpaceComparator(),e instanceof q){this.inputSequence=[].concat(e.inputSequence),this.minInputCost=[].concat(e.minInputCost),this.rootNode=e.rootNode,this.completedPaths=[].concat(e.completedPaths),this.returnedValues=A({},e.returnedValues),this.processedEdgeSet=A({},e.processedEdgeSet),this.tierOrdering=e.tierOrdering.map(n=>new pe(n)),this.selectionQueue=new k(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering);return}let t=e;if(t){if(!t.traverseFromRoot)throw"The provided model does not implement the \`traverseFromRoot\` function, which is needed to support robust correction searching."}else throw"The LexicalModel parameter must not be null / undefined.";this.selectionQueue=new k(this.QUEUE_SPACE_COMPARATOR),this.rootNode=new Ee(t.traverseFromRoot(),t.toKey?t.toKey.bind(t):null),this.completedPaths=[this.rootNode];let r=new pe(0,[this.rootNode]);this.tierOrdering.push(r),this.selectionQueue.enqueue(r)}buildQueueSpaceComparator(){let e=this;this.QUEUE_SPACE_COMPARATOR=function(t,r){let n=t.correctionQueue.peek(),i=r.correctionQueue.peek(),s=t.index,l=r.index,a=0,u=1;if(l<s){let c=l;l=s,s=c,u=-1}for(let c=s;c<l;c++)a=a+e.minInputCost[c];return n&&i?n.currentCost-i.currentCost+u*a:i?1:-1}}increaseMaxEditDistance(){this.tierOrdering.forEach(function(e){e.increaseMaxEditDistance()})}addInput(e){this.inputSequence.push(e),this.minInputCost.push(-Math.log(e[0].p));let t=[],r=this.completedPaths.map(function(i){let s=i.buildDeletionEdges(e),l=i.buildSubstitutionEdges(e);return s.concat(l)});this.completedPaths=[],this.returnedValues={},r.forEach(function(i){t=t.concat(i)});let n=new pe(this.tierOrdering.length,t);this.tierOrdering.push(n),this.selectionQueue.enqueue(n)}removeLastInput(){}hasNextMatchEntry(){let e=this.selectionQueue.peek();return e?e.correctionQueue.count>0:!1}handleNextNode(){if(!this.hasNextMatchEntry())return{type:"none"};let e=this.selectionQueue.dequeue(),t=e.correctionQueue.dequeue(),r={type:"intermediate",cost:t.currentCost};if(this.processedEdgeSet[t.pathKey])return this.selectionQueue.enqueue(e),r;this.processedEdgeSet[t.pathKey]=!0;let n=!1;if(t.knownCost>2)return r;t.knownCost==2&&(n=!0);let i=0;for(let s=0;s<=e.index;s++)i+=this.minInputCost[s];if(t.currentCost>i+2.5*q.EDIT_DISTANCE_COST_SCALE)return r;if(!n){let s=t.buildInsertionEdges();e.correctionQueue.enqueueAll(s)}if(e.index==this.tierOrdering.length-1)return this.completedPaths.push(t),this.selectionQueue.enqueue(e),{type:"complete",cost:t.currentCost,finalNode:t};{let s=this.tierOrdering[e.index+1],l=s.index,a=[];n||(a=t.buildDeletionEdges(this.inputSequence[l-1]));let u=t.buildSubstitutionEdges(this.inputSequence[l-1]);s.correctionQueue.enqueueAll(a.concat(u)),this.selectionQueue=new k(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering)}return r}getBestMatches(e){return Ct(this,null,function*(){let t={},r=Object.values(this.returnedValues);if(r.length>0){let n=new k(Le,r);for(;n.count>0;){let i=e.time(()=>{let s=n.dequeue();return s.isFullReplacement?null:(t[s.resultKey]=s,new de(s))},0);if(i){let s=e.start(1);yield i,s.end(),e.timeSinceLastDefer>Me&&(yield new be(e.defer()))}}}do{let n=e.time(()=>{var s,l;let i=this.handleNextNode();if(i.type=="none")return null;if(i.type=="complete"){if(i.finalNode.isFullReplacement)return null;let u=i.finalNode;if(((l=(s=t[u.resultKey])==null?void 0:s.currentCost)!=null?l:Number.MAX_VALUE)>u.currentCost)return t[u.resultKey]=u,this.returnedValues[u.resultKey]=u,new de(u)}return null},2);if(n){let i=e.start(1);yield n,i.end()}e.timeSinceLastDefer>Me&&(yield new be(e.defer()))}while(!e.elapsed&&this.hasNextMatchEntry());return null})}};h(q,"SearchSpace"),q.EDIT_DISTANCE_COST_SCALE=5,q.MIN_KEYSTROKE_PROBABILITY=1e-4,q.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL=33;var v=q;var st=class st{static isWhitespace(e){let t=/^[\\u0009\\u000A\\u000D\\u0020\\u00a0\\u1680\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u200b\\u2028\\u2029\\u202f\\u205f\\u3000]+$/i;return e.insert.match(t)!=null}static isBackspace(e){return e.insert==""&&e.deleteLeft>0&&!e.deleteRight}static isEmpty(e){return e.insert==""&&e.deleteLeft==0&&!e.deleteRight}};h(st,"TransformUtils");var w=st;var $t={quotesForKeepSuggestion:{open:"โ",close:"โ"},insertAfterWord:" "};function me(o){let e=$t;if(!o.punctuation)return e;let t=o.punctuation,r=t.insertAfterWord;r!==""&&!r&&(r=e.insertAfterWord);let n=t.quotesForKeepSuggestion;n||(n=e.quotesForKeepSuggestion);let i=t.isRTL;return{insertAfterWord:r,quotesForKeepSuggestion:n,isRTL:i}}h(me,"determinePunctuationFromModel");function B(o){return e=>{if(o.wordbreaker||!o.wordbreak){let t=o.wordbreaker||R;return X(t,e)}else return o.wordbreak(e)}}h(B,"determineModelWordbreaker");function $(o){return e=>o.wordbreaker?se(o.wordbreaker,e):null}h($,"determineModelTokenizer");function It(o,e){var i;let t=o,n=B(o)(e);if(!t.languageUsesCasing)throw"Invalid attempt to detect casing: languageUsesCasing is set to false";if(!t.applyCasing)throw"Invalid LMLayer state:  languageUsesCasing is set to true, but no applyCasing function exists";return e.casingForm=="upper"||e.casingForm=="initial"?e.casingForm:t.applyCasing("lower",n)==n?"lower":t.applyCasing("upper",n)==n?n.kmwLength()>1?"upper":"initial":t.applyCasing("initial",n)==n?"initial":(i=e.casingForm)!=null?i:null}h(It,"detectCurrentCasing");function at(o,e,t){let r=g(t,e),n=o(r).left,i=t.insert,s=[];for(let l=n.length-1;l>=0;l--){let a=n[l],u=a.text.length;if(u<i.length)s.unshift({insert:a.text,deleteLeft:0}),i=i.substring(0,i.length-u);else{s.unshift({insert:i,deleteLeft:t.deleteLeft});break}}return s}h(at,"tokenizeTransform");function Nt(o,e,t){return t.map(r=>({sample:at(o,e,r.sample),p:r.p}))}h(Nt,"tokenizeTransformDistribution");function At(o,e){let t=[];for(let r=0;r<o.kmwLength();r++){let i={insert:o.kmwCharAt(r),deleteLeft:0,id:e};t.push(i)}return t}h(At,"textToCharTransforms");var ct=class ct{};h(ct,"TrackedContextSuggestion");var lt=ct,ht=class ht{constructor(){this.transformDistributions=[];this.activeReplacementId=-1}get currentText(){return this.replacementText===void 0||this.replacementText===null?this.raw:this.replacementText}get replacement(){let e=this.activeReplacementId;return this.replacements.find(function(t){return t.suggestion.id==e})}revert(){delete this.activeReplacementId}updateWithBackspace(e,t){let r=At(e,t).map(function(n){return[{sample:n,p:1}]});this.raw=e,this.transformDistributions=r}update(e,t){t=t||(t===""?"":this.raw),(e==null?void 0:e.length)>0&&this.transformDistributions.push(e),this.raw=t}};h(ht,"TrackedContextToken");var z=ht,Pe=class Pe{constructor(e){this.searchSpace=[];if(e instanceof Pe){let t=e;this.tokens=t.tokens.map(function(n){let i=new z;return i.raw=n.raw,i.replacements=[].concat(n.replacements),i.activeReplacementId=n.activeReplacementId,i.transformDistributions=[].concat(n.transformDistributions),n.replacementText&&(i.replacementText=n.replacementText),i}),this.indexOffset=0;let r=this.model=e.model;this.taggedContext=e.taggedContext,r!=null&&r.traverseFromRoot&&(this.searchSpace=e.searchSpace.map(n=>new v(n)))}else{let t=e;this.tokens=[],this.indexOffset=Number.MIN_SAFE_INTEGER,this.model=t,t&&t.traverseFromRoot&&(this.searchSpace=[new v(t)])}}get head(){return this.tokens[0]}get tail(){return this.tokens[this.tokens.length-1]}popHead(){this.tokens.splice(0,1),this.indexOffset-=1}pushTail(e){this.model&&this.model.traverseFromRoot?this.searchSpace=[new v(this.model)]:this.searchSpace=[],this.tokens.push(e);let t=this;t.searchSpace.length>0&&e.transformDistributions.forEach(r=>t.searchSpace[0].addInput(r))}toRawTokenization(){let e=[];for(let t of this.tokens)t.currentText!==null&&e.push(t.currentText);return e}};h(Pe,"TrackedContextState");var V=Pe,fe=class fe{constructor(e=fe.DEFAULT_ARRAY_SIZE){this.currentHead=0;this.currentTail=0;this.circle=Array(e)}get count(){let e=this.currentHead-this.currentTail;return e<0&&(e=e+this.circle.length),e}get maxCount(){return this.circle.length}get oldest(){if(this.count!=0)return this.item(0)}get newest(){if(this.count!=0)return this.item(this.count-1)}enqueue(e){var t=null;let r=(this.currentHead+1)%this.maxCount;return r==this.currentTail&&(t=this.circle[this.currentTail],this.currentTail=(this.currentTail+1)%this.maxCount),this.circle[this.currentHead]=e,this.currentHead=r,t}dequeue(){if(this.currentTail==this.currentHead)return null;{let e=this.circle[this.currentTail];return this.currentTail=(this.currentTail+1)%this.maxCount,e}}popNewest(){if(this.currentTail==this.currentHead)return null;{let e=this.circle[this.currentHead];return this.currentHead=(this.currentHead-1+this.maxCount)%this.maxCount,e}}item(e){if(e>=this.count)return;let t=(this.currentTail+e)%this.maxCount;return this.circle[t]}};h(fe,"CircularArray"),fe.DEFAULT_ARRAY_SIZE=5;var ut=fe,ge=class ge extends ut{static attemptMatchContext(e,t,r){var C,x;let n=t.toRawTokenization(),s=K.computeDistance(n.map(m=>({key:m})),e.map(m=>({key:m.text})),3).editPath();s.length==2&&s[0]=="insert"&&s[1]=="substitute"&&(s[0]="substitute",s[1]="insert");let l=s.indexOf("match"),a=s.lastIndexOf("match");if(s.length>=2&&s[s.length-2]=="substitute"&&s[s.length-1]=="match"&&(a=s.lastIndexOf("match",s.length-2)),l){for(let m=l+1;m<a;m++)if(s[m]!="match")return null}if(l==0&&a==s.length-1)return{state:t,baseState:t};let u=t,c,p=0;for(let m=0;m<l;m++)switch(s[m]){case"delete":if(c&&c!="delete")return null;u==t&&(u=new V(u)),u.popHead(),p++;break;case"substitute":break;default:return null}let f=r&&Array.isArray(r);c=void 0;let d;for(let m=a+1;m<s.length;m++){let b=m==s.length-1;if(!f)return null;let y=m-(a+1),L=r.map(G=>({sample:G.sample[y],p:G.p})),M=f?(C=L[0])==null?void 0:C.sample:null;M&&M.insert==""&&M.deleteLeft==0&&!M.deleteRight&&(M=null),b||(d=d?U(d,M):M);let qt=M&&w.isBackspace(M),te=e[m-p];switch(s[m]){case"substitute":b&&(u=new V(u));let G=u.tokens[m-p],S=t.tokens[m];qt?(G.updateWithBackspace(te.text,M.id),b&&(u.tokens.pop(),u.pushTail(G))):(G.update(L,te.text),b&&((x=u.searchSpace[0])==null||x.addInput(L))),u!=t&&!b&&(S.replacementText=te.text);break;case"insert":if(c&&c!="substitute"&&c!="match"&&c!="insert")return null;d||(d={insert:"",deleteLeft:0}),u==t&&(u=new V(u));let E=new z;E.raw=te.text,M&&(E.transformDistributions=L?[L]:[]),E.isWhitespace=te.isWhitespace,u.pushTail(E);break;case"match":if(c=="substitute"&&e[e.length-1].text=="")continue;default:return null}c=s[m]}return{state:u,baseState:t,preservationTransform:d}}static modelContextState(e,t){let r=e.map(function(i){let s=new z;return s.raw=i.text,i.isWhitespace&&(s.isWhitespace=!0),s.raw?s.transformDistributions=At(s.raw).map(function(l){return[{sample:l,p:1}]}):s.transformDistributions=[],s}),n=new V(t);for(;r.length>0;)r.length==1&&r[0].updateWithBackspace(r[0].raw,null),n.pushTail(r.splice(0,1)[0]);if(n.tokens.length==0){let i=new z;i.raw="",n.pushTail(i)}return n}analyzeState(e,t,r){if(!e.traverseFromRoot)throw"This lexical model does not provide adequate data for correction algorithms and context reuse";let n=$(e),i=r==null?void 0:r[0],s=0,l=null;i&&(s=at(n,t,i.sample).length,l=Nt(n,t,r),t=g(i.sample,t),l=l.filter(c=>c.sample.length==s));let a=n(t);if(a.left.length>0)for(let c=this.count-1;c>=0;c--){let p=this.item(c),f=p.taggedContext;if(f&&r&&r.length>0){if(g(r[0].sample,f).left!=t.left)continue}else if((f==null?void 0:f.left)!=t.left)continue;let d=ge.attemptMatchContext(a.left,this.item(c),l);if(d!=null&&d.state)return this.newest!=d.state&&this.newest!=p&&this.enqueue(p),d.state.taggedContext=t,d.state!=this.item(c)&&this.enqueue(d.state),d}let u=ge.modelContextState(a.left,e);return u.taggedContext=t,this.enqueue(u),{state:u,baseState:null}}clearCache(){for(;this.count>0;)this.dequeue()}};h(ge,"ContextTracker");var Te=ge;var Zt=.66,Ot={MAX_SEARCH_THRESHOLD:8,REPLACEMENT_SEARCH_THRESHOLD:4};function pt(o,e){let t=e.matchLevel-o.matchLevel;return t!=0?t:e.totalProb-o.totalProb}h(pt,"tupleDisplayOrderSort");function _t(o,e,t,r,n){return D(this,null,function*(){let i=B(e),s=r[0].sample,l=g(s,n),a=[];if(!o){let S,E=w.isWhitespace(s),Ae=w.isBackspace(s);return E?S=[{sample:s,p:1}]:S=r.map(P=>{let Se=P.sample;return w.isWhitespace(Se)&&!E||w.isBackspace(Se)&&!Ae?null:P}),S=S.filter(P=>!!P),a=Rt(e,S,n),E&&a.forEach(P=>P.preservationTransform=s),{postContextState:null,rawPredictions:a}}let{state:u}=o.analyzeState(e,n,null),c=o.analyzeState(e,n,w.isEmpty(s)?null:r),p=c.state,f=p.searchSpace[0],d=0,C=p.tokens,x=C.length-u.tokens.length;c.preservationTransform?(d=0,n=g(c.preservationTransform,n)):x<0?d=i(l).kmwLength()+s.deleteLeft:d=i(n).kmwLength();let m=C[C.length-1];m.raw==""&&(d=0);let b=m.transformDistributions.length<=1,y,L={};try{for(var M=St(f.getBestMatches(t)),qt,te,G;qt=!(te=yield M.next()).done;qt=!1){let S=te.value;let E=S.matchString;if(S.matchSequence.length==0&&S.inputSequence.length!=0||S.matchSequence.length!=0&&S.matchSequence.length==S.knownCost)continue;let Ae={insert:E,deleteLeft:d,id:s.id},P=S.totalCost;b&&(P*=Z.SINGLE_CHAR_KEY_PROB_EXPONENT);let Se={sample:Ae,p:Math.exp(-P)},xe=Rt(e,[Se],n);xe.forEach(re=>re.preservationTransform=c.preservationTransform),xe.length>0&&y===void 0&&(y=P);let mt=L[S.matchString];if(mt&&(a=a.filter(re=>!mt.find(Bt=>re.prediction.sample==Bt.sample))),L[S.matchString]=xe.map(re=>re.prediction),a=a.concat(xe),Jt(y,S.totalCost,a))break}}catch(te){G=[te]}finally{try{qt&&(te=M.return)&&(yield te.call(M))}finally{if(G)throw G[0]}}return{postContextState:p,rawPredictions:a}})}h(_t,"correctAndEnumerate");function Jt(o,e,t){if(e>=o+Ot.MAX_SEARCH_THRESHOLD)return!0;if(t.length>=Z.MAX_SUGGESTIONS){if(e>=o+Ot.REPLACEMENT_SEARCH_THRESHOLD)return!0;if(t.sort(pt),t[Z.MAX_SUGGESTIONS-1].totalProb>Math.exp(-e))return!0}return!1}h(Jt,"shouldStopSearchingEarly");function Rt(o,e,t){let r=[],n=B(o);for(let i of e){let s=o.predict(i.sample,t),{sample:l,p:a}=i,u=n(g(i.sample,t)),c=s.map(p=>(l.id!==void 0&&(p.sample.transformId=l.id),{prediction:p,correction:{sample:u,p:a},totalProb:p.p*a,matchLevel:0}));r=r.concat(c)}return r}h(Rt,"predictFromCorrections");function Dt(o,e,t){let r=B(o),n={},i=[];for(let s of e){let l=r(g(s.prediction.sample.transform,t)),a=n[l];a?a.totalProb+=s.totalProb:n[l]=s}for(let s in n){let l=n[s];i.push(l)}return i}h(Dt,"dedupeSuggestions");function Ut(o,e,t,r){let{sample:n,p:i}=r,s=B(o),l=g(n,t),a=s(l),u=h(m=>o.toKey?o.toKey(m):m,"keyed"),c=h(m=>o.applyCasing?o.applyCasing("lower",m):m,"keyCased"),p=u(a),f=c(a),d;for(let m of e){n.id!==void 0&&(m.prediction.sample.transformId=n.id);let b=s(g(m.prediction.sample.transform,t));u(m.correction.sample)==p?b==a?(m.matchLevel=3,d=Ie(o,m.prediction.sample,"keep",j.noQuotes),d.matchesModel=!0,Object.assign(m.prediction.sample,d),d=m.prediction.sample):c(b)==f?m.matchLevel=2:u(b)==p?m.matchLevel=1:m.matchLevel=0:m.matchLevel=0}if(d||a=="")return;let C=A({},n),x=W(C,1);x.displayAs=a,d=Ie(o,x,"keep"),n.id!==void 0&&(d.transformId=n.id),d.matchesModel=!1,e.unshift({totalProb:d.p,prediction:{sample:d,p:d.p},correction:{sample:a,p:i},matchLevel:3})}h(Ut,"processSimilarity");function Ft(o){if(o.length==0)return;let e=o[0].prediction.sample;if(e.tag=="keep"&&e.matchesModel){e.autoAccept=!0;return}else if(o.length==1)return;if(o=o.slice(1),o.length==1){o[0].prediction.sample.autoAccept=!0;return}let t=o[0];if(t.correction.sample.length==0||o.reduce((a,u)=>(a==null?void 0:a.correction.p)>u.correction.p?a:u,null).correction.p>t.correction.p)return;let i=t.matchLevel,s=o.reduce((a,u)=>a+(u.matchLevel==i?u.totalProb:0),0);t.totalProb/s<Zt||(t.prediction.sample.autoAccept=!0)}h(Ft,"predictionAutoSelect");function Wt(o,e,t,r,n){let i=me(o),s=$(o),l=e.map(a=>{let u=a.prediction;if(a.preservationTransform){let c=U(a.preservationTransform,u.sample.transform);c.id=u.sample.transformId;let p=u.sample;p.transform=c}return n?Re(A({},u.sample),{p:a.totalProb,"lexical-p":u.p,"correction-p":a.correction.p}):Re(A({},u.sample),{p:a.totalProb})});return l.forEach(a=>{let u=s(t);u&&u.caretSplitsToken?a.transform.insert+=i.insertAfterWord:t.right?i.insertAfterWord!=""&&t.right.indexOf(i.insertAfterWord)!=0&&(a.transform.insert+=i.insertAfterWord):a.transform.insert+=i.insertAfterWord}),l}h(Wt,"finalizeSuggestions");function Ie(o,e,t,r=j.default){let n=j,i=me(o),s=n.noQuotes;(t=="keep"||t=="revert")&&(s=n.useQuotes);let l={transform:e.transform,displayAs:n.apply(r,e.displayAs,i,s),tag:t,p:e.p};return e.transformId!==void 0&&(l.transformId=e.transformId),l}h(Ie,"toAnnotatedSuggestion");var J=class J{constructor(e,t){this.SUGGESTION_ID_SEED=0;this.testMode=!1;this.verbose=!0;this.lexicalModel=e,e.traverseFromRoot&&(this.contextTracker=new Te),this.punctuation=me(e),this.testMode=!!t}predict(e,t){return D(this,null,function*(){var b;let r=this.lexicalModel;(b=this.activeTimer)==null||b.terminate(),e instanceof Array?e.length==0&&e.push({sample:{insert:"",deleteLeft:0},p:1}):e=[{sample:e,p:1}],e.sort(function(y,L){return L.p-y.p});let n=e[0].sample,i=w.isBackspace(n),s=w.isWhitespace(n),l=g(n,t),a=this.wordbreak(l),u=i||s?a:this.wordbreak(t),c=r.languageUsesCasing?It(r,l):null,p=v.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL,f=this.activeTimer=new he(this.testMode?Number.MAX_VALUE:p,this.testMode?Number.MAX_VALUE:p*1.5),{postContextState:d,rawPredictions:C}=yield _t(this.contextTracker,this.lexicalModel,f,e,t);this.activeTimer==f&&(this.activeTimer=null);for(let y of C)c&&c!="lower"&&this.applySuggestionCasing(y.prediction.sample,u,c);let x=Dt(this.lexicalModel,C,t);Ut(this.lexicalModel,x,t,e[0]),x.sort(pt),Ft(x);let m=Wt(this.lexicalModel,x.splice(0,J.MAX_SUGGESTIONS),t,n,this.verbose);return m.forEach(y=>{y.id=this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++}),d&&(d.tail.replacements=m.map(function(y){return{suggestion:y,tokenWidth:1}})),m})}applySuggestionCasing(e,t,r){let n=t.kmwLength()-e.transform.deleteLeft;n>0&&(e.transform.deleteLeft+=n,e.transform.insert=t.kmwSubstr(0,n)+e.transform.insert),e.transform.insert=this.lexicalModel.applyCasing(r,e.transform.insert),e.displayAs=this.lexicalModel.applyCasing(r,e.displayAs)}acceptSuggestion(e,t,r){let n=e.transform,i=t.left.kmwSubstr(-n.deleteLeft,n.deleteLeft),s=n.insert.kmwLength(),l={insert:i,deleteLeft:s},a=t;r&&(l=U(l,r),a=g(r,a));let u,c=this.tokenize(a);if(c){let d=c.left[c.left.length-1];u=d&&!d.isWhitespace?d.text:"",u+=c.caretSplitsToken?c.right[0].text:""}else u=this.wordbreak(a);let p=W(l);p.displayAs=u;let f=Ie(this.lexicalModel,p,"revert");if(e.transformId!=null&&(f.transformId=-e.transformId),e.id!=null?f.id=-e.id:(f.id=-this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++),this.contextTracker){let d=this.contextTracker.newest;d||(d=this.contextTracker.analyzeState(this.lexicalModel,t).state),d.tail.activeReplacementId=e.id;let C=g(e.transform,t);this.contextTracker.analyzeState(this.lexicalModel,C)}return f}applyReversion(e,t){return D(this,null,function*(){let r=this,n=h(function(){return D(this,null,function*(){let l=g(e.transform,t),a=yield r.predict({insert:"",deleteLeft:0},l);return a.forEach(function(u){u.transformId=-e.transformId,u.autoAccept=!1}),a})},"fallbackSuggestions");if(!this.contextTracker)return n();let i=!1;for(let l=this.contextTracker.count-1;l>=0;l--)if(this.contextTracker.item(l).tail.activeReplacementId==-e.id){i=!0;break}if(!i)return n();for(;this.contextTracker.newest.tail.activeReplacementId!=-e.id;)this.contextTracker.popNewest();this.contextTracker.newest.tail.revert();let s=this.contextTracker.newest.tail.replacements.map(function(l){return l.suggestion});return s.forEach(function(l){l.transformId=-e.transformId,l.autoAccept=!1}),s})}wordbreak(e){return B(this.lexicalModel)(e)}tokenize(e){return $(this.lexicalModel)(e)}resetContext(e){var t;(t=this.activeTimer)==null||t.terminate(),this.contextTracker&&(this.contextTracker.clearCache(),this.contextTracker.analyzeState(this.lexicalModel,e,null))}};h(J,"ModelCompositor"),J.MAX_SUGGESTIONS=12,J.SINGLE_CHAR_KEY_PROB_EXPONENT=16;var dt=J,Z=dt;O();var Ne=class Ne{constructor(e={importScripts:null,postMessage:null}){this._testMode=!1;this._postMessage=e.postMessage||postMessage,this._importScripts=e.importScripts||importScripts,this.setupConfigState()}error(e,t){this.cast("error",{log:e,error:t&&t.stack?t.stack:void 0})}onMessage(e){let{message:t}=e.data;if(!t)throw new Error(\`Missing required 'message' property: \${e.data}\`);let r=e.data;if(r.message=="load"){let n=r,i=!1;if(this._currentModelSource&&n.source.type==this._currentModelSource.type&&(n.source.type=="file"&&n.source.file==this._currentModelSource.file||n.source.type=="raw"&&n.source.code==this._currentModelSource.code)&&(i=!0),i){typeof console!="undefined"&&console.warn("Duplicate model load message detected - squashing!");return}else this._currentModelSource=n.source}else r.message=="unload"&&(this._currentModelSource=null);this.state.handleMessage(r)}cast(e,t){let r=this._postMessage;r(A({message:e},t))}loadModel(e){try{let t=e.configure(this._platformCapabilities);t.leftContextCodePoints||(t.leftContextCodePoints=t.leftContextCodeUnits),t.rightContextCodePoints||(t.rightContextCodePoints=t.rightContextCodeUnits),t.leftContextCodePoints||(t.leftContextCodePoints=this._platformCapabilities.maxLeftContextCodePoints),t.rightContextCodePoints||(t.rightContextCodePoints=this._platformCapabilities.maxRightContextCodePoints||0),e.languageUsesCasing&&!e.applyCasing&&(e.applyCasing=we);let r=this.transitionToReadyState(e);t.wordbreaksAfterSuggestions===void 0&&(t.wordbreaksAfterSuggestions=r.punctuation.insertAfterWord!=""),this.cast("ready",{configuration:t})}catch(t){this.error("loadModel failed!",t)}}loadModelFile(e){try{this._importScripts(e)}catch(t){this.error("Error occurred when attempting to load dictionary",t)}}unloadModel(){this.transitionToLoadingState()}setupConfigState(){this.state={name:"unconfigured",handleMessage:e=>{if(e.message!=="config")throw new Error(\`invalid message; expected 'config' but got \${e.message}\`);this._platformCapabilities=e.capabilities,this._testMode=!!e.testMode,this.transitionToLoadingState()}}}transitionToLoadingState(){let e=this;this.state={name:"modelless",handleMessage:t=>{if(t.message!=="load")throw new Error(\`invalid message; expected 'load' but got \${t.message}\`);if(t.source.type=="file")e.loadModelFile(t.source.file);else{let r=t.source.code;new Function("LMLayerWorker","models","correction","wordBreakers",r)(e,ve,Ce,le)}}}}transitionToReadyState(e){let t=new Z(e,this._testMode);return this.state={name:"ready",handleMessage:r=>{switch(r.message){case"predict":var{transform:n,context:a}=r;t.predict(n,a).then(c=>{this.cast("suggestions",{token:r.token,suggestions:c})});break;case"wordbreak":let u=X(e.wordbreaker||R,r.context);this.cast("currentword",{token:r.token,word:u});break;case"unload":this.unloadModel();break;case"accept":var{suggestion:i,context:a,postTransform:s}=r,l=t.acceptSuggestion(i,a,s);this.cast("postaccept",{token:r.token,reversion:l});break;case"revert":var{reversion:l,context:a}=r;t.applyReversion(l,a).then(c=>{this.cast("postrevert",{token:r.token,suggestions:c})});break;case"reset-context":var{context:a}=r;t.resetContext(a);break;default:throw new Error(\`invalid message; expected one of {'predict', 'wordbreak', 'accept', 'revert', 'reset-context', 'unload'} but got \${r.message}\`)}},compositor:t},t}static install(e){let t=new Ne({postMessage:e.postMessage,importScripts:e.importScripts.bind(e)});return e.onmessage=t.onMessage.bind(t),t.self=e,e.LMLayerWorker=t,e.models=ve,e.correction=Ce,e.wordBreakers=le,t}};h(Ne,"LMLayerWorker");var ee=Ne;typeof self!="undefined"&&"postMessage"in self&&"importScripts"in self?ee.install(self):window.LMLayerWorker=ee;})();
//# sourceMappingURL=worker-main.min.js.map
`,Zo="";var rr=class rr{static constructInstance(){return new Worker(this.asBlobURI(xo))}static asBlobURI(t){let e=ss(t);e+=`
`+Zo;let n=new Blob([e],{type:"text/javascript"});return URL.createObjectURL(n)}};o(rr,"DefaultWorker");var nn=rr;var cr=class cr extends S.default{constructor(e,n,i=!1){super();this._mayPredict=!0;this._mayCorrect=!0;this._state="inactive";this.recentTranscriptions=n;let s={maxLeftContextCodePoints:64,maxRightContextCodePoints:i?0:64};e&&(this.lmEngine=new tn(s,e))}get activeModel(){return this.currentModel}get isConfigured(){return!!this.configuration}get state(){return this._state}unloadModel(){this.lmEngine.unloadModel(),delete this.currentModel,delete this.configuration,this._state="inactive",this.emit("statechange","inactive")}loadModel(e){if(!e)throw new Error("Null reference not allowed.");let n=e.path?"file":"raw",i=n=="file"?e.path:e.code;return this.currentModel=e,this.mayPredict&&(this._state="active",this.emit("statechange","active")),this.lmEngine.loadModel(i,n).then(s=>{this.configuration=s,this.mayPredict&&(this._state="configured",this.emit("statechange","configured"))}).catch(s=>{let l;s instanceof Error?l=s.message:l=String(s),console.error("Could not load model '"+e.id+"': "+l),this.currentModel=null,this._state="inactive",this.emit("statechange","inactive")})}invalidateContext(e,n){if(this.emit("invalidatesuggestions","context"),!this.currentModel||!this.configuration)return Promise.resolve([]);if(this.isActive)if(e){let i=e.buildTranscriptionFrom(e,null,!1);return this.predict_internal(i,!0,n)}else return Promise.resolve([]);else return Promise.resolve([])}wordbreak(e,n){if(!this.isActive)return null;let i=new Ue(k.from(e,!1),this.configuration,n);return this.lmEngine.wordbreak(i)}predict(e,n){return!this.isActive||!this.currentModel||!this.configuration?null:(this.emit("invalidatesuggestions","new"),this.predict_internal(e,!1,n))}applySuggestion(e,n,i){if(!n)throw"Accepting suggestions requires a destination OutputTarget instance.";if(!this.isConfigured)return console.warn("Could not apply suggestion; the corresponding model has been unloaded"),null;let s=this.getPredictionState(e.transformId);if(s){let l=k.from(s.preInput,!1);l.apply(e.transform);let r=l.buildTransformFrom(n);n.apply(r),this.emit("suggestionapplied",n),k.from(s.preInput,!1).apply(s.transform);let g=new Ue(s.preInput,this.configuration,i()),d=this.lmEngine.acceptSuggestion(e,g,s.transform);return d=d.then(u=>{let I={transform:s.transform,transformId:-s.token,displayAs:u.displayAs,id:u.id,tag:u.tag};return this.predictFromTarget(n,i()),I}),d}else return console.warn("Could not apply the Suggestion!"),null}applyReversion(e,n){if(!n)throw"Accepting suggestions requires a destination OutputTarget instance.";let i=this.getPredictionState(-e.transformId);if(!i)return console.warn("Could not apply the Suggestion!"),Promise.resolve([]);let s=k.from(i.preInput,!1);s.apply(e.transform);let l=s.buildTransformFrom(n);n.apply(l);let r=this.currentPromise=this.lmEngine.revertSuggestion(e,new Ue(i.preInput,this.configuration,null));return r.then(()=>this.currentPromise=this.currentPromise==r?null:this.currentPromise),r}predictFromTarget(e,n){if(!e)return null;let i=e.buildTranscriptionFrom(e,null,!1);return this.predict(i,n)}predict_internal(e,n,i){if(!e)return null;let s=new Ue(e.preInput,this.configuration,i);this.recordTranscription(e),n&&this.lmEngine.resetContext(s);let l=e.alternates;(!l||l.length==0)&&(l=[{sample:e.transform,p:1}]);let r=e.transform;var c=this.currentPromise=this.lmEngine.predict(l,s);return c.then(g=>{if(c==this.currentPromise){let d=new Ct(g,r.id);this.emit("suggestionsready",d),this.currentPromise=null}return g})}recordTranscription(e){this.recentTranscriptions.save(e)}getPredictionState(e){return this.recentTranscriptions.get(e)}shutdown(){this.lmEngine.shutdown(),this.removeAllListeners()}get isActive(){return this.canEnable()?(this.activeModel||!1)&&this._mayPredict:(this._mayPredict=!1,!1)}canEnable(){return!!this.lmEngine}get mayPredict(){return this._mayPredict}set mayPredict(e){if(!this.canEnable())return;let n=this._mayPredict;if(this._mayPredict=e,n!=e&&this.activeModel){let i=e?"active":"inactive";this._state=i,this.emit("statechange",i),e&&this.isConfigured&&(this._state="configured",this.emit("statechange","configured"))}}get mayCorrect(){return this._mayCorrect}set mayCorrect(e){this._mayCorrect=e}get wordbreaksAfterSuggestions(){return this.configuration.wordbreaksAfterSuggestions}tryAcceptSuggestion(e){var i;let n={shouldSwallow:!1};return this.emit("tryaccept",e,n),(i=n.shouldSwallow)!=null?i:!1}tryRevertSuggestion(){return this.emit("tryrevert"),!1}};o(cr,"LanguageProcessor");var Dn=cr;var Sa=10,or=class or{constructor(){this.map=new Map}get(t){let e=this.map.get(t);return e&&this.save(e),e}save(t){let e=t.token>=0?t.token:-t.token;this.map.delete(e),this.map.set(e,t),this.map.size>Sa&&this.map.delete(this.map.keys().next().value)}};o(or,"TranscriptionCache");var On=or;var Pn=class Pn{constructor(t,e,n){this.contextCache=new On;if(!t)throw new Error("device must be defined");n||(n=Pn.DEFAULT_OPTIONS),this.contextDevice=t,this.kbdProcessor=new jt(t,n),this.lngProcessor=new Dn(e,this.contextCache)}get languageProcessor(){return this.lngProcessor}get keyboardProcessor(){return this.kbdProcessor}get keyboardInterface(){return this.keyboardProcessor.keyboardInterface}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(t){this.keyboardInterface.activeKeyboard=t,this.resetContext()}get activeModel(){return this.languageProcessor.activeModel}processKeyEvent(t,e){let n=t.srcKeyboard&&this.activeKeyboard!=t.srcKeyboard,i=this.activeKeyboard;try{if(n&&(this.keyboardInterface.activeKeyboard=t.srcKeyboard),t.baseTranscriptionToken){let s=this.contextCache.get(t.baseTranscriptionToken);s?(!xt(s.transform)||!s.preInput.isEqual(k.from(e)))&&e.restoreTo(s.preInput):console.warn("The base context for the multitap could not be found")}return this._processKeyEvent(t,e)}finally{n&&(this.keyboardInterface.activeKeyboard=i)}}_processKeyEvent(t,e){var I;let n=t.device.formFactor,i=t.isSynthetic;if((n==V.FormFactor.Desktop||!this.activeKeyboard||this.activeKeyboard.usesDesktopLayoutOnDevice(t.device))&&i&&this.keyboardProcessor.selectLayer(t))return new ie;if(this.keyboardProcessor.doModifierPress(t,e,!i)&&!i)return new ie;if(this.languageProcessor.isActive){if((t.kName=="K_BKSP"||t.Lcode==C.keyCodes.K_BKSP)&&this.languageProcessor.tryRevertSuggestion())return new ie;if((t.kName=="K_SPACE"||t.Lcode==C.keyCodes.K_SPACE)&&this.languageProcessor.tryAcceptSuggestion("space"))return new ie}let s=k.from(e,!0),l=this.keyboardProcessor.layerId,r=this.keyboardProcessor.processKeystroke(t,e);t.kNextLayer&&this.keyboardProcessor.selectLayer(t);let c=C.isFrameKey(t.kName);xt((I=r==null?void 0:r.transcription)==null?void 0:I.transform)&&t.kNextLayer&&(c=!0);let g=r!=null;if(g){let B=c?null:this.buildAlternates(r,t,s);r.finalize(this.keyboardProcessor,e,!1),B&&B.length>0&&(r.transcription.alternates=B)}else r=new ie,r.transcription=e.buildTranscriptionFrom(e,null,!1),r.triggersDefaultCommand=!0;this.contextCache.save(r.transcription);let d=r.setStore[33]||t.kNextLayer;this.keyboardProcessor.newLayerStore.set(d?this.keyboardProcessor.layerId:""),this.keyboardProcessor.oldLayerStore.set(d?l:"");let u=this.keyboardProcessor.processPostKeystroke(this.contextDevice,e);return u&&u.finalize(this.keyboardProcessor,e,!0),r.predictionPromise=this.languageProcessor.predict(r.transcription,this.keyboardProcessor.layerId),r.triggersDefaultCommand||e.doInputEvent(),g?r:null}buildAlternates(t,e,n){let i;if(this.languageProcessor.isActive&&!t.triggersDefaultCommand){let s=e.keyDistribution,r=new Ue(n,Ue.ENGINE_RULE_WINDOW,this.keyboardProcessor.layerId).toMock();if(this.languageProcessor.isActive&&s&&e.kbdLayer){let c=Number.MAX_VALUE,g=Et(),d;g.performance&&g.performance.now&&(d=o(function(){return g.performance.now()},"timer"),c=d()+16);let u=Math.exp(-5);s.sort((B,h)=>h.p-B.p),i=[];let I=0;for(let B of s){if(B.p<u){I+=B.p;break}else if(d&&d()>=c)break;let h=k.from(r,!1),b=B.keySpec;if(!b){console.warn("Internal error:  failed to properly filter set of keys for corrections");continue}let F=this.keyboardProcessor.activeKeyboard.constructKeyEvent(b,e.device,this.keyboardProcessor.stateKeys),G=this.keyboardProcessor.processKeystroke(F,h);if(G&&!G.beep&&B.p>0){let U=G.transcription.transform;U.id=t.transcription.token,i.push({sample:U,p:B.p}),I+=B.p}}i.forEach(function(B){B.p/=I})}}return i}resetContext(t){this.keyboardProcessor.resetContext(t),this.languageProcessor.invalidateContext(t,this.keyboardProcessor.layerId)}};o(Pn,"InputProcessor"),Pn.DEFAULT_OPTIONS={baseLayout:"us"};var jn=Pn;var ar=class ar{constructor(t,e,n,i){this.Pelem=t,this.Peventname=e.toLowerCase(),this.Phandler=n,this.PuseCapture=i}equals(t){return this.Pelem==t.Pelem&&this.Peventname==t.Peventname&&this.Phandler==t.Phandler&&this.PuseCapture==t.PuseCapture}};o(ar,"DomEventTracking");var ls=ar,gr=class gr{constructor(){this.domEvents=[]}attachDOMEvent(t,e,n,i){this.detachDOMEvent(t,e,n,i),t.addEventListener(e,n,!!i);var s=new ls(t,e,n,i);this.domEvents.push(s)}detachDOMEvent(t,e,n,i){t.removeEventListener(e,n,i);for(var s=new ls(t,e,n,i),l=0;l<this.domEvents.length;l++)if(this.domEvents[l].equals(s)){this.domEvents.splice(l,1);break}}shutdown(){for(let t of this.domEvents)this.detachDOMEvent(t.Pelem,t.Peventname,t.Phandler,t.PuseCapture)}};o(gr,"DomEventTracker");var xe=gr;var dr=class dr extends S.default{constructor(t){super(),t instanceof S.default?(t.on=this.listenerRegistrationSpy("listeneradded",t,t.on),t.addListener=this.listenerRegistrationSpy("listeneradded",t,t.addListener),t.off=this.listenerRegistrationSpy("listenerremoved",t,t.off),t.removeListener=this.listenerRegistrationSpy("listenerremoved",t,t.off)):(t.addEventListener=this.listenerRegistrationSpy("listeneradded",t,t.addEventListener),t.removeEventListener=this.listenerRegistrationSpy("listenerremoved",t,t.removeEventListener))}listenerRegistrationSpy(t,e,n){return(i,s)=>{let l=n.apply(e,[i,s]);return this.emit(t,i),l}}};o(dr,"EmitterListenerSpy");var sn=dr;var ur=class ur{constructor(){this.events={};this.currentEvents=[]}addEventListener(t,e){return this._removeEventListener(t,e),this.events[t].push(e),!0}removeEventListener(t,e){return this._removeEventListener(t,e)}_removeEventListener(t,e){typeof this.events[t]=="undefined"&&(this.events[t]=[]);for(var n=0;n<this.events[t].length;n++)if(this.events[t][n]==e)return this.events[t].splice(n,1),!0;return!1}callEvent(t,e){if(typeof this.events[t]=="undefined")return!0;if(this.currentEvents.indexOf(t)!=-1)return!1;this.currentEvents.push(t);for(var n=0;n<this.events[t].length;n++){var i=this.events[t][n],s=!1;try{s=i(e)}catch(l){console.error(l),s=!1}if(s===!1)return this.currentEvents.pop(),!1}return this.currentEvents.pop(),!0}listenerCount(t){let e=this.events[t];return e?e.length:0}shutdown(){this.events={}}};o(ur,"LegacyEventEmitter");var ln=ur;var Br=class Br{constructor(t=!1){this.fileLocal=t}request(t){let e=new f,n=window.setTimeout(()=>{e.reject(new Error(Co))},1e4),i="&timerid="+n,s=t+i,l=document.createElement("script");l.onload=r=>{window.clearTimeout(n),e.isResolved||e.reject(new Error(Go))},l.onerror=(r,c,g,d,u)=>{window.clearTimeout(n);let I=zl;u&&(I=I+": "+u.message),e.reject(new Error(I))},this.fileLocal?l.src=t:l.src=s;try{document.body.appendChild(l)}catch(r){document.getElementsByTagName("head")[0].appendChild(l)}return e.finally(()=>{clearTimeout(n)}),{promise:e,queryId:n}}};o(Br,"DOMCloudRequester");var _n=Br;function Va(){return typeof window.KeymanWeb_BaseLayout!="undefined"?window.KeymanWeb_BaseLayout:"us"}o(Va,"determineBaseLayout");var Ir=class Ir{constructor(t,e,n,i){this.legacyAPIEvents=new ln;this.keyEventListener=o((t,e)=>{var s;let n=this.contextManager.activeTarget;if(!this.contextManager.activeKeyboard||!n){e&&e(null,null);return}if(this.core.languageProcessor.mayCorrect||(t.keyDistribution=[]),this.keyEventRefocus&&this.keyEventRefocus(),n.invalidateSelection(),n.deadkeys().deleteMatched(),t.isSynthetic){let l=this.osk.vkbd.layerId;l&&l!=this.core.keyboardProcessor.layerId&&(this.core.keyboardProcessor.layerId=l)}let i=this.core.processKeyEvent(t,n);i&&((s=i.transcription)!=null&&s.transform)&&this.config.onRuleFinalization(i,this.contextManager.activeTarget),e&&e(i,null)},"keyEventListener");this.config=e,this.contextManager=n;let s=i(this);s.baseLayout=Va(),this.interface=s.keyboardInterface,this.core=new jn(e.hostDevice,t,s),this.core.languageProcessor.on("statechange",l=>{var r,c;(r=this.osk)==null||r.bannerController.selectBanner(l),(c=this.osk)==null||c.refreshLayout()}),this.core.keyboardProcessor.on("statekeychange",l=>{var r,c;(c=(r=this.osk)==null?void 0:r.vkbd)==null||c.updateStateKeys(l)}),this.contextManager.on("beforekeyboardchange",l=>{this.legacyAPIEvents.callEvent("beforekeyboardchange",{internalName:l==null?void 0:l.id,languageCode:l==null?void 0:l.langId})}),this.contextManager.on("keyboardchange",l=>{l||this.osk.startHide(!1);let r=o(()=>{var c,g;this.refreshModel(),this.core.activeKeyboard=l==null?void 0:l.keyboard,this.legacyAPIEvents.callEvent("keyboardchange",{internalName:(c=l==null?void 0:l.metadata.id)!=null?c:"",languageCode:(g=l==null?void 0:l.metadata.langId)!=null?g:""})},"prepareKeyboardSwap");this.osk?this.osk.batchLayoutAfter(()=>{r(),this.osk.activeKeyboard=l,this.contextManager.resetContext(),this.osk.present()}):(r(),this.contextManager.resetContext())}),this.contextManager.on("keyboardasyncload",l=>{var r,c;this.config.hostDevice.touchable&&((r=this.osk)!=null&&r.activationModel)&&(this.osk.activationModel.enabled=!0),(c=this.osk)==null||c.startHide(!1)})}init(t){return W(this,null,function*(){let e=this.config;if(e.deferForInitialization.isResolved)return Promise.resolve();e.initialize(t),String.kmwEnableSupplementaryPlane(!0);let n=new ns(this.interface,e.applyCacheBusting);this.keyboardRequisitioner=new $t(n,new _n,this.config.paths),this.modelCache=new en;let i=this.keyboardRequisitioner.cache,s=this.core.keyboardProcessor,l=new Gt(this.core.languageProcessor,()=>s.layerId);this.contextManager.configure({resetContext:r=>{this.osk?this.osk.batchLayoutAfter(()=>{this.core.resetContext(r)}):this.core.resetContext(r)},predictionContext:l,keyboardCache:this.keyboardRequisitioner.cache}),this.core.languageProcessor.on("suggestionapplied",()=>{var r;s.newLayerStore.set(""),s.oldLayerStore.set(""),(r=s.processPostKeystroke(s.contextDevice,l.currentTarget))==null||r.finalize(s,l.currentTarget,!0)}),this.config.on("spacebartext",()=>{var r;(r=this.osk)==null||r.refreshLayout()}),i.on("stubadded",r=>{let c=o(()=>{this.legacyAPIEvents.callEvent("keyboardregistered",{internalName:r.KI,language:r.KL,keyboardName:r.KN,languageCode:r.KLC,package:r.KP}),this.config.activateFirstKeyboard&&this.keyboardRequisitioner.cache.defaultStub==r&&this.contextManager.activateKeyboard(r.id,r.langId,!0)},"eventRaiser");this.config.deferForInitialization.isResolved?c():this.config.deferForInitialization.then(c)}),i.on("keyboardadded",r=>{let c=o(()=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:r.id})},"eventRaiser");this.config.deferForInitialization.isResolved?c():this.config.deferForInitialization.then(c)}),this.keyboardRequisitioner.cache.on("keyboardadded",r=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:r.id})})})}get build(){return Number.parseInt(et.VERSION_PATCH,10)}get version(){return et.VERSION_RELEASE}get hardKeyboard(){return this._hardKeyboard}set hardKeyboard(t){this._hardKeyboard&&this._hardKeyboard.off("keyevent",this.keyEventListener),this._hardKeyboard=t,t.on("keyevent",this.keyEventListener)}get osk(){return this._osk}set osk(t){var e;this._osk&&(this._osk.off("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=this.osk.layerChangeHandler),this._osk=t,this.core.keyboardProcessor.contextDevice=(e=t==null?void 0:t.targetDevice)!=null?e:this.config.softDevice,t&&(this.contextManager.activeKeyboard&&(t.activeKeyboard=this.contextManager.activeKeyboard),t.on("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=t.layerChangeHandler)}getDebugInfo(){var n,i,s,l,r,c,g,d,u,I,B,h,b,F;let t=(n=this.contextManager)==null?void 0:n.activeKeyboard;return{configReport:(i=this.config)==null?void 0:i.debugReport(),keyboard:{id:we((l=(s=t==null?void 0:t.metadata)==null?void 0:s.id)!=null?l:""),langId:((r=t==null?void 0:t.metadata)==null?void 0:r.langId)||"",version:(g=(c=t==null?void 0:t.keyboard)==null?void 0:c.version)!=null?g:""},model:{id:((u=(d=this.core)==null?void 0:d.activeModel)==null?void 0:u.id)||""},osk:{banner:(h=(B=(I=this.osk)==null?void 0:I.banner)==null?void 0:B.banner.type)!=null?h:"",layer:((F=(b=this.osk)==null?void 0:b.vkbd)==null?void 0:F.layerId)||""}}}refreshModel(){let t=this.contextManager.activeKeyboard,e=this.modelCache.modelForLanguage(t==null?void 0:t.metadata.langId);return this.core.activeModel!=e&&(this.core.activeModel&&this.core.languageProcessor.unloadModel(),e)?this.core.languageProcessor.loadModel(e).then(()=>e):Promise.resolve(e)}addEventListener(t,e){this.legacyAPIEvents.addEventListener(t,e)}removeEventListener(t,e){this.legacyAPIEvents.removeEventListener(t,e)}shutdown(){var t;this.legacyAPIEvents.shutdown(),(t=this.osk)==null||t.shutdown()}addModel(t){var n;this.modelCache.register(t);let e=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata;return e&&t.languages.indexOf(e.langId)!=-1?this.refreshModel().then(()=>{}):Promise.resolve()}removeModel(t){this.modelCache.unregister(t),this.core.activeModel&&this.core.activeModel.id==t&&this.core.languageProcessor.unloadModel()}setActiveKeyboard(t,e){return W(this,null,function*(){return this.contextManager.activateKeyboard(t,e,!0)})}getActiveKeyboard(){var t,e;return(e=(t=this.contextManager.activeKeyboard)==null?void 0:t.metadata.id)!=null?e:""}getActiveLanguage(t){var n,i,s;let e=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata;return t?(s=e==null?void 0:e.langName)!=null?s:"":(i=e==null?void 0:e.langId)!=null?i:""}isChiral(t){let e;if(t){if(typeof t=="string"){let n=this.keyboardRequisitioner.cache.getKeyboard(t);if(n)t=n;else throw new Error(`Keyboard '${t}' has not been loaded.`)}e=t}else e=this.core.activeKeyboard;return e.isChiral}resetContext(){this.contextManager.resetContext()}setNumericLayer(){this.core.keyboardProcessor.setNumericLayer(this.config.softDevice)}};o(Ir,"KeymanEngine");var rn=Ir;var rt=class rt{get height(){return this._height}set height(t){this._height=t>0?t:0,this.update()}get width(){return this._width}set width(t){this._width=t,this.update()}update(){let t=this.div.style,e=t.height,n=t.display;return this._height>0?(t.height=this._height+"px",t.display="block"):(t.height="0px",t.display="none"),e!==t.height||n!==t.display}constructor(t){let e=H("div");e.id=rt.BANNER_ID,e.className=rt.BANNER_CLASS,this.div=e,this.height=t,this.update()}appendStyleSheet(){}getDiv(){return this.div}configureForKeyboard(t,e){}shutdown(){}};o(rt,"Banner"),rt.DEFAULT_HEIGHT=37,rt.BANNER_CLASS="kmw-banner-bar",rt.BANNER_ID="kmw-banner-bar";var de=rt;var Me=class Me{constructor(t){let e=typeof t=="string"?Me.parseLengthStyle(t):t;this.val=e.val,this.absolute=e.absolute,e.special&&(this.special=e.special)}get styleString(){return this.absolute?this.val+"px":this.special?this.val+this.special:this.val*100+"%"}scaledBy(t){return new Me({val:t*this.val,absolute:this.absolute})}static inPixels(t){return new Me({val:t,absolute:!0})}static inPercent(t){return new Me({val:t/100,absolute:!1})}static forScalar(t){return new Me({val:t,absolute:!1})}static special(t,e){return new Me({val:t,absolute:!1,special:e})}static parseLengthStyle(t){if(t=="")return Xo;let e=parseFloat(t);return isNaN(e)?(console.error("Could not properly parse specified length style info: '"+t+"'."),Xo):t.indexOf("px")!=-1?{val:e,absolute:!0}:t.indexOf("pt")!=-1?{val:4*e/3,absolute:!0}:t.indexOf("%")!=-1?{val:e/100,absolute:!1}:t.indexOf("rem")!=-1?{val:e,absolute:!1,special:"rem"}:t.indexOf("em")!=-1?{val:e,absolute:!1,special:"em"}:{val:4*e/3,absolute:!0}}};o(Me,"ParsedLengthStyle");var x=Me,Xo=new x("1em");var br=class br extends de{constructor(){super(0);this.type="blank"}};o(br,"BlankBanner");var ct=br;var hr=class hr{constructor(){this._activeBannerHeight=de.DEFAULT_HEIGHT;this.events=new S.default;this.constructContainer()}constructContainer(){let t=H("div");return t.id="keymanweb_banner_container",t.className="kmw-banner-container",this.bannerContainer=t}get element(){return this.bannerContainer}appendStyles(){this.currentBanner&&this.currentBanner.appendStyleSheet()}get banner(){return this.currentBanner}set banner(t){if(this.currentBanner){if(t==this.currentBanner)return;{let e=this.currentBanner;this.currentBanner=t,this.bannerContainer.replaceChild(t.getDiv(),e.getDiv()),e.shutdown()}}else this.currentBanner=t,t&&this.bannerContainer.appendChild(t.getDiv());t instanceof ct||(t.height=this.activeBannerHeight),this.events.emit("bannerchange")}get height(){return this.currentBanner?this.currentBanner.height:0}get activeBannerHeight(){return this._activeBannerHeight}set activeBannerHeight(t){this._activeBannerHeight=t,this.currentBanner&&!(this.currentBanner instanceof ct)&&(this.currentBanner.height=t)}get layoutHeight(){return x.inPixels(this.height)}get width(){var t;return(t=this.currentBanner)==null?void 0:t.width}set width(t){this.currentBanner&&(this.currentBanner.width=t)}refreshLayout(){var t,e;(e=(t=this.currentBanner).refreshLayout)==null||e.call(t)}};o(hr,"BannerView");var rs=hr;var Fr=class Fr extends de{constructor(e,n){var t=(...args)=>{super(...args)};e.length>0?(t(),n&&(this.height=n)):t(0),this.type="image",e.indexOf("base64")>=0?console.log("Loading img from base64 data"):console.log("Loading img with src '"+e+"'"),this.img=document.createElement("img"),this.img.setAttribute("src",e);let i=this.img.style;i.width="100%",i.height="100%",this.getDiv().appendChild(this.img),console.log("Image loaded.")}setImagePath(e){this.img&&this.img.setAttribute("src",e)}};o(Fr,"ImageBanner");var cs=Fr;function Le(a,t){t instanceof Error?console.error(`${a}: ${t.message}

${t.stack}`):(console.error(a),console.error(t))}o(Le,"reportError");var mr=class mr{constructor(t){this.queue=[],this.defaultWaitFactory=t||(()=>ae(0))}get defaultWait(){return this.defaultWaitFactory()}get ready(){return this.queue.length==0&&!this.waitLock}triggerNextClosure(){return W(this,null,function*(){if(this.queue.length==0)return;let t=this.queue.shift();this.waitLock=Promise.resolve();let e;try{e=t()}catch(n){Le("Error from queued closure",n)}e=e!=null?e:this.defaultWaitFactory(),this.waitLock=e;try{yield e}catch(n){Le("Async error from queued closure",n)}this.waitLock=null,this.triggerNextClosure()})}runAsync(t){let e=this.ready;this.queue.push(t),e&&this.triggerNextClosure()}};o(mr,"AsyncClosureDispatchQueue");var os=mr;function So(a){return"targetX"in a&&"targetY"in a&&"t"in a}o(So,"isAnInputSample");var ot=class ot{constructor(t){this.rawLinearSums={x:0,y:0,t:0};this.coordArcSum=0;this._sampleCount=0;if(t)if(t instanceof ot)Object.assign(this,t),this.rawLinearSums=y({},t.rawLinearSums);else if(So(t))Object.assign(this,this.extend(t));else throw new Error("A constructor for this input pattern has not yet been implemented")}extend(t){return this._extend(new ot(this),t)}_extend(t,e){t._initialSample||(t._initialSample=e,t.baseSample=e);let n=t.baseSample;this.followingSample=e;let i=e.targetX-n.targetX,s=e.targetY-n.targetY,l=e.t-n.t;if(t.rawLinearSums.x+=i,t.rawLinearSums.y+=s,t.rawLinearSums.t+=l,this.lastSample){let r=e.targetX-this.lastSample.targetX,c=e.targetY-this.lastSample.targetY,g=r*r+c*c,d=Math.sqrt(g);t.coordArcSum+=d}return t._lastSample=e,t.sampleCount=this.sampleCount+1,t}deaccumulate(t){let e=new ot(this);return this._deaccumulate(e,t)}_deaccumulate(t,e){if(!e)return t;if(!e.followingSample||!e.lastSample)throw"Invalid argument:  stats missing necessary tracking variable.";for(let n in t.rawLinearSums){let i=n;t.rawLinearSums[i]-=e.rawLinearSums[i]}if(e.followingSample&&e.lastSample){let n=e.followingSample.targetX-e.lastSample.targetX,i=e.followingSample.targetY-e.lastSample.targetY,s=n*n+i*i,l=Math.sqrt(s);t.coordArcSum-=l,t.coordArcSum-=e.coordArcSum}return t.sampleCount-=e.sampleCount,t._initialSample=e.followingSample,t}translateCoordSystem(t){let e=new ot(this);return this._translateCoordSystem(e,t)}_translateCoordSystem(t,e){if(this.sampleCount==0)return t;let n=t.initialSample==t.lastSample;return t._initialSample=e(t.initialSample),t.baseSample=e(t.baseSample),t._lastSample=n?t._initialSample:e(t.lastSample),t}replaceInitialSample(t){let e=new ot(this);return this._replaceInitialSample(e,t)}_replaceInitialSample(t,e){if(this.sampleCount==0)throw new Error("no sample available to replace");let n=t.initialSample;if(t._initialSample=e,this.sampleCount>1){let i=e.targetX-n.targetX,s=e.targetY-n.targetY,l=e.t-n.t;t.rawLinearSums.x+=i,t.rawLinearSums.y+=s,t.rawLinearSums.t+=l;let r=i*i+s*s,c=Math.sqrt(r);t.coordArcSum+=c}else t._lastSample=e;return t}get lastSample(){return this._lastSample}get lastTimestamp(){var t;return(t=this.lastSample)==null?void 0:t.t}get sampleCount(){return this._sampleCount}set sampleCount(t){this._sampleCount=t}get initialSample(){return this._initialSample}mappingConstant(t){if(this.baseSample)return t=="t"?this.baseSample.t:t=="x"?this.baseSample.targetX:t=="y"?this.baseSample.targetY:0}mean(t){return this.rawLinearSums[t]/this.sampleCount+this.mappingConstant(t)}get netDistance(){if(!this.lastSample||!this.initialSample)return 0;let t=this.lastSample.targetX-this.initialSample.targetX,e=this.lastSample.targetY-this.initialSample.targetY;return Math.sqrt(t*t+e*e)}get duration(){return!this.lastSample||!this.initialSample?0:this.lastSample.t-this.initialSample.t}get angle(){if(this.sampleCount==1||!this.lastSample||!this.initialSample)return;if(this.netDistance<1)return;let t=this.lastSample.targetX-this.initialSample.targetX,e=this.lastSample.targetY-this.initialSample.targetY,n=Math.acos(-e/this.netDistance);return t<0?2*Math.PI-n:n}get angleInDegrees(){return this.angle*180/Math.PI}get cardinalDirection(){if(this.sampleCount==1||!this.lastSample||!this.initialSample||isNaN(this.angle)||this.angle===null||this.angle===void 0)return;let t=["n","ne","e","se","s","sw","w","nw","n"],e=Math.ceil((this.angleInDegrees-22.5)/45);return t[e]}get speed(){return this.duration?this.netDistance/this.duration:0}get rawDistance(){return this.coordArcSum}toJSON(){return{angle:this.angle,cardinal:this.cardinalDirection,netDistance:this.netDistance,duration:this.duration,sampleCount:this.sampleCount,rawDistance:this.rawDistance}}};o(ot,"CumulativePathStats");var Re=ot;function St(a,t){let e=a.gestures.find(n=>n.id==t);if(!e)throw new Error(`Could not find spec for gesture with id '${t}'`);return e}o(St,"getGestureModel");function yr(a,t){let e=a.sets[t];if(!e)throw new Error(`Could not find a defined gesture-set with id '${t}'`);let n=a.gestures.filter(s=>!!e.find(l=>s.id==l)),i=e.filter(s=>!n.find(l=>l.id==s));if(i.length>0)throw new Error(`Set '${t}' cannot find definitions for gestures with ids ${i}`);return n}o(yr,"getGestureModelSet");var pr={gestures:[],sets:{default:[]}};var Cr=class Cr{constructor(){}getBoundingClientRect(){return new DOMRect(0,0,Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),Math.max(document.documentElement.clientHeight||0,window.innerHeight||0))}};o(Cr,"ViewportZoneSource");var as=Cr;var Gr=class Gr{get edgePadding(){return this._edgePadding}constructor(t,e){Array.isArray(t)&&(e=t,t=new as),this.root=t,e=e||[0,0,0,0],this.updatePadding(e)}updatePadding(t){switch(t.length){case 1:let e=t[0];this._edgePadding={x:e,y:e,w:2*e,h:2*e};break;case 2:this._edgePadding={x:t[1],y:t[0],w:2*t[1],h:2*t[0]};break;case 3:this._edgePadding={x:t[1],y:t[0],w:2*t[1],h:t[0]+t[2]};break;case 4:this._edgePadding={x:t[3],y:t[0],w:t[1]+t[3],h:t[0]+t[2]};break;default:throw new Error("Invalid values for PaddedZoneSource's edgePadding - must be between 1 to 4 `number` values.")}}getBoundingClientRect(){let t=this.root.getBoundingClientRect();return new DOMRect(t.left+this.edgePadding.x,t.top+this.edgePadding.y,t.width-this.edgePadding.w,t.height-this.edgePadding.h)}};o(Gr,"PaddedZoneSource");var ue=Gr;function gs(a){var e,n,i,s,l,r,c;let t=y({},a);if(t.mouseEventRoot=(e=t.mouseEventRoot)!=null?e:t.targetRoot,t.touchEventRoot=(n=t.touchEventRoot)!=null?n:t.targetRoot,t.inputStartBounds=(i=t.inputStartBounds)!=null?i:t.targetRoot,t.maxRoamingBounds=(s=t.maxRoamingBounds)!=null?s:t.targetRoot,t.safeBounds=(l=t.safeBounds)!=null?l:new ue([2]),t.itemIdentifier=(r=t.itemIdentifier)!=null?r:()=>null,t.recordingMode=!!t.recordingMode,t.historyLength=((c=t.historyLength)!=null?c:0)>0?t.historyLength:0,a.paddedSafeBounds)delete t.safeBoundPadding;else{let g=a.safeBoundPadding;typeof g=="number"&&(g=[g]),g=g!=null?g:[3],t.paddedSafeBounds=new ue(t.safeBounds,g)}return t}o(gs,"preprocessRecognizerConfig");var ds=class ds extends S.default{constructor(){super();this._isComplete=!1;this._stats=new Re}get stats(){return this._stats}clone(){let e=new ds;return e._isComplete=this._isComplete,e._wasCancelled=this._wasCancelled,e._stats=new Re(this._stats),e}get isComplete(){return this._isComplete}get wasCancelled(){return this._wasCancelled}translateCoordSystem(e){this._stats=this._stats.translateCoordSystem(e)}replaceInitialSample(e){this._stats=this._stats.replaceInitialSample(e)}extend(e){if(this._isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this._stats=this._stats.extend(e),this.emit("step",e)}terminate(e=!1){this._isComplete||(this._wasCancelled=e,this._isComplete=!0,e?this.emit("invalidated"):this.emit("complete"),this.removeAllListeners())}toJSON(){return{stats:this.stats,wasCancelled:this.wasCancelled}}};o(ds,"GesturePath");var cn=ds;var qn=class qn extends cn{constructor(){super(...arguments);this.samples=[]}clone(){let e=new qn;return e.samples=[].concat(this.samples),e._isComplete=this._isComplete,e._wasCancelled=this._wasCancelled,e._stats=new Re(this._stats),e}static deserialize(e){let n=new qn;n.samples=[].concat(e.coords.map(s=>y({},s))),n._isComplete=!0,n._wasCancelled=e.wasCancelled;let i=n.samples.reduce((s,l)=>s.extend(l),new Re);return n._stats=i,n}extend(e){if(this.isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this.samples.push(e),super.extend(e)}translateCoordSystem(e){super.translateCoordSystem(e);for(let n=0;n<this.samples.length;n++)this.samples[n]=e(this.samples[n])}get coords(){return this.samples}toJSON(){let e={coords:[].concat(this.samples.map(n=>({targetX:n.targetX,targetY:n.targetY,t:n.t,item:n.item}))),wasCancelled:this.wasCancelled,stats:this.stats};for(let n of e.coords)delete n.clientX,delete n.clientY,n.item===void 0&&delete n.item;return e}};o(qn,"GestureDebugPath");var at=qn;var Qr=class Qr{constructor(t,e,n,i){this.stateToken=null;this.rawIdentifier=t,this.isFromTouch=n,this._path=i?new i:new cn,this.recognizerConfigStack=Array.isArray(e)?e:[e]}get path(){return this._path}setGestureMatchInspector(t){if(this._matchInspectionClosure)throw new Error("Invalid state:  the match-inspection closure has already been set");this._matchInspectionClosure=t}update(t){this.path.extend(t),this._baseItem||(this._baseItem=t.item)}get baseItem(){return this._baseItem}set baseItem(t){this._baseItem=t}get currentSample(){return this.path.stats.lastSample}get potentialModelMatchIds(){return this._matchInspectionClosure(this)}constructSubview(t,e,n){return new re(this,this.recognizerConfigStack,t,e,n)}terminate(t){this.path.terminate(t)}get isPathComplete(){return this.path.isComplete}get identifier(){return`${this.isFromTouch?"touch":"mouse"}:${this.rawIdentifier}`}pushRecognizerConfig(t){let e=A(y({},t),{mouseEventRoot:this.recognizerConfigStack[0].mouseEventRoot,touchEventRoot:this.recognizerConfigStack[0].touchEventRoot});this.recognizerConfigStack.push(gs(e))}popRecognizerConfig(){if(this.recognizerConfigStack.length==1)throw new Error("Cannot 'pop' the original recognizer-configuration for this GestureSource.");return this.recognizerConfigStack.pop()}get currentRecognizerConfig(){return this.recognizerConfigStack[this.recognizerConfigStack.length-1]}toJSON(){return{identifier:this.identifier,isFromTouch:this.isFromTouch,path:this.path.toJSON(),stateToken:this.stateToken}}};o(Qr,"GestureSource");var he=Qr,$n=class $n extends he{constructor(e,n,i,s,l){let r=0,c=e.path.stats.sampleCount;e instanceof $n&&(r=e._baseStartIndex);super(e.rawIdentifier,n,e.isFromTouch,Object.getPrototypeOf(e.path).constructor);let g=this._baseSource=e instanceof $n?e._baseSource:e;this.stateToken=l!=null?l:e.stateToken;let d=o(b=>{let F=this.recognizerTranslation,G=A(y({},b),{targetX:b.targetX-F.x,targetY:b.targetY-F.y});return this.stateToken&&(G.stateToken=this.stateToken),(this.stateToken!=g.stateToken||this.stateToken!=e.stateToken)&&(G.item=this.currentRecognizerConfig.itemIdentifier(G,null)),G},"translateSample"),u=e.path.stats.lastSample;i?(this._baseStartIndex=r=Math.max(r+c-1,0),c=c>0?1:0):this._baseStartIndex=r,i?e.path.stats.sampleCount&&this._path.extend(e.path.stats.lastSample):this._path=e.path.clone(),this._path.translateCoordSystem(d),s?this._baseItem=e.baseItem:this._baseItem=u==null?void 0:u.item;let I=o(()=>this.path.terminate(!1),"completeHook"),B=o(()=>this.path.terminate(!0),"invalidatedHook"),h=o(b=>{super.update(d(b))},"stepHook");g.path.on("complete",I),g.path.on("invalidated",B),g.path.on("step",h),this.subviewDisconnector=()=>{g.path.off("complete",I),g.path.off("invalidated",B),g.path.off("step",h)},g.isPathComplete&&(this.path.terminate(g.path.wasCancelled),this.disconnect())}get recognizerTranslation(){if(this.recognizerConfigStack.length==1||!this.currentRecognizerConfig)return{x:0,y:0};let n=this.currentRecognizerConfig.targetRoot.getBoundingClientRect(),i=this.recognizerConfigStack[0].targetRoot.getBoundingClientRect();return{x:n.left-i.left,y:n.top-i.top}}get baseSource(){return this._baseSource}disconnect(){this.subviewDisconnector&&(this.subviewDisconnector(),this.subviewDisconnector=null)}pushRecognizerConfig(e){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}popRecognizerConfig(){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}update(e){throw new Error("Updates should be provided through the base GestureSource.")}terminate(e){this.baseSource.terminate(e)}};o($n,"GestureSourceSubview");var re=$n;var Bs=class Bs extends he{constructor(e,n,i){super(e,n,i,at);this.stateToken=null}initPath(){return new at}static deserialize(e,n){let i=n!==void 0?n:this._jsonIdSeed++,s=e.isFromTouch,l=at.deserialize(e.path),r=new Bs(i,null,s);return r._path=l,r}};o(Bs,"GestureDebugSource");var us=Bs;var ei=class ei extends S.default{constructor(e){var n;super();this._activeTouchpoints=[];this.identifierMap={};this.config=e,this.sourceConstructor=(n=e==null?void 0:e.recordingMode)==null||n?us:he}createTouchpoint(e,n){let i=ei.IDENTIFIER_SEED++;this.identifierMap[e]=i;let s=new this.sourceConstructor(i,this.config,n);return s.stateToken=this.stateToken,s}fulfillInputStart(e){}maintainTouchpoints(e){e||(e=[]),this._activeTouchpoints.filter(n=>!e.includes(n)).forEach(n=>n.terminate(!0))}hasActiveTouchpoint(e){return this.identifierMap[e]!==void 0}getTouchpointWithId(e){let n=this.identifierMap[e];return this._activeTouchpoints.find(i=>i.rawIdentifier==n)}getConfigForId(e){return this.getTouchpointWithId(e).currentRecognizerConfig}getStateTokenForId(e){var n;return(n=this.getTouchpointWithId(e).stateToken)!=null?n:null}dropTouchpoint(e){let n=e.rawIdentifier;this._activeTouchpoints=this._activeTouchpoints.filter(i=>e!=i);for(let i of Object.keys(this.identifierMap)){let s=Number.parseInt(i,10);this.identifierMap[s]==n&&delete this.identifierMap[s]}}addTouchpoint(e){this._activeTouchpoints.push(e)}get activeSources(){return[].concat(this._activeTouchpoints)}};o(ei,"InputEngineBase"),ei.IDENTIFIER_SEED=0;var Is=ei;function Ur(a,t,e){let n=a.targetRoot.getBoundingClientRect();return{clientX:t,clientY:e,targetX:t-n.left,targetY:e-n.top}}o(Ur,"processSampleClientCoords");var xr=class xr extends Is{buildSampleFor(t,e,n,i,s){var g,d;let l=A(y({},Ur(this.config,t,e)),{t:i,stateToken:(g=s==null?void 0:s.stateToken)!=null?g:this.stateToken}),c=((d=s==null?void 0:s.currentRecognizerConfig.itemIdentifier)!=null?d:this.config.itemIdentifier)(l,n);return l.item=c,l}onInputStart(t,e,n,i){let s=this.createTouchpoint(t,i);s.update(e),this.addTouchpoint(s),s.path.on("invalidated",()=>{this.dropTouchpoint(s)}),s.path.on("complete",()=>{this.dropTouchpoint(s)});try{this.emit("pointstart",s)}catch(l){Le("Engine-internal error while initializing gesture matching for new source",l)}return s}onInputMove(t,e,n){if(t)try{t.update(e)}catch(i){Le("Error occurred while updating source",i)}}onInputMoveCancel(t,e,n){if(t)try{t.update(e),t.path.terminate(!0)}catch(i){Le("Error occurred while cancelling further input for source",i)}}onInputEnd(t,e){if(t)try{t.path.terminate(!1)}catch(n){Le("Error occurred while finalizing input for source",n)}}};o(xr,"InputEventEngine");var on=xr;var Ze=class Ze{constructor(){}static getCoordZoneBitmask(t,e){let n=e.getBoundingClientRect(),i=0;return i|=t.clientX<n.left?Ze.FAR_LEFT:0,i|=t.clientX>n.right?Ze.FAR_RIGHT:0,i|=t.clientY<n.top?Ze.FAR_TOP:0,i|=t.clientY>n.bottom?Ze.FAR_BOTTOM:0,i}static inputStartOutOfBoundsCheck(t,e){return!!this.getCoordZoneBitmask(t,e.inputStartBounds)}static inputStartSafeBoundProximityCheck(t,e){return this.getCoordZoneBitmask(t,e.paddedSafeBounds)}static inputMoveCancellationCheck(t,e,n){return n=n||0,this.getCoordZoneBitmask(t,e.maxRoamingBounds)?!0:!!(this.getCoordZoneBitmask(t,e.safeBounds)&~n)}};o(Ze,"ZoneBoundaryChecker"),Ze.FAR_TOP=8,Ze.FAR_LEFT=4,Ze.FAR_BOTTOM=2,Ze.FAR_RIGHT=1;var ve=Ze;var Zr=class Zr extends on{constructor(e){super(e);this.hasActiveClick=!1;this.disabledSafeBounds=0;this.currentSource=null;this.activeIdentifier=0;this._mouseStart=n=>this.onMouseStart(n),this._mouseMove=n=>this.onMouseMove(n),this._mouseEnd=n=>this.onMouseEnd(n)}get eventRoot(){return this.config.mouseEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("mousedown",this._mouseStart,!0),this.eventRoot.addEventListener("mousemove",this._mouseMove,!1),this.eventRoot.addEventListener("mouseup",this._mouseEnd,!0)}unregisterEventHandlers(){this.eventRoot.removeEventListener("mousedown",this._mouseStart,!0),this.eventRoot.removeEventListener("mousemove",this._mouseMove,!1),this.eventRoot.removeEventListener("mouseup",this._mouseEnd,!0)}preventPropagation(e){e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1,typeof e.stopImmediatePropagation=="function"?e.stopImmediatePropagation():typeof e.stopPropagation=="function"&&e.stopPropagation()}buildSampleFromEvent(e){return this.buildSampleFor(e.clientX,e.clientY,e.target,performance.now(),this.currentSource)}onMouseStart(e){if(!this.config.targetRoot.contains(e.target))return;this.preventPropagation(e);let n=this.buildSampleFromEvent(e);ve.inputStartOutOfBoundsCheck(n,this.config)||(this.disabledSafeBounds=ve.inputStartSafeBoundProximityCheck(n,this.config));let i=this.onInputStart(this.activeIdentifier,n,e.target,!1);this.currentSource=i;let s=o(()=>{this.currentSource=null},"cleanup");i.path.on("complete",s),i.path.on("invalidated",s)}onMouseMove(e){let n=this.currentSource;if(!n)return;let i=this.buildSampleFromEvent(e);if(!e.buttons){this.hasActiveClick&&(this.hasActiveClick=!1,this.onInputMoveCancel(n,i,e.target));return}this.preventPropagation(e);let s=n.currentRecognizerConfig;ve.inputMoveCancellationCheck(i,s,this.disabledSafeBounds)?this.onInputMoveCancel(n,i,e.target):this.onInputMove(n,i,e.target)}onMouseEnd(e){let n=this.currentSource;n&&(e.buttons||(this.hasActiveClick=!1),this.onInputEnd(n,e.target))}};o(Zr,"MouseEventEngine");var bs=Zr;function Vo(a){let t=[];for(let e=0;e<a.length;e++)t.push(a.item(e));return t}o(Vo,"touchListToArray");var Xr=class Xr extends on{constructor(e){super(e);this.eventDispatcher=new os;this.safeBoundMaskMap={};this.pendingSourcePromises=new Map;this.inputStartSignalMap=new Map;this._touchStart=n=>this.onTouchStart(n),this._touchMove=n=>this.onTouchMove(n),this._touchEnd=n=>this.onTouchEnd(n)}get eventRoot(){return this.config.touchEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("touchstart",this._touchStart,{capture:!0,passive:!1}),this.eventRoot.addEventListener("touchmove",this._touchMove,{capture:!1,passive:!1}),this.eventRoot.addEventListener("touchend",this._touchEnd,{capture:!0,passive:!1})}unregisterEventHandlers(){this.eventRoot.removeEventListener("touchstart",this._touchStart,!0),this.eventRoot.removeEventListener("touchmove",this._touchMove,!1),this.eventRoot.removeEventListener("touchend",this._touchEnd,!0)}preventPropagation(e){e.cancelable&&e.preventDefault(),typeof e.stopImmediatePropagation=="function"?e.stopImmediatePropagation():typeof e.stopPropagation=="function"&&e.stopPropagation()}dropTouchpoint(e){super.dropTouchpoint(e);for(let n of Object.keys(this.safeBoundMaskMap)){let i=Number.parseInt(n,10);this.getTouchpointWithId(i)==e&&delete this.safeBoundMaskMap[i]}}fulfillInputStart(e){let n=this.inputStartSignalMap.get(e);n&&(this.inputStartSignalMap.delete(e),n.resolve())}hasActiveTouchpoint(e){return super.hasActiveTouchpoint(e)||!!this.pendingSourcePromises.has(e)}buildSampleFromTouch(e,n,i){return this.buildSampleFor(e.clientX,e.clientY,e.target,n,i)}onTouchStart(e){if(!this.config.targetRoot.contains(e.target))return;this.preventPropagation(e);let n=Vo(e.touches),i=Vo(e.changedTouches),l=n.filter(c=>i.findIndex(g=>c.identifier==g.identifier)==-1).map(c=>this.pendingSourcePromises.get(c.identifier));this.eventDispatcher.runAsync(()=>W(this,null,function*(){let c=yield Promise.all(l);return this.maintainTouchpoints(c),this.eventDispatcher.defaultWait}));let r=new Map;for(let c=0;c<e.changedTouches.length;c++){let g=e.changedTouches.item(c),d=new f;this.pendingSourcePromises.set(g.identifier,d),r.set(g.identifier,d)}this.eventDispatcher.runAsync(()=>{let c=performance.now(),g=null;for(let d=0;d<e.changedTouches.length;d++){let u=e.changedTouches.item(d),I=u.identifier,B=this.buildSampleFromTouch(u,c,null);if(!ve.inputStartOutOfBoundsCheck(B,this.config))this.safeBoundMaskMap[I]=ve.inputStartSafeBoundProximityCheck(B,this.config);else{r.get(I).resolve(null);continue}g=this.onInputStart(I,B,e.target,!0);let h=r.get(I);h.resolve(g);let b=o(()=>{this.pendingSourcePromises.get(I)==h&&this.pendingSourcePromises.delete(I)},"cleanup");g.path.on("complete",b),g.path.on("invalidated",b)}if(g){let d=new f;return this.inputStartSignalMap.set(g,d),d.corePromise}else return Promise.resolve()})}onTouchMove(e){var i;for(let s=0;s<e.touches.length;s++){let l=e.touches.item(s);if(this.hasActiveTouchpoint(l.identifier)){this.preventPropagation(e);break}}let n=new Map;for(let s=0;s<e.touches.length;s++){let l=e.touches.item(s).identifier;n.set(l,(i=this.pendingSourcePromises.get(l))==null?void 0:i.corePromise)}this.eventDispatcher.runAsync(()=>W(this,null,function*(){let s=yield Promise.all(n.values());return this.maintainTouchpoints(s),this.eventDispatcher.defaultWait})),this.eventDispatcher.runAsync(()=>W(this,null,function*(){let s=performance.now();for(let l=0;l<e.touches.length;l++){let r=e.touches.item(l),c=r.identifier,g=yield n.get(c);if(!g||g.isPathComplete)continue;let d=g.currentRecognizerConfig,u=this.buildSampleFromTouch(r,s,g);ve.inputMoveCancellationCheck(u,d,this.safeBoundMaskMap[c])?this.onInputMoveCancel(g,u,r.target):this.onInputMove(g,u,r.target)}return this.eventDispatcher.defaultWait}))}onTouchEnd(e){var i;for(let s=0;s<e.changedTouches.length;s++){let l=e.changedTouches.item(s);if(this.hasActiveTouchpoint(l.identifier)){this.preventPropagation(e);break}}let n=new Map;for(let s=0;s<e.changedTouches.length;s++){let l=e.changedTouches.item(s).identifier,r=(i=this.pendingSourcePromises.get(l))==null?void 0:i.corePromise;n.set(l,r)}this.eventDispatcher.runAsync(()=>W(this,null,function*(){for(let s=0;s<e.changedTouches.length;s++){let l=e.changedTouches.item(s),r=yield n.get(l.identifier);!r||r.isPathComplete||this.onInputEnd(r,e.target)}return this.eventDispatcher.defaultWait}))}};o(Xr,"TouchEventEngine");var hs=Xr;var Sr=class Sr{get promise(){return this.publishedPromise.corePromise}constructor(t,e,n){if(!t||!e)throw new Error("A gesture-path source and contact-path model must be specified.");if(this.model=t,this.publishedPromise=new f,this.source=e,this.inheritedStats=n,this.lastStats=null,t.timer){let i=t.timer.inheritElapsed?Math.min(e.path.stats.duration,t.timer.duration):0;this.timerPromise=new Ee(t.timer.duration-i),this.publishedPromise.then(()=>{this.timerPromise.resolve(!1)}),this.timerPromise.then(s=>{let l=e instanceof re?e.baseSource:e,r=performance.now();!l.isPathComplete&&l.currentSample.t!=r&&l.path.extend(A(y({},l.currentSample),{t:r})),s!=t.timer.expectedResult&&this.finalize(!1,"timer"),this.finalize(!0,"timer")})}}finalize(t,e){if(this.publishedPromise.isFulfilled)return this._result;let n=this.model;n.validateItem&&t&&(t=n.validateItem(this.source.path.stats.lastSample.item,this.baseItem));let i;return t?i={type:n.pathResolutionAction,cause:e}:i={type:"reject",cause:e},this.publishedPromise.resolve(i),this._result=i,i}get stats(){return this.source.path.stats}get baseItem(){return this.source.baseItem}get lastItem(){return this.source.currentSample.item}update(){let t=this.model,e=this.source;if(e.path.wasCancelled)return this.finalize(!1,"path");if(t.itemChangeAction&&e.path.stats.sampleCount>0&&e.currentSample.item!=e.baseItem){let n=t.itemChangeAction=="resolve";return this.finalize(n,"item")}else{let n=t.pathModel.evaluate(e.path,this.lastStats,e.baseItem,this.inheritedStats)||"continue";return this.lastStats=e.path.stats,n!="continue"?this.finalize(n=="resolve","path"):e.path.isComplete?this.finalize(!1,"path"):{type:"continue"}}}};o(Sr,"PathMatcher");var an=Sr;var Vr=class Vr{constructor(t,e){this._isCancelled=!1;var r;if(!t||!e)throw new Error("Construction of GestureMatcher requires a gesture-model spec and a source for related contact points.");if(!t.sustainTimer&&!e)throw new Error("If the provided gesture-model spec lacks a sustain timer, there must be an active contact point.");let n=e instanceof he?null:e,i=n?null:e;this.predecessor=n,this.publishedPromise=new f,this.model=t,t.sustainTimer&&(this.sustainTimerPromise=new Ee(t.sustainTimer.duration),this.sustainTimerPromise.then(c=>{let g=t.sustainTimer.expectedResult==c;this.finalize(g,"timer")})),this.pathMatchers=[];let l=(i?[i]:n.sources).map(c=>i&&c==i?i:c.isPathComplete?null:c).reduce((c,g)=>g?c.concat(g):c,[]);if(t.sustainTimer&&l.length>0){this.finalize(!1,"path");return}else!t.sustainTimer&&l.length==0&&this.finalize(!1,"path");for(let c=0;c<l.length;c++){let g=l[c];g instanceof re&&g.disconnect();let d=t.contacts[c];if(!d)throw new Error(`No contact model for inherited path: gesture "${t.id}', entry ${c}`);let u=(r=d==null?void 0:d.model.pathInheritance)!=null?r:"chop",I=!1,B;switch(u){case"reject":this.finalize(!1,"path");return;case"full":B=g.constructSubview(!1,!0),this.addContactInternal(B,g.path.stats,!0);continue;case"partial":I=!0;case"chop":B=g.constructSubview(!0,I),this.addContactInternal(B,g.path.stats,!0);break}}}get sources(){return this.pathMatchers.map((t,e)=>{if(!this.model.contacts[e].resetOnInstantFulfill)return t.source}).filter(t=>!!t)}get promise(){return this.publishedPromise.corePromise}cancel(){this._isCancelled=!0,this._result||this.finalize(!1,"cancelled")}get isCancelled(){return this._isCancelled}finalize(t,e){var n,i;if(this.publishedPromise.isFulfilled)return this._result;try{let s;t?s=this.model.resolutionAction:(e!="cancelled"&&((n=this.model.rejectionActions)!=null&&n[e])&&(s=this.model.rejectionActions[e],s.item="none"),s=s||{type:"none",item:"none"});let l;switch((i=s.item)!=null?i:"current"){case"none":l=null;break;case"base":l=this.primaryPath.baseItem;break;case"current":l=this.primaryPath.currentSample.item;break}let c={matched:t,action:A(y({},s),{item:l})};return this.publishedPromise.resolve(c),this._result=c,c}catch(s){return this.publishedPromise.reject(s),{matched:!1,action:{type:"none",item:null}}}}finalizeSources(){if(!this._result)throw Error("Invalid state for source-finalization - the matcher's evaluation of the gesture model is not yet complete");let t=this._result.matched;for(let e=0;e<this.pathMatchers.length;e++){let n=this.pathMatchers[e],i=this.model.contacts[e];n.source.isPathComplete||(t&&i.endOnResolve||!t&&i.endOnReject)&&n.source.terminate(!1)}}get primaryPath(){let t,e=Number.NEGATIVE_INFINITY;for(let n of this.pathMatchers)n.model.itemPriority>e&&(e=n.model.itemPriority,t=n);return!t&&this.predecessor?this.predecessor.primaryPath:t==null?void 0:t.source}get baseItem(){return this.primaryPath.baseItem}get currentItem(){return this.primaryPath.currentSample.item}get allSourceIds(){let t=this.sources.map(n=>n.identifier),e=this.predecessor?this.predecessor.allSourceIds:[];return t=t.filter(n=>e.indexOf(n)==-1),t.concat(e)}mayAddContact(){return this.pathMatchers.length<this.model.contacts.length}addContact(t){let e=this.pathMatchers.length;if(!this.mayAddContact())throw new Error(`The specified gesture model does not support more than ${e} contact points.`);this.addContactInternal(t.constructSubview(!1,!0),null)}get result(){return this._result}addContactInternal(t,e,n){var d;let i=this.pathMatchers.length,s=this.model.contacts[i],l=new an(s.model,t,new Re(e));this.pathMatchers.push(l);let r=null,c=null;if(!i&&this.predecessor&&this.model.sustainTimer){r=this.predecessor.primaryPath;let u=(d=this.model.sustainTimer.baseItem)!=null?d:"result",I;switch(u){case"none":c=null;break;case"base":c=this.predecessor.primaryPath.baseItem,I=this.predecessor.primaryPath.stateToken;break;case"result":c=this.predecessor.result.action.item,I=this.predecessor.primaryPath.currentSample.stateToken;break}t.baseItem=c!=null?c:t.baseItem,t.stateToken=I,t.currentSample.stateToken=I,t.currentRecognizerConfig&&(t.currentSample.item=t.currentRecognizerConfig.itemIdentifier(t.currentSample,null))}else c=this.primaryPath.baseItem,r=this.primaryPath;if(s.model.baseCoordReplacer){let u=t.path.stats,I=s.model.baseCoordReplacer(u,c);if(I){let B=A(y({},Ur(t.currentRecognizerConfig,I.clientX,I.clientY)),{t:I.t||I.t===0?I.t:u.initialSample.t,item:c,stateToken:t.stateToken});t.path.replaceInitialSample(B)}}if(s.model.allowsInitialState&&!s.model.allowsInitialState(t.currentSample,r.currentSample,c,r.stateToken)){this.pathMatchers.pop(),this.finalize(!1,"cancelled");return}let g=l.update();if((g==null?void 0:g.type)=="reject"){this.finalize(!1,n?"cancelled":"path");return}l.promise.then(u=>{this.finalize(u.type=="resolve",u.cause)})}update(){this.pathMatchers.forEach(t=>{try{t.update()}catch(e){console.error(e),this.finalize(!1,"cancelled")}})}};o(Vr,"GestureMatcher");var Vt=Vr;var Ar=class Ar extends S.default{constructor(e){super();this._sourceSelector=[];this.potentialMatchers=[];this.sustainMode=!1;this.attemptSynchronousUpdate=o(()=>{let n=this._sourceSelector.filter(s=>!s.source.isPathComplete).map(s=>s.source.currentSample.t),i=n[0];n.find(s=>i!=s)||this.potentialMatchers.forEach(s=>s.update())},"attemptSynchronousUpdate");this.baseGestureSetId=e||"default"}potentialMatchersForSource(e){return this.potentialMatchers.filter(n=>n.allSourceIds.find(i=>i==e.identifier))}cascadeTermination(){let e=this.potentialMatchers,n=e.filter(r=>!r.model.sustainWhenNested),i=e.filter(r=>r.model.sustainWhenNested);this.potentialMatchers=i;let s=i.map(r=>r.allSourceIds).reduce((r,c)=>{for(let g of c)r.indexOf(g)==-1&&r.push(g);return r},[]);return this._sourceSelector.filter(r=>!s.find(c=>c==r.source.identifier)).forEach(r=>{r.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}});let c=this._sourceSelector.indexOf(r);c>-1&&this._sourceSelector.splice(c,1)}),n.forEach(r=>r.cancel()),this.sustainMode=!0,this._sourceSelector.map(r=>r.source)}matchGesture(e,n){return W(this,null,function*(){let i=e instanceof he,s=o(B=>{let h=B.sources.map(b=>b.baseSource);return h&&h.length>0?h:B.predecessor?s(B.predecessor):[]},"determinePredecessorSources"),l=i?[e instanceof re?e.baseSource:e]:s(e),r=i?e:null,c=i?null:e;if(this.pendingMatchSetup){let B=this.pendingMatchSetup,h=new f;this.pendingMatchSetup=h.corePromise,yield B,this.pendingMatchSetup==h.corePromise&&(this.pendingMatchSetup=null),h.resolve()}i&&r.path.on("invalidated",()=>{this.dropSourcesWithIds([r.identifier])});let g=new f,d=l.map(B=>{let h={source:B,matchPromise:g,preserve:!0};return this._sourceSelector.push(h),h}),u=d.map(B=>B.matchPromise);if(i){let B=this.potentialMatchers.filter(h=>h.mayAddContact());if(B.forEach(h=>{h.addContact(r),h.promise.then(this.matcherSelectionFilter(h,u))}),B.length>0){let h=this.stateToken,b=new f;this.pendingMatchSetup=b.corePromise,yield ae(0),yield ae(0),this.pendingMatchSetup==b.corePromise&&(this.pendingMatchSetup=null),b.resolve();let F=this.stateToken;if(h!=F){let U=r.currentSample;r.stateToken=F,U.stateToken=F,U.item=e.currentRecognizerConfig.itemIdentifier(U,null),r.baseItem=U.item}let G=B.find(U=>U.result);if(G&&G.allSourceIds.includes(e.identifier))return g.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:g.corePromise}}}if(d.forEach(B=>{B.preserve=!1}),this.sustainMode&&r)return g.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:g.corePromise,sustainModeWithoutMatch:!0};let I=n.map(B=>{try{return new Vt(B,r||c)}catch(h){return console.error(h),null}}).filter(B=>!!B);I=I.filter(B=>!B.result||B.result.matched!==!1);for(let B of I)B.promise.then(this.matcherSelectionFilter(B,u));return I.length>0?this.potentialMatchers=this.potentialMatchers.concat(I):g.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),this.potentialMatchers.sort((B,h)=>h.model.resolutionPriority-B.model.resolutionPriority),this.resetSourceHooks(),{selectionPromise:g.corePromise}})}resetSourceHooks(){let e=o(n=>{let i=n;i.path.off("step",this.attemptSynchronousUpdate),i.path.off("complete",this.attemptSynchronousUpdate),i.path.off("invalidated",this.attemptSynchronousUpdate),i.path.on("step",this.attemptSynchronousUpdate),i.path.on("complete",this.attemptSynchronousUpdate),i.path.on("invalidated",this.attemptSynchronousUpdate)},"resetHooks");this._sourceSelector.forEach(n=>e(n.source))}dropSourcesWithIds(e){for(let n of e){let i=this._sourceSelector.findIndex(s=>s.source.identifier==n);i>-1&&this._sourceSelector.splice(i,1)[0].matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"none",item:null}}})}}matchersForSource(e){return this.potentialMatchers.filter(n=>!!n.sources.find(i=>i.identifier==e.identifier))}matcherSelectionFilter(e,n){return i=>W(this,null,function*(){e.isCancelled?i={matched:!1,action:{type:"none",item:null}}:e.finalizeSources();let l=e.allSourceIds.map(c=>this._sourceSelector.find(g=>g.source.identifier==c)).filter(c=>!!c),r=this.potentialMatchers.indexOf(e);if(r!=-1){if(this.potentialMatchers.splice(r,1),i.action.type=="none"){this.finalizeMatcherlessTrackers(l);return}if(i.matched)for(let c of l){let g=this.matchersForSource(c.source);this.potentialMatchers=this.potentialMatchers.filter(d=>!g.find(u=>d==u)),g.forEach(d=>{d.cancel()}),this._sourceSelector=this._sourceSelector.filter(d=>!l.find(u=>d==u)),c.matchPromise.resolve({matcher:e,result:i})}else{let c=o(g=>{if(this.sustainMode&&!g.sustainWhenNested){this.finalizeMatcherlessTrackers(l);return}let d=new Vt(g,e);if(d.result&&d.result.matched==!1){this.finalizeMatcherlessTrackers(l);return}d.promise.then(this.matcherSelectionFilter(d,l.map(u=>u.matchPromise))),this.potentialMatchers.push(d),this.resetSourceHooks()},"replacer");this.emit("rejectionwithaction",{matcher:e,result:i},c);return}}})}finalizeMatcherlessTrackers(e){let n=e.map(i=>({tracker:i,pendingCount:this.potentialMatchers.filter(s=>!!s.allSourceIds.find(l=>i.source.identifier==l)).length}));for(let i of n)i.pendingCount==0&&!i.tracker.preserve&&i.tracker.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}})}};o(Ar,"MatcherSelector");var gt=Ar;var fr=class fr{constructor(t,e){var s,l;let{matcher:n,result:i}=t;this.gestureSetId=e,this.matchedId=n==null?void 0:n.model.id,this.linkType=i.action.type,this.item=i.action.item,this.sources=n==null?void 0:n.sources,(s=this.sources)==null||s.forEach(r=>r.disconnect()),(l=this.sources)==null||l.sort((r,c)=>(n==null?void 0:n.primaryPath)==r?-1:(n==null?void 0:n.primaryPath)==c?1:0),this.allSourceIds=(n==null?void 0:n.allSourceIds)||[]}};o(fr,"GestureStageReport");var ti=fr,Lr=class Lr extends S.default{constructor(e,n,i,s){super();this.markedComplete=!1;this.selectionHandler=o(e=>W(this,null,function*(){var d,u,I,B,h,b,F,G,U,Q;let n=((d=this.pushedSelector)==null?void 0:d.baseGestureSetId)||((u=this.selector)==null?void 0:u.baseGestureSetId),i=new ti(e,n);e.matcher&&this.stageReports.push(i);let s=(I=e.matcher)!=null?I:this.stageReports[this.stageReports.length-1],l=(B=s==null?void 0:s.sources.map(p=>p instanceof re?p.baseSource:p))!=null?B:[],r=e.result.action.type;if((r=="complete"||r=="none")&&(l.forEach(p=>{p.isPathComplete||p.terminate(r=="none")}),!e.result.matched)){this.markedComplete||(this.markedComplete=!0,this.emit("complete"));return}if(r=="complete"&&this.touchpointCoordinator&&this.pushedSelector){let X=((h=this.touchpointCoordinator)==null?void 0:h.sustainSelectorSubstack(this.pushedSelector)).map(R=>{let L=new f;return R.path.on("invalidated",()=>L.resolve()),R.path.on("complete",()=>L.resolve()),L.corePromise});X.length>0&&e.result.action.awaitNested&&(yield Promise.all(X),yield ae(0)),(b=this.touchpointCoordinator)==null||b.popSelector(this.pushedSelector),this.pushedSelector=null}this.emit("stage",i,p=>{p.type=="pop"?l.forEach(X=>X.popRecognizerConfig()):l.forEach(X=>X.pushRecognizerConfig(p.config))});let c=!1;this.touchpointCoordinator&&(c=!this.touchpointCoordinator.selectorStackIncludes(this.selector));let g=Wr(e.result.action,this.gestureConfig,this.baseGestureSetId);if(c&&(g=g.filter(p=>p.sustainWhenNested)),g.length>0){if(!(r=="chain"&&e.result.action.selectionMode==((F=this.pushedSelector)==null?void 0:F.baseGestureSetId))){if(this.pushedSelector&&(this.pushedSelector.off("rejectionwithaction",this.modelResetHandler),(G=this.touchpointCoordinator)==null||G.popSelector(this.pushedSelector),this.pushedSelector=null),r=="chain"){let R=e.result.action.selectionMode;if(R){let L=new gt(R);L.on("rejectionwithaction",this.modelResetHandler),this.pushedSelector=L,(U=this.touchpointCoordinator)==null||U.pushSelector(L)}}}((Q=this.pushedSelector)!=null?Q:this.selector).matchGesture(e.matcher,g).then(R=>W(this,null,function*(){return this.selectionHandler(yield R.selectionPromise)}))}else this.markedComplete||(this.markedComplete=!0,this.emit("complete"))}),"selectionHandler");this.modelResetHandler=o((e,n)=>{let i=e.matcher.allSourceIds;if(!this.allSourceIds.find(s=>i.indexOf(s)==-1))if(e.result.action.type=="replace")n(St(this.gestureConfig,e.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.stageReports=[],this.selector=i,this.selector.on("rejectionwithaction",this.modelResetHandler),this.once("complete",()=>{var l;this.pushedSelector&&((l=this.touchpointCoordinator)==null||l.popSelector(this.pushedSelector),this.pushedSelector=null),this.selector.off("rejectionwithaction",this.modelResetHandler),this.selector.dropSourcesWithIds(this.allSourceIds),this.selector=null}),this.gestureConfig=n,this.touchpointCoordinator=s,Promise.resolve().then(()=>this.selectionHandler(e))}get allSourceIds(){var e,n;return(n=(e=this.stageReports[this.stageReports.length-1])==null?void 0:e.allSourceIds)!=null?n:[]}get baseGestureSetId(){var e,n;return(n=(e=this.selector)==null?void 0:e.baseGestureSetId)!=null?n:null}get potentialModelMatchIds(){if(!this.selector)return[];let e=[this.selector];return this.pushedSelector&&e.push(this.pushedSelector),this.stageReports[this.stageReports.length-1].sources.map(l=>e.map(r=>r.potentialMatchersForSource(l).map(c=>c.model.id))).reduce((l,r)=>l.concat(r)).reduce((l,r)=>{for(let c of r)l.indexOf(c)==-1&&l.push(c);return l},[])}cancel(){this.stageReports[this.stageReports.length-1].sources.forEach(n=>n.baseSource.isPathComplete||n.baseSource.terminate(!0)),this.markedComplete||(this.markedComplete=!0,this.emit("complete"))}toJSON(){return this.stageReports}};o(Lr,"GestureSequence");var gn=Lr;function Wr(a,t,e){switch(a.type){case"none":case"complete":return[];case"replace":return[St(t,a.replace)];case"chain":return[St(t,a.next)];default:throw new Error("Unexpected case arose within `processGestureAction` method")}}o(Wr,"modelSetForAction");var Rr=class Rr extends S.default{constructor(e,n,i){super();this.selectorStack=[new gt];this._activeSources=[];this._activeGestures=[];this._history=[];this.modelResetHandler=o((e,n)=>{let i=e.matcher.allSourceIds;if(!this.activeGestures.find(s=>s.allSourceIds.find(l=>i.indexOf(l)!=-1)))if(e.result.action.type=="replace")n(St(this.gestureModelDefinitions,e.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.onNewTrackedPath=o(e=>W(this,null,function*(){this.addSimpleSourceHooks(e);let n=this.gestureModelDefinitions,i,s;do{i=this.currentSelector;let I=yield i.matchGesture(e,yr(n,i.baseGestureSetId));if(I.sustainModeWithoutMatch){let B=o(h=>{h.stateToken=this.stateToken,h.item=e.currentRecognizerConfig.itemIdentifier(h,null)},"correctSample");e.path instanceof at&&e.path.coords.forEach(B),e.stateToken=this.stateToken,e.baseItem=e.path.stats.initialSample.item,B(e.path.stats.initialSample),B(e.path.stats.lastSample);continue}else{s=I.selectionPromise;break}}while(i!=this.currentSelector);let l=this.currentSelector;e.setGestureMatchInspector(this.buildGestureMatchInspector(l));let r=o(()=>{this.recordHistory(e)},"preGestureScribe");try{e.path.on("invalidated",r),this.emit("inputstart",e)}catch(u){Le("Error from 'inputstart' event listener",u)}this.inputEngines.forEach(u=>{u.fulfillInputStart(e)});let c=yield s;if(!c||c.result.matched==!1)return;let g=c.matcher.allSourceIds;for(let u of this._activeGestures)if(u.allSourceIds.find(I=>!!g.find(B=>I==B)))return;let d=new gn(c,n,this.currentSelector,this);this._activeGestures.push(d),d.on("complete",()=>{let u=this._activeGestures.indexOf(d);u!=-1&&this._activeGestures.splice(u,1)}),e.path.wasCancelled||(e.path.off("invalidated",r),d.on("complete",()=>this.recordHistory(d))),this.emit("recognizedgesture",d)}),"onNewTrackedPath");if(this.historyMax=i>0?i:0,this.gestureModelDefinitions=e,this.inputEngines=[],n)for(let s of n)this.addEngine(s);this.selectorStack[0].on("rejectionwithaction",this.modelResetHandler)}pushSelector(e){this.selectorStack.push(e),e.on("rejectionwithaction",this.modelResetHandler)}sustainSelectorSubstack(e){if(!e)return[];let n=this.selectorStack.indexOf(e);if(n==-1)return[];if(this.selectorStack.length<=1)throw new Error("May not force the original, base gesture selector into sustain mode.");let i=[];for(let s=n;s<this.selectorStack.length;s++)e=this.selectorStack[s],i=i.concat(e.cascadeTermination());return i}popSelector(e){if(!e)return;let n=this.selectorStack.indexOf(e);if(n!=-1){if(this.selectorStack.length<=1)throw new Error("May not pop the original, base gesture selector.");for(;n<this.selectorStack.length;)e=this.selectorStack[n],e.off("rejectionwithaction",this.modelResetHandler),this.selectorStack.splice(n,1);this.currentSelector.stateToken=this.stateToken}}selectorStackIncludes(e){return this.selectorStack.includes(e)}get currentSelector(){return this.selectorStack[this.selectorStack.length-1]}buildGestureMatchInspector(e){return n=>{let i=this.selectorStack.indexOf(e);return this.selectorStack.slice(i).map(l=>l.potentialMatchersForSource(n).map(r=>r.model.id)).reduce((l,r)=>l.concat(r))}}addEngine(e){e.on("pointstart",this.onNewTrackedPath),this.inputEngines.push(e)}recordHistory(e){let n=this.historyMax;n>0&&(this._history.length==n&&this._history.shift(),this._history.push(e))}get activeGestures(){return[].concat(this._activeGestures)}get activeSources(){return[].concat(this.inputEngines.map(e=>e.activeSources).reduce((e,n)=>e.concat(n),[]))}get history(){return this._history}get historyJSON(){let e=o(function(n,i){return n=="item"?i==null?void 0:i.id:i},"sanitizingReplacer");return JSON.stringify(this.history,e,2)}get stateToken(){return this._stateToken}set stateToken(e){this._stateToken=e,this.inputEngines.forEach(n=>n.stateToken=e),this.currentSelector.stateToken=e}addSimpleSourceHooks(e){e.path.on("invalidated",()=>{let n=this.activeGestures.find(s=>s.allSourceIds.includes(e.identifier));n&&n.cancel();let i=this._activeSources.indexOf(e);this._activeSources=this._activeSources.splice(i,1)}),e.path.on("complete",()=>{let n=this._activeSources.indexOf(e);this._activeSources=this._activeSources.splice(n,1)})}};o(Rr,"TouchpointCoordinator");var Fs=Rr;var ms={};Sn(ms,{EMPTY_GESTURE_DEFS:()=>pr,getGestureModel:()=>St,getGestureModelSet:()=>yr});var vr=class vr extends Fs{constructor(e,n){let i=gs(n);e=e||pr;super(e,null,i.historyLength);this.config=i,this.mouseEngine=new bs(this.config),this.touchEngine=new hs(this.config),this.mouseEngine.registerEventHandlers(),this.touchEngine.registerEventHandlers(),this.addEngine(this.mouseEngine),this.addEngine(this.touchEngine)}destroy(){this.activeGestures.forEach(e=>e.cancel()),this.activeSources.forEach(e=>e.terminate(!0)),this.mouseEngine.unregisterEventHandlers(),this.touchEngine.unregisterEventHandlers(),this.mouseEngine=null,this.touchEngine=null}};o(vr,"GestureRecognizer");var At=vr;var Hr={};Sn(Hr,{matchers:()=>ys,specs:()=>ms});var ys={};Sn(ys,{GestureMatcher:()=>Vt,GestureSequence:()=>gn,GestureStageReport:()=>ti,MatcherSelector:()=>gt,PathMatcher:()=>an,modelSetForAction:()=>Wr});function ps(a,t){let e=new Map;return t.keys.forEach(n=>{let i=Math.abs(a.x-n.centerX),s=Math.abs(a.y-n.centerY),l,r;i>.5*n.width?(l=i-.5*n.width,i=.5):(l=0,i/=n.width),s>.5*n.height?(r=s-.5*n.height,s=.5):(r=0,s/=n.height),l*=t.kbdScaleRatio,l+=i*n.height,r+=s*n.height;let c=l*l+r*r;e.set(n.keySpec,c)}),e}o(ps,"keyTouchDistances");function dt(a){var i;let t=new Map,e=0;Array.isArray(a)||(a=[a]);for(let s of a)for(let l of s.keys()){let r=1/(Math.pow(s.get(l),2)+3e-5);e+=r,t.set(l,(i=t.get(l))!=null?i:0+r)}let n=[];for(let s of t.keys())n.push({keySpec:s,p:t.get(s)/e});return n.sort(function(s,l){return l.p-s.p})}o(dt,"distributionFromDistanceMaps");var Jr=["n","ne","e","se","s","sw","w","nw"],Ao=Math.PI,kr=(()=>{let a=new Map,t=Ao/4;for(let e=0;e<Jr.length;e++)a.set(Jr[e],[t*e,1]);return a})();function Cs(a){return Math.PI/4*Jr.indexOf(a)}o(Cs,"lockedAngleForDir");function ii(a,t){let e=Cs(t),n=a.initialSample,i=a.lastSample.targetX-n.targetX,s=a.lastSample.targetY-n.targetY,l=Math.max(0,-s*Math.cos(e));return Math.max(0,i*Math.sin(e))+l}o(ii,"calcLockedDistance");function Aa(a,t,e,n){return i=>{let s=Cs(t),l=n.flick.triggerDist-n.flick.dirLockDist,r=Math.max(0,ii(a.path.stats,t)-n.flick.dirLockDist),g=Math.min(1,.7*r/l),d=Math.sin(s)*g,u=-Math.cos(s)*g;e==null||e.scrollFlickPreview(d,u)}}o(Aa,"buildFlickScroller");var Gs=Math.PI/3,Nr=class Nr{constructor(t,e,n,i,s,l){this.directlyEmitsKeys=!0;this.sequence=t,this.gestureParams=s,this.baseSpec=i.key.spec,this.baseKeyDistances=n.getSimpleTapCorrectionDistances(t.stageReports[0].sources[0].path.stats.initialSample,this.baseSpec);let r=t.stageReports[0].sources[0].baseSource,c=r;t.on("complete",()=>{l==null||l.cancel()}),this.sequence.on("stage",d=>{var h;let u=c.path.stats;this.computedFlickDistribution=this.flickDistribution(u,!0);let I=this.computedFlickDistribution[0].keySpec;if(d.matchedId=="flick-restart"){c.path.replaceInitialSample(d.sources[0].path.stats.initialSample);return}if(d.matchedId=="flick-reset-centering"){c=r.constructSubview(!0,!0);return}else if(d.matchedId=="flick-reset-end"){this.emitKey(n,this.baseSpec,c.path.stats);return}else if(d.matchedId=="flick-reset"){this.flickScroller&&(this.flickScroller(c.currentSample),c.path.off("step",this.flickScroller)),this.lockedDir=null,this.lockedSelectable=null,c instanceof re&&c.disconnect();return}else if(d.matchedId=="flick-mid"){if(I==this.baseSpec)return;let b=Object.keys(this.baseSpec.flick).find(F=>this.baseSpec.flick[F]==I);this.lockedDir=b,this.lockedSelectable=I,this.flickScroller&&c.path.off("step",this.flickScroller),this.flickScroller=Aa(c,b,l,this.gestureParams),this.flickScroller(c.currentSample),c.path.on("step",this.flickScroller);return}let B=(h=this.lockedSelectable)!=null?h:I;this.emitKey(n,B,u)});let g=this.buildPopupRecognitionConfig(n);e({type:"push",config:g})}emitKey(t,e,n){let i;ii(n,this.lockedDir)>this.gestureParams.flick.triggerDist?i=t.keyEventFromSpec(e):i=t.keyEventFromSpec(this.baseSpec),i.keyDistribution=this.currentStageKeyDistribution(this.baseKeyDistances),t.raiseKeyEvent(i,null)}buildPopupRecognitionConfig(t){let e={getBoundingClientRect(){let n=Number.MAX_SAFE_INTEGER;return new DOMRect(-n,-n,2*n,2*n)}};return A(y({},t.gestureEngine.config),{maxRoamingBounds:e,safeBounds:e})}cancel(){}flickDistribution(t,e){let n=this.baseSpec.flick,i=[{spec:this.baseSpec,coord:[NaN,0]}];i=i.concat(Object.keys(n).map(I=>({spec:n[I],coord:kr.get(I)})));let s=t.angle,l=this.gestureParams.flick.triggerDist,c=Math.min(l,e?l:t.netDistance)/l,g=0,d=i.map(I=>{let B=0,h=I.coord;if(!isNaN(h[0])){let U=s-h[0],Q=2*Ao+h[0]-s;B=Math.min(U*U,Q*Q)}let b=Gs*(h[1]-c),F=b*b,G=1/(B+F+1e-6);return g+=G,{keySpec:I.spec,p:G}}),u=1/g;return d.forEach(I=>I.p*=u),d.sort((I,B)=>B.p-I.p)}currentStageKeyDistribution(t){let e=this.baseSpec,n=this.baseKeyDistances,i=this.computedFlickDistribution;if(!n.get(e))return[{keySpec:i[0].keySpec,p:1}];let l=i.findIndex(g=>g.keySpec==e),r=i.splice(l,1)[0].p,c=dt(n);return i.concat(c.map(g=>({keySpec:g.keySpec,p:g.p*r})))}};o(Nr,"Flick");var ni=Nr;var Qs=ha.TouchLayoutKeySp,si={longpress:{flickDistStart:8,flickDistFinal:40,waitLength:500,noiseTolerance:10},multitap:{waitLength:300,holdLength:150},flick:{startDist:10,dirLockDist:25,triggerDist:40}};function Wo(a){let t=a.getBoundingClientRect();return{clientX:t.left+t.width/2,clientY:t.top+t.height/2}}o(Wo,"getKeyCentroid");function fo(a){let t=Wo(a);return e=>{let n=e.lastSample.clientX-t.clientX,i=e.lastSample.clientY-t.clientY;return Math.sqrt(n*n+i*i)}}o(fo,"buildDistFromKeyCentroidFunctor");function li(a){let t=a.key.spec;if(t.sk)return!1;let e=["K_SHIFT","K_ALT","K_CTRL","K_NUMERALS","K_SYMBOLS","K_CURRENCIES"];for(let n of e)if(t.id==n)return!0;if(t.nextlayer)switch(t.sp){case Qs.special:case Qs.specialActive:case Qs.customSpecial:case Qs.customSpecialActive:return!0;default:return!1}else return!1}o(li,"keySupportsModipress");function Er(a,t){let e=o((b,F)=>{if(!b)return!1;let G=b.key.spec;switch(F){case"modipress-start":return li(b);case"special-key-start":return["K_LOPT","K_ROPT","K_BKSP"].indexOf(G.baseKeyID)!=-1;case"longpress":return!0;case"multitap-start":case"modipress-multitap-start":return a.hasMultitaps?!!G.multitap:!1;case"flick-start":return!!G.flick;default:return!0}},"gestureKeyFilter"),n=t;n.longpress.permitsFlick=b=>{let F=b==null?void 0:b.key.spec.flick;return!F||!(F.n||F.nw||F.ne)};let i=n.roamingEnabled=!a.hasFlicks,s=ce(i?Pa(n):ko(n)),l=ce(i?Tr(n):No(n)),r=d(ce(Ho(n,!0,i)),0),c=d(Da(n),0),g=d(tg(n),0);Object.defineProperty(r.contacts[0].model.timer,"duration",{get:()=>n.longpress.waitLength}),Object.defineProperty(c.sustainTimer,"duration",{get:()=>n.multitap.waitLength}),Object.defineProperty(g.sustainTimer,"duration",{get:()=>n.multitap.waitLength});function d(b,F){b=ce(b);let G=b.id;return typeof F=="number"&&(F=[F]),b.contacts.forEach((U,Q)=>{var p;if(F.indexOf(Q)!=-1){let X=(p=U.model.allowsInitialState)!=null?p:()=>!0;U.model=A(y({},U.model),{allowsInitialState:(R,L,T)=>e(T,G)&&X(R,L,T)})}}),b}o(d,"withKeySpecFiltering");let u=Ja(),I=_a(),B=[r,c,Oa(n),s,l,d(u,0),ka(n),ja(),d(I,0),qa(n),eg(),$a(),g,ng(n),ig()],h=[r.id,s.id,I.id,u.id];return i?(B.push(d(Na(n),0)),B.push(Ea())):(B.push(d(Jo(n),0)),B.push(Ta(n)),B.push(wa(n)),B.push(Ma(n)),B.push(Ya(n)),B.push(Ka()),B.push(za(n)),h.push("flick-start")),{gestures:B,sets:{default:h,modipress:h.filter(b=>b!=I.id),none:[]}}}o(Er,"gestureSetForLayout");function Yr(){return{itemPriority:0,pathResolutionAction:"reject",pathModel:{evaluate:a=>"resolve"}}}o(Yr,"instantContactRejectionModel");function Ke(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:a=>"resolve"}}}o(Ke,"instantContactResolutionModel");function Wa(a){let t=a.flick;return{itemPriority:1,pathModel:{evaluate:(e,n,i)=>{let s=e.stats,l=i==null?void 0:i.key.spec;if(l&&l.sk){let r=l.flick;if(!(r.nw||r.n||r.ne)){let g=s.netDistance,d=s.angle;if(g*Math.cos(d)>a.longpress.flickDistStart)return"reject"}}return s.netDistance>t.startDist?"resolve":null}},pathResolutionAction:"resolve",pathInheritance:"partial"}}o(Wa,"flickStartContactModel");function Lo(a,t){let e=t.key.spec.flick,n=Object.keys(e),i,s=0;for(let l of n){let r=ii(a,l);r>s&&(s=r,i=l)}return{dir:i,dist:s}}o(Lo,"determineLockFromStats");function fa(a){return{itemPriority:1,pathModel:{evaluate:(t,e,n)=>{let{dir:i,dist:s}=Lo(t.stats,n);if(s>a.flick.dirLockDist){let l=t.stats.angle,r=Cs(i),c=Math.abs(l-r),g=Math.abs(2*Math.PI+r-l);if(c<=Gs||g<=Gs)return"resolve"}else if(t.isComplete)return"reject"}},pathResolutionAction:"resolve",pathInheritance:"full"}}o(fa,"flickMidContactModel");function La(a){return{itemPriority:1,pathModel:{evaluate:(t,e,n,i)=>{if(t.isComplete)return"resolve";{let{dir:s}=Lo(i,n);if(ii(t.stats,s)<a.flick.dirLockDist)return"reject"}}},pathResolutionAction:"resolve",pathInheritance:"full"}}o(La,"flickEndContactModel");function Ra(a,t,e){let n=a.longpress;return{itemPriority:0,pathResolutionAction:"resolve",timer:{get duration(){return n.waitLength},expectedResult:!0},validateItem:(i,s)=>!!(s!=null&&s.key.spec.sk),pathModel:{evaluate:i=>{var l;let s=i.stats;if(t&&n.permitsFlick(s.lastSample.item)&&((l=s.cardinalDirection)==null?void 0:l.indexOf("n"))!=-1){let r=s.netDistance,c=s.angle;if(r*Math.cos(c)>n.flickDistFinal)return"resolve"}else if(e){if(s.rawDistance>n.noiseTolerance||s.lastSample.item!=s.initialSample.item)return"reject"}else if(s.lastSample.item!=s.initialSample.item)return"reject";return i.isComplete?"reject":null}}}}o(Ra,"longpressContactModel");function Ro(){return{itemPriority:-1,pathResolutionAction:"resolve",pathModel:{evaluate:a=>"resolve"}}}o(Ro,"modipressContactStartModel");function va(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:a=>{if(a.isComplete)return"reject"}}}}o(va,"modipressContactHoldModel");function vo(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:a=>{if(a.isComplete)return"resolve"}}}}o(vo,"modipressContactEndModel");function Us(a,t){var n;let e=(n=a==null?void 0:a.roamingEnabled)!=null?n:!0;return{itemPriority:0,itemChangeAction:e?"reject":void 0,pathResolutionAction:"resolve",pathInheritance:!e&&t?"full":"chop",pathModel:{evaluate:i=>{if(i.isComplete&&!i.wasCancelled)return"resolve"}}}}o(Us,"simpleTapContactModel");function Ha(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:a=>{if(a.isComplete&&!a.wasCancelled)return"resolve"}}}}o(Ha,"subkeySelectContactModel");function Ja(){return{id:"special-key-start",resolutionPriority:0,contacts:[{model:y({},Ke()),endOnResolve:!1}],resolutionAction:{type:"chain",next:"special-key-end",item:"current"}}}o(Ja,"specialKeyStartModel");function ka(a){return{id:"special-key-end",resolutionPriority:0,contacts:[{model:A(y({},Us(a)),{itemChangeAction:"resolve"}),endOnResolve:!0}],resolutionAction:{type:"complete",item:"none"}}}o(ka,"specialKeyEndModel");function Ho(a,t,e){let n={id:"longpress",resolutionPriority:4,contacts:[{model:A(y({},Ra(a,t,e)),{itemPriority:1,pathInheritance:"chop"}),endOnResolve:!1},{model:Yr(),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"subkey-select",selectionMode:"none",item:"none"}};return e?A(y({},n),{rejectionActions:{path:{type:"replace",replace:"longpress-roam"},timer:{type:"replace",replace:"longpress-roam-restore"}}}):n}o(Ho,"longpressModel");function Na(a){let t=Ho(a,!1,!0);return A(y({},t),{id:"longpress-roam"})}o(Na,"longpressModelAfterRoaming");function Ea(){return{id:"longpress-roam-restore",contacts:[{model:{pathModel:{evaluate:a=>null},itemChangeAction:"reject",pathInheritance:"full",pathResolutionAction:"reject",itemPriority:0}}],resolutionPriority:-1,rejectionActions:{item:{type:"replace",replace:"longpress-roam"}},resolutionAction:{type:"chain",next:"longpress-roam"}}}o(Ea,"longpressRoamRestoration");function Jo(a){return{id:"flick-start",resolutionPriority:3,contacts:[{model:Wa(a)}],resolutionAction:{type:"chain",item:"none",next:"flick-mid"}}}o(Jo,"flickStartModel");function Ya(a){let t=Jo(a);return A(y({},t),{contacts:[A(y({},t.contacts[0]),{model:A(y({},t.contacts[0].model),{baseCoordReplacer:(e,n)=>{let i=Wo(n),s=fo(n),l=e.initialSample,r=s(e);if(r>a.flick.triggerDist)return i;let c=a.flick.dirLockDist;if(r<c)return l;let g=c/r,d=l.clientX-i.clientX,u=l.clientY-i.clientY;return{clientX:i.clientX+d*g,clientY:i.clientY+u*g}}})})],id:"flick-restart",sustainWhenNested:!0,rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}}})}o(Ya,"flickRestartModel");function Ta(a){return{id:"flick-mid",resolutionPriority:0,contacts:[{model:fa(a),endOnReject:!0},{model:Yr(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}},resolutionAction:{type:"chain",item:"none",next:"flick-end"},sustainWhenNested:!0}}o(Ta,"flickMidModel");function wa(a){return{id:"flick-reset",resolutionPriority:1,contacts:[{model:A(y({},Ke()),{pathInheritance:"partial"})}],resolutionAction:{type:"chain",next:"flick-reset-centering"},sustainWhenNested:!0}}o(wa,"flickResetModel");function Ma(a){return{id:"flick-reset-centering",resolutionPriority:1,contacts:[{model:{pathModel:{evaluate(t,e,n){e||(e=t.stats);let i=fo(n),s=i(t.stats);if(i(e)<s)return"resolve"}},itemPriority:0,pathResolutionAction:"resolve",pathInheritance:"full"}}],resolutionAction:{type:"chain",next:"flick-restart"},sustainWhenNested:!0}}o(Ma,"flickResetCenteringModel");function Ka(){return{id:"flick-reset-end",resolutionPriority:1,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"complete",item:"base"},sustainWhenNested:!0}}o(Ka,"flickResetEndModel");function za(a){return{id:"flick-end",resolutionPriority:0,contacts:[{model:La(a)},{model:Ke(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset"}},resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}o(za,"flickEndModel");function Da(a){return{id:"multitap-start",resolutionPriority:2,contacts:[{model:A(y({},Ke()),{itemPriority:1,pathInheritance:"reject",allowsInitialState(t,e,n){return t.item==n}})}],sustainTimer:{duration:a.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"multitap-end",item:"current"}}}o(Da,"multitapStartModel");function Oa(a){return{id:"multitap-end",resolutionPriority:2,contacts:[{model:A(y({},Us(a)),{itemPriority:1,timer:{duration:a.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:Ke(),resetOnInstantFulfill:!0}],rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"none"}}}o(Oa,"multitapEndModel");function ko(a){return{id:"initial-tap",resolutionPriority:1,contacts:[{model:A(y({},Us(a)),{pathInheritance:"chop",itemPriority:1,timer:{duration:a.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:Ke(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"base"}}}o(ko,"initialTapModel");function No(a){return{id:"simple-tap",resolutionPriority:1,contacts:[{model:A(y({},Us(a,!0)),{itemPriority:1}),endOnResolve:!0},{model:Ke(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,resolutionAction:{type:"complete",item:"base"}}}o(No,"simpleTapModel");function Pa(a){let t=ko(a);return A(y({},t),{rejectionActions:A(y({},t.rejectionActions),{item:{type:"replace",replace:"initial-tap"}})})}o(Pa,"initialTapModelWithReset");function Tr(a){let t=No(a);return A(y({},t),{rejectionActions:A(y({},t.rejectionActions),{item:{type:"replace",replace:"simple-tap"}})})}o(Tr,"simpleTapModelWithReset");function ja(){return{id:"subkey-select",resolutionPriority:0,contacts:[{model:A(y({},Ha()),{pathInheritance:"full",itemPriority:1}),endOnResolve:!0,endOnReject:!0}],resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}o(ja,"subkeySelectModel");function _a(){return{id:"modipress-start",resolutionPriority:5,contacts:[{model:A(y({},Ro()),{allowsInitialState(a,t,e){return li(e)},itemChangeAction:"reject",itemPriority:1})}],resolutionAction:{type:"chain",next:"modipress-hold",selectionMode:"modipress",item:"current"}}}o(_a,"modipressStartModel");function qa(a){return{id:"modipress-hold",resolutionPriority:5,contacts:[{model:A(y({},va()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:a.multitap.holdLength,expectedResult:!0,inheritElapsed:!0}})},{model:y({},Ke()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"},rejectionActions:{path:{type:"replace",replace:"modipress-end-multitap-transition"}}}}o(qa,"modipressHoldModel");function $a(){return{id:"modipress-end-multitap-transition",resolutionPriority:5,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"}}}o($a,"modipressMultitapTransitionModel");function eg(){return{id:"modipress-end",resolutionPriority:5,contacts:[{model:A(y({},vo()),{itemChangeAction:"reject",pathInheritance:"full"})}],resolutionAction:{type:"complete",item:"none",awaitNested:!0}}}o(eg,"modipressEndModel");function tg(a){return{id:"modipress-multitap-start",resolutionPriority:6,contacts:[{model:A(y({},Ro()),{pathInheritance:"reject",allowsInitialState(t,e,n){return t.item!=n?!1:li(n)},itemChangeAction:"reject",itemPriority:1})}],sustainTimer:{duration:a.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"modipress-multitap-end",selectionMode:"modipress",item:"current"}}}o(tg,"modipressMultitapStartModel");function ng(a){return{id:"modipress-multitap-end",resolutionPriority:5,contacts:[{model:A(y({},vo()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:a.multitap.holdLength,expectedResult:!1}})},{model:y({},Yr()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"},rejectionActions:{timer:{type:"replace",replace:"modipress-multitap-lock-transition"},path:{type:"replace",replace:"modipress-multitap-lock-transition"}}}}o(ng,"modipressMultitapEndModel");function ig(){return{id:"modipress-multitap-lock-transition",resolutionPriority:5,contacts:[{model:A(y({},Ke()),{pathResolutionAction:"resolve"})}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"}}}o(ig,"modipressMultitapLockModel");var Eo=A(y({},ce(Tr(null))),{resolutionAction:{type:"complete",item:"current"}}),Yo={gestures:[Eo],sets:{default:[Eo.id]}};function xs(a){var t;return typeof a=="string"?t=a:(t=a.style.fontSize,t||(t=getComputedStyle(a).fontSize)),new x(t)}o(xs,"getFontSizeStyle");function To(a,t,e){if(a.touchable){let n=a.formFactor=="phone"?1.6*(e?.65:.6)*1.2:2;return x.special(n,"em")}else return t?x.inPixels(t/8):void 0}o(To,"defaultFontSize");var ri;function Zs(a,t,e){e={fontFamily:e.fontFamily,fontSize:e.fontSize},e.fontFamily||(e.fontFamily=getComputedStyle(document.body).fontFamily),(!e.fontSize||e.fontSize=="")&&(e.fontSize="1em");let n=e.fontFamily,i=xs(e.fontSize);var s;i.absolute?s=i.val+"px":s=i.val*t+"px",ri=ri!=null?ri:document.createElement("canvas");var l=ri.getContext("2d");l.font=s+" "+n;var r=l.measureText(a);return r}o(Zs,"getTextMetrics");var sg=10,wr=class wr{constructor(t,e){this.totalLength=0;this.baseCoord=t,this.curCoord=t,this.baseScrollLeft=e,this.totalLength=0}updateTo(t){let e=this.curCoord;this.curCoord=t;let n=this.baseCoord.targetX-this.curCoord.targetX+this.baseScrollLeft;return this.totalLength+=Math.abs(this.curCoord.targetX-e.targetX),n}get hasScrolled(){return this.totalLength>sg}};o(wr,"BannerScrollState");var Xs=wr;var wo="kmw-suggest-touched",lg="kmw-suggest-banner-scroller",Mo=.666,Ko="swallow-fade-transition",ci=class ci{constructor(t,e){this.index=t,this.rtl=e!=null?e:!1,this.constructRoot();let n=this.display=H("span");n.className="kmw-suggestion-text",this.container.appendChild(n)}get computedStyle(){return getComputedStyle(this.display)}constructRoot(){let t=this.div=H("div");t.className="kmw-suggest-option",t.id=ci.BASE_ID+this.index,this.div.suggestion=this;let e=this.container=document.createElement("div");e.className="kmw-suggestion-container";let i=(100-He.MARGIN*(He.LONG_SUGGESTION_DISPLAY_LIMIT-1))/He.LONG_SUGGESTION_DISPLAY_LIMIT;e.style.minWidth=i+"%",t.appendChild(e)}matchKeyboardProperties(t){let e=this.div;if(t){t.KLC&&(e.lang=t.KLC);let n=t.KFont;n&&n.family&&n.family!=""&&(e.style.fontFamily=n.family)}}get suggestion(){return this._suggestion}update(t,e){this._suggestion=t;let n=this.generateSuggestionText(this.rtl);if(this.container.replaceChild(n,this.display),this.display=n,e.minWidth!==void 0&&(this._minWidth=e.minWidth),this._paddingWidth=e.paddingWidth,this._collapsedWidth=e.collapsedWidth,t&&t.displayAs){let i=Zs(t.displayAs,e.emSize,e.styleForFont);this._textWidth=i.width}else this._textWidth=0;this.currentWidth=this.collapsedWidth,this.highlight(t==null?void 0:t.autoAccept),this.updateLayout()}updateLayout(){if(!this.suggestion&&this.index!=0){this.div.style.width="0px";return}else this.div.style.width="";let t=this.container.style;t.minWidth=this.collapsedWidth+"px",this.rtl?t.marginRight=this.collapsedWidth-this.expandedWidth+"px":t.marginLeft=this.collapsedWidth-this.expandedWidth+"px",this.updateFade()}updateFade(){this.div.classList.add(Ko),window.requestAnimationFrame(()=>{this.div.classList.remove(Ko)}),this.div.classList.add(`kmw-hide-fade-${this.rtl?"left":"right"}`);let t=`kmw-hide-fade-${this.rtl?"right":"left"}`;this.expandedWidth-this.collapsedWidth?this.div.classList.remove(t):this.div.classList.add(t)}get targetCollapsedWidth(){return this._collapsedWidth}get textWidth(){return this._textWidth}get paddingWidth(){return this._paddingWidth}get minWidth(){return this._minWidth}set minWidth(t){this._minWidth=t}get expandedWidth(){return this.minWidth>this.spanWidth?this.minWidth:this.spanWidth}get spanWidth(){var e,n;let t=(e=this.textWidth)!=null?e:0;return t&&(t+=(n=this.paddingWidth)!=null?n:0),t}get collapsedWidth(){let t=this.spanWidth<this.targetCollapsedWidth?this.spanWidth:this.targetCollapsedWidth,e=t<this.expandedWidth?t:this.expandedWidth;return this.minWidth>e?this.minWidth:e}get currentWidth(){return this.div.offsetWidth}set currentWidth(t){t<this.collapsedWidth?t=this.collapsedWidth:t>this.expandedWidth&&(t=this.expandedWidth),this.rtl?this.container.style.marginRight=`${t-this.expandedWidth}px`:this.container.style.marginLeft=`${t-this.expandedWidth}px`}highlight(t){let e=this.div;t?e.classList.add(wo):e.classList.remove(wo)}isEmpty(){return!this._suggestion}generateSuggestionText(t){let e=this._suggestion;var n,i=H("span");if(i.className="kmw-suggestion-text",e==null)return i;if(e.displayAs==null||e.displayAs=="")n="ย";else{let s=t?8238:8237;n=String.fromCharCode(s)+e.displayAs}return i.innerHTML=n,i}};o(ci,"BannerSuggestion"),ci.BASE_ID="kmw-suggestion-";var Mr=ci,D=class D extends de{constructor(e,n){super(n||de.DEFAULT_HEIGHT);this.type="suggestion";this.currentSuggestions=[];this.options=[];this.separators=[];this.isRTL=!1;this.onSuggestionUpdate=o(e=>{var I;this.currentSuggestions=e,(I=this.highlightAnimation)==null||I.cancel();let n=this.options[0].computedStyle,i={fontSize:n.fontSize,fontFamily:n.fontFamily},s=getComputedStyle(document.body).fontSize,l=xs(s).val,r=getComputedStyle(this.options[0].container.firstChild),c=this.width/D.LONG_SUGGESTION_DISPLAY_LIMIT,g=new x(r.paddingLeft||"4px"),d=new x(r.paddingRight||"4px"),u={paddingWidth:g.val+d.val,emSize:l,styleForFont:i,collapsedWidth:c,minWidth:0};for(let B=0;B<D.SUGGESTION_LIMIT;B++){let h=this.options[B];if(e.length>B){let b=e[B];h.update(b,u)}else h.update(null,u)}this.refreshLayout()},"onSuggestionUpdate");this.refreshLayout=o(()=>{let e=[],n=0,i=Math.min(this.currentSuggestions.length,8);for(let s=0;s<i;s++){let l=this.options[s];l.minWidth=0,n+=l.collapsedWidth,l.collapsedWidth<l.expandedWidth&&e.push(l)}if(i=i||1,n<this.width){let s=this.width*.01*(i-1);for(;n<this.width&&e.length>0;){let r=(this.width-n-s)/e.length;e.sort((u,I)=>u.expandedWidth-I.expandedWidth);let c=e[0],g=c.expandedWidth-c.collapsedWidth,d=Math.min(g,r);d>0&&(e.forEach(u=>u.minWidth=u.collapsedWidth+d),n+=d*e.length),e.splice(0,1)}let l=(this.width-n-s)/i;for(let r=0;r<i;r++){let c=this.options[r];c.minWidth=c.collapsedWidth+l,c.updateLayout()}}for(let s=0;s<D.SUGGESTION_LIMIT-1;s++)this.separators[s].style.display=s<i-1?"":"none"},"refreshLayout");this.getDiv().className=this.getDiv().className+" "+D.BANNER_CLASS,this.container=document.createElement("div"),this.container.className=lg,this.getDiv().appendChild(this.container),this.buildInternals(!1),this.gestureEngine=this.setupInputHandling()}shutdown(){this.gestureEngine.destroy()}buildInternals(e){this.isRTL=e,this.options.length>0&&(this.options=[],this.separators=[]);for(var n=0;n<D.SUGGESTION_LIMIT;n++){let i=new Mr(n,e);this.options[n]=i}for(var n=0;n<D.SUGGESTION_LIMIT;n++){let s=e?D.SUGGESTION_LIMIT-n-1:n;if(this.container.appendChild(this.options[s].div),e&&(this.container.scrollLeft=this.container.scrollWidth),n!=D.SUGGESTION_LIMIT-1){let l=H("div");l.className="kmw-banner-separator";let r=l.style;r.marginLeft=`calc(${D.MARGIN/2}% - 0.5px)`,r.marginRight=`calc(${D.MARGIN/2}% - 0.5px)`,this.container.appendChild(l),this.separators[s-(e?1:0)]=l}}}setupInputHandling(){let e=new ue(this.getDiv(),[-Number.MAX_SAFE_INTEGER]);this.selectionBounds=new ue(this.getDiv(),[-Mo*this.height,-Number.MAX_SAFE_INTEGER]);let n={targetRoot:this.getDiv(),maxRoamingBounds:e,safeBounds:e,itemIdentifier:c=>{let g=this.selectionBounds.getBoundingClientRect();if(c.clientX<g.left||c.clientX>g.right||c.clientY<g.top||c.clientY>g.bottom)return null;let d=null,u=Number.MAX_VALUE;for(let I of this.options){let B=I.div.getBoundingClientRect();if(B.left<=c.clientX&&c.clientX<B.right)return I.suggestion?I:null;{let h=(c.clientX<B.left?-1:1)*(c.clientX-B.left);h<u&&(u=h,d=I)}}return d.suggestion?d:null}},i=new At(Yo,n),s={source:null,scrollingHandler:null,suggestion:null},l=o(c=>{c.highlight(!0),this.highlightAnimation&&(this.highlightAnimation.cancel(),this.highlightAnimation.decouple()),this.highlightAnimation=new Ss(this.container,c,!1),this.highlightAnimation.expand()},"markSelection"),r=o(c=>{c.highlight(!1),this.highlightAnimation||(this.highlightAnimation=new Ss(this.container,c,!1)),this.highlightAnimation.collapse()},"clearSelection");return i.on("inputstart",c=>{if(s.source){c.terminate(!0);return}let g=this._predictionContext.selected;this._predictionContext.selected=null,g&&this.options.forEach(I=>{I.suggestion==g&&I.highlight(!1)}),this.scrollState=new Xs(c.currentSample,this.container.scrollLeft);let d=c.baseItem;s.source=c,s.scrollingHandler=I=>{var b;let B=this.scrollState.updateTo(I);(b=this.highlightAnimation)==null||b.setBaseScroll(B);let h=I.item?d:null;h!=s.suggestion&&(s.suggestion&&r(s.suggestion),s.suggestion=h,h&&l(h))},s.suggestion=c.currentSample.item,s.suggestion&&l(s.suggestion);let u=o(()=>{let I=this.currentSuggestions;ae(0).then(()=>W(this,null,function*(){if(I==this.currentSuggestions&&(this._predictionContext.selected=g,g)){for(let B of this.options)if(B.suggestion==g){B.highlight(!0);break}}})),s.suggestion&&(r(s.suggestion),s.suggestion=null),s.source=null,s.scrollingHandler=null},"terminationHandler");c.path.on("complete",u),c.path.on("invalidated",u),c.path.on("step",s.scrollingHandler)}),i.on("recognizedgesture",c=>{c.once("stage",g=>{let d=g.item;d&&!this.scrollState.hasScrolled&&this.currentSuggestions.length>0&&(this.currentSuggestions=[],this.predictionContext.accept(d.suggestion).then(()=>{this.container.scrollLeft=this.isRTL?this.container.scrollWidth:0})),this.scrollState=null})}),i}update(){var n;let e=super.update();return(n=this.selectionBounds)==null||n.updatePadding([-Mo*this.height,-Number.MAX_SAFE_INTEGER]),e}configureForKeyboard(e,n){let i=e.isRTL;this.container.textContent="",this.buildInternals(i),this.options.forEach(s=>s.matchKeyboardProperties(n)),this.onSuggestionUpdate(this.currentSuggestions)}get predictionContext(){return this._predictionContext}set predictionContext(e){this._predictionContext&&this._predictionContext.off("update",this.onSuggestionUpdate),this._predictionContext=e,e&&(e.on("update",this.onSuggestionUpdate),this.onSuggestionUpdate(e.currentSuggestions))}};o(D,"SuggestionBanner"),D.SUGGESTION_LIMIT=8,D.LONG_SUGGESTION_DISPLAY_LIMIT=3,D.MARGIN=1;var He=D,Fe=class Fe{constructor(t,e,n){this.setScrollOffset=o(()=>{if(!this.scrollContainer)return;let t=this.option.currentWidth-this.option.collapsedWidth,e=this.option.rtl,n=Math.max(this.rootScrollOffset-this.option.div.offsetLeft,0),i=Math.max(this.option.div.offsetLeft+this.option.collapsedWidth-(this.rootScrollOffset+this.scrollContainer.offsetWidth)),s=Math.max(e?i:n,0),l=Math.max(this.collapsedScrollOffset+(e?0:1)*t,0)+(e?0:-1)*s,r=Math.max(this.rootScrollOffset+(e?0:1)*t,0)+(e?0:-1)*s,c=e?Math.max(l,r):Math.min(l,r),g=Math.max(e?this.option.div.offsetLeft+this.option.currentWidth-(c+this.scrollContainer.offsetWidth):c-this.option.div.offsetLeft,0),d=Math.min(t,g),u=l+(e?1:-1)*d+(e?0:1)*s;if(this.scrollContainer.scrollLeft=u,this.pendingAnimation){let I=this.scrollContainer.scrollLeft-u;this.option.currentWidth+=I}},"setScrollOffset");this._expand=o(t=>{if(this.startTimestamp===void 0)return;let e=t-this.startTimestamp,n=e>Fe.TRANSITION_TIME;n&&(e=Fe.TRANSITION_TIME);let i=this.option.expandedWidth-this.option.collapsedWidth,s=e/Fe.TRANSITION_TIME,l=i*s;this.option.currentWidth=l+this.option.collapsedWidth,n?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._expand),this.setScrollOffset()},"_expand");this._collapse=o(t=>{if(this.startTimestamp===void 0)return;let e=t-this.startTimestamp,n=e>Fe.TRANSITION_TIME;n&&(e=Fe.TRANSITION_TIME);let i=this.option.expandedWidth-this.option.collapsedWidth,s=1-e/Fe.TRANSITION_TIME,l=i*s;this.option.currentWidth=l+this.option.collapsedWidth,n?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._collapse),this.setScrollOffset()},"_collapse");this.scrollContainer=t,this.option=e,this.collapsedScrollOffset=t.scrollLeft,this.rootScrollOffset=t.scrollLeft}setBaseScroll(t){this.collapsedScrollOffset=t,this.option.rtl?t>this.rootScrollOffset&&(this.rootScrollOffset=t):t<this.rootScrollOffset&&(this.rootScrollOffset=t),window.requestAnimationFrame(this.setScrollOffset)}decouple(){this.cancel(),this.scrollContainer=null}clear(){this.startTimestamp=null,window.cancelAnimationFrame(this.pendingAnimation),this.pendingAnimation=null}cancel(){this.clear(),this.option.currentWidth=this.option.collapsedWidth}expand(){this.clear(),this.startTimestamp=performance.now();let t=this.option.currentWidth-this.option.collapsedWidth,e=this.option.expandedWidth-this.option.collapsedWidth;t!=0&&(this.startTimestamp-=t/e*Fe.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._expand)}collapse(){this.clear(),this.startTimestamp=performance.now();let t=this.option.expandedWidth-this.option.currentWidth,e=this.option.expandedWidth-this.option.collapsedWidth;t!=0&&(this.startTimestamp-=t/e*Fe.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._collapse)}};o(Fe,"SuggestionExpandContractAnimation"),Fe.TRANSITION_TIME=250;var Ss=Fe;var Kr=class Kr extends de{constructor(e){super();this.type="html";let n=this.getDiv(),i=document.createElement("div");i.style.userSelect="none",i.style.height="100%",i.style.width="100%",n.appendChild(i),this.container=i.attachShadow?i.attachShadow({mode:"closed"}):i,this.container.innerHTML=e}get innerHTML(){return this.container.innerHTML}set innerHTML(e){this.container.innerHTML=e}};o(Kr,"HTMLBanner");var Vs=Kr;var zr=class zr{constructor(t,e,n){this.ImageBanner=cs;this.HTMLBanner=Vs;this.hostDevice=e,this.container=t,this.predictionContext=n,this.inactiveBanner=new ct}get inactiveBanner(){return this._inactiveBanner}set inactiveBanner(t){this._inactiveBanner=t!=null?t:new ct,this.container.banner instanceof He||(this.container.banner=this._inactiveBanner)}activateBanner(t){let e=this.container.banner;if(e instanceof He&&(e.predictionContext=null),!t)this.container.banner=this.inactiveBanner;else{let n=new He(this.hostDevice,this.container.activeBannerHeight);n.predictionContext=this.predictionContext,this.container.banner=n}}selectBanner(t){this.activateBanner(t=="active"||t=="configured"),this.keyboard&&this.container.banner.configureForKeyboard(this.keyboard,this.keyboardStub)}configureForKeyboard(t,e){this.keyboard=t,this.keyboardStub=e,this.container.banner.configureForKeyboard(t,e)}shutdown(){this.container.banner instanceof He&&(this.container.banner.predictionContext=null)}};o(zr,"BannerController");var oi=zr;var Dr=class Dr{constructor(){let t=this.element=document.createElement("div");t.style.userSelect="none",t.className="kmw-osk-none"}postInsert(){}updateState(){}refreshLayout(){}get layoutHeight(){return x.inPixels(0)}};o(Dr,"EmptyView");var Wt=Dr;var dn=class dn{constructor(t){this.kbd=t;var e=this.element=document.createElement("div");e.style.userSelect="none",e.className="kmw-osk-static",e.id=dn.ID,e.innerHTML=t.helpText}postInsert(){if(!this.element.parentElement||!document.getElementById(dn.ID))throw new Error("The HelpPage root element has not yet been inserted into the DOM.");this.kbd.hasScript&&this.kbd.embedScript(this.element.parentElement)}updateState(){}refreshLayout(){}get layoutHeight(){return x.inPercent(100)}};o(dn,"HelpPageView"),dn.ID="kmw-osk-help-page";var ai=dn;var Pr=class Pr{constructor(t,e,n){this.keySpec=n,this.centerX=n.proportionalX,this.centerY=e.proportionalY,this.width=n.proportionalWidth,this.height=t.rowProportionalHeight}};o(Pr,"CorrectiveBaseKeyLayout");var Or=Pr;function rg(a){return a.baseKeyID?C.isFrameKey(a.baseKeyID)?!1:!a.isPadding:!1}o(rg,"correctionKeyFilter");function zo(a,t){return{keys:a.row.map(e=>e.key.map(n=>new Or(a,e,n))).reduce((e,n)=>e.concat(n),[]).filter(e=>rg(e.keySpec)),kbdScaleRatio:t}}o(zo,"buildCorrectiveLayout");var cg={"*Shift*":8,"*Enter*":5,"*Tab*":6,"*BkSp*":4,"*Menu*":11,"*Hide*":10,"*Alt*":25,"*Ctrl*":1,"*Caps*":3,"*ABC*":16,"*abc*":17,"*123*":19,"*Symbol*":21,"*Currency*":20,"*Shifted*":9,"*AltGr*":2,"*TabLeft*":7,"*LAlt*":86,"*RAlt*":87,"*LCtrl*":88,"*RCtrl*":89,"*LAltCtrl*":96,"*RAltCtrl*":97,"*LAltCtrlShift*":98,"*RAltCtrlShift*":99,"*AltShift*":100,"*CtrlShift*":101,"*AltCtrlShift*":102,"*LAltShift*":103,"*RAltShift*":104,"*LCtrlShift*":105,"*RCtrlShift*":112,"*LTREnter*":5,"*LTRBkSp*":4,"*RTLEnter*":113,"*RTLBkSp*":114,"*ShiftLock*":115,"*ShiftedLock*":116,"*ZWNJ*":117,"*ZWNJiOS*":117,"*ZWNJAndroid*":118,"*ZWNJGeneric*":121,"*Sp*":128,"*NBSp*":130,"*NarNBSp*":131,"*EnQ*":132,"*EmQ*":133,"*EnSp*":134,"*EmSp*":135,"*PunctSp*":140,"*ThSp*":141,"*HSp*":142,"*ZWSp*":129,"*ZWJ*":119,"*WJ*":120,"*CGJ*":122,"*LTRM*":144,"*RTLM*":145,"*SH*":161,"*HTab*":162},jr=cg;var og=["default","shift","shift-on","special","special-on","","","","deadkey","blank","hidden"],ft=og;function Lt(a,t){switch(a){case"*ZWNJ*":a=t.device.OS==V.OperatingSystem.Android?"*ZWNJAndroid*":"*ZWNJiOS*";break;case"*Enter*":a=t.isRTL?"*RTLEnter*":"*LTREnter*";break;case"*BkSp*":a=t.isRTL?"*RTLBkSp*":"*LTRBkSp*";break;default:}let e=jr[a],n=57344+e;return e?String.fromCharCode(n):a}o(Lt,"renameSpecialKey");var ze=class ze{constructor(t,e){this.spec=t,this.layer=e}setButtonClass(){var i;let t=this.spec,e=this.btn;var n=0;typeof t.dk=="string"&&t.dk=="1"&&(n=8),n=(i=t.sp)!=null?i:n,(n<0||n>10)&&(n=0),e.className="kmw-key kmw-key-"+ft[n]}setToggleState(t){let e;switch(e=this.spec.sp,ft[e]){case"shift":case"shift-on":t===void 0&&(t=ft[e]=="shift"),this.spec.sp=1+(t?1:0);break;case"special":case"special-on":t===void 0&&(t=ft[e]=="special"),this.spec.sp=3+(t?1:0);break;default:return}this.setButtonClass()}isFrameKey(){let t=this.spec.sp||0;switch(ft[t]){case"default":case"deadkey":return!1;default:return!0}}allowsKeyTip(){return this.isFrameKey()?!1:!this.btn.classList.contains("kmw-spacebar")}highlight(t){var e=this.btn.classList;t?e.contains(ze.HIGHLIGHT_CLASS)||e.add(ze.HIGHLIGHT_CLASS):e.remove(ze.HIGHLIGHT_CLASS)}getIdealFontSize(t,e,n){if(!this._fontFamily)return new x("1em");n!=null||(n=1);let i=e.keyWidth,s=e.keyHeight,l=e.baseEmFontSize.scaledBy(e.layoutFontSize.val),r=this._fontSize;r.absolute||(r=l.scaledBy(r.val));let c={fontFamily:this._fontFamily,fontSize:r.styleString,height:e.keyHeight},g=Zs(t,l.scaledBy(n).val,c),d=.9,u=.9,I=2;var B;g.fontBoundingBoxAscent&&(B=g.fontBoundingBoxAscent+g.fontBoundingBoxDescent);let h=B!=null?B:0,b=i*d/(g.width+I),F=h&&s?s*u/h:void 0;var G=b;return F&&F<b&&(G=F),x.forScalar(n*Math.min(G,1))}get keyText(){let t=this.spec,e="ย",n=null;return t.text==null||t.text==""?n=e:(n=t.text,n=="*Tab*"&&this.layer=="shift"&&(n="*TabLeft*")),n}generateKeyText(t){let e=this.spec,n=document.createElement("span"),i=n.style;n.className="kmw-key-text";let s=this.keyText,l=Lt(s,t);l!=s&&(s=l,e.font="SpecialOSK"),typeof e.font=="string"&&e.font!=""&&(i.fontFamily=e.font),typeof e.fontsize=="string"&&e.fontsize!=""&&(i.fontSize=e.fontsize);let r={fontSize:i.fontSize};return i.fontFamily?r.fontFamily=i.fontFamily:r.fontFamily=t.fontFamily,t.isRTL&&(s="โ"+s),n.innerText=s,n}resetFontPrecalc(){this._fontFamily=void 0,this._fontSize=void 0,this.label.style.fontSize=""}detectStyles(t){if(!(this.spec.sp==J.spacer||this.spec.sp==J.blank)&&this._fontFamily===void 0){let e=getComputedStyle(this.label);if(!e.fontFamily)return;this._fontFamily=e.fontFamily;let n=new x(e.fontSize),i=t.layoutFontSize;if(i.absolute)this._fontSize=n;else{let s=t.baseEmFontSize,l=i.scaledBy(s.val),r=n.val/l.val;this._fontSize=x.forScalar(r)}}}refreshLayout(t){if(this.label)if(this.label.classList.contains("kmw-spacebar-caption")){let e=this.getIdealFontSize(this.keyText,t);this.label.style.setProperty("font-size",e.styleString,"important")}else{let e=this.label.textContent,n=this.getIdealFontSize(e,t);this.label.style.fontSize=n.styleString}}};o(ze,"OSKKey"),ze.specialCharacters=jr,ze.BUTTON_CLASSES=ft,ze.HIGHLIGHT_CLASS="kmw-key-touched";var Xe=ze;var _r=class _r{constructor(t,e){this.key=t,this.keyId=e}};o(_r,"KeyData");var un=_r;function As(a,t){let e=a;for(let n in t)e.hasOwnProperty(n)||(e[n]=t[n]);return e}o(As,"link");function ag(a){return a&&"key"in a&&a.key instanceof Xe}o(ag,"isKey");function Ws(a){return ag(a)?a:null}o(Ws,"getKeyFrom");var qr=class qr extends Xe{constructor(e,n,i){super(e,n);this.row=i}getId(){return this.spec.elementID}getCoreId(){return this.spec.coreID}getBaseId(){return this.spec.baseKeyID}generateKeyCapLabel(){var e=C.keyCodes[this.spec.baseKeyID];switch(e){case 186:e=59;break;case 187:e=61;break;case 188:e=44;break;case 189:e=45;break;case 190:e=46;break;case 191:e=47;break;case 192:e=96;break;case 219:e=91;break;case 220:e=92;break;case 221:e=93;break;case 222:e=39;break;default:(e<48||e>90)&&(e=0)}let n=document.createElement("div");return n.className="kmw-key-label",e>0&&(n.innerText=String.fromCharCode(e)),n}processSubkeys(e,n){var i,s=e.subKeys=this.spec.sk;for(i=0;i<s.length;i++){if(s[i].sp==1||s[i].sp==2){var l=s[i].text;s[i].text=Lt(l,n)}s[i].layer||(s[i].layer=e.key.layer)}}construct(e){let n=this.spec,i=document.createElement("div");i.className="kmw-key-square";let s=document.createElement("div"),l=this.btn=As(s,new un(this,n.id));this.setButtonClass();let r=this.capLabel=this.generateKeyCapLabel();l.appendChild(r),l.id=this.getId(),l.appendChild(this.label=this.generateKeyText(e)),typeof n.sk!="undefined"&&n.sk!=null?this.processSubkeys(l,e):l.subKeys=null;let c=this.generateHint(e);return l.appendChild(c),i.appendChild(l),this.preview=document.createElement("div"),this.preview.style.display="none",l.appendChild(this.preview),this.square=i}generateHint(e){let n=document.createElement("div");n.className="kmw-key-popup-icon";let i=this.spec.hintSrc;if(!i)return n;if(i.font&&i.font!="SpecialOSK"?n.style.fontFamily=i.font:n.classList.add("kmw-key-text"),i.fontsize){let r=new x(i.fontsize);n.style.fontSize=r.scaledBy(.5).styleString}let s=i==this.spec?this.spec.hint:i.text,l=Lt(s,e);return l=="โข"&&(n.style.fontWeight="bold"),s!=l&&(n.style.fontFamily="SpecialOSK"),n.textContent=l,n}setPreview(e){let n=this.preview;e?(this.previewHost=e,this.preview=this.previewHost.element):(this.previewHost=null,this.preview=document.createElement("div"),this.preview.style.display="none"),e==null||e.setCancellationHandler(()=>{this.setPreview(null)}),this.btn.replaceChild(this.preview,n)}refreshLayout(e){super.refreshLayout(e),e.baseEmFontSize.val<12?this.capLabel.style.fontSize="6px":this.capLabel.style.fontSize=x.forScalar(.5).styleString}get displaysKeyCap(){return this.capLabel&&this.capLabel.style.display=="block"}set displaysKeyCap(e){if(!this.capLabel)throw new Error("Key element not yet constructed; cannot display key cap");this.capLabel.style.display=e?"block":"none"}};o(qr,"OSKBaseKey");var gi=qr;var fs=.15,$r=class $r{constructor(t,e,n){let i=this.element=document.createElement("div");i.className="kmw-key-row",this.heightFraction=1/e.row.length;let s=n.key;this.spec=n,this.keys=[];for(let c=0;c<s.length;c++){let g=s[c];var l=new gi(g,e.id,this),r=l.construct(t);this.keys.push(l),i.appendChild(r)}}get displaysKeyCaps(){if(this.keys.length>0)return this.keys[0].displaysKeyCap}set displaysKeyCaps(t){for(let e of this.keys)e.displaysKeyCap=t}refreshLayout(t){let e=this.element.style,n=t.heightStyle.scaledBy(this.heightFraction);e.maxHeight=e.lineHeight=e.height=n.styleString;let i=t.heightStyle.absolute?n:x.forScalar(1),s=i.scaledBy(fs/2),l=i.scaledBy(1-fs);this.keys.forEach(r=>{let c=r.square,g=r.btn,d=c.style;d.height=d.minHeight=i.styleString;let u=g.style;u.top=s.styleString,u.height=u.lineHeight=u.minHeight=l.styleString})}buildKeyLayout(t,e){let n=t.widthStyle.scaledBy(e.spec.proportionalWidth),i=t.heightStyle.scaledBy(this.heightFraction).scaledBy(1-fs);return{keyWidth:n.val*(n.absolute?1:t.keyboardWidth),keyHeight:i.val*(i.absolute?1:t.keyboardHeight),baseEmFontSize:t.baseEmFontSize,layoutFontSize:t.layoutFontSize}}detectStyles(t){this.keys.forEach(e=>{e.detectStyles(this.buildKeyLayout(t,e))})}refreshKeyLayouts(t){this.keys.forEach(e=>{var u;let n=e.btn,i=t.widthStyle,s=t.heightStyle,l=i.scaledBy(e.spec.proportionalWidth),r=i.scaledBy(e.spec.proportionalPad),c=s.scaledBy(this.heightFraction).scaledBy(1-fs),g=s.absolute?c.styleString:"100%",d=this.buildKeyLayout(t,e);(u=n.key)==null||u.refreshLayout(d),e.square.style.width=l.styleString,e.square.style.marginLeft=r.styleString,e.btn.style.width=i.absolute?l.styleString:"100%",e.square.style.height=g})}};o($r,"OSKRow");var di=$r;var ec=class ec{get rowHeight(){return this._rowHeight}get id(){return this.spec.id}constructor(t,e,n){this.spec=n;let i=this.element=document.createElement("div"),s=i.style;i.className="kmw-key-layer";var l=n.row.length;l>4&&t.device.formFactor=="phone"&&(i.className=i.className+" kmw-5rows"),s.fontFamily="font"in e?e.font:"",this.nextlayer=n.id,i.layer=n.id,typeof n.nextlayer=="string"&&(i.nextLayer=this.nextlayer=n.nextlayer);let r=n.row;this.rows=[];for(let c=0;c<r.length;c++){let g=new di(t,n,r[c]);g.displaysKeyCaps=e.displayUnderlying,i.appendChild(g.element),this.rows.push(g)}if(t.device.touchable&&(this.globeKey=this.findKey("K_LOPT"),this.hideKey=this.findKey("K_ROPT")),this.spaceBarKey=this.findKey("K_SPACE"),this.capsKey=this.findKey("K_CAPS"),this.numKey=this.findKey("K_NUMLOCK"),this.scrollKey=this.findKey("K_SCROLL"),this.spaceBarKey){let c=this.spaceBarKey.label,g=this.spaceBarKey.btn;typeof g.className=="undefined"||g.className==""?g.className="kmw-spacebar":g.className.indexOf("kmw-spacebar")==-1&&(g.className+=" kmw-spacebar"),c.className!="kmw-spacebar-caption"&&(c.className="kmw-spacebar-caption")}}findKey(t){for(let e of this.rows)for(let n of e.keys)if(n.getBaseId()==t)return n;return null}showLanguage(t){if(this.spaceBarKey)try{let e=this.spaceBarKey.label;this.spaceBarKey.spec.text=t,(e.innerText!=t||t=="")&&(e.innerText=t)}catch(e){}}refreshLayout(t){this.rows.forEach(l=>l.detectStyles(t));let e=t.keyboardHeight,n=this.rows.length,i=this._rowHeight=Math.floor(e/(n==0?1:n)),s=t.widthStyle.absolute;s&&(this.element.style.height=e+"px"),this.showLanguage(t.spacebarText);for(let l=0;l<n;l++){let r=this.rows[l],c=(n-l-1)*i+1;s&&(this.spec.row[l].proportionalY=(e-c-i/2)/e),r.refreshLayout(t),l==n-1&&(r.element.style.bottom="1px")}for(let l of this.rows)l.refreshKeyLayouts(t)}};o(ec,"OSKLayer");var ui=ec;var gg=.06,tc=class tc{constructor(t,e,n){this._layers={};this._activeLayerId="default";let i=e.layout(n);this.spec=i,this.vkbd=t;let s=this.element=document.createElement("div"),l=s.style;if(s.className="kmw-key-layer-group",i==null)return;let r=i.fontsize;typeof r=="undefined"||r==null||r==""?l.fontSize="1em":l.fontSize=i.fontsize,l.width="100%",l.height="100%",this.activeLayerId="default"}buildLayer(t){let e=this.spec,n=e.getLayer(t);if(!n)return null;let i=new ui(this.vkbd,e,n);return this._layers[t]=i,this.element.appendChild(i.element),i}getLayer(t){let e=this._layers[t];return e||(e=this.buildLayer(t),e&&(this._layers[t]=e,e.element.style.display="none")),e}get activeLayer(){return this.activeLayerId?this._layers[this.activeLayerId]:null}get layers(){let e=this.spec.layer.map(n=>n.id);for(let n of e)this.buildLayer(n);return this._layers}get activeLayerId(){return this._activeLayerId}set activeLayerId(t){this._activeLayerId=t,this.getLayer(t);for(let e of Object.keys(this._layers)){let n=this._layers[e],i=n.element;n.id==t?i.style.display="block":i.style.display="none"}}findNearestKey(t){if(!t)return null;let e=t.stateToken;if(!e)throw new Error("Layer id not set for input coordinate");let n=this._layers[e];if(!n)throw new Error(`Layer id ${e} could not be found`);return this.nearestKey(t,n)}blinkLayer(t){if(typeof t=="string"){let n=t;if(t=this.getLayer(n),!t)throw new Error(`Layer id ${n} could not be found`)}let e=t;if(e.element.style.display!="block")for(let n in this._layers){if(this._layers[n].element.style.display=="block"){let i=this._layers[n];i.element.style.display="none"}this._layers[n].element.style.display="none"}e.element.style.display="block",Promise.resolve().then(()=>{let n=this._layers[this._activeLayerId];(e.element.style.display=="block"||n.element.style.display!="block")&&(e.element.style.display="none",n.element.style.display="block")})}nearestKey(t,e){if(e.rows.length==0)return null;let n={x:t.targetX/this.computedWidth,y:t.targetY/this.computedHeight};if(!isFinite(n.x)||!isFinite(n.y))return null;let i=Math.max(0,Math.min(e.rows.length-1,Math.floor(n.y*e.rows.length))),s=e.rows[i],l=null,r=Number.MAX_VALUE;for(let c of s.keys){let g=c.spec;if(g.sp==J.blank||g.sp==J.spacer)continue;let d=g.proportionalWidth/2,u=Math.abs(n.x-g.proportionalX);if(u-d<=0)return c.btn;{let I=u-d;I<r&&(r=I,l=c)}}return r<=gg?l.btn:null}resetPrecalcFontSizes(){for(let t of Object.values(this._layers))for(let e of t.rows)for(let n of e.keys)n.resetFontPrecalc();this._heightPadding=void 0}refreshLayout(t){if(!(isNaN(t.keyboardWidth)||isNaN(t.keyboardHeight))){if(this.computedWidth=t.keyboardWidth,this.computedHeight=t.keyboardHeight,this._heightPadding===void 0){let e=getComputedStyle(this.element),n=parseInt(e.paddingTop,10)||0,i=parseInt(e.paddingBottom,10)||0;this._heightPadding=n+i}this.activeLayer&&this.activeLayer.refreshLayout(t)}}get verticalPadding(){var t;return(t=this._heightPadding)!=null?t:0}};o(tc,"OSKLayerGroup");var Bi=tc;var Do="kmw-",Oo="top",nc=class nc{constructor(t,e){this.state=!1;this.orientation=Oo;this.vkbd=t;let n=this.element=document.createElement("div");n.className="kmw-keytip",n.id="kmw-keytip",n.style.pointerEvents="none",n.style.display="none",n.appendChild(this.tip=document.createElement("div")),n.appendChild(this.cap=document.createElement("div")),this.tip.appendChild(this.preview=document.createElement("div")),this.tip.className="kmw-keytip-tip",this.cap.className="kmw-keytip-cap",this.constrain=e,this.reorient=i=>{this.orientation=i,this.show(this.key,this.state,this.previewHost)}}show(t,e,n){var r;let i=this.vkbd;if(e&&i.layerGroup.blinkLayer(t.key.spec.displayLayer),e&&t.offsetParent){let c=t.key.row.element,g=t.getClientRects()[0],d=c.getClientRects()[0],u=g.left-d.left,I=g.width,B=g.height,h=1.8,b=this.element.style,G=i.topContainer.getBoundingClientRect(),U=t.getBoundingClientRect(),Q,p=this.orientation,X=U.bottom-G.top;Q=X+(p=="top"?1:-1);let R=Q-Math.floor(Q),L=I+Math.ceil(I*.3)*2,T=Math.ceil(2.3*B)+R;p=="bottom"&&(Q+=T-B),b.top="auto";let _e=p=="top"?"bottom":"top";this.tip.classList.remove(`${Do}${_e}`),this.tip.classList.add(`${Do}${p}`),b.bottom=Math.floor(G.height-Q)+"px",b.textAlign="center",b.overflow="visible",b.width=L+"px",b.height=T+"px";let Hi=this.vkbd.currentLayer.element.style.fontFamily,Ce=getComputedStyle(i.element);b.fontFamily=t.key.spec.font||Hi||Ce.fontFamily;var s=parseInt(Ce.fontSize,10);if(s==Number.NaN&&(s=0),s!=0){let $e={keyWidth:1.6*I,keyHeight:1.6*B,baseEmFontSize:i.getKeyEmFontSize(),layoutFontSize:new x(i.kbdDiv.style.fontSize)};b.fontSize=t.key.getIdealFontSize(t.key.keyText,$e,h).styleString}var l=(L-I)/2;u<l?(this.cap.style.left="1px",u+=l-1):u>window.innerWidth-I-l?(this.cap.style.left=L-I-1+"px",u-=l-1):this.cap.style.left=l+"px",b.left=u-l+"px";let Je=getComputedStyle(this.element),Un=G.height,ht=parseFloat(Je.bottom),xn=parseFloat(Je.height),qe=Math.ceil(T/2);this.cap.style.width=I+"px",this.tip.style.height=qe+"px";let kt=3,Zn=qe-kt+"px";p=="top"?(this.cap.style.top=Zn,this.cap.style.bottom=""):(this.cap.style.top="",this.cap.style.bottom=Zn);let Xn=X-Math.floor(Q)+T-(p=="top"?qe:-kt*2);if(this.cap.style.height=Xn+"px",this.constrain&&xn+ht>Un){let $e=xn+ht-Un;b.height=T-$e+"px";let la=Math.max(0,T-$e-T/2+2);this.cap.style.height=la+"px"}else ht<0&&(b.bottom="0px",this.cap.style.height=Math.max(0,Xn+ht)+"px");if(b.display="block",this.previewHost==n)return;let ke=this.preview;this.previewHost&&this.previewHost.off("preferredOrientation",this.reorient),this.previewHost=n,n&&(this.previewHost.on("preferredOrientation",this.reorient),this.preview=this.previewHost.element,this.tip.replaceChild(this.preview,ke),n.setCancellationHandler(()=>this.show(null,!1,null)),n.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",(r=this.previewHost)==null||r.off("preferredOrientation",this.reorient),this.previewHost=null;let c=this.preview;this.preview=document.createElement("div"),this.tip.replaceChild(this.preview,c),this.element.classList.remove("kmw-preview-fade"),this.orientation=Oo}this.key=t,this.state=e}};o(nc,"KeyTip");var Ii=nc;var ic="kmw-keypreview",dg="kmw-preview-overlay",ug="kmw-keytip",sc=class sc{constructor(t){this.state=!1;this.vkbd=t;let e=this.element=document.createElement("div");e.className=ic,e.id="kmw-keytip",e.style.pointerEvents="none",e.style.display="none",this.preview=document.createElement("div"),e.appendChild(this.preview)}show(t,e,n){let i=this.vkbd,s=t==null?void 0:t.key.spec.displayLayer;if(e&&i.layerGroup.blinkLayer(s),e&&(t!=null&&t.offsetParent)){let l=this.vkbd.topContainer.getBoundingClientRect(),r=t.getBoundingClientRect(),c=s!=i.layerId?dg:"";this.element.className=`${ic} ${t.className} ${c}`,this.element.id=`${ug}-${t.id}`;let g=this.element.style,d=this.vkbd.currentLayer.element.style.fontFamily;if(g.fontFamily=t.key.spec.font||d,g.left=r.left-l.left+"px",g.top=r.top-l.top+"px",g.width=r.width+"px",g.height=r.height+"px",this.element.style.display="block",this.previewHost==n)return;let u=this.preview;this.previewHost=n,n&&(this.preview=this.previewHost.element,this.element.replaceChild(this.preview,u),n.setCancellationHandler(()=>this.show(null,!1,null)),n.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",this.element.className=ic,this.previewHost=null;let l=this.preview;this.preview=document.createElement("div"),this.element.replaceChild(this.preview,l),this.element.classList.remove("kmw-preview-fade")}this.key=t,this.state=e}};o(sc,"TabletKeyTip");var Ls=sc;function Se(a){try{if(a=="desktop")return 1;var t=document.documentElement.clientWidth;if(screen.width>t)return 1;var e=screen.width;return be()?screen.width<screen.height&&(e=screen.height):screen.width>screen.height&&(e=screen.height),Math.round(100*e/t)/100}catch(n){return 1}}o(Se,"getViewportScale");var Rt=class Rt{constructor(t,e){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.deleteRepeater=o(()=>{this.repeatClosure(),this.timerHandle=window.setTimeout(this.deleteRepeater,Rt.REPEAT_DELAY)},"deleteRepeater");this.source=t;let n=t.stageReports[0].item;n.key.highlight(!0),this.repeatClosure=()=>{e(),n.key.highlight(!0)},this.timerHandle=window.setTimeout(this.deleteRepeater,Rt.INITIAL_DELAY),this.source.on("complete",()=>{window.clearTimeout(this.timerHandle),this.timerHandle=void 0,n.key.highlight(!1)})}cancel(){this.deleteRepeater(),this.source.cancel()}currentStageKeyDistribution(){return null}};o(Rt,"HeldRepeater"),Rt.INITIAL_DELAY=500,Rt.REPEAT_DELAY=100;var Rs=Rt;var lc=class lc extends Xe{constructor(t,e){if(typeof e!="string"||e=="")throw"The 'layer' parameter for subkey construction must be properly defined.";super(t,e)}getId(){return"popup-"+this.spec.elementID}construct(t,e,n,i){let s=this.spec,l=document.createElement("div"),r=l.style;l.className="kmw-key-square-ex",i&&(r.marginTop="5px"),r.width=n+"px",r.height=e.offsetHeight+"px";let c=document.createElement("div"),g=this.btn=As(c,new un(this,s.id));this.setButtonClass(),g.id=this.getId();let d=g.style;return d.height=r.height,d.lineHeight=e.style.lineHeight,d.width=r.width,d.position="absolute",g.appendChild(this.label=this.generateKeyText(t)),l.appendChild(g),this.square=l}allowsKeyTip(){return!1}};o(lc,"OSKSubKey");var bi=lc;var Po=.2,Bg=1.2,_o=3,Bn=5,jo=6+_o,rc=class rc{constructor(t,e,n,i,s){this.directlyEmitsKeys=!0;this.shouldLockLayer=!1;var U;this.baseKey=i,this.source=t,this.gestureParams=s,n.layerLocked&&(this.shouldLockLayer=!0),t.on("complete",()=>{var Q;(Q=this.currentSelection)==null||Q.key.highlight(!1),this.clear()}),t.on("stage",()=>{let Q=this.currentSelection;if(Q){let p=n.keyEventFromSpec(Q.key.spec);p.keyDistribution=this.currentStageKeyDistribution(),n.raiseKeyEvent(p,Q)}});let l=t.stageReports[0].sources[0].constructSubview(!0,!1);l.path.on("step",Q=>{var p,X;l.path.stats.netDistance>=4&&((p=this.currentSelection)==null||p.key.highlight(!1),(X=Q.item)==null||X.key.highlight(!0),this.currentSelection=Q.item)}),this.currentSelection=i,i.key.highlight(!0);let r=i.subKeys,c=this.element=document.createElement("div");c.id="kmw-popup-keys";var g=c.style;g.fontFamily=n.fontFamily;let d=getComputedStyle(i);g.fontSize=d.fontSize,g.visibility="hidden";let u=i.key.layer;(typeof u!="string"||u=="")&&(u=n.layerId);let I=r.length,B=Math.ceil(I/9),h=Math.ceil(I/B);this.subkeys=[];let b=Bn,F=0;for(let Q=0,p=0;Q<I;Q++,p++){let X=typeof r[Q].width!="undefined"?r[Q].width*i.offsetWidth/100:i.offsetWidth;X>n.width-2*Bn&&(X=n.width-2*Bn),(b+X+Bn>n.width||p>=h)&&(F++,p=0,b=Bn);let L=new bi(r[Q],u).construct(n,i,X,F>0);b+=X+Bn,this.menuWidth=Math.max((U=this.menuWidth)!=null?U:0,b),this.subkeys.push(L.firstChild),c.appendChild(L)}g.width=this.menuWidth+"px",this.shim=document.createElement("div"),this.shim.id="kmw-popup-shim",n.device.formFactor==V.FormFactor.Phone&&this.selectDefaultSubkey(i,c),n.element.appendChild(this.element),n.topContainer.appendChild(this.shim),this.reposition(n);let G=this.buildPopupRecognitionConfig(n);e({type:"push",config:G})}buildPopupRecognitionConfig(t){let e=this.element.getBoundingClientRect(),n=this.baseKey.getBoundingClientRect(),i=this.subkeys[0].style,l=-.666*Number.parseInt(i.height,10),r=3,c=n.bottom-e.bottom,g=new ue(this.element,[l*r,l,-c<l?-c:l]),d={getBoundingClientRect(){let u=Number.MAX_SAFE_INTEGER;return new DOMRect(-u,-u,2*u,2*u)}};return{targetRoot:this.element,inputStartBounds:t.element,maxRoamingBounds:d,safeBounds:d,itemIdentifier:(u,I)=>{let B=g.getBoundingClientRect(),h=null,b=Number.MAX_VALUE,F=Number.MAX_VALUE;if(u.clientX<B.left||u.clientX>B.right||u.clientY<B.top||u.clientY>B.bottom)return null;for(let G of this.subkeys){let U=G.getBoundingClientRect(),Q=Number.MAX_VALUE,p=Number.MAX_VALUE;if(U.left<=u.clientX&&u.clientX<U.right?Q=0:Q=U.left>=u.clientX?U.left-u.clientX:u.clientX-U.right,U.top<=u.clientY&&u.clientY<U.bottom?p=0:p=U.top>=u.clientY?U.top-u.clientY:u.clientY-U.bottom,Q==0&&p==0)return G;(Q<F||Q==F&&p<b)&&(F=Q,h=G,b=p)}return h}}}reposition(t){let e=this.element,n=this.baseKey,i=t.topContainer,s=n.key.row.element,l=e.style,r=n.offsetParent?n.offsetParent.offsetLeft:0;var c=n.offsetLeft+r+.5*(n.offsetWidth-e.offsetWidth),g=t.width-e.offsetWidth;c>g&&(c=g),c<0&&(c=0),l.left=c+"px";let d=i.getBoundingClientRect(),u=s.getBoundingClientRect();l.top=u.top-d.top-e.offsetHeight-_o+"px",l.visibility="visible";let I=t.isEmbedded,B=getComputedStyle(e),h=parseFloat(B.top),b=0,F=0;h<b&&I&&(F=b-h,l.top=b+"px"),this.callout=this.addCallout(n,F,t.element,t.topContainer,t.device.formFactor=="tablet")}addCallout(t,e,n,i,s){e=e||0;let l=getComputedStyle(this.element),r=Math.max(Number.parseInt(l.borderRadius),0),c=t.getBoundingClientRect(),g=i.getBoundingClientRect(),d=Math.floor(Number.parseInt(l.top,10)+Number.parseInt(l.height,10)+Number.parseInt(l.paddingTop,10)/2+Number.parseInt(l.paddingBottom,10)),u=Po*(c.height-e),I=Po*c.height,B=u+jo,h=B/(I+jo),b=c.bottom-g.top-d-1,F=b<B?b:B;if(F>0){let G=document.createElement("div"),U=G.style;G.id="kmw-popup-callout",n.appendChild(G),U.top=d+"px",U.borderTopWidth=F+"px";let Q=Bg*h,p=c.width*Q,X=this.menuWidth-2*r,R=X<p?X:p,L=c.left-g.left-(R-c.width)/2,T=Math.max(0,L+R-(g.right-r)),_e=Math.max(0,r-L);return U.left=c.left-g.left-(R-c.width)/2+_e+"px",U.borderLeftWidth=R/2-_e+"px",U.borderRightWidth=R/2-T+"px",G}else return null}selectDefaultSubkey(t,e){var s;var n;let i=t.subKeys;for(let l=0;l<i.length;l++){let r=i[l],c=e.childNodes[l].firstChild;if(r.default){n=c;break}else if(!t.key||!t.key.spec)continue;r.elementID==t.key.spec.elementID&&(n=c)}n&&((s=this.currentSelection)==null||s.key.highlight(!1),this.currentSelection=n,n.key.highlight(!0))}get hasModalVisualization(){return this.element.style.visibility=="visible"}buildCorrectiveLayout(){let t=this.element.getBoundingClientRect(),e=t.width/t.height;return{keys:this.subkeys.map(i=>{let s=i.getBoundingClientRect();return{keySpec:i.key.spec,centerX:(s.right-s.width/2-t.left)/t.width,centerY:(s.bottom-s.height/2-t.top)/t.height,width:s.width/t.width,height:s.height/t.height}}),kbdScaleRatio:e}}currentStageKeyDistribution(){let t=this.source.stageReports[this.source.stageReports.length-1],e=this.source.stageReports[0],n=t.sources[0],i=n.currentSample,s=this.element.getBoundingClientRect(),l={x:i.targetX/s.width,y:i.targetY/s.height};l.x=l.x<0?0:l.x>1?1:l.x,l.y=l.y<0?0:l.y>1?1:l.y;let r=ps(l,this.buildCorrectiveLayout()),c=r.get(i.item.key.spec),g=Math.min(n.path.stats.duration-e.sources[0].path.stats.duration,this.gestureParams.longpress.waitLength)/(2*this.gestureParams.longpress.waitLength),d=Math.min(n.path.stats.rawDistance,this.gestureParams.longpress.noiseTolerance*4)/(this.gestureParams.longpress.noiseTolerance*8),u=Math.min(g*g,d*d),I=c+u,B=new Map,h=this.subkeys.find(b=>b.keyId==this.baseKey.keyId);return h?B.set(h.key.spec,I):B.set(this.baseKey.key.spec,I),dt([r,B])}cancel(){this.clear(),this.source.cancel()}clear(){this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.shim.parentNode&&this.shim.parentNode.removeChild(this.shim),this.callout&&this.callout.parentNode&&this.callout.parentNode.removeChild(this.callout)}};o(rc,"SubkeyPopup");var In=rc;var cc=class cc{constructor(t,e,n){this.directlyEmitsKeys=!0;this.shouldRestore=!1;this.hasModalVisualization=!1;let i=t.stageReports[0];this.originalLayer=i.sources[0].stateToken,this.source=t,this.completionCallback=()=>{e.lockLayer(!1),this.shouldRestore&&(e.layerId=this.originalLayer,e.updateState()),n==null||n()},e.lockLayer(!0),t.on("stage",s=>{let l=s.matchedId;l.includes("modipress")&&l.includes("-end")?this.clear():l.includes("modipress")&&l.includes("-hold")&&(this.shouldRestore=!0)}),t.on("complete",()=>this.cancel())}get isLocked(){return this.shouldRestore}setLocked(){this.shouldRestore=!0}get completed(){return this.completionCallback===null}clear(){let t=this.completionCallback;this.completionCallback=null,t==null||t()}cancel(){this.clear(),this.source.cancel()}currentStageKeyDistribution(t){return null}};o(cc,"Modipress");var ut=cc;var oc=class oc{constructor(t,e,n,i,s){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.tapIndex=0;this.baseKey=n,this.baseContextToken=i,this.multitaps=[n.key.spec].concat(n.key.spec.multitap),this.sequence=t;let l=o(u=>{var B;(B=this.modipress)==null||B.clear();let I=new ut(t,e,()=>{this.modipress=e.activeModipress=null});this.modipress=e.activeModipress=I},"startModipress");this.originalLayer=e.layerId;let r=o(u=>(this.tapIndex+u)%this.multitaps.length,"tapLookahead"),c=o(()=>{s==null||s.setMultitapHint(this.multitaps[r(0)],this.multitaps[r(1)],e)},"updatePreview");t.on("complete",()=>{var u;(u=this.modipress)==null||u.cancel(),this.clear()});let g=o(u=>{var F;switch(u.matchedId){case"modipress-hold":this.clear(),t.off("stage",g);return;case"modipress-end-multitap-transition":case"modipress-multitap-end":case"modipress-end":case"multitap-end":case"simple-tap":return;case"modipress-multitap-lock-transition":(F=this.modipress)==null||F.setLocked();return;case"modipress-multitap-start":case"multitap-start":break;default:throw new Error(`Unsupported gesture state encountered during multitap: ${u.matchedId}`)}this.tapIndex=r(1);let I=this.multitaps[this.tapIndex];c();let B=e.keyEventFromSpec(I);B.baseTranscriptionToken=this.baseContextToken;let h=u.sources[0].currentSample,b=e.getSimpleTapCorrectionDistances(h,this.baseKey.key.spec);if(h.stateToken!=e.layerId&&!u.matchedId.includes("modipress")){let G=e.layerGroup.findNearestKey(A(y({},h),{stateToken:e.layerId})),U=b.get(G.key.spec);U==null&&console.warn("Could not find current layer's key"),b.delete(G.key.spec),b.set(h.item.key.spec,U)}B.keyDistribution=this.currentStageKeyDistribution(b),B.kNextLayer||(B.kNextLayer=this.originalLayer),e.raiseKeyEvent(B,null),u.matchedId=="modipress-multitap-start"&&l(u)},"stageHandler");t.on("stage",g),t.stageReports[0].matchedId=="modipress-start"&&l(t.stageReports[0]),c()}currentStageKeyDistribution(t){let e=dt(t),n=e.findIndex(c=>c.keySpec==this.baseKey.key.spec);if(n==-1)return li(this.baseKey)||console.warn("Could not find base key's probability for multitap correction"),e;let i=e.splice(n,1)[0].p,s=0,l=[];for(let c=0;c<this.multitaps.length;c++){let g=this.multitaps[c],d=Math.abs(c-this.tapIndex)%this.multitaps.length,u=(c+this.multitaps.length-this.tapIndex)%this.multitaps.length,I=d<u?d:u,B=1/((1+I)*(1+I));s+=B,l.push({keySpec:g,p:B})}let r=i/s;return l.forEach(c=>{c.p=r*c.p}),e.concat(l).sort((c,g)=>g.p-c.p)}cancel(){this.clear(),this.sequence.cancel()}clear(){}};o(oc,"Multitap");var hi=oc;var Fi=1.4142,ac=o(a=>Math.abs(a)<1e-10?0:a,"coerceZeroes"),gc=class gc extends S.default{constructor(e,n,i,s){var I;super();this.flickPreviews=new Map;this.orientation="top";let l=e.key.spec,r=this.flickEdgeLength=Math.max(i,s),c=this.div=document.createElement("div");c.className=c.id="kmw-gesture-preview",c.style.pointerEvents="none";let g=this.previewImgContainer=document.createElement("div");this.previewImgContainer.id="kmw-preview-img-container";let d=this.label=document.createElement("span");if(d.className="kmw-gesture-base-label kmw-key-text",d.id="kmw-gesture-base-label",g.appendChild(d),d.textContent=e.key.label.textContent,this.div.appendChild(this.previewImgContainer),l.flick){let B=l.flick||{};Object.keys(B).forEach(h=>{let b=document.createElement("div");b.className="kmw-flick-preview kmw-key-text",b.textContent=B[h].text;let F=b.style,G=kr.get(h),U=ac(-Math.sin(G[0])),Q=ac(Math.cos(G[0]));F.width="100%",F.textAlign="center",U<0?F.right=-U*Fi*r+"px":U>0?F.left=U*Fi*r+"px":F.left="0px",F.height="100%",F.lineHeight="100%",Q<0?F.bottom=-Q*Fi*r+"px":Q>0?F.top=Q*Fi*r+"px":F.top="0px",this.flickPreviews.set(h,b),g.appendChild(b)})}let u=this.hintLabel=document.createElement("div");u.className="kmw-key-popup-icon",n||(u.textContent=l==l.hintSrc?l.hint:(I=l.hintSrc)==null?void 0:I.text,u.style.fontWeight=u.textContent=="โข"?"bold":""),c.appendChild(u)}get element(){return this.div}refreshLayout(){let e=getComputedStyle(this.div),n=Number.parseInt(e.height,10);this.flickPreviews.forEach(i=>{i.style.lineHeight=i.style.height=`${n}px`})}cancel(){var e;(e=this.onCancel)==null||e.call(this),this.onCancel=null}setCancellationHandler(e){this.onCancel=e}setMultitapHint(e,n,i){var r,c;let s=Lt(e.text,i),l=Lt(n.text,i);this.label.textContent=s,this.hintLabel.textContent=l,this.label.style.fontFamily=s!=e.text?"SpecialOSK":(r=e.font)!=null?r:this.label.style.fontFamily,this.hintLabel.style.fontFamily=l!=n.text?"SpecialOSK":(c=n.font)!=null?c:this.hintLabel.style.fontFamily,this.emit("startFade"),this.clearFlick()}scrollFlickPreview(e,n){this.clearHint();let i=this.previewImgContainer.style,s=this.flickEdgeLength*Fi;i.marginLeft=`${s*e}px`,i.marginTop=`${s*n}px`;let l=ac(n)<0?"bottom":"top";this.orientation!=l&&(this.orientation=l,this.emit("preferredOrientation",l))}clearFlick(){this.previewImgContainer.style.marginTop="0px",this.previewImgContainer.style.marginLeft="0px",this.previewImgContainer.classList.add("kmw-flick-clear")}clearHint(){this.hintLabel.classList.add("kmw-hint-clear")}clearAll(){this.clearFlick()}};o(gc,"GesturePreviewHost");var vs=gc;var qo=et.TIER!="stable"||et.VERSION_ENVIRONMENT!="",Ig=qo?10:0,mi=class mi extends S.default{constructor(e){var g,d,u;super();this.layerLocked=!1;this.layerIndex=0;this.isStatic=!1;this._fixedWidthScaling=!1;this._fixedHeightScaling=!0;this._borderWidth=0;this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.activeGestures=[];this.activeModipress=null;this.repeatDelete=function(){this.deleting&&(this.modelKeyClick(this.deleteKey),this.deleting=window.setTimeout(this.repeatDelete,100))}.bind(this);this.config=e,this.config.device=e.device||e.hostDevice,this.config.isEmbedded=e.isEmbedded||!1,e.isStatic&&(this.isStatic=e.isStatic),(g=this.config).gestureParams||(g.gestureParams=y({},si)),this._fixedWidthScaling=this.device.touchable&&!this.isStatic,this._fixedHeightScaling=this.device.touchable&&!this.isStatic;var n=document.createElement("div");this.config.styleSheetManager=e.styleSheetManager||new ge(n);let i;if(e.keyboard)i=this.kbdLayout=e.keyboard.layout(e.device.formFactor),this.layoutKeyboardProperties=e.keyboardMetadata,this.isRTL=e.keyboard.isRTL;else{let I=E.buildDefaultLayout(null,null,e.device.formFactor);i=this.kbdLayout=wt.polyfill(I,null,e.device.formFactor),this.layoutKeyboardProperties=null,this.isRTL=!1}"font"in i?this.fontFamily=i.font:this.fontFamily="";let s=e.device.formFactor;this.layoutKeyboard=e.keyboard,this.layoutKeyboard||(this.layoutKeyboard=new Y(null)),this.layerGroup=new Bi(this,this.layoutKeyboard,s),this.layoutKeyboard.markLayoutCalibrated(s),n.appendChild(this.layerGroup.element),this.kbdDiv=n,this.isStatic||(this.gestureEngine=this.constructGestureEngine()),n.classList.add(e.device.formFactor,"kmw-osk-inner-frame");let l=(u=(d=this.layoutKeyboard)==null?void 0:d.id.replace("Keyboard_",""))!=null?u:"",r=l.indexOf("::");r!=-1&&(l=l.substring(r+2));let c="kmw-keyboard-"+l;this.element.classList.add(c)}get gestureParams(){return this.config.gestureParams}get layerId(){var e,n;return(n=(e=this.layerGroup)==null?void 0:e.activeLayerId)!=null?n:"default"}set layerId(e){let n=e!=this.layerId;if(this.layerGroup.getLayer(e))this.layerGroup.activeLayerId=e,this.gestureEngine&&(this.gestureEngine.stateToken=e);else throw new Error(`Keyboard ${this.layoutKeyboard.id} does not have a layer with id ${e}`);n&&!this.deferLayout&&(this.updateState(),this.layerGroup.refreshLayout(this.constructLayoutParams()))}get currentLayer(){var e;return(e=this.layerGroup)==null?void 0:e.activeLayer}get lgKey(){var e,n;return(n=(e=this.currentLayer)==null?void 0:e.globeKey)==null?void 0:n.btn}get hkKey(){var e,n;return(n=(e=this.currentLayer)==null?void 0:e.hideKey)==null?void 0:n.btn}get spaceBar(){var e,n;return(n=(e=this.currentLayer)==null?void 0:e.spaceBarKey)==null?void 0:n.btn}constructGestureEngine(){let e={targetRoot:this.element,mouseEventRoot:document.body,maxRoamingBounds:new ue(this.topContainer,[NaN]),itemIdentifier:(r,c)=>this.layerGroup.findNearestKey(r),recordingMode:qo,historyLength:Ig},n=new At(Er(this.kbdLayout,this.gestureParams),e);n.stateToken=this.layerId;let i={},s=o(r=>{for(let c of Object.keys(i)){if(c==r)continue;i[c].source.terminate(!0)}},"clearActiveGestures"),l=new Map;return n.on("inputstart",r=>{var u;let c=this.highlightKey(r.currentSample.item,!0);c&&((u=this.gesturePreviewHost)==null||u.cancel(),this.gesturePreviewHost=c),i[r.identifier]={source:r,roamingHighlightHandler:null,key:r.currentSample.item,previewHost:c};let g=i[r.identifier],d=o(()=>{ae(0).then(()=>{let I=g.previewHost;I&&(I.cancel(),this.gesturePreviewHost=null,g.previewHost=null),g.key&&(this.highlightKey(g.key,!1),g.key=null)})},"endHighlighting");g.roamingHighlightHandler=I=>{var b;let B=I.item,h=i[r.identifier].key;if(!this.kbdLayout.hasFlicks&&B!=h){this.highlightKey(h,!1),(b=this.gesturePreviewHost)==null||b.cancel(),this.gesturePreviewHost=null,g.previewHost=null;let F=this.highlightKey(B,!0);F&&(this.gesturePreviewHost=F,g.previewHost=F),i[r.identifier].key=B}},r.path.on("invalidated",d),r.path.on("complete",d),r.path.on("step",g.roamingHighlightHandler)}),n.on("recognizedgesture",r=>{var c;(c=this.activeModipress)==null||c.setLocked(),r.on("complete",()=>{var g;for(let d of r.allSourceIds)(g=i[d])!=null&&g.previewHost&&(this.gesturePreviewHost=null,i[d].previewHost.cancel()),delete i[d]}),r.on("stage",(g,d)=>{let u=r.allSourceIds.map(p=>{var X;return(X=i[p])==null?void 0:X.previewHost}).find(p=>!!p),I=o(()=>{u&&(u.cancel(),this.gesturePreviewHost=null)},"clearPreviewHost"),B=l.get(r);!B&&u&&!g.matchedId.includes("flick")&&u.clearFlick();let h;for(let p of g.allSourceIds){let X=o(R=>{R.key&&(this.highlightKey(R.key,!1),R.key=null),R.source.path.off("step",R.roamingHighlightHandler)},"clearRoaming");if(h=i[p],h)X(h);else{let R=p;ae(0).then(()=>{let L=i[R];L&&X(L)})}}let b=g.item,F=g.sources[0],G=F?F.currentSample:null,U=null;if(b&&!(B&&B[0].directlyEmitsKeys)){let p,X=this.getSimpleTapCorrectionDistances(F.currentSample,b.key.spec);B&&(p=B[0].currentStageKeyDistribution(X)),p||(p=dt(X));let R=!this.layerLocked&&B&&B[0]instanceof In&&B[0].shouldLockLayer;try{R&&this.lockLayer(!0),U=this.modelKeyClick(g.item,G,p)}finally{R&&this.lockLayer(!1)}}if(r.stageReports.length>1&&g.matchedId!="modipress-end")return;let Q=r.stageReports[0].item;if(g.matchedId=="special-key-start")b.key.spec.baseKeyID=="K_BKSP"?(I(),B=[new Rs(r,()=>this.modelKeyClick(b,G))]):b.key.spec.baseKeyID=="K_LOPT"&&(r.on("complete",()=>{b.key.highlight(!1),this.emit("globekey",b,!1)}),s(F.identifier),b.key.highlight(!0));else if(g.matchedId.indexOf("longpress")>-1)I(),B=[new In(r,d,this,r.stageReports[0].sources[0].baseItem,this.gestureParams)];else if(Q!=null&&Q.key.spec.multitap&&(g.matchedId=="initial-tap"||g.matchedId=="multitap"||g.matchedId=="modipress-start"))h.previewHost=null,r.on("complete",()=>{I()}),B=[new hi(r,this,Q,U.contextToken,u)];else if(g.matchedId.indexOf("flick")>-1)B=[new ni(r,d,this,r.stageReports[0].sources[0].baseItem,this.gestureParams,u)];else if(g.matchedId.includes("modipress")&&g.matchedId.includes("-start"))if(I(),this.layerLocked)console.warn("Unexpected state:  modipress start attempt during an active modipress");else{B||(B=[]);let p=new ut(r,this,()=>{let X=B.indexOf(p);X>-1&&B.splice(X,1),this.activeModipress=null});B.push(p),this.activeModipress=p}else I();B&&(this.activeGestures=this.activeGestures.concat(B),l.set(r,B),r.on("complete",()=>{let p=this.activeGestures.filter(X=>B.includes(X));this.activeGestures=this.activeGestures.filter(X=>!B.includes(X)),p.forEach(X=>{X instanceof ut&&X.cancel()})}))})}),n}get element(){return this.kbdDiv}get device(){return this.config.device}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get styleSheetManager(){return this.config.styleSheetManager}get topContainer(){return this.config.topContainer}get isEmbedded(){return this.config.isEmbedded}postInsert(){}get width(){return this._width}get height(){return this._height}get layoutWidth(){if(this.usesFixedWidthScaling){let e=this.width;return e-=this._borderWidth*2,x.inPixels(e)}else return x.forScalar(1)}get layoutHeight(){if(this.usesFixedHeightScaling){let e=this.height;return e-=this._borderWidth*2,x.inPixels(e)}else return x.forScalar(1)}get internalHeight(){return this.usesFixedHeightScaling?x.inPixels(this.layoutHeight.val-this._borderWidth*2-this.layerGroup.verticalPadding):x.forScalar(1)}get fontSize(){return this._fontSize||(this._fontSize=new x("1em")),this._fontSize}set fontSize(e){this._fontSize=e,this.kbdDiv.style.fontSize=e.styleString}get usesFixedWidthScaling(){return this._fixedWidthScaling}set usesFixedWidthScaling(e){this._fixedWidthScaling=e}get usesFixedHeightScaling(){return this._fixedHeightScaling}set usesFixedHeightScaling(e){this._fixedHeightScaling=e}get usesFixedPositioning(){let e=this.element;for(;e;){if(getComputedStyle(e).position=="fixed")return!0;e=e.offsetParent}return!1}setSize(e,n,i){this._width=e,this._height=n,this.kbdDiv&&(this.kbdDiv.style.width=e?this._width+"px":"",this.kbdDiv.style.height=n?this._height+"px":"",!this.device.touchable&&n&&(this.fontSize=new x(this._height/8+"px")),i||this.refreshLayout())}getTouchCoordinatesOnKeyboard(e){let n={x:e.targetX,y:e.targetY};return n.x/=this.layerGroup.element.offsetWidth,n.y/=this.kbdDiv.offsetHeight,n}getSimpleTapCorrectionDistances(e,n){let i=this.getTouchCoordinatesOnKeyboard(e),l=this.layerGroup.element.offsetWidth,r=this.kbdDiv.offsetHeight;if(!l||!r)return new Map;let c=l/r,g=zo(this.kbdLayout.getLayer(this.layerId),c);return ps(i,g)}keyTarget(e){let n=e;try{if(n){if(n.classList.contains("kmw-key"))return Ws(n);if(n.parentNode&&n.parentNode.classList.contains("kmw-key"))return Ws(n.parentNode);if(n.firstChild&&n.firstChild.classList.contains("kmw-key"))return Ws(n.firstChild)}}catch(i){}return null}cancelDelete(){this.deleting&&window.clearTimeout(this.deleting),this.deleting=0}modelKeyClick(e,n,i){let s=this.initKeyEvent(e);return n&&(s.source=n),i&&(s.keyDistribution=i),this.raiseKeyEvent(s,e)}initKeyEvent(e){this.highlightKey(e,!1);let n=e.key?e.key.spec:null;return n?this.keyEventFromSpec(n):null}keyEventFromSpec(e){let n=this.layoutKeyboard.constructKeyEvent(e,this.device,this.stateKeys);return n.srcKeyboard=this.layoutKeyboard,n}_UpdateVKShiftStyle(e){var r;var n;e||(e=this.layerId);let i=this.layerGroup.getLayer(e);if(!i||(this.gestureEngine&&(this.gestureEngine.stateToken=e),!((r=this.layoutKeyboard)!=null&&r.usesDesktopLayoutOnDevice(this.device))))return;let s=["K_CAPS","K_NUMLOCK","K_SCROLL"],l=[i.capsKey,i.numKey,i.scrollKey];for(n=0;n<l.length;n++)l[n]!=null&&l[n].setToggleState(this.stateKeys[s[n]])}updateStateKeys(e){for(let n of Object.keys(this.stateKeys))this.stateKeys[n]=e[n];this._UpdateVKShiftStyle()}highlightKey(e,n){if(!e||!e.key||e.className==""||e.className.indexOf("kmw-key-row")>=0)return null;let i=e.key.allowsKeyTip();return n=this.activeGestures.find(l=>l.hasModalVisualization)?!1:n,e.key.highlight(n),n&&i?this.gesturePreviewHost?null:this.showGesturePreview(e):null}getKeyEmFontSize(){if(!this.fontSize)return new x("0px");if(this.device.formFactor=="desktop"){let e=.8;return this.fontSize.scaledBy(e)}else{let e=getComputedStyle(document.body).fontSize,n=new x(e),i=1;if(!this.isStatic){if(this.fontSize.absolute)return this.fontSize;i=this.fontSize.val}return n.scaledBy(i)}}updateState(){this.currentLayer&&(this.nextLayer=this.layerId,this.currentLayer.nextlayer&&(this.nextLayer=this.currentLayer.nextlayer),this.layerGroup.activeLayerId=this.layerId,this._UpdateVKShiftStyle())}refreshLayout(){if(this.deferLayout)return;let e=this.device;var n=1;e.OS==V.OperatingSystem.iOS&&!this.isEmbedded&&(n=n/Se(this.device.formFactor));let i=this.kbdDiv.style;this.usesFixedHeightScaling&&this.height&&(i.height=i.maxHeight=this.height+"px"),i.fontSize=this.fontSize.scaledBy(n).styleString;let s=this.width&&this.height,l=getComputedStyle(this.kbdDiv),r=getComputedStyle(this.layerGroup.element),c=l.height!=""&&l.height!="auto",g=r.height!=""&&r.height!="auto";if(l.border&&(this._borderWidth=new x(l.borderWidth).val),s)this._computedWidth=this.width,this._computedHeight=this.height;else if(c)this._computedWidth=parseInt(l.width,10),this._computedHeight=parseInt(l.height,10);else if(g)this._computedWidth=parseInt(r.width,10),this._computedHeight=parseInt(r.height,10);else return;this.layerGroup.refreshLayout(this.constructLayoutParams()),this.isStatic||(this.gestureEngine.config.maxRoamingBounds.updatePadding([-.333*this.currentLayer.rowHeight]),this.gestureParams.longpress.flickDistStart=.24*this.currentLayer.rowHeight,this.gestureParams.flick.startDist=.3*this.currentLayer.rowHeight,this.gestureParams.flick.dirLockDist=.35*this.currentLayer.rowHeight,this.gestureParams.flick.triggerDist=.75*this.currentLayer.rowHeight,this.gestureParams.longpress.flickDistFinal=.75*this.currentLayer.rowHeight)}constructLayoutParams(){var e,n;return{keyboardWidth:this._computedWidth-2*this._borderWidth,keyboardHeight:this._computedHeight-2*this._borderWidth-this.layerGroup.verticalPadding,widthStyle:this.layoutWidth,heightStyle:this.internalHeight,baseEmFontSize:this.getKeyEmFontSize(),layoutFontSize:new x(this.layerGroup.element.style.fontSize),spacebarText:(n=(e=this.layoutKeyboardProperties)==null?void 0:e.displayName)!=null?n:"(System keyboard)"}}computedAdjustedOskHeight(e){if(!this.layerGroup)return e;let n=this.layerGroup.spec.layer,i=0;for(let r in n){let g=n[r].row.length,d=Math.floor(e/(g==0?1:g)),u=g*d;u>i&&(i=u)}return i+0}appendStyleSheet(){var e=this.layoutKeyboard,n=this.layoutKeyboardProperties;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet);var i=n==null?void 0:n.textFont,s=n==null?void 0:n.oskFont;this.styleSheetManager.addStyleSheetForFont(i,this.fontRootPath,this.device.OS),this.styleSheetManager.addStyleSheetForFont(s,this.fontRootPath,this.device.OS),this.config.specialFont&&this.styleSheetManager.addStyleSheetForFont(this.config.specialFont,"",this.device.OS);var l=this.addFontStyle(i,s);e!=null&&typeof e.oskStyling=="string"&&(l=l+e.oskStyling),l&&(this.styleSheet=st(l),this.styleSheetManager.linkStylesheet(this.styleSheet)),this.styleSheetManager.allLoadedPromise().then(()=>{this.layerGroup.resetPrecalcFontSizes(),this.refreshLayout()})}addFontStyle(e,n){let i="",s=o(l=>l.family.replace(/\u0022/g,"").replace(/,/g,'","'),"family");return(e||n)&&(i=`
.kmw-key-text {
  font-family: "${s(n||e)}";
}

.kmw-suggestion-text {
  font-family: "${s(e||n)}";
}
`),i}static buildDocumentationKeyboard(e,n,i,s,l,r){if(!e)return null;var c=typeof s=="undefined"?"desktop":s,g=typeof l=="undefined"?"default":l,d={};d.formFactor=c,c!="desktop"?(d.OS=V.OperatingSystem.iOS,d.touchable=!0):(d.OS=V.OperatingSystem.Windows,d.touchable=!1);let u=e.layout(c),I=new V("other",d.formFactor,d.OS,d.touchable),B=new mi({keyboard:e,keyboardMetadata:n,hostDevice:I,isStatic:!0,topContainer:null,pathConfig:i,styleSheetManager:null,specialFont:{family:"SpecialOSK",files:[`${i.resources}/osk/keymanweb-osk.ttf`],path:""}});B.layerGroup.element.className=B.kbdDiv.className,B.layerGroup.element.classList.add(d.formFactor+"-static");let h=B.kbdDiv.childNodes[0],b=document.createElement("div");b.classList.add(d.OS.toLowerCase(),d.formFactor),u!=null?(B.layerId=g,B.layerGroup.activeLayerId=g,B.setSize(800,r),B.fontSize=To(I,r,!1),b.style.fontSize=B.element.style.fontSize,B.refreshLayout(),h.style.height=B.kbdDiv.style.height,h.style.maxHeight=B.kbdDiv.style.maxHeight):h.innerHTML="<p style='color:#c40; font-size:0.5em;margin:10px;'>No "+c+" layout is defined for "+e.name+".</p>",h.style.border="1px solid #ccc",B.updateState();let F=o(()=>W(this,null,function*(){if(document.contains(h))try{yield B.styleSheetManager.allLoadedPromise();let U=B.styleSheet;U&&h.appendChild(U);let Q=[].concat(B.styleSheetManager.sheets);for(let p of Q)p!=U&&(p.href||(B.styleSheetManager.unlink(p),document.head.appendChild(p)));B.refreshLayout(),B.styleSheet=null,B.shutdown()}finally{G.disconnect()}}),"detectAndHandleInsertion"),G=new MutationObserver(F);G.observe(document.body,{childList:!0,subtree:!0}),b.append(h);for(let U of ye.STYLESHEET_FILES){let Q=`${i.resources}/osk/${U}`,p=B.styleSheetManager.linkExternalSheet(Q,!0);p.parentNode.removeChild(p),b.appendChild(p)}return B.appendStyleSheet(),delete B._width,delete B._height,b}onHide(){this.hkKey&&this.highlightKey(this.hkKey,!1)}optionKey(e,n,i){n.indexOf("K_LOPT")>=0?this.emit("globekey",e,i):n.indexOf("K_ROPT")>=0&&i&&this.emit("hiderequested",e)}showGesturePreview(e){let n=this.keytip,i=this.constructLayoutParams(),s=i.keyboardWidth*e.key.spec.proportionalWidth,l=i.keyboardHeight/this.currentLayer.rows.length,r=new vs(e,this.device.formFactor=="phone",s,l);return n==null?e.key.setPreview(r):n.show(e,!0,r),r.refreshLayout(),r}createKeyTip(){if(this.keytip==null)if(this.device.formFactor=="phone"){let e=this.isEmbedded;this.keytip=new Ii(this,e)}else this.keytip=new Ls(this);this.keytip&&this.keytip.element&&this.element.appendChild(this.keytip.element)}createGlobeHint(){return this.config.embeddedGestureConfig.createGlobeHint?this.config.embeddedGestureConfig.createGlobeHint(this):null}shutdown(){var e;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet),this.activeGestures.forEach(n=>n.cancel()),this.gestureEngine&&this.gestureEngine.destroy(),this.deleting&&window.clearTimeout(this.deleting),(e=this.keytip)==null||e.show(null,!1,null)}lockLayer(e){this.layerLocked=e}raiseKeyEvent(e,n){if(e.kName=="K_LOPT"||e.kName=="K_ROPT")return this.optionKey(n,e.kName,!0),{};let i={},s=o((l,r)=>{var g,d;i.contextToken=(g=l==null?void 0:l.transcription)==null?void 0:g.token;let c=(d=l==null?void 0:l.transcription)==null?void 0:d.transform;i.alteredText=l&&(!c||xt(c))},"keyEventCallback");return this.layerLocked&&(e.kNextLayer=this.layerId),this.emit("keyevent",e,s),i}};o(mi,"VisualKeyboard"),mi.specialCharacters=Xe.specialCharacters;var me=mi;var dc=class dc extends S.default{};o(dc,"Activator");var De=dc,uc=class uc extends De{get enabled(){return!0}set enabled(t){}get activate(){return!0}get conditionsMet(){return!0}};o(uc,"StaticActivator");var vt=uc;var Bc=class Bc{constructor(){this.map=new Map}promiseForTouchpoint(t){return this.map.get(t)||this.map.set(t,new f),this.map.get(t)}maintainTouches(t){let e=Array.from(this.map.keys());for(let n=0;n<t.length;n++){let i=e.indexOf(t.item(n).identifier);i!=-1&&e.splice(i,1)}for(let n of e)this.map.get(n).resolve(),this.map.delete(n)}};o(Bc,"TouchEventPromiseMap");var yi=Bc;function $o(a){let t="osk/";return a.isEmbedded&&(t=""),`${a.pathConfig.resources}/${t}`}o($o,"getResourcePath");var bn=class bn extends S.default{constructor(e){var i;super();this.legacyEvents=new ln;this.needsLayout=!0;this.touchEventPromiseManager=new yi;this.activationListener=o(e=>{if(!this.mayDisable&&!this.activationModel.enabled){this.activationModel.off("activate",this.activationListener);try{this.activationModel.enabled=!0}finally{this.activationModel.on("activate",this.activationListener)}}this.commonCheckAndDisplay()},"activationListener");this.layerChangeHandler=o((e,n)=>{var i,s;return this.vkbd&&this.vkbd._UpdateVKShiftStyle(n),(this.vkbd&&this.vkbd.layerId!=n||e.value!=n)&&(i=this.vkbd)!=null&&i.layerGroup.getLayer(n)&&!((s=this.vkbd)!=null&&s.layerLocked)&&(this.vkbd.layerId=n),!1},"layerChangeHandler");this._Visible=!1;this.config=e=y({},e),(i=this.config).gestureParams||(i.gestureParams=si),this.config.allowHideAnimations===void 0&&(this.config.allowHideAnimations=!0),this.config.device=e.device||e.hostDevice,this.config.isEmbedded=e.isEmbedded||!1,this.config.embeddedGestureConfig=e.embeddedGestureConfig||{},this.config.activator.on("activate",this.activationListener),this._Box=H("div"),this.kbdStyleSheetManager=new ge(this._Box,this.config.doCacheBusting||!1),this.uiStyleSheetManager=new ge(this._Box),this.bannerView=new rs,this.bannerView.events.on("bannerchange",()=>this.refreshLayout()),this._Box.appendChild(this.bannerView.element),this._bannerController=new oi(this.bannerView,this.hostDevice,this.config.predictionContextManager),this.keyboardView=this._GenerateKeyboardView(null,null),this._Box.appendChild(this.keyboardView.element);let n=$o(this.config);for(let s of bn.STYLESHEET_FILES){let l=`${n}${s}`;this.uiStyleSheetManager.linkExternalSheet(l)}this.setBaseMouseEventListeners(),this.hostDevice.touchable&&this.setBaseTouchEventListeners(),this._Box.style.display="none"}get keyCodes(){return C.keyCodes}get modifierCodes(){return C.modifierCodes}get modifierBitmasks(){return C.modifierBitmasks}get stateBitmasks(){return C.stateBitmasks}get gestureParams(){return this.config.gestureParams}get configuration(){return this.config}get bannerController(){return this._bannerController}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get isEmbedded(){return this.config.isEmbedded}setBaseMouseEventListeners(){this._Box.onmouseenter=e=>{this.mouseEnterPromise&&this.mouseEnterPromise.resolve(),this.mouseEnterPromise=new f,this.emit("pointerinteraction",this.mouseEnterPromise.corePromise)},this._Box.onmouseleave=e=>{this.mouseEnterPromise.resolve(),this.mouseEnterPromise=null}}removeBaseMouseEventListeners(){this._Box.onmouseenter=null,this._Box.onmouseleave=null}setBaseTouchEventListeners(){let e=o(function(n){return n.cancelable&&n.preventDefault(),n.stopPropagation(),!1},"commonPrevention");this._boxBaseTouchEventCancel=n=>(this.touchEventPromiseManager.maintainTouches(n.touches),e(n)),this._boxBaseTouchStart=n=>{for(let i=0;i<n.changedTouches.length;i++){let s=this.touchEventPromiseManager.promiseForTouchpoint(n.changedTouches[i].identifier);this.emit("pointerinteraction",s.corePromise)}return this.touchEventPromiseManager.maintainTouches(n.touches),e(n)},this._Box.addEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.addEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchcancel",this._boxBaseTouchEventCancel,!1)}removeBaseTouchEventListeners(){this._boxBaseTouchEventCancel&&(this._Box.removeEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.removeEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchcancel",this._boxBaseTouchEventCancel,!1),this._boxBaseTouchEventCancel=null,this._boxBaseTouchStart=null)}get targetDevice(){return this.config.device}set targetDevice(e){this.allowsDeviceChange(e)?(this.config.device=e,this.loadActiveKeyboard()):console.error("May not change target device for this OSKView type.")}allowsDeviceChange(e){return!1}get activationModel(){return this.config.activator}set activationModel(e){if(!e)throw new Error("The activation model may not be set to null or undefined!");this.config.activator.off("activate",this.activationListener),e.on("activate",this.activationListener),this.config.activator=e,this.commonCheckAndDisplay()}get mayDisable(){var e;return!(this.hostDevice.touchable||(e=this.activeKeyboard)!=null&&e.keyboard.isCJK)}get displayIfActive(){return this.activationModel.enabled}commonCheckAndDisplay(){this.activationModel.activate&&this.activeKeyboard?this.present():this.startHide(!1)}get vkbd(){return this.keyboardView instanceof me?this.keyboardView:null}get banner(){return this.bannerView}get width(){return this._width}get height(){return this._height}get computedWidth(){return this.needsLayout&&this.refreshLayout(),this._computedWidth}get computedHeight(){return this.needsLayout&&this.refreshLayout(),this._computedHeight}get baseFontSize(){var e;return((e=this.parsedBaseFontSize)==null?void 0:e.styleString)||""}get parsedBaseFontSize(){return this._baseFontSize||(this._baseFontSize=bn.defaultFontSize(this.targetDevice,this.computedHeight,this.isEmbedded)),this._baseFontSize}static defaultFontSize(e,n,i){if(e.touchable){let s=e.formFactor=="phone"?1.6*(i?.65:.6)*1.2:2;return x.special(s,"em")}else return n?x.inPixels(n/8):void 0}get activeKeyboard(){return this.keyboardData}set activeKeyboard(e){var n;this.keyboardData=e,this.loadActiveKeyboard(),(n=this.keyboardData)!=null&&n.keyboard.isCJK&&(this.activationModel.enabled=!0)}computeFrameHeight(){var e,n;return(((e=this.headerView)==null?void 0:e.layoutHeight.val)||0)+(((n=this.footerView)==null?void 0:n.layoutHeight.val)||0)}setSize(e,n,i){let s=!1,l,r;!e&&e!==0||!n&&n!==0||(Number.isFinite(e)?l=x.inPixels(e):l=new x(e),Number.isFinite(n)?r=x.inPixels(n):r=new x(n),e&&n&&(s=!this._width||!this._height,s=s||l.styleString!=this._width.styleString,s=s||r.styleString!=this._height.styleString,this._width=l,this._height=r),this.needsLayout=this.needsLayout||s,this.refreshLayoutIfNeeded(i))}setNeedsLayout(){this.needsLayout=!0}batchLayoutAfter(e){if(this.deferLayout){e();return}try{this.deferLayout=!0,this.vkbd&&(this.vkbd.deferLayout=!0),e()}finally{this.deferLayout=!1,this.vkbd&&(this.vkbd.deferLayout=!1),this.refreshLayout()}}refreshLayout(e){var r,c;if(!this.keyboardView||this.deferLayout||!(this.width&&this.height))return;let i=this.width.absolute&&this.height.absolute,s=getComputedStyle(this._Box),l=s.height!=""&&s.height!="auto";if(i)this._computedWidth=this.width.val,this._computedHeight=this.height.val;else if(l){let g=this._Box.parentElement;this._computedWidth=this.width.val*(this.width.absolute?1:g.offsetWidth),this._computedHeight=this.height.val*(this.height.absolute?1:g.offsetHeight)}else{console.warn("Unable to properly perform layout - specification uses a relative spec, thus relies upon insertion into the DOM for layout.");return}if(this.needsLayout=!1,this.banner.element.style.fontSize=this.baseFontSize,this.vkbd&&(this.vkbd.fontSize=this.parsedBaseFontSize),e||((r=this.headerView)==null||r.refreshLayout(),this.bannerView.width=this.computedWidth,this.bannerView.refreshLayout(),(c=this.footerView)==null||c.refreshLayout()),this.vkbd){let g=this.computedHeight-this.computeFrameHeight();this.bannerView.height>0&&(g-=this.bannerView.height+5),this.vkbd.setSize(this.computedWidth,g,e);let d=this._Box.style;d.width=d.maxWidth=this.computedWidth+"px",d.height=d.maxHeight=this.computedHeight+"px"}else{let g=this._Box.style;g.width="auto",g.height="auto",g.maxWidth=g.maxHeight=""}}refreshLayoutIfNeeded(e){this.needsLayout&&this.refreshLayout(e)}postKeyboardLoad(){this._Visible=!1,this.postKeyboardAdjustments(),this.displayIfActive&&this.present()}loadActiveKeyboard(){var s,l,r,c,g;this.setBoxStyling(),this.needsLayout=!0;let e=this.keyboardView,n=this.kbdStyleSheetManager;this.kbdStyleSheetManager=new ge(this._Box,this.config.doCacheBusting||!1);let i=this.keyboardView=this._GenerateKeyboardView((s=this.keyboardData)==null?void 0:s.keyboard,(l=this.keyboardData)==null?void 0:l.metadata);if(this._Box.replaceChild(i.element,e.element),i.postInsert(),(g=this.bannerController)==null||g.configureForKeyboard((r=this.keyboardData)==null?void 0:r.keyboard,(c=this.keyboardData)==null?void 0:c.metadata),e instanceof me&&e.shutdown(),n.unlinkAll(),this.banner.appendStyles(),this.vkbd){this.vkbd.createKeyTip();let d=this.vkbd.createGlobeHint();d&&this._Box.appendChild(d.element),this.vkbd.appendStyleSheet()}this.postKeyboardLoad()}_GenerateKeyboardView(e,n){let i=this.targetDevice;return this._Box.className="",e==null&&!i.touchable?new Wt:e&&e.layout(i.formFactor)?this._GenerateVisualKeyboard(e,n):!e||!n?this._GenerateVisualKeyboard(null,null):new ai(e)}_GenerateVisualKeyboard(e,n){let i=this.targetDevice,s=$o(this.config),l=new me({keyboard:e,keyboardMetadata:n,device:i,hostDevice:this.hostDevice,topContainer:this._Box,styleSheetManager:this.kbdStyleSheetManager,pathConfig:this.config.pathConfig,embeddedGestureConfig:this.config.embeddedGestureConfig,isEmbedded:this.config.isEmbedded,specialFont:{family:"SpecialOSK",files:[`${s}/keymanweb-osk.ttf`],path:""},gestureParams:this.config.gestureParams});return l.on("keyevent",(r,c)=>this.emit("keyevent",r,c)),l.on("globekey",(r,c)=>this.emit("globekey",r,c)),l.on("hiderequested",r=>{this.doHide(!0),this.emit("hiderequested",r)}),this._Box.className=i.formFactor+" "+i.OS.toLowerCase()+" kmw-osk-frame",l}present(){if(this.mayShow()){if(this.keyboardView.updateState(),this._Box.style.display="block",this.refreshLayoutIfNeeded(),this._Visible=!0,this._Box.style.opacity="1",this._Box.style.visibility=="hidden"){let e=this;window.setTimeout(function(){e._Box.style.visibility="visible"},0)}this.setDisplayPositioning()}}startHide(e){if(!this.mayHide(e))return;e&&(this.activationModel.enabled=!!(this.keyboardData.keyboard.isCJK||this.hostDevice.touchable));let n=null;this._Box&&this.hostDevice.touchable&&!(this.keyboardView instanceof Wt)&&this.config.allowHideAnimations?n=this.useHideAnimation():n=Promise.resolve(!0);let i=this;n.then(function(s){s&&i.finalizeHide()}),this.doHide(e)}finalizeHide(){if(!(document.body.className.indexOf("osk-always-visible")>=0&&this.hostDevice.formFactor=="desktop")){if(this._Box){let e=this._Box.style;e.display="none",e.transition="",e.opacity="1",this._Visible=!1}this.vkbd&&this.vkbd.onHide()}}mayShow(){return!(!this.activationModel.conditionsMet||!this.keyboardView||this.keyboardView instanceof Wt||!this.activationModel.enabled||!this._Box)}mayHide(e){return!(this.activationModel.conditionsMet&&!this.mayDisable||this.activationModel instanceof vt||!e&&this.hostDevice.formFactor=="desktop"&&document.body.className.indexOf("osk-always-visible")>=0)}useHideAnimation(){let e=this._Box.style,n=this;return new Promise(function(i){let s=o(function(){return n._Box.removeEventListener("transitionend",s,!1),n._Box.removeEventListener("webkitTransitionEnd",s,!1),n._Box.removeEventListener("transitioncancel",s,!1),n._Box.removeEventListener("webkitTransitionCancel",s,!1),n._animatedHideTimeout!=0&&window.clearTimeout(n._animatedHideTimeout),n._animatedHideTimeout=0,n._Visible&&n.activationModel.conditionsMet?(e.transition="",e.opacity="1",i(!1),!1):(i(!0),!0)},"cleanup"),l=o(function(){n._Box.removeEventListener("transitionrun",l,!1),n._Box.removeEventListener("webkitTransitionRun",l,!1),n._Box.addEventListener("transitionend",s,!1),n._Box.addEventListener("webkitTransitionEnd",s,!1),n._Box.addEventListener("transitioncancel",s,!1),n._Box.addEventListener("webkitTransitionCancel",s,!1)},"startup");n._Box.addEventListener("transitionrun",l,!1),n._Box.addEventListener("webkitTransitionRun",l,!1),e.transition="opacity 0.5s linear 0",e.opacity="0",n._animatedHideTimeout=window.setTimeout(s,200)})}hideNow(){if(!this.mayHide(!1)||!this._Box)return;this._animatedHideTimeout&&(window.clearTimeout(this._animatedHideTimeout),this._animatedHideTimeout=0);let e=this._Box.style;e.transition="",e.opacity="0",this.finalizeHide()}shutdown(){this.removeBaseMouseEventListeners(),this.removeBaseTouchEventListeners();var e=this._Box;e.parentElement&&e.parentElement.removeChild(e),this.kbdStyleSheetManager.unlinkAll(),this.uiStyleSheetManager.unlinkAll(),this.bannerController.shutdown()}getRect(){var e={};return e.left=e.left=K(this._Box),e.top=e.top=z(this._Box),e.width=this.computedWidth,e.height=this.computedHeight,e}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}hide(){this.activationModel.enabled=!1,this.startHide(!0)}show(e){arguments.length>0?this.activationModel.enabled=e:this.activationModel.conditionsMet&&(this.activationModel.enabled=!this.activationModel.enabled)}doShow(e){this.legacyEvents.callEvent("show",e)}doHide(e){let n={HiddenByUser:e};this.legacyEvents.callEvent("hide",n)}addEventListener(e,n){this.legacyEvents.addEventListener(e,n)}removeEventListener(e,n){this.legacyEvents.removeEventListener(e,n)}};o(bn,"OSKView"),bn.STYLESHEET_FILES=["kmwosk.css","globe-hint.css"];var ye=bn;var pi=class pi extends S.default{constructor(e){super();this.mouseCancellingHandler=o(function(e){return e.preventDefault(),e.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildTitleBar(),this.helpEnabled=!1,this.configEnabled=!1,e&&(this.element.onmousedown=e.mouseDownHandler)}get helpEnabled(){return this._helpEnabled}set helpEnabled(e){this._helpEnabled=e,this._helpButton.style.display=e?"inline":"none"}get configEnabled(){return this._configEnabled}set configEnabled(e){this._configEnabled=e,this._configButton.style.display=e?"inline":"none"}get layoutHeight(){return pi.DISPLAY_HEIGHT}get element(){return this._element}setPinCJKOffset(){this._unpinButton.style.left="15px"}showPin(e){this._unpinButton.style.display=e?"block":"none"}setTitle(e){this._caption.innerHTML=e}setTitleFromKeyboard(e){let n="<span style='font-weight:bold'>"+(e==null?void 0:e.name)+"</span>";this._caption.innerHTML=n}buildTitleBar(){let e=H("div");e.id="keymanweb_title_bar",e.className="kmw-title-bar";var n=this._caption=H("span");n.className="kmw-title-bar-caption",n.style.color="#fff",e.appendChild(n);var i=this._closeButton=this.buildCloseButton();return this._closeButton.onclick=()=>(this.emit("close"),!1),e.appendChild(i),i=this._helpButton=this.buildHelpButton(),this._helpButton.onclick=()=>(this.emit("help"),!1),e.appendChild(i),i=this._configButton=this.buildConfigButton(),this._configButton.onclick=()=>(this.emit("config"),!1),e.appendChild(i),i=this._unpinButton=this.buildUnpinButton(),this._unpinButton.onclick=()=>(this.emit("unpin"),!1),e.appendChild(i),e}buildCloseButton(){var e=H("div");return e.id="kmw-close-button",e.className="kmw-title-bar-image",e.onmousedown=this.mouseCancellingHandler,e}buildHelpButton(){let e=H("div");return e.id="kmw-help-image",e.className="kmw-title-bar-image",e.title="KeymanWeb Help",e.onmousedown=this.mouseCancellingHandler,e}buildConfigButton(){let e=H("div");return e.id="kmw-config-image",e.className="kmw-title-bar-image",e.title="KeymanWeb Configuration Options",e.onmousedown=this.mouseCancellingHandler,e}buildUnpinButton(){let e=H("div");return e.id="kmw-pin-image",e.className="kmw-title-bar-image",e.title="Pin the On Screen Keyboard to its default location on the active text box",e.onmousedown=this.mouseCancellingHandler,e}refreshLayout(){}};o(pi,"TitleBar"),pi.DISPLAY_HEIGHT=x.inPixels(20);var hn=pi;var Ci=class Ci extends S.default{constructor(e){super();this.mouseCancellingHandler=o(function(e){return e.preventDefault(),e.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildResizeBar(),e&&(this._resizeHandle.onmousedown=e.mouseDownHandler)}get layoutHeight(){return Ci.DISPLAY_HEIGHT}get element(){return this._element}get handle(){return this._resizeHandle}allowResizing(e){this._resizeHandle.style.display=e?"block":"none"}buildResizeBar(){var e=H("div");e.className="kmw-footer",e.onmousedown=this.mouseCancellingHandler;var n=H("div");n.className="kmw-footer-caption",n.innerHTML='<a href="https://keyman.com/developer/keymanweb/">KeymanWeb</a>',n.id="keymanweb-osk-footer-caption",n.addEventListener("dblclick",s=>(this.emit("showbuild"),!1),!1),e.appendChild(n);var i=H("div");return i.className="kmw-footer-resize",e.appendChild(i),this._resizeHandle=i,e}refreshLayout(){}};o(Ci,"ResizeBar"),Ci.DISPLAY_HEIGHT=x.inPixels(16);var Gi=Ci;var Fn=class Fn{constructor(t,e,n){this.x=t,this.y=e}static fromEvent(t){let e;if(window.TouchEvent&&t instanceof TouchEvent||t.changedTouches?e=t.changedTouches[0]:e=t,e.pageX)return new Fn(e.pageX,e.pageY,t);if(e.clientX){let n=e.clientX+document.body.scrollLeft,i=e.clientY+document.body.scrollTop;return new Fn(n,i,t)}else return new Fn(null,null,t)}};o(Fn,"InputEventCoordinate");var Hs=Fn,bc=class bc{constructor(t){this._VPreviousMouseMove=document.onmousemove,this._VPreviousMouseUp=document.onmouseup,this._VPreviousCursor=document.body.style.cursor,this._VPreviousMouseButton=typeof t.which=="undefined"?t.button:t.which}restore(){document.onmousemove=this._VPreviousMouseMove,document.onmouseup=this._VPreviousMouseUp,document.body.style.cursor&&(document.body.style.cursor=this._VPreviousCursor)}matchesCausingClick(t){return this._VPreviousMouseButton==(typeof t.which=="undefined"?t.button:t.which)}};o(bc,"MouseStartSnapshot");var Ic=bc,hc=class hc{constructor(t){this.startHandler=this._VMoveMouseDown.bind(this),this.cursorType=t}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get isActive(){return!!this._mouseStartSnapshot}get mouseDownHandler(){return this.startHandler}_VMoveMouseDown(t){return!t||!this._enabled?!0:(this._mouseStartSnapshot||(this._mouseStartSnapshot=new Ic(t)),this._startCoord=Hs.fromEvent(t),document.onmousemove=this._VMoveMouseMove.bind(this),document.onmouseup=this._VMoveMouseUp.bind(this),document.body.style.cursor&&(document.body.style.cursor=this.cursorType),t.preventDefault(),t.cancelBubble=!0,this.onDragStart(),!1)}_VMoveMouseMove(t){if(!t||!this.enabled)return!0;if(t.preventDefault(),t.cancelBubble=!0,this._mouseStartSnapshot.matchesCausingClick(t)){let e=Hs.fromEvent(t),n=e.x-this._startCoord.x,i=e.y-this._startCoord.y;return this.onDragMove(n,i),!1}else return this._VMoveMouseUp(t)}_VMoveMouseUp(t){return t?(this._mouseStartSnapshot.restore(),this._mouseStartSnapshot=null,t.preventDefault(),t.cancelBubble=!0,this.onDragRelease(),!1):!0}};o(hc,"MouseDragOperation");var mn=hc;var Fc=class Fc extends De{constructor(){super(...arguments);this._enabled=!0;this.actValue=null}get activate(){return this._enabled&&!!this.actValue}checkState(e){this.activate!=e&&this.emit("activate",this.activate)}get enabled(){return this._enabled}set enabled(e){let n=this.activate;this._enabled=e,this.checkState(n)}get activationTrigger(){return this.actValue}set activationTrigger(e){let n=this.activate,i=this.actValue;this.actValue=e,this.checkState(n),i!=e&&this.emit("triggerchange",e)}get conditionsMet(){return!!this.activationTrigger}};o(Fc,"TwoStateActivator");var Bt=Fc;var mc=class mc extends le{constructor(){super("KeymanWeb_OnScreenKeyboard")}loadWithDefaults(t){return y(y({},t),this.load())}load(){let t=super.load((e,n)=>{switch(n){case"version":return e;default:return Number.parseInt(e,10)}});return t.width||delete t.width,t.height||delete t.height,t}save(t){super.save(t)}};o(mc,"FloatingOSKCookieSerializer");var Js=mc;var yc=class yc extends ye{constructor(e){e.activator=e.activator||new Bt;super(e);this.userPositioned=!1;this.specifiedPosition=!1;this.noDrag=!1;this.layoutSerializer=new Js;this.restorePosition=function(e){let n=this._Visible,i=new f;this.emit("dragmove",i.corePromise),this.loadPersistedLayout(),this.userPositioned=!1,e||(delete this.dfltX,delete this.dfltY),this.savePersistedLayout(),n&&this.present(),this.titleBar.showPin(!1),i.resolve(),this.doResizeMove()}.bind(this);this.typedActivationModel.on("triggerchange",()=>this.setDisplayPositioning()),document.body.appendChild(this._Box),this.titleBar=new hn(this.titleDragHandler),this.titleBar.on("help",()=>{this.legacyEvents.callEvent("helpclick",{})}),this.titleBar.on("config",()=>{this.legacyEvents.callEvent("configclick",{})}),this.titleBar.on("close",()=>this.startHide(!0)),this.titleBar.on("unpin",()=>this.restorePosition(!0)),this.resizeBar=new Gi(this.resizeDragHandler),this.resizeBar.on("showbuild",()=>this.emit("showbuild")),this.headerView=this.titleBar,this._Box.insertBefore(this.headerView.element,this._Box.firstChild);let n=o(l=>{let r=this.headerView;if(r&&r instanceof hn)switch(l){case"configclick":r.configEnabled=this.legacyEvents.listenerCount("configclick")>0;break;case"helpclick":r.helpEnabled=this.legacyEvents.listenerCount("helpclick")>0;break;default:return}},"onListenedEvent"),i=new sn(this),s=new sn(this.legacyEvents);for(let l of[i,s])l.on("listeneradded",n),l.on("listenerremoved",n);this.activeKeyboard&&this.postKeyboardAdjustments(),this.loadPersistedLayout()}get typedActivationModel(){return this.activationModel}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let e=this._Box.style;e.zIndex="9999",e.display="none",e.width="auto",e.position="absolute"}postKeyboardAdjustments(){this.titleBar&&(this.enableMoveResizeHandlers(),this.activeKeyboard&&this.titleBar.setTitleFromKeyboard(this.activeKeyboard.keyboard),this.vkbd?(this.footerView=this.resizeBar,this._Box.appendChild(this.footerView.element)):(this.footerView&&this._Box.removeChild(this.footerView.element),this.footerView=null),this.loadPersistedLayout(),this.setNeedsLayout())}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}savePersistedLayout(){var e=this.getPos();let n={visible:this.displayIfActive?1:0,userSet:this.userPositioned?1:0,left:e.left,top:e.top,_version:M.CURRENT.toString()};this.vkbd&&(n.width=this.width.val,n.height=this.height.val),this.layoutSerializer.save(n)}loadPersistedLayout(){let e=this.layoutSerializer.loadWithDefaults({visible:1,userSet:0,left:-1,top:-1,_version:void 0,width:.3*screen.width,height:.15*screen.height});this.activationModel.enabled=e.visible==1,this.userPositioned=e.userSet==1,this.x=e.left,this.y=e.top;let n=e._version,i=n===void 0,s=e.width,l=e.height;s<.2*screen.width&&(s=.2*screen.width),l<.1*screen.height&&(l=.1*screen.height),s>.9*screen.width&&(s=.9*screen.width),l>.5*screen.height&&(l=.5*screen.height),(i||!n)&&(this.headerView&&this.headerView.layoutHeight.absolute&&(l+=this.headerView.layoutHeight.val),this.footerView&&this.footerView.layoutHeight.absolute&&(l+=this.footerView.layoutHeight.val)),this.setSize(s,l),(this.x==-1||this.y==-1||!this._Box)&&(this.userPositioned=!1),this.x<window.pageXOffset-.8*s&&(this.x=window.pageXOffset-.8*s),this.y<0&&(this.x=-1,this.y=-1,this.userPositioned=!1),this.userPositioned&&this._Box&&this.setPos({left:this.x,top:this.y})}getDefaultKeyboardHeight(){if(this.configuration.heightOverride)return this.configuration.heightOverride();var e=Math.floor(Math.min(screen.availHeight,screen.availWidth)/2),n=e;if(this.targetDevice.formFactor=="phone"){var i=Math.min(screen.height,screen.width),s=Math.max(screen.height,screen.width);be()?n=n*(s/i)/1.6:n=Math.floor(Math.max(screen.availHeight,screen.availWidth)/3)}return this.targetDevice.OS==V.OperatingSystem.iOS&&(n=n/Se(this.targetDevice.formFactor)),n}getDefaultWidth(){if(this.configuration.widthOverride)return this.configuration.widthOverride();var e;if(this.targetDevice.OS==V.OperatingSystem.iOS)e=window.innerWidth;else if(this.targetDevice.OS==V.OperatingSystem.Android)try{e=document.documentElement.clientWidth}catch(n){e=screen.availWidth}else e=screen.width;return e}doResizeMove(e){this.legacyEvents.callEvent("resizemove",e)}setRect(e){if(!(this._Box==null||this.targetDevice.formFactor!="desktop")){var n=this._Box,i=n.style;if("left"in e&&(this.x=e.left-K(n)+n.offsetLeft,i.left=this.x+"px",this.dfltX=i.left),"top"in e&&(this.y=e.top-z(n)+n.offsetTop,i.top=this.y+"px",this.dfltY=i.top),this.vkbd!=null){var s=this.vkbd.kbdDiv,l=s.style;if("width"in e){var r=e.width-(n.offsetWidth-s.offsetWidth);r<.2*screen.width&&(r=.2*screen.width),r>.9*screen.width&&(r=.9*screen.width),l.width=r+"px",this.setSize(r,this.computedHeight,!0)}if("height"in e){var c=e.height-(n.offsetHeight-s.offsetHeight);c<.1*screen.height&&(c=.1*screen.height),c>.5*screen.height&&(c=.5*screen.height),l.height=c+"px",l.fontSize=c/8+"px",this.setSize(this.computedWidth,c,!0)}"nosize"in e&&(this.resizingEnabled=!e.nosize)}"nomove"in e&&(this.noDrag=e.nomove,this.movementEnabled=!this.noDrag),this.savePersistedLayout()}}getPos(){var e=this._Box,n={left:this._Visible?e.offsetLeft:this.x,top:this._Visible?e.offsetTop:this.y};return n}setPos(e){if(typeof this._Box!="undefined"){if(this.userPositioned){var n=e.left,i=e.top;typeof n!="undefined"&&(n<-.8*this._Box.offsetWidth&&(n=-.8*this._Box.offsetWidth),this.userPositioned&&(this._Box.style.left=n+"px",this.x=n)),typeof i!="undefined"&&(i<0&&(i=0),this.userPositioned&&(this._Box.style.top=i+"px",this.y=i))}this.titleBar.showPin(this.userPositioned)}}setDisplayPositioning(){var e=this._Box.style;if(e.position="absolute",this.activationModel.activate&&(e.display="block"),e.left="0px",this.specifiedPosition||this.userPositioned)e.left=this.x+"px",e.top=this.y+"px";else{let n=this.typedActivationModel.activationTrigger||null;this.dfltX?e.left=this.dfltX:typeof n!="undefined"&&n!=null&&(e.left=K(n)+"px"),this.dfltY?e.top=this.dfltY:typeof n!="undefined"&&n!=null&&(e.top=z(n)+n.offsetHeight+"px")}this.specifiedPosition=!1}presentAtPosition(e,n){this.mayShow()&&(this.specifiedPosition=e>=0||n>=0,this.specifiedPosition&&(this.x=e,this.y=n),this.specifiedPosition=this.specifiedPosition||this.userPositioned,this.present())}present(){this.mayShow()&&(this.titleBar.showPin(this.userPositioned),super.present(),this.doShow({x:this._Box.offsetLeft,y:this._Box.offsetTop,userLocated:this.userPositioned}))}startHide(e){super.startHide(e),e&&this.savePersistedLayout()}show(e){e!==void 0?super.show(e):super.show(),this.savePersistedLayout()}userLocated(){return this.userPositioned}get movementEnabled(){return this.titleDragHandler.enabled}set movementEnabled(e){this.titleDragHandler.enabled=e,this.titleBar.showPin(e&&this.userPositioned)}get resizingEnabled(){return this.resizeDragHandler.enabled}set resizingEnabled(e){this.resizeDragHandler.enabled=e,this.resizeBar.allowResizing(e)}get isBeingMoved(){return this.titleDragHandler.isActive}get isBeingResized(){return this.resizeDragHandler.isActive}enableMoveResizeHandlers(){this.titleDragHandler.enabled=!this.noDrag,this.resizeDragHandler.enabled=!0}get titleDragHandler(){let e=this;return this._moveHandler?this._moveHandler:(this._moveHandler=new class extends mn{constructor(){super("move")}onDragStart(){this.startX=e._Box.offsetLeft,this.startY=e._Box.offsetTop,e.activeKeyboard.keyboard.isCJK&&e.titleBar.setPinCJKOffset(),this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new f,e.emit("dragmove",this.dragPromise.corePromise)}onDragMove(i,s){e.titleBar.showPin(!0),e.userPositioned=!0,e._Box.style.left=this.startX+i+"px",e._Box.style.top=this.startY+s+"px";var l=e.getRect();e.setSize(l.width,l.height,!0),e.x=l.left,e.y=l.top}onDragRelease(){e.vkbd&&(e.vkbd.currentKey=null),this.dragPromise.resolve(),this.dragPromise.then(()=>{e.userPositioned=!0,e.doResizeMove(),e.savePersistedLayout()}),this.dragPromise=null}},this._moveHandler)}get resizeDragHandler(){let e=this;return this._resizeHandler?this._resizeHandler:(this._resizeHandler=new class extends mn{constructor(){super("se-resize")}onDragStart(){this.startWidth=e.computedWidth,this.startHeight=e.computedHeight,this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new f,e.emit("resizemove",this.dragPromise.corePromise)}onDragMove(i,s){let l=this.startWidth+i,r=this.startHeight+s;l<.2*screen.width&&(l=.2*screen.width),r<.1*screen.height&&(r=.1*screen.height),l>.9*screen.width&&(l=.9*screen.width),r>.5*screen.height&&(r=.5*screen.height),e.setSize(l,r,!0)}onDragRelease(){e.vkbd&&(e.vkbd.currentKey=null),e.vkbd&&(this.startWidth=e.computedWidth,this.startHeight=e.computedHeight),e.refreshLayout(),this.dragPromise.resolve(),this.dragPromise.then(()=>{e.doResizeMove(),e.savePersistedLayout()}),this.dragPromise=null}},this._resizeHandler)}};o(yc,"FloatingOSKView");var Oe=yc;var pc=class pc extends ye{constructor(e){e.isEmbedded?e.activator=e.activator||new vt:e.activator=e.activator||new Bt;super(e);this.isResizing=!1;this.restorePosition=function(e){}.bind(this);document.body.appendChild(this._Box)}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let e=this._Box.style;e.zIndex="9999",e.display="none",e.width="100%",e.position="fixed"}refreshLayout(e){if(!this.isResizing){try{this.isResizing=!0,this.doResize()}finally{this.isResizing=!1}super.refreshLayout(e)}}doResize(){if(this.vkbd){let e=this.getDefaultKeyboardHeight();this.setSize(this.getDefaultWidth(),e+this.banner.height)}}postKeyboardAdjustments(){this.doResize()}getDefaultKeyboardHeight(){var r,c;let e=this.targetDevice;if(this.configuration.heightOverride)return this.configuration.heightOverride();let n=(r=document==null?void 0:document.documentElement)==null?void 0:r.clientWidth,i=(c=document==null?void 0:document.documentElement)==null?void 0:c.clientHeight;if(typeof n=="undefined"&&(n=Math.min(screen.height,screen.width),i=Math.max(screen.height,screen.width),be())){let g=n;n=i,i=g}var s=Math.floor(Math.min(i,n)/2),l=s;return e.formFactor=="phone"&&(be()?l=Math.floor(i/1.6):l=Math.floor(i/2.4)),this.targetDevice.OS==V.OperatingSystem.iOS&&(l=l/Se(this.targetDevice.formFactor)),l}getDefaultWidth(){var i;let e=this.targetDevice;if(this.configuration.widthOverride)return this.configuration.widthOverride();var n;return n=(i=document==null?void 0:document.documentElement)==null?void 0:i.clientWidth,typeof n=="undefined"&&(this.targetDevice.OS==V.OperatingSystem.iOS?n=window.innerWidth:e.OS==V.OperatingSystem.Android?n=screen.availWidth:n=screen.width),n}setRect(e){}getPos(){var e=this._Box,n={left:this._Visible?e.offsetLeft:this.x,top:this._Visible?e.offsetTop:this.y};return n}setPos(e){}setDisplayPositioning(){let e=this._Box.style;this.vkbd&&(e.position="fixed",e.left=e.bottom="0px",e.border="none",e.borderTop="1px solid gray")}present(){super.present(),this.legacyEvents.callEvent("show",{})}};o(pc,"AnchoredOSKView");var yn=pc;var Cc=class Cc extends De{constructor(){super(...arguments);this.flag=!0}get enabled(){return this.flag}set enabled(e){this.activate=e}get activate(){return this.flag}set activate(e){this.flag!=e&&(this.flag=e,this.emit("activate",e))}get conditionsMet(){return!0}};o(Cc,"SimpleActivator");var pn=Cc;var Gc=class Gc extends ye{constructor(e){e.activator=e.activator||new pn;super(e);this.restorePosition=function(e){}.bind(this)}get element(){return this._Box}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let e=this._Box.style;e.display="none",e.position="relative"}postKeyboardAdjustments(){}getDefaultKeyboardHeight(){return this.keyboardView instanceof me?this.keyboardView.height:this.computedHeight}getDefaultWidth(){return this.computedWidth}setRect(e){}getPos(){var e=this._Box,n={left:this._Visible?e.offsetLeft:void 0,top:this._Visible?e.offsetTop:void 0};return n}setPos(e){}present(){super.present(),this.legacyEvents.callEvent("show",{})}setDisplayPositioning(){}allowsDeviceChange(e){return!0}};o(Gc,"InlinedOSKView");var Cn=Gc;var xc={};Sn(xc,{AnchoredOSKView:()=>Qi,FloatingOSKView:()=>Ui,InlinedOSKView:()=>Qc});function Uc(a){return{hostDevice:a.config.hostDevice,pathConfig:a.config.paths,predictionContextManager:a.contextManager.predictionContext,isEmbedded:!1}}o(Uc,"buildBaseOskConfiguration");var Zc=class Zc extends yn{constructor(t,e){let n=y(y({},Uc(t)),e||{});super(n)}};o(Zc,"PublishedAnchoredOSKView");var Qi=Zc,Xc=class Xc extends Oe{constructor(t,e){let n=y(y({},Uc(t)),e||{});super(n)}};o(Xc,"PublishedFloatingOSKView");var Ui=Xc,Sc=class Sc extends Cn{constructor(t,e){let n=y(y({},Uc(t)),e||{});super(n)}};o(Sc,"PublishedInlineOSKView");var Qc=Sc;var Vc=class Vc extends it{constructor(){super(...arguments);this.events=new S.default;this.changed=!1}focus(){let e=this.getElement();e.focus&&e.focus()}isForcingScroll(){return!1}dispatchInputEventOn(e){let n;window.InputEvent&&(n=new InputEvent("input",{bubbles:!0,cancelable:!1})),e&&n&&e.dispatchEvent(n)}};o(Vc,"OutputTarget");var O=Vc;var Ac=class Ac extends O{constructor(e){super();this.root=e,this._cachedSelectionStart=-1}get isSynthetic(){return!1}static isSupportedType(e){return e=="email"||e=="search"||e=="text"||e=="url"}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(e){this.setSelection(e,e,"none")}setSelection(e,n,i){let s=this.root.value._kmwCodePointToCodeUnit(e),l=this.root.value._kmwCodePointToCodeUnit(n);this.root.setSelectionRange(s,l,i),this.processedSelectionStart=e,this.processedSelectionEnd=n,this.forceScroll(),this.root.setSelectionRange(s,l,i)}forceScroll(){let e=this.getElement(),n=e.selectionStart,i=e.selectionEnd;this._activeForcedScroll=!0;try{e.blur(),e.focus()}finally{e.selectionStart=n,e.selectionEnd=i,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}setTextBeforeCaret(e){this.getCaret();let n=this.processedSelectionEnd-this.processedSelectionStart,i=this.getSelectionDirection(),s=e._kmwLength();this.root.value=e+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(s,s+n,i)}setTextAfterCaret(e){let n=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+e,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,n)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(e){if(e>0){let n=this.getTextBeforeCaret(),i=this.processedSelectionStart;e>i&&(e=i),this.adjustDeadkeys(-e),this.setTextBeforeCaret(n.kmwSubstring(0,i-e)),this.setCaret(i-e)}}insertTextBeforeCaret(e){if(!e)return;let n=this.getCaret(),i=this.getTextBeforeCaret(),s=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(e._kmwLength()),this.root.value=i+e+s,this.setCaret(n+e._kmwLength())}handleNewlineAtCaret(){let e=this.root;e&&(e.type=="search"||e.type=="submit")?(e.disabled=!1,e.form.submit()):this.events.emit("unhandlednewline",e)}doInputEvent(){this.dispatchInputEventOn(this.root)}};o(Ac,"Input");var Pe=Ac;var Wc=class Wc extends O{constructor(e){super();this.root=e,this._cachedSelectionStart=-1}get isSynthetic(){return!1}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(e){this.setSelection(e,e,"none")}setSelection(e,n,i){let s=this.root.value._kmwCodePointToCodeUnit(e),l=this.root.value._kmwCodePointToCodeUnit(n);this.root.setSelectionRange(s,l,i),this.processedSelectionStart=e,this.processedSelectionEnd=n,this.forceScroll(),this.root.setSelectionRange(s,l,i)}forceScroll(){let e=this.getElement(),n=e.selectionStart,i=e.selectionEnd;this._activeForcedScroll=!0;try{e.blur(),e.focus()}finally{e.selectionStart=n,e.selectionEnd=i,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}setTextBeforeCaret(e){this.getCaret();let n=this.processedSelectionEnd-this.processedSelectionStart,i=this.getSelectionDirection(),s=e._kmwLength();this.root.value=e+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(s,s+n,i)}setTextAfterCaret(e){let n=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+e,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,n)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(e){if(e>0){let n=this.getTextBeforeCaret(),i=this.processedSelectionStart;e>i&&(e=i),this.adjustDeadkeys(-e),this.setTextBeforeCaret(n.kmwSubstring(0,i-e)),this.setCaret(i-e)}}insertTextBeforeCaret(e){if(!e)return;let n=this.getCaret(),i=this.getTextBeforeCaret(),s=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(e._kmwLength()),this.root.value=i+e+s,this.setCaret(n+e._kmwLength())}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}doInputEvent(){this.dispatchInputEventOn(this.root)}};o(Wc,"TextArea");var Gn=Wc;var fc=class fc{constructor(t,e){this.node=t,this.offset=e}};o(fc,"SelectionCaret");var xi=fc,Lc=class Lc{constructor(t,e){this.start=t,this.end=e}};o(Lc,"SelectionRange");var Zi=Lc,Rc=class Rc{constructor(t,e){this.cmd=t,this.stateType=e}};o(Rc,"StyleCommand");var Be=Rc,vc=class vc extends O{constructor(e){super();if(this.root=e,e.contentWindow&&e.contentWindow.document&&e.contentWindow.document.designMode=="on")this.doc=e.contentWindow.document,this.docRoot=e.contentWindow.document.documentElement;else throw"Specified IFrame is not in design-mode!"}get isSynthetic(){return!1}getElement(){return this.root}focus(){this.doc.defaultView.focus()}isSelectionEmpty(){return this.hasSelection()?this.doc.getSelection().isCollapsed:!0}hasSelection(){let e=this.doc.getSelection(),n=document.getSelection();return n.anchorNode==e.anchorNode&&n.focusNode==e.focusNode,!0}clearSelection(){if(this.hasSelection()){let e=this.doc.getSelection();e.isCollapsed||e.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let e=this.doc.getSelection(),n=e.anchorNode.compareDocumentPosition(e.focusNode);if(e.isCollapsed){let i=new xi(e.anchorNode,e.anchorOffset);return new Zi(i,i)}else{let i=new xi(e.anchorNode,e.anchorOffset),s=new xi(e.focusNode,e.focusOffset);return i.node==s.node&&(n=s.offset-i.offset>0?2:4),n&2?new Zi(i,s):new Zi(s,i)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let e=this.getCarets().start;return e.node.nodeType!=3?"":e.node.textContent.substr(0,e.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let e=this.getCarets().end;return e.node.nodeType!=3?"":e.node.textContent.substr(e.offset)}getText(){return this.docRoot.innerText}deleteCharsBeforeCaret(e){if(!this.hasSelection()||e<=0)return;let n=this.getCarets().start;if(e>n.offset&&(e=n.offset),n.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let i=this.doc.createRange(),s=n.offset-n.node.nodeValue.substr(0,n.offset)._kmwSubstr(-e).length;i.setStart(n.node,s),i.setEnd(n.node,n.offset),this.adjustDeadkeys(-e),i.deleteContents()}insertTextBeforeCaret(e){if(!this.hasSelection())return;let n=this.getCarets().start,i=e._kmwLength(),s=this.doc.getSelection();if(i==0)return;this.adjustDeadkeys(i);let l=this.root.ownerDocument.createRange();if(n.node.nodeType==3){let c=n.node;c.insertData(n.offset,e),l.setStart(c,n.offset+e.length)}else{var r=this.doc.createTextNode(e);let c=this.doc.createRange();c.setStart(n.node,n.offset),c.collapse(!0),c.insertNode(r),l.setStart(r,e.length)}l.collapse(!0),s.removeAllRanges();try{s.addRange(l)}catch(c){n.node.parentElement.scrollIntoView(),s.addRange(l)}s.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(e){if(!this.hasSelection())return;let n=this.getCarets().end;if(e._kmwLength()!=0)if(n.node.nodeType==3){let l=n.node;l.replaceData(n.offset,l.length,e)}else{var s=n.node.ownerDocument.createTextNode(e);let l=this.root.ownerDocument.createRange();l.setStart(n.node,n.offset),l.collapse(!0),l.insertNode(s)}}saveProperties(){var e=[new Be("backcolor",1),new Be("fontname",1),new Be("fontsize",1),new Be("forecolor",1),new Be("bold",0),new Be("italic",0),new Be("strikethrough",0),new Be("subscript",0),new Be("superscript",0),new Be("underline",0)];this.doc.defaultView&&e.push(new Be("hilitecolor",1));for(var n=0;n<e.length;n++){let i=e[n];i.stateType==1?i.cache=this.doc.queryCommandValue(i.cmd):i.cache=this.doc.queryCommandState(i.cmd)}this.commandCache=e}restoreProperties(e){this.commandCache||console.error("No command cache exists to restore!");for(var n=0;n<this.commandCache.length;n++){let i=this.commandCache[n];i.stateType==1?this.doc.queryCommandValue(i.cmd)!=i.cache&&(e&&e(),this.doc.execCommand(i.cmd,!1,i.cache)):this.doc.queryCommandState(i.cmd)!=i.cache&&(e&&e(),this.doc.execCommand(i.cmd,!1,null))}}doInputEvent(){this.dispatchInputEventOn(this.root)}};o(vc,"DesignIFrame");var P=vc;var Hc=class Hc{constructor(t,e){this.node=t,this.offset=e}};o(Hc,"SelectionCaret");var Xi=Hc,Jc=class Jc{constructor(t,e){this.start=t,this.end=e}};o(Jc,"SelectionRange");var Si=Jc,kc=class kc extends O{constructor(e){var t=(...args)=>{super(...args)};if(e.isContentEditable)t(),this.root=e;else throw"Specified element is not already content-editable!"}get isSynthetic(){return!1}getElement(){return this.root}isSelectionEmpty(){return this.hasSelection()?this.root.ownerDocument.getSelection().isCollapsed:!0}hasSelection(){let e=this.root.ownerDocument.getSelection();return!(this.root!=e.anchorNode&&!this.root.contains(e.anchorNode)||this.root!=e.focusNode&&!this.root.contains(e.focusNode))}clearSelection(){if(this.hasSelection()){let e=this.root.ownerDocument.getSelection();e.isCollapsed||e.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let e=this.root.ownerDocument.getSelection(),n=e.anchorNode.compareDocumentPosition(e.focusNode);if(e.isCollapsed){let i=new Xi(e.anchorNode,e.anchorOffset);return new Si(i,i)}else{let i=new Xi(e.anchorNode,e.anchorOffset),s=new Xi(e.focusNode,e.focusOffset);return i.node==s.node&&(n=s.offset-i.offset>0?2:4),n&2?new Si(i,s):new Si(s,i)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let e=this.getCarets().start;return e.node.nodeType!=3?"":e.node.textContent.substr(0,e.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let e=this.getCarets().end;return e.node.nodeType!=3?"":e.node.textContent.substr(e.offset)}getText(){return this.root.innerText}deleteCharsBeforeCaret(e){if(!this.hasSelection()||e<=0)return;let n=this.getCarets().start;if(e>n.offset&&(e=n.offset),n.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let i=this.root.ownerDocument.createRange(),s=n.offset-n.node.nodeValue.substr(0,n.offset)._kmwSubstr(-e).length;i.setStart(n.node,s),i.setEnd(n.node,n.offset),this.adjustDeadkeys(-e),i.deleteContents()}insertTextBeforeCaret(e){if(!this.hasSelection())return;let n=this.getCarets().start,i=e._kmwLength(),s=this.root.ownerDocument.getSelection();if(i==0)return;this.adjustDeadkeys(i);let l=this.root.ownerDocument.createRange();if(n.node.nodeType==3){let c=n.node;c.insertData(n.offset,e),l.setStart(c,n.offset+e.length)}else{var r=n.node.ownerDocument.createTextNode(e);let c=this.root.ownerDocument.createRange();c.setStart(n.node,n.offset),c.collapse(!0),c.insertNode(r),l.setStart(r,e.length)}l.collapse(!0),s.removeAllRanges();try{s.addRange(l)}catch(c){n.node.parentElement.scrollIntoView(),s.addRange(l)}s.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(e){if(!this.hasSelection())return;let n=this.getCarets().end;if(e._kmwLength()!=0)if(n.node.nodeType==3){let l=n.node;l.replaceData(n.offset,l.length,e)}else{var s=n.node.ownerDocument.createTextNode(e);let l=this.root.ownerDocument.createRange();l.setStart(n.node,n.offset),l.collapse(!0),l.insertNode(s)}}doInputEvent(){this.dispatchInputEventOn(this.root)}};o(kc,"ContentEditable");var Ht=kc;function j(a,t){var e;return a?a.Window?t=="Window":(a.defaultView?e=a.defaultView[t]:a.ownerDocument&&(e=a.ownerDocument.defaultView[t]),e?a instanceof e:!1):!1}o(j,"nestedInstanceOf");function ks(a){if(j(a,"HTMLInputElement"))return new Pe(a);if(j(a,"HTMLTextAreaElement"))return new Gn(a);if(j(a,"HTMLIFrameElement")){let t=a;return t.contentWindow&&t.contentWindow.document&&t.contentWindow.document.designMode=="on"?new P(t):a.isContentEditable?new Ht(a):null}else if(a.isContentEditable)return new Ht(a);return null}o(ks,"wrapElement");var Nc=class Nc{constructor(){this.pending=!1;let t=this.bg=document.createElement("div"),e=document.createElement("div"),n=this.lt=document.createElement("div"),i=this.gr=document.createElement("div"),s=this.bx=document.createElement("div");t.className="kmw-wait-background",e.className="kmw-wait-box",this.dismiss=null,n.className="kmw-wait-text",i.className="kmw-wait-graphic",s.className="kmw-alert-close";let l=e.onmousedown=e.onclick=c=>{s.style.display=="block"&&(t.style.display="none",this.dismiss&&this.dismiss())};e.addEventListener("touchstart",l,!1);let r=t.onmousedown=t.onclick=c=>{c.preventDefault(),c.stopPropagation()};t.addEventListener("touchstart",r,!1),e.appendChild(s),e.appendChild(n),e.appendChild(i),t.appendChild(e),document.body.appendChild(t)}get rootElement(){return this.bg}wait(t){let e=this.bg;typeof e=="undefined"||e==null||(t?(this.pending=!0,window.setTimeout(()=>{this.pending&&(window.scrollTo(0,0),this.bx.style.display="none",this.lt.className="kmw-wait-text",this.lt.innerHTML=t,this.gr.style.display="block",e.style.display="block")},1e3)):this.pending&&(this.lt.innerHTML="",this.pending=!1,e.style.display="none"))}alert(t,e){let n=this.bg;this.bx.style.display="block",this.lt.className="kmw-alert-text",this.lt.innerHTML=t,this.gr.style.display="none",n.style.display="block",this.dismiss=arguments.length>1?e:null}shutdown(){this.bg.parentNode.removeChild(this.bg)}};o(Nc,"AlertHost");var It=Nc;function Vi(){return document.readyState==="complete"?Promise.resolve():new Promise((a,t)=>{let e=o(()=>{window.removeEventListener("load",e),a()},"loadHandler");window.addEventListener("load",e)})}o(Vi,"whenDocumentReady");var Ec=class Ec extends Jn{initialize(e){this._options?this._options=y(y({},this._options),e):this._options=y({},e),super.initialize(e),this._options=e,this._ui=e.ui,this._attachType=e.attachType,Vi().then(()=>{var n;e.useAlerts&&!this.alertHost?this._alertHost=new It:!e.useAlerts&&this.alertHost&&((n=this._alertHost)==null||n.shutdown(),this._alertHost=null)})}get options(){return this._options}get attachType(){return this._attachType}get alertHost(){return this._alertHost}set signalUser(e){(!e||e!=this.alertHost)&&this.alertHost.shutdown(),this._alertHost=e}debugReport(){let e=super.debugReport();return e.attachType=this.attachType,e.ui=this._ui,e.keymanEngine="app/browser",e}onRuleFinalization(e,n){let i=e.transcription.transform;xt(i)||n instanceof O&&(n.changed=!0)}};o(Ec,"BrowserConfiguration");var Ns=Ec,ea=y({ui:"",attachType:"",useAlerts:!0},Zl);var Yc=class Yc{constructor(t,e,n){this.interface=t,this.keyboard=e}};o(Yc,"AttachmentInfo");var Ai=Yc;function je(a){let t=a==null?void 0:a.target;return Ve(t)}o(je,"eventOutputTarget");function Ve(a){var t;if(a==null)return null;if(a.body&&(a=a.body),a.nodeType==3&&(a=a.parentNode),j(a,"HTMLInputElement")){let e=a.type.toLowerCase();if(!(e=="text"||e=="search"))return null}return(t=a._kmwAttachment)==null?void 0:t.interface}o(Ve,"outputTargetForElement");var Es=class Es extends S.default{constructor(e,n){if(!e)throw new Error("Cannot attach to a null/undefined document");super();this.baseFont="";this.appliedFont="";this.embeddedPageContexts=[];this._inputList=[];this._sortedInputs=[];this._InputModeObserverCore=o(e=>{this.disableInputModeObserver();try{for(let n of e){let i=n.target;this.isAttached(i)&&(i._kmwAttachment.inputMode=i.inputMode,this.device.touchable&&(i.inputMode="none"))}}finally{this.enableInputModeObserver()}},"_InputModeObserverCore");this._EnablementMutationObserverCore=o(e=>{for(var n=0;n<e.length;n++){var i=e[n],s=i.oldValue?i.oldValue.indexOf("kmw-disabled")>=0:!1,l=i.target.className.indexOf("kmw-disabled")>=0;if(s&&!l?this._EnableControl(i.target):!s&&l&&this._DisableControl(i.target),!l&&i.attributeName=="readonly"){var r=i.oldValue?i.oldValue!=null:!1,c=i.target;if(c instanceof c.ownerDocument.defaultView.HTMLInputElement||c instanceof c.ownerDocument.defaultView.HTMLTextAreaElement){var g=c.readOnly;r&&!g?this._EnableControl(i.target):!r&&g&&this._DisableControl(i.target)}}}},"_EnablementMutationObserverCore");this._AutoAttachObserverCore=o(e=>{for(var n=[],i=[],s=0;s<e.length;s++){let c=e[s];for(var l=0;l<c.addedNodes.length;l++)n=n.concat(this._GetDocumentEditables(c.addedNodes[l]));for(l=0;l<c.removedNodes.length;l++)i=i.concat(this._GetDocumentEditables(c.removedNodes[l]))}for(var r=0;r<n.length;r++)this.isKMWInput(n[r])&&this._MutationAdditionObserved(n[r]);for(r=0;r<i.length;r++){let c=!1,g=i[r];if(g instanceof g.ownerDocument.defaultView.HTMLIFrameElement){for(let d=0;d<this.embeddedPageContexts.length;d++)if(this.embeddedPageContexts[d].options.owner==g){this.embeddedPageContexts[d].shutdown(),this.embeddedPageContexts.splice(d,1),c=!0;break}if(!c){for(let d=0;d<this._inputList.length;d++)if(this._inputList[d]==g){this.detachFromControl(g),this._inputList[d]==g&&this._inputList.splice(d,1);break}}}else this.isKMWInput(g)&&this._MutationRemovalObserved(g)}(n.length||i.length)&&(this.device.touchable?this.device.touchable&&window.setTimeout(()=>{this.listInputs()},1):this.listInputs())},"_AutoAttachObserverCore");this._MutationAdditionObserved=o(e=>{if(e instanceof e.ownerDocument.defaultView.HTMLIFrameElement){let n=o(()=>{window.setTimeout(()=>{this.attachToControl(e)},1)},"attachFunctor");e.addEventListener("load",n)}else this.attachToControl(e)},"_MutationAdditionObserved");this._MutationRemovalObserved=o(e=>{this.detachFromControl(e)},"_MutationRemovalObserved");this.options=n,this.document=e,this.stylesheetManager=new ge(this.document.body)}get device(){return this.options.hostDevice}get window(){return this.document.defaultView}get inputList(){let e=this.embeddedPageContexts.map(n=>n.inputList).reduce((n,i)=>n.concat(i),[]);return[].concat(this._inputList).concat(e)}get sortedInputs(){return this._sortedInputs}install(e){this.manualAttach=e,this.baseFont=this.getBaseFont(),this.manualAttach||(this._SetupDocument(this.document.documentElement),this.listInputs()),this.options.owner||this.initMutationObservers(this.document,e)}setupElementAttachment(e){if(!e._kmwAttachment){let n=ks(e);n||j(e,"HTMLIFrameElement")||console.warn("Could not create processing interface for newly-attached element!"),e._kmwAttachment=new Ai(n,null,this.device.touchable)}}clearElementAttachment(e){e._kmwAttachment=null}isKMWInput(e){if(e instanceof e.ownerDocument.defaultView.HTMLTextAreaElement)return!0;if(e instanceof e.ownerDocument.defaultView.HTMLInputElement){if(Pe.isSupportedType(e.type))return!0}else if(e instanceof e.ownerDocument.defaultView.HTMLIFrameElement)try{if(e.contentWindow){let n=e.contentWindow.document;if(n)return!(this.device.touchable&&n.designMode.toLowerCase()=="on")}else return!!e._kmwAttachment}catch(n){console.warn("Error during attachment to / detachment from iframe: "),console.warn(n)}else if(e.isContentEditable)return!0;return!1}isAttached(e){if(e._kmwAttachment)return!0;if(j(e,"HTMLIFrameElement")){if(e.contentDocument==this.document)return!0;for(let i of this.embeddedPageContexts)if(i.isAttached(e))return!0}return!1}isKMWDisabled(e){let n=e.className;return e.readOnly?!0:!!(n&&n.indexOf("kmw-disabled")>=0)}enableInputElement(e){var n;this.isKMWDisabled(e)||(e instanceof e.ownerDocument.defaultView.HTMLIFrameElement?this._AttachToIframe(e):(this.setupElementAttachment(e),e._kmwAttachment.inputMode=(n=e.inputMode)!=null?n:"text",this.disableInputModeObserver(),e.inputMode="none",this.enableInputModeObserver(),e.classList.add("keymanweb-font"),this._inputList.push(e),this.emit("enabled",e)))}disableInputElement(e){var i;if(e)if(e.ownerDocument.defaultView&&e instanceof e.ownerDocument.defaultView.HTMLIFrameElement||e instanceof HTMLIFrameElement)this._DetachFromIframe(e);else{if(this.isAttached(e)){let l=(i=e._kmwAttachment)==null?void 0:i.inputMode;this.disableInputModeObserver(),e.inputMode=l,this.enableInputModeObserver()}e.className.indexOf("keymanweb-font")>=0&&(e.className=e.className.replace("keymanweb-font","").trim());var n=this.inputList.indexOf(e);n>-1&&this._inputList.splice(n,1),this.emit("disabled",e)}}enableTouchElement(e){return this.isKMWDisabled(e)?(this.emit("disabled",e),!1):(this.isAttached(e)||this.setupElementAttachment(e),this.enableInputElement(e),!0)}disableTouchElement(e){if(this.isAttached(e)){let n=e._kmwAttachment.inputMode;this.disableInputModeObserver(),e.inputMode=n,this.enableInputModeObserver()}}_AttachToIframe(e){try{let n=e.contentWindow.document;if(n){if(n.designMode.toLowerCase()=="on")this.setupElementAttachment(e),n.body._kmwAttachment=e._kmwAttachment,this._inputList.push(e),this.emit("enabled",e);else if(this.embeddedPageContexts.filter(i=>i.document==n).length==0){let i=new Es(n,A(y({},this.options),{owner:e}));this.embeddedPageContexts.push(i),i.on("enabled",s=>this.emit("enabled",s)),i.on("disabled",s=>this.emit("disabled",s)),i.install(this.manualAttach)}}}catch(n){}}_DetachFromIframe(e){let n=o(()=>{this.clearElementAttachment(e);let i=this._inputList.indexOf(e);i!=-1&&this._inputList.splice(i,1),this.emit("disabled",e)},"detachFromDesignIframe");try{let i=e.contentWindow.document;if(i){if(i.designMode.toLowerCase()=="on")i.body._kmwAttachment=null,n();else for(let s=0;s<this.embeddedPageContexts.length;s++)if(this.embeddedPageContexts[s].document==i){let l=this.embeddedPageContexts.splice(s,1)[0];l._ClearDocument(i.body),l.shutdown(),this.embeddedPageContexts.splice(s,1);break}}}catch(i){e._kmwAttachment&&n()}}attachToControl(e){var n=this.device.touchable;this.isAttached(e)&&!(e instanceof e.ownerDocument.defaultView.HTMLIFrameElement)||(this.isKMWInput(e)?this.isKMWDisabled(e)?this.emit("disabled",e):n?this.enableTouchElement(e):this.enableInputElement(e):n&&this.emit("disabled",e))}detachFromControl(e){(this.isAttached(e)||e instanceof e.ownerDocument.defaultView.HTMLIFrameElement)&&(this.isKMWInput(e)&&(this.isKMWDisabled(e)||this._DisableControl(e)),this.clearElementAttachment(e))}_DisableControl(e){(this.isAttached(e)||e instanceof e.ownerDocument.defaultView.HTMLIFrameElement)&&(this.device.touchable&&this.disableTouchElement(e),this.listInputs(),this.disableInputElement(e))}_EnableControl(e){this.isAttached(e)?(this.device.touchable?this.enableTouchElement(e):this.enableInputElement(e),this.listInputs()):j(e,"HTMLIFrameElement")&&this._AttachToIframe(e)}disableControl(e){this.isAttached(e)||console.warn("KeymanWeb is not attached to element "+e);var n=e.className;n.indexOf("kmw-disabled")<0&&(e.className=n?n+" kmw-disabled":"kmw-disabled")}enableControl(e){!this.isAttached(e)&&!j(e,"HTMLIFrameElement")&&console.warn("KeymanWeb is not attached to element "+e);var n=e.className,i=n.indexOf("kmw-disabled");i>=0&&(e.className=n.replace("kmw-disabled","").trim())}listInputs(){let e=[],n=document.getElementsByTagName("input"),i=document.getElementsByTagName("textarea");for(let l=0;l<n.length;l++)Pe.isSupportedType(n[l].type)&&n[l].className.indexOf("kmw-disabled")<0&&e.push({ip:n[l],x:K(n[l]),y:z(n[l])});for(let l=0;l<i.length;l++)i[l].className.indexOf("kmw-disabled")<0&&e.push({ip:i[l],x:K(i[l]),y:z(i[l])});e.sort((l,r)=>l.y!=r.y?l.y-r.y:l.x-r.x);let s=[];for(let l=0;l<e.length;l++)s.push(e[l].ip);this._sortedInputs=s}findNeighboringInput(e,n){var i,s=this.sortedInputs;if(s.length==0)return null;for(i=0;i<s.length&&s[i]!=e;i++);return i==s.length&&!n&&i--,i=n?i-1:i+1,i=i>=s.length?i-s.length:i,i=i<0?i+s.length:i,s[i]}_GetDocumentEditables(e){let n=[];if(e.ownerDocument&&e instanceof e.ownerDocument.defaultView.HTMLElement){let s=e.ownerDocument.defaultView;(e instanceof s.HTMLInputElement||e instanceof s.HTMLTextAreaElement||e instanceof s.HTMLIFrameElement)&&n.push(e)}if(e.getElementsByTagName){var i=o(function(s){return es(e.getElementsByTagName(s))},"LiTmp");n=n.concat(i("INPUT"),i("TEXTAREA"),i("IFRAME"))}return e.querySelectorAll&&(n=n.concat(es(e.querySelectorAll("[contenteditable]")))),e.ownerDocument&&e instanceof e.ownerDocument.defaultView.HTMLElement&&e.isContentEditable&&n.push(e),n}_SetupDocument(e){let n=this._GetDocumentEditables(e);for(var i=0;i<n.length;i++)this.attachToControl(n[i])}_ClearDocument(e){let n=this._GetDocumentEditables(e);for(var i=0;i<n.length;i++)this.detachFromControl(n[i])}initMutationObservers(e,n){if(typeof MutationObserver=="function"){var i=e.querySelector("body"),s;n||(s={childList:!0,subtree:!0},this.attachmentObserver=new MutationObserver(this._AutoAttachObserverCore),this.attachmentObserver.observe(i,s)),s={subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["class","readonly"]},this.enablementObserver=new MutationObserver(this._EnablementMutationObserverCore),this.enablementObserver.observe(i,s),this.inputModeObserver=new MutationObserver(this._InputModeObserverCore),this.enableInputModeObserver()}else console.warn("Your browser is outdated and does not support MutationObservers, a web feature needed by KeymanWeb to support dynamically-added elements.")}enableInputModeObserver(){var i;let e=document.querySelector("body"),n={subtree:!0,attributes:!0,attributeFilter:["inputmode"]};(i=this.inputModeObserver)==null||i.observe(e,n)}disableInputModeObserver(){var e;(e=this.inputModeObserver)==null||e.disconnect()}getBaseFont(){var e=document.getElementsByTagName("input"),n=document.getElementsByTagName("textarea"),i=0,s,l="Arial,sans-serif";if(e.length==0&&n.length==0)i=0;else if(e.length>0&&n.length==0)i=1;else if(e.length==0&&n.length>0)i=2;else{var r=e[0],c=n[0];r.offsetTop<c.offsetTop?i=1:r.offsetTop>c.offsetTop?i=2:r.offsetLeft<c.offsetLeft?i=1:r.offsetLeft>c.offsetLeft&&(i=2)}switch(i){case 0:s=l;break;case 1:s=getComputedStyle(e[0]).fontFamily||"";break;case 2:s=getComputedStyle(n[0]).fontFamily||"";break}return(typeof s=="undefined"||s=="monospace")&&(s=l),s}buildAttachmentFontStyle(e){let n=e,i=this.baseFont;n&&typeof n.family!="undefined"&&(i=n.family),i=i.replace(/\u0022/g,"");var s=new RegExp("\\s?"+i+",?"),l=this.appliedFont.replace(/\u0022/g,"");l=l.replace(s,""),l=l.replace(/,$/,""),l==""?l=i:l=i+","+l,l='"'+l.replace(/\,\s?/g,'","')+'"';let r=`.keymanweb-font{
font-family:`+l+` !important;
}
`;return this.appliedFont=l,r}setAttachmentFont(e,n,i){this.stylesheetManager.unlinkAll(),this.stylesheetManager.addStyleSheetForFont(e,n,i),this.stylesheetManager.linkStylesheet(st(this.buildAttachmentFontStyle(e)))}shutdown(){var e,n,i,s;try{(e=this.enablementObserver)==null||e.disconnect(),(n=this.attachmentObserver)==null||n.disconnect(),(i=this.inputModeObserver)==null||i.disconnect(),(s=this.stylesheetManager)==null||s.unlinkAll(),this.inputModeObserver=null,this.embeddedPageContexts.forEach(l=>{try{l.shutdown()}catch(r){}});for(let l of this.inputList)try{this.detachFromControl(l)}catch(r){this.emit("disabled",l)}this._inputList=[]}catch(l){console.error("Error occurred during shutdown"),console.error(l)}}};o(Es,"PageContextAttachment");var Wi=Es;var wc=class wc{constructor(t,e){this.activationPending=t,this.activated=e}};o(wc,"FocusStateAPIObject");var Tc=wc,Mc=class Mc extends S.default{constructor(e){super();this._maintainingFocus=!1;this.restoringFocus=!1;this._IgnoreNextSelChange=0;this.isTargetForcingScroll=e}get maintainingFocus(){return this._maintainingFocus}set maintainingFocus(e){let n=this._maintainingFocus;this._maintainingFocus=e,n&&!e&&this.emit("maintainingfocusend")}getUIState(){return new Tc(this.maintainingFocus,this.restoringFocus)}setMaintainingFocus(e){this.maintainingFocus=!!e}setFocusTimer(){this.focusing=!0,this.focusTimer=window.setTimeout(()=>{this.focusing=!1},50)}};o(Mc,"FocusAssistant");var Ys=Mc;function ta(a,t){let e=t!=null&&t.isRTL?"rtl":"ltr";a&&(a instanceof a.ownerDocument.defaultView.HTMLInputElement||a instanceof a.ownerDocument.defaultView.HTMLTextAreaElement?a.value.length==0&&(a.dir=e):typeof a.textContent=="string"&&a.textContent.length==0&&(a.dir=e))}o(ta,"_SetTargDir");var Ts=class Ts extends Nn{constructor(e,n){super(e);this.cookieManager=new le("KeymanWeb_Keyboard");this.focusAssistant=new Ys(()=>{var e;return(e=this.activeTarget)==null?void 0:e.isForcingScroll()});this.domEventTracker=new xe;this._ControlFocus=o(e=>{let n=je(e);return n&&this.setActiveTarget(n,!0),!0},"_ControlFocus");this._ControlBlur=o(e=>{if(this.focusAssistant._IgnoreNextSelChange)return this.focusAssistant._IgnoreNextSelChange--,e.cancelBubble=!0,e.stopPropagation(),!0;if(this.focusAssistant.isTargetForcingScroll())return e.cancelBubble=!0,e.stopPropagation(),!0;let n=je(e);if(n==null)return!0;this.lastActiveTarget&&this._BlurKeyboardSettings(this.lastActiveTarget.getElement());let i=this.activeTarget;this.currentTarget=null,(i||this.lastActiveTarget)&&(this.mostRecentTarget=n),this.focusAssistant.restoringFocus=!1;let s=this.activeKeyboard,l=this.focusAssistant.maintainingFocus;return!l&&s&&s.keyboard.notify(0,n,0),i&&!this.activeTarget&&this.emit("targetchange",null),this.apiEvents.callEvent("controlblurred",{target:n.getElement(),event:e,isActivating:l}),this.doChangeEvent(n),this.resetContext(),!0},"_ControlBlur");this._Click=o(e=>(this.resetContext(),!0),"_Click");this.nonKMWTouchHandler=o(e=>{this.focusAssistant.focusing=!1,clearTimeout(this.focusAssistant.focusTimer),this.forgetActiveTarget()},"nonKMWTouchHandler");this._eventsObj=n,this.page=new Wi(window.document,{hostDevice:this.engineConfig.hostDevice}),this.focusAssistant.on("maintainingfocusend",()=>{!this.activeTarget&&this.mostRecentTarget&&this.emit("targetchange",this.activeTarget)})}get apiEvents(){return this._eventsObj()}initialize(){this.on("keyboardasyncload",(e,n)=>{var i;(i=this.engineConfig.alertHost)==null||i.wait("Installing keyboard<br/>"+e.name),n.then(()=>{var s;(s=this.engineConfig.alertHost)==null||s.wait()})}),this.engineConfig.deferForInitialization.then(()=>{let e=this.engineConfig.hostDevice,n=o(i=>i.stopPropagation(),"noPropagation");this.page.on("enabled",i=>{if(!(i._kmwAttachment.interface instanceof P))e.touchable&&(this.domEventTracker.detachDOMEvent(i,"touchstart",this.nonKMWTouchHandler),this.domEventTracker.attachDOMEvent(i,"touchmove",n,!1),this.domEventTracker.attachDOMEvent(i,"touchend",n,!1)),this.domEventTracker.attachDOMEvent(i,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(i,"blur",this._ControlBlur),this.domEventTracker.attachDOMEvent(i,"click",this._Click);else{var s=i.contentWindow.document;e.browser=="firefox"?(this.domEventTracker.attachDOMEvent(s,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s,"blur",this._ControlBlur)):(this.domEventTracker.attachDOMEvent(s.body,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s.body,"blur",this._ControlBlur))}i.ownerDocument.activeElement==i&&this.setActiveTarget(Ve(i),!0)}),this.page.on("disabled",i=>{var l;if(!j(i,"HTMLIFrameElement"))e.touchable&&this.domEventTracker.attachDOMEvent(i,"touchstart",this.nonKMWTouchHandler,!1),this.domEventTracker.detachDOMEvent(i,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(i,"blur",this._ControlBlur),this.domEventTracker.detachDOMEvent(i,"click",this._Click);else{let r=i.contentWindow.document;e.browser=="firefox"?(this.domEventTracker.detachDOMEvent(r,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(r,"blur",this._ControlBlur)):(this.domEventTracker.detachDOMEvent(r.body,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(r.body,"blur",this._ControlBlur))}var s=(l=this.mostRecentTarget)==null?void 0:l.getElement();s&&s==i&&this.forgetActiveTarget()}),this.page.install(this.engineConfig.attachType=="manual")})}get activeTarget(){let e=this.focusAssistant.maintainingFocus;return this.currentTarget||(e?this.mostRecentTarget:null)}get lastActiveTarget(){return this.mostRecentTarget}deactivateCurrentTarget(){let e=this.activeTarget||this.lastActiveTarget;e&&this.page.isAttached(e.getElement())&&this._BlurKeyboardSettings(e.getElement()),this.activeTarget||this.setActiveTarget(null,!0)}forgetActiveTarget(){this.focusAssistant.maintainingFocus=!1,this.focusAssistant.restoringFocus=!1;let e=this.activeTarget||this.mostRecentTarget;e&&this._BlurKeyboardSettings(e.getElement()),this.setActiveTarget(null,!0),e==this.lastActiveTarget&&(this.mostRecentTarget=null)}setActiveTarget(e,n){var c;let i=this.mostRecentTarget,s=this.activeTarget;if(e==s){s&&(this.currentTarget=s);return}let l=!!i;if(this.currentTarget=this.mostRecentTarget=e,this.predictionContext.setCurrentTarget(e),this.focusAssistant.restoringFocus?this._BlurKeyboardSettings(e.getElement()):e&&this._FocusKeyboardSettings(e.getElement(),!l),this._CommonFocusHelper(e))return;let r=e==null?void 0:e.getElement();if(e instanceof P&&(r=e.docRoot),r&&r.ownerDocument&&r instanceof r.ownerDocument.defaultView.HTMLElement&&ta(r,(c=this.activeKeyboard)==null?void 0:c.keyboard),e!=s&&this.emit("targetchange",e),n){let g=i==null?void 0:i.getElement();i instanceof P&&(g=i.docRoot),r?this.apiEvents.callEvent("controlfocused",{target:r,activeControl:g}):g&&this.apiEvents.callEvent("controlblurred",{target:g,event:null,isActivating:this.focusAssistant.maintainingFocus})}}get activeKeyboard(){return this._activeKeyboard}restoreLastActiveTarget(){this.mostRecentTarget&&(this.focusAssistant.restoringFocus=!0,this.mostRecentTarget.focus(),this.focusAssistant.restoringFocus=!1)}insertText(e,n,i){this.restoreLastActiveTarget();let s=this.activeTarget;return s==null&&this.mostRecentTarget&&(s=this.activeTarget),s!=null?super.insertText(e,n,i):!1}currentKeyboardSrcTarget(){let e=this.currentTarget||this.mostRecentTarget;return this.isTargetKeyboardIndependent(e)?e:null}isTargetKeyboardIndependent(e){let n=e==null?void 0:e.getElement()._kmwAttachment;return!!(n!=null&&n.keyboard||(n==null?void 0:n.keyboard)==="")}activateKeyboardForTarget(e,n){var s,l;let i=n==null?void 0:n.getElement()._kmwAttachment;if(i?(i.keyboard=(s=e==null?void 0:e.metadata.id)!=null?s:"",i.languageCode=(l=e==null?void 0:e.metadata.langId)!=null?l:""):this.globalKeyboard=e,this.currentKeyboardSrcTarget()==n){this._activeKeyboard=e;let r=e==null?void 0:e.metadata;this.page.setAttachmentFont(r==null?void 0:r.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS)}}setKeyboardForTarget(e,n,i){if(e instanceof P){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}let s=e.getElement()._kmwAttachment,l=this.currentKeyboardSrcTarget()==e;if(s){if(s.keyboard=n||null,s.languageCode=i||null,l||this.currentKeyboardSrcTarget()==e){let r=this.globalKeyboard.metadata;this.activateKeyboard(s.keyboard||r.id,s.languageCode||r.langId,!0)}}else return}getKeyboardStubForTarget(e){if(this.isTargetKeyboardIndependent(e)){let n=e.getElement()._kmwAttachment;return this.keyboardCache.getStub(n.keyboard,n.languageCode)}else return this.globalKeyboard.metadata}getFallbackStubKey(){let e={id:"",langId:""};return this.engineConfig.hostDevice.touchable&&this.keyboardCache.defaultStub||e}activateKeyboard(e,n,i){return W(this,null,function*(){var l,r,c,g,d,u;i||(i=!1);let s=this.currentKeyboardSrcTarget();this.engineConfig.deferForInitialization.isFulfilled||(yield this.engineConfig.deferForInitialization.corePromise),e||(e=this.getFallbackStubKey().id,n=this.getFallbackStubKey().langId);try{let I=yield Ji(Ts.prototype,this,"activateKeyboard").call(this,e,n,i);return(l=this.engineConfig.alertHost)==null||l.wait(),i&&!s&&this.cookieManager.save({current:`${e}:${n}`}),s==this.currentKeyboardSrcTarget()&&(ta((r=this.currentTarget)==null?void 0:r.getElement(),this.keyboardCache.getKeyboard(e)),this.page.setAttachmentFont((g=(c=this.activeKeyboard)==null?void 0:c.metadata)==null?void 0:g.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS),this.restoreLastActiveTarget()),I}catch(I){let B=o(()=>W(this,null,function*(){let b=this.getFallbackStubKey();b.id!=e&&(yield this.activateKeyboard(b.id,b.langId,!0).catch(()=>{}))}),"fallback");(d=this.engineConfig.alertHost)==null||d.wait();let h=(I==null?void 0:I.message)||"Sorry, the "+e+" keyboard for "+n+" is not currently available.";throw I instanceof pt?console.error(I||h):console.warn(I||h),this.engineConfig.alertHost?(u=this.engineConfig.alertHost)==null||u.alert(h,B):yield B(),I}})}_BlurKeyboardSettings(e,n,i){var r;var s=this.activeKeyboard?this.activeKeyboard.keyboard.id:"",l=(r=this.activeKeyboard)==null?void 0:r.metadata.langId;n!==void 0&&i!==void 0&&(s=n,l=i),e&&e._kmwAttachment.keyboard!=null?(e._kmwAttachment.keyboard=s,e._kmwAttachment.languageCode=l):this.globalKeyboard=this.activeKeyboard}_FocusKeyboardSettings(e,n){var l;let i=e._kmwAttachment,s=this.globalKeyboard;i.keyboard!=null?this.activateKeyboard(i.keyboard,i.languageCode,!0):!n&&(s==null?void 0:s.metadata)!=((l=this._activeKeyboard)==null?void 0:l.metadata)&&this.activateKeyboard(s==null?void 0:s.metadata.id,s==null?void 0:s.metadata.langId,!0)}_CommonFocusHelper(e){var s;let n=this.focusAssistant,i=(s=this.activeKeyboard)==null?void 0:s.keyboard;return n.restoringFocus||(e==null||e.deadkeys().clear(),i==null||i.notify(0,e,1)),!n.restoringFocus&&this.mostRecentTarget!=e&&(n.maintainingFocus=!1),n.restoringFocus=!1,this.resetContext(),!1}doChangeEvent(e){if(e.changed){let n=new Event("change",{bubbles:!0,cancelable:!1});e.getElement().dispatchEvent(n)}e.changed=!1}getSavedKeyboardRaw(){var n=new le("KeymanWeb_Keyboard").load(decodeURIComponent);return typeof n.current!="string"||n.current=="Keyboard_us:eng"?"Keyboard_us:en":n.current}getSavedKeyboard(){let e=this.getSavedKeyboardRaw(),n=this.keyboardCache.getStubList(),i;for(let s=0;s<n.length;s++)if(i=n[s].KI+":"+n[s].KLC,i==e)return i;for(let s=0;s<n.length;s++)if(i=n[s].KI+":"+n[s].KLC,i=="Keyboard_us:en")return i;return n.length>0?n[0].KI+":"+n[0].KLC:"Keyboard_us:en"}restoreSavedKeyboard(e){let i=e.split(":");i.length<2&&(i[1]=""),(this.keyboardCache.getStub(i[0],i[1])||this.keyboardCache.defaultStub)&&this.activateKeyboard(i[0],i[1])}shutdown(){this.page.shutdown(),this.domEventTracker.shutdown()}};o(Ts,"ContextManager");var fi=Ts;var Kc=class Kc extends Ae{constructor(e){super();this.contextManager=e}isCommand(e){switch(this.codeForEvent(e)){case C.keyCodes.K_TAB:case C.keyCodes.K_TABBACK:case C.keyCodes.K_TABFWD:return!0;default:return super.isCommand(e)}}applyCommand(e,n){let i=this.codeForEvent(e),s=o(l=>{var d;let r=this.contextManager,c=(d=r.activeTarget)==null?void 0:d.getElement(),g=r.page.findNeighboringInput(c,l);g==null||g.focus()},"moveToNext");switch(i){case C.keyCodes.K_TAB:s((e.Lmodifiers&m.K_SHIFTFLAG)!=0);break;case C.keyCodes.K_TABBACK:s(!0);break;case C.keyCodes.K_TABFWD:s(!1);break}super.applyCommand(e,n)}};o(Kc,"DefaultBrowserRules");var Li=Kc;function zc(a){return a.keyCode?a.keyCode:a.which?a.which:null}o(zc,"_GetEventKeyCode");function ws(a,t,e){if(a.cancelBubble===!0)return null;let n=zc(a);if(n==null)return null;var i=t.modStateFlags,s=0,l=!1,r=!1;let c=C.keyCodes;switch(n){case c.K_CTRL:case c.K_LCTRL:case c.K_RCTRL:case c.K_CONTROL:case c.K_LCONTROL:case c.K_RCONTROL:l=!0;break;case c.K_LMENU:case c.K_RMENU:case c.K_ALT:case c.K_LALT:case c.K_RALT:r=!0;break}s|=a.getModifierState("Shift")?16:0,a.getModifierState("Control")&&(s|=a.location!=0&&l?a.location==1?m.LCTRLFLAG:m.RCTRLFLAG:i&3),a.getModifierState("Alt")&&(s|=a.location!=0&&r?a.location==1?m.LALTFLAG:m.RALTFLAG:i&12);let g=0;g|=a.getModifierState("CapsLock")?m.CAPITALFLAG:m.NOTCAPITALFLAG,g|=a.getModifierState("NumLock")?m.NUMLOCKFLAG:m.NOTNUMLOCKFLAG,g|=a.getModifierState("ScrollLock")?m.SCROLLFLAG:m.NOTSCROLLFLAG,s|=g;let d=t.modStateFlags!=s;t.modStateFlags=s;let u=m.RALTFLAG|m.LCTRLFLAG;(i&u)==u&&(s&u)!=u&&(s&=~u),s&m.RALTFLAG&&(s&=~m.LCTRLFLAG);let I=C.modifierBitmasks,B=t.activeKeyboard,h;B&&B.isChiral?(h=s&I.CHIRAL,B.emulatesAltGr&&(h&I.ALT_GR_SIM)==I.ALT_GR_SIM&&(h^=I.ALT_GR_SIM,h|=m.RALTFLAG)):h=s&16|(s&(m.LCTRLFLAG|m.RCTRLFLAG)?32:0)|(s&(m.LALTFLAG|m.RALTFLAG)?64:0),h|=a.metaKey?m.K_METAFLAG:0,e.browser==V.Browser.Firefox&&te.browserMap.FF["k"+n]&&(n=te.browserMap.FF["k"+n]);let b=new ee({device:e,kName:"",Lcode:n,Lmodifiers:h,Lstates:g,LmodifierChange:d,isSynthetic:!1}),F=typeof a.charCode!="undefined"&&a.charCode!=null&&(a.charCode==0||(h&111)!=0);b.LisVirtualKey=F||a.type!="keypress",b=Sl(b,B,t.baseLayout);let G=new ee(b);return G.source=a,G}o(ws,"preprocessKeyboardEvent");var Dc=class Dc extends Dt{constructor(e,n,i){super();this.domEventTracker=new xe;this.swallowKeypress=!1;this._KeyDown=o(e=>{var l;let n=this.contextManager.activeKeyboard,i=je(e);if(!i||n==null)return!0;let s=i.getElement();return((l=s==null?void 0:s.getAttribute("class"))==null?void 0:l.indexOf("kmw-disabled"))>=0?!0:this.keyDown(e)},"_KeyDown");this._KeyPress=o(e=>{var i;return!je(e)||((i=this.contextManager.activeKeyboard)==null?void 0:i.keyboard)==null?!0:this.keyPress(e)},"_KeyPress");this._KeyUp=o(e=>{let n=je(e);var i=ws(e,this.processor,this.hardDevice);if(i==null||n==null)return!0;var s=n.getElement();if(i.Lcode==13){var l=!1;if(j(s,"HTMLTextAreaElement")&&(l=!0),!l)return s instanceof s.ownerDocument.defaultView.HTMLInputElement&&(s.form&&(s.type=="search"||s.type=="submit")?s.form.submit():this.contextManager.page.findNeighboringInput(s,!1).focus()),!0}return this.keyUp(e)},"_KeyUp");this.hardDevice=e,this.contextManager=i,this.processor=n;let s=i.page,l=this.domEventTracker;s.on("enabled",r=>{let c=Ve(r);if(!(c instanceof P))l.attachDOMEvent(r,"keypress",this._KeyPress),l.attachDOMEvent(r,"keydown",this._KeyDown),l.attachDOMEvent(r,"keyup",this._KeyUp);else{let g=c.getElement().contentDocument;l.attachDOMEvent(g.body,"keydown",this._KeyDown),l.attachDOMEvent(g.body,"keypress",this._KeyPress),l.attachDOMEvent(g.body,"keyup",this._KeyUp)}}),s.on("disabled",r=>{let c=Ve(r);if(!(c instanceof P))l.detachDOMEvent(r,"keypress",this._KeyPress),l.detachDOMEvent(r,"keydown",this._KeyDown),l.detachDOMEvent(r,"keyup",this._KeyUp);else{let g=c.getElement().contentDocument;l.detachDOMEvent(g.body,"keydown",this._KeyDown),l.detachDOMEvent(g.body,"keypress",this._KeyPress),l.detachDOMEvent(g.body,"keyup",this._KeyUp)}})}keyDown(e){this.swallowKeypress=!1;var n=ws(e,this.processor,this.hardDevice);if(n==null)return!0;let i={LeventMatched:!1};return this.emit("keyevent",n,(s,l)=>{i.LeventMatched=s&&!s.triggerKeyDefault,i.LeventMatched?(e&&e.preventDefault&&(e.preventDefault(),e.stopPropagation()),this.swallowKeypress=!!n.Lcode,n.Lcode==8&&(this.swallowKeypress=!1)):this.swallowKeypress=!1}),!i.LeventMatched}keyUp(e){var n=ws(e,this.processor,this.hardDevice);if(n==null)return!0;let i=je(e);return this.processor.doModifierPress(n,i,!1)}keyPress(e){var s;var n=ws(e,this.processor,this.hardDevice);if(n==null||n.LisVirtualKey)return!0;if(!((s=this.contextManager.activeKeyboard)!=null&&s.keyboard.isMnemonic))return!this.swallowKeypress||n.Lcode<32||this.hardDevice.browser==V.Browser.Safari&&n.Lcode>63232&&n.Lcode<63744;let i={};return this.swallowKeypress||this.emit("keyevent",n,(l,r)=>{i.preventDefaultKeystroke=!!l}),this.swallowKeypress||i.preventDefaultKeystroke?(this.swallowKeypress=!1,e&&e.preventDefault&&(e.preventDefault(),e.stopPropagation()),!1):(this.swallowKeypress=!1,!0)}shutdown(){this.domEventTracker.shutdown()}};o(Dc,"HardwareEventKeyboard");var Ri=Dc;var Oc=class Oc{constructor(){this.innerWidth=window.innerWidth,this.innerHeight=window.innerHeight}equals(t){return this.innerWidth==t.innerWidth&&this.innerHeight==t.innerHeight}};o(Oc,"RotationState");var Ms=Oc,bt=class bt{constructor(t){this.idlePermutationCounter=bt.IDLE_PERMUTATION_CAP;this.keyman=t}resolve(){var n;var t=this.keyman.osk;(n=this.keyman.touchLanguageMenu)==null||n.hide(),this.keyman.touchLanguageMenu=null,t.setNeedsLayout(),this.oskVisible&&t.present(),this.isActive=!1,this.updateTimer&&(window.clearInterval(this.updateTimer),this.rotState=null);let e=this.keyman.contextManager.activeTarget;e&&window.setTimeout(()=>{this.keyman.ensureElementVisibility(e.getElement())},0)}initNewRotation(){this.oskVisible=this.keyman.osk.isVisible(),this.keyman.osk.hideNow(),this.isActive=!0}init(){var t=this.keyman.config.hostDevice.OS,e=this.keyman.util;t=="ios"?(e.attachDOMEvent(window,"orientationchange",()=>(this.iOSEventHandler(),!1)),e.attachDOMEvent(window,"resize",()=>(this.iOSEventHandler(),!1))):t=="android"&&("onmozorientationchange"in screen?e.attachDOMEvent(screen,"mozorientationchange",()=>(this.initNewRotation(),!1)):e.attachDOMEvent(window,"orientationchange",()=>(this.initNewRotation(),!1)),e.attachDOMEvent(window,"resize",()=>(this.resolve(),!1)))}iOSEventHandler(){this.isActive||(this.initNewRotation(),this.rotState=new Ms,this.updateTimer=window.setInterval(this.iOSEventUpdate.bind(this),bt.UPDATE_INTERVAL)),this.idlePermutationCounter=0}iOSEventUpdate(){var t=new Ms;this.rotState.equals(t)?++this.idlePermutationCounter==bt.IDLE_PERMUTATION_CAP&&this.resolve():(this.rotState=t,this.idlePermutationCounter=0)}};o(bt,"RotationProcessor"),bt.IDLE_PERMUTATION_CAP=15,bt.UPDATE_INTERVAL=20;var Ks=bt;var Pc=class Pc{constructor(t,e){this.domEventTracker=new xe;this.suppressFocusCheck=o(t=>(this.focusAssistant.isTargetForcingScroll()&&(t.stopPropagation(),t.cancelBubble=!0),!0),"suppressFocusCheck");this.pageFocusHandler=o(()=>{var t;return!this.focusAssistant.maintainingFocus&&((t=this.engine.osk)!=null&&t.vkbd)&&(this.engine.contextManager.deactivateCurrentTarget(),this.engine.contextManager.resetContext()),!1},"pageFocusHandler");this.touchStartActivationHandler=o(t=>{var i,s;let e=this.engine.osk;if(!e)return!1;let n=this.engine.config.hostDevice;if(this.deactivateOnRelease=!0,this.touchY=t.touches[0].screenY,this.deactivateOnScroll=!1,n.OS=="android"&&n.browser=="chrome"){if(typeof e._Box=="undefined"||typeof e._Box.style=="undefined")return!1;let l=t.target.parentElement;if(typeof l!="undefined"&&l!=null&&(((i=l.getAttribute("class"))==null?void 0:i.indexOf("kmw-key-"))>=0||typeof l.parentElement!="undefined"&&l.parentElement!=null&&(l=l.parentElement,((s=l.getAttribute("class"))==null?void 0:s.indexOf("kmw-key-"))>=0)))return!1;this.deactivateOnScroll=!0}return!1},"touchStartActivationHandler");this.touchMoveActivationHandler=o(t=>{this.deactivateOnScroll&&(this.focusAssistant.focusing=!1,this.engine.contextManager.deactivateCurrentTarget());let e=t.touches[0].screenY,n=this.touchY;return(e-n>5||n-e<5)&&(this.deactivateOnRelease=!1),!1},"touchMoveActivationHandler");this.touchEndActivationHandler=o(t=>(this.deactivateOnRelease&&!this.engine.touchLanguageMenu&&!this.focusAssistant.focusing&&this.engine.contextManager.deactivateCurrentTarget(),this.deactivateOnRelease=!1,!1),"touchEndActivationHandler");this._WindowLoad=o(()=>{document.body.scrollTop=0,typeof document.documentElement!="undefined"&&(document.documentElement.scrollTop=0)},"_WindowLoad");this._WindowUnload=o(()=>{this.engine.shutdown()},"_WindowUnload");this.window=t,this.engine=e,this.attachHandlers(),e.config.hostDevice.touchable&&(this.buildPageTrailer(),this.rotationProcessor=new Ks(this.engine),this.rotationProcessor.init())}buildPageTrailer(){let t=this.mobilePageTrailer=document.createElement("div"),e=t.style;e.width="100%",e.height=screen.width/2+"px",document.body.appendChild(t)}get focusAssistant(){return this.engine.contextManager.focusAssistant}attachHandlers(){let t=this.domEventTracker,e=this.engine.config.hostDevice,n=this.window.document.body;t.attachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),t.attachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),t.attachDOMEvent(n,"focus",this.suppressFocusCheck,!0),t.attachDOMEvent(n,"blur",this.suppressFocusCheck,!0),e.touchable&&(t.attachDOMEvent(n,"touchstart",this.touchStartActivationHandler,!1),t.attachDOMEvent(n,"touchmove",this.touchMoveActivationHandler,!1),t.attachDOMEvent(n,"touchend",this.touchEndActivationHandler,!1)),t.attachDOMEvent(window,"load",this._WindowLoad,!1),t.attachDOMEvent(window,"unload",this._WindowUnload,!1),t.attachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}shutdown(){var i;let t=this.domEventTracker,e=this.engine.config.hostDevice,n=this.window.document.body;t.detachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),t.detachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),t.detachDOMEvent(n,"focus",this.suppressFocusCheck,!0),t.detachDOMEvent(n,"blur",this.suppressFocusCheck,!0),e.touchable&&(t.detachDOMEvent(n,"touchstart",this.touchStartActivationHandler,!1),t.detachDOMEvent(n,"touchmove",this.touchMoveActivationHandler,!1),t.detachDOMEvent(n,"touchend",this.touchEndActivationHandler,!1),(i=this.mobilePageTrailer)==null||i.parentElement.removeChild(this.mobilePageTrailer)),t.detachDOMEvent(window,"load",this._WindowLoad,!1),t.detachDOMEvent(window,"unload",this._WindowUnload,!1),t.detachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}};o(Pc,"PageIntegrationHandlers");var zs=Pc;function pe(a){let t=document.createElement(a);return t.style.userSelect="none",t.style.MozUserSelect="none",t.style.KhtmlUserSelect="none",t.style.UserSelect="none",t.style.WebkitUserSelect="none",t}o(pe,"_CreateElement");function Jt(a,t){try{if(a&&typeof window.getComputedStyle!="undefined")return window.getComputedStyle(a,"").getPropertyValue(t)}catch(e){}return""}o(Jt,"getStyleValue");var jc=class jc{constructor(t){this.keyman=t,this.scrolling=!1,this.shim=this.constructShim()}constructShim(){let t=this,e=pe("div"),n=this.keyman.osk;return e.id="kmw-language-menu-background",e.addEventListener("touchstart",i=>{if(i.preventDefault(),t.hide(),i.touches.length>2){var s=i.touches[1].pageX,l=i.touches[1].pageY;let r=n.vkbd.spaceBar;s>r.offsetLeft&&s<r.offsetLeft+r.offsetWidth&&l>r.offsetTop&&l<r.offsetTop+r.offsetHeight&&this.keyman.osk.emit("showbuild")}},!1),e}show(){let t=this.keyman.config.hostDevice,e=this.keyman.keyboardRequisitioner.cache.getStubList();if(e.length<1)return;var i=this.lgList=pe("div");this.lgList.id="kmw-language-menu";let s=this;document.body.appendChild(this.shim);var l=pe("div"),r=l.style,c=pe("div");l.id="kmw-menu-scroll-container",c.id="kmw-menu-scroller","WebkitOverflowScrolling"in r&&(r.WebkitOverflowScrolling="touch"),l.appendChild(c),i.appendChild(l);let g,d=pe("div");d.id="kmw-menu-index";for(let Q=1;Q<=26;Q++)g=pe("p"),g.innerHTML=String.fromCharCode(Q+64),d.appendChild(g);if(d.addEventListener("touchstart",function(Q){s.scrollToLanguage(Q,l,c)},!1),d.addEventListener("touchend",function(Q){Q.stopPropagation()},!1),i.appendChild(d),i.addEventListener("scroll",function(Q){s.scrolling=!0},!1),l.addEventListener("scroll",function(Q){l.scrollTop<1&&(l.scrollTop=1),l.scrollTop>l.scrollHeight-l.offsetHeight-1&&(l.scrollTop=l.scrollHeight-l.offsetHeight-1)},!1),this.activeLgNo=this.addLanguages(c,e),this.lgList.style.visibility="hidden",document.body.appendChild(this.lgList),t.OS=="android"&&"devicePixelRatio"in window&&(this.lgList.style.fontSize=2/window.devicePixelRatio+"em"),t.OS=="android"&&t.formFactor=="tablet"&&"devicePixelRatio"in window){var u=parseInt(Jt(i,"width"),10),I=i.style;isNaN(u)||(I.width=I.maxWidth=2*u/window.devicePixelRatio+"px"),u=parseInt(Jt(l,"width"),10),I=l.style,isNaN(u)||(I.width=I.maxWidth=2*u/window.devicePixelRatio+"px"),u=parseInt(Jt(c,"width"),10),I=c.style,isNaN(u)||(I.width=I.maxWidth=2*u/window.devicePixelRatio+"px")}this.adjust(0);var B=d.childNodes[1].offsetTop-d.childNodes[0].offsetTop,h=Math.floor(i.offsetHeight/26),b=Math.round(100*h/B)/100,F=b>.6?1:2;b>1.25&&(b=1.25);for(let Q=0;Q<26;Q++){var G=d.childNodes[Q].style;F==2&&Q%2==1?G.display="none":(G.fontSize=b*F+"em",G.lineHeight=h*F+"px")}var U=l.offsetWidth;l.scrollHeight>l.offsetHeight+3?U=U+d.offsetWidth:d.style.display="none",i.style.width=U+"px",this.lgList.style.visibility="",this.scrollToIndex(this.activeLgNo,l,c)}adjust(t){let e=this.keyman.osk,n=this.keyman.config.hostDevice;var i=this.lgList,s=i.firstChild,l=s.firstChild,r=0,c=i.style,g=i.childNodes[1],d=window.innerHeight-e.vkbd.lgKey.offsetHeight-16,u=l.childNodes.length+t-1,I=l.firstChild.firstChild.offsetHeight,B=u*I;n.OS=="ios"&&(n.formFactor=="phone"?(r=be()?36:0,d=(window.innerHeight-r-16)*Se(n.formFactor)):n.formFactor=="tablet"&&(r=be()?16:0,d=d-r)),c.left=K(e.vkbd.lgKey)+"px",B>d&&(B=d),c.height=B+"px",c.bottom="0px",g.style.height=s.style.height=c.height}scrollToLanguage(t,e,n){t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault();let i=t.touches[0].target;if(i.nodeName=="P"){var s,l,r=i.innerHTML.charCodeAt(0),c=n.childNodes;try{for(s=0;s<c.length-1&&(l=c[s].firstChild.innerHTML.toUpperCase().charCodeAt(0),!(l>=r));s++);}catch(g){}this.scrollToIndex(s,e,n)}}scrollToIndex(t,e,n){let i;try{i=n.firstChild.getBoundingClientRect().height*(t-.5)+1,e.scrollTop=i}catch(l){i=0}try{e.scrollTop<0&&(e.scrollTop=0),e.scrollTop>e.scrollHeight-e.offsetHeight-1&&(e.scrollTop=e.scrollHeight-e.offsetHeight-1)}catch(l){}}addLanguages(t,e){var d;var n=e.length;let i=this.keyman.config.hostDevice,s=[];for(let u=0;u<n;u++){let I=e[u].KL;s.indexOf(I)==-1&&s.push(I)}s.sort();var l=Math.round(100/Se(i.formFactor))/100;let r=-1;for(let u=0;u<s.length;u++){let I=pe("div");I.className="kbd-list-closed";let B=pe("p");B.kList=[];for(let b=0;b<n;b++)e[b].KL==s[u]&&B.kList.push(e[b]);i.OS=="ios"&&(B.style.fontSize=l+"em"),I.appendChild(B),t.appendChild(I),s[u]==((d=this.keyman.contextManager.activeKeyboard)==null?void 0:d.metadata.langName)&&(r=u);let h=this;if(B.kList.length>1){B.className="kbd-list",B.innerHTML=s[u]+"...",B.scrolled=!1,B.ontouchend=b=>{b.stopPropagation(),B.scrolled?B.scrolled=!1:B.parentElement.className=B.parentElement.className=="kbd-list-closed"?"kbd-list-open":"kbd-list-closed",h.adjust(B.parentElement.className=="kbd-list-closed"?0:B.kList.length)},B.addEventListener("touchstart",function(b){b.stopPropagation()},!1),B.addEventListener("touchmove",function(b){B.scrolled=!0,b.stopPropagation()},!1);for(let b=0;b<B.kList.length;b++){let F=pe("p");F.className="kbd-list-entry",i.OS=="ios"&&(F.style.fontSize=l+"em"),this.addKeyboard(B.kList[b],F,!1),I.appendChild(F)}}else B.innerHTML=s[u],B.className="kbd-single-entry",this.addKeyboard(B.kList[0],B,!0);u==r&&(B.className=B.className+" current")}var c=pe("div");c.id="kmw-menu-footer";var g=o(function(u){u.cancelable&&u.preventDefault(),u.stopPropagation()},"cancelTouch");return c.addEventListener("touchstart",g,!1),c.addEventListener("touchmove",g,!1),c.addEventListener("touchend",g,!1),t.appendChild(c),r}addKeyboard(t,e,n){e.kn=t.KI,e.kc=t.KLC,e.innerHTML=n?t.KL:t.KN.replace(" Keyboard","");let i=this,s=o(()=>{if(this.originalBodyStyle)return console.error("Unexpected state:  `originalBodyStyle` was not cleared by a previous `unlockBodyScroll()` call"),!1;this.originalBodyStyle={};let u=this.originalBodyStyle,I=document.body.style;return u.overflowY=I.overflowY,u.height=I.height,I.overflowY="hidden",I.height="100%",!0},"lockBodyScroll"),l=o(()=>{if(!this.originalBodyStyle){console.error("Unexpected state:  `originalBodyStyle` is unset; cannot restore original body style");return}let u=this.originalBodyStyle,I=document.body.style;I.overflowY=u.overflowY,I.height=u.height,this.originalBodyStyle=null},"unlockBodyScroll"),r=o(function(u){u.stopPropagation(),this.className.indexOf("selected")<=0&&(this.className=this.className+" selected"),i.scrolling=!1,i.y0=u.touches[0].pageY,s()},"touchStart"),c=o(function(u){u.stopImmediatePropagation();var I=i.lgList.childNodes[0],B=I.scrollHeight-I.offsetHeight,h,b;if(typeof u.pageY!="undefined")h=u.pageY;else if(typeof u.touches!="undefined")h=u.touches[0].pageY;else return!1;if(b=h-i.y0,b<0)I.scrollTop>=B-1&&(i.y0=h);else if(b>0)I.scrollTop<2&&(i.y0=h);else return!1;return(b<-5||b>5)&&(i.scrolling=!0,this.className=this.className.replace(/\s*selected/,""),i.y0=h),!0},"touchMove"),g=o(function(u){let I=this;return typeof u.stopImmediatePropagation!="undefined"?u.stopImmediatePropagation():u.stopPropagation(),i.scrolling?this.className=this.className.replace(/\s*selected/,""):(i.keyman.contextManager.focusAssistant.setFocusTimer(),i.lgList.style.display="none",i.keyman.contextManager.activateKeyboard(I.kn,I.kc,!0),i.keyman.contextManager.restoreLastActiveTarget(),i.hide()),l(),!0},"touchEnd"),d=o(function(u){l()},"touchCancel");e.addEventListener("touchstart",r,!1),e.addEventListener("touchmove",c,!1),e.addEventListener("touchend",g,!1),e.addEventListener("touchcancel",d,!1)}hide(){let t=this.keyman.osk;this.lgList&&(t.vkbd.highlightKey(t.vkbd.lgKey,!1),this.lgList.style.visibility="hidden",window.setTimeout(()=>{this.shim.parentElement&&(document.body.removeChild(this.shim),document.body.removeChild(this.lgList))},500)),this.keyman.touchLanguageMenu=null}};o(jc,"LanguageMenu");var Ds=jc;function na(a,t,e){let n=e.focusAssistant;t.on("globekey",(i,s)=>{s&&t.hostDevice.touchable&&(a.touchLanguageMenu=new Ds(a),a.touchLanguageMenu.show()),t.vkbd&&t.vkbd.highlightKey(i,!1)}),t.on("hiderequested",i=>{t&&(t.startHide(!0),e.forgetActiveTarget())}),t.addEventListener("hide",i=>{var s;i!=null&&i.HiddenByUser&&((s=e.activeTarget)==null||s.focus())}),t.on("showbuild",()=>{var i;(i=a.config.alertHost)==null||i.alert("KeymanWeb Version "+Wn.VERSION+'<br /><br /><span style="font-size:0.8em">Copyright &copy; 2007-2023 SIL International</span>')}),t.on("dragmove",i=>W(this,null,function*(){n.restoringFocus=!0,yield i,e.restoreLastActiveTarget(),n.restoringFocus=!1,n.setMaintainingFocus(!1)})),t.on("resizemove",i=>W(this,null,function*(){n.restoringFocus=!0,yield i,e.restoreLastActiveTarget(),n.restoringFocus=!1,n.setMaintainingFocus(!1)})),t.on("pointerinteraction",i=>W(this,null,function*(){n.setMaintainingFocus(!0),yield i,n.setMaintainingFocus(!1)}))}o(na,"setupOskListeners");function hg(a){let t=document.createElement(a);return t.style.userSelect="none",t}o(hg,"createUnselectableElement");var _c=class _c{constructor(t){this.getAbsoluteX=K;this.getAbsoluteY=z;this._GetAbsoluteX=K;this._GetAbsoluteY=z;this._GetAbsolute=this.getAbsolute;this.toNzString=this.nzString;this.createElement=hg;this.getStyleValue=Jt;this.config=t,this.stylesheetManager=new ge(document.body,t.applyCacheBusting),this.domEventTracker=new xe}isTouchDevice(){return this.config.hostDevice.touchable}getAbsolute(t){return{x:K(t),y:z(t)}}getOption(t,e){return t in this.config.paths?this.config.paths[t]:t in this.config.options?this.config.options[t]:arguments.length>1?e:""}setOption(t,e){switch(t){case"attachType":break;case"ui":break;case"useAlerts":this.config.signalUser=e?new It:null;break;case"setActiveOnRegister":this.config.activateFirstKeyboard=!!e;break;case"spacebarText":this.config.spacebarText=e;break;default:throw new Error("Path-related options may not be changed after the engine has initialized.")}}loadCookie(t){return new le(t).load(decodeURIComponent)}saveCookie(t,e){new le(t).save(e,encodeURIComponent)}addStyleSheet(t){let e=st(t);return this.stylesheetManager.linkStylesheet(e),e}removeStyleSheet(t){return this.stylesheetManager.unlink(t)}linkStyleSheet(t){this.stylesheetManager.linkExternalSheet(t)}getLanguageCodes(t){return t.indexOf("-")==-1?[t]:t.split("-")}attachDOMEvent(t,e,n,i){this.domEventTracker.attachDOMEvent(t,e,n,i)}detachDOMEvent(t,e,n,i){this.domEventTracker.detachDOMEvent(t,e,n,i)}get alertHost(){return this.config.alertHost?this.config.alertHost:(this._alertHost||(this._alertHost=new It),this._alertHost)}alert(t,e){this.alertHost.alert(t,e)}nzString(t,e){let n="";return arguments.length>1&&(n=e),typeof t=="undefined"||t==null||t==0||t==""?n:""+t}toNumber(t,e){let n=parseInt(t,10);return isNaN(n)?e:n}toFloat(t,e){let n=parseFloat(t);return isNaN(n)?e:n}rgba(t,e,n,i,s){let l="transparent";try{l="rgba("+e+","+n+","+i+","+s+")"}catch(r){l="rgb("+e+","+n+","+i+")"}return l}shutdown(){var t,e,n;(t=this.stylesheetManager)==null||t.unlinkAll(),(e=this.domEventTracker)==null||e.shutdown(),(n=this._alertHost)==null||n.shutdown()}};o(_c,"UtilApiEndpoint");var Os=_c;var $c=class $c{constructor(t,e,n){this.code=t,this.shift=e,this.handler=n}matches(t,e){return this.code==t&&this.shift==e}};o($c,"Hotkey");var qc=$c,eo=class eo{constructor(){this.hotkeys=[];this._Process=o(t=>{t||(t=window.event);var e=zc(t);if(e==null)return!1;for(var n=(t.shiftKey?16:0)|(t.ctrlKey?32:0)|(t.altKey?64:0),i=0;i<this.hotkeys.length;i++)if(this.hotkeys[i].matches(e,n))return this.hotkeys[i].handler(),t.returnValue=!1,t&&t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,!1;return!0},"_Process")}addHotKey(t,e,n){for(var i=0;i<this.hotkeys.length;i++)if(this.hotkeys[i].code==t&&this.hotkeys[i].shift==e){this.hotkeys[i].handler=n;return}this.hotkeys.push(new qc(t,e,n))}removeHotkey(t,e){for(var n=0;n<this.hotkeys.length;n++)if(this.hotkeys[n].matches(t,e)){this.hotkeys.splice(n,1);return}}};o(eo,"HotkeyManager");var Ps=eo;var no=class no{constructor(t){this.e=t,this.c=t.style.backgroundColor}reset(){this.e.style.backgroundColor=this.c}};o(no,"BeepData");var to=no,io=class io{constructor(t){this._BeepObjects=[];this._BeepTimeout=0;this.reset=o(()=>{this.keyboardInterface.resetContextCache();var t;for(this._BeepTimeout=0,t=0;t<this._BeepObjects.length;t++)this._BeepObjects[t].reset();this._BeepObjects=[]},"reset");this.keyboardInterface=t}beep(t){if(t instanceof O){var e=t.getElement();if(t instanceof P&&(e=t.docRoot),!!e&&!(!e.style||typeof e.style.backgroundColor=="undefined")){for(var n=0;n<this._BeepObjects.length;n++)if(this._BeepObjects[n].e==e)return;this._BeepObjects.push(new to(e)),e.style.backgroundColor="#000000",this._BeepTimeout==0&&(this._BeepTimeout=1,window.setTimeout(this.reset,50))}}}};o(io,"BeepHandler");var js=io;var so=class so extends Xt{constructor(e,n){super(e,n);this.GetLastActiveElement=this.getLastActiveElement;this.FocusLastActiveElement=this.focusLastActiveElement;this.HideHelp=this.hideHelp;this.ShowHelp=this.showHelp;this.ShowPinnedHelp=this.showPinnedHelp}saveFocus(){this.engine.contextManager.focusAssistant._IgnoreNextSelChange=1}getLastActiveElement(){return this.engine.contextManager.lastActiveTarget}focusLastActiveElement(){this.engine.contextManager.restoreLastActiveTarget()}hideHelp(){this.engine.osk.startHide(!0)}showHelp(e,n){let i=this.engine.osk;i instanceof Oe?i.presentAtPosition(e,n):i.present()}showPinnedHelp(){let e=this.engine.osk;e instanceof Oe&&(!e.activeKeyboard.keyboard.isCJK||!this.ruleBehavior)&&(e.userPositioned=!0),e.present()}};o(so,"KeyboardInterface");var Qn=so;(function(){Qn.__publishShorthandAPI()})();var _s=class _s extends rn{constructor(e,n){let i=new Ns(n);super(e,i,new fi(i,()=>this.legacyAPIEvents),s=>({keyboardInterface:new Qn(window,s),defaultOutputRules:new Li(s.contextManager)}));this._initialized=0;this.hotkeyManager=new Ps;this.getOskHeight=null;this.getOskWidth=null;this.helpURL="https://help.keyman.com/go";this.keyEventRefocus=o(()=>{this.contextManager.restoreLastActiveTarget()},"keyEventRefocus");this._GetKeyboardDetail=o(function(e,n){return{Name:e.KN,InternalName:e.KI,LanguageName:e.KL,LanguageCode:e.KLC,RegionName:e.KR,RegionCode:e.KRC,CountryName:e.KC,CountryCode:e.KCC,KeyboardID:e.KD,Font:e.KFont,OskFont:e.KOskFont,HasLoaded:!!n,IsRTL:n?n.isRTL:null}},"_GetKeyboardDetail");this._util=new Os(i),this.beepHandler=new js(this.core.keyboardInterface),this.core.keyboardProcessor.beepHandler=()=>this.beepHandler.beep(this.contextManager.activeTarget),this.hardKeyboard=new Ri(i.hardDevice,this.core.keyboardProcessor,this.contextManager),this.contextManager.on("targetchange",s=>{let l=s==null?void 0:s.getElement();this.osk&&(this.osk.activationModel.activationTrigger=l),this.config.hostDevice.touchable&&s&&this.ensureElementVisibility(l)})}ensureElementVisibility(e){if(!e||!this.osk)return;let n=z(e),i=window.pageYOffset,s=n-i;n>=i&&(s-=window.innerHeight-this.osk._Box.offsetHeight-e.offsetHeight-2,s<0&&(s=0)),s!=0&&window.scrollTo(0,s+i)}get util(){return this._util}get views(){return xc}get initialized(){return this._initialized}get ui(){return this._ui}set ui(e){this._ui&&this._ui.shutdown(),this._ui=e,this.config.deferForInitialization.isFulfilled&&e.initialize()}init(e){return W(this,null,function*(){let i=new Qt().detect(),s=y(y({},ea),e);if(this.config.hostDevice=i,this.config.initialize(s),this._initialized=1,yield Vi(),this.config.deferForInitialization.isResolved)return Promise.resolve();yield Ji(_s.prototype,this,"init").call(this,s),this.keyboardRequisitioner.cloudQueryEngine.once("unboundregister",()=>{var r;(r=this.contextManager.activeKeyboard)!=null&&r.keyboard||this.setActiveKeyboard("","")}),this.contextManager.initialize();let l=this.contextManager.getSavedKeyboardRaw();i.touchable?this.osk=new Qi(this):this.osk=new Ui(this),na(this,this.osk,this.contextManager),this.pageIntegration=new zs(window,this),this.config.finalizeInit(),this.ui&&(this.ui.initialize(),this.legacyAPIEvents.callEvent("loaduserinterface",{})),this._initialized=2,yield Promise.resolve(),this.contextManager.restoreSavedKeyboard(l),yield Promise.resolve()})}get register(){return this.keyboardRequisitioner.cloudQueryEngine.registerFromCloud}getUIState(){return this.contextManager.focusAssistant.getUIState()}activatingUI(e){this.contextManager.focusAssistant.setMaintainingFocus(!!e)}setKeyboardForControl(e,n,i){if(e instanceof e.ownerDocument.defaultView.HTMLIFrameElement){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}if(!this.isAttached(e)){console.error("KeymanWeb is not attached to element "+e);return}let s=null;if(n&&(s=this.keyboardRequisitioner.cache.getStub(n,i),!s))throw new Error(`No keyboard has been registered with id ${n} and language code ${i}.`);this.contextManager.setKeyboardForTarget(e._kmwAttachment.interface,n,i)}getKeyboardForControl(e){let n=Ve(e);return this.contextManager.getKeyboardStubForTarget(n).id}getLanguageForControl(e){let n=Ve(e);return this.contextManager.getKeyboardStubForTarget(n).langId}isAttached(e){return this.contextManager.page.isAttached(e)}addKeyboards(...e){return this.config.deferForInitialization.then(()=>{if(!e||!e[0]||e[0].length==0)return this.keyboardRequisitioner.fetchCloudCatalog().catch(n=>(console.error(n[0].error),n));{let n=[];return Array.isArray(e[0])?n=n.concat(e[0]):Array.isArray(e)&&(n=n.concat(e)),this.keyboardRequisitioner.addKeyboardArray(n)}})}addKeyboardsForLanguage(e){return this.config.deferForInitialization.then(()=>typeof e=="string"?this.keyboardRequisitioner.addLanguageKeyboards(e.split(",").map(n=>n.trim())):this.keyboardRequisitioner.addLanguageKeyboards(e))}isCJK(e){let n;if(e){let i=e;i.KeyboardID?n=this.keyboardRequisitioner.cache.getKeyboard(i.KeyboardID):n=new Y(e)}else n=this.core.activeKeyboard;return n&&n.isCJK}getKeyboard(e,n){let i=this.keyboardRequisitioner.cache.getStub(e,n),s=this.keyboardRequisitioner.cache.getKeyboardForStub(i);return i&&this._GetKeyboardDetail(i,s)}getKeyboards(){let e=[],n=this.keyboardRequisitioner.cache,i=n.getStubList();for(let s=0;s<i.length;s++){let l=i[s],r=n.getKeyboardForStub(l),c=this._GetKeyboardDetail(l,r);e.push(c)}return e}removeKeyboards(...e){var n;for(let i=0;i<e.length;i++)this.keyboardRequisitioner.cache.forgetKeyboard(e[i],!0),((n=this.contextManager.activeKeyboard)==null?void 0:n.metadata.id)==se(e[i])&&this.contextManager.activateKeyboard("","");return!0}getSavedKeyboard(){return this.contextManager.getSavedKeyboard()}focusLastActiveElement(){var e;(e=this.contextManager.lastActiveTarget)==null||e.focus()}getLastActiveElement(){var e;return(e=this.contextManager.lastActiveTarget)==null?void 0:e.getElement()}setActiveElement(e,n){if(typeof e=="string"){let s=e;if(e=document.getElementById(e),!e)throw new Error(`Could not find the specified element (id: ${s}`)}let i=Ve(e);if(!i)throw new Error(`KMW is not attached to the specified element (id: ${e.id}).`);this.contextManager.setActiveTarget(i,n)}moveToElement(e){typeof e=="string"&&(e=document.getElementById(e)),e.focus()}addHotKey(e,n,i){this.hotkeyManager.addHotKey(e,n,i)}removeHotKey(e,n){this.hotkeyManager.removeHotkey(e,n)}attachToControl(e){this.contextManager.page.attachToControl(e)}detachFromControl(e){this.contextManager.page.detachFromControl(e)}disableControl(e){this.contextManager.page.disableControl(e)}enableControl(e){this.contextManager.page.enableControl(e)}BuildVisualKeyboard(e,n,i,s){let l=null;e!=null&&(l=this.keyboardRequisitioner.cache.getKeyboard(e)),l=l||this.core.activeKeyboard;let r=this.keyboardRequisitioner.cache.getStub(l),c=this.getOskHeight,g=(typeof c=="function"?c():null)||this.osk.computedHeight||200;return me.buildDocumentationKeyboard(l,r,this.config.paths,i,s,g)}shutdown(){var e,n;this.pageIntegration.shutdown(),this.contextManager.shutdown(),(e=this.osk)==null||e.shutdown(),this.core.languageProcessor.shutdown(),this.hardKeyboard.shutdown(),this.util.shutdown(),this.legacyAPIEvents.callEvent("unloaduserinterface",{}),(n=this.ui)==null||n.shutdown()}};o(_s,"KeymanEngine");var vi=_s;var ia=document.getElementsByTagName("script"),sa=ia[ia.length-1].src,Fg=sa.substr(0,sa.lastIndexOf("/")+1);window.keyman=new vi(nn.constructInstance(),Fg);})();
//# sourceMappingURL=keymanweb.js.map
