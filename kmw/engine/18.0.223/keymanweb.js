"use strict";(()=>{var oa=Object.create;var Yt=Object.defineProperty,aa=Object.defineProperties,ao=Object.getOwnPropertyDescriptor,ga=Object.getOwnPropertyDescriptors,da=Object.getOwnPropertyNames,ro=Object.getOwnPropertySymbols,go=Object.getPrototypeOf,uo=Object.prototype.hasOwnProperty,ua=Object.prototype.propertyIsEnumerable,Ba=Reflect.get;var oo=(g,n,t)=>n in g?Yt(g,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[n]=t,C=(g,n)=>{for(var t in n||(n={}))uo.call(n,t)&&oo(g,t,n[t]);if(ro)for(var t of ro(n))ua.call(n,t)&&oo(g,t,n[t]);return g},W=(g,n)=>aa(g,ga(n)),a=(g,n)=>Yt(g,"name",{value:n,configurable:!0});var Ia=(g,n)=>()=>(n||g((n={exports:{}}).exports,n),n.exports),Sn=(g,n)=>{for(var t in n)Yt(g,t,{get:n[t],enumerable:!0})},ba=(g,n,t,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let l of da(n))!uo.call(g,l)&&l!==t&&Yt(g,l,{get:()=>n[l],enumerable:!(i=ao(n,l))||i.enumerable});return g};var ha=(g,n,t)=>(t=g!=null?oa(go(g)):{},ba(n||!g||!g.__esModule?Yt(t,"default",{value:g,enumerable:!0}):t,g));var Qe=(g,n,t,i)=>{for(var l=i>1?void 0:i?ao(n,t):n,s=g.length-1,c;s>=0;s--)(c=g[s])&&(l=(i?c(n,t,l):c(l))||l);return i&&l&&Yt(n,t,l),l};var Ji=(g,n,t)=>Ba(go(g),t,n);var A=(g,n,t)=>new Promise((i,l)=>{var s=o=>{try{r(t.next(o))}catch(d){l(d)}},c=o=>{try{r(t.throw(o))}catch(d){l(d)}},r=o=>o.done?i(o.value):Promise.resolve(o.value).then(s,c);r((t=t.apply(g,n)).next())});var bo=Ia((Wg,$l)=>{"use strict";var Qa=Object.prototype.hasOwnProperty,q="~";function Wn(){}a(Wn,"Events");Object.create&&(Wn.prototype=Object.create(null),new Wn().__proto__||(q=!1));function Ua(g,n,t){this.fn=g,this.context=n,this.once=t||!1}a(Ua,"EE");function Io(g,n,t,i,l){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new Ua(t,i||g,l),c=q?q+n:n;return g._events[c]?g._events[c].fn?g._events[c]=[g._events[c],s]:g._events[c].push(s):(g._events[c]=s,g._eventsCount++),g}a(Io,"addListener");function Ei(g,n){--g._eventsCount===0?g._events=new Wn:delete g._events[n]}a(Ei,"clearEvent");function M(){this._events=new Wn,this._eventsCount=0}a(M,"EventEmitter");M.prototype.eventNames=a(function(){var n=[],t,i;if(this._eventsCount===0)return n;for(i in t=this._events)Qa.call(t,i)&&n.push(q?i.slice(1):i);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(t)):n},"eventNames");M.prototype.listeners=a(function(n){var t=q?q+n:n,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var l=0,s=i.length,c=new Array(s);l<s;l++)c[l]=i[l].fn;return c},"listeners");M.prototype.listenerCount=a(function(n){var t=q?q+n:n,i=this._events[t];return i?i.fn?1:i.length:0},"listenerCount");M.prototype.emit=a(function(n,t,i,l,s,c){var r=q?q+n:n;if(!this._events[r])return!1;var o=this._events[r],d=arguments.length,u,B;if(o.fn){switch(o.once&&this.removeListener(n,o.fn,void 0,!0),d){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,t),!0;case 3:return o.fn.call(o.context,t,i),!0;case 4:return o.fn.call(o.context,t,i,l),!0;case 5:return o.fn.call(o.context,t,i,l,s),!0;case 6:return o.fn.call(o.context,t,i,l,s,c),!0}for(B=1,u=new Array(d-1);B<d;B++)u[B-1]=arguments[B];o.fn.apply(o.context,u)}else{var b=o.length,I;for(B=0;B<b;B++)switch(o[B].once&&this.removeListener(n,o[B].fn,void 0,!0),d){case 1:o[B].fn.call(o[B].context);break;case 2:o[B].fn.call(o[B].context,t);break;case 3:o[B].fn.call(o[B].context,t,i);break;case 4:o[B].fn.call(o[B].context,t,i,l);break;default:if(!u)for(I=1,u=new Array(d-1);I<d;I++)u[I-1]=arguments[I];o[B].fn.apply(o[B].context,u)}}return!0},"emit");M.prototype.on=a(function(n,t,i){return Io(this,n,t,i,!1)},"on");M.prototype.once=a(function(n,t,i){return Io(this,n,t,i,!0)},"once");M.prototype.removeListener=a(function(n,t,i,l){var s=q?q+n:n;if(!this._events[s])return this;if(!t)return Ei(this,s),this;var c=this._events[s];if(c.fn)c.fn===t&&(!l||c.once)&&(!i||c.context===i)&&Ei(this,s);else{for(var r=0,o=[],d=c.length;r<d;r++)(c[r].fn!==t||l&&!c[r].once||i&&c[r].context!==i)&&o.push(c[r]);o.length?this._events[s]=o.length===1?o[0]:o:Ei(this,s)}return this},"removeListener");M.prototype.removeAllListeners=a(function(n){var t;return n?(t=q?q+n:n,this._events[t]&&Ei(this,t)):(this._events=new Wn,this._eventsCount=0),this},"removeAllListeners");M.prototype.off=M.prototype.removeListener;M.prototype.addListener=M.prototype.on;M.prefixed=q;M.EventEmitter=M;typeof $l!="undefined"&&($l.exports=M)});var m={LCTRLFLAG:1,RCTRLFLAG:2,LALTFLAG:4,RALTFLAG:8,K_SHIFTFLAG:16,K_CTRLFLAG:32,K_ALTFLAG:64,K_METAFLAG:128,CAPITALFLAG:256,NOTCAPITALFLAG:512,NUMLOCKFLAG:1024,NOTNUMLOCKFLAG:2048,SCROLLFLAG:4096,NOTSCROLLFLAG:8192,ISVIRTUALKEY:16384,VIRTUALCHARKEY:32768};var ki={K_BKSP:8,K_TAB:9,K_ENTER:13,K_SHIFT:16,K_CONTROL:17,K_ALT:18,K_PAUSE:19,K_CAPS:20,K_ESC:27,K_SPACE:32,K_PGUP:33,K_PGDN:34,K_END:35,K_HOME:36,K_LEFT:37,K_UP:38,K_RIGHT:39,K_DOWN:40,K_SEL:41,K_PRINT:42,K_EXEC:43,K_INS:45,K_DEL:46,K_HELP:47,K_0:48,K_1:49,K_2:50,K_3:51,K_4:52,K_5:53,K_6:54,K_7:55,K_8:56,K_9:57,K_A:65,K_B:66,K_C:67,K_D:68,K_E:69,K_F:70,K_G:71,K_H:72,K_I:73,K_J:74,K_K:75,K_L:76,K_M:77,K_N:78,K_O:79,K_P:80,K_Q:81,K_R:82,K_S:83,K_T:84,K_U:85,K_V:86,K_W:87,K_X:88,K_Y:89,K_Z:90,K_NP0:96,K_NP1:97,K_NP2:98,K_NP3:99,K_NP4:100,K_NP5:101,K_NP6:102,K_NP7:103,K_NP8:104,K_NP9:105,K_NPSTAR:106,K_NPPLUS:107,K_SEPARATOR:108,K_NPMINUS:109,K_NPDOT:110,K_NPSLASH:111,K_F1:112,K_F2:113,K_F3:114,K_F4:115,K_F5:116,K_F6:117,K_F7:118,K_F8:119,K_F9:120,K_F10:121,K_F11:122,K_F12:123,K_NUMLOCK:144,K_SCROLL:145,K_LSHIFT:160,K_RSHIFT:161,K_LCONTROL:162,K_RCONTROL:163,K_LALT:164,K_RALT:165,K_COLON:186,K_EQUAL:187,K_COMMA:188,K_HYPHEN:189,K_PERIOD:190,K_SLASH:191,K_BKQUOTE:192,K_LBRKT:219,K_BKSLASH:220,K_RBRKT:221,K_QUOTE:222,K_oE2:226,K_OE2:226,K_oC1:193,K_OC1:193,"K_?C1":193,"k_?C1":193,K_oDF:223,K_ODF:223,K_LOPT:50001,K_ROPT:50002,K_NUMERALS:50003,K_SYMBOLS:50004,K_CURRENCIES:50005,K_UPPER:50006,K_LOWER:50007,K_ALPHA:50008,K_SHIFTED:50009,K_ALTGR:50010,K_TABBACK:50011,K_TABFWD:50012},X=ki,Gg={2:X.K_1,3:X.K_2,4:X.K_3,5:X.K_4,6:X.K_5,7:X.K_6,8:X.K_7,9:X.K_8,10:X.K_9,11:X.K_0,12:X.K_HYPHEN,13:X.K_EQUAL,16:X.K_Q,17:X.K_W,18:X.K_E,19:X.K_R,20:X.K_T,21:X.K_Y,22:X.K_U,23:X.K_I,24:X.K_O,25:X.K_P,26:X.K_LBRKT,27:X.K_RBRKT,30:X.K_A,31:X.K_S,32:X.K_D,33:X.K_F,34:X.K_G,35:X.K_H,36:X.K_J,37:X.K_K,38:X.K_L,39:X.K_COLON,40:X.K_QUOTE,41:X.K_BKQUOTE,43:X.K_BKSLASH,44:X.K_Z,45:X.K_X,46:X.K_C,47:X.K_V,48:X.K_B,49:X.K_N,50:X.K_M,51:X.K_COMMA,52:X.K_PERIOD,53:X.K_SLASH,57:X.K_SPACE,86:X.K_oE2,115:X.K_oC1,125:X.K_oE2};var ya={};Sn(ya,{PRIVATE_USE_IDS:()=>Fa,TouchLayoutKeySp:()=>Bo});var Fa=["T_*_MT_SHIFT_TO_SHIFT","T_*_MT_SHIFT_TO_CAPS","T_*_MT_SHIFT_TO_DEFAULT"],Bo=(o=>(o[o.normal=0]="normal",o[o.special=1]="special",o[o.specialActive=2]="specialActive",o[o.customSpecial=3]="customSpecial",o[o.customSpecialActive=4]="customSpecialActive",o[o.deadkey=8]="deadkey",o[o.blank=9]="blank",o[o.spacer=10]="spacer",o))(Bo||{});var ma=55296,Ga=56319,pa=56320,Ca=57343;function Ni(g){return g>=ma&&g<=Ga}a(Ni,"Uni_IsSurrogate1");function Yi(g){return g>=pa&&g<=Ca}a(Yi,"Uni_IsSurrogate2");var e={};var VX={};var V=ha(bo(),1);var ho={modifierCodes:{LCTRL:m.LCTRLFLAG,RCTRL:m.RCTRLFLAG,LALT:m.LALTFLAG,RALT:m.RALTFLAG,SHIFT:m.K_SHIFTFLAG,CTRL:m.K_CTRLFLAG,ALT:m.K_ALTFLAG,META:m.K_METAFLAG,CAPS:m.CAPITALFLAG,NO_CAPS:m.NOTCAPITALFLAG,NUM_LOCK:m.NUMLOCKFLAG,NO_NUM_LOCK:m.NOTNUMLOCKFLAG,SCROLL_LOCK:m.SCROLLFLAG,NO_SCROLL_LOCK:m.NOTSCROLLFLAG,VIRTUAL_KEY:m.ISVIRTUALKEY,VIRTUAL_CHAR_KEY:m.VIRTUALCHARKEY},modifierBitmasks:{ALL:127,ALT_GR_SIM:5,CHIRAL:31,IS_CHIRAL:15,NON_CHIRAL:112,NON_LEGACY:111},stateBitmasks:{ALL:16128,CAPS:768,NUM_LOCK:3072,SCROLL_LOCK:12288},keyCodes:C({},ki),codesUS:[["0123456789",";=,-./`","[\\]'"],[")!@#$%^&*(",":+<_>?~",'{|}"']],isFrameKey(g){switch(g){case"K_SHIFT":case"K_LOPT":case"K_ROPT":case"K_NUMLOCK":case"K_CAPS":return!0;default:if(ho.keyCodes[g]>=5e4)return!0}return!1},getModifierState(g){var n=0;g.indexOf("shift")>=0&&(n|=m.K_SHIFTFLAG);var t=!1;g.indexOf("leftctrl")>=0&&(n|=m.LCTRLFLAG,t=!0),g.indexOf("rightctrl")>=0&&(n|=m.RCTRLFLAG,t=!0),g.indexOf("ctrl")>=0&&!t&&(n|=m.K_CTRLFLAG);var i=!1;return g.indexOf("leftalt")>=0&&(n|=m.LALTFLAG,i=!0),g.indexOf("rightalt")>=0&&(n|=m.RALTFLAG,i=!0),g.indexOf("alt")>=0&&!i&&(n|=m.K_ALTFLAG),n},getStateFromLayer(g){var n=0;return g.indexOf("caps")>=0?n|=m.CAPITALFLAG:n|=m.NOTCAPITALFLAG,n}},Q=ho;var es=class es{codeForEvent(n){return Q.keyCodes[n.kName]||n.Lcode}forAny(n,t,i){var l="";if((l=this.forSpecialEmulation(n))!=null)return l;if(!t&&(l=this.forNumpadKeys(n))!=null)return l;if((l=this.forUnicodeKeynames(n,i))!=null)return l;if((l=this.forBaseKeys(n,i))!=null)return l;switch(this.codeForEvent(n)){default:return null}}isCommand(n){switch(this.codeForEvent(n)){default:return!1}}applyCommand(n,t){}forSpecialEmulation(n){switch(this.codeForEvent(n)){case Q.keyCodes.K_BKSP:return"\b";case Q.keyCodes.K_ENTER:return`
`;default:return null}}forNumpadKeys(n){if(n.Lmodifiers!=m.K_SHIFTFLAG&&n.Lmodifiers!=0)return null;if(n.Lcode>=Q.keyCodes.K_NP0&&n.Lcode<=Q.keyCodes.K_NPSLASH){if(n.Lcode<106)var t=n.Lcode-48;else t=n.Lcode-64;return String._kmwFromCharCode(t)}else return null}forUnicodeKeynames(n,t){let i=n.kName;if(!i||i.substr(0,2)!="U_")return null;let l="",s=i.substr(2).split("_");for(let c of s){let r=parseInt(c,16);if(0<=r&&r<=31||128<=r&&r<=159||isNaN(r)){t&&(t.errorLog="Suppressing Unicode control code in "+i);continue}else l+=String.kmwFromCharCode(r)}return l||null}forBaseKeys(n,t){let i=n.Lcode,l=n.Lmodifiers;if(l==m.K_SHIFTFLAG)l=1;else if(l!=0)return t&&(t.warningLog="KMW only defines default key output for the 'default' and 'shift' layers!"),null;try{if(i==Q.keyCodes.K_SPACE)return" ";if(i>=Q.keyCodes.K_0&&i<=Q.keyCodes.K_9)return Q.codesUS[l][0][i-Q.keyCodes.K_0];if(i>=Q.keyCodes.K_A&&i<=Q.keyCodes.K_Z)return String.fromCharCode(i+(l?0:32));if(i>=Q.keyCodes.K_COLON&&i<=Q.keyCodes.K_BKQUOTE)return Q.codesUS[l][1][i-Q.keyCodes.K_COLON];if(i>=Q.keyCodes.K_LBRKT&&i<=Q.keyCodes.K_QUOTE)return Q.codesUS[l][2][i-Q.keyCodes.K_LBRKT];if(i==Q.keyCodes.K_oE2)return l?"|":"\\"}catch(s){t&&(t.errorLog="Error detected with default mapping for key:  code = "+i+", shift state = "+(l==1?"shift":"default"))}return null}};a(es,"DefaultRules");var We=es;var xa=new We,An=class An{constructor(n){this.isSynthetic=!0;for(let t in n)n[t]!==void 0&&(this[t]=n[t])}static constructNullKeyEvent(n){return new An({Lcode:0,kName:"",device:n,Lstates:void 0,Lmodifiers:void 0,vkCode:void 0,LisVirtualKey:void 0})}get isModifier(){switch(this.Lcode){case 16:case 17:case 18:case 20:case 144:case 145:return!0;default:return!1}}setMnemonicCode(n,t){if(this.Lcode!=Q.keyCodes.K_SPACE){let l=new An(this);for(let s in this)l[s]=this[s];l.kName="K_xxxx",l.Lmodifiers=n?16:0;var i=xa.forAny(l,!0);this.vkCode=this.Lcode,i?this.Lcode=i.charCodeAt(0):this.isModifier||delete this.Lcode}t&&(this.Lcode>=65&&this.Lcode<=90||this.Lcode>=97&&this.Lcode<=122)&&(this.Lmodifiers^=16,this.Lcode^=32)}};a(An,"KeyEvent");var te=An;var is=class is{};a(is,"KeyMap");var Ee=is,ls=class ls{constructor(){this.FF=new Ee;this.Safari=new Ee;this.Opera=new Ee;this.FF.k61=187,this.FF.k59=186,this.FF.k173=189}};a(ls,"BrowserKeyMaps");var ts=ls,ss=class ss{constructor(){this.se=new Ee,this.se.k220=192,this.se.k187=189,this.se.k219=187,this.se.k221=219,this.se.k186=221,this.se.k191=220,this.se.k192=186,this.se.k189=191,this.uk=new Ee,this.uk.k223=192,this.uk.k192=222,this.uk.k222=226,this.uk.k220=220}};a(ss,"LanguageKeyMaps");var ns=ss,Ae=class Ae{constructor(){}static _usCodeInit(){var n=new Ee,t=new Ee;n.k192=96,n.k49=49,n.k50=50,n.k51=51,n.k52=52,n.k53=53,n.k54=54,n.k55=55,n.k56=56,n.k57=57,n.k48=48,n.k189=45,n.k187=61,n.k81=113,n.k87=119,n.k69=101,n.k82=114,n.k84=116,n.k89=121,n.k85=117,n.k73=105,n.k79=111,n.k80=112,n.k219=91,n.k221=93,n.k220=92,n.k65=97,n.k83=115,n.k68=100,n.k70=102,n.k71=103,n.k72=104,n.k74=106,n.k75=107,n.k76=108,n.k186=59,n.k222=39,n.k90=122,n.k88=120,n.k67=99,n.k86=118,n.k66=98,n.k78=110,n.k77=109,n.k188=44,n.k190=46,n.k191=47,t.k192=126,t.k49=33,t.k50=64,t.k51=35,t.k52=36,t.k53=37,t.k54=94,t.k55=38,t.k56=42,t.k57=40,t.k48=41,t.k189=95,t.k187=43,t.k81=81,t.k87=87,t.k69=69,t.k82=82,t.k84=84,t.k89=89,t.k85=85,t.k73=73,t.k79=79,t.k80=80,t.k219=123,t.k221=125,t.k220=124,t.k65=65,t.k83=83,t.k68=68,t.k70=70,t.k71=71,t.k72=72,t.k74=74,t.k75=75,t.k76=76,t.k186=58,t.k222=34,t.k90=90,t.k88=88,t.k67=67,t.k86=86,t.k66=66,t.k78=78,t.k77=77,t.k188=60,t.k190=62,t.k191=63,Ae._usCharCodes=[n,t]}static _USKeyCodeToCharCode(n){return Ae.usCharCodes[n.Lmodifiers&16?1:0]["k"+n.Lcode]}static get usCharCodes(){return Ae._usCharCodes||Ae._usCodeInit(),Ae._usCharCodes}};a(Ae,"KeyMapping"),Ae.browserMap=new ts,Ae.languageMap=new ns;var ne=Ae;function oe(g){if(typeof g!="object"||!g)return g;{let n=Array.isArray(g)?[]:{},t=Object.keys(g);for(let i of t)g[i]!==void 0&&(n[i]=oe(g[i]));return n}}a(oe,"deepCopy");var Y=class Y{constructor(n,t,i,l){switch(n.toLowerCase()){case Y.Browser.Chrome:case Y.Browser.Edge:case Y.Browser.Firefox:case Y.Browser.Native:case Y.Browser.Opera:case Y.Browser.Safari:this.browser=n.toLowerCase();break;default:this.browser=Y.Browser.Other}switch(t.toLowerCase()){case Y.FormFactor.Desktop:case Y.FormFactor.Phone:case Y.FormFactor.Tablet:this.formFactor=t.toLowerCase();break;default:throw"Invalid form factor specified for device: "+t}switch(i.toLowerCase()){case Y.OperatingSystem.Windows.toLowerCase():case Y.OperatingSystem.macOS.toLowerCase():case Y.OperatingSystem.Linux.toLowerCase():case Y.OperatingSystem.Android.toLowerCase():case Y.OperatingSystem.iOS.toLowerCase():this.OS=i.toLowerCase();break;default:this.OS=Y.OperatingSystem.Other}this.touchable=l}};a(Y,"DeviceSpec");var yt=Y;(i=>{let g;(B=>(B.Chrome="chrome",B.Edge="edge",B.Firefox="firefox",B.Native="native",B.Opera="opera",B.Safari="safari",B.Other="other"))(g=i.Browser||(i.Browser={}));let n;(u=>(u.Windows="windows",u.macOS="macosx",u.Linux="linux",u.Android="android",u.iOS="ios",u.Other="other"))(n=i.OperatingSystem||(i.OperatingSystem={}));let t;(r=>(r.Desktop="desktop",r.Phone="phone",r.Tablet="tablet"))(t=i.FormFactor||(i.FormFactor={}))})(yt||(yt={}));function cs(g){return new yt(g.browser,"desktop",g.OS,!1)}a(cs,"physicalKeyDeviceAlias");var S=yt;var ae=class ae{};a(ae,"KEYMAN_VERSION"),ae.VERSION="18.0.223",ae.VERSION_RELEASE="18.0",ae.VERSION_MAJOR="18",ae.VERSION_MINOR="0",ae.VERSION_PATCH="223",ae.TIER="beta",ae.VERSION_TAG="-beta",ae.VERSION_WITH_TAG="18.0.223-beta",ae.VERSION_ENVIRONMENT="beta",ae.VERSION_GIT_TAG="release@18.0.223-beta";var Rn=ae,tt=Rn;var be=class be{constructor(n){if(n==null){this.components=[].concat(be.DEVELOPER_VERSION_FALLBACK.components);return}if(Array.isArray(n)){let l=n;if(l.length<2)throw new Error("Version string must have at least a major and minor component!");this.components=[].concat(l);return}let t=n.split("."),i=[];if(t.length<2)throw new Error("Version string must have at least a major and minor component!");for(let l=0;l<t.length;l++){let s=parseInt(t[l],10);if(isNaN(s))throw new Error("Version string components must be numerical!");i.push(s)}this.components=i}get major(){return this.components[0]}get minor(){return this.components[1]}toString(){return this.components.join(".")}toJSON(){return this.toString()}equals(n){return this.compareTo(n)==0}precedes(n){return this.compareTo(n)<0}compareTo(n){var t=this.components.length<n.components.length,i=this.components.length<n.components.length?this.components.length:n.components.length,l;for(l=0;l<i;l++){let c=this.components[l]-n.components[l];if(c!=0)return c}var s=t?n.components:this.components;do{if(s[l]>0)return t?-1:1;l++}while(l<s.length);return 0}};a(be,"Version"),be.CURRENT=new be(tt.VERSION_RELEASE),be.DEVELOPER_VERSION_FALLBACK=new be([9,0,0]),be.NO_DEFAULT_KEYCAPS=new be([12,0]),be.MAC_POSSIBLE_IPAD_ALIAS=new be([10,15]);var K=be;function Et(){return typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof self!="undefined"?self:global}a(Et,"getGlobalObject");function Hn(){String.kmwFromCharCode=function(g){var n=[],t;for(t=0;t<arguments.length;t++){var i=Number(arguments[t]);if(!isFinite(i)||i<0||i>1114111||Math.floor(i)!==i)throw new RangeError("Invalid code point "+i);i<65536?n.push(i):(i-=65536,n.push((i>>10)+55296),n.push(i%1024+56320))}return String.fromCharCode.apply(void 0,n)},String.prototype.kmwCharCodeAt=function(g){var n=String(this),t=0;if(g<0||g>=n.length)return NaN;for(var i=0;i<g;i++)if(t=n.kmwNextChar(t),t===null)return NaN;var l=n.charCodeAt(t);if(l>=55296&&l<=56319&&n.length>t+1){var s=n.charCodeAt(t+1);if(s>=56320&&s<=57343)return(l-55296<<10)+(s-56320)+65536}return l},String.prototype.kmwIndexOf=function(g,n){var t=String(this),i=t.indexOf(g,n);if(i<0)return i;for(var l=0,s=0;s!==null&&s<i;s=t.kmwNextChar(s))l++;return l},String.prototype.kmwLastIndexOf=function(g,n){var t=String(this),i=t.lastIndexOf(g,n);if(i<0)return i;for(var l=0,s=0;s!==null&&s<i;s=t.kmwNextChar(s))l++;return l},String.prototype.kmwLength=function(){var g=String(this);if(g.length==0)return 0;for(var n=0,t=0;t!==null;n++)t=g.kmwNextChar(t);return n},String.prototype.kmwSlice=function(g,n){var t=String(this),i=t.kmwCodePointToCodeUnit(g),l=t.kmwCodePointToCodeUnit(n);return i===null||l===null?"":t.slice(i,l)},String.prototype.kmwSubstr=function(g,n){var t=String(this);g<0&&(g=t.kmwLength()+g),g<0&&(g=0);var i=t.kmwCodePointToCodeUnit(g),l=i;if(i===null)return"";if(arguments.length<2)l=t.length;else for(var s=0;s<n;s++)l=t.kmwNextChar(l);return l===null?t.substring(i):t.substring(i,l)},String.prototype.kmwSubstring=function(g,n){var t=String(this),i,l;if(typeof n=="undefined")i=t.kmwCodePointToCodeUnit(g),l=t.length;else{if(g>n){var s=g;g=n,n=s}i=t.kmwCodePointToCodeUnit(g),l=t.kmwCodePointToCodeUnit(n)}return(isNaN(i)||i===null)&&(i=0),(isNaN(l)||l===null)&&(l=t.length),t.substring(i,l)},String.prototype.kmwNextChar=function(g){var n=String(this);if(g===null||g<0||g>=n.length-1)return null;var t=n.charCodeAt(g);if(t>=55296&&t<=56319&&n.length>g+1){var i=n.charCodeAt(g+1);if(i>=56320&&i<=57343)return g==n.length-2?null:g+2}return g+1},String.prototype.kmwPrevChar=function(g){var n=String(this);if(g==null||g<=0||g>n.length)return null;var t=n.charCodeAt(g-1);if(t>=56320&&t<=57343&&g>1){var i=n.charCodeAt(g-2);if(i>=55296&&i<=56319)return g-2}return g-1},String.prototype.kmwCodePointToCodeUnit=function(g){if(g===null)return null;var n=String(this),t=0;if(g<0){t=n.length;for(var i=0;i>g;i--)t=n.kmwPrevChar(t);return t}if(g==n.kmwLength())return n.length;for(var i=0;i<g;i++)t=n.kmwNextChar(t);return t},String.prototype.kmwCodeUnitToCodePoint=function(g){var n=String(this);return g===null?null:g==0?0:g<0?n.substr(g).kmwLength():n.substr(0,g).kmwLength()},String.prototype.kmwCharAt=function(g){var n=String(this);return g>=0?n.kmwSubstr(g,1):""},String.prototype.kmwBMPNextChar=function(g){var n=String(this);return g<0||g>=n.length-1?null:g+1},String.prototype.kmwBMPPrevChar=function(g){var n=String(this);return g<=0||g>n.length?null:g-1},String.prototype.kmwBMPCodePointToCodeUnit=function(g){return g},String.prototype.kmwBMPCodeUnitToCodePoint=function(g){return g},String.prototype.kmwBMPLength=function(){var g=String(this);return g.length},String.prototype.kmwBMPSubstr=function(g,n){var t=String(this);return g>-1?t.substr(g,n):t.substr(t.length+g,-g)},String.kmwEnableSupplementaryPlane=function(g){var n=String.prototype;String._kmwFromCharCode=g?String.kmwFromCharCode:String.fromCharCode,n._kmwCharAt=g?n.kmwCharAt:n.charAt,n._kmwCharCodeAt=g?n.kmwCharCodeAt:n.charCodeAt,n._kmwIndexOf=g?n.kmwIndexOf:n.indexOf,n._kmwLastIndexOf=g?n.kmwLastIndexOf:n.lastIndexOf,n._kmwSlice=g?n.kmwSlice:n.slice,n._kmwSubstring=g?n.kmwSubstring:n.substring,n._kmwSubstr=g?n.kmwSubstr:n.kmwBMPSubstr,n._kmwLength=g?n.kmwLength:n.kmwBMPLength,n._kmwNextChar=g?n.kmwNextChar:n.kmwBMPNextChar,n._kmwPrevChar=g?n.kmwPrevChar:n.kmwBMPPrevChar,n._kmwCodePointToCodeUnit=g?n.kmwCodePointToCodeUnit:n.kmwBMPCodePointToCodeUnit,n._kmwCodeUnitToCodePoint=g?n.kmwCodeUnitToCodePoint:n.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}a(Hn,"extendString");Hn();var rs=class rs{constructor(n){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((t,i)=>{this._resolve=l=>{this._isFulfilled=!0,t(l)},this._reject=l=>{this._isRejected=!0,i(l)},n&&n(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(n,t){return this._promise.then(n,t)}catch(n){return this._promise.catch(n)}finally(n){return this._promise.finally(n)}get corePromise(){return this._promise}};a(rs,"ManagedPromise");var H=rs;var os=class os extends H{constructor(t){let i=null;super(c=>{i=setTimeout(()=>{this.isResolved||c(!0)},t)});this.timerHandle=i;let l=this._resolve;this._resolve=c=>{clearTimeout(this.timerHandle),l(c)};let s=this._reject;this._reject=c=>{clearTimeout(this.timerHandle),s(c)}}};a(os,"TimeoutPromise");var Te=os,ge=a(g=>new Te(g).corePromise,"timedPromise");var k=ya.TouchLayoutKeySp;var Za=200,L=class L{static buildDefaultLayout(n,t,i){var Vn;let l=i;typeof L.dfltLayout[l]!="object"&&(l="desktop");let s=Q.modifierBitmasks.NON_CHIRAL,c=K.CURRENT;t&&(s=t.modifierBitmask,c=t.compilerVersion),n||(n=this.DEFAULT_RAW_SPEC);var r=oe(L.dfltLayout[l]),o,d=r.layer,u=n.KLS,B=n.K102,b,I,F,h,y,U,x=(s&Q.modifierBitmasks.IS_CHIRAL)!=0;if(n.F){let Ye=/^(?:(?:italic|bold) )* *[0-9.eE-]+(?:[a-z]+) "(.+)"$/.exec(n.F);Ye&&(r.font=Ye[1])}var G=!(typeof u=="undefined"||!u);G||(u=n.KLS=L.processLegacyDefinitions(n.BK));var p=Object.getOwnPropertyNames(u),R=[];if(p.splice(p.indexOf("default"),1),p=["default"].concat(p),t&&t.emulatesAltGr&&(p.indexOf("leftctrl-leftalt")==-1&&p.indexOf("rightalt")!=-1&&(p.push("leftctrl-leftalt"),u["leftctrl-leftalt"]=u.rightalt),p.indexOf("leftctrl-leftalt-shift")==-1&&p.indexOf("rightalt-shift")!=-1&&(p.push("leftctrl-leftalt-shift"),u["leftctrl-leftalt-shift"]=u["rightalt-shift"])),r.displayUnderlying=t?!!t.scriptObject.KDU:!1,i=="desktop")for(R=L.generateLayerIds(x),o=0;o<R.length;o++)p.indexOf(R[o])!=-1&&R.splice(o--,1);var f=p.concat(R);if(G&&i!="desktop"){var v=null;h=d[0].row;for(var w=0;w<h.length;w++){U=h[w].key;for(var qe=0;qe<U.length;qe++)y=U[qe],y.id=="K_SHIFT"&&(v=y)}if(v){v.sk=[];for(let Ye in u){if(Ye=="default"||Ye=="shift")continue;var Li=L.modifierSpecials[Ye];let et={id:`K_${Li}`,text:Li,sp:1,nextlayer:Ye};v.sk.push(et)}}else console.warn("Error in default layout - cannot find default Shift key!")}for(o=0;o<f.length;o++)o>0&&(d[o]=oe(d[0])),d[o].id=f[o],d[o].nextlayer=f[o],L.formatDefaultLayer(d[o],x,i,!!B);for(o=0;o<d.length;o++){var Ce=d[o],Ne,v=null,xn=null,Ft=null,Zn=null,$e=u[Ce.id],Nt=Ce.id=="shift"?1:0,Xn=Ce.id=="default"||Nt?1:0;for(h=Ce.row,b=0;b<h.length;b++)for(U=h[b].key,I=0;I<U.length;I++){switch(y=U[I],Ne=L.dfltCodes.indexOf(y.id),($e||Xn)&&($e&&Ne>=0&&Ne<$e.length&&(y.text=$e[Ne]),Xn&&c.precedes(K.NO_DEFAULT_KEYCAPS)&&y.id!="K_SPACE"&&Ne+65*Nt<L.dfltText.length&&y.text!==null&&(y.text=y.text||L.dfltText[Ne+65*Nt])),y.text!==null&&(y.text=y.text||""),y.id){case"K_SHIFT":v=y;break;case"K_CAPS":xn=y;break;case"K_NUMLOCK":Ft=y;break;case"K_SCROLL":Zn=y;break}if(y.sk!=null){for(F=0;F<y.sk.length;F++)p.indexOf(y.sk[F].nextlayer)==-1&&y.sk.splice(F--,1);y.sk.length==0&&(y.sk=null)}}Ce.shiftKey=v,Ce.capsKey=xn,Ce.numKey=Ft,Ce.scrollKey=Zn;let et=d[o].id;i!="desktop"&&o>0&&v!=null&&(v.sp=k.specialActive,v.sk=null,v.text=(Vn=L.modifierSpecials[et])!=null?Vn:"*Shift*")}return r}static getLayerId(n){var t="";return n==0?"default":(n&m.LCTRLFLAG&&(t=(t.length>0?t+"-":"")+"leftctrl"),n&m.RCTRLFLAG&&(t=(t.length>0?t+"-":"")+"rightctrl"),n&m.LALTFLAG&&(t=(t.length>0?t+"-":"")+"leftalt"),n&m.RALTFLAG&&(t=(t.length>0?t+"-":"")+"rightalt"),n&m.K_SHIFTFLAG&&(t=(t.length>0?t+"-":"")+"shift"),n&m.K_CTRLFLAG&&(t=(t.length>0?t+"-":"")+"ctrl"),n&m.K_ALTFLAG&&(t=(t.length>0?t+"-":"")+"alt"),t)}static generateLayerIds(n){var t,i;n?(t=32,i=1):(t=8,i=16);for(var l=[],s=0;s<t;s++)l.push(L.getLayerId(s*i));return l}static formatDefaultLayer(n,t,i,l){for(var s=n.id,c=0;c<n.row.length;c++)for(var r=n.row[c],o=r.key,d=0;d<o.length;d++){var u=o[d];switch(u.id){case"K_SHIFT":case"K_LSHIFT":case"K_RSHIFT":s.indexOf("shift")!=-1&&(u.sp=k.specialActive),i!="desktop"&&(s!="default"?u.nextlayer="default":u.nextlayer="shift");break;case"K_LCTRL":case"K_LCONTROL":if(t){s.indexOf("leftctrl")!=-1&&(u.sp=k.specialActive);break}case"K_RCTRL":case"K_RCONTROL":if(t){s.indexOf("rightctrl")!=-1&&(u.sp=k.specialActive);break}case"K_CONTROL":s.indexOf("ctrl")!=-1&&(!t||s.indexOf("leftctrl")!=-1&&s.indexOf("rightctrl")!=-1)&&(u.sp=k.specialActive);break;case"K_LALT":if(t){s.indexOf("leftalt")!=-1&&(u.sp=k.specialActive);break}case"K_RALT":if(t){s.indexOf("rightalt")!=-1&&(u.sp=k.specialActive);break}case"K_ALT":s.indexOf("alt")!=-1&&(!t||s.indexOf("leftalt")!=-1&&s.indexOf("rightalt")!=-1)&&(u.sp=k.specialActive);break;case"K_oE2":(typeof l=="undefined"||!l)&&(i=="desktop"?(o.splice(d--,1),o[0].width=Za):o[d].sp=k.spacer);break}}}static processLegacyDefinitions(n){for(var t=L.generateLayerIds(!1),i={},l=0;l<t.length;l++){for(var s=t[l],c=[],r=!1,o=0;o<65;o++){var d=o+65*l;c.push(n[d]),d<n.length&&n[d]!=""&&o!=L.dfltCodes.indexOf("K_SPACE")&&(r=!0)}r&&(i[s]=c)}return(typeof i.default=="undefined"||!i.default)&&(i.default=[""]),(typeof i.shift=="undefined"||!i.shift)&&(i.shift=[""]),i}};a(L,"Layouts"),L.dfltCodes=["K_BKQUOTE","K_1","K_2","K_3","K_4","K_5","K_6","K_7","K_8","K_9","K_0","K_HYPHEN","K_EQUAL","K_*","K_*","K_*","K_Q","K_W","K_E","K_R","K_T","K_Y","K_U","K_I","K_O","K_P","K_LBRKT","K_RBRKT","K_BKSLASH","K_*","K_*","K_*","K_A","K_S","K_D","K_F","K_G","K_H","K_J","K_K","K_L","K_COLON","K_QUOTE","K_*","K_*","K_*","K_*","K_*","K_oE2","K_Z","K_X","K_C","K_V","K_B","K_N","K_M","K_COMMA","K_PERIOD","K_SLASH","K_*","K_*","K_*","K_*","K_*","K_SPACE"],L.dfltText="`1234567890-=§~~qwertyuiop[]\\~~~asdfghjkl;'~~~~~?zxcvbnm,./~~~~~ ~!@#$%^&*()_+§~~QWERTYUIOP{}\\~~~ASDFGHJKL:\"~~~~~?ZXCVBNM<>?~~~~~ ",L.DEFAULT_RAW_SPEC={F:"Tahoma",BK:L.dfltText.split("")},L.modifierSpecials={leftalt:"*LAlt*",rightalt:"*RAlt*",alt:"*Alt*",leftctrl:"*LCtrl*",rightctrl:"*RCtrl*",ctrl:"*Ctrl*","ctrl-alt":"*AltGr*","leftctrl-leftalt":"*LAltCtrl*","rightctrl-rightalt":"*RAltCtrl*","leftctrl-leftalt-shift":"*LAltCtrlShift*","rightctrl-rightalt-shift":"*RAltCtrlShift*",shift:"*Shift*","shift-alt":"*AltShift*","shift-ctrl":"*CtrlShift*","shift-ctrl-alt":"*AltCtrlShift*","leftalt-shift":"*LAltShift*","rightalt-shift":"*RAltShift*","leftctrl-shift":"*LCtrlShift*","rightctrl-shift":"*RCtrlShift*"},L.dfltShiftToCaps={id:"T_*_MT_SHIFT_TO_CAPS",text:"*ShiftLock*",sp:1,nextlayer:"caps"},L.dfltShiftToDefault={id:"T_*_MT_SHIFT_TO_DEFAULT",text:"*Shift*",sp:1,nextlayer:"default"},L.dfltShiftToShift={id:"T_*_MT_SHIFT_TO_SHIFT",text:"*Shift*",sp:1,nextlayer:"shift"},L.dfltLayout={desktop:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:1,key:[{id:"K_BKQUOTE"},{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{id:"K_BKSP",text:"*BkSp*",sp:1,width:130}]},{id:2,key:[{id:"K_TAB",text:"*Tab*",sp:1,width:130},{id:"K_Q"},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{id:"K_BKSLASH"}]},{id:3,key:[{id:"K_CAPS",text:"*Caps*",sp:1,width:165},{id:"K_A"},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_ENTER",text:"*Enter*",sp:1,width:165}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:130},{id:"K_oE2"},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_RSHIFT",text:"*Shift*",sp:1,width:130}]},{id:5,key:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:170},{id:"K_LALT",text:"*Alt*",sp:1,width:160},{id:"K_SPACE",text:"",width:770},{id:"K_RALT",text:"*Alt*",sp:1,width:160},{id:"K_RCONTROL",text:"*Ctrl*",sp:1,width:170}]}]}]},tablet:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",sp:1,width:150},{id:"K_SPACE",text:"",width:570},{id:"K_BKSP",text:"*BkSp*",sp:1,width:150},{id:"K_ENTER",text:"*Enter*",sp:1,width:200}]}]}]},phone:{defaultHint:"dot",font:"Tahoma,Helvetica",layer:[{id:"default",row:[{id:0,key:[{id:"K_1"},{id:"K_2"},{id:"K_3"},{id:"K_4"},{id:"K_5"},{id:"K_6"},{id:"K_7"},{id:"K_8"},{id:"K_9"},{id:"K_0"},{id:"K_HYPHEN"},{id:"K_EQUAL"},{sp:10,width:1}]},{id:1,key:[{id:"K_Q",pad:25},{id:"K_W"},{id:"K_E"},{id:"K_R"},{id:"K_T"},{id:"K_Y"},{id:"K_U"},{id:"K_I"},{id:"K_O"},{id:"K_P"},{id:"K_LBRKT"},{id:"K_RBRKT"},{sp:10,width:1}]},{id:2,key:[{id:"K_A",pad:50},{id:"K_S"},{id:"K_D"},{id:"K_F"},{id:"K_G"},{id:"K_H"},{id:"K_J"},{id:"K_K"},{id:"K_L"},{id:"K_COLON"},{id:"K_QUOTE"},{id:"K_BKSLASH",width:90}]},{id:3,key:[{id:"K_oE2",width:90},{id:"K_Z"},{id:"K_X"},{id:"K_C"},{id:"K_V"},{id:"K_B"},{id:"K_N"},{id:"K_M"},{id:"K_COMMA"},{id:"K_PERIOD"},{id:"K_SLASH"},{id:"K_BKQUOTE"},{sp:10,width:1}]},{id:4,key:[{id:"K_SHIFT",text:"*Shift*",sp:1,width:200,sk:[{id:"K_LCONTROL",text:"*Ctrl*",sp:1,width:50,nextlayer:"ctrl"},{id:"K_LCONTROL",text:"*LCtrl*",sp:1,width:50,nextlayer:"leftctrl"},{id:"K_RCONTROL",text:"*RCtrl*",sp:1,width:50,nextlayer:"rightctrl"},{id:"K_LALT",text:"*Alt*",sp:1,width:50,nextlayer:"alt"},{id:"K_LALT",text:"*LAlt*",sp:1,width:50,nextlayer:"leftalt"},{id:"K_RALT",text:"*RAlt*",sp:1,width:50,nextlayer:"rightalt"},{id:"K_ALTGR",text:"*AltGr*",sp:1,width:50,nextlayer:"ctrl-alt"}]},{id:"K_LOPT",text:"*Menu*",width:150,sp:1},{id:"K_SPACE",width:570,text:""},{id:"K_BKSP",text:"*BkSp*",width:150,sp:1},{id:"K_ENTER",text:"*Enter*",width:200,sp:1}]}]}]}};var E=L;function Re(g,n,t){t.enumerable=!0}a(Re,"Enumerable");var Fo={id:"string",text:"string",layer:"string",nextlayer:"string",font:"string",fontsize:"string",sp:"number",pad:"number",width:"number",sk:"subkeys",flick:"flicks",multitap:"subkeys",hint:"string",default:"boolean"},yo=["n","ne","e","se","s","sw","w","nw"];function as(g,n){let t=Object.getPrototypeOf(n);for(let i in n)if(!g.hasOwnProperty(i)){let l=Object.getOwnPropertyDescriptor(t,i);l?Object.defineProperty(g,i,l):g[i]=n[i]}return g}a(as,"assignDefaultsWithPropDefs");var $=class ${constructor(n,t,i){this.isMnemonic=!1;Object.assign(this,n),!this.text&&typeof this.id=="string"&&(this.text=ie.unicodeIDToText(this.id)),this.displayLayer=i,this.layer=this.layer||i,this._baseKeyEvent=()=>this.constructBaseKeyEvent(t,i)}get baseKeyID(){if(typeof this.id!="undefined")return this.id}get isPadding(){return this.sp==k.spacer}get coreID(){if(typeof this.id=="undefined")return;let n=this.id||"";return this.displayLayer!=this.layer&&(n=n+"+"+this.layer),n}get elementID(){if(typeof this.id!="undefined")return this.displayLayer+"-"+this.coreID}get baseKeyEvent(){let n=this._baseKeyEvent;return typeof n=="function"&&(n=n()),new te(n)}static unicodeIDToText(n,t){if(!n||n.substring(0,2)!="U_")return null;let i="",l=n.substring(2).split("_");for(let s of l){let c=parseInt(s,16);if(0<=c&&c<=31||128<=c&&c<=159||isNaN(c)){t&&t(s);continue}else i+=String.kmwFromCharCode(c)}return i||null}static sanitize(n){typeof n.width=="string"&&(n.width=parseInt(n.width,10)),n.width||(n.width=ie.DEFAULT_KEY_WIDTH),typeof n.pad=="string"&&(n.pad=parseInt(n.pad,10)),n.pad||(n.pad=ie.DEFAULT_PAD),typeof n.sp=="string"&&(n.sp=Number.parseInt(n.sp,10)),n.sp||(n.sp=ie.DEFAULT_KEY.sp);for(let t of Object.keys(Fo)){let i=Fo[t];switch(i){case"subkeys":let l=n[t];if(l===void 0)break;if(!Array.isArray(l))delete n[t];else for(let r=0;r<l.length;r++){let o=l[r];typeof o!="object"?l.splice(r--,1):ie.sanitize(o)}break;case"flicks":let s=n[t];if(s===void 0)break;if(typeof s!="object")delete n[t];else for(let r of yo){let o=s[r];if(o===void 0)break;typeof o!="object"?delete s[r]:ie.sanitize(o)}break;default:let c=n[t];c!==void 0&&typeof c!=i&&delete n[t]}}n.text||(n.text=ie.DEFAULT_KEY.text)}constructBaseKeyEvent(n,t){let i=this.layer||t||"",l=this.id?this.id.toUpperCase():null,s={Lmodifiers:Q.getModifierState(i),Lstates:Q.getStateFromLayer(i),Lcode:l?Q.keyCodes[l]:0,LisVirtualKey:!0,vkCode:0,kName:l,kLayer:i,kbdLayer:t,kNextLayer:this.nextlayer,device:null,isSynthetic:!0},c=new te(s);if(n.keyboard){let r=n.keyboard;r.isMnemonic&&!(n.isDefault&&n.formFactor!="desktop")?c.Lcode!=Q.keyCodes.K_SPACE&&(c.vkCode=c.Lcode,this.isMnemonic=!0):c.vkCode=c.Lcode,r.definesPositionalOrMnemonic||(c.Lcode=ne._USKeyCodeToCharCode(c),c.LisVirtualKey=!1)}return c}};a($,"ActiveKeyBase"),$.DEFAULT_PAD=15,$.DEFAULT_RIGHT_MARGIN=15,$.DEFAULT_KEY_WIDTH=100,$.DEFAULT_KEY={text:"",width:$.DEFAULT_KEY_WIDTH,sp:k.normal,pad:$.DEFAULT_PAD},Qe([Re],$.prototype,"baseKeyID",1),Qe([Re],$.prototype,"isPadding",1),Qe([Re],$.prototype,"coreID",1),Qe([Re],$.prototype,"elementID",1),Qe([Re],$.prototype,"baseKeyEvent",1),Qe([Re],$.prototype,"constructBaseKeyEvent",1);var vn=$,Mi=class Mi extends vn{getSubkey(n){if(this.sk){for(let t of this.sk)if(t.coreID==n)return t}return null}constructor(n,t,i){super(n,t,i);let l=this.sk;if(l)for(let r=0;r<l.length;r++)l[r]=new mt(l[r],t,i);let s=this.multitap;if(s)for(let r=0;r<s.length;r++)s[r]=new mt(s[r],t,i);let c=this.flick;if(c)for(let r in c)c[r]=new mt(c[r],t,i);Mi.determineHint(this,t.defaultHint)}static determineHint(n,t){var i;if(n.hint){n.hintSrc=n;return}if(t!=null&&t.includes("flick-")){if(n.flick){let l=t.substring(6);(i=n.flick[l])!=null&&i.text&&(n.hintSrc=n.flick[l])}return}switch(t){case"none":return;case"multitap":n.multitap&&(n.hintSrc=n.multitap[0]);return;case"flick":if(n.flick){for(let l of yo)if(n.flick[l]){n.hintSrc=n.flick[l];return}}return;case"longpress":n.sk&&(n.hintSrc=n.sk[0]);return;case"dot":default:n.sk&&(n.hint="•",n.hintSrc=n);return}}};a(Mi,"ActiveKey");var ie=Mi,gs=class gs extends vn{};a(gs,"ActiveSubKey");var mt=gs,nt=class nt{constructor(){}static sanitize(n){for(let t of n.key)t==null?n.key.length=n.key.length-1:ie.sanitize(t);typeof n.id=="string"&&(n.id=Number.parseInt(n.id,10))}static polyfill(n,t,i,l,s){let c=n.key,r=vn.DEFAULT_KEY;for(let b=0;b<c.length;b++){let I=c[b],F=Object.keys(r);for(let y of F){let U=y;typeof I[U]!="string"&&typeof I[U]!="number"&&(I[U]=r[U])}switch(I.sp){case k.special:!nt.SPECIAL_LABEL.test(I.text)&&I.text!=""&&(I.sp=k.customSpecial);break;case k.specialActive:!nt.SPECIAL_LABEL.test(I.text)&&I.text!=""&&(I.sp=k.customSpecialActive);break}let h=new ie(I,t,i);c[b]=h}let o=a(function(b,I,F,h){b.proportionalPad=I,b.proportionalWidth=F,b.proportionalX=h+I+F/2},"setProportions"),d=0;for(let b=0;b<c.length-1;b++){let I=c[b];o(I,I.pad/l,I.width/l,d),d+=I.proportionalPad,d+=I.proportionalWidth}let u=ie.DEFAULT_RIGHT_MARGIN/l;if(c.length>0){let b=c[c.length-1];if(c.length==1&&b.pad<0){let I=b.width/l,F=1-(d+I+u);o(b,F,I,d)}else{let I=b.pad/l,F=1-(d+I+u);o(b,I,F,d)}}as(n,new nt);let B=n;B.proportionalY=s}populateKeyMap(n){this.key.forEach(function(t){t.coreID&&(n[t.coreID]=t)})}};a(nt,"ActiveRow"),nt.SPECIAL_LABEL=/\*\w+\*/,Qe([Re],nt.prototype,"populateKeyMap",1);var Ti=nt,Tt=class Tt{constructor(){}static sanitize(n){for(let t of n.row)Ti.sanitize(t)}static polyfill(n,t){n.aligned=!1;let i=n.row,l=0;for(let r of i){let o=0,d=r.key;for(let u of d)o+=u.width+u.pad;o>l&&(l=o)}t.formFactor=="desktop"?l+=5:l+=ie.DEFAULT_RIGHT_MARGIN;let s=n.row.length;for(let r=0;r<s;r++){let o=(r+.5)/s;Ti.polyfill(n.row[r],t,n.id,l,o)}as(n,new Tt);let c=n;c.totalWidth=l,c.defaultKeyProportionalWidth=ie.DEFAULT_KEY.width/l,c.rowProportionalHeight=1/s,c.keyMap=c.constructKeyMap()}constructKeyMap(){let n={};return this.row.forEach(function(t){t.populateKeyMap(n)}),n}getKey(n){n.indexOf(this.id+"-")==0&&(n=n.replace(this.id+"-",""));let t=n.split("::");return t.length>1?this.keyMap[t[0]].getSubkey(t[1]):this.keyMap[n]}};a(Tt,"ActiveLayer"),Qe([Re],Tt.prototype,"constructKeyMap",1),Qe([Re],Tt.prototype,"getKey",1);var wi=Tt,wt=class wt{constructor(){this.hasFlicks=!1;this.hasLongpresses=!1;this.hasMultitaps=!1}getLayer(n){if(!this.layerMap[n]){let t=this.layer.find(i=>i.id==n);if(!t)return null;wi.sanitize(t),wi.polyfill(t,this),this.layerMap[n]=t}return this.layerMap[n]}static correctLayerEmptyRowBug(n){for(let t=0;t<n.length;t++){let l=n[t].row,s;for(s=l.length-1;s>=0;s--)(!Array.isArray(l[s].key)||l[s].key.length==0)&&l.splice(s,1)}}static sanitize(n){wt.correctLayerEmptyRowBug(n.layer)}static polyfill(n,t,i){if(n==null)throw new Error("Cannot build an ActiveLayout for a null specification.");let l={hasFlicks:!1,hasLongpresses:!1,hasMultitaps:!1};this.sanitize(n);for(let r of n.layer)for(let o of r.row)for(let d of o.key)l.hasLongpresses||(l.hasLongpresses=!!d.sk),l.hasFlicks||(l.hasFlicks=!!d.flick),l.hasMultitaps||(l.hasMultitaps=!!d.multitap);let s={};as(n,new wt);let c=n;if(c.keyboard=t,c.formFactor=i,c.layerMap=s,i!="desktop"&&n.layer.find(r=>r.id=="caps")){let r=c.getLayer("default"),o=c.getLayer("shift"),d=r.getKey("K_SHIFT"),u=o==null?void 0:o.getKey("K_SHIFT");d&&u&&!d.multitap&&!u.multitap&&!d.sk&&!u.sk&&(l.hasMultitaps=!0,d.multitap=[C({},E.dfltShiftToCaps),C({},E.dfltShiftToDefault)],u.multitap=[C({},E.dfltShiftToCaps),C({},E.dfltShiftToShift)],d.multitap.forEach((B,b)=>d.multitap[b]=new mt(B,c,"default")),u.multitap.forEach((B,b)=>u.multitap[b]=new mt(B,c,"shift")))}return c.hasFlicks=l.hasFlicks,c.hasLongpresses=l.hasLongpresses,c.hasMultitaps=l.hasMultitaps,c}};a(wt,"ActiveLayout"),Qe([Re],wt.prototype,"getLayer",1);var Mt=wt;var us=class us{constructor(){this.stores={}}};a(us,"CacheTag");var ds=us,Ki=(i=>(i[i.NOT_LOADED=void 0]="NOT_LOADED",i[i.POLYFILLED=1]="POLYFILLED",i[i.CALIBRATED=2]="CALIBRATED",i))(Ki||{}),Kt=class Kt{constructor(n){n?this.scriptObject=n:this.scriptObject=Kt.DEFAULT_SCRIPT_OBJECT,this.layoutStates={}}process(n,t){return this.scriptObject.gs(n,t)}processNewContextEvent(n,t){return this.scriptObject.gn?this.scriptObject.gn(n,t):!1}processPostKeystroke(n,t){return this.scriptObject.gpk?this.scriptObject.gpk(n,t):!1}get isHollow(){return this.scriptObject==Kt.DEFAULT_SCRIPT_OBJECT}get id(){return this.scriptObject.KI}get name(){return this.scriptObject.KN}get variableStores(){let n=this.scriptObject.KVS,t={};if(Array.isArray(n))for(let i of n)t[i]=this.scriptObject[i];return t}set variableStores(n){let t=this.scriptObject.KVS;if(Array.isArray(t))for(let i of t)typeof n[i]=="string"&&(this.scriptObject[i]=n[i])}get _legacyLayoutSpec(){return this.scriptObject.KV}get _layouts(){return this.scriptObject.KVKL}set _layouts(n){this.scriptObject.KVKL=n}get compilerVersion(){return new K(this.scriptObject.KVER)}get isMnemonic(){return!!this.scriptObject.KM}get definesPositionalOrMnemonic(){return typeof this.scriptObject.KM!="undefined"}get helpText(){return this.scriptObject.KH}get hasScript(){return!!this.scriptObject.KHF}embedScript(n){this.scriptObject.KHF(n)}get oskStyling(){return this.scriptObject.KCSS}get isCJK(){var n;return typeof this.scriptObject.KLC!="undefined"?n=this.scriptObject.KLC:typeof this.scriptObject.LanguageCode!="undefined"&&(n=this.scriptObject.LanguageCode),n=="cmn"||n=="jpn"||n=="kor"}get isRTL(){return!!this.scriptObject.KRTL}get modifierBitmask(){return this.scriptObject.KMBM||Q.modifierBitmasks.NON_CHIRAL}get isChiral(){return!!(this.modifierBitmask&Q.modifierBitmasks.IS_CHIRAL)}get desktopFont(){return this.scriptObject.KV?this.scriptObject.KV.F:null}get cacheTag(){let n=this.scriptObject._kmw;return n||(n=new ds,this.scriptObject._kmw=n),n}get explodedStores(){return this.cacheTag.stores}get emulatesAltGr(){if(!this.isChiral||this._legacyLayoutSpec==null)return!1;let n=this._legacyLayoutSpec.KLS;if(!n)return!1;var t=m.LCTRLFLAG|m.LALTFLAG,i=n[E.getLayerId(t)],l=n[E.getLayerId(m.K_SHIFTFLAG|t)];if(i!=null&&i!=n[E.getLayerId(m.RALTFLAG)]||l!=null&&l!=n[E.getLayerId(m.RALTFLAG|m.K_SHIFTFLAG)])return!1;var s=this.modifierBitmask;return(s&t)!=t||i==null&&l==null,!0}get usesSupplementaryPlaneChars(){let n=this.scriptObject;return n&&(n.KS&&n.KS==1||n.KN=="Hieroglyphic")}get version(){return this.scriptObject.KBVER||""}usesDesktopLayoutOnDevice(n){return this.scriptObject.KVKL?n.formFactor==S.FormFactor.Desktop:!0}notify(n,t,i){typeof this.scriptObject.KNS=="function"&&this.scriptObject.KNS(n,t,i)}findOrConstructLayout(n){if(this._layouts){if(this._layouts[n]!==void 0)return this._layouts[n];if(n==S.FormFactor.Phone&&this._layouts[S.FormFactor.Tablet])return this._layouts[S.FormFactor.Phone]=this._layouts[S.FormFactor.Tablet];if(n==S.FormFactor.Tablet&&this._layouts[S.FormFactor.Phone])return this._layouts[S.FormFactor.Tablet]=this._layouts[S.FormFactor.Phone]}let t=null;if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.KLS)t=this._legacyLayoutSpec;else if(this._legacyLayoutSpec!=null&&this._legacyLayoutSpec.BK!=null){for(var i=this._legacyLayoutSpec.BK,l=0;l<i.length;l++)if(i[l].length>0){t=this._legacyLayoutSpec;break}}if(!t&&(this.helpText==""||n!=S.FormFactor.Desktop)&&(t={F:"Tahoma",BK:E.dfltText}),this._layouts||(this._layouts={}),t){let s=this._layouts[n]=E.buildDefaultLayout(t,this,n);return s.isDefault=!0,s}else return this._layouts[n]=null,null}layout(n){let t=this.findOrConstructLayout(n);if(t)if(this.layoutStates[n]==Ki.NOT_LOADED){let i=Mt.polyfill(t,this,n);return this.layoutStates[n]=1,i}else return t;else return null}refreshLayouts(){let n=[S.FormFactor.Desktop,S.FormFactor.Phone,S.FormFactor.Tablet],t=this;n.forEach(function(i){t.layoutStates[i]=Ki.NOT_LOADED})}markLayoutCalibrated(n){this.layoutStates[n]!=Ki.NOT_LOADED&&(this.layoutStates[n]=2)}getLayoutState(n){return this.layoutStates[n]}constructNullKeyEvent(n,t){t=t||{K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};let i=te.constructNullKeyEvent(n);return this.setSyntheticEventDefaults(i,t),i}constructKeyEvent(n,t,i){let l=n.baseKeyEvent;l.device=t,this.isMnemonic&&l.setMnemonicCode(n.layer.indexOf("shift")!=-1,i.K_CAPS),this.setSyntheticEventDefaults(l,i);let c={K_CAPS:Q.stateBitmasks.CAPS,K_NUMLOCK:Q.stateBitmasks.NUM_LOCK,K_SCROLL:Q.stateBitmasks.SCROLL_LOCK}[l.kName];return c&&(l.Lstates^=c,l.LmodifierChange=!0),l}setSyntheticEventDefaults(n,t){n.device.touchable||(n.Lstates=0,n.Lstates|=t.K_CAPS?m.CAPITALFLAG:m.NOTCAPITALFLAG,n.Lstates|=t.K_NUMLOCK?m.NUMLOCKFLAG:m.NOTNUMLOCKFLAG,n.Lstates|=t.K_SCROLL?m.SCROLLFLAG:m.NOTSCROLLFLAG),n.kName&&n.kName.substr(0,2)=="U_"&&(n.LisVirtualKey=!1),typeof n.Lcode=="undefined"&&(n.Lcode=this.getVKDictionaryCode(n.kName),n.Lcode||(n.Lcode=1)),(n.Lmodifiers&Q.modifierBitmasks.ALT_GR_SIM)==Q.modifierBitmasks.ALT_GR_SIM&&this.emulatesAltGr&&(n.Lmodifiers&=~Q.modifierBitmasks.ALT_GR_SIM,n.Lmodifiers|=m.RALTFLAG)}getVKDictionaryCode(n){let t=this.scriptObject.VKDictionary||{};if(!this.scriptObject.VKDictionary){if(typeof this.scriptObject.KVKD=="string"){let s=this.scriptObject.KVKD.split(" ");for(var i=0;i<s.length;i++)t[s[i].toUpperCase()]=i+256}this.scriptObject.VKDictionary=t}let l=t[n.toUpperCase()];return l||0}};a(Kt,"Keyboard"),Kt.DEFAULT_SCRIPT_OBJECT={gs:function(n,t){return!1},KI:"",KN:"",KV:E.DEFAULT_RAW_SPEC,KM:0};var T=Kt;var fn={osk:Q},Bs=class Bs{constructor(n,t){this.loadedKeyboard=null;this._jsGlobal=n,this.keymanGlobal=t,this.install()}KR(n){if(this.loadedKeyboard)throw new Error("Unexpected state:  the most-recently loaded keyboard field was not properly reset.");this.loadedKeyboard=new T(n)}KLOAD(n,t,i){return i}install(){this._jsGlobal.KeymanWeb=this,this._jsGlobal.keyman=this.keymanGlobal}uninstall(){this._jsGlobal.KeymanWeb==this&&delete this._jsGlobal.KeymanWeb,this._jsGlobal.keyman==this.keymanGlobal&&delete this._jsGlobal.keyman}};a(Bs,"KeyboardHarness");var Gt=Bs;var hs=class hs extends Error{constructor(t,i){super(t);this.cause=i}};a(hs,"KeyboardScriptError");var pt=hs,Fs=class Fs extends Error{constructor(t,i){super(t);this.cause=i}};a(Fs,"KeyboardMissingError");var Ln=Fs,ys=class ys{constructor(n){this.uri=n}missingError(n){let t=`Cannot find the keyboard at ${this.uri}.`;return new Ln(t,n)}scriptError(n){let t=`Error registering the keyboard script at ${this.uri}; it may contain an error.`;return new pt(t,n)}};a(ys,"UriBasedErrorBuilder");var Is=ys,ms=class ms{constructor(n){this.stub=n}missingError(n){let t=this.stub,i=`Cannot find the ${t.name} keyboard for ${t.langName} at ${t.filename}.`;return new Ln(i,n)}scriptError(n){let t=this.stub,i=`Error registering the ${t.name} keyboard for ${t.langName}; keyboard script at ${t.filename} may contain an error.`;return new pt(i,n)}};a(ms,"StubBasedErrorBuilder");var bs=ms,Gs=class Gs{get harness(){return this._harness}constructor(n){this._harness=n}loadKeyboardFromPath(n){return this.harness.install(),this.loadKeyboardInternal(n,new Is(n))}loadKeyboardFromStub(n){return this.harness.install(),this.loadKeyboardInternal(n.filename,new bs(n),n.id)}};a(Gs,"KeyboardLoaderBase");var zt=Gs;var mo=(l=>(l.KEYBOARD="keyboard",l.LANGUAGE="language",l.LANGUAGE_KEYBOARD="languageKeyboard",l.BLANK="blank",l))(mo||{}),Ue=mo;function ps(g,n){if(g)return{family:g.family,path:n,files:g.filename||g.source}}a(ps,"internalizeFont");var it=class it{static get spacebarTextMode(){return typeof this.spacebarTextModeSrc=="string"?this.spacebarTextModeSrc:this.spacebarTextModeSrc()}static set spacebarTextMode(n){this.spacebarTextModeSrc=n}constructor(n,t){if(typeof n!="string")if(n.KI||n.KL||n.KLC||n.KFont||n.KOskFont){let i=n;this.KI=i.KI,this.KN=i.KN,this.KL=i.KL,this.KLC=i.KLC,this.KFont=i.KFont,this.KOskFont=i.KOskFont,this._displayName=i instanceof it?i._displayName:i.displayName}else{let i=n;i.languages||(i.languages=i.language),this.KI=i.id,this.KN=i.name,this.KL=i.languages.name,this.KLC=i.languages.id,this.KFont=ps(i.languages.font,t),this.KOskFont=ps(i.languages.oskFont,t)}else this.KI=n,this.KLC=t}static fromMultilanguageAPIStub(n){let t=[];n.languages||(n.languages=n.language);for(let i of n.languages){let l={id:n.id,name:n.name,languages:i};t.push(new it(l))}return t}get id(){return this.KI}get name(){return this.KN}get langId(){return this.KLC}get langName(){return this.KL}get displayName(){if(this._displayName)return this._displayName;let n=this.KN,t=this.KL;switch(it.spacebarTextMode){case Ue.KEYBOARD:return n;case Ue.LANGUAGE:return t;case Ue.LANGUAGE_KEYBOARD:return n==t?t:t+" - "+n;case Ue.BLANK:return"";default:return n}}set displayName(n){this._displayName=n}get textFont(){return this.KFont}get oskFont(){return this.KOskFont}validateForOSK(){return this.KLC?this.displayName===void 0||it.spacebarTextMode!=Ue.BLANK&&!this.displayName?new Error("A display name is missing for this keyboard and cannot be generated under current settings."):null:this.KI||this.KN?new Error(`No language code was specified for use with the ${this.KI||this.KN} keyboard`):new Error("No language code was specified for use with the corresponding keyboard")}validateForCustomKeyboard(){return!this.KI||!this.KN||!this.KL||!this.KLC?new Error("To use a custom keyboard, you must specify keyboard id, keyboard name, language and language code."):null}};a(it,"KeyboardProperties"),it.spacebarTextModeSrc=Ue.KEYBOARD;var we=it;var Go=a(g=>g.substring(g.length-1)!="/"?g+"/":g,"addDelimiter"),Cs=class Cs{constructor(n,t){t=Go(t),this.sourcePath=t,this.protocol=t.replace(/(.{3,5}:)(.*)/,"$1"),this.updateFromOptions(n)}updateFromOptions(n){let t=this.sourcePath.replace(/(https?:\/\/)([^\/]*)(.*)/,"$1$2/");this._root=t,n.root!=""?this._root=this.fixPath(n.root):this._root=this.fixPath(t);let i=n.resources;i==""&&(i=this.sourcePath),this._resources=this.fixPath(i),this._keyboards=this.fixPath(n.keyboards),this._fonts=this.fixPath(n.fonts)}fixPath(n){return n.length==0||(n=Go(n),n.replace(/^(http)s?:.*/,"$1")=="http"||n.replace(/^(file):.*/,"$1")=="file")?n:n.substring(0,2)=="//"?this.protocol+n:n.substring(0,1)=="/"?this.root+n.substring(1):this.sourcePath+n}get fonts(){return this._fonts}updateFontPath(n){this._fonts=this.fixPath(n)}get root(){return this._root}get resources(){return this._resources}get keyboards(){return this._keyboards}};a(Cs,"PathConfiguration");var Dt=Cs;var Qs={root:"",resources:"",keyboards:"",fonts:""};var Us=class Us{constructor(n,t){this.suggestions=n,this.transcriptionID=t}};a(Us,"ReadySuggestions");var Ct=Us;var xs=class xs extends V.default{constructor(t,i){super();this.initNewContext=!0;this._currentSuggestions=[];this.swallowPrediction=!1;this.doRevert=!1;this.recentRevert=!1;this.doTryAccept=a((t,i)=>{let l=this.recentAcceptCause;if(!l&&this.selected)this.accept(this.selected),i.shouldSwallow=!this.currentTarget.getTextAfterCaret(),this.recentAcceptCause="key";else if(l&&t=="space"){if(this.recentAcceptCause=null,l=="key"){i.shouldSwallow=!1;return}i.shouldSwallow=!!this.langProcessor.wordbreaksAfterSuggestions&&!this.currentTarget.getTextAfterCaret()}else i.shouldSwallow=!1},"doTryAccept");this.doTryRevert=a(()=>{this.doRevert?(this.doRevert=!1,this.recentAcceptCause=null):this.recentAcceptCause&&(this.showRevert(),this.swallowPrediction=!0)},"doTryRevert");this.invalidateSuggestions=a(t=>{this.initNewContext=!1,this.selected=null,(!this.swallowPrediction||t=="context")&&(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1,t=="context"&&(this.swallowPrediction=!1,this.initNewContext=!0)),t!="new"&&this.clearSuggestions()},"invalidateSuggestions");this.updateSuggestions=a(t=>{let i=t.suggestions;this._currentSuggestions=i,this.selected=null,this.keepSuggestion=null;for(let l of i)l.tag=="keep"&&(this.keepSuggestion=l),this.langProcessor.mayAutoCorrect&&l.autoAccept&&!this.selected&&(this.selected=l);this.keepSuggestion&&this._currentSuggestions.splice(this._currentSuggestions.indexOf(this.keepSuggestion),1),this.swallowPrediction?this.swallowPrediction=!1:(this.recentAcceptCause=null,this.doRevert=!1,this.recentRevert=!1),this.sendUpdateEvent()},"updateSuggestions");this.onModelStateChange=a(t=>{(t=="configured"||t=="inactive")&&this.resetContext()},"onModelStateChange");this.langProcessor=t,this.getLayerId=i;let l=a(()=>this.currentTarget&&t.state=="configured","validSuggestionState");this.suggestionApplier=s=>l()?t.applySuggestion(s,this.currentTarget,i):null,this.suggestionReverter=s=>A(this,null,function*(){if(l()){let c=yield t.applyReversion(s,this.currentTarget);this.swallowPrediction=!0,this.updateSuggestions(new Ct(c,s.id?-s.id:void 0))}}),this.connect()}get currentTarget(){return this._currentTarget}setCurrentTarget(t){let i=this._currentTarget;return this._currentTarget=t,i!=t?this.resetContext():Promise.resolve([])}connect(){this.langProcessor.addListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.addListener("suggestionsready",this.updateSuggestions),this.langProcessor.addListener("tryaccept",this.doTryAccept),this.langProcessor.addListener("tryrevert",this.doTryRevert),this.langProcessor.addListener("statechange",this.onModelStateChange)}disconnect(){this.langProcessor.removeListener("invalidatesuggestions",this.invalidateSuggestions),this.langProcessor.removeListener("suggestionsready",this.updateSuggestions),this.langProcessor.removeListener("tryaccept",this.doTryAccept),this.langProcessor.removeListener("tryrevert",this.doTryRevert),this.langProcessor.removeListener("statechange",this.onModelStateChange),this.clearSuggestions()}get currentSuggestions(){let t=[],i=this.activateKeep()&&this.keepSuggestion,l=this.selected&&this.keepSuggestion!=this.selected;return i&&(l||this.keepSuggestion.matchesModel)?t.push(this.keepSuggestion):this.doRevert&&t.push(this.revertSuggestion),t.concat(this._currentSuggestions)}acceptInternal(t){return t?t.tag=="revert"?(this.suggestionReverter(t),null):this.suggestionApplier(t):null}accept(t){let i=this;return this.selected=null,this.doRevert=!1,this.revertAcceptancePromise=this.acceptInternal(t),this.revertAcceptancePromise?(this.revertAcceptancePromise.then(function(l){l&&(i.revertSuggestion=l)}),this.recentAcceptCause="banner",this.recentRevert=!1,this.swallowPrediction=!0,this.revertAcceptancePromise):(t&&t.tag=="revert"&&(this.recentAcceptCause=null,this.recentRevert=!0),Promise.resolve(null))}showRevert(){this.doRevert=!0,this.sendUpdateEvent()}clearSuggestions(){this.updateSuggestions({suggestions:[],transcriptionID:0})}activateKeep(){return!this.recentAcceptCause&&!this.recentRevert&&!this.initNewContext}sendUpdateEvent(){this.emit("update",this.currentSuggestions)}resetContext(){let t=this.currentTarget;return t?this.langProcessor.invalidateContext(t,this.getLayerId()):Promise.resolve([])}};a(xs,"PredictionContext");var Qt=xs;var zi=class zi{constructor(n){n.OS==S.OperatingSystem.Android?this.popupCanvasBackgroundColor="#999":this.popupCanvasBackgroundColor=zi.prefersDarkMode()?"#0f1319":"#ffffff"}static prefersDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}};a(zi,"StyleConstants");var Jn=zi;var Zs=class Zs{constructor(){this.touchable="ontouchstart"in window,this.OS="",this.formFactor="desktop",this.browser="",this.dyPortrait=0,this.dyLandscape=0,this.version="0",this.orientation=window.orientation}getDPI(){var n=document.createElement("DIV"),t=n.style,i=96;return document.readyState!=="complete"||(n.id="calculateDPI",t.position="absolute",t.display="block",t.visibility="hidden",t.left="10px",t.top="10px",t.width="1in",t.height="10px",document.body.appendChild(n),i=typeof window.devicePixelRatio=="undefined"?n.offsetWidth:n.offsetWidth*window.devicePixelRatio,document.body.removeChild(n)),i}detect(){var n=!1;if(navigator&&navigator.userAgent){var t=navigator.userAgent;if(t.indexOf("iPad")>=0)this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;else if(t.indexOf("iPhone")>=0)this.OS="iOS",this.formFactor="phone",this.dyPortrait=this.dyLandscape=25;else if(t.indexOf("Android")>=0){this.OS="Android",this.formFactor="phone",this.dyPortrait=75,this.dyLandscape=25;try{var i=new RegExp("(?:Android\\s+)(\\d+\\.\\d+\\.\\d+)");this.version=t.match(i)[1]}catch(d){}}else if(t.indexOf("Linux")>=0)this.OS="Linux";else if(t.indexOf("Macintosh")>=0){let u=/Intel Mac OS X (\d+(?:[_\.]\d+)+)/i.exec(t);if(!u)console.warn("KMW could not properly parse the user agent string.A suboptimal keyboard layout may result."),this.OS="MacOSX";else if(u.length>1&&u[1]){let B=u[1].replace("_","."),b=new K(B);n=K.MAC_POSSIBLE_IPAD_ALIAS.compareTo(b)<=0,this.OS="MacOSX"}}else t.indexOf("Windows NT")>=0&&(this.OS="Windows",t.indexOf("Touch")>=0&&(this.formFactor="phone"),typeof navigator.msMaxTouchPoints=="number"&&navigator.msMaxTouchPoints>0&&(this.touchable=!0))}let l=Math.min(screen.width,screen.height),s=Math.max(screen.width,screen.height),c=l/s;this.OS!="iOS"&&this.formFactor=="phone"&&(l>=600&&c>.5625||c>=.625)&&(this.formFactor="tablet");let r=navigator.platform=="Win32"||navigator.platform=="MacIntel";this.OS=="iOS"&&!("ongesturestart"in window)&&!r&&(this.OS="Android"),this.browser="web",(this.OS=="iOS"||this.OS.toLowerCase()=="macosx")&&(this.browser="safari");var o=/Firefox|Chrome|OPR|Safari|Edge/;if(o.test(navigator.userAgent)&&(navigator.userAgent.indexOf("Firefox")>=0&&"onmozorientationchange"in screen?this.browser="firefox":navigator.userAgent.indexOf("OPR")>=0?this.browser="opera":navigator.userAgent.indexOf(" Edge/")>=0?this.browser="edge":navigator.userAgent.indexOf("Chrome")>=0?this.browser="chrome":navigator.userAgent.indexOf("Safari")>=0&&(this.browser="safari")),n&&this.browser=="safari"&&window.TouchEvent){this.OS="iOS",this.formFactor="tablet",this.dyPortrait=this.dyLandscape=0;let d=screen.height/screen.width;d<1&&(d=1/d),d>1.6&&(this.formFactor="phone",this.dyPortrait=this.dyLandscape=25)}return this.colorScheme=Jn.prefersDarkMode()?"dark":"light",this.coreSpec}get coreSpec(){return new S(this.browser,this.formFactor,this.OS,this.touchable)}};a(Zs,"DeviceDetector");var Ut=Zs;var Vs=class Vs extends V.default{constructor(t,i){super();this.applyCacheBusting=!1;if(!i){let l=new Ut;l.detect(),i=l.coreSpec}this.sourcePath=t,this.hostDevice=i,this.deferForInitialization=new H}initialize(t){this._paths?this._paths.updateFromOptions(t):this._paths=new Dt(t,this.sourcePath),typeof t.setActiveOnRegister=="boolean"?this.activateFirstKeyboard=t.setActiveOnRegister:this.activateFirstKeyboard=!0,this._spacebarText=t.spacebarText,we.spacebarTextMode=()=>this.spacebarText}finalizeInit(){this.deferForInitialization.resolve()}get paths(){return this._paths}get spacebarText(){return this._spacebarText}set spacebarText(t){this._spacebarText!=t&&(this._spacebarText=t,this.emit("spacebartext",t))}get softDevice(){return this.hostDevice}get hardDevice(){return cs(this.hostDevice)}get stubNamespacer(){return this._stubNamespacer}set stubNamespacer(t){this._stubNamespacer=t}debugReport(){return{hostDevice:this.hostDevice,initialized:this.deferForInitialization.isResolved}}onRuleFinalization(t,i){}};a(Vs,"EngineConfiguration");var kn=Vs,Xs=C({setActiveOnRegister:!0,spacebarText:Ue.LANGUAGE_KEYBOARD},Qs);var Nn=class Nn extends V.default{constructor(t){super();this.pendingActivations=[];this.engineConfig=t}get predictionContext(){return this._predictionContext}configure(t){this._resetContext=t.resetContext,this._predictionContext=t.predictionContext,this.keyboardCache=t.keyboardCache}insertText(t,i,l){let s=this.activeTarget;return s!=null?(i!=null&&t.output(0,s,i),typeof l!="undefined"&&l!==null&&t.deadkeyOutput(0,s,l),s.invalidateSelection(),!0):!1}resetContext(){this._resetContext(this.activeTarget),this.predictionContext.resetContext()}findAndPopActivation(t){let i;for(i=0;i<this.pendingActivations.length&&this.pendingActivations[i].target!=t;i++);return i==this.pendingActivations.length?null:this.pendingActivations.splice(i,1)[0]}deferredKeyboardActivation(t,i,l){return A(this,null,function*(){let s={target:l,keyboard:t,stub:i};this.findAndPopActivation(l),this.pendingActivations.push(s),yield t;let c=this.findAndPopActivation(l);return c==s?s:(c&&this.pendingActivations.push(c),null)})}activateKeyboard(t,i,l){return A(this,null,function*(){let s=!this.activeKeyboard;this.findAndPopActivation(this.currentKeyboardSrcTarget());let c=this.prepareKeyboardForActivation(t,i),r=this.currentKeyboardSrcTarget(),o=yield c.keyboard;if(o==null&&c.metadata)return!1;this.currentKeyboardSrcTarget()==r&&this.emit("beforekeyboardchange",c.metadata);let d=null;return o&&(d={keyboard:o,metadata:c.metadata}),this.activateKeyboardForTarget(d,r),this.currentKeyboardSrcTarget()==r&&(!s||o)&&this.emit("keyboardchange",this.activeKeyboard),!0})}prepareKeyboardForActivation(t,i){var c;i||(i="");let l=null;if(t?l=this.keyboardCache.getStub(t,i):i=="",!l){if(t)throw new Error("No matching stub has been registered.");return{keyboard:Promise.resolve(null),metadata:null}}if((c=this.activeKeyboard)!=null&&c.metadata&&t==this.activeKeyboard.metadata.id){let r=this.activeKeyboard.keyboard;return{keyboard:Promise.resolve(r),metadata:l}}let s;if(s=this.keyboardCache.getKeyboardForStub(l))return{keyboard:Promise.resolve(s),metadata:l};{this.emit("beforekeyboardchange",l);let r=this.engineConfig.deferForInitialization.then(()=>{let d=new H;this.emit("keyboardasyncload",l,d.corePromise);let u=this.keyboardCache.fetchKeyboardForStub(l),B=new Promise((I,F)=>{let h=`Sorry, the ${l.name} keyboard for ${l.langName} is not currently available.`;window.setTimeout(()=>F(new Error(h)),Nn.TIMEOUT_THRESHOLD)}),b=Promise.race([u,B]);return b.then(()=>{d.resolve(null),B.catch(()=>{})}),b.catch(I=>{throw d.resolve(I),I}),b});return{keyboard:this.deferredKeyboardActivation(r,l,this.currentKeyboardSrcTarget()).then(d=>A(this,null,function*(){return d?r:Promise.resolve(null)})),metadata:l}}}};a(Nn,"ContextManagerBase"),Nn.TIMEOUT_THRESHOLD=1e4;var Yn=Nn;var Ws=class Ws extends V.default{};a(Ws,"HardKeyboard");var Ot=Ws;function Ss(g,n,t){if(n&&n.isMnemonic&&g.setMnemonicCode(!!(g.Lmodifiers&m.K_SHIFTFLAG),!!(g.Lmodifiers&m.CAPITALFLAG)),n&&!n.isMnemonic){var i=ne.languageMap[t];i&&i["k"+g.Lcode]&&(g.Lcode=i["k"+g.Lcode]),!n.definesPositionalOrMnemonic&&!(g.Lmodifiers&Q.modifierBitmasks.NON_LEGACY)&&!g.isModifier&&(g=new te({Lcode:ne._USKeyCodeToCharCode(g),Lmodifiers:0,LisVirtualKey:!1,vkCode:g.Lcode,Lstates:g.Lstates,kName:"",device:g.device,isSynthetic:!1}))}return g}a(Ss,"processForMnemonicsAndLegacy");function As(g,n,t){let i=Math.min(g.length,n.length),l,s,c,r,o;for(t?(l=s=g.length-1,c=s-i,r=-1,o=n.length-g.length):(l=s=0,c=i,r=1,o=0);s!=c&&g.charAt(s)==n.charAt(s+o);s+=r);if(s!=l&&s!=c){let d=g.charCodeAt(s-r),u=g.charCodeAt(s),B=n.charCodeAt(s+o),b=t?Yi:Ni,I=t?Ni:Yi;if(b(d)&&(I(u)||I(B)))return s-r}return s}a(As,"findCommonSubstringEndIndex");var xt=class xt{constructor(n,t){this.p=n,this.d=t,this.o=xt.ordinalSeed++}match(n,t){var i=this.p==n&&this.d==t;return i}set(){this.matched=1}reset(){this.matched=0}before(n){return this.o<n.o}clone(){let n=new xt(this.p,this.d);return n.o=this.o,n}equal(n){return this.d==n.d&&this.p==n.d&&this.o==n.o}};a(xt,"Deadkey"),xt.ordinalSeed=0,xt.sortFunc=a(function(n,t){return n.p!=t.p?t.p-n.p:t.o-n.o},"sortFunc");var En=xt,Oi=class Oi{constructor(){this.dks=[]}toSortedArray(){return this.dks=this.dks.sort(En.sortFunc),[].concat(this.dks)}clone(){let n=new Oi,t=this.toSortedArray();return n.dks=[],t.forEach(function(i){n.dks.push(i.clone())}),n}isMatch(n,t,i){if(this.dks.length==0)return!1;var l=n;t=l-t;for(var s=0;s<this.dks.length;s++)if(this.dks[s].match(t,i)&&!this.dks[s].matched)return this.dks[s].set(),!0;return this.resetMatched(),!1}add(n){this.dks=this.dks.concat(n)}remove(n){var t=this.dks.indexOf(n);this.dks.splice(t,1)}clear(){this.dks=[]}resetMatched(){for(let n of this.dks)n.reset()}deleteMatched(){for(var n=0;n<this.dks.length;n++)this.dks[n].matched&&this.dks.splice(n--,1)}adjustPositions(n,t){if(t!=0)for(let i of this.dks)i.p>n&&(i.p+=t)}equal(n){if(this.dks.length!=n.dks.length)return!1;let t=n.dks,i=[];for(let l of this.dks)if(!t.find(c=>l.equal(c)))return!1;return i.length==t.length}count(){return this.dks.length}};a(Oi,"DeadkeyTracker");var Di=Oi;Hn();function Zt(g){var n;return g?g.insert===""&&g.deleteLeft===0&&((n=g.deleteRight)!=null?n:0)===0:!0}a(Zt,"isEmptyTransform");var Tn=class Tn{constructor(n,t,i,l){this.insert=n,this.deleteLeft=t,this.deleteRight=i,this.erasedSelection=l}};a(Tn,"TextTransform"),Tn.nil=new Tn("",0,0,!1);var Rs=Tn,wn=class wn{constructor(n,t,i,l){let s=this.token=wn.tokenSeed++;this.keystroke=n,this.transform=t,this.alternates=l,this.preInput=i,this.transform.id=this.token,l&&l.forEach(function(c){c.sample.id=s})}};a(wn,"Transcription"),wn.tokenSeed=0;var Hs=wn,vs=class vs{constructor(){this._dks=new Di}get isSynthetic(){return!0}resetContext(){this.deadkeys().clear()}deadkeys(){return this._dks}hasDeadkeyMatch(n,t){return this.deadkeys().isMatch(this.getDeadkeyCaret(),n,t)}insertDeadkeyBeforeCaret(n){var t=new En(this.getDeadkeyCaret(),n);this.deadkeys().add(t)}adjustDeadkeys(n){this.deadkeys().adjustPositions(this.getDeadkeyCaret(),n)}setDeadkeys(n){this._dks=n.clone()}buildTransformFrom(n){let t=this.getTextBeforeCaret(),i=n.getTextBeforeCaret(),l=As(i,t,!1),s=i.substring(l)._kmwLength(),c=t.substring(l),r=this.getTextAfterCaret(),o=n.getTextAfterCaret(),d=As(o,r,!0),u=o.substring(0,d+1)._kmwLength();return new Rs(c,s,u,n.getSelectedText()&&!this.getSelectedText())}buildTranscriptionFrom(n,t,i,l){let s=this.buildTransformFrom(n);return new Hs(t,s,N.from(n,i),l)}restoreTo(n){this.clearSelection(),this.setTextBeforeCaret(n.getTextBeforeCaret()),this.setTextAfterCaret(n.getTextAfterCaret()),this._dks=n._dks.clone()}apply(n){this.clearSelection(),n.deleteRight&&this.setTextAfterCaret(this.getTextAfterCaret()._kmwSubstr(n.deleteRight)),n.deleteLeft&&this.deleteCharsBeforeCaret(n.deleteLeft),n.insert&&this.insertTextBeforeCaret(n.insert),this._dks.clear()}setTextBeforeCaret(n){this.deleteCharsBeforeCaret(this.getTextBeforeCaret()._kmwLength()),this.insertTextBeforeCaret(n)}saveProperties(){}restoreProperties(){}};a(vs,"OutputTarget");var lt=vs;var Pt=class Pt extends lt{constructor(t,i,l){super();this.selForward=!0;this.text=t||"";var s=this.text._kmwLength();this.selStart=typeof i=="number"?i:s,this.selEnd=typeof l=="number"?l:this.selStart,this.selForward=this.selEnd>=this.selStart}static from(t,i){let l;if(t instanceof Pt){let s=t;l=new Pt(s.text,s.selStart,s.selEnd)}else{let s=t.getText(),c=s._kmwLength(),r=c,o=0;if(t.hasSelection()){let d=t.getTextBeforeCaret(),u=t.getTextAfterCaret();r=d._kmwLength(),o=c-u._kmwLength()}l=new Pt(s,r,o)}return l.setDeadkeys(t.deadkeys()),l}clearSelection(){this.text=this.getTextBeforeCaret()+this.getTextAfterCaret(),this.selEnd=this.selStart,this.selForward=!0}invalidateSelection(){}isSelectionEmpty(){return this.selStart==this.selEnd}hasSelection(){return!0}getDeadkeyCaret(){return this.selStart}setSelection(t,i){if(this.selStart=t,this.selEnd=typeof i=="number"?i:t,this.selForward=i>=t,!this.selForward){let l=this.selStart;this.selStart=this.selEnd,this.selEnd=l}}getTextBeforeCaret(){return this.text.kmwSubstr(0,this.selStart)}getSelectedText(){return this.text.kmwSubstr(this.selStart,this.selEnd-this.selStart)}getTextAfterCaret(){return this.text.kmwSubstr(this.selEnd)}getText(){return this.text}deleteCharsBeforeCaret(t){t>=0&&(t>this.selStart&&(t=this.selStart),this.adjustDeadkeys(-t),this.text=this.text.kmwSubstr(0,this.selStart-t)+this.text.kmwSubstr(this.selStart),this.selStart-=t,this.selEnd-=t)}insertTextBeforeCaret(t){this.adjustDeadkeys(t._kmwLength()),this.text=this.getTextBeforeCaret()+t+this.text.kmwSubstr(this.selStart),this.selStart+=t.kmwLength(),this.selEnd+=t.kmwLength()}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}setTextAfterCaret(t){this.text=this.getTextBeforeCaret()+t}isEqual(t){return this.text==t.text&&this.selStart==t.selStart&&this.selEnd==t.selEnd&&this.deadkeys().equal(t.deadkeys())}doInputEvent(){}};a(Pt,"Mock");var N=Pt;var fs=class fs{constructor(){this.transcription=null;this.setStore={};this.saveStore={};this.variableStores={};this.triggersDefaultCommand=!1}finalize(n,t,i){if(!this.transcription)throw"Cannot finalize a RuleBehavior with no transcription.";n.beepHandler&&this.beep&&n.beepHandler(t);for(let l in this.setStore){let s=n.keyboardInterface.systemStores[l];if(s)try{s.set(this.setStore[l])}catch(c){n.errorLogger&&n.errorLogger("Rule attempted to perform illegal operation - 'platform' may not be changed.")}else n.warningLogger&&n.warningLogger("Unknown store affected by keyboard rule: "+l)}if(n.keyboardInterface.applyVariableStores(this.variableStores),n.keyboardInterface.variableStoreSerializer)for(let l in this.saveStore)n.keyboardInterface.variableStoreSerializer.saveStore(n.activeKeyboard.id,l,this.saveStore[l]);if(this.triggersDefaultCommand){let l=this.transcription.keystroke;n.defaultRules.applyCommand(l,t)}n.warningLogger&&this.warningLog?n.warningLogger(this.warningLog):n.errorLogger&&this.errorLog&&n.errorLogger(this.errorLog)}mergeInDefaults(n){let t=this.transcription.keystroke,i=n.transcription.keystroke;if(t.Lcode!=i.Lcode||t.Lmodifiers!=i.Lmodifiers)throw"RuleBehavior default-merge not supported unless keystrokes are identical!";this.triggersDefaultCommand=this.triggersDefaultCommand||n.triggersDefaultCommand;let l=N.from(this.transcription.preInput,!1);l.apply(this.transcription.transform),l.apply(n.transcription.transform),this.transcription=l.buildTranscriptionFrom(this.transcription.preInput,t,!1,this.transcription.alternates)}};a(fs,"RuleBehavior");var le=fs;var Ls=class Ls{constructor(n){this.id=n}set(n){throw new Error("System store with ID "+this.id+" may not be directly set.")}};a(Ls,"SystemStore");var Pi=Ls,Js=class Js extends Pi{constructor(t,i){super(t);this.handler=null;this._value=i}get value(){return this._value}matches(t){return this._value==t}set(t){this.handler&&this.handler(this,t)||(this._value=t)}};a(Js,"MutableSystemStore");var jt=Js,ks=class ks extends Pi{constructor(t){super(31);this.kbdInterface=t}matches(t){var i,l,s=t.split(" ");let c=this.kbdInterface.activeDevice;for(i=0;i<s.length;i++)switch(l=s[i].toLowerCase(),l){case"touch":case"hardware":if(c.touchable!=(l=="touch"))return!1;break;case"macos":case"mac":l="macosx";case"macosx":case"windows":case"android":case"ios":case"linux":if(c.OS!=l)return!1;break;case"tablet":case"phone":case"desktop":if(c.formFactor!=l)return!1;break;case"web":if(c.browser=="native")return!1;break;case"native":case"chrome":case"firefox":case"safari":case"edge":case"opera":if(c.browser!=l)return!1;break;default:return!1}return!0}};a(ks,"PlatformSystemStore");var ji=ks;var Ts=class Ts{};a(Ts,"KeyInformation");var Ns=Ts;var ws=class ws{reset(){this._cache=[]}get(n,t){return typeof this._cache[n]=="undefined"||typeof this._cache[n][t]=="undefined"?null:this._cache[n][t]}set(n,t,i){typeof this._cache[n]=="undefined"&&(this._cache[n]=[]),this._cache[n][t]=i}};a(ws,"CachedContext");var Ys=ws,_i=class _i{reset(){this._cache=[]}get(n,t){return typeof this._cache[n]=="undefined"||typeof this._cache[n][t]=="undefined"?null:this._cache[n][t]}set(n,t,i){typeof this._cache[n]=="undefined"&&(this._cache[n]=[]),this._cache[n][t]=i}clone(){let n=new _i;return n._cache=this._cache,n}};a(_i,"CachedContextEx");var Es=_i,Mn=class Mn extends Gt{constructor(t,i,l=null){super(t,i);this.cachedContext=new Ys;this.cachedContextEx=new Es;this._AnyIndices=[];this.systemStores={},this.systemStores[31]=new ji(this),this.systemStores[33]=new jt(33,"default"),this.systemStores[42]=new jt(42,""),this.systemStores[43]=new jt(43,""),this.variableStoreSerializer=l}get Codes(){return Q}saveFocus(){}registerKeyboard(t){let i=new T(t);this.loadedKeyboard=i}context(t,i,l){var s=this.cachedContext.get(t,i);if(s!==null)return s;var c=this.KC_(t,i,l);return this.cachedContext.set(t,i,c),c}KC_(t,i,l){var s="";return s=l.isSelectionEmpty()?l.getTextBeforeCaret():"",s._kmwLength()<t&&(s=Array(t-s._kmwLength()+1).join("￾")+s),s._kmwSubstr(-t)._kmwSubstr(0,i)}nul(t,i){var l=this.context(t+1,1,i);return l==="￾"}contextMatch(t,i,l,s){var c=this.context(t,s,i);return c===l?!0:(i.deadkeys().resetMatched(),!1)}_BuildExtendedContext(t,i,l){var s=this.cachedContextEx.get(t,i);if(s!==null)return s;if(s=this.cachedContextEx.get(t,t),s===null){let B=l.deadkeys().toSortedArray();var c=0;for(s={valContext:[],deadContext:[]};s.valContext.length<t;){var r=l.getDeadkeyCaret(),o=r-c;if(B.length>0&&B[0].p>o){B.splice(0,1);continue}else if(B.length>0&&B[0].p==o)s.deadContext[t-s.valContext.length-1]=B[0],s.valContext=[B[0].d].concat(s.valContext),B.splice(0,1);else{var d=this.context(++c,1,l);s.valContext=[d].concat(s.valContext)}}this.cachedContextEx.set(t,t,s)}var u=s;return u.valContext=u.valContext.slice(0,i),this.cachedContextEx.set(t,i,u),u}fullContextMatch(t,i,l){var s=this._BuildExtendedContext(t,l.length,i);this.ruleContextEx=this.cachedContextEx.clone();var c=s.valContext,r=s.deadContext,o=!1;let d="￾";for(var u=a(function(U){throw new Error("Unexpected object in fullContextMatch specification: "+U)},"assertNever"),B=0;B<l.length;B++)if(typeof l[B]=="string"){var b=l[B];if(b!==c[B]){o=!0;break}}else{var I=l[B];switch(I.t){case"d":I.d!==c[B]?o=!0:r[B].set();break;case"a":var F;typeof c[B]=="string"?F=c[B]:F={t:"d",d:c[B]};var h=this.any(B,F,I.a);I.n?I.n&&(h||c[B]===d)&&(o=!0):h?r[B]!==void 0&&r[B].set():o=!0;break;case"i":var y=this._Index(I.i,I.o);y!==void 0&&(typeof y=="string"?y:y.d)!==c[B]?o=!0:r[B]!==void 0&&r[B].set();break;case"c":c[I.c-1]!==c[B]?o=!0:r[B]!==void 0&&r[B].set();break;case"n":c[B]!=d&&(o=!0);break;default:u(I)}}return o&&(i.deadkeys().resetMatched(),this._AnyIndices=[]),!o}isKeypress(t){return this.activeKeyboard.isMnemonic?!t.LisVirtualKey:!!ne._USKeyCodeToCharCode(t)}static matchModifiersToRuleChirality(t,i){let l=m.LALTFLAG|m.RALTFLAG,s=m.LCTRLFLAG|m.RCTRLFLAG,c=t;if(!(i&l)){let r=c&l;r&&(c^=r|m.K_ALTFLAG)}if(!(i&s)){let r=c&s;r&&(c^=r|m.K_CTRLFLAG)}return c}keyMatch(t,i,l){var s=!1,c=t.Lcode==173?189:t.Lcode;let r=this.activeKeyboard.modifierBitmask;var o=r&Q.modifierBitmasks.ALL,d=r&Q.stateBitmasks.ALL;let u=Mn.matchModifiersToRuleChirality(t.Lmodifiers,i);return t.vkCode>255&&(c=t.vkCode),t.LisVirtualKey||c>255?((i&16384)==16384||c>255)&&(s=l==c&&(i&o)==u,s=s&&this.stateMatch(t,i&d)):i&16384||(s=c==l),s||this.activeTargetOutput.deadkeys().resetMatched(),s}stateMatch(t,i){return(i&t.Lstates)==i}keyInformation(t){var i=new Ns;return i.vk=t.LisVirtualKey,i.code=t.Lcode,i.modifiers=t.Lmodifiers,i}deadkeyMatch(t,i,l){return i.hasDeadkeyMatch(t,l)}beep(t){this.resetContextCache(),this.ruleBehavior.beep=!0}_ExplodeStore(t){if(typeof t=="string"){let s=this.activeKeyboard.explodedStores;if(s[t])return s[t];for(var i=[],l=0;l<t._kmwLength();l++)i.push(t._kmwCharAt(l));return s[t]=i,i}else return t}any(t,i,l){if(i=="")return!1;l=this._ExplodeStore(l);for(var s=-1,c=0;c<l.length;c++){let r=l[c];if(typeof r=="string"){if(l[c]==i){s=c;break}}else if(r.d===i.d){s=c;break}}return this._AnyIndices[t]=s,s>=0}_Index(t,i){return t=this._ExplodeStore(t),this._AnyIndices[i-1]<t.length?t[this._AnyIndices[i-1]]:(console.warn("Unmatched contextual index() statement detected in rule with index "+i+"!"),"")}indexOutput(t,i,l,s){this.resetContextCache();var c=a(function(o){throw new Error("Unexpected object in fullContextMatch specification: "+o)},"assertNever"),r=this._Index(i,l);if(r!=="")if(typeof r=="string")this.output(t,s,r);else if(r.t)switch(r.t){case"b":this.beep(s);break;case"d":this.deadkeyOutput(t,s,r.d);break;default:c(r)}else this.deadkeyOutput(t,s,r.d)}deleteContext(t,i){var l;if(t>0){l=this._BuildExtendedContext(t,t,i);let r=0;for(var s=0;s<l.valContext.length;s++){var c=l.deadContext[s];c?(i.deadkeys().remove(c),t--):l.valContext[s]=="￾"&&r++}let o=l.valContext.length-r;t>o&&(t=o)}i.deadkeys().resetMatched(),this.output(t,i,"")}output(t,i,l){this.resetContextCache(),i.saveProperties(),i.clearSelection(),i.deadkeys().deleteMatched(),t>=0&&i.deleteCharsBeforeCaret(t),i.insertTextBeforeCaret(l),i.restoreProperties()}contextExOutput(t,i,l,s){this.resetContextCache(),t>=0&&this.output(t,i,"");let c=this.ruleContextEx.get(l,l),r=c.deadContext[s-1],o=c.valContext[s-1];if(r)i.insertDeadkeyBeforeCaret(r.d);else if(typeof o=="string")this.output(-1,i,o);else throw new Error("contextExOutput: should never be a numeric valContext with no corresponding deadContext")}deadkeyOutput(t,i,l){this.resetContextCache(),t>=0&&this.output(t,i,""),i.insertDeadkeyBeforeCaret(l)}ifStore(t,i,l){var s=!0;let c=this.systemStores[t];return c&&(s=c.matches(i)),s}setStore(t,i,l){return this.resetContextCache(),t==33&&this.activeDevice.touchable?(this.ruleBehavior.setStore[t]=i,!0):!1}loadStore(t,i,l){return this.resetContextCache(),this.variableStoreSerializer&&this.variableStoreSerializer.loadStore(t,i)[i]||l}saveStore(t,i){this.resetContextCache();var l=this.activeKeyboard;if(!l||typeof l.id=="undefined"||l.id=="")return!1;let s={};return s[t]=i,this.ruleBehavior?this.ruleBehavior.saveStore[t]=s:this.variableStoreSerializer.saveStore(this.activeKeyboard.id,t,s),!0}resetContextCache(){this.cachedContext.reset(),this.cachedContextEx.reset()}defaultBackspace(t){t.isSelectionEmpty()?this.output(1,t,""):this.output(0,t,"")}processNewContextEvent(t,i){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processNewContextEvent.bind(this.activeKeyboard),t,i,!0)}processPostKeystroke(t,i){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.processPostKeystroke.bind(this.activeKeyboard),t,i,!0)}processKeystroke(t,i){if(!this.activeKeyboard)throw"No active keyboard for keystroke processing!";return this.process(this.activeKeyboard.process.bind(this.activeKeyboard),t,i,!1)}process(t,i,l,s){if(i)if(this.activeKeyboard){if(!t)throw"No callee for keystroke processing!"}else throw"No active keyboard for keystroke processing!";else throw"No target specified for keyboard output!";i.invalidateSelection(),i.deadkeys().resetMatched(),this.resetContextCache();let c=N.from(i,!0),r=this.activeKeyboard.variableStores;this.ruleBehavior=new le,this.activeDevice=l.device,this.activeTargetOutput=i;var o=t(i,l);this.activeTargetOutput=null,this.ruleBehavior.transcription=i.buildTranscriptionFrom(c,l,s),this.ruleBehavior.variableStores=this.activeKeyboard.variableStores,this.activeKeyboard.variableStores=r,this.ruleBehavior.triggerKeyDefault=!o;let d=this.ruleBehavior;return this.ruleBehavior=null,d}applyVariableStores(t){this.activeKeyboard.variableStores=t}static __publishShorthandAPI(){let t=this.prototype;var i=a(function(l,s){t[s]&&(t[l]=t[s])},"exportKBCallback");i("KSF","saveFocus"),i("KBR","beepReset"),i("KT","insertText"),i("KR","registerKeyboard"),i("KRS","registerStub"),i("KC","context"),i("KN","nul"),i("KCM","contextMatch"),i("KFCM","fullContextMatch"),i("KIK","isKeypress"),i("KKM","keyMatch"),i("KSM","stateMatch"),i("KKI","keyInformation"),i("KDM","deadkeyMatch"),i("KB","beep"),i("KA","any"),i("KDC","deleteContext"),i("KO","output"),i("KDO","deadkeyOutput"),i("KCXO","contextExOutput"),i("KIO","indexOutput"),i("KIFS","ifStore"),i("KSETS","setStore"),i("KLOAD","loadStore"),i("KSAVE","saveStore")}};a(Mn,"KeyboardInterface"),Mn.GLOBAL_NAME="KeymanWeb";var Me=Mn;(function(){Me.__publishShorthandAPI()})();var Xt=class Xt extends V.default{constructor(t,i){super();this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.modStateFlags=0;i||(i=Xt.DEFAULT_OPTIONS),this.contextDevice=t,this.baseLayout=i.baseLayout||Xt.DEFAULT_OPTIONS.baseLayout,this.keyboardInterface=i.keyboardInterface||new Me(Et(),fn),this.defaultRules=i.defaultOutputRules||Xt.DEFAULT_OPTIONS.defaultOutputRules}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(t){this.keyboardInterface.activeKeyboard=t,this.resetContext()}get layerStore(){return this.keyboardInterface.systemStores[33]}get newLayerStore(){return this.keyboardInterface.systemStores[42]}get oldLayerStore(){return this.keyboardInterface.systemStores[43]}get layerId(){return this.layerStore.value}set layerId(t){this.layerStore.set(t)}defaultRuleBehavior(t,i,l){let s=N.from(i,l),c=new le,r=!1;var o="",d;if(t.isSynthetic||i.isSynthetic)if(r=!0,this.defaultRules.isCommand(t))c.triggersDefaultCommand=!0;else if((d=this.defaultRules.forSpecialEmulation(t))!=null)switch(d){case"\b":this.keyboardInterface.defaultBackspace(i);break;case`
`:i.handleNewlineAtCaret();break;default:c.errorLog="Unexpected 'special emulation' character (\\u"+d.kmwCharCodeAt(0).toString(16)+") went unhandled!"}else r=!1;let u=this.activeKeyboard&&this.activeKeyboard.isMnemonic;if(!r)if((o=this.defaultRules.forAny(t,u,c))!=null)if(d=this.defaultRules.forSpecialEmulation(t),d=="\b")this.keyboardInterface.defaultBackspace(i);else{if(d||this.defaultRules.isCommand(t))return null;this.keyboardInterface.output(0,i,o)}else return null;if(c.errorLog)return c;let B=i.buildTranscriptionFrom(s,t,l);return c.transcription=B,c}processNewContextEvent(t,i){return this.activeKeyboard?this.keyboardInterface.processNewContextEvent(i,this.activeKeyboard.constructNullKeyEvent(t,this.stateKeys)):null}processPostKeystroke(t,i){return this.activeKeyboard?this.keyboardInterface.processPostKeystroke(i,this.activeKeyboard.constructNullKeyEvent(t,this.stateKeys)):null}processKeystroke(t,i){var l;let s=i.getTextBeforeCaret().kmwLength()==0&&i.isSelectionEmpty();if(this.activeKeyboard&&t.Lcode!=0&&(l=this.keyboardInterface.processKeystroke(i,t)),s&&t.Lcode==Q.keyCodes.K_BKSP&&l.triggerKeyDefault)l=this.defaultRuleBehavior(t,i,!1),l.triggerKeyDefault=!0,l.transcription.transform.deleteLeft=1;else if(!l||l.triggerKeyDefault){t.Lcode=t.vkCode||t.Lcode,this.keyboardInterface.activeTargetOutput=i;let c=this.defaultRuleBehavior(t,i,!1);c&&(l?l.mergeInDefaults(c):l=c,l.triggerKeyDefault=!1),this.keyboardInterface.activeTargetOutput=null}return l}_UpdateVKShift(t){let i=0,l=["CAPS","NUM_LOCK","SCROLL_LOCK"],s=["K_CAPS","K_NUMLOCK","K_SCROLL"],c=[m.CAPITALFLAG,m.NUMLOCKFLAG,m.SCROLLFLAG];if(!this.activeKeyboard)return!0;if(t){i=t.Lmodifiers,this.activeKeyboard.isChiral&&this.activeKeyboard.emulatesAltGr&&(this.modStateFlags&Q.modifierBitmasks.ALT_GR_SIM)==Q.modifierBitmasks.ALT_GR_SIM&&(i|=Q.modifierBitmasks.ALT_GR_SIM,i&=~m.RALTFLAG);let r=!1;for(let o=0;o<l.length;o++)t.Lstates&Q.stateBitmasks[l[o]]&&(this.stateKeys[s[o]]=!!(t.Lstates&c[o]),r=!0);r&&this.emit("statekeychange",this.stateKeys)}return this.updateStates(),this.activeKeyboard.isMnemonic&&this.stateKeys.K_CAPS&&(!t||!t.isModifier)&&(i^=m.K_SHIFTFLAG),this.layerId=this.getLayerId(i),!0}updateStates(){let t=["K_CAPS","K_NUMLOCK","K_SCROLL"],i=[m.CAPITALFLAG,m.NUMLOCKFLAG,m.SCROLLFLAG],l=[m.NOTCAPITALFLAG,m.NOTNUMLOCKFLAG,m.NOTSCROLLFLAG];for(let s=0;s<t.length;s++){let c=t[s];this.stateKeys[c]?(this.modStateFlags|=i[s],this.modStateFlags&=~l[s]):(this.modStateFlags&=~i[s],this.modStateFlags|=l[s])}}getLayerId(t){return E.getLayerId(t)}selectLayer(t){let i=t.kName;var l=t.kNextLayer,s=this.activeKeyboard&&this.activeKeyboard.isChiral;if(typeof l=="number"&&(l=this.getLayerId(l*16)),!l)switch(i){case"K_LSHIFT":case"K_RSHIFT":case"K_SHIFT":l="shift";break;case"K_LCONTROL":case"K_LCTRL":if(s){l="leftctrl";break}case"K_RCONTROL":case"K_RCTRL":if(s){l="rightctrl";break}case"K_CTRL":l="ctrl";break;case"K_LMENU":case"K_LALT":if(s){l="leftalt";break}case"K_RMENU":case"K_RALT":if(s){l="rightalt";break}case"K_ALT":l="alt";break;case"K_ALTGR":s?l="leftctrl-rightalt":l="ctrl-alt";break;case"K_CURRENCIES":case"K_NUMERALS":case"K_SHIFTED":case"K_UPPER":case"K_LOWER":case"K_SYMBOLS":l="default";break}return l?(this.updateLayer(t,l),!0):!1}updateLayer(t,i){let l=this.layerId;var s=l;if(i==l&&t.device.formFactor!=S.FormFactor.Desktop)return;var c=i,r;if(t.device.formFactor==S.FormFactor.Desktop){var o=["leftctrl","rightctrl","ctrl","leftalt","rightalt","alt","shift"];for(r=0;r<o.length;r++)c=c.replace(o[r]+"-",""),c=c.replace(o[r],"");if(l=="default"||l=="numeric"||l=="symbol"||l=="currency"||c!="")s=i;else{var d=Q.getModifierState(s);for(r=0;r<o.length;r++)s=s.replace(o[r]+"-",""),s=s.replace(o[r],"");switch(i){case"shift":d^=m.K_SHIFTFLAG;break;case"leftctrl":d^=m.LCTRLFLAG;break;case"rightctrl":d^=m.RCTRLFLAG;break;case"ctrl":d^=m.K_CTRLFLAG;break;case"leftalt":d^=m.LALTFLAG;break;case"rightalt":d^=m.RALTFLAG;break;case"alt":d^=m.K_ALTFLAG;break;default:s=i}s!="default"&&(s==""?s=this.getLayerId(d):s=this.getLayerId(d)+"-"+s)}s==""&&(s="default")}else s=i;this.activeKeyboard.layout(t.device.formFactor).getLayer(s)?this.layerId=s:this.layerId="default";let B=Q.getModifierState(this.layerId);this.modStateFlags=B|t.Lstates}doModifierPress(t,i,l){return this.activeKeyboard?t.isModifier?(this.activeKeyboard.notify(t.Lcode,i,l?1:0),t.device.touchable?!0:this._UpdateVKShift(t)):(t.LmodifierChange&&(this.activeKeyboard.notify(0,i,1),t.device.touchable||this._UpdateVKShift(t)),!1):!1}performNewContextEvent(t){let i=this.processNewContextEvent(this.contextDevice,t);return i&&i.finalize(this,t,!0),i}resetContext(t){this.layerId="default",t==null||t.resetContext(),this.keyboardInterface.resetContextCache(),t&&this.performNewContextEvent(t),this.contextDevice.touchable||this._UpdateVKShift(null)}setNumericLayer(t){this.activeKeyboard&&this.activeKeyboard.layout(t.formFactor).getLayer("numeric")&&(this.layerId="numeric")}};a(Xt,"KeyboardProcessor"),Xt.DEFAULT_OPTIONS={baseLayout:"us",defaultOutputRules:new We};var _t=Xt;var qi="Keyboard_";function se(g){return g.startsWith(qi)?g:qi+g}a(se,"prefixed");function Ke(g){return g.startsWith(qi)?g.substring(qi.length):g}a(Ke,"withoutPrefix");var Ms=class Ms extends V.default{constructor(t){super();this.stubSetTable={};this.keyboardTable={};this.keyboardLoader=t}getKeyboardForStub(t){return t?this.getKeyboard(t.KI):null}getKeyboard(t){if(!t)return null;let i=this.keyboardTable[se(t)];return i instanceof Promise?null:i}get defaultStub(){function t(l){let s=Object.keys(l);if(s.length!=0)return l[s[0]]}a(t,"getFirstValue");let i=t(this.stubSetTable);if(i)return t(i)}addKeyboard(t){let i=se(t.id);this.keyboardTable[i]=t,this.emit("keyboardadded",t)}fetchKeyboardForStub(t){return this.fetchKeyboard(t.KI)}isFetchingKeyboard(t){if(!t)throw new Error("Keyboard ID must be specified");return t=se(t),this.keyboardTable[t]instanceof Promise}fetchKeyboard(t){if(!t)throw new Error("Keyboard ID must be specified");if(!this.keyboardLoader)throw new Error("Cannot load keyboards; this cache was configured without a loader");t=se(t);let i=this.keyboardTable[t];if(i instanceof T)return Promise.resolve(i);if(i instanceof Promise)return i;let l=this.getStub(t,null);if(!l)throw new Error(`No stub for ${Ke(t)} has been registered`);if(!l.filename)throw new Error(`The registered stub for ${Ke(t)} lacks a path to the main keyboard file`);let s=this.keyboardLoader.loadKeyboardFromStub(l);return this.keyboardTable[t]=s,s.then(c=>{c.scriptObject.KI=t,this.addKeyboard(c)}).catch(c=>{throw delete this.keyboardTable[t],c}),s}addStub(t){var s;let i=se(t.KI),l=this.stubSetTable[i]=(s=this.stubSetTable[i])!=null?s:{};l[t.KLC]=t,this.emit("stubadded",t)}findMatchingStub(t){return this.getStub(t.KI,t.KLC)}getStub(t,i){var r;let l,s=i||"---";t instanceof T?l=t.id:l=t,l&&(l=se(l));let c=(r=this.stubSetTable[l])!=null?r:{};if(s!="---")return c[s];{let o=Object.keys(c);return o.length==0?null:c[o[0]]}}forgetKeyboard(t,i=!1){let l=t instanceof T?t.id:se(t);this.stubSetTable[l]&&delete this.stubSetTable[l],i&&this.keyboardTable[l]&&delete this.keyboardTable[l]}getStubList(){let t=[],i=Object.keys(this.stubSetTable);for(let l of i){let s=this.stubSetTable[l],c=Object.keys(s);for(let r of c)t.push(s[r])}return t}};a(Ms,"StubAndKeyboardCache");var qt=Ms;var Ks=["World","Africa","Asia","Europe","South America","North America","Oceania","Central America","Middle East"],zs=["un","af","as","eu","sa","na","oc","ca","me"],Xa=RegExp("^(([\\.]/)|([\\.][\\.]/)|(/))|(:)");function Co(g,n){return n=n||"",g&&!Xa.test(g)?n+g:g}a(Co,"configureFilePathing");var $i=class $i extends we{constructor(t,i,l){var n=(...args)=>{super(...args)};if(typeof t!="string")if(t.id!==void 0){let s=t;s.id=se(s.id),n(s,l),this.KF=Co(s.filename,i),this.mapRegion(s.languages)}else{let s=t;s.KI=se(s.KI),n(s,l),this.KF=Co(s.KF,i),this.KP=s.KP,this.KR=s.KR,this.KRC=s.KRC;return}else n(se(t),i)}mapRegion(t){let i=t.region,l=0;if(typeof i=="number")i<1||i>9?l=0:l=i-1;else if(typeof i=="string"){let s=i.length==2?zs:Ks;for(let c=0;c<s.length;c++)if(i.toLowerCase()==s[c].toLowerCase()){l=c;break}}this.KR=Ks[l],this.KRC=zs[l]}get region(){return this.KR}get regionCode(){return this.KRC}get filename(){return this.KF}static toStubs(t,i,l){let s="";if(typeof t.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),t.languages||(t.languages=t.language),t?t.id?t.languages||(s="KeyboardStub has undefined languages"):s="KeyboardStub has undefined id":s="Stub undefined",s!="")return[{error:new Error(s)}];let c=[];Array.isArray(t.languages)?c=c.concat(t.languages):c.push(t.languages);let r=[];return c.forEach(o=>{let d=W(C({},t),{languages:o,language:void 0}),u=new $i(d,i,l);r.push(u)}),r}merge(t){this.KL||(this.KL=t.KL),this.KR||(this.KR=t.KR),this.KRC||(this.KRC=t.KRC),this.KN||(this.KN=t.KN),this.KF||(this.KF=t.KF),this.KFont||(this.KFont=t.KFont),this.KOskFont||(this.KOskFont=t.KOskFont),t._displayName&&(this._displayName||(this._displayName=t._displayName))}validateForCustomKeyboard(){return super.validateForCustomKeyboard()||!this.KF||!this.KR?new Error("To use a custom keyboard, you must specify file name, keyboard id, keyboard name, language, language code, and region."):null}};a($i,"KeyboardStub");var ee=$i;function el(g){if(g.length>1){let n=g.map(t=>{var i;return`${t.error.message}:
  ${(i=t.error.stack)!=null?i:""}`});return Promise.reject(new Error(n.join(`

`)))}else return Promise.reject(g[0].error)}a(el,"rejectErrorStubs");function Ds(g,n){if(n.length==0)return Promise.resolve(g);if(g.length==0)return el(n);{let t=g;return Promise.resolve(t.concat(n))}}a(Ds,"mergeAndResolveStubPromises");var Qo="The Cloud API request timed out.",Os="Could not find a keyboard with that ID.",Uo="The Cloud API failed to find an appropriate keyboard.",Va="Error occurred while registering keyboards: ",Sa=a(function(g){return g+" keyboard not found."},"MISSING_KEYBOARD"),Kn=class Kn extends V.default{constructor(t,i){super();this.cloudResolutionPromises=new Map;this.languageFetchStarted=!1;this.registerFromCloud=a(t=>{let i=Number.parseInt(t.timerid),l;try{l=this._registerCore(t)}catch(s){l=new Error(Va+s)}if(i){let s=this.cloudResolutionPromises.get(i);if(s)try{l instanceof Error?s.reject(l):s.resolve(l)}finally{this.cloudResolutionPromises.delete(i)}else{this.emit("unboundregister",l);return}}else{this.emit("unboundregister",l);return}},"registerFromCloud");this.requestEngine=t,this.pathConfig=i,this._languageListPromise=new H}get languageListPromise(){return this.languageFetchStarted||(this.languageFetchStarted=!0,this.keymanCloudRequest("",!0).catch(t=>{this.languageFetchStarted=!1,this._languageListPromise.reject(t),this._languageListPromise=new H})),this._languageListPromise.corePromise}keymanCloudRequest(t,i){let l="https://api.keyman.com/cloud/4.0/"+(arguments.length>1&&i?"languages":"keyboards"),s="?jsonp=keyman.register&languageidtype=bcp47&version="+K.CURRENT.toString(),c=l+s+t,{promise:r,queryId:o}=this.requestEngine.request(c);return this.cloudResolutionPromises.set(o,r),r.finally(()=>{this.cloudResolutionPromises.delete(o)}),r.corePromise}_registerCore(t){let i=t.options,l=i.fontBaseUri;if(this.pathConfig.fonts!=""?l=this.pathConfig.fonts:this.pathConfig.updateFontPath(l),typeof t.error=="string"){var s="";if(typeof t.options.keyboardid=="string"){let r=t.options.keyboardid;s=r.substring(0,1).toUpperCase()+r.substring(1)}return new Error(Sa(s))}if(typeof i=="undefined"||typeof i.context=="undefined")return new Error(Os);let c=[];if(i.context=="keyboard"){let r,o=t.keyboard;if(Array.isArray(o))for(r=0;r<o.length;r++)c=c.concat(Kn.registerLanguagesForKeyboard(o[r],i,r));else c=c.concat(Kn.registerLanguagesForKeyboard(o,i,0))}else if(i.context=="language"){let r=t.languages;return this._languageListPromise.resolve(r),r}return c}static registerLanguagesForKeyboard(t,i,l){let s="";if(typeof t=="undefined")return[];if(typeof i.keyboardid=="string"&&(s=i.keyboardid.split(",")[l]),Array.isArray(t))if(t.length==1||s.substr(-1,1)=="$"||s==""){let c=[];for(let r=0;r<t.length;r++)c=c.concat(this.registerLanguagesForKeyboard(t[r],i,l));return c}else{let c=0;for(let r=0;r<t.length;r++){let o=t[r].id.toLowerCase();if(o=="us"&&(o="english"),Array.isArray(t[r].languages)){let d=t[r].languages;for(let u=0;u<d.length;u++)if(o==d[u].name.toLowerCase()){c=r;break}}}return this.registerLanguagesForKeyboard(t[c],i,l)}else{let c=i.fontBaseUri||"",r=ee.toStubs(t,i.keyboardBaseUri,c),o=s.split("@")[1];if(r.length==1&&typeof r[0].error!="undefined")throw r[0].error;return typeof o!="string"?r:(o=o.replace(/\$$/,""),[r.find(d=>d.KLC==o)])}}fetchCloudStubs(t){return A(this,null,function*(){if(t.length==0)return Promise.resolve([]);let i="&keyboardid=",l="";for(let s=0;s<t.length;s++)i=i+l+t[s].toString(),l=",";try{return yield this.keymanCloudRequest(i,!1)}catch(s){return Promise.reject(s)}})}};a(Kn,"CloudQueryEngine");var $t=Kn;var _s=class _s{constructor(n,t){this.id=n,this.language=t}toString(){let n=this.id;return this.language?(n=n+"@"+this.language,this.version&&(n=n+"@"+this.version)):this.version&&(n=n+"@@"+this.version),n}};a(_s,"CloudRequestEntry");var js=_s;function Ps(g,n){return{keyboard:{id:g.id,name:g.name},error:typeof n=="string"?new Error(n):n}}a(Ps,"convertToErrorStub");function xo(g,n,t){let i=new js(g,n);return t&&(i.version=t),i}a(xo,"toQuerySpecs");function Zo(g,n,t){if(g.getStub(t.id,t.language)==null){for(let i=0;i<n.length;i++)if(n[i].id==t.id&&n[i].language==t.language)return!1;return!0}else return!1}a(Zo,"isUniqueRequest");var qs=class qs{constructor(n,t,i){this.pathConfig=i,this.cache=new qt(n),this.cloudQueryEngine=new $t(t,this.pathConfig),this.cloudQueryEngine.on("unboundregister",l=>{Array.isArray(l)&&l.forEach(s=>{s instanceof ee&&this.cache.addStub(s)})})}addKeyboardArray(n){let t=[],i=[],l=[],s=[],c=[];for(let d of n)if(typeof d=="string")d.length>0&&s.push(d);else if(d.KI||d.KL||d.KLC||d.KFont||d.KOskFont)l.push(new ee(d));else{let u=d;if(typeof u.language!="undefined"&&console.warn("The 'language' property for keyboard stubs has been deprecated.  Please use the 'languages' property instead."),u.languages||(u.languages=u.language),typeof u.languages=="undefined"){let B="To use keyboard '"+u.id+"', you must specify languages.";c.push(Ps(u,B))}else if(Array.isArray(u.languages)){let B=ee.toStubs(u,this.pathConfig.keyboards,this.pathConfig.fonts);for(let b of B)b instanceof ee?l.push(b):c.push(b)}else{let B=u;l.push(new ee(B,this.pathConfig.keyboards,this.pathConfig.fonts))}}for(let d of l)if(d.KF){let u=d.validateForCustomKeyboard();u?c.push(Ps(d,u)):t.push(d)}else i.push(d);let r=[];for(let d of i){if(!d.KI&&!d.KLC){c.push(Ps(d,"Cannot fetch keyboard information without a keyboard ID or language code."));continue}let u=xo(Ke(d.id),d.langId);Zo(this.cache,r,u)&&r.push(u)}for(let d of s){let u=d.split("@"),B=[""];u[0].toLowerCase()=="english"&&(u[0]="us"),u.length>1&&(B=u[1].split(","));for(let b=0;b<B.length;b++){if(b>0&&B[b]=="")continue;let I=xo(u[0],B[b],u[2]);Zo(this.cache,r,I)&&r.push(I)}}return t.forEach(d=>this.cache.addStub(d)),this.cloudQueryEngine.fetchCloudStubs(r.map(d=>d.toString())).then(d=>{for(let u of d)u instanceof ee?(this.cache.addStub(u),t.push(u)):c.push(u);return[].concat(c).concat(t)})}addLanguageKeyboards(n){return A(this,null,function*(){let t=[],i=[];try{i=yield this.cloudQueryEngine.languageListPromise}catch(c){return console.error(c),t.push({error:c}),t}let l=i,s="";for(let c=0;c<n.length;c++){let r=n[c].toLowerCase(),o=r.substr(-1,1)=="$";o&&(r=r.substr(0,r.length-1));let d=!1;for(let u=0;u<l.length;u++)if(r==l[u].name.toLowerCase()){s!=""&&(s=s+","),s=s+"@"+l[u].id,o&&(s=s+"$"),d=!0;break}if(!d){let u={language:{name:r},error:new Error(this.alertLanguageUnavailable(r))};t.push(u)}}return s==""?el(t):this.cloudQueryEngine.keymanCloudRequest("&keyboardid="+s,!1).then(c=>A(this,null,function*(){let r=yield Ds(c,t);for(let o of r)typeof o.error=="undefined"&&this.cache.addStub(o);return r}),c=>{console.error(c);let r={error:c};return t.push(r),el(t)})})}fetchCloudCatalog(){return A(this,null,function*(){try{let n=yield this.cloudQueryEngine.keymanCloudRequest("",!1);return n.forEach(t=>this.cache.addStub(t)),n}catch(n){return Promise.reject([{error:n}])}})}alertLanguageUnavailable(n){return"No keyboards are available for "+n+". Does it have another language name?"}};a(qs,"KeyboardRequisitioner");var en=qs;var $s=class $s{constructor(){this.registeredModels={};this.languageModelMap={}}modelForLanguage(n){return this.languageModelMap[n]}register(n){if(n.id=n.id.toLowerCase(),JSON.stringify(n)==JSON.stringify(this.registeredModels[n.id]))return;this.registeredModels[n.id]=n;let t=this;n.languages.forEach(function(i){if(!i){console.warn("Null / undefined language codes are not permitted for registration.");return}t.languageModelMap[i]=n})}unregister(n){let t;if(n=n.toLowerCase(),this.registeredModels[n])t=this.registeredModels[n],delete this.registeredModels[n];else return null;let i=this;return t.languages.forEach(function(l){i.languageModelMap[l].id==n&&delete i.languageModelMap[l]}),t}isRegistered(n){return!!this.registeredModels[n.id.toLowerCase()]}};a($s,"ModelManager");var tn=$s;function tl(g){let n=[];for(let t=0;t<g.length;t++)n.push(g[t]);return n}a(tl,"arrayFromNodeList");function J(g){let n=document.createElement(g);return n.style.userSelect="none",n.style.webkitUserSelect="none",n}a(J,"createUnselectableElement");var ec=class ec{constructor(n,t){this.fontStyleDefinitions={};this.linkedSheets=[];this.fontPromises=[];if(!n){let i=document.getElementsByTagName("HEAD");i.length>0?n=i[0]:n=document.body}this.linkNode=n,this.doCacheBusting=t||!1}get sheets(){return this.linkedSheets.map(n=>n.sheet)}linkStylesheet(n){if(!(n instanceof HTMLLinkElement)&&!n.innerHTML)return;let t=new H;n instanceof HTMLLinkElement?n.onload=()=>t.resolve():t.resolve(),this.linkedSheets.push({sheet:n,load:t}),this.linkNode.appendChild(n)}allLoadedPromise(){return A(this,null,function*(){let n=this.linkedSheets.map(t=>t.load.corePromise);Promise.allSettled?yield Promise.allSettled(n):yield Promise.all(n)})}addStyleSheetForFont(n,t,i){if(!n||typeof n.files=="undefined")return null;let l=n.family,s,c,r="",o="",d=[],u="";i||(i=S.OperatingSystem.Other);let B=this.fontStyleDefinitions[i]=this.fontStyleDefinitions[i]||{};if(B[l]){let U=B[l];return U.parentNode||this.linkStylesheet(U),null}for(typeof n.files=="string"?d[0]=n.files:d=n.files,c=0;c<d.length;c++)d[c].toLowerCase().indexOf("data:font")==0&&(u=d[c]),d[c].toLowerCase().indexOf(".otf")>0&&(r=d[c]),d[c].toLowerCase().indexOf(".ttf")>0&&(r=d[c]),d[c].toLowerCase().indexOf(".woff")>0&&(o=d[c]);r!=""&&r.indexOf("/")<0&&(r=t+r),o!=""&&o.indexOf("/")<0&&(o=t+o);var b=`@font-face {
font-family:"`+n.family.replace(/\u0022/g,"")+`";
font-style:normal;
font-weight:normal;
`;if(u){let x=u.substring(10,u.indexOf(";",10));b+=`src:url('${u}'), format('${x}');`}else{if(i==S.OperatingSystem.iOS?r!=""&&(this.doCacheBusting&&(r=this.cacheBust(r)),s='url("'+encodeURI(r)+`") format('truetype')`):(o!=""&&(s='url("'+encodeURI(o)+`"') format('woff')`),r!=""&&(s='url("'+encodeURI(r)+`") format('truetype')`)),!s)return null;b+="src:"+s+";"}b=b+`
}
`;let I=st(b);B[l]=I;let h=new FontFace(n.family,s).load(),y=a(()=>{this.fontPromises=this.fontPromises.filter(U=>U!=h)},"clearPromise");return this.fontPromises.push(h.then(y).catch(y)),this.linkStylesheet(I),I}cacheBust(n){return n+"?v="+new Date().getTime()}linkExternalSheet(n,t){try{if(!t&&document.querySelector("link[href="+JSON.stringify(n)+"]")!=null)return null}catch(l){return null}let i=document.createElement("link");return i.type="text/css",i.rel="stylesheet",i.href=n,this.linkStylesheet(i),i}unlink(n){let t=this.linkedSheets.findIndex(i=>i.sheet==n);return t>-1?(this.linkedSheets.splice(t,1)[0].load.resolve(),n.parentNode.removeChild(n),!0):!1}unlinkAll(){for(let n of this.linkedSheets){let t=n.sheet;t.parentNode&&t.parentNode.removeChild(t),n.load.resolve()}this.linkedSheets.splice(0,this.linkedSheets.length)}};a(ec,"StylesheetManager");var de=ec;function st(g){var n=document.createElement("style");return n.type="text/css",n.appendChild(document.createTextNode(g)),n}a(st,"createStyleSheet");function he(){var g;return typeof window.orientation!="undefined"?g=window.orientation:typeof window.screen.orientation!="undefined"&&(g=window.screen.orientation.angle),g!==void 0?Math.abs(g/90)==1:!1}a(he,"landscapeView");var tc=class tc{constructor(n){this.name=n}load(n){return this.loadCookie(this.name,n||(t=>t))}save(n,t){this.saveCookie(this.name,n,t||(i=>i))}_loadRawCookies(){let n={};if(typeof document.cookie!="undefined"&&document.cookie!=""){let t=document.cookie.split(/;\s*/);for(let i=0;i<t.length;i++){let l=t[i].split("=");l.length==2&&(n[l[0]]=l[1])}}return n}loadCookie(n,t){let i={},s=this._loadRawCookies()[n];if(s){let c=decodeURIComponent(s).split(";");for(let r=0;r<c.length&&!(r==c.length-1&&!c[r]);r++){let o=c[r].split("=");if(o.length>1){let[d,u]=o;i[d]=t(u,d)}else i[o[0]]=""}}return i}saveCookie(n,t,i){let l="";for(let r in t)l+=r+"="+i(t[r],r)+";";let c=" path=/; expires="+new Date(new Date().valueOf()+1e3*60*60*24*30).toUTCString();document.cookie=`${n}=${encodeURIComponent(l)}; ${c}`}};a(tc,"CookieSerializer");var ce=tc;function z(g){var n;if(!g)return 0;var t=g.offsetLeft?g.offsetLeft:0;if(n=g,n.offsetParent){for(;n.offsetParent;)n=n.offsetParent,t+=n.offsetLeft;let l=n.ownerDocument;n.style.position=="fixed"&&l&&l.scrollingElement&&(t+=l.scrollingElement.scrollLeft)}if(n&&n.ownerDocument&&g.ownerDocument!=window.document){var i=n.ownerDocument;if(i&&i.defaultView&&i.defaultView.frameElement)return t+z(i.defaultView.frameElement)-i.documentElement.scrollLeft}return t}a(z,"getAbsoluteX");function D(g){var n;if(!g)return 0;var t=g.offsetTop?g.offsetTop:0;if(n=g,n.ownerDocument&&n instanceof n.ownerDocument.defaultView.HTMLElement){for(;n.offsetParent;)n=n.offsetParent,t+=n.offsetTop;let l=n.ownerDocument;n.style.position=="fixed"&&l&&l.scrollingElement&&(t+=l.scrollingElement.scrollTop)}if(n&&n.ownerDocument&&g.ownerDocument!=window.document){var i=n.ownerDocument;if(i&&i.defaultView&&i.defaultView.frameElement)return t+D(i.defaultView.frameElement)}return t}a(D,"getAbsoluteY");var nc=class nc extends ce{constructor(n,t){super(`KeymanWeb_${n}_Option_${t}`)}load(){return super.load(decodeURIComponent)}save(n){super.save(n,encodeURIComponent)}};a(nc,"VarStoreSerializer");var nl=nc,ic=class ic{loadStore(n,t){return new nl(n,t).load()}saveStore(n,t,i){new nl(n,t).save(i)}};a(ic,"VariableStoreCookieSerializer");var zn=ic;var lc=class lc extends Me{constructor(t,i,l){super(t,i,new zn);this.insertText=a((t,i)=>{this.resetContextCache(),this.engine.contextManager.insertText(this,t,i)},"insertText");this.KT=this.insertText;this.engine=i,this.stubNamespacer=l}preserveID(t){var i;if(document.currentScript)i=document.currentScript.id;else{var l=document.getElementsByTagName("script"),s=l[l.length-1];i=s.id}if(i)i.indexOf(Ke(t.KI))!=-1?t.KI=i:console.error("Error when registering keyboard:  current SCRIPT tag's ID does not match!");else return}registerKeyboard(t){super.registerKeyboard(t);let i=this.loadedKeyboard;this.preserveID(t),this.engine.config.deferForInitialization.then(()=>{this.engine.keyboardRequisitioner.cache.isFetchingKeyboard(i.id)||(this.engine.keyboardRequisitioner.cache.addKeyboard(i),this.loadedKeyboard=null)})}registerStub(t){var l;this.stubNamespacer&&this.stubNamespacer(t);let i=a(()=>{let s=this.engine.config.paths;return new ee(t,s.keyboards,s.fonts)},"buildStub");if(!this.engine.config.deferForInitialization.isResolved)this.engine.config.deferForInitialization.then(()=>this.engine.keyboardRequisitioner.cache.addStub(i()));else{let s=i();if((l=this.engine.keyboardRequisitioner)!=null&&l.cache.findMatchingStub(s))return 1;this.engine.keyboardRequisitioner.cache.addStub(s)}return null}};a(lc,"KeyboardInterface");var Vt=lc;(function(){Vt.__publishShorthandAPI()})();var sc=class sc extends zt{constructor(t,i){var n=(...args)=>{super(...args)};t&&t._jsGlobal!=window&&(t._jsGlobal.String=window.String),n(t||new Gt(window,fn)),this.performCacheBusting=i||!1}loadKeyboardInternal(t,i,l){let s=new H;this.performCacheBusting&&(t=this.cacheBust(t));try{let c=this.harness._jsGlobal.document,r=c.createElement("script");l&&(r.id=l),c.head.appendChild(r),r.onerror=o=>{s.reject(i.missingError(o))},r.onload=()=>{if(this.harness.loadedKeyboard){let o=this.harness.loadedKeyboard;this.harness.loadedKeyboard=null,s.resolve(o)}else s.reject(i.scriptError())},s.then(()=>{r.remove()}).catch(()=>{r.remove()}),r.src=t}catch(c){return Promise.reject(c)}return s.corePromise}cacheBust(t){return t+"?v="+new Date().getTime()}};a(sc,"DOMKeyboardLoader");var il=sc;var ll=class ll{constructor(n,t,i){this.left=n.getTextBeforeCaret(),this.startOfBuffer=this.left._kmwLength()<=t.leftContextCodePoints,this.startOfBuffer||(this.left=this.left._kmwSubstr(-t.leftContextCodePoints)),this.right=n.getTextAfterCaret(),this.endOfBuffer=this.right._kmwLength()<=t.rightContextCodePoints,this.endOfBuffer||(this.right=this.right._kmwSubstr(0,t.rightContextCodePoints)),this.casingForm=i=="shift"?"initial":i=="caps"?"upper":null}toMock(){let n=this.left._kmwLength();return new N(this.left+(this.right||""),n)}};a(ll,"ContextWindow"),ll.ENGINE_RULE_WINDOW={leftContextCodePoints:64,rightContextCodePoints:32};var xe=ll;var cc=class cc{constructor(){this._promises=new Map}get length(){return this._promises.size}make(n,t,i){if(this._promises.has(n))return i(`Existing request with token ${n}`);this._promises.set(n,{reject:i,resolve:t})}keep(n,t){let i=this._promises.get(n);if(!i)throw new Error(`No promise associated with token: ${n}`);let l=i.resolve;return this._promises.delete(n),l(t)}break(n,t){let i=this._promises.get(n);if(!i)throw new Error(`No promise associated with token: ${n}`);this._promises.delete(n),i.reject(t)}};a(cc,"PromiseStore");var ct=cc;var rc=class rc{constructor(n,t,i){this._worker=t,this._worker.onmessage=this.onMessage.bind(this),this._declareLMLayerReady=null,this._predictPromises=new ct,this._wordbreakPromises=new ct,this._acceptPromises=new ct,this._revertPromises=new ct,this._nextToken=Number.MIN_SAFE_INTEGER,this.sendConfig(n,!!i)}sendConfig(n,t){this._worker.postMessage({message:"config",capabilities:n,testMode:t})}loadModel(n,t="file"){return new Promise((i,l)=>{this._declareLMLayerReady=i;let s={type:t};t=="file"?s.file=n:s.code=n,this._worker.postMessage({message:"load",source:s})})}unloadModel(){this._worker.postMessage({message:"unload"})}predict(n,t){let i=this._nextToken++;return new Promise((l,s)=>{this._predictPromises.make(i,l,s),this._worker.postMessage({message:"predict",token:i,transform:n,context:t})})}wordbreak(n){let t=this._nextToken++;return new Promise((i,l)=>{this._wordbreakPromises.make(t,i,l),this._worker.postMessage({message:"wordbreak",token:t,context:n})})}acceptSuggestion(n,t,i){let l=this._nextToken++;return new Promise((s,c)=>{this._acceptPromises.make(l,s,c),this._worker.postMessage({message:"accept",token:l,suggestion:n,context:t,postTransform:i})})}revertSuggestion(n,t){let i=this._nextToken++;return new Promise((l,s)=>{this._revertPromises.make(i,l,s),this._worker.postMessage({message:"revert",token:i,reversion:n,context:t})})}resetContext(n){this._worker.postMessage({message:"reset-context",context:n})}onMessage(n){let t=n.data;if(t.message==="error")console.error(t.log),t.error&&console.error(t.error);else if(t.message==="ready")this._declareLMLayerReady(n.data.configuration);else if(t.message==="suggestions")this._predictPromises.keep(t.token,t.suggestions);else if(t.message==="currentword")this._wordbreakPromises.keep(t.token,t.word);else if(t.message==="postaccept")this._acceptPromises.keep(t.token,t.reversion);else if(t.message==="postrevert")this._revertPromises.keep(t.token,t.suggestions);else throw new Error(`Message not implemented: ${t.message}`)}shutdown(){this._worker.terminate()}};a(rc,"LMLayer");var nn=rc;function sl(g){return g}a(sl,"unwrap");var Xo=`"use strict";(()=>{var De=Object.defineProperty,Vt=Object.defineProperties;var Ht=Object.getOwnPropertyDescriptors;var Tt=Object.getOwnPropertySymbols;var zt=Object.prototype.hasOwnProperty,Gt=Object.prototype.propertyIsEnumerable;var Ct=(s,t)=>{if(t=Symbol[s])return t;throw Error("Symbol."+s+" is not defined")};var St=(s,t,r)=>t in s?De(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,U=(s,t)=>{for(var r in t||(t={}))zt.call(t,r)&&St(s,r,t[r]);if(Tt)for(var r of Tt(t))Gt.call(t,r)&&St(s,r,t[r]);return s},_e=(s,t)=>Vt(s,Ht(t)),d=(s,t)=>De(s,"name",{value:t,configurable:!0});var Ue=(s,t)=>{for(var r in t)De(s,r,{get:t[r],enumerable:!0})};var F=(s,t,r)=>new Promise((n,i)=>{var o=l=>{try{u(r.next(l))}catch(c){i(c)}},a=l=>{try{u(r.throw(l))}catch(c){i(c)}},u=l=>l.done?n(l.value):Promise.resolve(l.value).then(o,a);u((r=r.apply(s,t)).next())}),ke=function(s,t){this[0]=s,this[1]=t},bt=(s,t,r)=>{var n=(a,u,l,c)=>{try{var p=r[a](u),h=(u=p.value)instanceof ke,g=p.done;Promise.resolve(h?u[0]:u).then(m=>h?n(a==="return"?a:"next",u[1]?{done:m.done,value:m.value}:m,l,c):l({value:m,done:g})).catch(m=>n("throw",m,l,c))}catch(m){c(m)}},i=a=>o[a]=u=>new Promise((l,c)=>n(a,u,l,c)),o={};return r=r.apply(s,t),o[Symbol.asyncIterator]=()=>o,i("next"),i("throw"),i("return"),o};var yt=(s,t,r)=>(t=s[Ct("asyncIterator")])?t.call(s):(s=s[Ct("iterator")](),t={},r=(n,i)=>(i=s[n])&&(t[n]=o=>new Promise((a,u,l)=>(o=i.call(s,o),l=o.done,Promise.resolve(o.value).then(c=>a({value:c,done:l}),u)))),r("next"),r("return"),t);function O(){String.kmwFromCharCode=function(s){var t=[],r;for(r=0;r<arguments.length;r++){var n=Number(arguments[r]);if(!isFinite(n)||n<0||n>1114111||Math.floor(n)!==n)throw new RangeError("Invalid code point "+n);n<65536?t.push(n):(n-=65536,t.push((n>>10)+55296),t.push(n%1024+56320))}return String.fromCharCode.apply(void 0,t)},String.prototype.kmwCharCodeAt=function(s){var t=String(this),r=0;if(s<0||s>=t.length)return NaN;for(var n=0;n<s;n++)if(r=t.kmwNextChar(r),r===null)return NaN;var i=t.charCodeAt(r);if(i>=55296&&i<=56319&&t.length>r+1){var o=t.charCodeAt(r+1);if(o>=56320&&o<=57343)return(i-55296<<10)+(o-56320)+65536}return i},String.prototype.kmwIndexOf=function(s,t){var r=String(this),n=r.indexOf(s,t);if(n<0)return n;for(var i=0,o=0;o!==null&&o<n;o=r.kmwNextChar(o))i++;return i},String.prototype.kmwLastIndexOf=function(s,t){var r=String(this),n=r.lastIndexOf(s,t);if(n<0)return n;for(var i=0,o=0;o!==null&&o<n;o=r.kmwNextChar(o))i++;return i},String.prototype.kmwLength=function(){var s=String(this);if(s.length==0)return 0;for(var t=0,r=0;r!==null;t++)r=s.kmwNextChar(r);return t},String.prototype.kmwSlice=function(s,t){var r=String(this),n=r.kmwCodePointToCodeUnit(s),i=r.kmwCodePointToCodeUnit(t);return n===null||i===null?"":r.slice(n,i)},String.prototype.kmwSubstr=function(s,t){var r=String(this);s<0&&(s=r.kmwLength()+s),s<0&&(s=0);var n=r.kmwCodePointToCodeUnit(s),i=n;if(n===null)return"";if(arguments.length<2)i=r.length;else for(var o=0;o<t;o++)i=r.kmwNextChar(i);return i===null?r.substring(n):r.substring(n,i)},String.prototype.kmwSubstring=function(s,t){var r=String(this),n,i;if(typeof t=="undefined")n=r.kmwCodePointToCodeUnit(s),i=r.length;else{if(s>t){var o=s;s=t,t=o}n=r.kmwCodePointToCodeUnit(s),i=r.kmwCodePointToCodeUnit(t)}return(isNaN(n)||n===null)&&(n=0),(isNaN(i)||i===null)&&(i=r.length),r.substring(n,i)},String.prototype.kmwNextChar=function(s){var t=String(this);if(s===null||s<0||s>=t.length-1)return null;var r=t.charCodeAt(s);if(r>=55296&&r<=56319&&t.length>s+1){var n=t.charCodeAt(s+1);if(n>=56320&&n<=57343)return s==t.length-2?null:s+2}return s+1},String.prototype.kmwPrevChar=function(s){var t=String(this);if(s==null||s<=0||s>t.length)return null;var r=t.charCodeAt(s-1);if(r>=56320&&r<=57343&&s>1){var n=t.charCodeAt(s-2);if(n>=55296&&n<=56319)return s-2}return s-1},String.prototype.kmwCodePointToCodeUnit=function(s){if(s===null)return null;var t=String(this),r=0;if(s<0){r=t.length;for(var n=0;n>s;n--)r=t.kmwPrevChar(r);return r}if(s==t.kmwLength())return t.length;for(var n=0;n<s;n++)r=t.kmwNextChar(r);return r},String.prototype.kmwCodeUnitToCodePoint=function(s){var t=String(this);return s===null?null:s==0?0:s<0?t.substr(s).kmwLength():t.substr(0,s).kmwLength()},String.prototype.kmwCharAt=function(s){var t=String(this);return s>=0?t.kmwSubstr(s,1):""},String.prototype.kmwBMPNextChar=function(s){var t=String(this);return s<0||s>=t.length-1?null:s+1},String.prototype.kmwBMPPrevChar=function(s){var t=String(this);return s<=0||s>t.length?null:s-1},String.prototype.kmwBMPCodePointToCodeUnit=function(s){return s},String.prototype.kmwBMPCodeUnitToCodePoint=function(s){return s},String.prototype.kmwBMPLength=function(){var s=String(this);return s.length},String.prototype.kmwBMPSubstr=function(s,t){var r=String(this);return s>-1?r.substr(s,t):r.substr(r.length+s,-s)},String.kmwEnableSupplementaryPlane=function(s){var t=String.prototype;String._kmwFromCharCode=s?String.kmwFromCharCode:String.fromCharCode,t._kmwCharAt=s?t.kmwCharAt:t.charAt,t._kmwCharCodeAt=s?t.kmwCharCodeAt:t.charCodeAt,t._kmwIndexOf=s?t.kmwIndexOf:t.indexOf,t._kmwLastIndexOf=s?t.kmwLastIndexOf:t.lastIndexOf,t._kmwSlice=s?t.kmwSlice:t.slice,t._kmwSubstring=s?t.kmwSubstring:t.substring,t._kmwSubstr=s?t.kmwSubstr:t.kmwBMPSubstr,t._kmwLength=s?t.kmwLength:t.kmwBMPLength,t._kmwNextChar=s?t.kmwNextChar:t.kmwBMPNextChar,t._kmwPrevChar=s?t.kmwPrevChar:t.kmwBMPPrevChar,t._kmwCodePointToCodeUnit=s?t.kmwCodePointToCodeUnit:t.kmwBMPCodePointToCodeUnit,t._kmwCodeUnitToCodePoint=s?t.kmwCodeUnitToCodePoint:t.kmwBMPCodeUnitToCodePoint},String._kmwFromCharCode||String.kmwEnableSupplementaryPlane(!1)}d(O,"extendString");O();var Fe=class Fe{constructor(t){this._isFulfilled=!1;this._isRejected=!1;this._promise=new Promise((r,n)=>{this._resolve=i=>{this._isFulfilled=!0,r(i)},this._reject=i=>{this._isRejected=!0,n(i)},t&&t(this._resolve,this._reject)})}get resolve(){return this._resolve}get reject(){return this._reject}get isFulfilled(){return this._isFulfilled}get isRejected(){return this._isRejected}get isResolved(){return this.isFulfilled||this.isRejected}then(t,r){return this._promise.then(t,r)}catch(t){return this._promise.catch(t)}finally(t){return this._promise.finally(t)}get corePromise(){return this._promise}};d(Fe,"ManagedPromise");var oe=Fe;var qe=class qe extends oe{constructor(r){let n=null;super(a=>{n=setTimeout(()=>{this.isResolved||a(!0)},r)});this.timerHandle=n;let i=this._resolve;this._resolve=a=>{clearTimeout(this.timerHandle),i(a)};let o=this._reject;this._reject=a=>{clearTimeout(this.timerHandle),o(a)}}};d(qe,"TimeoutPromise");var se=qe,We=d(s=>new se(s).corePromise,"timedPromise");var N=class N{constructor(t,r){if(typeof t!="function"){this.comparator=t.comparator,this.heap=[].concat(t.heap);return}let n=t;this.comparator=n,this.heap=(r!=null?r:[]).slice(0),this.heapify()}static leftChildIndex(t){return t*2+1}static rightChildIndex(t){return t*2+2}static parentIndex(t){return Math.floor((t-1)/2)}heapify(t,r){if(t==null||r==null){this.heapify(0,this.count-1);return}let n=[],i=-1;for(let o=r;o>=t;o--){let a=N.parentIndex(o);this.siftDown(o)&&a<t&&i!=a&&(n.push(a),i=a)}for(i=-1;n.length>0;){let o=n.shift(),a=N.parentIndex(o);this.siftDown(o)&&a>=0&&i!=a&&(n.push(a),i=a)}}get count(){return this.heap.length}peek(){return this.heap[0]}enqueue(t){let r=this.heap.length;this.heap.push(t);let n=N.parentIndex,i=n(r);for(;r!==0&&this.comparator(this.heap[r],this.heap[i])<0;){let o=this.heap[r];this.heap[r]=this.heap[i],this.heap[i]=o,r=i,i=n(r)}}enqueueAll(t){if(t.length==0)return;let r=this.count;this.heap=this.heap.concat(t);let n=N.parentIndex(r);this.heapify(n>=0?n:0,N.parentIndex(this.count-1))}dequeue(){if(this.count==0)return;let t=this.heap[0],r=this.heap.pop();return this.heap.length>0&&(this.heap[0]=r,this.siftDown(0)),t}siftDown(t){let r=N.leftChildIndex(t),n=N.rightChildIndex(t),i=t;if(r<this.heap.length&&this.comparator(this.heap[r],this.heap[i])<0&&(i=r),n<this.heap.length&&this.comparator(this.heap[n],this.heap[i])<0&&(i=n),i!=t){let o=this.heap[t];return this.heap[t]=this.heap[i],this.heap[i]=o,this.siftDown(i),!0}else return!1}toArray(){return this.heap.slice(0)}};d(N,"PriorityQueue");var w=N;var we={};Ue(we,{DummyModel:()=>At,QuoteBehavior:()=>Y,SENTINEL_CODE_UNIT:()=>R,TrieModel:()=>pe,applyTransform:()=>S,buildMergedTransform:()=>W,defaultApplyCasing:()=>Le,getLastPreCaretToken:()=>ue,isHighSurrogate:()=>q,isLowSurrogate:()=>Be,isSentinel:()=>Me,tokenize:()=>le,transformToSuggestion:()=>B,wordbreak:()=>$});var e={};O();var R="﷐";function S(s,t){var p,h;let r=t.left||"",n=r.kmwLength(),i=n<s.deleteLeft?n:s.deleteLeft,o=r.kmwSubstr(0,n-i)+(s.insert||""),a=t.right||"",u=a.kmwLength(),l=u<((p=s.deleteRight)!=null?p:0)?u:(h=s.deleteRight)!=null?h:0,c=a.kmwSubstr(l);return{left:o,right:c,startOfBuffer:t.startOfBuffer,endOfBuffer:t.endOfBuffer,casingForm:t.casingForm}}d(S,"applyTransform");function W(s,t){let r=s.insert,n=t.deleteLeft;if(t.deleteLeft){let i=s.insert.kmwLength();i<=t.deleteLeft?(r="",n=t.deleteLeft-i):(r=s.insert.kmwSubstr(0,i-t.deleteLeft),n=0)}return{insert:r+t.insert,deleteLeft:s.deleteLeft+n,deleteRight:(s.deleteRight||0)+(t.deleteRight||0)}}d(W,"buildMergedTransform");function q(s){return typeof s=="string"&&(s=s.charCodeAt(0)),s>=55296&&s<=56319}d(q,"isHighSurrogate");function Be(s){return typeof s=="string"&&(s=s.charCodeAt(0)),s>=56320&&s<=57343}d(Be,"isLowSurrogate");function Me(s){return s==R}d(Me,"isSentinel");function B(s,t){let r={transform:s,displayAs:s.insert};return s.id!==void 0&&(r.transformId=s.id),(t===0||t)&&(r.p=t),r}d(B,"transformToSuggestion");function Le(s,t){switch(s){case"lower":return t.toLowerCase();case"upper":return t.toUpperCase();case"initial":let r=1;return t.length>1&&q(t.charAt(0))&&Be(t.charCodeAt(1))&&(r=2),t.substring(0,r).toUpperCase().concat(t.substring(r))}}d(Le,"defaultApplyCasing");var ae=(n=>(n.noQuotes="no-quotes",n.useQuotes="use-quotes",n.default="default-quotes",n))(ae||{});(t=>{function s(r,n,i,o){if(o=="default-quotes"||!o)throw"Specified quote behavior may be ambiguous - default behavior not specified (may not be .default)";switch(r=="default-quotes"&&(r=o),r){case"no-quotes":return n;case"use-quotes":let{open:a,close:u}=i.quotesForKeepSuggestion;return a+n+u;default:throw"Unsupported quote behavior state detected; implementation missing!"}}t.apply=s,d(s,"apply")})(ae||(ae={}));var Y=ae;function le(s,t,r){let n=(r==null?void 0:r.rejoins)||["'"];t=t||{left:void 0,startOfBuffer:void 0,endOfBuffer:void 0};let i=s(t.left||"")||[],o=s(t.right||"")||[],a={left:[],right:[],caretSplitsToken:!1},u=0;for(;i.length>0;){let p=i[0];if(Math.max(p.start,u)!=u){let h=Math.max(u,p.start);a.left.push({text:t.left.substring(u,h),isWhitespace:!0}),u=h}else i.shift(),a.left.push({text:p.text}),u=Math.max(u,p.end)}if(t.left!=null&&u!=t.left.length){let p=Math.max(u,t.left.length);a.left.push({text:t.left.substring(u,p),isWhitespace:!0}),u=p}let l=a.left.length;if(l>1){let p=a.left[l-2],h=a.left[l-1];!p.isWhitespace&&!h.isWhitespace&&n.indexOf(h.text)!=-1&&(a.left.pop(),a.left.pop(),a.left.push({text:p.text+h.text}),l--)}u=0;let c=!0;for(;o.length>0;){let p=o[0];if(Math.max(p.start,u)!=u){let h=Math.max(u,p.start);a.right.push({text:t.right.substring(u,h),isWhitespace:!0}),u=h}else{let h=a.left[l-1];h&&c&&!h.isWhitespace&&s(h.text+p.text).length==1&&(a.caretSplitsToken=!0),o.shift(),a.right.push({text:p.text}),u=Math.max(u,p.end)}c=!1}if(t.right&&u!=t.right.length){let p=Math.max(u,t.right.length);a.right.push({text:t.right.substring(u,p),isWhitespace:!0}),u=p}return a}d(le,"tokenize");function ue(s,t){let r=le(s,t);if(r.left.length>0){let n=r.left.pop();return n.isWhitespace?"":n.text}return""}d(ue,"getLastPreCaretToken");function $(s,t){return ue(s,t)}d($,"wordbreak");var ce={};Ue(ce,{ascii:()=>Ve,default:()=>D,defaultWordbreaker:()=>D,placeholder:()=>Ke});function Ke(s){let t=0;return s.split(/\\s+/).map(r=>{let n={start:t,end:t+r.length,text:r,length:r.length};return t=n.end,n})}d(Ke,"placeholder");function Ve(s){let t=/[A-Za-z0-9']+/g,r=[],n;for(;(n=t.exec(s))!==null;)r.push(new Qe(n[0],n.index));return r}d(Ve,"ascii");var He=class He{constructor(t,r){this.text=t,this.start=r}get length(){return this.text.length}get end(){return this.start+this.text.length}};d(He,"RegExpDerivedSpan");var Qe=He;var kt=["Other","LF","Newline","CR","WSegSpace","Double_Quote","Single_Quote","MidNum","MidNumLet","Numeric","MidLetter","ALetter","ExtendNumLet","Format","Extend","Hebrew_Letter","ZWJ","Katakana","Regional_Indicator","sot","eot"],Mt=\`\\0 
!\\v"
#  $! "%# '&( ,'- .(/ 0):*;'< A+[ _,\\\` a+{ " ª+« ­-® µ+¶ ·*¸ º+» À+× Ø+÷ ø+˘ ˞+̀.Ͱ+͵ Ͷ+͸ ͺ+;'Ϳ+΀ Ά+·*Έ+΋ Ό+΍ Ύ+΢ Σ+϶ Ϸ+҂ ҃.Ҋ+԰ Ա+՗ ՙ+՝ ՞+՟*ՠ+։'֊+֋ ֑.־ ֿ.׀ ׁ.׃ ׄ.׆ ׇ.׈ א/׫ ׯ/׳+״*׵ ؀)؆ ،'؎ ؐ.؛ ؜-؝ ؠ+ً.٠)٪ ٫)٬'٭ ٮ+ٰ.ٱ+۔ ە+ۖ.۝)۞ ۟.ۥ+ۧ.۩ ۪.ۮ+۰)ۺ+۽ ۿ+܀ ܏+ܑ.ܒ+ܰ.݋ ݍ+ަ.ޱ+޲ ߀)ߊ+߫.ߴ+߶ ߸'߹ ߺ+߻ ߽.߾ ࠀ+ࠖ.ࠚ+ࠛ.ࠤ+ࠥ.ࠨ+ࠩ.࠮ ࡀ+࡙.࡜ ࡠ+࡫ ࡰ+࢈ ࢉ+࢏ ࢐)࢒ ࢗ.ࢠ+࣊.࣢)ࣣ.ऄ+ऺ.ऽ+ा.ॐ+॑.क़+ॢ.। ०)॰ ॱ+ঁ.঄ অ+঍ এ+঑ ও+঩ প+঱ ল+঳ শ+঺ ়.ঽ+া.৅ ে.৉ ো.ৎ+৏ ৗ.৘ ড়+৞ য়+ৢ.৤ ০)ৰ+৲ ৼ+৽ ৾.৿ ਁ.਄ ਅ+਋ ਏ+਑ ਓ+਩ ਪ+਱ ਲ+਴ ਵ+਷ ਸ+਺ ਼.਽ ਾ.੃ ੇ.੉ ੋ.੎ ੑ.੒ ਖ਼+੝ ਫ਼+੟ ੦)ੰ.ੲ+ੵ.੶ ઁ.઄ અ+઎ એ+઒ ઓ+઩ પ+઱ લ+઴ વ+઺ ઼.ઽ+ા.૆ ે.૊ ો.૎ ૐ+૑ ૠ+ૢ.૤ ૦)૰ ૹ+ૺ.଀ ଁ.଄ ଅ+଍ ଏ+଑ ଓ+଩ ପ+଱ ଲ+଴ ଵ+଺ ଼.ଽ+ା.୅ େ.୉ ୋ.୎ ୕.୘ ଡ଼+୞ ୟ+ୢ.୤ ୦)୰ ୱ+୲ ஂ.ஃ+஄ அ+஋ எ+஑ ஒ+஖ ங+஛ ஜ+஝ ஞ+஠ ண+஥ ந+஫ ம+஺ ா.௃ ெ.௉ ொ.௎ ௐ+௑ ௗ.௘ ௦)௰ ఀ.అ+఍ ఎ+఑ ఒ+఩ ప+఺ ఼.ఽ+ా.౅ ె.౉ ొ.౎ ౕ.౗ ౘ+౛ ౝ+౞ ౠ+ౢ.౤ ౦)౰ ಀ+ಁ.಄ ಅ+಍ ಎ+಑ ಒ+಩ ಪ+಴ ವ+಺ ಼.ಽ+ಾ.೅ ೆ.೉ ೊ.೎ ೕ.೗ ೝ+೟ ೠ+ೢ.೤ ೦)೰ ೱ+ೳ.೴ ഀ.ഄ+഍ എ+഑ ഒ+഻.ഽ+ാ.൅ െ.൉ ൊ.ൎ+൏ ൔ+ൗ.൘ ൟ+ൢ.൤ ൦)൰ ൺ+඀ ඁ.඄ අ+඗ ක+඲ ඳ+඼ ල+඾ ව+෇ ්.෋ ා.෕ ූ.෗ ෘ.෠ ෦)෰ ෲ.෴ ั.า ิ.฻ ็.๏ ๐)๚ ັ.າ ິ.ຽ ່.໏ ໐)໚ ༀ+༁ ༘.༚ ༠)༪ ༵.༶ ༷.༸ ༹.༺ ༾.ཀ+཈ ཉ+཭ ཱ.྅ ྆.ྈ+ྍ.྘ ྙ.྽ ࿆.࿇ ါ.ဿ ၀)၊ ၖ.ၚ ၞ.ၡ ၢ.ၥ ၧ.ၮ ၱ.ၵ ႂ.ႎ ႏ.႐)ႚ.႞ Ⴀ+჆ Ⴧ+჈ Ⴭ+჎ ა+჻ ჼ+቉ ቊ+቎ ቐ+቗ ቘ+቙ ቚ+቞ በ+኉ ኊ+኎ ነ+኱ ኲ+኶ ኸ+኿ ዀ+዁ ዂ+዆ ወ+዗ ዘ+጑ ጒ+጖ ጘ+፛ ፝.፠ ᎀ+᎐ Ꭰ+᏶ ᏸ+᏾ ᐁ+᙭ ᙯ+ $ᚁ+᚛ ᚠ+᛫ ᛮ+᛹ ᜀ+ᜒ.᜖ ᜟ+ᜲ.᜵ ᝀ+ᝒ.᝔ ᝠ+᝭ ᝮ+᝱ ᝲ.᝴ ឴.។ ៝.៞ ០)៪ ᠋.᠎-᠏.᠐)᠚ ᠠ+᡹ ᢀ+ᢅ.ᢇ+ᢩ.ᢪ+᢫ ᢰ+᣶ ᤀ+᤟ ᤠ.᤬ ᤰ.᤼ ᥆)ᥐ ᧐)᧛ ᨀ+ᨗ.᨜ ᩕ.᩟ ᩠.᩽ ᩿.᪀)᪊ ᪐)᪚ ᪰.᫏ ᬀ.ᬅ+᬴.ᭅ+᭍ ᭐)᭚ ᭫.᭴ ᮀ.ᮃ+ᮡ.ᮮ+᮰)ᮺ+᯦.᯴ ᰀ+ᰤ.᰸ ᱀)᱊ ᱍ+᱐)ᱚ+᱾ ᲀ+᲋ Ა+᲻ Ჽ+᳀ ᳐.᳓ ᳔.ᳩ+᳭.ᳮ+᳴.ᳵ+᳷.ᳺ+᳻ ᴀ+᷀.Ḁ+἖ Ἐ+἞ ἠ+὆ Ὀ+὎ ὐ+὘ Ὑ+὚ Ὓ+὜ Ὕ+὞ Ὗ+὾ ᾀ+᾵ ᾶ+᾽ ι+᾿ ῂ+῅ ῆ+῍ ῐ+῔ ῖ+῜ ῠ+῭ ῲ+῵ ῶ+´  $   $​ ‌.‍0‎-‐ ‘(‚ ․(‥ ‧*\\u2028"‪- ,‰ ‿,⁁ ⁄'⁅ ⁔,⁕  $⁠-⁥ ⁦-⁰ ⁱ+⁲ ⁿ+₀ ₐ+₝ ⃐.⃱ ℂ+℃ ℇ+℈ ℊ+℔ ℕ+№ ℙ+℞ ℤ+℥ Ω+℧ ℨ+℩ K+℮ ℯ+℺ ℼ+⅀ ⅅ+⅊ ⅎ+⅏ Ⅰ+↉ Ⓐ+⓪ Ⰰ+⳥ Ⳬ+⳯.Ⳳ+⳴ ⴀ+⴦ ⴧ+⴨ ⴭ+⴮ ⴰ+⵨ ⵯ+⵰ ⵿.ⶀ+⶗ ⶠ+⶧ ⶨ+⶯ ⶰ+⶷ ⶸ+⶿ ⷀ+⷇ ⷈ+⷏ ⷐ+⷗ ⷘ+⷟ ⷠ.⸀ ⸯ+⸰ 　$、 々+〆 〪.〰 〱1〶 〻+〽 ゙.゛1ゝ ゠1・ ー1㄀ ㄅ+㄰ ㄱ+㆏ ㆠ+㇀ ㇰ1㈀ ㋐1㋿ ㌀1㍘ ꀀ+꒍ ꓐ+꓾ ꔀ+꘍ ꘐ+꘠)ꘪ+꘬ Ꙁ+꙯.꙳ ꙴ.꙾ ꙿ+ꚞ.ꚠ+꛰.꛲ ꜈+꟎ Ꟑ+꟒ ꟓ+꟔ ꟕ+꟝ ꟲ+ꠂ.ꠃ+꠆.ꠇ+ꠋ.ꠌ+ꠣ.꠨ ꠬.꠭ ꡀ+꡴ ꢀ.ꢂ+ꢴ.꣆ ꣐)꣚ ꣠.ꣲ+꣸ ꣻ+꣼ ꣽ+ꣿ.꤀)ꤊ+ꤦ.꤮ ꤰ+ꥇ.꥔ ꥠ+꥽ ꦀ.ꦄ+꦳.꧁ ꧏ+꧐)꧚ ꧥ.ꧦ ꧰)ꧺ ꨀ+ꨩ.꨷ ꩀ+ꩃ.ꩄ+ꩌ.꩎ ꩐)꩚ ꩻ.ꩾ ꪰ.ꪱ ꪲ.ꪵ ꪷ.ꪹ ꪾ.ꫀ ꫁.ꫂ ꫠ+ꫫ.꫰ ꫲ+ꫵ.꫷ ꬁ+꬇ ꬉ+꬏ ꬑ+꬗ ꬠ+꬧ ꬨ+꬯ ꬰ+꭪ ꭰ+ꯣ.꯫ ꯬.꯮ ꯰)꯺ 가+힤 ힰ+퟇ ퟋ+퟼ ﬀ+﬇ ﬓ+﬘ יִ/ﬞ.ײַ/﬩ שׁ/﬷ טּ/﬽ מּ/﬿ נּ/﭂ ףּ/﭅ צּ/ﭐ+﮲ ﯓ+﴾ ﵐ+﶐ ﶒ+﷈ ﷰ+﷼ ︀.︐ ︓*︔ ︠.︰ ︳,︵ ﹍,﹐'﹑ ﹒(﹓ ﹔'﹕*﹖ ﹰ+﹵ ﹶ+﻽ \\uFEFF-＀ ＇(（ ，'－ ．(／ ０)：*；'＜ Ａ+［ ＿,｀ ａ+｛ ｦ1ﾞ.ﾠ+﾿ ￂ+￈ ￊ+￐ ￒ+￘ ￚ+￝ ￹-￼ ￿ \`,Lt="𐀀+𐀌 𐀍+𐀧 𐀨+𐀻 𐀼+𐀾 𐀿+𐁎 𐁐+𐁞 𐂀+𐃻 𐅀+𐅵 𐇽.𐇾 𐊀+𐊝 𐊠+𐋑 𐋠.𐋡 𐌀+𐌠 𐌭+𐍋 𐍐+𐍶.𐍻 𐎀+𐎞 𐎠+𐏄 𐏈+𐏐 𐏑+𐏖 𐐀+𐒞 𐒠)𐒪 𐒰+𐓔 𐓘+𐓼 𐔀+𐔨 𐔰+𐕤 𐕰+𐕻 𐕼+𐖋 𐖌+𐖓 𐖔+𐖖 𐖗+𐖢 𐖣+𐖲 𐖳+𐖺 𐖻+𐖽 𐗀+𐗴 𐘀+𐜷 𐝀+𐝖 𐝠+𐝨 𐞀+𐞆 𐞇+𐞱 𐞲+𐞻 𐠀+𐠆 𐠈+𐠉 𐠊+𐠶 𐠷+𐠹 𐠼+𐠽 𐠿+𐡖 𐡠+𐡷 𐢀+𐢟 𐣠+𐣳 𐣴+𐣶 𐤀+𐤖 𐤠+𐤺 𐦀+𐦸 𐦾+𐧀 𐨀+𐨁.𐨄 𐨅.𐨇 𐨌.𐨐+𐨔 𐨕+𐨘 𐨙+𐨶 𐨸.𐨻 𐨿.𐩀 𐩠+𐩽 𐪀+𐪝 𐫀+𐫈 𐫉+𐫥.𐫧 𐬀+𐬶 𐭀+𐭖 𐭠+𐭳 𐮀+𐮒 𐰀+𐱉 𐲀+𐲳 𐳀+𐳳 𐴀+𐴤.𐴨 𐴰)𐴺 𐵀)𐵊+𐵦 𐵩.𐵮 𐵯+𐶆 𐺀+𐺪 𐺫.𐺭 𐺰+𐺲 𐻂+𐻅 𐻼.𐼀+𐼝 𐼧+𐼨 𐼰+𐽆.𐽑 𐽰+𐾂.𐾆 𐾰+𐿅 𐿠+𐿷 𑀀.𑀃+𑀸.𑁇 𑁦)𑁰.𑁱+𑁳.𑁵+𑁶 𑁿.𑂃+𑂰.𑂻 𑂽)𑂾 𑃂.𑃃 𑃍)𑃎 𑃐+𑃩 𑃰)𑃺 𑄀.𑄃+𑄧.𑄵 𑄶)𑅀 𑅄+𑅅.𑅇+𑅈 𑅐+𑅳.𑅴 𑅶+𑅷 𑆀.𑆃+𑆳.𑇁+𑇅 𑇉.𑇍 𑇎.𑇐)𑇚+𑇛 𑇜+𑇝 𑈀+𑈒 𑈓+𑈬.𑈸 𑈾.𑈿+𑉁.𑉂 𑊀+𑊇 𑊈+𑊉 𑊊+𑊎 𑊏+𑊞 𑊟+𑊩 𑊰+𑋟.𑋫 𑋰)𑋺 𑌀.𑌄 𑌅+𑌍 𑌏+𑌑 𑌓+𑌩 𑌪+𑌱 𑌲+𑌴 𑌵+𑌺 𑌻.𑌽+𑌾.𑍅 𑍇.𑍉 𑍋.𑍎 𑍐+𑍑 𑍗.𑍘 𑍝+𑍢.𑍤 𑍦.𑍭 𑍰.𑍵 𑎀+𑎊 𑎋+𑎌 𑎎+𑎏 𑎐+𑎶 𑎷+𑎸.𑏁 𑏂.𑏃 𑏅.𑏆 𑏇.𑏋 𑏌.𑏑+𑏒.𑏓+𑏔 𑏡.𑏣 𑐀+𑐵.𑑇+𑑋 𑑐)𑑚 𑑞.𑑟+𑑢 𑒀+𑒰.𑓄+𑓆 𑓇+𑓈 𑓐)𑓚 𑖀+𑖯.𑖶 𑖸.𑗁 𑗘+𑗜.𑗞 𑘀+𑘰.𑙁 𑙄+𑙅 𑙐)𑙚 𑚀+𑚫.𑚸+𑚹 𑛀)𑛊 𑛐)𑛤 𑜝.𑜬 𑜰)𑜺 𑠀+𑠬.𑠻 𑢠+𑣠)𑣪 𑣿+𑤇 𑤉+𑤊 𑤌+𑤔 𑤕+𑤗 𑤘+𑤰.𑤶 𑤷.𑤹 𑤻.𑤿+𑥀.𑥁+𑥂.𑥄 𑥐)𑥚 𑦠+𑦨 𑦪+𑧑.𑧘 𑧚.𑧡+𑧢 𑧣+𑧤.𑧥 𑨀+𑨁.𑨋+𑨳.𑨺+𑨻.𑨿 𑩇.𑩈 𑩐+𑩑.𑩜+𑪊.𑪚 𑪝+𑪞 𑪰+𑫹 𑯀+𑯡 𑯰)𑯺 𑰀+𑰉 𑰊+𑰯.𑰷 𑰸.𑱀+𑱁 𑱐)𑱚 𑱲+𑲐 𑲒.𑲨 𑲩.𑲷 𑴀+𑴇 𑴈+𑴊 𑴋+𑴱.𑴷 𑴺.𑴻 𑴼.𑴾 𑴿.𑵆+𑵇.𑵈 𑵐)𑵚 𑵠+𑵦 𑵧+𑵩 𑵪+𑶊.𑶏 𑶐.𑶒 𑶓.𑶘+𑶙 𑶠)𑶪 𑻠+𑻳.𑻷 𑼀.𑼂+𑼃.𑼄+𑼑 𑼒+𑼴.𑼻 𑼾.𑽃 𑽐)𑽚.𑽛 𑾰+𑾱 𒀀+𒎚 𒐀+𒑯 𒒀+𒕄 𒾐+𒿱 𓀀+𓐰-𓑀.𓑁+𓑇.𓑖 𓑠+𔏻 𔐀+𔙇 𖄀+𖄞.𖄰)𖄺 𖠀+𖨹 𖩀+𖩟 𖩠)𖩪 𖩰+𖪿 𖫀)𖫊 𖫐+𖫮 𖫰.𖫵 𖬀+𖬰.𖬷 𖭀+𖭄 𖭐)𖭚 𖭣+𖭸 𖭽+𖮐 𖵀+𖵭 𖵰)𖵺 𖹀+𖺀 𖼀+𖽋 𖽏.𖽐+𖽑.𖾈 𖾏.𖾓+𖾠 𖿠+𖿢 𖿣+𖿤.𖿥 𖿰.𖿲 𚿰1𚿴 𚿵1𚿼 𚿽1𚿿 𛀀1𛀁 𛄠1𛄣 𛅕1𛅖 𛅤1𛅨 𛰀+𛱫 𛱰+𛱽 𛲀+𛲉 𛲐+𛲚 𛲝.𛲟 𛲠-𛲤 𜳰)𜳺 𜼀.𜼮 𜼰.𜽇 𝅥.𝅪 𝅭.𝅳-𝅻.𝆃 𝆅.𝆌 𝆪.𝆮 𝉂.𝉅 𝐀+𝑕 𝑖+𝒝 𝒞+𝒠 𝒢+𝒣 𝒥+𝒧 𝒩+𝒭 𝒮+𝒺 𝒻+𝒼 𝒽+𝓄 𝓅+𝔆 𝔇+𝔋 𝔍+𝔕 𝔖+𝔝 𝔞+𝔺 𝔻+𝔿 𝕀+𝕅 𝕆+𝕇 𝕊+𝕑 𝕒+𝚦 𝚨+𝛁 𝛂+𝛛 𝛜+𝛻 𝛼+𝜕 𝜖+𝜵 𝜶+𝝏 𝝐+𝝯 𝝰+𝞉 𝞊+𝞩 𝞪+𝟃 𝟄+𝟌 𝟎)𝠀 𝨀.𝨷 𝨻.𝩭 𝩵.𝩶 𝪄.𝪅 𝪛.𝪠 𝪡.𝪰 𝼀+𝼟 𝼥+𝼫 𞀀.𞀇 𞀈.𞀙 𞀛.𞀢 𞀣.𞀥 𞀦.𞀫 𞀰+𞁮 𞂏.𞂐 𞄀+𞄭 𞄰.𞄷+𞄾 𞅀)𞅊 𞅎+𞅏 𞊐+𞊮.𞊯 𞋀+𞋬.𞋰)𞋺 𞓐+𞓬.𞓰)𞓺 𞗐+𞗮.𞗰+𞗱)𞗻 𞟠+𞟧 𞟨+𞟬 𞟭+𞟯 𞟰+𞟿 𞠀+𞣅 𞣐.𞣗 𞤀+𞥄.𞥋+𞥌 𞥐)𞥚 𞸀+𞸄 𞸅+𞸠 𞸡+𞸣 𞸤+𞸥 𞸧+𞸨 𞸩+𞸳 𞸴+𞸸 𞸹+𞸺 𞸻+𞸼 𞹂+𞹃 𞹇+𞹈 𞹉+𞹊 𞹋+𞹌 𞹍+𞹐 𞹑+𞹓 𞹔+𞹕 𞹗+𞹘 𞹙+𞹚 𞹛+𞹜 𞹝+𞹞 𞹟+𞹠 𞹡+𞹣 𞹤+𞹥 𞹧+𞹫 𞹬+𞹳 𞹴+𞹸 𞹹+𞹽 𞹾+𞹿 𞺀+𞺊 𞺋+𞺜 𞺡+𞺤 𞺥+𞺪 𞺫+𞺼 🄰+🅊 🅐+🅪 🅰+🆊 🇦2🈀 🏻.🐀 🯰)🯺 󠀁-󠀂 󠀠.󠂀 󠄀.󠇰 ";function vt(s){let t=s<=65535?2:3,r=t==2?Mt:Lt;return ze(r,s,t,0,r.length/t-1)-32}d(vt,"searchForProperty");function ze(s,t,r,n,i){if(i<n)return 0;let o=n+~~((i-n)/2),a=s.codePointAt(r*o),u=s.codePointAt(r*(o+1)),l=isNaN(u)?1/0:u;return t<a?ze(s,t,r,n,o-1):t>=l?ze(s,t,r,o+1,i):s.charCodeAt(r*(o+1)-1)}d(ze,"_searchForProperty");function D(s,t){let r=Yt(s,t);if(r.length==0)return[];let n=[];for(let i=0;i<r.length-1;i++){let o=r[i],a=r[i+1],u=new ve(s,o,a);Xt(u.text,t)?n.push(u):i==r.length-2&&(u=new ve(s,a,a),n.push(u))}return n}d(D,"default_");var Xe=class Xe{constructor(t,r,n){this._source=t,this.start=r,this.end=n}get text(){return this._source.substring(this.start,this.end)}get length(){return this.end-this.start}};d(Xe,"LazySpan");var ve=Xe,J=class J{constructor(t,r,n,i,o,a){this.lookbehind=19;this.left=19;this.right=19;this.text=t,this.options=r,arguments.length==3?this.lookahead=this.wordbreakPropertyAt(n):(this.lookbehind=n,this.left=i,this.right=o,this.lookahead=a)}next(t){let r=this.wordbreakPropertyAt(t);return new J(this.text,this.options,this.left,this.right,this.lookahead,r)}ignoringRight(t){let r=this.wordbreakPropertyAt(t);return new J(this.text,this.options,this.lookbehind,this.left,this.lookahead,r)}ignoringLookahead(t){let r=this.wordbreakPropertyAt(t);return new J(this.text,this.options,this.lookbehind,this.left,this.right,r)}wordbreakPropertyAt(t){return t<0?19:t>=this.text.length?20:wt(this.text[t])?je(this.text[t]+this.text[t+1]):je(this.text[t],this.options)}match(t,r,n,i){var a,u,l,c;let o=(a=t==null?void 0:t.includes(this.lookbehind))!=null?a:!0;return o=o&&((u=r==null?void 0:r.includes(this.left))!=null?u:!0),o=o&&((l=n==null?void 0:n.includes(this.right))!=null?l:!0),o&&((c=i==null?void 0:i.includes(this.lookahead))!=null?c:!0)}propertyMatch(t,r,n,i){let o=d(a=>Et(a,this.options),"propMapper");return this.match(t==null?void 0:t.map(o),r==null?void 0:r.map(o),n==null?void 0:n.map(o),i==null?void 0:i.map(o))}};d(J,"BreakerContext");var Ge=J;function Xt(s,t){return!s.split("").map(r=>je(r,t)).every(r=>r===3||r===1||r===2||r===4)}d(Xt,"isNonSpace");function Yt(s,t){if(s.length===0)return[];t&&!t.rules&&(t.rules=[]);let r=[],n,i=0,o=new Ge(s,t,i),a=0;do{if(n=i,i=u(i),o=o.next(i),o.match(null,[19],null,null)){r.push(n);continue}if(o.match(null,null,[20],null)){r.push(n);break}if(o.match(null,[3],[1],null))continue;let l=[2,3,1];if(o.match(null,l,null,null)){r.push(n);continue}if(o.match(null,null,l,null)){r.push(n);continue}if(o.match(null,[4],[4],null))continue;let c=[13,14,16];for(;o.match(null,null,c,null);)[n,i]=[i,u(i)],o=o.ignoringRight(i);if(o.right===20){r.push(n);break}for(;o.match(null,null,null,c);)i=u(i),o=o.ignoringLookahead(i);let p=[11,15],h=[8,6];if(t!=null&&t.rules){let k=!1;for(let M of t.rules)if(k=M.match(o),k){M.breakIfMatch&&r.push(n);break}if(k)continue}if(o.match(null,p,p,null))continue;let g=[10].concat(h);if(o.match(null,p,g,p)||o.match(p,g,p,null)||o.match(null,[15],[6],null)||o.match(null,[15],[5],[15])||o.match([15],[5],[15],null)||o.match(null,[9],[9],null)||o.match(null,p,[9],null)||o.match(null,[9],p,null))continue;let m=[7].concat(h);if(o.match([9],m,[9],null)||o.match(null,[9],m,[9])||o.match(null,[17],[17],null))continue;let x=[17,9].concat(p);if(!o.match(null,x,[12],null)&&!o.match(null,[12],[12],null)&&!o.match(null,[12],x,null)){if(o.right===18){if(a+=1,a%2==1)continue}else a=0;r.push(n)}}while(n<s.length);return r;function u(l){return l>=s.length?s.length:wt(s[l])?l+2:l+1}}d(Yt,"findBoundaries");function wt(s){let t=s.charCodeAt(0);return t>=55296&&t<=56319}d(wt,"isStartOfSurrogatePair");function je(s,t){if(t!=null&&t.propertyMapping){let n=t.propertyMapping(s);if(n)return Et(n,t)}let r=s.codePointAt(0);return vt(r)}d(je,"property");function Et(s,t){var i,o;let r=d(a=>a.toLowerCase()==s.toLowerCase(),"matcher"),n=(o=(i=t==null?void 0:t.customProperties)==null?void 0:i.findIndex(r))!=null?o:-1;return n!=-1?-n-1:kt.findIndex(r)}d(Et,"propertyVal");O();var It=12,_=class _{constructor(t,r,n){this.root=t,this.prefix=r,this.totalWeight=n}child(t){if(t=="")return this;let r=t.split(""),n=this;for(;r.length>0&&n;){let i=r.shift();n=n._child(i)}return n}_child(t){let r=this.root,n=this.totalWeight,i=this.prefix+t;if(r.type=="internal"){let o=r.children[t];return o?new _(o,i,n):void 0}else return r.entries.filter(function(a){return a.key.indexOf(i)==0}).length?new _(r,i,n):void 0}*children(){let t=this.root,r=this.totalWeight;if(t.type=="internal"){for(let n of t.values){let i=t.children[n];if(q(n))if(i.type=="internal"){let o=i;for(let a of o.values){let u=this.prefix+n+a;yield{char:n+a,traversal:function(){return new _(o.children[a],u,r)}}}}else{let o=i.entries[0].key;n=n+o[this.prefix.length+1];let a=this.prefix+n;yield{char:n,traversal:function(){return new _(i,a,r)}}}else{if(Me(n))continue;if(n){let o=this.prefix+n;yield{char:n,traversal:function(){return new _(i,o,r)}}}else continue}}return}else{let n=this.prefix,i=t.entries.filter(function(o){return o.key!=n&&n.length<o.key.length});for(let{key:o}of i){let a=o[n.length];q(a)&&(a=a+o[n.length+1]),yield{char:a,traversal:function(){return new _(t,n+a,r)}}}return}}get entries(){let t=d(r=>({text:r.content,p:r.weight/this.totalWeight}),"entryMapper");if(this.root.type=="leaf"){let r=this.prefix;return this.root.entries.filter(function(i){return i.key==r}).map(t)}else{let r=this.root.children[R];return r&&r.type=="leaf"?r.entries.map(t):[]}}get p(){return this.root.weight/this.totalWeight}};d(_,"Traversal");var Ye=_,Je=class Je{constructor(t,r={}){this.languageUsesCasing=r.languageUsesCasing,this.applyCasing=r.applyCasing,this._trie=new $e(t.root,t.totalWeight,r.searchTermToKey||$t),this.breakWords=r.wordBreaker||D,this.punctuation=r.punctuation}configure(t){var r;return this.configuration={leftContextCodePoints:t.maxLeftContextCodePoints,rightContextCodePoints:(r=t.maxRightContextCodePoints)!=null?r:0}}toKey(t){return this._trie.toKey(t)}predict(t,r){if(!t.insert&&!r.left&&!r.right&&r.startOfBuffer&&r.endOfBuffer)return a(this._trie.firstN(It).map(({text:u,p:l})=>({transform:{insert:u,deleteLeft:0},displayAs:u,p:l})));let n=S(t,r),i=t.deleteLeft-t.insert.kmwLength(),o=ue(this.breakWords,n);return a(this._trie.lookup(o).map(({text:u,p:l})=>B({insert:u,deleteLeft:i+o.kmwLength()},l)));function a(u){let l=[];for(let c of u)l.push({sample:c,p:c.p});return l}}get wordbreaker(){return this.breakWords}traverseFromRoot(){return this._trie.traverseFromRoot()}};d(Je,"TrieModel");var pe=Je,Ze=class Ze{constructor(t,r,n){this.root=t,this.toKey=n,this.totalWeight=r}traverseFromRoot(){return new Ye(this.root,"",this.totalWeight)}lookup(t){let r=this.toKey(t),n=this.traverseFromRoot().child(r);if(!n)return[];let i=n.entries,o={};for(let l of i)o[l.text]=l.text;let u=Pt(n).filter(l=>!o[l.text]);return i.concat(u)}firstN(t){return Pt(this.traverseFromRoot(),t)}};d(Ze,"Trie");var $e=Ze;function Pt(s,t=It){let r=new w(function(i,o){return(o?o.p:0)-(i?i.p:0)}),n=[];for(r.enqueue(s);r.count>0;){let i=r.dequeue();if(i.text!==void 0){let o=i;if(n.push(o),n.length>=t)return n}else{let o=i;r.enqueueAll(o.entries);let a=[];for(let u of o.children())a.push(u.traversal());r.enqueueAll(a)}}return n}d(Pt,"getSortedResults");function $t(s){return s.normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").toLowerCase()}d($t,"defaultSearchTermToKey");var rt=class rt{constructor(t){t=t||{},this._futureSuggestions=t.futureSuggestions?t.futureSuggestions.slice():[],t.punctuation&&(this.punctuation=t.punctuation),this.toKey=t.toKey,this.wordbreaker=t.wordbreaker,this.applyCasing=t.applyCasing,this.languageUsesCasing=t.languageUsesCasing}configure(t){return this.configuration={leftContextCodePoints:t.maxLeftContextCodePoints,rightContextCodePoints:t.maxRightContextCodePoints},this.configuration}predict(t,r,n){let i=d(function(a){let u=[];for(let l of a)u.push({sample:l,p:l.p!==void 0?l.p:1});return u},"makeUniformDistribution");if(n)return i(n);let o=this._futureSuggestions.shift();return o?i(o):[]}};d(rt,"DummyModel");var tt=rt,At=tt;var Se={};Ue(Se,{ClassicalDistanceCalculation:()=>H,ContextTracker:()=>Ce,ExecutionBucket:()=>de,ExecutionSpan:()=>z,ExecutionTimer:()=>he,QUEUE_NODE_COMPARATOR:()=>Pe,STANDARD_TIME_BETWEEN_DEFERS:()=>Ee,SearchNode:()=>Ie,SearchResult:()=>fe,SearchSpace:()=>P,TrackedContextState:()=>V,TrackedContextSuggestion:()=>ct,TrackedContextToken:()=>j,getEditPathLastMatch:()=>Dt,tokenizeTransform:()=>Ae,tokenizeTransformDistribution:()=>ut});var b=class b{constructor(t){this.diagonalWidth=2;this.inputSequence=[];this.matchSequence=[];if(t){let r=t.resolvedDistances.length;this.resolvedDistances=Array(r);for(let n=0;n<r;n++)this.resolvedDistances[n]=t.resolvedDistances[n].slice(0);this.inputSequence=t.inputSequence.slice(0),this.matchSequence=t.matchSequence.slice(0),this.diagonalWidth=t.diagonalWidth}else this.resolvedDistances=[]}getTrueIndex(t,r,n){let i={row:t,col:r-t+n,sparse:!1};return(i.col<0||i.col>2*n)&&(i.sparse=!0),i}getCostAt(t,r,n=this.diagonalWidth){if(t<0||r<0)return t==-1&&r>=-1?r+1:r==-1&&t>=-1?t+1:Number.MAX_VALUE;let i=this.getTrueIndex(t,r,n);return i.sparse?Number.MAX_VALUE:this.resolvedDistances[i.row][i.col]}getFinalCost(){let t=this,r=t.getHeuristicFinalCost();for(;r>t.diagonalWidth;)t=t.increaseMaxDistance(),r=t.getHeuristicFinalCost();return r}getHeuristicFinalCost(){return this.getCostAt(this.inputSequence.length-1,this.matchSequence.length-1)}hasFinalCostWithin(t){let r=this,n=r.getHeuristicFinalCost(),i=this.diagonalWidth;do{if(n<=t)return!0;if(i<t)r=r.increaseMaxDistance(),i++,n=r.getHeuristicFinalCost();else break}while(!0);return!1}editPath(t=this.inputSequence.length-1,r=this.matchSequence.length-1){let n=this.getCostAt(t,r),i=null,o=null,a=this.getCostAt(t,r-1),u=this.getCostAt(t-1,r),l=this.getCostAt(t-1,r-1),[c,p]=b.getTransposeParent(this,t,r);if(c>=0&&p>=0){let h=1;if(i=["transpose-start"],c!=t-1){let g=t-c-1;i=i.concat(Array(g).fill("transpose-delete")),h+=g}else{let g=r-p-1;i=i.concat(Array(g).fill("transpose-insert")),h+=g}i.push("transpose-end"),this.getCostAt(c-1,p-1)!=n-h&&(i=null),o=[c-1,p-1]}return i||(a==n-1?(i=["insert"],o=[t,r-1]):l==n-1?(i=["substitute"],o=[t-1,r-1]):u==n-1?(i=["delete"],o=[t-1,r]):(i=["match"],o=[t-1,r-1])),o[0]>=0&&o[1]>=0?this.editPath(o[0],o[1]).concat(i):o[0]>-1?Array(o[0]+1).fill("delete").concat(i):o[1]>-1?Array(o[1]+1).fill("insert").concat(i):i}static getTransposeParent(t,r,n){if(r<0||n<0||t.inputSequence[r].key==t.matchSequence[n].key)return[-1,-1];let i=-1;for(let a=r-1;a>=0;a--)if(t.inputSequence[a].key==t.matchSequence[n].key){i=a;break}let o=-1;for(let a=n-1;a>=0;a--)if(t.matchSequence[a].key==t.inputSequence[r].key){o=a;break}return[i,o]}static initialCostAt(t,r,n,i,o){var a=t.inputSequence[r].key==t.matchSequence[n].key?0:1,u=t.getCostAt(r-1,n-1)+a,l=i||t.getCostAt(r,n-1)+1,c=o||t.getCostAt(r-1,n)+1,p=Number.MAX_VALUE;if(r>0&&n>0){let[h,g]=b.getTransposeParent(t,r,n);p=t.getCostAt(h-1,g-1)+(r-h-1)+1+(n-g-1)}return Math.min(u,c,l,p)}getSubset(t,r){let n=new b(this);if(t>this.inputSequence.length||r>this.matchSequence.length)throw"Invalid dimensions specified for trim operation";n.inputSequence.splice(t),n.matchSequence.splice(r),n.resolvedDistances.splice(t);let i=this.getTrueIndex(t-1,r-1,this.diagonalWidth);for(let o=i.col;o<=2*this.diagonalWidth;o++){let a=i.row-(o-i.col);if(a<0)break;if(o<0)n.resolvedDistances[a]=Array(2*n.diagonalWidth+1).fill(Number.MAX_VALUE);else{let u=2*this.diagonalWidth-o,l=n.resolvedDistances[a].splice(0,o+1),c=Array(u).fill(Number.MAX_VALUE);n.resolvedDistances[a]=l.concat(c)}}return n}static forDiagonalOfAxis(t,r,n,i){let o=n-r<t?n-r+t:2*t,a=r-t,u=a<0?0:a;for(let l=u-a;l<=o;l++)i(a+l,l)}addInputChar(t){let r=new b(this),n=r.inputSequence.length;r.inputSequence.push(t);let i=Array(2*r.diagonalWidth+1).fill(Number.MAX_VALUE);return r.resolvedDistances[n]=i,r.matchSequence.length==0||b.forDiagonalOfAxis(r.diagonalWidth,n,r.matchSequence.length-1,function(o,a){i[a]=b.initialCostAt(r,n,o)}),r}addMatchChar(t){let r=new b(this),n=r.matchSequence.length;return r.matchSequence.push(t),r.inputSequence.length==0||b.forDiagonalOfAxis(r.diagonalWidth,n,r.inputSequence.length-1,function(i,o){var a=r.resolvedDistances[i];a[2*r.diagonalWidth-o]=b.initialCostAt(r,i,n)}),r}increaseMaxDistance(){let t=new b(this);if(t.diagonalWidth++,t.inputSequence.length<1||t.matchSequence.length<1)return t;function r(i,o,a,u){let l=2*(t.diagonalWidth-1),c=a.length-1;l=l<c-i?l:c-i;for(let p=0;p<=l;p++)o==a[i+p].key&&u(i+p,p)}d(r,"forPossibleTranspositionsInDiagonal");for(let i=0;i<t.inputSequence.length;i++){let o=Number.MAX_VALUE,a=i-t.diagonalWidth;if(a>=0){let l=a==0?i+2:Number.MAX_VALUE;o=b.initialCostAt(t,i,a,l,void 0);let c=o;if(a<t.matchSequence.length-1){b.propagateUpdateFrom(t,i,a+1,c+1,0);let p=i+2;if(i+2<this.inputSequence.length){let h=t.inputSequence[i+1].key;r(a+3,h,t.matchSequence,function(g,m){b.propagateUpdateFrom(t,p,g,c+m+2,m)})}}}let u=Number.MAX_VALUE;if(a=i+t.diagonalWidth,a<t.matchSequence.length){let l=i==0?a+2:Number.MAX_VALUE;var n=t.getCostAt(i,a-1,this.diagonalWidth)+1;u=b.initialCostAt(t,i,a,n,l);let c=u;if(i<t.inputSequence.length-1){b.propagateUpdateFrom(t,i+1,a,c+1,2*this.diagonalWidth);let p=a+2;if(a+2<this.matchSequence.length){let h=t.matchSequence[i+1].key;r(i+3,h,t.inputSequence,function(g,m){let x=2*(t.diagonalWidth-1)-m;b.propagateUpdateFrom(t,g,p,c+m+2,x)})}}}t.resolvedDistances[i]=[o].concat(t.resolvedDistances[i],u)}return t}static propagateUpdateFrom(t,r,n,i,o){if(i<t.resolvedDistances[r][o])t.resolvedDistances[r][o]=i;else return;let a=r<t.inputSequence.length-1,u=n<t.matchSequence.length-1;if(o<2*(t.diagonalWidth-1)&&u){let l=i+1;this.propagateUpdateFrom(t,r,n+1,l,o+1)}if(o>0&&a){let l=i+1;this.propagateUpdateFrom(t,r+1,n,l,o-1)}if(a&&u){let l=i+(t.inputSequence[r+1].key==t.matchSequence[n+1].key?0:1);this.propagateUpdateFrom(t,r+1,n+1,l,o);let c=-1;for(let h=r+2;h<t.inputSequence.length;h++)if(t.inputSequence[h].key==t.matchSequence[n+1].key){c=h;break}let p=-1;for(let h=n+2;h<t.matchSequence.length;h++)if(t.matchSequence[h].key==t.inputSequence[r+1].key){p=h;break}if(c>0&&p>0){let h=i+(c-r-2)+1+(p-n-2);this.propagateUpdateFrom(t,c,p,h,t.diagonalWidth-1+p-c)}}}get mapKey(){let t=this.inputSequence.map(n=>n.key).join(""),r=this.matchSequence.map(n=>n.key).join("");return t+R+r+R+this.diagonalWidth}get lastInputEntry(){return this.inputSequence[this.inputSequence.length-1]}get lastMatchEntry(){return this.matchSequence[this.matchSequence.length-1]}static computeDistance(t,r,n=1){let i=new b;n=n||1,i.diagonalWidth=n;for(let o=0;o<t.length;o++)i=i.addInputChar(t[o]);for(let o=0;o<r.length;o++)i=i.addMatchChar(r[o]);return i}};d(b,"ClassicalDistanceCalculation");var H=b;var Jt=1,Nt=5,Ee=5,nt=class nt{constructor(t){this.timeSpent=0;this.eventCount=0;this.timeSquared=0;this.nearOutliers=[];this.outliers=[];this.preventOutliers=!1;this.preventOutliers=!!t}add(t){if(t<0)throw new Error("time may not be negative");this.eventCount++,this.timeSpent+=t,this.timeSquared+=t*t,t>=Jt&&(this.nearOutliers.length<Nt||this.nearOutliers[Nt-1]<t)&&(this.nearOutliers.push(t),this.nearOutliers.sort((r,n)=>n-r)),this.checkForOutlier()}checkForOutlier(){if(this.preventOutliers||this.eventCount<4||this.nearOutliers.length==0)return;let t=this.nearOutliers[0];this.timeSpent-=t,this.timeSquared-=t*t,this.eventCount--;let r=this.average,n=t-r,i=this.variance,o=n*n/i;o>=49||this.eventCount>=8&&o>=9?(this.nearOutliers.shift(),this.outliers.push(t)):(this.timeSpent+=t,this.timeSquared+=t*t,this.eventCount++)}get average(){return this.timeSpent/this.eventCount}get variance(){let t=this.eventCount;return t<=1?NaN:this.timeSquared/t-this.timeSpent*this.timeSpent/(t*t)}get outlierTime(){let t=0;for(let r=0;r<this.outliers.length;r++)t+=this.outliers[r];return t}};d(nt,"ExecutionBucket");var de=nt,it=class it{constructor(t,r){this.bucket=t,this.finalizer=r,this.start=performance.now()}end(){var t,r;this.finish=performance.now(),(t=this.bucket)==null||t.add(this.duration),(r=this.finalizer)==null||r.call(this)}get duration(){var t;return((t=this.finish)!=null?t:performance.now())-this.start}};d(it,"ExecutionSpan");var z=it,ot=class ot{constructor(t,r){this.buckets={};this.deferBucket=new de(!0);this.activeSpan=null;this.spanSinceLastDefer=null;this.trueStart=performance.now(),this.maxExecutionTime=t,this.maxTrueTime=r,this.spanSinceLastDefer=new z}validateStart(){if(this.activeSpan)throw new Error("illegal state - span-based timer still pending")}getBucket(t){t!=null||(t=-1);let r=this.buckets[t];return r||(r=this.buckets[t]=new de),r}get executionTime(){let t=Object.values(this.buckets),r=0;for(let n of t)r+=n.timeSpent;return r}get deferredTime(){let t=Object.values(this.buckets),r=0;for(let n of t)r+=n.outlierTime;return r+=this.deferBucket.timeSpent,r}time(t,r){this.validateStart();let n=performance.now(),i=t(),o=performance.now()-n;return this.getBucket(r).add(o),i}defer(t){return F(this,null,function*(){this.validateStart(),t!=null||(t=0),this.activeSpan=new z(this.deferBucket,()=>this.activeSpan=null),yield We(t),this.activeSpan.end(),this.spanSinceLastDefer=new z})}get timeSinceLastDefer(){return this.spanSinceLastDefer.duration}start(t){this.validateStart();let r=this.getBucket(t);return this.activeSpan=new z(r,()=>{this.activeSpan=null}),this.activeSpan}terminate(){this.maxTrueTime=0}get elapsed(){return performance.now()-this.trueStart>=this.maxTrueTime?!0:this.executionTime>=this.maxExecutionTime}};d(ot,"ExecutionTimer");var he=ot;var Pe=d(function(s,t){return s.currentCost-t.currentCost},"QUEUE_NODE_COMPARATOR");var G=class G{constructor(t,r){this.toKey=d(t=>t,"toKey");if(r=r||(n=>n),t instanceof G){let n=t;this.calculation=n.calculation,this.currentTraversal=n.currentTraversal,this.priorInput=n.priorInput,this.toKey=n.toKey}else this.calculation=new H,this.currentTraversal=t,this.priorInput=[],this.toKey=r}get knownCost(){return this.calculation.getHeuristicFinalCost()}get inputSamplingCost(){if(this._inputCost!==void 0)return this._inputCost;{let t=P.MIN_KEYSTROKE_PROBABILITY;return this._inputCost=this.priorInput.map(r=>r.p>t?r.p:t).reduce((r,n)=>r-Math.log(n),0),this._inputCost}}get currentCost(){return P.EDIT_DISTANCE_COST_SCALE*this.knownCost+this.inputSamplingCost}buildInsertionEdges(){let t=[];for(let r of this.currentTraversal.children()){let n=r.traversal(),i={key:r.char,traversal:n},o=this.calculation.addMatchChar(i),a=new G(this);a.calculation=o,a.priorInput=this.priorInput,a.currentTraversal=n,t.push(a)}return t}buildDeletionEdges(t){let r=[];for(let n of t){if(n.p<t[0].p*Math.exp(-P.EDIT_DISTANCE_COST_SCALE))break;let i=this.calculation,o=n.sample;o.deleteLeft&&(i=i.getSubset(i.inputSequence.length-o.deleteLeft,i.matchSequence.length));let a=this.priorInput.slice(0);a.push(n);for(let l=0;l<o.insert.length;l++){let c=o.insert[l];q(c)&&(l++,c=c+o.insert[l]);let p=this.toKey(c);p&&(i=i.addInputChar({key:p}))}let u=new G(this);u.calculation=i,u.priorInput=a,r.push(u)}return r}buildSubstitutionEdges(t){let r=this.buildDeletionEdges(t),n=[];for(let i of this.currentTraversal.children())for(let o of r){let a=i.traversal(),u={key:i.char,traversal:a},l=o.calculation.addMatchChar(u),c=new G(this);c.calculation=l,c.priorInput=o.priorInput,c.currentTraversal=a,n.push(c)}return n}get pathKey(){let t=this.priorInput.map(n=>"+"+n.sample.insert+"-"+n.sample.deleteLeft).join(""),r=this.calculation.matchSequence.map(n=>n.key).join("");return t+R+r}get resultKey(){return this.calculation.matchSequence.map(t=>t.key).join("")}get isFullReplacement(){return this.knownCost&&this.knownCost==this.priorInput.length}};d(G,"SearchNode");var Ie=G,st=class st{constructor(t,r){this.processed=[];if(typeof t=="number"){this.index=t,this.correctionQueue=new w(Pe,r);return}else this.index=t.index,this.processed=[].concat(t.processed),this.correctionQueue=new w(t.correctionQueue)}increaseMaxEditDistance(){let t=this.correctionQueue.toArray();t.forEach(function(r){r.calculation=r.calculation.increaseMaxDistance()}),this.correctionQueue=new w(Pe,t)}};d(st,"SearchSpaceTier");var me=st,at=class at{constructor(t){this.resultNode=t}get inputSequence(){return this.resultNode.priorInput}get matchSequence(){return this.resultNode.calculation.matchSequence}get matchString(){return this.resultNode.resultKey}get knownCost(){return this.resultNode.knownCost}get inputSamplingCost(){return this.resultNode.inputSamplingCost}get totalCost(){return this.resultNode.currentCost}get finalTraversal(){return this.resultNode.currentTraversal}};d(at,"SearchResult");var fe=at,K=class K{constructor(t){this.tierOrdering=[];this.inputSequence=[];this.minInputCost=[];this.returnedValues={};this.processedEdgeSet={};if(this.buildQueueSpaceComparator(),t instanceof K){this.inputSequence=[].concat(t.inputSequence),this.minInputCost=[].concat(t.minInputCost),this.rootNode=t.rootNode,this.completedPaths=[].concat(t.completedPaths),this.returnedValues=U({},t.returnedValues),this.processedEdgeSet=U({},t.processedEdgeSet),this.tierOrdering=t.tierOrdering.map(i=>new me(i)),this.selectionQueue=new w(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering);return}let r=t;if(r){if(!r.traverseFromRoot)throw"The provided model does not implement the \`traverseFromRoot\` function, which is needed to support robust correction searching."}else throw"The LexicalModel parameter must not be null / undefined.";this.selectionQueue=new w(this.QUEUE_SPACE_COMPARATOR),this.rootNode=new Ie(r.traverseFromRoot(),r.toKey?r.toKey.bind(r):null),this.completedPaths=[this.rootNode];let n=new me(0,[this.rootNode]);this.tierOrdering.push(n),this.selectionQueue.enqueue(n)}buildQueueSpaceComparator(){let t=this;this.QUEUE_SPACE_COMPARATOR=function(r,n){let i=r.correctionQueue.peek(),o=n.correctionQueue.peek(),a=r.index,u=n.index,l=0,c=1;if(u<a){let p=u;u=a,a=p,c=-1}for(let p=a;p<u;p++)l=l+t.minInputCost[p];return i&&o?i.currentCost-o.currentCost+c*l:o?1:-1}}increaseMaxEditDistance(){this.tierOrdering.forEach(function(t){t.increaseMaxEditDistance()})}get correctionsEnabled(){return!!this.inputSequence.find(t=>t.length>1)}addInput(t){this.inputSequence.push(t),this.minInputCost.push(-Math.log(t[0].p));let r=[],n=this.completedPaths.map(function(o){let a=o.buildDeletionEdges(t),u=o.buildSubstitutionEdges(t);return a.concat(u)});this.completedPaths=[],this.returnedValues={},n.forEach(function(o){r=r.concat(o)});let i=new me(this.tierOrdering.length,r);this.tierOrdering.push(i),this.selectionQueue.enqueue(i)}removeLastInput(){}hasNextMatchEntry(){let t=this.selectionQueue.peek();return t?t.correctionQueue.count>0:!1}handleNextNode(){if(!this.hasNextMatchEntry())return{type:"none"};let t=this.selectionQueue.dequeue(),r=t.correctionQueue.dequeue(),n={type:"intermediate",cost:r.currentCost};if(this.processedEdgeSet[r.pathKey])return this.selectionQueue.enqueue(t),n;this.processedEdgeSet[r.pathKey]=!0;let i=!1;if(r.knownCost>2)return n;r.knownCost==2&&(i=!0);let o=0;for(let a=0;a<=t.index;a++)o+=this.minInputCost[a];if(r.currentCost>o+2.5*K.EDIT_DISTANCE_COST_SCALE)return n;if(!i){let a=r.buildInsertionEdges();t.correctionQueue.enqueueAll(a)}if(t.index==this.tierOrdering.length-1)return this.completedPaths.push(r),this.selectionQueue.enqueue(t),{type:"complete",cost:r.currentCost,finalNode:r};{let a=this.tierOrdering[t.index+1],u=a.index,l=[];i||(l=r.buildDeletionEdges(this.inputSequence[u-1]));let c=r.buildSubstitutionEdges(this.inputSequence[u-1]);a.correctionQueue.enqueueAll(l.concat(c)),this.selectionQueue=new w(this.QUEUE_SPACE_COMPARATOR,this.tierOrdering)}return n}getBestMatches(t){return bt(this,null,function*(){let r={},n=Object.values(this.returnedValues);if(n.length>0){let i=new w(Pe,n);for(;i.count>0;){let o=t.time(()=>{let a=i.dequeue();return a.isFullReplacement?null:(r[a.resultKey]=a,new fe(a))},0);if(o){let a=t.start(1);yield o,a.end(),t.timeSinceLastDefer>Ee&&(yield new ke(t.defer()))}}}do{let i=t.time(()=>{var a,u;let o=this.handleNextNode();if(o.type=="none")return null;if(o.type=="complete"){if(o.finalNode.isFullReplacement)return null;let c=o.finalNode;if(((u=(a=r[c.resultKey])==null?void 0:a.currentCost)!=null?u:Number.MAX_VALUE)>c.currentCost)return r[c.resultKey]=c,this.returnedValues[c.resultKey]=c,new fe(c)}return null},2);if(i){let o=t.start(1);yield i,o.end()}t.timeSinceLastDefer>Ee&&(yield new ke(t.defer()))}while(!t.elapsed&&this.hasNextMatchEntry());return null})}};d(K,"SearchSpace"),K.EDIT_DISTANCE_COST_SCALE=5,K.MIN_KEYSTROKE_PROBABILITY=1e-4,K.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL=33;var P=K;var lt=class lt{static isWhitespace(t){let r=/^[\\u0009\\u000A\\u000D\\u0020\\u00a0\\u1680\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u200b\\u2028\\u2029\\u202f\\u205f\\u3000]+$/i;return t.insert.match(r)!=null}static isBackspace(t){return t.insert==""&&t.deleteLeft>0&&!t.deleteRight}static isEmpty(t){return t.insert==""&&t.deleteLeft==0&&!t.deleteRight}};d(lt,"TransformUtils");var E=lt;var Zt={quotesForKeepSuggestion:{open:"“",close:"”"},insertAfterWord:" "};function ge(s){let t=Zt;if(!s.punctuation)return t;let r=s.punctuation,n=r.insertAfterWord;n!==""&&!n&&(n=t.insertAfterWord);let i=r.quotesForKeepSuggestion;i||(i=t.quotesForKeepSuggestion);let o=r.isRTL;return{insertAfterWord:n,quotesForKeepSuggestion:i,isRTL:o}}d(ge,"determinePunctuationFromModel");function Q(s){return t=>{if(s.wordbreaker||!s.wordbreak){let r=s.wordbreaker||D;return $(r,t)}else return s.wordbreak(t)}}d(Q,"determineModelWordbreaker");function Z(s){return t=>s.wordbreaker?le(s.wordbreaker,t):null}d(Z,"determineModelTokenizer");function Rt(s,t){var o;let r=s,i=Q(s)(t);if(!r.languageUsesCasing)throw"Invalid attempt to detect casing: languageUsesCasing is set to false";if(!r.applyCasing)throw"Invalid LMLayer state:  languageUsesCasing is set to true, but no applyCasing function exists";return t.casingForm=="upper"||t.casingForm=="initial"?t.casingForm:r.applyCasing("lower",i)==i?"lower":r.applyCasing("upper",i)==i?i.kmwLength()>1?"upper":"initial":r.applyCasing("initial",i)==i?"initial":(o=t.casingForm)!=null?o:null}d(Rt,"detectCurrentCasing");function Ae(s,t,r){let n=S(r,t),i=s(n).left,o=r.insert,a=[];for(let u=i.length-1;u>=0;u--){let l=i[u],c=l.text.length;if(c<o.length)a.unshift({insert:l.text,deleteLeft:0}),o=o.substring(0,o.length-c);else{a.unshift({insert:o,deleteLeft:r.deleteLeft});break}}return a}d(Ae,"tokenizeTransform");function ut(s,t,r){return r.map(n=>({sample:Ae(s,t,n.sample),p:n.p}))}d(ut,"tokenizeTransformDistribution");function Ot(s,t){let r=[];for(let n=0;n<s.kmwLength();n++){let o={insert:s.kmwCharAt(n),deleteLeft:0,id:t};r.push(o)}return r}d(Ot,"textToCharTransforms");function Dt(s){let t=s.length;return t>=2&&s[t-2]=="substitute"&&s[t-1]=="match"?s.lastIndexOf("match",t-2):s.lastIndexOf("match")}d(Dt,"getEditPathLastMatch");var dt=class dt{};d(dt,"TrackedContextSuggestion");var ct=dt,ht=class ht{constructor(t){this.transformDistributions=[];this.replacements=[];this.activeReplacementId=-1;t&&(Object.assign(this,t),this.replacements=t.replacements.slice())}get currentText(){return this.replacementText===void 0||this.replacementText===null?this.raw:this.replacementText}get replacement(){let t=this.activeReplacementId;return this.replacements.find(function(r){return r.suggestion.id==t})}clearReplacements(){this.activeReplacementId=-1,this.replacements=[]}updateWithBackspace(t,r){let n=Ot(t,r).map(function(i){return[{sample:i,p:1}]});this.raw=t,this.transformDistributions=n,this.clearReplacements()}update(t,r){r=r||(r===""?"":this.raw),(t==null?void 0:t.length)>0&&this.transformDistributions.push(t),this.raw=r,this.clearReplacements()}};d(ht,"TrackedContextToken");var j=ht,Ne=class Ne{constructor(t){this.searchSpace=[];if(t instanceof Ne){let r=t;this.tokens=r.tokens.map(function(i){let o=new j;return Object.assign(o,i),o.replacements=o.replacements.slice(),o.transformDistributions=o.transformDistributions.slice(),o}),this.indexOffset=0;let n=this.model=t.model;this.taggedContext=t.taggedContext,n!=null&&n.traverseFromRoot&&(this.searchSpace=t.searchSpace.map(i=>new P(i)))}else{let r=t;this.tokens=[],this.indexOffset=Number.MIN_SAFE_INTEGER,this.model=r,r&&r.traverseFromRoot&&(this.searchSpace=[new P(r)])}}get head(){return this.tokens[0]}get tail(){return this.tokens[this.tokens.length-1]}popHead(){this.tokens.splice(0,1),this.indexOffset-=1}pushTail(t){this.model&&this.model.traverseFromRoot?this.searchSpace=[new P(this.model)]:this.searchSpace=[],this.tokens.push(t);let r=this;r.searchSpace.length>0&&t.transformDistributions.forEach(n=>r.searchSpace[0].addInput(n))}toRawTokenization(){let t=[];for(let r of this.tokens)r.currentText!==null&&t.push(r.currentText);return t}};d(Ne,"TrackedContextState");var V=Ne,xe=class xe{constructor(t=xe.DEFAULT_ARRAY_SIZE){this.currentHead=0;this.currentTail=0;this.circle=Array(t)}get count(){let t=this.currentHead-this.currentTail;return t<0&&(t=t+this.circle.length),t}get maxCount(){return this.circle.length}get oldest(){if(this.count!=0)return this.item(0)}get newest(){if(this.count!=0)return this.item(this.count-1)}enqueue(t){var r=null;let n=(this.currentHead+1)%this.maxCount;return n==this.currentTail&&(r=this.circle[this.currentTail],this.currentTail=(this.currentTail+1)%this.maxCount),this.circle[this.currentHead]=t,this.currentHead=n,r}dequeue(){if(this.currentTail==this.currentHead)return null;{let t=this.circle[this.currentTail];return this.currentTail=(this.currentTail+1)%this.maxCount,t}}popNewest(){if(this.currentTail==this.currentHead)return null;{let t=this.circle[this.currentHead];return this.currentHead=(this.currentHead-1+this.maxCount)%this.maxCount,t}}item(t){if(t>=this.count)return;let r=(this.currentTail+t)%this.maxCount;return this.circle[r]}};d(xe,"CircularArray"),xe.DEFAULT_ARRAY_SIZE=5;var pt=xe,Te=class Te extends pt{static attemptMatchContext(t,r,n){var k,M;let i=r.toRawTokenization(),a=H.computeDistance(i.map(f=>({key:f})),t.map(f=>({key:f.text})),3).editPath(),u=a.indexOf("match"),l=Dt(a);if(u){for(let f=u+1;f<l;f++)if(a[f]!="match")return null}if(u==0&&l==a.length-1)return{state:r,baseState:r,headTokensRemoved:0,tailTokensAdded:0};let c=r,p,h=0;for(let f=0;f<u;f++)switch(a[f]){case"delete":if(p&&p!="delete")return null;c==r&&(c=new V(c)),c.popHead(),h++;break;case"substitute":break;default:return null}let g=n&&Array.isArray(n);p=void 0;let m,x=0;for(let f=l+1;f<a.length;f++){let C=f==a.length-1;if(!g)return null;let X=f-(l+1),ne=n.map(T=>{let y=T.sample[X];return y?{sample:y,p:T.p}:null}),I=t[f-h],L=g?(k=ne[0])==null?void 0:k.sample:null;if(a[f]!="delete")if(I){if(!(L||a[f]=="insert")&&(I==null?void 0:I.text)!="")return null}else return null;L&&L.insert==""&&L.deleteLeft==0&&!L.deleteRight&&(L=null),C||(m=m&&L?W(m,L):L!=null?L:m);let Kt=L&&E.isBackspace(L);switch(a[f]){case"substitute":C&&(c=new V(c));let T=r.tokens[f];c.tokens[f-h]=T;let y=c.tokens[f-h];Kt?(y.updateWithBackspace(I.text,L.id),C&&(c.tokens.pop(),c.pushTail(y))):(y.update(ne,I.text),C&&((M=c.searchSpace[0])==null||M.addInput(ne))),c!=r&&!C&&(y.replacementText=I.text);break;case"insert":if(p&&p!="substitute"&&p!="match"&&p!="insert")return null;m||(m={insert:"",deleteLeft:0}),c==r&&(c=new V(c));let A=new j;if(A.raw=I.text,L)A.transformDistributions=ne?[ne]:[];else if(I.text)return null;A.isWhitespace=I.isWhitespace,c.pushTail(A),x++;break;case"match":if(p=="substitute"&&t[t.length-1].text=="")continue;case"delete":for(let v=f+1;v<a.length;v++)if(a[v]!="delete")return null;c==r&&(c=new V(c)),c.tokens.pop();break;default:return null}p=a[f]}return{state:c,baseState:r,preservationTransform:m,headTokensRemoved:h,tailTokensAdded:x}}static modelContextState(t,r){let n=t.map(function(o){let a=new j;return a.raw=o.text,o.isWhitespace&&(a.isWhitespace=!0),a.raw?a.transformDistributions=Ot(a.raw).map(function(u){return[{sample:u,p:1}]}):a.transformDistributions=[],a}),i=new V(r);for(;n.length>0;)n.length==1&&n[0].updateWithBackspace(n[0].raw,null),i.pushTail(n.splice(0,1)[0]);if(i.tokens.length==0){let o=new j;o.raw="",i.pushTail(o)}return i}analyzeState(t,r,n,i){if(!t.traverseFromRoot)throw"This lexical model does not provide adequate data for correction algorithms and context reuse";let o=Z(t),a=n==null?void 0:n[0],u=0,l=null;a&&(u=Ae(o,r,a.sample).length,l=ut(o,r,n),r=S(a.sample,r),l=l.filter(h=>h.sample.length==u));let c=o(r);if(c.left.length>0)for(let h=this.count-1;h>=0;h--){let g=this.item(h),m=g.taggedContext;if(m&&n&&n.length>0){if(S(n[0].sample,m).left!=r.left)continue}else if((m==null?void 0:m.left)!=r.left)continue;let x=Te.attemptMatchContext(c.left,this.item(h),l);if(x!=null&&x.state)return this.newest!=x.state&&this.newest!=g&&this.enqueue(g),x.state.taggedContext=r,x.state!=this.item(h)&&this.enqueue(x.state),x}let p=Te.modelContextState(c.left,t);return p.taggedContext=r,this.enqueue(p),{state:p,baseState:null,headTokensRemoved:0,tailTokensAdded:0}}clearCache(){for(;this.count>0;)this.dequeue()}};d(Te,"ContextTracker");var Ce=Te;var er=.66,_t={MAX_SEARCH_THRESHOLD:8,REPLACEMENT_SEARCH_THRESHOLD:4};function ft(s,t){let r=t.matchLevel-s.matchLevel;return r!=0?r:t.totalProb-s.totalProb}d(ft,"tupleDisplayOrderSort");function Ut(s,t,r,n,i){return F(this,null,function*(){let o=Q(t),a=n[0].sample,u=S(a,i),l=[];if(!s){let T,y=E.isWhitespace(a),A=E.isBackspace(a);return y?T=[{sample:a,p:1}]:T=n.map(v=>{let be=v.sample;return E.isWhitespace(be)&&!y||E.isBackspace(be)&&!A?null:v}),T=T.filter(v=>!!v),l=mt(t,T,i),y&&l.forEach(v=>v.preservationTransform=a),{postContextState:null,rawPredictions:l}}let{state:c}=s.analyzeState(t,i,null),p=s.analyzeState(t,i,E.isEmpty(a)?null:n),h=p.state,g=h.searchSpace[0],m=0,x=h.tokens,k=x.length-c.tokens.length;p.preservationTransform?(m=0,i=S(p.preservationTransform,i)):k<0?m=o(u).kmwLength()+a.deleteLeft:m=o(i).kmwLength();let M=x[x.length-1];M.raw==""&&(m=0);let f=M.transformDistributions.length<=1,C,X={};if(!g.correctionsEnabled){let T={sample:{insert:o(u),deleteLeft:m,id:a.id},p:1},y=mt(t,[T],i);return y.forEach(A=>A.preservationTransform=p.preservationTransform),{postContextState:h,rawPredictions:y}}try{for(var ne=yt(g.getBestMatches(r)),I,L,Kt;I=!(L=yield ne.next()).done;I=!1){let T=L.value;let y=T.matchString;if(T.matchSequence.length==0&&T.inputSequence.length!=0||T.matchSequence.length!=0&&T.matchSequence.length==T.knownCost)continue;let A={insert:y,deleteLeft:m,id:a.id},v=T.totalCost;f&&(v*=ee.SINGLE_CHAR_KEY_PROB_EXPONENT);let be={sample:A,p:Math.exp(-v)},ye=mt(t,[be],i);ye.forEach(ie=>ie.preservationTransform=p.preservationTransform),ye.length>0&&C===void 0&&(C=v);let xt=X[T.matchString];if(xt&&(l=l.filter(ie=>!xt.find(Qt=>ie.prediction.sample==Qt.sample))),X[T.matchString]=ye.map(ie=>ie.prediction),l=l.concat(ye),tr(C,T.totalCost,l))break}}catch(L){Kt=[L]}finally{try{I&&(L=ne.return)&&(yield L.call(ne))}finally{if(Kt)throw Kt[0]}}return{postContextState:h,rawPredictions:l}})}d(Ut,"correctAndEnumerate");function tr(s,t,r){if(t>=s+_t.MAX_SEARCH_THRESHOLD)return!0;if(r.length>=ee.MAX_SUGGESTIONS){if(t>=s+_t.REPLACEMENT_SEARCH_THRESHOLD)return!0;if(r.sort(ft),r[ee.MAX_SUGGESTIONS-1].totalProb>Math.exp(-t))return!0}return!1}d(tr,"shouldStopSearchingEarly");function mt(s,t,r){let n=[],i=Q(s);for(let o of t){let a=s.predict(o.sample,r),{sample:u,p:l}=o,c=i(S(o.sample,r)),p=a.map(h=>(u.id!==void 0&&(h.sample.transformId=u.id),{prediction:h,correction:{sample:c,p:l},totalProb:h.p*l,matchLevel:0}));n=n.concat(p)}return n}d(mt,"predictFromCorrections");function Ft(s,t,r){let n=Q(s),i={},o=[];for(let a of t){let u=n(S(a.prediction.sample.transform,r)),l=i[u];l?l.totalProb+=a.totalProb:i[u]=a}for(let a in i){let u=i[a];o.push(u)}return o}d(Ft,"dedupeSuggestions");function Wt(s,t,r,n){let{sample:i,p:o}=n,a=Q(s),u=S(i,r),l=a(u),c=d(f=>s.toKey?s.toKey(f):f,"keyed"),p=d(f=>s.applyCasing?s.applyCasing("lower",f):f,"keyCased"),h=c(l),g=p(l),m;for(let f of t){i.id!==void 0&&(f.prediction.sample.transformId=i.id);let C=a(S(f.prediction.sample.transform,r));c(f.correction.sample)==h?C==l?(f.matchLevel=3,m=Re(s,f.prediction.sample,"keep",Y.noQuotes),m.matchesModel=!0,Object.assign(f.prediction.sample,m),m=f.prediction.sample):p(C)==g?f.matchLevel=2:c(C)==h?f.matchLevel=1:f.matchLevel=0:f.matchLevel=0}if(m||l=="")return;let x=l.kmwLength()-i.insert.kmwLength()+i.deleteLeft,M=B({insert:l,deleteLeft:x},1);M.displayAs=l,m=Re(s,M,"keep"),i.id!==void 0&&(m.transformId=i.id),m.matchesModel=!1,t.unshift({totalProb:m.p,prediction:{sample:m,p:m.p},correction:{sample:l,p:o},matchLevel:3})}d(Wt,"processSimilarity");function qt(s){if(s.length==0)return;let t=s[0].prediction.sample;if(t.tag=="keep"&&t.matchesModel){t.autoAccept=!0;return}else if(s.length==1)return;if(s=s.slice(1),s.length==1){s[0].prediction.sample.autoAccept=!0;return}let r=s[0];if(r.correction.sample.length==0||s.reduce((l,c)=>(l==null?void 0:l.correction.p)>c.correction.p?l:c,null).correction.p>r.correction.p)return;let o=r.matchLevel,a=s.reduce((l,c)=>l+(c.matchLevel==o?c.totalProb:0),0);r.totalProb/a<er||(r.prediction.sample.autoAccept=!0)}d(qt,"predictionAutoSelect");function Bt(s,t,r,n,i){let o=ge(s),a=Z(s),u=t.map(l=>{let c=l.prediction;if(l.preservationTransform){let p=W(l.preservationTransform,c.sample.transform);p.id=c.sample.transformId;let h=c.sample;h.transform=p}return i?_e(U({},c.sample),{p:l.totalProb,"lexical-p":c.p,"correction-p":l.correction.p}):_e(U({},c.sample),{p:l.totalProb})});return u.forEach(l=>{let c=a(r);c&&c.caretSplitsToken?l.transform.insert+=o.insertAfterWord:r.right?o.insertAfterWord!=""&&r.right.indexOf(o.insertAfterWord)!=0&&(l.transform.insert+=o.insertAfterWord):l.transform.insert+=o.insertAfterWord}),u}d(Bt,"finalizeSuggestions");function Re(s,t,r,n=Y.default){let i=Y,o=ge(s),a=i.noQuotes;(r=="keep"||r=="revert")&&(a=i.useQuotes);let u={transform:t.transform,displayAs:i.apply(n,t.displayAs,o,a),tag:r,p:t.p};return t.transformId!==void 0&&(u.transformId=t.transformId),u}d(Re,"toAnnotatedSuggestion");var te=class te{constructor(t,r){this.SUGGESTION_ID_SEED=0;this.testMode=!1;this.verbose=!0;this.lexicalModel=t,t.traverseFromRoot&&(this.contextTracker=new Ce),this.punctuation=ge(t),this.testMode=!!r}predict(t,r){return F(this,null,function*(){var f;let n=this.lexicalModel;(f=this.activeTimer)==null||f.terminate(),t instanceof Array?t.length==0&&t.push({sample:{insert:"",deleteLeft:0},p:1}):t=[{sample:t,p:1}],t.sort(function(C,X){return X.p-C.p});let i=t[0].sample,o=E.isBackspace(i),a=E.isWhitespace(i),u=S(i,r),l=this.wordbreak(u),c=o||a?l:this.wordbreak(r),p=n.languageUsesCasing?Rt(n,u):null,h=P.DEFAULT_ALLOTTED_CORRECTION_TIME_INTERVAL,g=this.activeTimer=new he(this.testMode?Number.MAX_VALUE:h,this.testMode?Number.MAX_VALUE:h*1.5),{postContextState:m,rawPredictions:x}=yield Ut(this.contextTracker,this.lexicalModel,g,t,r);this.activeTimer==g&&(this.activeTimer=null);for(let C of x)p&&p!="lower"&&this.applySuggestionCasing(C.prediction.sample,c,p);let k=Ft(this.lexicalModel,x,r);Wt(this.lexicalModel,k,r,t[0]),k.sort(ft),qt(k);let M=Bt(this.lexicalModel,k.splice(0,te.MAX_SUGGESTIONS),r,i,this.verbose);return M.forEach(C=>{C.id=this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++}),m&&(m.tail.replacements=M.map(function(C){return{suggestion:C,tokenWidth:1}})),M})}applySuggestionCasing(t,r,n){let i=r.kmwLength()-t.transform.deleteLeft;i>0&&(t.transform.deleteLeft+=i,t.transform.insert=r.kmwSubstr(0,i)+t.transform.insert),t.transform.insert=this.lexicalModel.applyCasing(n,t.transform.insert),t.displayAs=this.lexicalModel.applyCasing(n,t.displayAs)}acceptSuggestion(t,r,n){let i=t.transform,o=r.left.kmwSubstr(-i.deleteLeft,i.deleteLeft),a=i.insert.kmwLength(),u={insert:o,deleteLeft:a},l=r;n&&(u=W(u,n),l=S(n,l));let c,p=this.tokenize(l);if(p){let m=p.left[p.left.length-1];c=m&&!m.isWhitespace?m.text:"",c+=p.caretSplitsToken?p.right[0].text:""}else c=this.wordbreak(l);let h=B(u);h.displayAs=c;let g=Re(this.lexicalModel,h,"revert");if(t.transformId!=null&&(g.transformId=-t.transformId),t.id!=null?g.id=-t.id:(g.id=-this.SUGGESTION_ID_SEED,this.SUGGESTION_ID_SEED++),this.contextTracker){let m=this.contextTracker.newest;m||(m=this.contextTracker.analyzeState(this.lexicalModel,r).state),m.tail.activeReplacementId=t.id;let x=S(t.transform,r);this.contextTracker.analyzeState(this.lexicalModel,x)}return g}applyReversion(t,r){return F(this,null,function*(){let n=this,i=d(function(){return F(this,null,function*(){let u=S(t.transform,r),l=yield n.predict({insert:"",deleteLeft:0},u);return l.forEach(function(c){c.transformId=-t.transformId,c.autoAccept=!1}),l})},"fallbackSuggestions");if(!this.contextTracker)return i();let o=!1;for(let u=this.contextTracker.count-1;u>=0;u--)if(this.contextTracker.item(u).tail.activeReplacementId==-t.id){o=!0;break}if(!o)return i();for(;this.contextTracker.newest.tail.activeReplacementId!=-t.id;)this.contextTracker.popNewest();this.contextTracker.newest.tail.activeReplacementId=-1;let a=this.contextTracker.newest.tail.replacements.map(function(u){return u.suggestion});return a.forEach(function(u){u.transformId=-t.transformId,u.autoAccept=!1}),a})}wordbreak(t){return Q(this.lexicalModel)(t)}tokenize(t){return Z(this.lexicalModel)(t)}resetContext(t){var r;(r=this.activeTimer)==null||r.terminate(),this.contextTracker&&(this.contextTracker.clearCache(),this.contextTracker.analyzeState(this.lexicalModel,t,null))}};d(te,"ModelCompositor"),te.MAX_SUGGESTIONS=12,te.SINGLE_CHAR_KEY_PROB_EXPONENT=16;var gt=te,ee=gt;O();var Oe=class Oe{constructor(t={importScripts:null,postMessage:null}){this._testMode=!1;this._postMessage=t.postMessage||postMessage,this._importScripts=t.importScripts||importScripts,this.setupConfigState()}error(t,r){this.cast("error",{log:t,error:r&&r.stack?r.stack:void 0})}onMessage(t){let{message:r}=t.data;if(!r)throw new Error(\`Missing required 'message' property: \${t.data}\`);let n=t.data;if(n.message=="load"){let i=n,o=!1;if(this._currentModelSource&&i.source.type==this._currentModelSource.type&&(i.source.type=="file"&&i.source.file==this._currentModelSource.file||i.source.type=="raw"&&i.source.code==this._currentModelSource.code)&&(o=!0),o){typeof console!="undefined"&&console.warn("Duplicate model load message detected - squashing!");return}else this._currentModelSource=i.source}else n.message=="unload"&&(this._currentModelSource=null);this.state.handleMessage(n)}cast(t,r){let n=this._postMessage;n(U({message:t},r))}loadModel(t){try{let r=t.configure(this._platformCapabilities);r.leftContextCodePoints||(r.leftContextCodePoints=r.leftContextCodeUnits),r.rightContextCodePoints||(r.rightContextCodePoints=r.rightContextCodeUnits),r.leftContextCodePoints||(r.leftContextCodePoints=this._platformCapabilities.maxLeftContextCodePoints),r.rightContextCodePoints||(r.rightContextCodePoints=this._platformCapabilities.maxRightContextCodePoints||0),t.languageUsesCasing&&!t.applyCasing&&(t.applyCasing=Le);let n=this.transitionToReadyState(t);r.wordbreaksAfterSuggestions===void 0&&(r.wordbreaksAfterSuggestions=n.punctuation.insertAfterWord!=""),this.cast("ready",{configuration:r})}catch(r){this.error("loadModel failed!",r)}}loadModelFile(t){try{this._importScripts(t)}catch(r){this.error("Error occurred when attempting to load dictionary",r)}}unloadModel(){this.transitionToLoadingState()}setupConfigState(){this.state={name:"unconfigured",handleMessage:t=>{if(t.message!=="config")throw new Error(\`invalid message; expected 'config' but got \${t.message}\`);this._platformCapabilities=t.capabilities,this._testMode=!!t.testMode,this.transitionToLoadingState()}}}transitionToLoadingState(){let t=this;this.state={name:"modelless",handleMessage:r=>{if(r.message!=="load")throw new Error(\`invalid message; expected 'load' but got \${r.message}\`);if(r.source.type=="file")t.loadModelFile(r.source.file);else{let n=r.source.code;new Function("LMLayerWorker","models","correction","wordBreakers",n)(t,we,Se,ce)}}}}transitionToReadyState(t){let r=new ee(t,this._testMode);return this.state={name:"ready",handleMessage:n=>{switch(n.message){case"predict":var{transform:i,context:l}=n;r.predict(i,l).then(p=>{this.cast("suggestions",{token:n.token,suggestions:p})});break;case"wordbreak":let c=$(t.wordbreaker||D,n.context);this.cast("currentword",{token:n.token,word:c});break;case"unload":this.unloadModel();break;case"accept":var{suggestion:o,context:l,postTransform:a}=n,u=r.acceptSuggestion(o,l,a);this.cast("postaccept",{token:n.token,reversion:u});break;case"revert":var{reversion:u,context:l}=n;r.applyReversion(u,l).then(p=>{this.cast("postrevert",{token:n.token,suggestions:p})});break;case"reset-context":var{context:l}=n;r.resetContext(l);break;default:throw new Error(\`invalid message; expected one of {'predict', 'wordbreak', 'accept', 'revert', 'reset-context', 'unload'} but got \${n.message}\`)}},compositor:r},r}static install(t){let r=new Oe({postMessage:t.postMessage,importScripts:t.importScripts.bind(t)});return t.onmessage=r.onMessage.bind(r),r.self=t,t.LMLayerWorker=r,t.models=we,t.correction=Se,t.wordBreakers=ce,r}};d(Oe,"LMLayerWorker");var re=Oe;typeof self!="undefined"&&"postMessage"in self&&"importScripts"in self?re.install(self):window.LMLayerWorker=re;})();
//# sourceMappingURL=worker-main.min.js.map
`,Vo="";var oc=class oc{static constructInstance(){return new Worker(this.asBlobURI(Xo))}static asBlobURI(n){let t=sl(n);t+=`
`+Vo;let i=new Blob([t],{type:"text/javascript"});return URL.createObjectURL(i)}};a(oc,"DefaultWorker");var ln=oc;var ac=class ac extends V.default{constructor(t,i,l=!1){super();this._mayPredict=!0;this._mayCorrect=!0;this._mayAutoCorrect=!1;this._state="inactive";this.recentTranscriptions=i;let s={maxLeftContextCodePoints:64,maxRightContextCodePoints:l?0:64};if(!t)return;let c;try{c=t==null?void 0:t.constructInstance()}catch(r){console.warn("Web workers are not available: "+(r!=null?r:"").toString()),c=null}c&&(this.lmEngine=new nn(s,c))}get activeModel(){return this.currentModel}get isConfigured(){return!!this.configuration}get state(){return this._state}unloadModel(){this.canEnable&&(this.lmEngine.unloadModel(),delete this.currentModel,delete this.configuration,this._state="inactive",this.emit("statechange","inactive"))}loadModel(t){if(!t)throw new Error("Null reference not allowed.");if(!this.canEnable)return Promise.resolve();let i=t.path?"file":"raw",l=i=="file"?t.path:t.code;return this.currentModel=t,this.mayPredict&&(this._state="active",this.emit("statechange","active")),this.lmEngine.loadModel(l,i).then(s=>{this.configuration=s,this.mayPredict&&(this._state="configured",this.emit("statechange","configured"))}).catch(s=>{let c;s instanceof Error?c=s.message:c=String(s),console.error("Could not load model '"+t.id+"': "+c),this.currentModel=null,this._state="inactive",this.emit("statechange","inactive")})}invalidateContext(t,i){if(!this.currentModel||!this.configuration)return Promise.resolve([]);if(!this.isActive)return Promise.resolve([]);if(this.emit("invalidatesuggestions","context"),t){let l=t.buildTranscriptionFrom(t,null,!1);return this.predict_internal(l,!0,i)}else return Promise.resolve([])}wordbreak(t,i){if(!this.isActive)return null;let l=new xe(N.from(t,!1),this.configuration,i);return this.lmEngine.wordbreak(l)}predict(t,i){return!this.isActive||!this.currentModel||!this.configuration?null:(this.emit("invalidatesuggestions","new"),this.predict_internal(t,!1,i))}applySuggestion(t,i,l){if(!i)throw"Accepting suggestions requires a destination OutputTarget instance.";if(!this.isActive)return null;if(!this.isConfigured)return console.warn("Could not apply suggestion; the corresponding model has been unloaded"),null;let s=this.getPredictionState(t.transformId);if(s){let c=N.from(s.preInput,!1);c.apply(t.transform);let r=c.buildTransformFrom(i);i.apply(r),this.emit("suggestionapplied",i),N.from(s.preInput,!1).apply(s.transform);let d=new xe(s.preInput,this.configuration,l()),u=this.lmEngine.acceptSuggestion(t,d,s.transform);return u=u.then(B=>{let b={transform:s.transform,transformId:-s.token,displayAs:B.displayAs,id:B.id,tag:B.tag};return this.predictFromTarget(i,l()),b}),u}else return console.warn("Could not apply the Suggestion!"),null}applyReversion(t,i){if(!i)throw"Accepting suggestions requires a destination OutputTarget instance.";if(!this.isActive)return null;let l=this.getPredictionState(-t.transformId);if(!l)return console.warn("Could not apply the Suggestion!"),Promise.resolve([]);let s=N.from(l.preInput,!1);s.apply(t.transform);let c=s.buildTransformFrom(i);i.apply(c);let r=this.currentPromise=this.lmEngine.revertSuggestion(t,new xe(l.preInput,this.configuration,null));return r.then(()=>this.currentPromise=this.currentPromise==r?null:this.currentPromise),r}predictFromTarget(t,i){if(!this.isActive||!t)return null;let l=t.buildTranscriptionFrom(t,null,!1);return this.predict(l,i)}predict_internal(t,i,l){if(!this.isActive||!t)return null;let s=new xe(t.preInput,this.configuration,l);this.recordTranscription(t),i&&this.lmEngine.resetContext(s);let c=t.alternates;(!this.mayCorrect||!c||c.length==0)&&(c=[{sample:t.transform,p:1}]);let r=t.transform;var o=this.currentPromise=this.lmEngine.predict(c,s);return o.then(d=>{if(o==this.currentPromise){let u=new Ct(d,r.id);this.emit("suggestionsready",u),this.currentPromise=null}return d})}recordTranscription(t){this.recentTranscriptions.save(t)}getPredictionState(t){return this.recentTranscriptions.get(t)}shutdown(){var t;(t=this.lmEngine)==null||t.shutdown(),this.removeAllListeners()}get isActive(){return this.canEnable?(this.activeModel||!1)&&this._mayPredict:(this._mayPredict=!1,!1)}get canEnable(){return!!this.lmEngine}get mayPredict(){return this._mayPredict}set mayPredict(t){if(!this.canEnable)return;let i=this._mayPredict;if(this._mayPredict=t,i!=t&&this.activeModel){let l=t?"active":"inactive";this._state=l,this.emit("statechange",l),t&&this.isConfigured&&(this._state="configured",this.emit("statechange","configured"))}}get mayCorrect(){return this._mayCorrect}set mayCorrect(t){this._mayCorrect=t}get mayAutoCorrect(){return this._mayAutoCorrect}set mayAutoCorrect(t){this._mayAutoCorrect=t}get wordbreaksAfterSuggestions(){return this.configuration.wordbreaksAfterSuggestions}tryAcceptSuggestion(t){var l;if(!this.isActive)return!1;let i={shouldSwallow:!1};return this.emit("tryaccept",t,i),(l=i.shouldSwallow)!=null?l:!1}tryRevertSuggestion(){return this.isActive&&this.emit("tryrevert"),!1}};a(ac,"LanguageProcessor");var Dn=ac;var Wa=10,gc=class gc{constructor(){this.map=new Map}get(n){let t=this.map.get(n);return t&&this.save(t),t}save(n){let t=n.token>=0?n.token:-n.token;this.map.delete(t),this.map.set(t,n),this.map.size>Wa&&this.map.delete(this.map.keys().next().value)}buildLog(){return[...this.map.entries()].map(([t,i])=>{var l;return`Context state ${t}'s keystroke:
${(l=i.keystroke.inputBreadcrumb)!=null?l:""}`}).join(`
`)}};a(gc,"TranscriptionCache");var On=gc;var Pn=class Pn{constructor(n,t,i){this.contextCache=new On;if(!n)throw new Error("device must be defined");i||(i=Pn.DEFAULT_OPTIONS),this.contextDevice=n,this.kbdProcessor=new _t(n,i),this.lngProcessor=new Dn(t,this.contextCache)}get languageProcessor(){return this.lngProcessor}get keyboardProcessor(){return this.kbdProcessor}get keyboardInterface(){return this.keyboardProcessor.keyboardInterface}get activeKeyboard(){return this.keyboardInterface.activeKeyboard}set activeKeyboard(n){this.keyboardInterface.activeKeyboard=n,this.resetContext()}get activeModel(){return this.languageProcessor.activeModel}processKeyEvent(n,t){let i=n.srcKeyboard&&this.activeKeyboard!=n.srcKeyboard,l=this.activeKeyboard;try{if(i&&(this.keyboardInterface.activeKeyboard=n.srcKeyboard),n.baseTranscriptionToken){let s=this.contextCache.get(n.baseTranscriptionToken);s?(!Zt(s.transform)||!s.preInput.isEqual(N.from(t)))&&t.restoreTo(s.preInput):console.warn(`The base context for the multitap could not be found!

`+this.contextCache.buildLog())}return this._processKeyEvent(n,t)}finally{i&&(this.keyboardInterface.activeKeyboard=l)}}_processKeyEvent(n,t){var b;let i=n.device.formFactor,l=n.isSynthetic;if((i==S.FormFactor.Desktop||!this.activeKeyboard||this.activeKeyboard.usesDesktopLayoutOnDevice(n.device))&&l&&this.keyboardProcessor.selectLayer(n))return new le;if(this.keyboardProcessor.doModifierPress(n,t,!l)&&!l)return new le;if(this.languageProcessor.isActive){if((n.kName=="K_BKSP"||n.Lcode==Q.keyCodes.K_BKSP)&&this.languageProcessor.tryRevertSuggestion())return new le;if((n.kName=="K_SPACE"||n.Lcode==Q.keyCodes.K_SPACE)&&this.languageProcessor.tryAcceptSuggestion("space"))return new le}let s=N.from(t,!0),c=this.keyboardProcessor.layerId,r=this.keyboardProcessor.processKeystroke(n,t);n.kNextLayer&&this.keyboardProcessor.selectLayer(n);let o=Q.isFrameKey(n.kName);Zt((b=r==null?void 0:r.transcription)==null?void 0:b.transform)&&n.kNextLayer&&(o=!0);let d=r!=null;if(d){let I=o?null:this.buildAlternates(r,n,s);r.finalize(this.keyboardProcessor,t,!1),I&&I.length>0&&(r.transcription.alternates=I)}else r=new le,r.transcription=t.buildTranscriptionFrom(t,null,!1),r.triggersDefaultCommand=!0;this.contextCache.save(r.transcription);let u=r.setStore[33]||n.kNextLayer;this.keyboardProcessor.newLayerStore.set(u?this.keyboardProcessor.layerId:""),this.keyboardProcessor.oldLayerStore.set(u?c:"");let B=this.keyboardProcessor.processPostKeystroke(this.contextDevice,t);return B&&B.finalize(this.keyboardProcessor,t,!0),r.predictionPromise=this.languageProcessor.predict(r.transcription,this.keyboardProcessor.layerId),r.triggersDefaultCommand||t.doInputEvent(),d?r:null}buildAlternates(n,t,i){let l;if(this.languageProcessor.isActive&&!n.triggersDefaultCommand){let s=t.keyDistribution,r=new xe(i,xe.ENGINE_RULE_WINDOW,this.keyboardProcessor.layerId).toMock();if(this.languageProcessor.isActive&&s&&t.kbdLayer){let o=Number.MAX_VALUE,d=Et(),u;d.performance&&d.performance.now&&(u=a(function(){return d.performance.now()},"timer"),o=u()+16);let B=Math.exp(-5);s.sort((I,F)=>F.p-I.p),l=[];let b=0;for(let I of s){if(I.p<B){b+=I.p;break}else if(u&&u()>=o)break;let F=N.from(r,!1),h=I.keySpec;if(!h){console.warn("Internal error:  failed to properly filter set of keys for corrections");continue}let y=this.keyboardProcessor.activeKeyboard.constructKeyEvent(h,t.device,this.keyboardProcessor.stateKeys),U=this.keyboardProcessor.processKeystroke(y,F);if(U&&!U.beep&&I.p>0){let x=U.transcription.transform;x.id=n.transcription.token,l.push({sample:x,p:I.p}),b+=I.p}}l.forEach(function(I){I.p/=b})}}return l}resetContext(n){this.keyboardProcessor.resetContext(n),this.languageProcessor.invalidateContext(n,this.keyboardProcessor.layerId)}};a(Pn,"InputProcessor"),Pn.DEFAULT_OPTIONS={baseLayout:"us"};var jn=Pn;var dc=class dc{constructor(n,t,i,l){this.Pelem=n,this.Peventname=t.toLowerCase(),this.Phandler=i,this.PuseCapture=l}equals(n){return this.Pelem==n.Pelem&&this.Peventname==n.Peventname&&this.Phandler==n.Phandler&&this.PuseCapture==n.PuseCapture}};a(dc,"DomEventTracking");var cl=dc,uc=class uc{constructor(){this.domEvents=[]}attachDOMEvent(n,t,i,l){this.detachDOMEvent(n,t,i,l),n.addEventListener(t,i,!!l);var s=new cl(n,t,i,l);this.domEvents.push(s)}detachDOMEvent(n,t,i,l){n.removeEventListener(t,i,l);for(var s=new cl(n,t,i,l),c=0;c<this.domEvents.length;c++)if(this.domEvents[c].equals(s)){this.domEvents.splice(c,1);break}}shutdown(){for(let n of this.domEvents)this.detachDOMEvent(n.Pelem,n.Peventname,n.Phandler,n.PuseCapture)}};a(uc,"DomEventTracker");var Ze=uc;var Bc=class Bc extends V.default{constructor(n){super(),n instanceof V.default?(n.on=this.listenerRegistrationSpy("listeneradded",n,n.on),n.addListener=this.listenerRegistrationSpy("listeneradded",n,n.addListener),n.off=this.listenerRegistrationSpy("listenerremoved",n,n.off),n.removeListener=this.listenerRegistrationSpy("listenerremoved",n,n.off)):(n.addEventListener=this.listenerRegistrationSpy("listeneradded",n,n.addEventListener),n.removeEventListener=this.listenerRegistrationSpy("listenerremoved",n,n.removeEventListener))}listenerRegistrationSpy(n,t,i){return(l,s)=>{let c=i.apply(t,[l,s]);return this.emit(n,l),c}}};a(Bc,"EmitterListenerSpy");var sn=Bc;var Ic=class Ic{constructor(){this.events={};this.currentEvents=[]}addEventListener(n,t){return this._removeEventListener(n,t),this.events[n].push(t),!0}removeEventListener(n,t){return this._removeEventListener(n,t)}_removeEventListener(n,t){typeof this.events[n]=="undefined"&&(this.events[n]=[]);for(var i=0;i<this.events[n].length;i++)if(this.events[n][i]==t)return this.events[n].splice(i,1),!0;return!1}callEvent(n,t){if(typeof this.events[n]=="undefined")return!0;if(this.currentEvents.indexOf(n)!=-1)return!1;this.currentEvents.push(n);for(var i=0;i<this.events[n].length;i++){var l=this.events[n][i],s=!1;try{s=l(t)}catch(c){console.error(c),s=!1}if(s===!1)return this.currentEvents.pop(),!1}return this.currentEvents.pop(),!0}listenerCount(n){let t=this.events[n];return t?t.length:0}shutdown(){this.events={}}};a(Ic,"LegacyEventEmitter");var cn=Ic;var bc=class bc{constructor(n=!1){this.fileLocal=n}request(n){let t=new H,i=window.setTimeout(()=>{t.reject(new Error(Qo))},1e4),l="&timerid="+i,s=n+l,c=document.createElement("script");c.onload=r=>{window.clearTimeout(i),t.isResolved||t.reject(new Error(Uo))},c.onerror=(r,o,d,u,B)=>{window.clearTimeout(i);let b=Os;B&&(b=b+": "+B.message),t.reject(new Error(b))},this.fileLocal?c.src=n:c.src=s;try{document.body.appendChild(c)}catch(r){document.getElementsByTagName("head")[0].appendChild(c)}return t.finally(()=>{clearTimeout(i)}),{promise:t,queryId:i}}};a(bc,"DOMCloudRequester");var _n=bc;function Aa(){return typeof window.KeymanWeb_BaseLayout!="undefined"?window.KeymanWeb_BaseLayout:"us"}a(Aa,"determineBaseLayout");var hc=class hc{constructor(n,t,i,l){this.legacyAPIEvents=new cn;this.keyEventListener=a((n,t)=>{var s;let i=this.contextManager.activeTarget;if(!this.contextManager.activeKeyboard||!i){t&&t(null,null);return}if(this.core.languageProcessor.mayCorrect||(n.keyDistribution=[]),this.keyEventRefocus&&this.keyEventRefocus(),i.invalidateSelection(),i.deadkeys().deleteMatched(),n.isSynthetic){let c=this.osk.vkbd.layerId;c&&c!=this.core.keyboardProcessor.layerId&&(this.core.keyboardProcessor.layerId=c)}let l=this.core.processKeyEvent(n,i);l&&((s=l.transcription)!=null&&s.transform)&&this.config.onRuleFinalization(l,this.contextManager.activeTarget),t&&t(l,null)},"keyEventListener");this.config=t,this.contextManager=i;let s=l(this);s.baseLayout=Aa(),this.interface=s.keyboardInterface,this.core=new jn(t.hostDevice,n,s),this.core.languageProcessor.on("statechange",c=>{var r,o;(r=this.osk)==null||r.bannerController.selectBanner(c),(o=this.osk)==null||o.refreshLayout()}),this.core.keyboardProcessor.on("statekeychange",c=>{var r,o;(o=(r=this.osk)==null?void 0:r.vkbd)==null||o.updateStateKeys(c)}),this.contextManager.on("beforekeyboardchange",c=>{this.legacyAPIEvents.callEvent("beforekeyboardchange",{internalName:c==null?void 0:c.id,languageCode:c==null?void 0:c.langId})}),this.contextManager.on("keyboardchange",c=>{c||this.osk.startHide(!1);let r=a(()=>{var o,d;this.refreshModel(),this.core.activeKeyboard=c==null?void 0:c.keyboard,this.legacyAPIEvents.callEvent("keyboardchange",{internalName:(o=c==null?void 0:c.metadata.id)!=null?o:"",languageCode:(d=c==null?void 0:c.metadata.langId)!=null?d:""})},"prepareKeyboardSwap");this.osk?this.osk.batchLayoutAfter(()=>{r(),this.osk.activeKeyboard=c,this.contextManager.resetContext(),this.osk.present()}):(r(),this.contextManager.resetContext())}),this.contextManager.on("keyboardasyncload",c=>{var r,o;this.config.hostDevice.touchable&&((r=this.osk)!=null&&r.activationModel)&&(this.osk.activationModel.enabled=!0),(o=this.osk)==null||o.startHide(!1)})}init(n){return A(this,null,function*(){let t=this.config;if(t.deferForInitialization.isResolved)return Promise.resolve();t.initialize(n),String.kmwEnableSupplementaryPlane(!0);let i=new il(this.interface,t.applyCacheBusting);this.keyboardRequisitioner=new en(i,new _n,this.config.paths),this.modelCache=new tn;let l=this.keyboardRequisitioner.cache,s=this.core.keyboardProcessor,c=new Qt(this.core.languageProcessor,()=>s.layerId);this.contextManager.configure({resetContext:r=>{this.osk?this.osk.batchLayoutAfter(()=>{this.core.resetContext(r)}):this.core.resetContext(r)},predictionContext:c,keyboardCache:this.keyboardRequisitioner.cache}),this.core.languageProcessor.on("suggestionapplied",()=>{var r;s.newLayerStore.set(""),s.oldLayerStore.set(""),(r=s.processPostKeystroke(s.contextDevice,c.currentTarget))==null||r.finalize(s,c.currentTarget,!0)}),this.config.on("spacebartext",()=>{var r;(r=this.osk)==null||r.refreshLayout()}),l.on("stubadded",r=>{let o=a(()=>{this.legacyAPIEvents.callEvent("keyboardregistered",{internalName:r.KI,language:r.KL,keyboardName:r.KN,languageCode:r.KLC,package:r.KP}),this.config.activateFirstKeyboard&&this.keyboardRequisitioner.cache.defaultStub==r&&this.contextManager.activateKeyboard(r.id,r.langId,!0)},"eventRaiser");this.config.deferForInitialization.isResolved?o():this.config.deferForInitialization.then(o)}),l.on("keyboardadded",r=>{let o=a(()=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:r.id})},"eventRaiser");this.config.deferForInitialization.isResolved?o():this.config.deferForInitialization.then(o)}),this.keyboardRequisitioner.cache.on("keyboardadded",r=>{this.legacyAPIEvents.callEvent("keyboardloaded",{keyboardName:r.id})})})}get build(){return Number.parseInt(tt.VERSION_PATCH,10)}get version(){return tt.VERSION_RELEASE}get hardKeyboard(){return this._hardKeyboard}set hardKeyboard(n){this._hardKeyboard&&this._hardKeyboard.off("keyevent",this.keyEventListener),this._hardKeyboard=n,n.on("keyevent",this.keyEventListener)}get osk(){return this._osk}set osk(n){var t;this._osk&&(this._osk.off("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=this.osk.layerChangeHandler),this._osk=n,this.core.keyboardProcessor.contextDevice=(t=n==null?void 0:n.targetDevice)!=null?t:this.config.softDevice,n&&(this.contextManager.activeKeyboard&&(n.activeKeyboard=this.contextManager.activeKeyboard),n.on("keyevent",this.keyEventListener),this.core.keyboardProcessor.layerStore.handler=n.layerChangeHandler)}getDebugInfo(){var i,l,s,c,r,o,d,u,B,b,I,F,h,y;let n=(i=this.contextManager)==null?void 0:i.activeKeyboard;return{configReport:(l=this.config)==null?void 0:l.debugReport(),keyboard:{id:Ke((c=(s=n==null?void 0:n.metadata)==null?void 0:s.id)!=null?c:""),langId:((r=n==null?void 0:n.metadata)==null?void 0:r.langId)||"",version:(d=(o=n==null?void 0:n.keyboard)==null?void 0:o.version)!=null?d:""},model:{id:((B=(u=this.core)==null?void 0:u.activeModel)==null?void 0:B.id)||""},osk:{banner:(F=(I=(b=this.osk)==null?void 0:b.banner)==null?void 0:I.banner.type)!=null?F:"",layer:((y=(h=this.osk)==null?void 0:h.vkbd)==null?void 0:y.layerId)||""}}}refreshModel(){let n=this.contextManager.activeKeyboard,t=this.modelCache.modelForLanguage(n==null?void 0:n.metadata.langId);return this.core.activeModel!=t&&(this.core.activeModel&&this.core.languageProcessor.unloadModel(),t)?this.core.languageProcessor.loadModel(t).then(()=>t):Promise.resolve(t)}addEventListener(n,t){this.legacyAPIEvents.addEventListener(n,t)}removeEventListener(n,t){this.legacyAPIEvents.removeEventListener(n,t)}shutdown(){var n;this.legacyAPIEvents.shutdown(),(n=this.osk)==null||n.shutdown()}addModel(n){var i;this.modelCache.register(n);let t=(i=this.contextManager.activeKeyboard)==null?void 0:i.metadata;return t&&n.languages.indexOf(t.langId)!=-1?this.refreshModel().then(()=>{}):Promise.resolve()}removeModel(n){this.modelCache.unregister(n),this.core.activeModel&&this.core.activeModel.id==n&&this.core.languageProcessor.unloadModel()}setActiveKeyboard(n,t){return A(this,null,function*(){return this.contextManager.activateKeyboard(n,t,!0)})}getActiveKeyboard(){var n,t;return(t=(n=this.contextManager.activeKeyboard)==null?void 0:n.metadata.id)!=null?t:""}getActiveLanguage(n){var i,l,s;let t=(i=this.contextManager.activeKeyboard)==null?void 0:i.metadata;return n?(s=t==null?void 0:t.langName)!=null?s:"":(l=t==null?void 0:t.langId)!=null?l:""}isChiral(n){let t;if(n){if(typeof n=="string"){let i=this.keyboardRequisitioner.cache.getKeyboard(n);if(i)n=i;else throw new Error(`Keyboard '${n}' has not been loaded.`)}t=n}else t=this.core.activeKeyboard;return t.isChiral}resetContext(){this.contextManager.resetContext()}setNumericLayer(){this.core.keyboardProcessor.setNumericLayer(this.config.softDevice)}};a(hc,"KeymanEngine");var rn=hc;var rt=class rt{get height(){return this._height}set height(n){this._height=n>0?n:0,this.update()}get width(){return this._width}set width(n){this._width=n,this.update()}update(){let n=this.div.style,t=n.height,i=n.display;return this._height>0?(n.height=this._height+"px",n.display="block"):(n.height="0px",n.display="none"),t!==n.height||i!==n.display}constructor(n){let t=J("div");t.id=rt.BANNER_ID,t.className=rt.BANNER_CLASS,this.div=t,this.height=n,this.update()}appendStyleSheet(){}getDiv(){return this.div}configureForKeyboard(n,t){}shutdown(){}};a(rt,"Banner"),rt.DEFAULT_HEIGHT=37,rt.BANNER_CLASS="kmw-banner-bar",rt.BANNER_ID="kmw-banner-bar";var ue=rt;var ze=class ze{constructor(n){let t=typeof n=="string"?ze.parseLengthStyle(n):n;this.val=t.val,this.absolute=t.absolute,t.special&&(this.special=t.special)}get styleString(){return this.absolute?this.val+"px":this.special?this.val+this.special:this.val*100+"%"}scaledBy(n){return new ze({val:n*this.val,absolute:this.absolute})}static inPixels(n){return new ze({val:n,absolute:!0})}static inPercent(n){return new ze({val:n/100,absolute:!1})}static forScalar(n){return new ze({val:n,absolute:!1})}static special(n,t){return new ze({val:n,absolute:!1,special:t})}static parseLengthStyle(n){if(n=="")return So;let t=parseFloat(n);return isNaN(t)?(console.error("Could not properly parse specified length style info: '"+n+"'."),So):n.indexOf("px")!=-1?{val:t,absolute:!0}:n.indexOf("pt")!=-1?{val:4*t/3,absolute:!0}:n.indexOf("%")!=-1?{val:t/100,absolute:!1}:n.indexOf("rem")!=-1?{val:t,absolute:!1,special:"rem"}:n.indexOf("em")!=-1?{val:t,absolute:!1,special:"em"}:{val:4*t/3,absolute:!0}}};a(ze,"ParsedLengthStyle");var Z=ze,So=new Z("1em");var Fc=class Fc extends ue{constructor(){super(0);this.type="blank"}};a(Fc,"BlankBanner");var ot=Fc;var yc=class yc{constructor(){this._activeBannerHeight=ue.DEFAULT_HEIGHT;this.events=new V.default;this.constructContainer()}constructContainer(){let n=J("div");return n.id="keymanweb_banner_container",n.className="kmw-banner-container",this.bannerContainer=n}get element(){return this.bannerContainer}appendStyles(){this.currentBanner&&this.currentBanner.appendStyleSheet()}get banner(){return this.currentBanner}set banner(n){if(this.currentBanner){if(n==this.currentBanner)return;{let t=this.currentBanner;this.currentBanner=n,this.bannerContainer.replaceChild(n.getDiv(),t.getDiv()),t.shutdown()}}else this.currentBanner=n,n&&this.bannerContainer.appendChild(n.getDiv());n instanceof ot||(n.height=this.activeBannerHeight),this.events.emit("bannerchange")}get height(){return this.currentBanner?this.currentBanner.height:0}get activeBannerHeight(){return this._activeBannerHeight}set activeBannerHeight(n){this._activeBannerHeight=n,this.currentBanner&&!(this.currentBanner instanceof ot)&&(this.currentBanner.height=n)}get layoutHeight(){return Z.inPixels(this.height)}get width(){var n;return(n=this.currentBanner)==null?void 0:n.width}set width(n){this.currentBanner&&(this.currentBanner.width=n)}refreshLayout(){var n,t;(t=(n=this.currentBanner).refreshLayout)==null||t.call(n)}};a(yc,"BannerView");var rl=yc;var mc=class mc extends ue{constructor(t,i){var n=(...args)=>{super(...args)};t.length>0?(n(),i&&(this.height=i)):n(0),this.type="image",t.indexOf("base64")>=0?console.log("Loading img from base64 data"):console.log("Loading img with src '"+t+"'"),this.img=document.createElement("img"),this.img.setAttribute("src",t);let l=this.img.style;l.width="100%",l.height="100%",this.getDiv().appendChild(this.img),console.log("Image loaded.")}setImagePath(t){this.img&&this.img.setAttribute("src",t)}};a(mc,"ImageBanner");var ol=mc;function He(g,n){n instanceof Error?console.error(`${g}: ${n.message}

${n.stack}`):(console.error(g),console.error(n))}a(He,"reportError");var Gc=class Gc{constructor(n){this.queue=[],this.defaultWaitFactory=n||(()=>ge(0))}get defaultWait(){return this.defaultWaitFactory()}get ready(){return this.queue.length==0&&!this.waitLock}triggerNextClosure(){return A(this,null,function*(){if(this.queue.length==0)return;let n=this.queue.shift();this.waitLock=Promise.resolve();let t;try{t=n()}catch(i){He("Error from queued closure",i)}t=t!=null?t:this.defaultWaitFactory(),this.waitLock=t;try{yield t}catch(i){He("Async error from queued closure",i)}this.waitLock=null,this.triggerNextClosure()})}runAsync(n){let t=this.ready;this.queue.push(n),t&&this.triggerNextClosure()}};a(Gc,"AsyncClosureDispatchQueue");var al=Gc;function Wo(g){return"targetX"in g&&"targetY"in g&&"t"in g}a(Wo,"isAnInputSample");var at=class at{constructor(n){this.rawLinearSums={x:0,y:0,t:0};this.coordArcSum=0;this._sampleCount=0;if(n)if(n instanceof at)Object.assign(this,n),this.rawLinearSums=C({},n.rawLinearSums);else if(Wo(n))Object.assign(this,this.extend(n));else throw new Error("A constructor for this input pattern has not yet been implemented")}extend(n){return this._extend(new at(this),n)}_extend(n,t){n._initialSample||(n._initialSample=t,n.baseSample=t);let i=n.baseSample;this.followingSample=t;let l=t.targetX-i.targetX,s=t.targetY-i.targetY,c=t.t-i.t;if(n.rawLinearSums.x+=l,n.rawLinearSums.y+=s,n.rawLinearSums.t+=c,this.lastSample){let r=t.targetX-this.lastSample.targetX,o=t.targetY-this.lastSample.targetY,d=r*r+o*o,u=Math.sqrt(d);n.coordArcSum+=u}return n._lastSample=t,n.sampleCount=this.sampleCount+1,n}deaccumulate(n){let t=new at(this);return this._deaccumulate(t,n)}_deaccumulate(n,t){if(!t)return n;if(!t.followingSample||!t.lastSample)throw"Invalid argument:  stats missing necessary tracking variable.";for(let i in n.rawLinearSums){let l=i;n.rawLinearSums[l]-=t.rawLinearSums[l]}if(t.followingSample&&t.lastSample){let i=t.followingSample.targetX-t.lastSample.targetX,l=t.followingSample.targetY-t.lastSample.targetY,s=i*i+l*l,c=Math.sqrt(s);n.coordArcSum-=c,n.coordArcSum-=t.coordArcSum}return n.sampleCount-=t.sampleCount,n._initialSample=t.followingSample,n}translateCoordSystem(n){let t=new at(this);return this._translateCoordSystem(t,n)}_translateCoordSystem(n,t){if(this.sampleCount==0)return n;let i=n.initialSample==n.lastSample;return n._initialSample=t(n.initialSample),n.baseSample=t(n.baseSample),n._lastSample=i?n._initialSample:t(n.lastSample),n}replaceInitialSample(n){let t=new at(this);return this._replaceInitialSample(t,n)}_replaceInitialSample(n,t){if(this.sampleCount==0)throw new Error("no sample available to replace");let i=n.initialSample;if(n._initialSample=t,this.sampleCount>1){let l=t.targetX-i.targetX,s=t.targetY-i.targetY,c=t.t-i.t;n.rawLinearSums.x+=l,n.rawLinearSums.y+=s,n.rawLinearSums.t+=c;let r=l*l+s*s,o=Math.sqrt(r);n.coordArcSum+=o}else n._lastSample=t;return n}get lastSample(){return this._lastSample}get lastTimestamp(){var n;return(n=this.lastSample)==null?void 0:n.t}get sampleCount(){return this._sampleCount}set sampleCount(n){this._sampleCount=n}get initialSample(){return this._initialSample}mappingConstant(n){if(this.baseSample)return n=="t"?this.baseSample.t:n=="x"?this.baseSample.targetX:n=="y"?this.baseSample.targetY:0}mean(n){return this.rawLinearSums[n]/this.sampleCount+this.mappingConstant(n)}get netDistance(){if(!this.lastSample||!this.initialSample)return 0;let n=this.lastSample.targetX-this.initialSample.targetX,t=this.lastSample.targetY-this.initialSample.targetY;return Math.sqrt(n*n+t*t)}get duration(){return!this.lastSample||!this.initialSample?0:this.lastSample.t-this.initialSample.t}get angle(){if(this.sampleCount==1||!this.lastSample||!this.initialSample)return;if(this.netDistance<1)return;let n=this.lastSample.targetX-this.initialSample.targetX,t=this.lastSample.targetY-this.initialSample.targetY,i=Math.acos(-t/this.netDistance);return n<0?2*Math.PI-i:i}get angleInDegrees(){return this.angle*180/Math.PI}get cardinalDirection(){if(this.sampleCount==1||!this.lastSample||!this.initialSample||isNaN(this.angle)||this.angle===null||this.angle===void 0)return;let n=["n","ne","e","se","s","sw","w","nw","n"],t=Math.ceil((this.angleInDegrees-22.5)/45);return n[t]}get speed(){return this.duration?this.netDistance/this.duration:0}get rawDistance(){return this.coordArcSum}toJSON(){return{angle:this.angle,cardinal:this.cardinalDirection,netDistance:this.netDistance,duration:this.duration,sampleCount:this.sampleCount,rawDistance:this.rawDistance}}};a(at,"CumulativePathStats");var ve=at;function St(g,n){let t=g.gestures.find(i=>i.id==n);if(!t)throw new Error(`Could not find spec for gesture with id '${n}'`);return t}a(St,"getGestureModel");function pc(g,n){let t=g.sets[n];if(!t)throw new Error(`Could not find a defined gesture-set with id '${n}'`);let i=g.gestures.filter(s=>!!t.find(c=>s.id==c)),l=t.filter(s=>!i.find(c=>c.id==s));if(l.length>0)throw new Error(`Set '${n}' cannot find definitions for gestures with ids ${l}`);return i}a(pc,"getGestureModelSet");var Cc={gestures:[],sets:{default:[]}};var Qc=class Qc{constructor(){}getBoundingClientRect(){return new DOMRect(0,0,Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),Math.max(document.documentElement.clientHeight||0,window.innerHeight||0))}};a(Qc,"ViewportZoneSource");var gl=Qc;var Uc=class Uc{get edgePadding(){return this._edgePadding}constructor(n,t){Array.isArray(n)&&(t=n,n=new gl),this.root=n,t=t||[0,0,0,0],this.updatePadding(t)}updatePadding(n){switch(n.length){case 1:let t=n[0];this._edgePadding={x:t,y:t,w:2*t,h:2*t};break;case 2:this._edgePadding={x:n[1],y:n[0],w:2*n[1],h:2*n[0]};break;case 3:this._edgePadding={x:n[1],y:n[0],w:2*n[1],h:n[0]+n[2]};break;case 4:this._edgePadding={x:n[3],y:n[0],w:n[1]+n[3],h:n[0]+n[2]};break;default:throw new Error("Invalid values for PaddedZoneSource's edgePadding - must be between 1 to 4 `number` values.")}}getBoundingClientRect(){let n=this.root.getBoundingClientRect();return new DOMRect(n.left+this.edgePadding.x,n.top+this.edgePadding.y,n.width-this.edgePadding.w,n.height-this.edgePadding.h)}};a(Uc,"PaddedZoneSource");var Be=Uc;function dl(g){var t,i,l,s,c,r,o;let n=C({},g);if(n.mouseEventRoot=(t=n.mouseEventRoot)!=null?t:n.targetRoot,n.touchEventRoot=(i=n.touchEventRoot)!=null?i:n.targetRoot,n.inputStartBounds=(l=n.inputStartBounds)!=null?l:n.targetRoot,n.maxRoamingBounds=(s=n.maxRoamingBounds)!=null?s:n.targetRoot,n.safeBounds=(c=n.safeBounds)!=null?c:new Be([2]),n.itemIdentifier=(r=n.itemIdentifier)!=null?r:()=>null,n.recordingMode=!!n.recordingMode,n.historyLength=((o=n.historyLength)!=null?o:0)>0?n.historyLength:0,g.paddedSafeBounds)delete n.safeBoundPadding;else{let d=g.safeBoundPadding;typeof d=="number"&&(d=[d]),d=d!=null?d:[3],n.paddedSafeBounds=new Be(n.safeBounds,d)}return n}a(dl,"preprocessRecognizerConfig");var ul=class ul extends V.default{constructor(){super();this._isComplete=!1;this._stats=new ve}get stats(){return this._stats}clone(){let t=new ul;return t._isComplete=this._isComplete,t._wasCancelled=this._wasCancelled,t._stats=new ve(this._stats),t}get isComplete(){return this._isComplete}get wasCancelled(){return this._wasCancelled}translateCoordSystem(t){this._stats=this._stats.translateCoordSystem(t)}replaceInitialSample(t){this._stats=this._stats.replaceInitialSample(t)}extend(t){if(this._isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this._stats=this._stats.extend(t),this.emit("step",t)}terminate(t=!1){this._isComplete||(this._wasCancelled=t,this._isComplete=!0,t?this.emit("invalidated"):this.emit("complete"),this.removeAllListeners())}toJSON(){return{stats:this.stats,wasCancelled:this.wasCancelled}}};a(ul,"GesturePath");var on=ul;var qn=class qn extends on{constructor(){super(...arguments);this.samples=[]}clone(){let t=new qn;return t.samples=[].concat(this.samples),t._isComplete=this._isComplete,t._wasCancelled=this._wasCancelled,t._stats=new ve(this._stats),t}static deserialize(t){let i=new qn;i.samples=[].concat(t.coords.map(s=>C({},s))),i._isComplete=!0,i._wasCancelled=t.wasCancelled;let l=i.samples.reduce((s,c)=>s.extend(c),new ve);return i._stats=l,i}extend(t){if(this.isComplete)throw new Error("Invalid state:  this GesturePath has already terminated.");this.samples.push(t),super.extend(t)}translateCoordSystem(t){super.translateCoordSystem(t);for(let i=0;i<this.samples.length;i++)this.samples[i]=t(this.samples[i])}get coords(){return this.samples}toJSON(){let t={coords:[].concat(this.samples.map(i=>({targetX:i.targetX,targetY:i.targetY,t:i.t,item:i.item}))),wasCancelled:this.wasCancelled,stats:this.stats};for(let i of t.coords)delete i.clientX,delete i.clientY,i.item===void 0&&delete i.item;return t}};a(qn,"GestureDebugPath");var gt=qn;var xc=class xc{constructor(n,t,i,l){this.stateToken=null;this.rawIdentifier=n,this.isFromTouch=i,this._path=l?new l:new on,this.recognizerConfigStack=Array.isArray(t)?t:[t]}get path(){return this._path}setGestureMatchInspector(n){if(this._matchInspectionClosure)throw new Error("Invalid state:  the match-inspection closure has already been set");this._matchInspectionClosure=n}update(n){this.path.extend(n),this._baseItem||(this._baseItem=n.item)}get baseItem(){return this._baseItem}set baseItem(n){this._baseItem=n}get currentSample(){return this.path.stats.lastSample}get potentialModelMatchIds(){return this._matchInspectionClosure(this)}constructSubview(n,t,i){return new re(this,this.recognizerConfigStack,n,t,i)}terminate(n){this.path.terminate(n)}get isPathComplete(){return this.path.isComplete}get identifier(){return`${this.isFromTouch?"touch":"mouse"}:${this.rawIdentifier}`}pushRecognizerConfig(n){let t=W(C({},n),{mouseEventRoot:this.recognizerConfigStack[0].mouseEventRoot,touchEventRoot:this.recognizerConfigStack[0].touchEventRoot});this.recognizerConfigStack.push(dl(t))}popRecognizerConfig(){if(this.recognizerConfigStack.length==1)throw new Error("Cannot 'pop' the original recognizer-configuration for this GestureSource.");return this.recognizerConfigStack.pop()}get currentRecognizerConfig(){return this.recognizerConfigStack[this.recognizerConfigStack.length-1]}toJSON(){return{identifier:this.identifier,isFromTouch:this.isFromTouch,path:this.path.toJSON(),stateToken:this.stateToken}}};a(xc,"GestureSource");var Fe=xc,$n=class $n extends Fe{constructor(t,i,l,s,c){let r=0,o=t.path.stats.sampleCount;t instanceof $n&&(r=t._baseStartIndex);super(t.rawIdentifier,i,t.isFromTouch,Object.getPrototypeOf(t.path).constructor);let d=this._baseSource=t instanceof $n?t._baseSource:t;this.stateToken=c!=null?c:t.stateToken;let u=a(h=>{let y=this.recognizerTranslation,U=W(C({},h),{targetX:h.targetX-y.x,targetY:h.targetY-y.y});return this.stateToken&&(U.stateToken=this.stateToken),(this.stateToken!=d.stateToken||this.stateToken!=t.stateToken)&&(U.item=this.currentRecognizerConfig.itemIdentifier(U,null)),U},"translateSample"),B=t.path.stats.lastSample;l?(this._baseStartIndex=r=Math.max(r+o-1,0),o=o>0?1:0):this._baseStartIndex=r,l?t.path.stats.sampleCount&&this._path.extend(t.path.stats.lastSample):this._path=t.path.clone(),this._path.translateCoordSystem(u),s?this._baseItem=t.baseItem:this._baseItem=B==null?void 0:B.item;let b=a(()=>this.path.terminate(!1),"completeHook"),I=a(()=>this.path.terminate(!0),"invalidatedHook"),F=a(h=>{super.update(u(h))},"stepHook");d.path.on("complete",b),d.path.on("invalidated",I),d.path.on("step",F),this.subviewDisconnector=()=>{d.path.off("complete",b),d.path.off("invalidated",I),d.path.off("step",F)},d.isPathComplete&&(this.path.terminate(d.path.wasCancelled),this.disconnect())}get recognizerTranslation(){if(this.recognizerConfigStack.length==1||!this.currentRecognizerConfig)return{x:0,y:0};let i=this.currentRecognizerConfig.targetRoot.getBoundingClientRect(),l=this.recognizerConfigStack[0].targetRoot.getBoundingClientRect();return{x:i.left-l.left,y:i.top-l.top}}get baseSource(){return this._baseSource}disconnect(){this.subviewDisconnector&&(this.subviewDisconnector(),this.subviewDisconnector=null)}pushRecognizerConfig(t){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}popRecognizerConfig(){throw new Error("Pushing and popping of recognizer configurations should only be called on the base GestureSource")}update(t){throw new Error("Updates should be provided through the base GestureSource.")}terminate(t){this.baseSource.terminate(t)}};a($n,"GestureSourceSubview");var re=$n;var Il=class Il extends Fe{constructor(t,i,l){super(t,i,l,gt);this.stateToken=null}initPath(){return new gt}static deserialize(t,i){let l=i!==void 0?i:this._jsonIdSeed++,s=t.isFromTouch,c=gt.deserialize(t.path),r=new Il(l,null,s);return r._path=c,r}};a(Il,"GestureDebugSource");var Bl=Il;var ei=class ei extends V.default{constructor(t){var i;super();this._activeTouchpoints=[];this.identifierMap={};this.config=t,this.sourceConstructor=(i=t==null?void 0:t.recordingMode)==null||i?Bl:Fe}createTouchpoint(t,i){let l=ei.IDENTIFIER_SEED++;this.identifierMap[t]=l;let s=new this.sourceConstructor(l,this.config,i);return s.stateToken=this.stateToken,s}fulfillInputStart(t){}maintainTouchpoints(t){t||(t=[]),this._activeTouchpoints.filter(i=>!t.includes(i)).forEach(i=>i.terminate(!0))}hasActiveTouchpoint(t){return this.identifierMap[t]!==void 0}getTouchpointWithId(t){let i=this.identifierMap[t];return this._activeTouchpoints.find(l=>l.rawIdentifier==i)}getConfigForId(t){return this.getTouchpointWithId(t).currentRecognizerConfig}getStateTokenForId(t){var i;return(i=this.getTouchpointWithId(t).stateToken)!=null?i:null}dropTouchpoint(t){let i=t.rawIdentifier;this._activeTouchpoints=this._activeTouchpoints.filter(l=>t!=l);for(let l of Object.keys(this.identifierMap)){let s=Number.parseInt(l,10);this.identifierMap[s]==i&&delete this.identifierMap[s]}}addTouchpoint(t){this._activeTouchpoints.push(t)}get activeSources(){return[].concat(this._activeTouchpoints)}};a(ei,"InputEngineBase"),ei.IDENTIFIER_SEED=0;var bl=ei;function Zc(g,n,t){let i=g.targetRoot.getBoundingClientRect();return{clientX:n,clientY:t,targetX:n-i.left,targetY:t-i.top}}a(Zc,"processSampleClientCoords");var Xc=class Xc extends bl{buildSampleFor(n,t,i,l,s){var d,u;let c=W(C({},Zc(this.config,n,t)),{t:l,stateToken:(d=s==null?void 0:s.stateToken)!=null?d:this.stateToken}),o=((u=s==null?void 0:s.currentRecognizerConfig.itemIdentifier)!=null?u:this.config.itemIdentifier)(c,i);return c.item=o,c}onInputStart(n,t,i,l){let s=this.createTouchpoint(n,l);s.update(t),this.addTouchpoint(s),s.path.on("invalidated",()=>{this.dropTouchpoint(s)}),s.path.on("complete",()=>{this.dropTouchpoint(s)});try{this.emit("pointstart",s)}catch(c){He("Engine-internal error while initializing gesture matching for new source",c)}return s}onInputMove(n,t,i){if(n)try{n.update(t)}catch(l){He("Error occurred while updating source",l)}}onInputMoveCancel(n,t,i){if(n)try{n.update(t),n.path.terminate(!0)}catch(l){He("Error occurred while cancelling further input for source",l)}}onInputEnd(n,t){if(n)try{n.path.terminate(!1)}catch(i){He("Error occurred while finalizing input for source",i)}}};a(Xc,"InputEventEngine");var an=Xc;var Xe=class Xe{constructor(){}static getCoordZoneBitmask(n,t){let i=t.getBoundingClientRect(),l=0;return l|=n.clientX<i.left?Xe.FAR_LEFT:0,l|=n.clientX>i.right?Xe.FAR_RIGHT:0,l|=n.clientY<i.top?Xe.FAR_TOP:0,l|=n.clientY>i.bottom?Xe.FAR_BOTTOM:0,l}static inputStartOutOfBoundsCheck(n,t){return!!this.getCoordZoneBitmask(n,t.inputStartBounds)}static inputStartSafeBoundProximityCheck(n,t){return this.getCoordZoneBitmask(n,t.paddedSafeBounds)}static inputMoveCancellationCheck(n,t,i){return i=i||0,this.getCoordZoneBitmask(n,t.maxRoamingBounds)?!0:!!(this.getCoordZoneBitmask(n,t.safeBounds)&~i)}};a(Xe,"ZoneBoundaryChecker"),Xe.FAR_TOP=8,Xe.FAR_LEFT=4,Xe.FAR_BOTTOM=2,Xe.FAR_RIGHT=1;var fe=Xe;var Vc=class Vc extends an{constructor(t){super(t);this.hasActiveClick=!1;this.disabledSafeBounds=0;this.currentSource=null;this.activeIdentifier=0;this._mouseStart=i=>this.onMouseStart(i),this._mouseMove=i=>this.onMouseMove(i),this._mouseEnd=i=>this.onMouseEnd(i)}get eventRoot(){return this.config.mouseEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("mousedown",this._mouseStart,!0),this.eventRoot.addEventListener("mousemove",this._mouseMove,!1),this.eventRoot.addEventListener("mouseup",this._mouseEnd,!0)}unregisterEventHandlers(){this.eventRoot.removeEventListener("mousedown",this._mouseStart,!0),this.eventRoot.removeEventListener("mousemove",this._mouseMove,!1),this.eventRoot.removeEventListener("mouseup",this._mouseEnd,!0)}preventPropagation(t){t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,typeof t.stopImmediatePropagation=="function"?t.stopImmediatePropagation():typeof t.stopPropagation=="function"&&t.stopPropagation()}buildSampleFromEvent(t){return this.buildSampleFor(t.clientX,t.clientY,t.target,performance.now(),this.currentSource)}onMouseStart(t){if(!this.config.targetRoot.contains(t.target))return;this.preventPropagation(t);let i=this.buildSampleFromEvent(t);fe.inputStartOutOfBoundsCheck(i,this.config)||(this.disabledSafeBounds=fe.inputStartSafeBoundProximityCheck(i,this.config));let l=this.onInputStart(this.activeIdentifier,i,t.target,!1);this.currentSource=l;let s=a(()=>{this.currentSource=null},"cleanup");l.path.on("complete",s),l.path.on("invalidated",s)}onMouseMove(t){let i=this.currentSource;if(!i)return;let l=this.buildSampleFromEvent(t);if(!t.buttons){this.hasActiveClick&&(this.hasActiveClick=!1,this.onInputMoveCancel(i,l,t.target));return}this.preventPropagation(t);let s=i.currentRecognizerConfig;fe.inputMoveCancellationCheck(l,s,this.disabledSafeBounds)?this.onInputMoveCancel(i,l,t.target):this.onInputMove(i,l,t.target)}onMouseEnd(t){let i=this.currentSource;i&&(t.buttons||(this.hasActiveClick=!1),this.onInputEnd(i,t.target))}};a(Vc,"MouseEventEngine");var hl=Vc;function Ao(g){let n=[];for(let t=0;t<g.length;t++)n.push(g.item(t));return n}a(Ao,"touchListToArray");var Sc=class Sc extends an{constructor(t){super(t);this.eventDispatcher=new al;this.safeBoundMaskMap={};this.pendingSourcePromises=new Map;this.inputStartSignalMap=new Map;this._touchStart=i=>this.onTouchStart(i),this._touchMove=i=>this.onTouchMove(i),this._touchEnd=i=>this.onTouchEnd(i)}get eventRoot(){return this.config.touchEventRoot}registerEventHandlers(){this.eventRoot.addEventListener("touchstart",this._touchStart,{capture:!0,passive:!1}),this.eventRoot.addEventListener("touchmove",this._touchMove,{capture:!1,passive:!1}),this.eventRoot.addEventListener("touchend",this._touchEnd,{capture:!0,passive:!1})}unregisterEventHandlers(){this.eventRoot.removeEventListener("touchstart",this._touchStart,!0),this.eventRoot.removeEventListener("touchmove",this._touchMove,!1),this.eventRoot.removeEventListener("touchend",this._touchEnd,!0)}preventPropagation(t){t.cancelable&&t.preventDefault(),typeof t.stopImmediatePropagation=="function"?t.stopImmediatePropagation():typeof t.stopPropagation=="function"&&t.stopPropagation()}dropTouchpoint(t){super.dropTouchpoint(t);for(let i of Object.keys(this.safeBoundMaskMap)){let l=Number.parseInt(i,10);this.getTouchpointWithId(l)==t&&delete this.safeBoundMaskMap[l]}}fulfillInputStart(t){let i=this.inputStartSignalMap.get(t);i&&(this.inputStartSignalMap.delete(t),i.resolve())}hasActiveTouchpoint(t){return super.hasActiveTouchpoint(t)||!!this.pendingSourcePromises.has(t)}buildSampleFromTouch(t,i,l){return this.buildSampleFor(t.clientX,t.clientY,t.target,i,l)}onTouchStart(t){if(!this.config.targetRoot.contains(t.target))return;this.preventPropagation(t);let i=Ao(t.touches),l=Ao(t.changedTouches),c=i.filter(o=>l.findIndex(d=>o.identifier==d.identifier)==-1).map(o=>this.pendingSourcePromises.get(o.identifier));this.eventDispatcher.runAsync(()=>A(this,null,function*(){let o=yield Promise.all(c);return this.maintainTouchpoints(o),this.eventDispatcher.defaultWait}));let r=new Map;for(let o=0;o<t.changedTouches.length;o++){let d=t.changedTouches.item(o),u=new H;this.pendingSourcePromises.set(d.identifier,u),r.set(d.identifier,u)}this.eventDispatcher.runAsync(()=>{let o=performance.now(),d=null;for(let u=0;u<t.changedTouches.length;u++){let B=t.changedTouches.item(u),b=B.identifier,I=this.buildSampleFromTouch(B,o,null);if(!fe.inputStartOutOfBoundsCheck(I,this.config))this.safeBoundMaskMap[b]=fe.inputStartSafeBoundProximityCheck(I,this.config);else{r.get(b).resolve(null);continue}d=this.onInputStart(b,I,t.target,!0);let F=r.get(b);F.resolve(d);let h=a(()=>{this.pendingSourcePromises.get(b)==F&&this.pendingSourcePromises.delete(b)},"cleanup");d.path.on("complete",h),d.path.on("invalidated",h)}if(d){let u=new H;return this.inputStartSignalMap.set(d,u),u.corePromise}else return Promise.resolve()})}onTouchMove(t){var l;for(let s=0;s<t.touches.length;s++){let c=t.touches.item(s);if(this.hasActiveTouchpoint(c.identifier)){this.preventPropagation(t);break}}let i=new Map;for(let s=0;s<t.touches.length;s++){let c=t.touches.item(s).identifier;i.set(c,(l=this.pendingSourcePromises.get(c))==null?void 0:l.corePromise)}this.eventDispatcher.runAsync(()=>A(this,null,function*(){let s=yield Promise.all(i.values());return this.maintainTouchpoints(s),this.eventDispatcher.defaultWait})),this.eventDispatcher.runAsync(()=>A(this,null,function*(){let s=performance.now();for(let c=0;c<t.touches.length;c++){let r=t.touches.item(c),o=r.identifier,d=yield i.get(o);if(!d||d.isPathComplete)continue;let u=d.currentRecognizerConfig,B=this.buildSampleFromTouch(r,s,d);fe.inputMoveCancellationCheck(B,u,this.safeBoundMaskMap[o])?this.onInputMoveCancel(d,B,r.target):this.onInputMove(d,B,r.target)}return this.eventDispatcher.defaultWait}))}onTouchEnd(t){var l;for(let s=0;s<t.changedTouches.length;s++){let c=t.changedTouches.item(s);if(this.hasActiveTouchpoint(c.identifier)){this.preventPropagation(t);break}}let i=new Map;for(let s=0;s<t.changedTouches.length;s++){let c=t.changedTouches.item(s).identifier,r=(l=this.pendingSourcePromises.get(c))==null?void 0:l.corePromise;i.set(c,r)}this.eventDispatcher.runAsync(()=>A(this,null,function*(){for(let s=0;s<t.changedTouches.length;s++){let c=t.changedTouches.item(s),r=yield i.get(c.identifier);!r||r.isPathComplete||this.onInputEnd(r,t.target)}return this.eventDispatcher.defaultWait}))}};a(Sc,"TouchEventEngine");var Fl=Sc;var Wc=class Wc{get promise(){return this.publishedPromise.corePromise}constructor(n,t,i){if(!n||!t)throw new Error("A gesture-path source and contact-path model must be specified.");if(this.model=n,this.publishedPromise=new H,this.source=t,this.inheritedStats=i,this.lastStats=null,n.timer){let l=n.timer.inheritElapsed?Math.min(t.path.stats.duration,n.timer.duration):0;this.timerPromise=new Te(n.timer.duration-l),this.publishedPromise.then(()=>{this.timerPromise.resolve(!1)}),this.timerPromise.then(s=>{let c=t instanceof re?t.baseSource:t,r=performance.now();!c.isPathComplete&&c.currentSample.t!=r&&c.path.extend(W(C({},c.currentSample),{t:r})),s!=n.timer.expectedResult&&this.finalize(!1,"timer"),this.finalize(!0,"timer")})}}finalize(n,t){if(this.publishedPromise.isFulfilled)return this._result;let i=this.model;i.validateItem&&n&&(n=i.validateItem(this.source.path.stats.lastSample.item,this.baseItem));let l;return n?l={type:i.pathResolutionAction,cause:t}:l={type:"reject",cause:t},this.publishedPromise.resolve(l),this._result=l,l}get stats(){return this.source.path.stats}get baseItem(){return this.source.baseItem}get lastItem(){return this.source.currentSample.item}update(){let n=this.model,t=this.source;if(t.path.wasCancelled)return this.finalize(!1,"path");if(n.itemChangeAction&&t.path.stats.sampleCount>0&&t.currentSample.item!=t.baseItem){let i=n.itemChangeAction=="resolve";return this.finalize(i,"item")}else{let i=n.pathModel.evaluate(t.path,this.lastStats,t.baseItem,this.inheritedStats)||"continue";return this.lastStats=t.path.stats,i!="continue"?this.finalize(i=="resolve","path"):t.path.isComplete?this.finalize(!1,"path"):{type:"continue"}}}};a(Wc,"PathMatcher");var gn=Wc;var Ac=class Ac{constructor(n,t){this._isCancelled=!1;var r;if(!n||!t)throw new Error("Construction of GestureMatcher requires a gesture-model spec and a source for related contact points.");if(!n.sustainTimer&&!t)throw new Error("If the provided gesture-model spec lacks a sustain timer, there must be an active contact point.");let i=t instanceof Fe?null:t,l=i?null:t;this.predecessor=i,this.publishedPromise=new H,this.model=n,n.sustainTimer&&(this.sustainTimerPromise=new Te(n.sustainTimer.duration),this.sustainTimerPromise.then(o=>{let d=n.sustainTimer.expectedResult==o;this.finalize(d,"timer")})),this.pathMatchers=[];let c=(l?[l]:i.sources).map(o=>l&&o==l?l:o.isPathComplete?null:o).reduce((o,d)=>d?o.concat(d):o,[]);if(n.sustainTimer&&c.length>0){this.finalize(!1,"path");return}else!n.sustainTimer&&c.length==0&&this.finalize(!1,"path");for(let o=0;o<c.length;o++){let d=c[o];d instanceof re&&d.disconnect();let u=n.contacts[o];if(!u)throw new Error(`No contact model for inherited path: gesture "${n.id}', entry ${o}`);let B=(r=u==null?void 0:u.model.pathInheritance)!=null?r:"chop",b=!1,I;switch(B){case"reject":this.finalize(!1,"path");return;case"full":I=d.constructSubview(!1,!0),this.addContactInternal(I,d.path.stats,!0);continue;case"partial":b=!0;case"chop":I=d.constructSubview(!0,b),this.addContactInternal(I,d.path.stats,!0);break}}}get sources(){return this.pathMatchers.map((n,t)=>{if(!this.model.contacts[t].resetOnInstantFulfill)return n.source}).filter(n=>!!n)}get promise(){return this.publishedPromise.corePromise}cancel(){this._isCancelled=!0,this._result||this.finalize(!1,"cancelled")}get isCancelled(){return this._isCancelled}finalize(n,t){var i,l;if(this.publishedPromise.isFulfilled)return this._result;try{let s;n?s=this.model.resolutionAction:(t!="cancelled"&&((i=this.model.rejectionActions)!=null&&i[t])&&(s=this.model.rejectionActions[t],s.item="none"),s=s||{type:"none",item:"none"});let c;switch((l=s.item)!=null?l:"current"){case"none":c=null;break;case"base":c=this.primaryPath.baseItem;break;case"current":c=this.primaryPath.currentSample.item;break}let o={matched:n,action:W(C({},s),{item:c})};return this.publishedPromise.resolve(o),this._result=o,o}catch(s){return this.publishedPromise.reject(s),{matched:!1,action:{type:"none",item:null}}}}finalizeSources(){if(!this._result)throw Error("Invalid state for source-finalization - the matcher's evaluation of the gesture model is not yet complete");let n=this._result.matched;for(let t=0;t<this.pathMatchers.length;t++){let i=this.pathMatchers[t],l=this.model.contacts[t];i.source.isPathComplete||(n&&l.endOnResolve||!n&&l.endOnReject)&&i.source.terminate(!1)}}get primaryPath(){let n,t=Number.NEGATIVE_INFINITY;for(let i of this.pathMatchers)i.model.itemPriority>t&&(t=i.model.itemPriority,n=i);return!n&&this.predecessor?this.predecessor.primaryPath:n==null?void 0:n.source}get baseItem(){return this.primaryPath.baseItem}get currentItem(){return this.primaryPath.currentSample.item}get allSourceIds(){let n=this.sources.map(i=>i.identifier),t=this.predecessor?this.predecessor.allSourceIds:[];return n=n.filter(i=>t.indexOf(i)==-1),n.concat(t)}mayAddContact(){return this.pathMatchers.length<this.model.contacts.length}addContact(n){let t=this.pathMatchers.length;if(!this.mayAddContact())throw new Error(`The specified gesture model does not support more than ${t} contact points.`);this.addContactInternal(n.constructSubview(!1,!0),null)}get result(){return this._result}addContactInternal(n,t,i){var u;let l=this.pathMatchers.length,s=this.model.contacts[l],c=new gn(s.model,n,new ve(t));this.pathMatchers.push(c);let r=null,o=null;if(!l&&this.predecessor&&this.model.sustainTimer){r=this.predecessor.primaryPath;let B=(u=this.model.sustainTimer.baseItem)!=null?u:"result",b;switch(B){case"none":o=null;break;case"base":o=this.predecessor.primaryPath.baseItem,b=this.predecessor.primaryPath.stateToken;break;case"result":o=this.predecessor.result.action.item,b=this.predecessor.primaryPath.currentSample.stateToken;break}n.baseItem=o!=null?o:n.baseItem,n.stateToken=b,n.currentSample.stateToken=b,n.currentRecognizerConfig&&(n.currentSample.item=n.currentRecognizerConfig.itemIdentifier(n.currentSample,null))}else o=this.primaryPath.baseItem,r=this.primaryPath;if(s.model.baseCoordReplacer){let B=n.path.stats,b=s.model.baseCoordReplacer(B,o);if(b){let I=W(C({},Zc(n.currentRecognizerConfig,b.clientX,b.clientY)),{t:b.t||b.t===0?b.t:B.initialSample.t,item:o,stateToken:n.stateToken});n.path.replaceInitialSample(I)}}if(s.model.allowsInitialState&&!s.model.allowsInitialState(n.currentSample,r.currentSample,o,r.stateToken)){this.pathMatchers.pop(),this.finalize(!1,"cancelled");return}let d=c.update();if((d==null?void 0:d.type)=="reject"){this.finalize(!1,i?"cancelled":"path");return}c.promise.then(B=>{this.finalize(B.type=="resolve",B.cause)})}update(){this.pathMatchers.forEach(n=>{try{n.update()}catch(t){console.error(t),this.finalize(!1,"cancelled")}})}};a(Ac,"GestureMatcher");var Wt=Ac;var Rc=class Rc extends V.default{constructor(t){super();this._sourceSelector=[];this.potentialMatchers=[];this.sustainMode=!1;this.attemptSynchronousUpdate=a(()=>{let i=this._sourceSelector.filter(s=>!s.source.isPathComplete).map(s=>s.source.currentSample.t),l=i[0];i.find(s=>l!=s)||this.potentialMatchers.forEach(s=>s.update())},"attemptSynchronousUpdate");this.baseGestureSetId=t||"default"}potentialMatchersForSource(t){return this.potentialMatchers.filter(i=>i.allSourceIds.find(l=>l==t.identifier))}cascadeTermination(){let t=this.potentialMatchers,i=t.filter(r=>!r.model.sustainWhenNested),l=t.filter(r=>r.model.sustainWhenNested);this.potentialMatchers=l;let s=l.map(r=>r.allSourceIds).reduce((r,o)=>{for(let d of o)r.indexOf(d)==-1&&r.push(d);return r},[]);return this._sourceSelector.filter(r=>!s.find(o=>o==r.source.identifier)).forEach(r=>{r.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}});let o=this._sourceSelector.indexOf(r);o>-1&&this._sourceSelector.splice(o,1)}),i.forEach(r=>r.cancel()),this.sustainMode=!0,this._sourceSelector.map(r=>r.source)}matchGesture(t,i){return A(this,null,function*(){let l=t instanceof Fe,s=a(I=>{let F=I.sources.map(h=>h.baseSource);return F&&F.length>0?F:I.predecessor?s(I.predecessor):[]},"determinePredecessorSources"),c=l?[t instanceof re?t.baseSource:t]:s(t),r=l?t:null,o=l?null:t;if(this.pendingMatchSetup){let I=this.pendingMatchSetup,F=new H;this.pendingMatchSetup=F.corePromise,yield I,this.pendingMatchSetup==F.corePromise&&(this.pendingMatchSetup=null),F.resolve()}l&&r.path.on("invalidated",()=>{this.dropSourcesWithIds([r.identifier])});let d=new H,u=c.map(I=>{let F={source:I,matchPromise:d,preserve:!0};return this._sourceSelector.push(F),F}),B=u.map(I=>I.matchPromise);if(l){let I=this.potentialMatchers.filter(F=>F.mayAddContact());if(I.forEach(F=>{F.addContact(r),F.promise.then(this.matcherSelectionFilter(F,B))}),I.length>0){let F=this.stateToken,h=new H;this.pendingMatchSetup=h.corePromise,yield ge(0),yield ge(0),this.pendingMatchSetup==h.corePromise&&(this.pendingMatchSetup=null),h.resolve();let y=this.stateToken;if(F!=y){let x=r.currentSample;r.stateToken=y,x.stateToken=y,x.item=t.currentRecognizerConfig.itemIdentifier(x,null),r.baseItem=x.item}let U=I.find(x=>x.result);if(U&&U.allSourceIds.includes(t.identifier))return d.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:d.corePromise}}}if(u.forEach(I=>{I.preserve=!1}),this.sustainMode&&r)return d.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),{selectionPromise:d.corePromise,sustainModeWithoutMatch:!0};let b=i.map(I=>{try{return new Wt(I,r||o)}catch(F){return console.error(F),null}}).filter(I=>!!I);b=b.filter(I=>!I.result||I.result.matched!==!1);for(let I of b)I.promise.then(this.matcherSelectionFilter(I,B));return b.length>0?this.potentialMatchers=this.potentialMatchers.concat(b):d.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}}),this.potentialMatchers.sort((I,F)=>F.model.resolutionPriority-I.model.resolutionPriority),this.resetSourceHooks(),{selectionPromise:d.corePromise}})}resetSourceHooks(){let t=a(i=>{let l=i;l.path.off("step",this.attemptSynchronousUpdate),l.path.off("complete",this.attemptSynchronousUpdate),l.path.off("invalidated",this.attemptSynchronousUpdate),l.path.on("step",this.attemptSynchronousUpdate),l.path.on("complete",this.attemptSynchronousUpdate),l.path.on("invalidated",this.attemptSynchronousUpdate)},"resetHooks");this._sourceSelector.forEach(i=>t(i.source))}dropSourcesWithIds(t){for(let i of t){let l=this._sourceSelector.findIndex(s=>s.source.identifier==i);l>-1&&this._sourceSelector.splice(l,1)[0].matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"none",item:null}}})}}matchersForSource(t){return this.potentialMatchers.filter(i=>!!i.sources.find(l=>l.identifier==t.identifier))}matcherSelectionFilter(t,i){return l=>A(this,null,function*(){t.isCancelled?l={matched:!1,action:{type:"none",item:null}}:t.finalizeSources();let c=t.allSourceIds.map(o=>this._sourceSelector.find(d=>d.source.identifier==o)).filter(o=>!!o),r=this.potentialMatchers.indexOf(t);if(r!=-1){if(this.potentialMatchers.splice(r,1),l.action.type=="none"){this.finalizeMatcherlessTrackers(c);return}if(l.matched)for(let o of c){let d=this.matchersForSource(o.source);this.potentialMatchers=this.potentialMatchers.filter(u=>!d.find(B=>u==B)),d.forEach(u=>{u.cancel()}),this._sourceSelector=this._sourceSelector.filter(u=>!c.find(B=>u==B)),o.matchPromise.resolve({matcher:t,result:l})}else{let o=a(d=>{if(this.sustainMode&&!d.sustainWhenNested){this.finalizeMatcherlessTrackers(c);return}let u=new Wt(d,t);if(u.result&&u.result.matched==!1){this.finalizeMatcherlessTrackers(c);return}u.promise.then(this.matcherSelectionFilter(u,c.map(B=>B.matchPromise))),this.potentialMatchers.push(u),this.resetSourceHooks()},"replacer");this.emit("rejectionwithaction",{matcher:t,result:l},o);return}}})}finalizeMatcherlessTrackers(t){let i=t.map(l=>({tracker:l,pendingCount:this.potentialMatchers.filter(s=>!!s.allSourceIds.find(c=>l.source.identifier==c)).length}));for(let l of i)l.pendingCount==0&&!l.tracker.preserve&&l.tracker.matchPromise.resolve({matcher:null,result:{matched:!1,action:{type:"complete",item:null}}})}};a(Rc,"MatcherSelector");var dt=Rc;var vc=class vc{get currentSourceIds(){return this.sources.map(n=>n.identifier)}constructor(n,t){var s,c;let{matcher:i,result:l}=n;this.gestureSetId=t,this.matchedId=i==null?void 0:i.model.id,this.linkType=l.action.type,this.item=l.action.item,this.sources=i==null?void 0:i.sources,(s=this.sources)==null||s.forEach(r=>r.disconnect()),(c=this.sources)==null||c.sort((r,o)=>(i==null?void 0:i.primaryPath)==r?-1:(i==null?void 0:i.primaryPath)==o?1:0),this.allSourceIds=(i==null?void 0:i.allSourceIds)||[]}get interval(){return this.sources.length==0?void 0:this.sources.map(t=>({start:t.path.stats.initialSample.t,end:t.path.stats.lastTimestamp})).reduce((t,i)=>({start:t.start>i.start?i.start:t.start,end:t.end<i.end?i.end:t.end}),{start:Number.POSITIVE_INFINITY,end:Number.NEGATIVE_INFINITY})}};a(vc,"GestureStageReport");var ti=vc,fc=class fc extends V.default{constructor(t,i,l,s){super();this.selectionHandler=a(t=>A(this,null,function*(){var u,B,b,I,F,h,y,U,x,G;let i=((u=this.pushedSelector)==null?void 0:u.baseGestureSetId)||((B=this.selector)==null?void 0:B.baseGestureSetId),l=new ti(t,i);t.matcher&&this.stageReports.push(l);let s=(b=t.matcher)!=null?b:this.stageReports[this.stageReports.length-1],c=(I=s==null?void 0:s.sources.map(p=>p instanceof re?p.baseSource:p))!=null?I:[],r=t.result.action.type;if((r=="complete"||r=="none")&&(c.forEach(p=>{p.isPathComplete||p.terminate(r=="none")}),!t.result.matched)){this.markedComplete||this.emit("complete");return}if(r=="complete"&&this.touchpointCoordinator&&this.pushedSelector){let R=((F=this.touchpointCoordinator)==null?void 0:F.sustainSelectorSubstack(this.pushedSelector)).map(f=>{let v=new H;return f.path.on("invalidated",()=>v.resolve()),f.path.on("complete",()=>v.resolve()),v.corePromise});R.length>0&&t.result.action.awaitNested&&(yield Promise.all(R),yield ge(0)),(h=this.touchpointCoordinator)==null||h.popSelector(this.pushedSelector),this.pushedSelector=null}this.emit("stage",l,p=>{p.type=="pop"?c.forEach(R=>R.popRecognizerConfig()):c.forEach(R=>R.pushRecognizerConfig(p.config))});let o=!1;this.touchpointCoordinator&&(o=!this.touchpointCoordinator.selectorStackIncludes(this.selector));let d=Hc(t.result.action,this.gestureConfig,this.baseGestureSetId);if(o&&(d=d.filter(p=>p.sustainWhenNested)),d.length>0){if(!(r=="chain"&&t.result.action.selectionMode==((y=this.pushedSelector)==null?void 0:y.baseGestureSetId))){if(this.pushedSelector&&(this.pushedSelector.off("rejectionwithaction",this.modelResetHandler),(U=this.touchpointCoordinator)==null||U.popSelector(this.pushedSelector),this.pushedSelector=null),r=="chain"){let f=t.result.action.selectionMode;if(f){let v=new dt(f);v.on("rejectionwithaction",this.modelResetHandler),this.pushedSelector=v,(x=this.touchpointCoordinator)==null||x.pushSelector(v)}}}((G=this.pushedSelector)!=null?G:this.selector).matchGesture(t.matcher,d).then(f=>A(this,null,function*(){return this.selectionHandler(yield f.selectionPromise)}))}else this.markedComplete||this.emit("complete")}),"selectionHandler");this.modelResetHandler=a((t,i)=>{let l=t.matcher.allSourceIds;if(!this.allSourceIds.find(s=>l.indexOf(s)==-1))if(t.result.action.type=="replace")i(St(this.gestureConfig,t.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.stageReports=[],this.selector=l,this.selector.on("rejectionwithaction",this.modelResetHandler),this.once("complete",()=>{var c;this.completionTime=performance.now(),this.pushedSelector&&((c=this.touchpointCoordinator)==null||c.popSelector(this.pushedSelector),this.pushedSelector=null),this.selector.off("rejectionwithaction",this.modelResetHandler),this.selector.dropSourcesWithIds(this.allSourceIds),this.selector=null}),this.gestureConfig=i,this.touchpointCoordinator=s,Promise.resolve().then(()=>this.selectionHandler(t))}get markedComplete(){return this.completionTime!==void 0}get allSourceIds(){var t,i;return(i=(t=this.stageReports[this.stageReports.length-1])==null?void 0:t.allSourceIds)!=null?i:[]}get baseGestureSetId(){var t,i;return(i=(t=this.selector)==null?void 0:t.baseGestureSetId)!=null?i:null}get potentialModelMatchIds(){if(!this.selector)return[];let t=[this.selector];return this.pushedSelector&&t.push(this.pushedSelector),this.stageReports[this.stageReports.length-1].sources.map(c=>t.map(r=>r.potentialMatchersForSource(c).map(o=>o.model.id))).reduce((c,r)=>c.concat(r)).reduce((c,r)=>{for(let o of r)c.indexOf(o)==-1&&c.push(o);return c},[])}cancel(){this.stageReports[this.stageReports.length-1].sources.forEach(i=>i.baseSource.isPathComplete||i.baseSource.terminate(!0)),this.markedComplete||this.emit("complete")}toJSON(){return this.stageReports}trace(t){t||(t="  ");let i=a(c=>c.length==0?"<empty>":c.length==1?c[0]:c.join(", "),"logTouches"),l=a(c=>c?c.start==c.end?`@ ${c.start.toFixed(2)} ms`:`from ${c.start.toFixed(2)} ms - ${c.end.toFixed(2)} ms`:"","logInterval"),s=this.stageReports.map(c=>t+`${i(c.currentSourceIds)} - ${c.matchedId} ${l(c.interval)}`).reverse();return this.markedComplete&&s.unshift(t+`complete @ ${this.completionTime}`),s.join(`
`)}};a(fc,"GestureSequence");var dn=fc;function Hc(g,n,t){switch(g.type){case"none":case"complete":return[];case"replace":return[St(n,g.replace)];case"chain":return[St(n,g.next)];default:throw new Error("Unexpected case arose within `processGestureAction` method")}}a(Hc,"modelSetForAction");var Lc=class Lc extends V.default{constructor(t,i,l){super();this.selectorStack=[new dt];this._activeSources=[];this._activeGestures=[];this._history=[];this.modelResetHandler=a((t,i)=>{let l=t.matcher.allSourceIds;if(!this.activeGestures.find(s=>s.allSourceIds.find(c=>l.indexOf(c)!=-1)))if(t.result.action.type=="replace")i(St(this.gestureModelDefinitions,t.result.action.replace));else throw new Error("Missed a case in implementation!")},"modelResetHandler");this.onNewTrackedPath=a(t=>A(this,null,function*(){this.addSimpleSourceHooks(t);let i=this.gestureModelDefinitions,l,s;do{l=this.currentSelector;let B=yield l.matchGesture(t,pc(i,l.baseGestureSetId));if(B.sustainModeWithoutMatch){let b=a(I=>{I.stateToken=this.stateToken,I.item=t.currentRecognizerConfig.itemIdentifier(I,null)},"correctSample");t.path instanceof gt&&t.path.coords.forEach(b),t.stateToken=this.stateToken,t.baseItem=t.path.stats.initialSample.item,b(t.path.stats.initialSample),b(t.path.stats.lastSample);continue}else{s=B.selectionPromise;break}}while(l!=this.currentSelector);let c=this.currentSelector;t.setGestureMatchInspector(this.buildGestureMatchInspector(c));let r=a(()=>{this.recordHistory(t)},"preGestureScribe");try{t.path.on("invalidated",r),this.emit("inputstart",t)}catch(B){He("Error from 'inputstart' event listener",B)}this.inputEngines.forEach(B=>{B.fulfillInputStart(t)});let o=yield s;if(!o||o.result.matched==!1)return;let d=o.matcher.allSourceIds;for(let B of this._activeGestures)if(B.allSourceIds.find(b=>!!d.find(I=>b==I)))return;let u=new dn(o,i,this.currentSelector,this);this._activeGestures.push(u),u.on("complete",()=>{let B=this._activeGestures.indexOf(u);B!=-1&&this._activeGestures.splice(B,1)}),t.path.wasCancelled||(t.path.off("invalidated",r),u.on("complete",()=>this.recordHistory(u))),this.emit("recognizedgesture",u)}),"onNewTrackedPath");if(this.historyMax=l>0?l:0,this.gestureModelDefinitions=t,this.inputEngines=[],i)for(let s of i)this.addEngine(s);this.selectorStack[0].on("rejectionwithaction",this.modelResetHandler)}pushSelector(t){this.selectorStack.push(t),t.on("rejectionwithaction",this.modelResetHandler)}sustainSelectorSubstack(t){if(!t)return[];let i=this.selectorStack.indexOf(t);if(i==-1)return[];if(this.selectorStack.length<=1)throw new Error("May not force the original, base gesture selector into sustain mode.");let l=[];for(let s=i;s<this.selectorStack.length;s++)t=this.selectorStack[s],l=l.concat(t.cascadeTermination());return l}popSelector(t){if(!t)return;let i=this.selectorStack.indexOf(t);if(i!=-1){if(this.selectorStack.length<=1)throw new Error("May not pop the original, base gesture selector.");for(;i<this.selectorStack.length;)t=this.selectorStack[i],t.off("rejectionwithaction",this.modelResetHandler),this.selectorStack.splice(i,1);this.currentSelector.stateToken=this.stateToken}}selectorStackIncludes(t){return this.selectorStack.includes(t)}get currentSelector(){return this.selectorStack[this.selectorStack.length-1]}buildGestureMatchInspector(t){return i=>{let l=this.selectorStack.indexOf(t);return this.selectorStack.slice(l).map(c=>c.potentialMatchersForSource(i).map(r=>r.model.id)).reduce((c,r)=>c.concat(r))}}addEngine(t){t.on("pointstart",this.onNewTrackedPath),this.inputEngines.push(t)}recordHistory(t){let i=this.historyMax;i>0&&(this._history.length==i&&this._history.shift(),this._history.push(t))}get activeGestures(){return[].concat(this._activeGestures)}get activeSources(){return[].concat(this.inputEngines.map(t=>t.activeSources).reduce((t,i)=>t.concat(i),[]))}get history(){return this._history}get historyJSON(){let t=a(function(i,l){return i=="item"?l==null?void 0:l.id:l},"sanitizingReplacer");return JSON.stringify(this.history,t,2)}get stateToken(){return this._stateToken}set stateToken(t){this._stateToken=t,this.inputEngines.forEach(i=>i.stateToken=t),this.currentSelector.stateToken=t}addSimpleSourceHooks(t){t.path.on("invalidated",()=>{let i=this.activeGestures.find(s=>s.allSourceIds.includes(t.identifier));i&&i.cancel();let l=this._activeSources.indexOf(t);this._activeSources=this._activeSources.splice(l,1)}),t.path.on("complete",()=>{let i=this._activeSources.indexOf(t);this._activeSources=this._activeSources.splice(i,1)})}};a(Lc,"TouchpointCoordinator");var yl=Lc;var ml={};Sn(ml,{EMPTY_GESTURE_DEFS:()=>Cc,getGestureModel:()=>St,getGestureModelSet:()=>pc});var Jc=class Jc extends yl{constructor(t,i){let l=dl(i);t=t||Cc;super(t,null,l.historyLength);this.config=l,this.mouseEngine=new hl(this.config),this.touchEngine=new Fl(this.config),this.mouseEngine.registerEventHandlers(),this.touchEngine.registerEventHandlers(),this.addEngine(this.mouseEngine),this.addEngine(this.touchEngine)}destroy(){this.activeGestures.forEach(t=>t.cancel()),this.activeSources.forEach(t=>t.terminate(!0)),this.mouseEngine.unregisterEventHandlers(),this.touchEngine.unregisterEventHandlers(),this.mouseEngine=null,this.touchEngine=null}};a(Jc,"GestureRecognizer");var At=Jc;var kc={};Sn(kc,{matchers:()=>Gl,specs:()=>ml});var Gl={};Sn(Gl,{GestureMatcher:()=>Wt,GestureSequence:()=>dn,GestureStageReport:()=>ti,MatcherSelector:()=>dt,PathMatcher:()=>gn,modelSetForAction:()=>Hc});function pl(g,n){let t=new Map;return n.keys.forEach(i=>{let l=Math.abs(g.x-i.centerX),s=Math.abs(g.y-i.centerY),c,r;l>.5*i.width?(c=l-.5*i.width,l=.5):(c=0,l/=i.width),s>.5*i.height?(r=s-.5*i.height,s=.5):(r=0,s/=i.height),c*=n.kbdScaleRatio,c+=l*i.height,r+=s*i.height;let o=c*c+r*r;t.set(i.keySpec,o)}),t}a(pl,"keyTouchDistances");function ut(g){var l;let n=new Map,t=0;Array.isArray(g)||(g=[g]);for(let s of g)for(let c of s.keys()){let r=1/(Math.pow(s.get(c),2)+3e-5);t+=r,n.set(c,(l=n.get(c))!=null?l:0+r)}let i=[];for(let s of n.keys())i.push({keySpec:s,p:n.get(s)/t});return i.sort(function(s,c){return c.p-s.p})}a(ut,"distributionFromDistanceMaps");var Nc=["n","ne","e","se","s","sw","w","nw"],Ro=Math.PI,Yc=(()=>{let g=new Map,n=Ro/4;for(let t=0;t<Nc.length;t++)g.set(Nc[t],[n*t,1]);return g})();function Cl(g){return Math.PI/4*Nc.indexOf(g)}a(Cl,"lockedAngleForDir");function ii(g,n){let t=Cl(n),i=g.initialSample,l=g.lastSample.targetX-i.targetX,s=g.lastSample.targetY-i.targetY,c=Math.max(0,-s*Math.cos(t));return Math.max(0,l*Math.sin(t))+c}a(ii,"calcLockedDistance");function Ra(g,n,t,i){return l=>{let s=Cl(n),c=i.flick.triggerDist-i.flick.dirLockDist,r=Math.max(0,ii(g.path.stats,n)-i.flick.dirLockDist),d=Math.min(1,.7*r/c),u=Math.sin(s)*d,B=-Math.cos(s)*d;t==null||t.scrollFlickPreview(u,B)}}a(Ra,"buildFlickScroller");var Ql=Math.PI/3,Ec=class Ec{constructor(n,t,i,l,s,c){this.directlyEmitsKeys=!0;this.sequence=n,this.gestureParams=s,this.baseSpec=l.key.spec,this.baseKeyDistances=i.getSimpleTapCorrectionDistances(n.stageReports[0].sources[0].path.stats.initialSample,this.baseSpec);let r=n.stageReports[0].sources[0].baseSource,o=r;n.on("complete",()=>{c==null||c.cancel(),this.baseSpec}),this.sequence.on("stage",u=>{var F;let B=o.path.stats;this.computedFlickDistribution=this.flickDistribution(B,!0);let b=this.computedFlickDistribution[0].keySpec;if(u.matchedId=="flick-restart"){o.path.replaceInitialSample(u.sources[0].path.stats.initialSample);return}if(u.matchedId=="flick-reset-centering"){o=r.constructSubview(!0,!0);return}else if(u.matchedId=="flick-reset-end"){this.emitKey(i,this.baseSpec,o.path.stats);return}else if(u.matchedId=="flick-reset"){this.flickScroller&&(this.flickScroller(o.currentSample),o.path.off("step",this.flickScroller)),this.lockedDir=null,this.lockedSelectable=null,o instanceof re&&o.disconnect();return}else if(u.matchedId=="flick-mid"){if(b==this.baseSpec)return;let h=Object.keys(this.baseSpec.flick).find(y=>this.baseSpec.flick[y]==b);this.lockedDir=h,this.lockedSelectable=b,this.flickScroller&&o.path.off("step",this.flickScroller),this.flickScroller=Ra(o,h,c,this.gestureParams),this.flickScroller(o.currentSample),o.path.on("step",this.flickScroller);return}let I=(F=this.lockedSelectable)!=null?F:b;this.emitKey(i,I,B)});let d=this.buildPopupRecognitionConfig(i);t({type:"push",config:d})}emitKey(n,t,i){let l;ii(i,this.lockedDir)>this.gestureParams.flick.triggerDist?l=n.keyEventFromSpec(t):l=n.keyEventFromSpec(this.baseSpec),l.keyDistribution=this.currentStageKeyDistribution(this.baseKeyDistances),l.inputBreadcrumb=this.sequence.trace(),n.raiseKeyEvent(l,null)}buildPopupRecognitionConfig(n){let t={getBoundingClientRect(){let i=Number.MAX_SAFE_INTEGER;return new DOMRect(-i,-i,2*i,2*i)}};return W(C({},n.gestureEngine.config),{maxRoamingBounds:t,safeBounds:t})}cancel(){}flickDistribution(n,t){let i=this.baseSpec.flick,l=[{spec:this.baseSpec,coord:[NaN,0]}];l=l.concat(Object.keys(i).map(b=>({spec:i[b],coord:Yc.get(b)})));let s=n.angle,c=this.gestureParams.flick.triggerDist,o=Math.min(c,t?c:n.netDistance)/c,d=0,u=l.map(b=>{let I=0,F=b.coord;if(!isNaN(F[0])){let x=s-F[0],G=2*Ro+F[0]-s;I=Math.min(x*x,G*G)}let h=Ql*(F[1]-o),y=h*h,U=1/(I+y+1e-6);return d+=U,{keySpec:b.spec,p:U}}),B=1/d;return u.forEach(b=>b.p*=B),u.sort((b,I)=>I.p-b.p)}currentStageKeyDistribution(n){let t=this.baseSpec,i=this.baseKeyDistances,l=this.computedFlickDistribution;if(!i.get(t))return[{keySpec:l[0].keySpec,p:1}];let c=l.findIndex(d=>d.keySpec==t),r=l.splice(c,1)[0].p,o=ut(i);return l.concat(o.map(d=>({keySpec:d.keySpec,p:d.p*r})))}};a(Ec,"Flick");var ni=Ec;var Ul=ya.TouchLayoutKeySp,li={longpress:{flickDistStart:8,flickDistFinal:40,waitLength:500,noiseTolerance:10},multitap:{waitLength:300,holdLength:150},flick:{startDist:10,dirLockDist:25,triggerDist:40}};function Ho(g){let n=g.getBoundingClientRect();return{clientX:n.left+n.width/2,clientY:n.top+n.height/2}}a(Ho,"getKeyCentroid");function vo(g){let n=Ho(g);return t=>{let i=t.lastSample.clientX-n.clientX,l=t.lastSample.clientY-n.clientY;return Math.sqrt(i*i+l*l)}}a(vo,"buildDistFromKeyCentroidFunctor");function si(g){let n=g.key.spec;if(n.sk)return!1;let t=["K_SHIFT","K_ALT","K_CTRL","K_NUMERALS","K_SYMBOLS","K_CURRENCIES"];for(let i of t)if(n.id==i)return!0;if(n.nextlayer)switch(n.sp){case Ul.special:case Ul.specialActive:case Ul.customSpecial:case Ul.customSpecialActive:return!0;default:return!1}else return!1}a(si,"keySupportsModipress");function Tc(g,n){let t=a((h,y)=>{if(!h)return!1;let U=h.key.spec;switch(y){case"modipress-start":return si(h);case"special-key-start":return["K_LOPT","K_ROPT","K_BKSP"].indexOf(U.baseKeyID)!=-1;case"longpress":return!0;case"multitap-start":case"modipress-multitap-start":return g.hasMultitaps?!!U.multitap:!1;case"flick-start":return!!U.flick;default:return!0}},"gestureKeyFilter"),i=n;i.longpress.permitsFlick=h=>{let y=h==null?void 0:h.key.spec.flick;return!y||!(y.n||y.nw||y.ne)};let l=i.roamingEnabled=!g.hasFlicks,s=oe(l?_a(i):Yo(i)),c=oe(l?Mc(i):Eo(i)),r=u(oe(ko(i,!0,l)),0),o=u(Pa(i),0),d=u(ig(i),0);Object.defineProperty(r.contacts[0].model.timer,"duration",{get:()=>i.longpress.waitLength}),Object.defineProperty(o.sustainTimer,"duration",{get:()=>i.multitap.waitLength}),Object.defineProperty(d.sustainTimer,"duration",{get:()=>i.multitap.waitLength});function u(h,y){h=oe(h);let U=h.id;return typeof y=="number"&&(y=[y]),h.contacts.forEach((x,G)=>{var p;if(y.indexOf(G)!=-1){let R=(p=x.model.allowsInitialState)!=null?p:()=>!0;x.model=W(C({},x.model),{allowsInitialState:(f,v,w)=>t(w,U)&&R(f,v,w)})}}),h}a(u,"withKeySpecFiltering");let B=Na(),b=$a(),I=[r,o,ja(i),s,c,u(B,0),Ya(i),qa(),u(b,0),eg(i),ng(),tg(),d,lg(i),sg()],F=[r.id,s.id,b.id,B.id];return l?(I.push(u(Ea(i),0)),I.push(Ta())):(I.push(u(No(i),0)),I.push(Ma(i)),I.push(Ka(i)),I.push(za(i)),I.push(wa(i)),I.push(Da()),I.push(Oa(i)),F.push("flick-start")),{gestures:I,sets:{default:F,modipress:F.filter(h=>h!=b.id),none:[]}}}a(Tc,"gestureSetForLayout");function wc(){return{itemPriority:0,pathResolutionAction:"reject",pathModel:{evaluate:g=>"resolve"}}}a(wc,"instantContactRejectionModel");function Le(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:g=>"resolve"}}}a(Le,"instantContactResolutionModel");function Ha(g){let n=g.flick;return{itemPriority:1,pathModel:{evaluate:(t,i,l)=>{let s=t.stats,c=l==null?void 0:l.key.spec;if(c&&c.sk){let r=c.flick;if(!(r.nw||r.n||r.ne)){let d=s.netDistance,u=s.angle;if(d*Math.cos(u)>g.longpress.flickDistStart)return"reject"}}return s.netDistance>n.startDist?"resolve":null}},pathResolutionAction:"resolve",pathInheritance:"partial"}}a(Ha,"flickStartContactModel");function fo(g,n){let t=n.key.spec.flick,i=Object.keys(t),l,s=0;for(let c of i){let r=ii(g,c);r>s&&(s=r,l=c)}return{dir:l,dist:s}}a(fo,"determineLockFromStats");function va(g){return{itemPriority:1,pathModel:{evaluate:(n,t,i)=>{let{dir:l,dist:s}=fo(n.stats,i);if(s>g.flick.dirLockDist){let c=n.stats.angle,r=Cl(l),o=Math.abs(c-r),d=Math.abs(2*Math.PI+r-c);if(o<=Ql||d<=Ql)return"resolve"}else if(n.isComplete)return"reject"}},pathResolutionAction:"resolve",pathInheritance:"full"}}a(va,"flickMidContactModel");function fa(g){return{itemPriority:1,pathModel:{evaluate:(n,t,i,l)=>{if(n.isComplete)return"resolve";{let{dir:s}=fo(l,i);if(ii(n.stats,s)<g.flick.dirLockDist)return"reject"}}},pathResolutionAction:"resolve",pathInheritance:"full"}}a(fa,"flickEndContactModel");function La(g,n,t){let i=g.longpress;return{itemPriority:0,pathResolutionAction:"resolve",timer:{get duration(){return i.waitLength},expectedResult:!0},validateItem:(l,s)=>!!(s!=null&&s.key.spec.sk),pathModel:{evaluate:l=>{var c;let s=l.stats;if(n&&i.permitsFlick(s.lastSample.item)&&((c=s.cardinalDirection)!=null?c:"").indexOf("n")!=-1){let r=s.netDistance,o=s.angle;if(r*Math.cos(o)>i.flickDistFinal)return"resolve"}else if(t){if(s.rawDistance>i.noiseTolerance||s.lastSample.item!=s.initialSample.item)return"reject"}else if(s.lastSample.item!=s.initialSample.item)return"reject";return l.isComplete?"reject":null}}}}a(La,"longpressContactModel");function Lo(){return{itemPriority:-1,pathResolutionAction:"resolve",pathModel:{evaluate:g=>"resolve"}}}a(Lo,"modipressContactStartModel");function Ja(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:g=>{if(g.isComplete)return"reject"}}}}a(Ja,"modipressContactHoldModel");function Jo(){return{itemPriority:-1,itemChangeAction:"resolve",pathResolutionAction:"resolve",pathModel:{evaluate:g=>{if(g.isComplete)return"resolve"}}}}a(Jo,"modipressContactEndModel");function xl(g,n){var i;let t=(i=g==null?void 0:g.roamingEnabled)!=null?i:!0;return{itemPriority:0,itemChangeAction:t?"reject":void 0,pathResolutionAction:"resolve",pathInheritance:!t&&n?"full":"chop",pathModel:{evaluate:l=>{if(l.isComplete&&!l.wasCancelled)return"resolve"}}}}a(xl,"simpleTapContactModel");function ka(){return{itemPriority:0,pathResolutionAction:"resolve",pathModel:{evaluate:g=>{if(g.isComplete&&!g.wasCancelled)return"resolve"}}}}a(ka,"subkeySelectContactModel");function Na(){return{id:"special-key-start",resolutionPriority:0,contacts:[{model:C({},Le()),endOnResolve:!1}],resolutionAction:{type:"chain",next:"special-key-end",item:"current"}}}a(Na,"specialKeyStartModel");function Ya(g){return{id:"special-key-end",resolutionPriority:0,contacts:[{model:W(C({},xl(g)),{itemChangeAction:"resolve"}),endOnResolve:!0},{model:Le(),resetOnInstantFulfill:!0}],resolutionAction:{type:"complete",item:"none"}}}a(Ya,"specialKeyEndModel");function ko(g,n,t){let i={id:"longpress",resolutionPriority:4,contacts:[{model:W(C({},La(g,n,t)),{itemPriority:1,pathInheritance:"chop"}),endOnResolve:!1},{model:wc(),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"subkey-select",selectionMode:"none",item:"none"}};return t?W(C({},i),{rejectionActions:{path:{type:"replace",replace:"longpress-roam"},timer:{type:"replace",replace:"longpress-roam-restore"}}}):i}a(ko,"longpressModel");function Ea(g){let n=ko(g,!1,!0);return W(C({},n),{id:"longpress-roam"})}a(Ea,"longpressModelAfterRoaming");function Ta(){return{id:"longpress-roam-restore",contacts:[{model:{pathModel:{evaluate:g=>null},itemChangeAction:"reject",pathInheritance:"full",pathResolutionAction:"reject",itemPriority:0}}],resolutionPriority:-1,rejectionActions:{item:{type:"replace",replace:"longpress-roam"}},resolutionAction:{type:"chain",next:"longpress-roam"}}}a(Ta,"longpressRoamRestoration");function No(g){return{id:"flick-start",resolutionPriority:3,contacts:[{model:Ha(g)}],resolutionAction:{type:"chain",item:"none",next:"flick-mid"}}}a(No,"flickStartModel");function wa(g){let n=No(g);return W(C({},n),{contacts:[W(C({},n.contacts[0]),{model:W(C({},n.contacts[0].model),{baseCoordReplacer:(t,i)=>{let l=Ho(i),s=vo(i),c=t.initialSample,r=s(t);if(r>g.flick.triggerDist)return l;let o=g.flick.dirLockDist;if(r<o)return c;let d=o/r,u=c.clientX-l.clientX,B=c.clientY-l.clientY;return{clientX:l.clientX+u*d,clientY:l.clientY+B*d}}})})],id:"flick-restart",sustainWhenNested:!0,rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}}})}a(wa,"flickRestartModel");function Ma(g){return{id:"flick-mid",resolutionPriority:0,contacts:[{model:va(g),endOnReject:!0},{model:wc(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset-end"}},resolutionAction:{type:"chain",item:"none",next:"flick-end"},sustainWhenNested:!0}}a(Ma,"flickMidModel");function Ka(g){return{id:"flick-reset",resolutionPriority:1,contacts:[{model:W(C({},Le()),{pathInheritance:"partial"})}],resolutionAction:{type:"chain",next:"flick-reset-centering"},sustainWhenNested:!0}}a(Ka,"flickResetModel");function za(g){return{id:"flick-reset-centering",resolutionPriority:1,contacts:[{model:{pathModel:{evaluate(n,t,i){t||(t=n.stats);let l=vo(i),s=l(n.stats);if(l(t)<s)return"resolve"}},itemPriority:0,pathResolutionAction:"resolve",pathInheritance:"full"}}],resolutionAction:{type:"chain",next:"flick-restart"},sustainWhenNested:!0}}a(za,"flickResetCenteringModel");function Da(){return{id:"flick-reset-end",resolutionPriority:1,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"complete",item:"base"},sustainWhenNested:!0}}a(Da,"flickResetEndModel");function Oa(g){return{id:"flick-end",resolutionPriority:0,contacts:[{model:fa(g)},{model:Le(),resetOnInstantFulfill:!0}],rejectionActions:{path:{type:"replace",replace:"flick-reset"}},resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}a(Oa,"flickEndModel");function Pa(g){return{id:"multitap-start",resolutionPriority:2,contacts:[{model:W(C({},Le()),{itemPriority:1,pathInheritance:"reject",allowsInitialState(n,t,i){return n.item==i}})}],sustainTimer:{duration:g.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"multitap-end",item:"current"}}}a(Pa,"multitapStartModel");function ja(g){return{id:"multitap-end",resolutionPriority:2,contacts:[{model:W(C({},xl(g)),{itemPriority:1,timer:{duration:g.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:Le(),resetOnInstantFulfill:!0}],rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"none"}}}a(ja,"multitapEndModel");function Yo(g){return{id:"initial-tap",resolutionPriority:1,contacts:[{model:W(C({},xl(g)),{pathInheritance:"chop",itemPriority:1,timer:{duration:g.multitap.holdLength,expectedResult:!1}}),endOnResolve:!0},{model:Le(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,rejectionActions:{timer:{type:"replace",replace:"simple-tap"}},resolutionAction:{type:"chain",next:"multitap-start",item:"base"}}}a(Yo,"initialTapModel");function Eo(g){return{id:"simple-tap",resolutionPriority:1,contacts:[{model:W(C({},xl(g,!0)),{itemPriority:1}),endOnResolve:!0},{model:Le(),resetOnInstantFulfill:!0}],sustainWhenNested:!0,resolutionAction:{type:"complete",item:"base"}}}a(Eo,"simpleTapModel");function _a(g){let n=Yo(g);return W(C({},n),{rejectionActions:W(C({},n.rejectionActions),{item:{type:"replace",replace:"initial-tap"}})})}a(_a,"initialTapModelWithReset");function Mc(g){let n=Eo(g);return W(C({},n),{rejectionActions:W(C({},n.rejectionActions),{item:{type:"replace",replace:"simple-tap"}})})}a(Mc,"simpleTapModelWithReset");function qa(){return{id:"subkey-select",resolutionPriority:0,contacts:[{model:W(C({},ka()),{pathInheritance:"full",itemPriority:1}),endOnResolve:!0,endOnReject:!0}],resolutionAction:{type:"complete",item:"current"},sustainWhenNested:!0}}a(qa,"subkeySelectModel");function $a(){return{id:"modipress-start",resolutionPriority:5,contacts:[{model:W(C({},Lo()),{allowsInitialState(g,n,t){return si(t)},itemChangeAction:"reject",itemPriority:1})}],resolutionAction:{type:"chain",next:"modipress-hold",selectionMode:"modipress",item:"current"}}}a($a,"modipressStartModel");function eg(g){return{id:"modipress-hold",resolutionPriority:5,contacts:[{model:W(C({},Ja()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:g.multitap.holdLength,expectedResult:!0,inheritElapsed:!0}})},{model:C({},Le()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"},rejectionActions:{path:{type:"replace",replace:"modipress-end-multitap-transition"}}}}a(eg,"modipressHoldModel");function tg(){return{id:"modipress-end-multitap-transition",resolutionPriority:5,contacts:[],sustainTimer:{duration:0,expectedResult:!0},resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"}}}a(tg,"modipressMultitapTransitionModel");function ng(){return{id:"modipress-end",resolutionPriority:5,contacts:[{model:W(C({},Jo()),{itemChangeAction:"reject",pathInheritance:"full"})}],resolutionAction:{type:"complete",item:"none",awaitNested:!0}}}a(ng,"modipressEndModel");function ig(g){return{id:"modipress-multitap-start",resolutionPriority:6,contacts:[{model:W(C({},Lo()),{pathInheritance:"reject",allowsInitialState(n,t,i){return n.item!=i?!1:si(i)},itemChangeAction:"reject",itemPriority:1})}],sustainTimer:{duration:g.multitap.waitLength,expectedResult:!1,baseItem:"base"},resolutionAction:{type:"chain",next:"modipress-multitap-end",selectionMode:"modipress",item:"current"}}}a(ig,"modipressMultitapStartModel");function lg(g){return{id:"modipress-multitap-end",resolutionPriority:5,contacts:[{model:W(C({},Jo()),{itemChangeAction:"reject",pathInheritance:"full",timer:{duration:g.multitap.holdLength,expectedResult:!1}})},{model:C({},wc()),resetOnInstantFulfill:!0}],resolutionAction:{type:"chain",next:"modipress-multitap-start",item:"none"},rejectionActions:{timer:{type:"replace",replace:"modipress-multitap-lock-transition"},path:{type:"replace",replace:"modipress-multitap-lock-transition"}}}}a(lg,"modipressMultitapEndModel");function sg(){return{id:"modipress-multitap-lock-transition",resolutionPriority:5,contacts:[{model:W(C({},Le()),{pathResolutionAction:"resolve"})}],resolutionAction:{type:"chain",next:"modipress-end",selectionMode:"modipress",item:"none"}}}a(sg,"modipressMultitapLockModel");var To=W(C({},oe(Mc(null))),{resolutionAction:{type:"complete",item:"current"}}),wo={gestures:[To],sets:{default:[To.id]}};function Zl(g){var n;return typeof g=="string"?n=g:(n=g.style.fontSize,n||(n=getComputedStyle(g).fontSize)),new Z(n)}a(Zl,"getFontSizeStyle");function Mo(g,n,t){if(g.touchable){let i=g.formFactor=="phone"?1.6*(t?.65:.6)*1.2:2;return Z.special(i,"em")}else return n?Z.inPixels(n/8):void 0}a(Mo,"defaultFontSize");var ci;function Xl(g,n,t){t={fontFamily:t.fontFamily,fontSize:t.fontSize},t.fontFamily||(t.fontFamily=getComputedStyle(document.body).fontFamily),(!t.fontSize||t.fontSize=="")&&(t.fontSize="1em");let i=t.fontFamily,l=Zl(t.fontSize);var s;l.absolute?s=l.val+"px":s=l.val*n+"px",ci=ci!=null?ci:document.createElement("canvas");var c=ci.getContext("2d");c.font=s+" "+i;var r=c.measureText(g);return r}a(Xl,"getTextMetrics");var cg=10,Kc=class Kc{constructor(n,t){this.totalLength=0;this.baseCoord=n,this.curCoord=n,this.baseScrollLeft=t,this.totalLength=0}updateTo(n){let t=this.curCoord;this.curCoord=n;let i=this.baseCoord.targetX-this.curCoord.targetX+this.baseScrollLeft;return this.totalLength+=Math.abs(this.curCoord.targetX-t.targetX),i}get hasScrolled(){return this.totalLength>cg}};a(Kc,"BannerScrollState");var Vl=Kc;var Ko="kmw-suggest-touched",rg="kmw-suggest-banner-scroller",zo=.666,Do="swallow-fade-transition",ri=class ri{constructor(n,t){this.index=n,this.rtl=t!=null?t:!1,this.constructRoot();let i=this.display=J("span");i.className="kmw-suggestion-text",this.container.appendChild(i)}get computedStyle(){return getComputedStyle(this.display)}constructRoot(){let n=this.div=J("div");n.className="kmw-suggest-option",n.id=ri.BASE_ID+this.index,this.div.suggestion=this;let t=this.container=document.createElement("div");t.className="kmw-suggestion-container";let l=(100-Je.MARGIN*(Je.LONG_SUGGESTION_DISPLAY_LIMIT-1))/Je.LONG_SUGGESTION_DISPLAY_LIMIT;t.style.minWidth=l+"%",n.appendChild(t)}matchKeyboardProperties(n){let t=this.div;if(n){n.KLC&&(t.lang=n.KLC);let i=n.KFont;i&&i.family&&i.family!=""&&(t.style.fontFamily=i.family)}}get suggestion(){return this._suggestion}update(n,t){this._suggestion=n;let i=this.generateSuggestionText(this.rtl);if(this.container.replaceChild(i,this.display),this.display=i,t.minWidth!==void 0&&(this._minWidth=t.minWidth),this._paddingWidth=t.paddingWidth,this._collapsedWidth=t.collapsedWidth,n&&n.displayAs){let l=Xl(n.displayAs,t.emSize,t.styleForFont);this._textWidth=l.width}else this._textWidth=0;this.currentWidth=this.collapsedWidth,this.updateLayout()}updateLayout(){if(!this.suggestion&&this.index!=0){this.div.style.width="0px";return}else this.div.style.width="";let n=this.container.style;n.minWidth=this.collapsedWidth+"px",this.rtl?n.marginRight=this.collapsedWidth-this.expandedWidth+"px":n.marginLeft=this.collapsedWidth-this.expandedWidth+"px",this.updateFade()}updateFade(){this.div.classList.add(Do),window.requestAnimationFrame(()=>{this.div.classList.remove(Do)}),this.div.classList.add(`kmw-hide-fade-${this.rtl?"left":"right"}`);let n=`kmw-hide-fade-${this.rtl?"right":"left"}`;this.expandedWidth-this.collapsedWidth?this.div.classList.remove(n):this.div.classList.add(n)}get targetCollapsedWidth(){return this._collapsedWidth}get textWidth(){return this._textWidth}get paddingWidth(){return this._paddingWidth}get minWidth(){return this._minWidth}set minWidth(n){this._minWidth=n}get expandedWidth(){return this.minWidth>this.spanWidth?this.minWidth:this.spanWidth}get spanWidth(){var t,i;let n=(t=this.textWidth)!=null?t:0;return n&&(n+=(i=this.paddingWidth)!=null?i:0),n}get collapsedWidth(){let n=this.spanWidth<this.targetCollapsedWidth?this.spanWidth:this.targetCollapsedWidth,t=n<this.expandedWidth?n:this.expandedWidth;return this.minWidth>t?this.minWidth:t}get currentWidth(){return this.div.offsetWidth}set currentWidth(n){n<this.collapsedWidth?n=this.collapsedWidth:n>this.expandedWidth&&(n=this.expandedWidth),this.rtl?this.container.style.marginRight=`${n-this.expandedWidth}px`:this.container.style.marginLeft=`${n-this.expandedWidth}px`}highlight(n){let t=this.div;n?t.classList.add(Ko):t.classList.remove(Ko)}isEmpty(){return!this._suggestion}generateSuggestionText(n){let t=this._suggestion;var i,l=J("span");if(l.className="kmw-suggestion-text",t==null)return l;if(t.displayAs==null||t.displayAs=="")i=" ";else{let s=n?8238:8237;i=String.fromCharCode(s)+t.displayAs}return l.innerHTML=i,l}};a(ri,"BannerSuggestion"),ri.BASE_ID="kmw-suggestion-";var zc=ri,O=class O extends ue{constructor(t,i){super(i||ue.DEFAULT_HEIGHT);this.type="suggestion";this.currentSuggestions=[];this.options=[];this.separators=[];this.isRTL=!1;this.onSuggestionUpdate=a(t=>{var b;this.currentSuggestions=t,(b=this.highlightAnimation)==null||b.cancel();let i=this.options[0].computedStyle,l={fontSize:i.fontSize,fontFamily:i.fontFamily},s=getComputedStyle(document.body).fontSize,c=Zl(s).val,r=getComputedStyle(this.options[0].container.firstChild),o=this.width/O.LONG_SUGGESTION_DISPLAY_LIMIT,d=new Z(r.paddingLeft||"4px"),u=new Z(r.paddingRight||"4px"),B={paddingWidth:d.val+u.val,emSize:c,styleForFont:l,collapsedWidth:o,minWidth:0};for(let I=0;I<O.SUGGESTION_LIMIT;I++){let F=this.options[I];if(t.length>I){let h=t[I];F.update(h,B),this.predictionContext.selected==h&&F.highlight(!0)}else F.update(null,B)}this.refreshLayout()},"onSuggestionUpdate");this.refreshLayout=a(()=>{let t=[],i=0,l=Math.min(this.currentSuggestions.length,8);for(let s=0;s<l;s++){let c=this.options[s];c.minWidth=0,i+=c.collapsedWidth,c.collapsedWidth<c.expandedWidth&&t.push(c)}if(l=l||1,i<this.width){let s=this.width*.01*(l-1);for(;i<this.width&&t.length>0;){let r=(this.width-i-s)/t.length;t.sort((B,b)=>B.expandedWidth-b.expandedWidth);let o=t[0],d=o.expandedWidth-o.collapsedWidth,u=Math.min(d,r);u>0&&(t.forEach(B=>B.minWidth=B.collapsedWidth+u),i+=u*t.length),t.splice(0,1)}let c=(this.width-i-s)/l;for(let r=0;r<l;r++){let o=this.options[r];o.minWidth=o.collapsedWidth+c,o.updateLayout()}}for(let s=0;s<O.SUGGESTION_LIMIT-1;s++)this.separators[s].style.display=s<l-1?"":"none"},"refreshLayout");this.getDiv().className=this.getDiv().className+" "+O.BANNER_CLASS,this.container=document.createElement("div"),this.container.className=rg,this.getDiv().appendChild(this.container),this.buildInternals(!1),this.gestureEngine=this.setupInputHandling()}shutdown(){this.gestureEngine.destroy()}buildInternals(t){this.isRTL=t,this.options.length>0&&(this.options=[],this.separators=[]);for(var i=0;i<O.SUGGESTION_LIMIT;i++){let l=new zc(i,t);this.options[i]=l}for(var i=0;i<O.SUGGESTION_LIMIT;i++){let s=t?O.SUGGESTION_LIMIT-i-1:i;if(this.container.appendChild(this.options[s].div),t&&(this.container.scrollLeft=this.container.scrollWidth),i!=O.SUGGESTION_LIMIT-1){let c=J("div");c.className="kmw-banner-separator";let r=c.style;r.marginLeft=`calc(${O.MARGIN/2}% - 0.5px)`,r.marginRight=`calc(${O.MARGIN/2}% - 0.5px)`,this.container.appendChild(c),this.separators[s-(t?1:0)]=c}}}setupInputHandling(){let t=new Be(this.getDiv(),[-Number.MAX_SAFE_INTEGER]);this.selectionBounds=new Be(this.getDiv(),[-zo*this.height,-Number.MAX_SAFE_INTEGER]);let i={targetRoot:this.getDiv(),maxRoamingBounds:t,safeBounds:t,itemIdentifier:o=>{let d=this.selectionBounds.getBoundingClientRect();if(o.clientX<d.left||o.clientX>d.right||o.clientY<d.top||o.clientY>d.bottom)return null;let u=null,B=Number.MAX_VALUE;for(let b of this.options){let I=b.div.getBoundingClientRect();if(I.left<=o.clientX&&o.clientX<I.right)return b.suggestion?b:null;{let F=(o.clientX<I.left?-1:1)*(o.clientX-I.left);F<B&&(B=F,u=b)}}return u.suggestion?u:null}},l=new At(wo,i),s={source:null,scrollingHandler:null,suggestion:null},c=a(o=>{o.highlight(!0),this.highlightAnimation&&(this.highlightAnimation.cancel(),this.highlightAnimation.decouple()),this.highlightAnimation=new Sl(this.container,o,!1),this.highlightAnimation.expand()},"markSelection"),r=a(o=>{o.highlight(!1),this.highlightAnimation||(this.highlightAnimation=new Sl(this.container,o,!1)),this.highlightAnimation.collapse()},"clearSelection");return l.on("inputstart",o=>{if(s.source){o.terminate(!0);return}let d=this._predictionContext.selected;this._predictionContext.selected=null,this.options.forEach(b=>{b.highlight(!1)}),this.scrollState=new Vl(o.currentSample,this.container.scrollLeft);let u=o.baseItem;s.source=o,s.scrollingHandler=b=>{var h;let I=this.scrollState.updateTo(b);(h=this.highlightAnimation)==null||h.setBaseScroll(I);let F=b.item?u:null;F!=s.suggestion&&(s.suggestion&&r(s.suggestion),s.suggestion=F,F&&c(F))},s.suggestion=o.currentSample.item,s.suggestion&&c(s.suggestion);let B=a(()=>{let b=this.currentSuggestions;ge(0).then(()=>A(this,null,function*(){if(b==this.currentSuggestions&&(this._predictionContext.selected=d,d)){for(let I of this.options)if(I.suggestion==d){I.highlight(!0);break}}})),s.suggestion&&(r(s.suggestion),s.suggestion=null),s.source=null,s.scrollingHandler=null},"terminationHandler");o.path.on("complete",B),o.path.on("invalidated",B),o.path.on("step",s.scrollingHandler)}),l.on("recognizedgesture",o=>{o.once("stage",d=>{let u=d.item;u&&!this.scrollState.hasScrolled&&this.currentSuggestions.length>0&&(this.currentSuggestions=[],this.predictionContext.accept(u.suggestion).then(()=>{this.container.scrollLeft=this.isRTL?this.container.scrollWidth:0})),this.scrollState=null})}),l}update(){var i;let t=super.update();return(i=this.selectionBounds)==null||i.updatePadding([-zo*this.height,-Number.MAX_SAFE_INTEGER]),t}configureForKeyboard(t,i){let l=t.isRTL;this.container.textContent="",this.buildInternals(l),this.options.forEach(s=>s.matchKeyboardProperties(i)),this.onSuggestionUpdate(this.currentSuggestions)}get predictionContext(){return this._predictionContext}set predictionContext(t){this._predictionContext&&this._predictionContext.off("update",this.onSuggestionUpdate),this._predictionContext=t,t&&(t.on("update",this.onSuggestionUpdate),this.onSuggestionUpdate(t.currentSuggestions))}};a(O,"SuggestionBanner"),O.SUGGESTION_LIMIT=8,O.LONG_SUGGESTION_DISPLAY_LIMIT=3,O.MARGIN=1;var Je=O,ye=class ye{constructor(n,t,i){this.setScrollOffset=a(()=>{if(!this.scrollContainer)return;let n=this.option.currentWidth-this.option.collapsedWidth,t=this.option.rtl,i=Math.max(this.rootScrollOffset-this.option.div.offsetLeft,0),l=Math.max(this.option.div.offsetLeft+this.option.collapsedWidth-(this.rootScrollOffset+this.scrollContainer.offsetWidth)),s=Math.max(t?l:i,0),c=Math.max(this.collapsedScrollOffset+(t?0:1)*n,0)+(t?0:-1)*s,r=Math.max(this.rootScrollOffset+(t?0:1)*n,0)+(t?0:-1)*s,o=t?Math.max(c,r):Math.min(c,r),d=Math.max(t?this.option.div.offsetLeft+this.option.currentWidth-(o+this.scrollContainer.offsetWidth):o-this.option.div.offsetLeft,0),u=Math.min(n,d),B=c+(t?1:-1)*u+(t?0:1)*s;if(this.scrollContainer.scrollLeft=B,this.pendingAnimation){let b=this.scrollContainer.scrollLeft-B;this.option.currentWidth+=b}},"setScrollOffset");this._expand=a(n=>{if(this.startTimestamp===void 0)return;let t=n-this.startTimestamp,i=t>ye.TRANSITION_TIME;i&&(t=ye.TRANSITION_TIME);let l=this.option.expandedWidth-this.option.collapsedWidth,s=t/ye.TRANSITION_TIME,c=l*s;this.option.currentWidth=c+this.option.collapsedWidth,i?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._expand),this.setScrollOffset()},"_expand");this._collapse=a(n=>{if(this.startTimestamp===void 0)return;let t=n-this.startTimestamp,i=t>ye.TRANSITION_TIME;i&&(t=ye.TRANSITION_TIME);let l=this.option.expandedWidth-this.option.collapsedWidth,s=1-t/ye.TRANSITION_TIME,c=l*s;this.option.currentWidth=c+this.option.collapsedWidth,i?this.clear():this.pendingAnimation=window.requestAnimationFrame(this._collapse),this.setScrollOffset()},"_collapse");this.scrollContainer=n,this.option=t,this.collapsedScrollOffset=n.scrollLeft,this.rootScrollOffset=n.scrollLeft}setBaseScroll(n){this.collapsedScrollOffset=n,this.option.rtl?n>this.rootScrollOffset&&(this.rootScrollOffset=n):n<this.rootScrollOffset&&(this.rootScrollOffset=n),window.requestAnimationFrame(this.setScrollOffset)}decouple(){this.cancel(),this.scrollContainer=null}clear(){this.startTimestamp=null,window.cancelAnimationFrame(this.pendingAnimation),this.pendingAnimation=null}cancel(){this.clear(),this.option.currentWidth=this.option.collapsedWidth}expand(){this.clear(),this.startTimestamp=performance.now();let n=this.option.currentWidth-this.option.collapsedWidth,t=this.option.expandedWidth-this.option.collapsedWidth;n!=0&&(this.startTimestamp-=n/t*ye.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._expand)}collapse(){this.clear(),this.startTimestamp=performance.now();let n=this.option.expandedWidth-this.option.currentWidth,t=this.option.expandedWidth-this.option.collapsedWidth;n!=0&&(this.startTimestamp-=n/t*ye.TRANSITION_TIME),this.pendingAnimation=window.requestAnimationFrame(this._collapse)}};a(ye,"SuggestionExpandContractAnimation"),ye.TRANSITION_TIME=250;var Sl=ye;var Dc=class Dc extends ue{constructor(t){super();this.type="html";let i=this.getDiv(),l=document.createElement("div");l.style.userSelect="none",l.style.height="100%",l.style.width="100%",i.appendChild(l),this.container=l.attachShadow?l.attachShadow({mode:"closed"}):l,this.container.innerHTML=t}get innerHTML(){return this.container.innerHTML}set innerHTML(t){this.container.innerHTML=t}};a(Dc,"HTMLBanner");var Wl=Dc;var Oc=class Oc{constructor(n,t,i){this.ImageBanner=ol;this.HTMLBanner=Wl;this.hostDevice=t,this.container=n,this.predictionContext=i,this.inactiveBanner=new ot}get inactiveBanner(){return this._inactiveBanner}set inactiveBanner(n){this._inactiveBanner=n!=null?n:new ot,this.container.banner instanceof Je||(this.container.banner=this._inactiveBanner)}activateBanner(n){let t=this.container.banner;if(t instanceof Je&&(t.predictionContext=null),!n)this.container.banner=this.inactiveBanner;else{let i=new Je(this.hostDevice,this.container.activeBannerHeight);i.predictionContext=this.predictionContext,this.container.banner=i}}selectBanner(n){this.activateBanner(n=="active"||n=="configured"),this.keyboard&&this.container.banner.configureForKeyboard(this.keyboard,this.keyboardStub)}configureForKeyboard(n,t){this.keyboard=n,this.keyboardStub=t,this.container.banner.configureForKeyboard(n,t)}shutdown(){this.container.banner instanceof Je&&(this.container.banner.predictionContext=null)}};a(Oc,"BannerController");var oi=Oc;var Pc=class Pc{constructor(){let n=this.element=document.createElement("div");n.style.userSelect="none",n.className="kmw-osk-none"}postInsert(){}updateState(){}refreshLayout(){}get layoutHeight(){return Z.inPixels(0)}};a(Pc,"EmptyView");var Rt=Pc;var un=class un{constructor(n){this.kbd=n;var t=this.element=document.createElement("div");t.style.userSelect="none",t.className="kmw-osk-static",t.id=un.ID,t.innerHTML=n.helpText}postInsert(){if(!this.element.parentElement||!document.getElementById(un.ID))throw new Error("The HelpPage root element has not yet been inserted into the DOM.");this.kbd.hasScript&&this.kbd.embedScript(this.element.parentElement)}updateState(){}refreshLayout(){}get layoutHeight(){return Z.inPercent(100)}};a(un,"HelpPageView"),un.ID="kmw-osk-help-page";var ai=un;var _c=class _c{constructor(n,t,i){this.keySpec=i,this.centerX=i.proportionalX,this.centerY=t.proportionalY,this.width=i.proportionalWidth,this.height=n.rowProportionalHeight}};a(_c,"CorrectiveBaseKeyLayout");var jc=_c;function Al(g){return g.baseKeyID?Q.isFrameKey(g.baseKeyID)?!1:!g.isPadding:!1}a(Al,"correctionKeyFilter");function Oo(g,n){return{keys:g.row.map(t=>t.key.map(i=>new jc(g,t,i))).reduce((t,i)=>t.concat(i),[]).filter(t=>Al(t.keySpec)),kbdScaleRatio:n}}a(Oo,"buildCorrectiveLayout");var og={"*Shift*":8,"*Enter*":5,"*Tab*":6,"*BkSp*":4,"*Menu*":11,"*Hide*":10,"*Alt*":25,"*Ctrl*":1,"*Caps*":3,"*ABC*":16,"*abc*":17,"*123*":19,"*Symbol*":21,"*Currency*":20,"*Shifted*":9,"*AltGr*":2,"*TabLeft*":7,"*LAlt*":86,"*RAlt*":87,"*LCtrl*":88,"*RCtrl*":89,"*LAltCtrl*":96,"*RAltCtrl*":97,"*LAltCtrlShift*":98,"*RAltCtrlShift*":99,"*AltShift*":100,"*CtrlShift*":101,"*AltCtrlShift*":102,"*LAltShift*":103,"*RAltShift*":104,"*LCtrlShift*":105,"*RCtrlShift*":112,"*LTREnter*":5,"*LTRBkSp*":4,"*RTLEnter*":113,"*RTLBkSp*":114,"*ShiftLock*":115,"*ShiftedLock*":116,"*ZWNJ*":117,"*ZWNJiOS*":117,"*ZWNJAndroid*":118,"*ZWNJGeneric*":121,"*Sp*":128,"*NBSp*":130,"*NarNBSp*":131,"*EnQ*":132,"*EmQ*":133,"*EnSp*":134,"*EmSp*":135,"*PunctSp*":140,"*ThSp*":141,"*HSp*":142,"*ZWSp*":129,"*ZWJ*":119,"*WJ*":120,"*CGJ*":122,"*LTRM*":144,"*RTLM*":145,"*SH*":161,"*HTab*":162},qc=og;var ag=["default","shift","shift-on","special","special-on","","","","deadkey","blank","hidden"],Ht=ag;function vt(g,n){switch(g){case"*ZWNJ*":g=n.device.OS==S.OperatingSystem.Android?"*ZWNJAndroid*":"*ZWNJiOS*";break;case"*Enter*":g=n.isRTL?"*RTLEnter*":"*LTREnter*";break;case"*BkSp*":g=n.isRTL?"*RTLBkSp*":"*LTRBkSp*";break;default:}let t=qc[g],i=57344+t;return t?String.fromCharCode(i):g}a(vt,"renameSpecialKey");var De=class De{constructor(n,t){this.spec=n,this.layer=t}setButtonClass(){var l;let n=this.spec,t=this.btn;var i=0;typeof n.dk=="string"&&n.dk=="1"&&(i=8),i=(l=n.sp)!=null?l:i,(i<0||i>10)&&(i=0),t.className="kmw-key kmw-key-"+Ht[i]}setToggleState(n){let t;switch(t=this.spec.sp,Ht[t]){case"shift":case"shift-on":n===void 0&&(n=Ht[t]=="shift"),this.spec.sp=1+(n?1:0);break;case"special":case"special-on":n===void 0&&(n=Ht[t]=="special"),this.spec.sp=3+(n?1:0);break;default:return}this.setButtonClass()}isFrameKey(){let n=this.spec.sp||0;switch(Ht[n]){case"default":case"deadkey":return!1;default:return!0}}allowsKeyTip(){return this.isFrameKey()?!1:!this.btn.classList.contains("kmw-spacebar")}highlight(n){var t=this.btn.classList;n?t.contains(De.HIGHLIGHT_CLASS)||t.add(De.HIGHLIGHT_CLASS):t.remove(De.HIGHLIGHT_CLASS)}getIdealFontSize(n,t,i){if(!this._fontFamily)return new Z("1em");i!=null||(i=1);let l=t.keyWidth,s=t.keyHeight,c=t.baseEmFontSize.scaledBy(t.layoutFontSize.val),r=this._fontSize;r.absolute||(r=c.scaledBy(r.val));let o={fontFamily:this._fontFamily,fontSize:r.styleString,height:t.keyHeight},d=Xl(n,c.scaledBy(i).val,o),u=.9,B=.9,b=2;var I;d.fontBoundingBoxAscent&&(I=d.fontBoundingBoxAscent+d.fontBoundingBoxDescent);let F=I!=null?I:0,h=l*u/(d.width+b),y=F&&s?s*B/F:void 0;var U=h;return y&&y<h&&(U=y),Z.forScalar(i*Math.min(U,1))}get keyText(){let n=this.spec,t=" ",i=null;return n.text==null||n.text==""?i=t:(i=n.text,i=="*Tab*"&&this.layer=="shift"&&(i="*TabLeft*")),i}generateKeyText(n){let t=this.spec,i=document.createElement("span"),l=i.style;i.className="kmw-key-text";let s=this.keyText,c=vt(s,n);c!=s&&(s=c,t.font="SpecialOSK"),typeof t.font=="string"&&t.font!=""&&(l.fontFamily=t.font),typeof t.fontsize=="string"&&t.fontsize!=""&&(l.fontSize=t.fontsize);let r={fontSize:l.fontSize};return l.fontFamily?r.fontFamily=l.fontFamily:r.fontFamily=n.fontFamily,n.isRTL&&(s="‏"+s),i.innerText=s,i}resetFontPrecalc(){this._fontFamily=void 0,this._fontSize=void 0,this.label.style.fontSize=""}detectStyles(n){if(!(this.spec.sp==k.spacer||this.spec.sp==k.blank)&&this._fontFamily===void 0){let t=getComputedStyle(this.label);if(!t.fontFamily)return;this._fontFamily=t.fontFamily;let i=new Z(t.fontSize),l=n.layoutFontSize;if(l.absolute)this._fontSize=i;else{let s=n.baseEmFontSize,c=l.scaledBy(s.val),r=i.val/c.val;this._fontSize=Z.forScalar(r)}}}refreshLayout(n){if(this.label)if(this.label.classList.contains("kmw-spacebar-caption")){let t=this.getIdealFontSize(this.keyText,n);this.label.style.setProperty("font-size",t.styleString,"important")}else{let t=this.label.textContent,i=this.getIdealFontSize(t,n);this.label.style.fontSize=i.styleString}}};a(De,"OSKKey"),De.specialCharacters=qc,De.BUTTON_CLASSES=Ht,De.HIGHLIGHT_CLASS="kmw-key-touched";var ke=De;var $c=class $c{constructor(n,t){this.key=n,this.keyId=t}};a($c,"KeyData");var Bn=$c;function Rl(g,n){let t=g;for(let i in n)t.hasOwnProperty(i)||(t[i]=n[i]);return t}a(Rl,"link");var er=class er extends ke{constructor(t,i,l){super(t,i);this.row=l}getId(){return this.spec.elementID}getCoreId(){return this.spec.coreID}getBaseId(){return this.spec.baseKeyID}generateKeyCapLabel(){var t=Q.keyCodes[this.spec.baseKeyID];switch(t){case 186:t=59;break;case 187:t=61;break;case 188:t=44;break;case 189:t=45;break;case 190:t=46;break;case 191:t=47;break;case 192:t=96;break;case 219:t=91;break;case 220:t=92;break;case 221:t=93;break;case 222:t=39;break;default:(t<48||t>90)&&(t=0)}let i=document.createElement("div");return i.className="kmw-key-label",t>0&&(i.innerText=String.fromCharCode(t)),i}processSubkeys(t,i){var l,s=t.subKeys=this.spec.sk;for(l=0;l<s.length;l++){if(s[l].sp==1||s[l].sp==2){var c=s[l].text;s[l].text=vt(c,i)}s[l].layer||(s[l].layer=t.key.layer)}}construct(t){let i=this.spec,l=document.createElement("div");l.className="kmw-key-square";let s=document.createElement("div"),c=this.btn=Rl(s,new Bn(this,i.id));this.setButtonClass();let r=this.capLabel=this.generateKeyCapLabel();c.appendChild(r),c.id=this.getId(),c.appendChild(this.label=this.generateKeyText(t)),typeof i.sk!="undefined"&&i.sk!=null?this.processSubkeys(c,t):c.subKeys=null;let o=this.generateHint(t);return c.appendChild(o),l.appendChild(c),this.preview=document.createElement("div"),this.preview.style.display="none",c.appendChild(this.preview),this.square=l}generateHint(t){let i=document.createElement("div");i.className="kmw-key-popup-icon";let l=this.spec.hintSrc;if(!l)return i;if(l.font&&l.font!="SpecialOSK"?i.style.fontFamily=l.font:i.classList.add("kmw-key-text"),l.fontsize){let r=new Z(l.fontsize);i.style.fontSize=r.scaledBy(.5).styleString}let s=l==this.spec?this.spec.hint:l.text,c=vt(s,t);return c=="•"&&(i.style.fontWeight="bold"),s!=c&&(i.style.fontFamily="SpecialOSK"),i.textContent=c,i}setPreview(t){let i=this.preview;t?(this.previewHost=t,this.preview=this.previewHost.element):(this.previewHost=null,this.preview=document.createElement("div"),this.preview.style.display="none"),t==null||t.setCancellationHandler(()=>{this.setPreview(null)}),this.btn.replaceChild(this.preview,i)}refreshLayout(t){super.refreshLayout(t),t.baseEmFontSize.val<12?this.capLabel.style.fontSize="6px":this.capLabel.style.fontSize=Z.forScalar(.5).styleString}get displaysKeyCap(){return this.capLabel&&this.capLabel.style.display=="block"}set displaysKeyCap(t){if(!this.capLabel)throw new Error("Key element not yet constructed; cannot display key cap");this.capLabel.style.display=t?"block":"none"}};a(er,"OSKBaseKey");var gi=er;var Hl=.15,tr=class tr{constructor(n,t,i){let l=this.element=document.createElement("div");l.className="kmw-key-row",this.heightFraction=1/t.row.length;let s=i.key;this.spec=i,this.keys=[];for(let o=0;o<s.length;o++){let d=s[o];var c=new gi(d,t.id,this),r=c.construct(n);this.keys.push(c),l.appendChild(r)}}get displaysKeyCaps(){if(this.keys.length>0)return this.keys[0].displaysKeyCap}set displaysKeyCaps(n){for(let t of this.keys)t.displaysKeyCap=n}refreshLayout(n){let t=this.element.style,i=n.heightStyle.scaledBy(this.heightFraction);t.maxHeight=t.lineHeight=t.height=i.styleString;let l=n.heightStyle.absolute?i:Z.forScalar(1),s=l.scaledBy(Hl/2),c=l.scaledBy(1-Hl);this.keys.forEach(r=>{let o=r.square,d=r.btn,u=o.style;u.height=u.minHeight=l.styleString;let B=d.style;B.top=s.styleString,B.height=B.lineHeight=B.minHeight=c.styleString})}buildKeyLayout(n,t){let i=n.widthStyle.scaledBy(t.spec.proportionalWidth),l=n.heightStyle.scaledBy(this.heightFraction).scaledBy(1-Hl);return{keyWidth:i.val*(i.absolute?1:n.keyboardWidth),keyHeight:l.val*(l.absolute?1:n.keyboardHeight),baseEmFontSize:n.baseEmFontSize,layoutFontSize:n.layoutFontSize}}detectStyles(n){this.keys.forEach(t=>{t.detectStyles(this.buildKeyLayout(n,t))})}refreshKeyLayouts(n){this.keys.forEach(t=>{var B;let i=t.btn,l=n.widthStyle,s=n.heightStyle,c=l.scaledBy(t.spec.proportionalWidth),r=l.scaledBy(t.spec.proportionalPad),o=s.scaledBy(this.heightFraction).scaledBy(1-Hl),d=s.absolute?o.styleString:"100%",u=this.buildKeyLayout(n,t);(B=i.key)==null||B.refreshLayout(u),t.square.style.width=c.styleString,t.square.style.marginLeft=r.styleString,t.btn.style.width=l.absolute?c.styleString:"100%",t.square.style.height=d})}};a(tr,"OSKRow");var di=tr;var nr=class nr{get rowHeight(){return this._rowHeight}get id(){return this.spec.id}constructor(n,t,i){this.spec=i;let l=this.element=document.createElement("div"),s=l.style;l.className="kmw-key-layer";var c=i.row.length;c>4&&n.device.formFactor=="phone"&&(l.className=l.className+" kmw-5rows"),s.fontFamily="font"in t?t.font:"",this.nextlayer=i.id,l.layer=i.id,typeof i.nextlayer=="string"&&(l.nextLayer=this.nextlayer=i.nextlayer);let r=i.row;this.rows=[];for(let o=0;o<r.length;o++){let d=new di(n,i,r[o]);d.displaysKeyCaps=t.displayUnderlying,l.appendChild(d.element),this.rows.push(d)}if(n.device.touchable&&(this.globeKey=this.findKey("K_LOPT"),this.hideKey=this.findKey("K_ROPT")),this.spaceBarKey=this.findKey("K_SPACE"),this.capsKey=this.findKey("K_CAPS"),this.numKey=this.findKey("K_NUMLOCK"),this.scrollKey=this.findKey("K_SCROLL"),this.spaceBarKey){let o=this.spaceBarKey.label,d=this.spaceBarKey.btn;typeof d.className=="undefined"||d.className==""?d.className="kmw-spacebar":d.className.indexOf("kmw-spacebar")==-1&&(d.className+=" kmw-spacebar"),o.className!="kmw-spacebar-caption"&&(o.className="kmw-spacebar-caption")}}findKey(n){for(let t of this.rows)for(let i of t.keys)if(i.getBaseId()==n)return i;return null}showLanguage(n){if(this.spaceBarKey)try{let t=this.spaceBarKey.label;this.spaceBarKey.spec.text=n,(t.innerText!=n||n=="")&&(t.innerText=n)}catch(t){}}refreshLayout(n){this.rows.forEach(c=>c.detectStyles(n));let t=n.keyboardHeight,i=this.rows.length,l=this._rowHeight=Math.floor(t/(i==0?1:i)),s=n.widthStyle.absolute;s&&(this.element.style.height=t+"px"),this.showLanguage(n.spacebarText);for(let c=0;c<i;c++){let r=this.rows[c],o=(i-c-1)*l+1;s&&(this.spec.row[c].proportionalY=(t-o-l/2)/t),r.refreshLayout(n),c==i-1&&(r.element.style.bottom="1px")}for(let c of this.rows)c.refreshKeyLayouts(n)}};a(nr,"OSKLayer");var ui=nr;var gg=.06,ir=class ir{constructor(n,t,i){this._layers={};this._activeLayerId="default";let l=t.layout(i);this.spec=l,this.vkbd=n;let s=this.element=document.createElement("div"),c=s.style;if(s.className="kmw-key-layer-group",l==null)return;let r=l.fontsize;typeof r=="undefined"||r==null||r==""?c.fontSize="1em":c.fontSize=l.fontsize,c.width="100%",c.height="100%",this.activeLayerId="default"}buildLayer(n){let t=this.spec,i=t.getLayer(n);if(!i)return null;let l=new ui(this.vkbd,t,i);return this._layers[n]=l,this.element.appendChild(l.element),l}getLayer(n){let t=this._layers[n];return t||(t=this.buildLayer(n),t&&(this._layers[n]=t,t.element.style.display="none")),t}get activeLayer(){return this.activeLayerId?this._layers[this.activeLayerId]:null}get layers(){let t=this.spec.layer.map(i=>i.id);for(let i of t)this.buildLayer(i);return this._layers}get activeLayerId(){return this._activeLayerId}set activeLayerId(n){this._activeLayerId=n,this.getLayer(n);for(let t of Object.keys(this._layers)){let i=this._layers[t],l=i.element;i.id==n?l.style.display="block":l.style.display="none"}}findNearestKey(n){if(!n)return null;let t=n.stateToken;if(!t)throw new Error("Layer id not set for input coordinate");let i=this._layers[t];if(!i)throw new Error(`Layer id ${t} could not be found`);return this.nearestKey(n,i)}blinkLayer(n){if(typeof n=="string"){let i=n;if(n=this.getLayer(i),!n)throw new Error(`Layer id ${i} could not be found`)}let t=n;if(t.element.style.display!="block")for(let i in this._layers){if(this._layers[i].element.style.display=="block"){let l=this._layers[i];l.element.style.display="none"}this._layers[i].element.style.display="none"}t.element.style.display="block",Promise.resolve().then(()=>{let i=this._layers[this._activeLayerId];(t.element.style.display=="block"||i.element.style.display!="block")&&(t.element.style.display="none",i.element.style.display="block")})}nearestKey(n,t){if(t.rows.length==0)return null;let i={x:n.targetX/this.computedWidth,y:n.targetY/this.computedHeight};if(!isFinite(i.x)||!isFinite(i.y))return null;let l=Math.max(0,Math.min(t.rows.length-1,Math.floor(i.y*t.rows.length))),s=t.rows[l],c=null,r=Number.MAX_VALUE;for(let o of s.keys){let d=o.spec;if(d.sp==k.blank||d.sp==k.spacer)continue;let u=d.proportionalWidth/2,B=Math.abs(i.x-d.proportionalX);if(B-u<=0)return o.btn;{let b=B-u;b<r&&(r=b,c=o)}}return r<=gg?c.btn:null}resetPrecalcFontSizes(){for(let n of Object.values(this._layers))for(let t of n.rows)for(let i of t.keys)i.resetFontPrecalc();this._heightPadding=void 0}refreshLayout(n){if(!(isNaN(n.keyboardWidth)||isNaN(n.keyboardHeight))){if(this.computedWidth=n.keyboardWidth,this.computedHeight=n.keyboardHeight,this._heightPadding===void 0){let t=getComputedStyle(this.element),i=parseInt(t.paddingTop,10)||0,l=parseInt(t.paddingBottom,10)||0;this._heightPadding=i+l}this.activeLayer&&this.activeLayer.refreshLayout(n)}}get verticalPadding(){var n;return(n=this._heightPadding)!=null?n:0}};a(ir,"OSKLayerGroup");var Bi=ir;var Po="kmw-",jo="top",lr=class lr{constructor(n,t){this.state=!1;this.orientation=jo;this.vkbd=n;let i=this.element=document.createElement("div");i.className="kmw-keytip",i.id="kmw-keytip",i.style.pointerEvents="none",i.style.display="none",i.appendChild(this.tip=document.createElement("div")),i.appendChild(this.cap=document.createElement("div")),this.tip.appendChild(this.preview=document.createElement("div")),this.tip.className="kmw-keytip-tip",this.cap.className="kmw-keytip-cap",this.constrain=t,this.reorient=l=>{this.orientation=l,this.show(this.key,this.state,this.previewHost)}}show(n,t,i){var r;let l=this.vkbd;if(t&&l.layerGroup.blinkLayer(n.key.spec.displayLayer),t&&n.offsetParent){let o=n.key.row.element,d=n.getClientRects()[0],u=o.getClientRects()[0],B=d.left-u.left,b=d.width,I=d.height,F=1.8,h=this.element.style,U=l.topContainer.getBoundingClientRect(),x=n.getBoundingClientRect(),G,p=this.orientation,R=x.bottom-U.top;G=R+(p=="top"?1:-1);let f=G-Math.floor(G),v=b+Math.ceil(b*.3)*2,w=Math.ceil(2.3*I)+f;p=="bottom"&&(G+=w-I),h.top="auto";let qe=p=="top"?"bottom":"top";this.tip.classList.remove(`${Po}${qe}`),this.tip.classList.add(`${Po}${p}`),h.bottom=Math.floor(U.height-G)+"px",h.textAlign="center",h.overflow="visible",h.width=v+"px",h.height=w+"px";let Li=this.vkbd.currentLayer.element.style.fontFamily,Ce=getComputedStyle(l.element);h.fontFamily=n.key.spec.font||Li||Ce.fontFamily;var s=parseInt(Ce.fontSize,10);if(s==Number.NaN&&(s=0),s!=0){let et={keyWidth:1.6*b,keyHeight:1.6*I,baseEmFontSize:l.getKeyEmFontSize(),layoutFontSize:new Z(l.kbdDiv.style.fontSize)};h.fontSize=n.key.getIdealFontSize(n.key.keyText,et,F).styleString}var c=(v-b)/2;B<c?(this.cap.style.left="1px",B+=c-1):B>window.innerWidth-b-c?(this.cap.style.left=v-b-1+"px",B-=c-1):this.cap.style.left=c+"px",h.left=B-c+"px";let Ne=getComputedStyle(this.element),xn=U.height,Ft=parseFloat(Ne.bottom),Zn=parseFloat(Ne.height),$e=Math.ceil(w/2);this.cap.style.width=b+"px",this.tip.style.height=$e+"px";let Nt=3,Xn=$e-Nt+"px";p=="top"?(this.cap.style.top=Xn,this.cap.style.bottom=""):(this.cap.style.top="",this.cap.style.bottom=Xn);let Vn=R-Math.floor(G)+w-(p=="top"?$e:-Nt*2);if(this.cap.style.height=Vn+"px",this.constrain&&Zn+Ft>xn){let et=Zn+Ft-xn;h.height=w-et+"px";let ra=Math.max(0,w-et-w/2+2);this.cap.style.height=ra+"px"}else Ft<0&&(h.bottom="0px",this.cap.style.height=Math.max(0,Vn+Ft)+"px");if(h.display="block",this.previewHost==i)return;let Ye=this.preview;this.previewHost&&this.previewHost.off("preferredOrientation",this.reorient),this.previewHost=i,i&&(this.previewHost.on("preferredOrientation",this.reorient),this.preview=this.previewHost.element,this.tip.replaceChild(this.preview,Ye),i.setCancellationHandler(()=>this.show(null,!1,null)),i.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",(r=this.previewHost)==null||r.off("preferredOrientation",this.reorient),this.previewHost=null;let o=this.preview;this.preview=document.createElement("div"),this.tip.replaceChild(this.preview,o),this.element.classList.remove("kmw-preview-fade"),this.orientation=jo}this.key=n,this.state=t}};a(lr,"KeyTip");var Ii=lr;var sr="kmw-keypreview",dg="kmw-preview-overlay",ug="kmw-keytip",cr=class cr{constructor(n){this.state=!1;this.vkbd=n;let t=this.element=document.createElement("div");t.className=sr,t.id="kmw-keytip",t.style.pointerEvents="none",t.style.display="none",this.preview=document.createElement("div"),t.appendChild(this.preview)}show(n,t,i){let l=this.vkbd,s=n==null?void 0:n.key.spec.displayLayer;if(t&&l.layerGroup.blinkLayer(s),t&&(n!=null&&n.offsetParent)){let c=this.vkbd.topContainer.getBoundingClientRect(),r=n.getBoundingClientRect(),o=s!=l.layerId?dg:"";this.element.className=`${sr} ${n.className} ${o}`,this.element.id=`${ug}-${n.id}`;let d=this.element.style,u=this.vkbd.currentLayer.element.style.fontFamily;if(d.fontFamily=n.key.spec.font||u,d.left=r.left-c.left+"px",d.top=r.top-c.top+"px",d.width=r.width+"px",d.height=r.height+"px",this.element.style.display="block",this.previewHost==i)return;let B=this.preview;this.previewHost=i,i&&(this.preview=this.previewHost.element,this.element.replaceChild(this.preview,B),i.setCancellationHandler(()=>this.show(null,!1,null)),i.on("startFade",()=>{this.element.classList.remove("kmw-preview-fade"),this.element.offsetWidth,this.element.classList.add("kmw-preview-fade")}))}else{this.element.style.display="none",this.element.className=sr,this.previewHost=null;let c=this.preview;this.preview=document.createElement("div"),this.element.replaceChild(this.preview,c),this.element.classList.remove("kmw-preview-fade")}this.key=n,this.state=t}};a(cr,"TabletKeyTip");var vl=cr;function Ve(g){try{if(g=="desktop")return 1;var n=document.documentElement.clientWidth;if(screen.width>n)return 1;var t=screen.width;return he()?screen.width<screen.height&&(t=screen.height):screen.width>screen.height&&(t=screen.height),Math.round(100*t/n)/100}catch(i){return 1}}a(Ve,"getViewportScale");var ft=class ft{constructor(n,t){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.deleteRepeater=a(()=>{this.repeatClosure(),this.timerHandle=window.setTimeout(this.deleteRepeater,ft.REPEAT_DELAY)},"deleteRepeater");this.source=n;let i=n.stageReports[0].item;i.key.highlight(!0),this.repeatClosure=()=>{t(),i.key.highlight(!0)},this.timerHandle=window.setTimeout(this.deleteRepeater,ft.INITIAL_DELAY),this.source.on("complete",()=>{window.clearTimeout(this.timerHandle),this.timerHandle=void 0,i.key.highlight(!1)})}cancel(){this.deleteRepeater(),this.source.cancel()}currentStageKeyDistribution(){return null}};a(ft,"HeldRepeater"),ft.INITIAL_DELAY=500,ft.REPEAT_DELAY=100;var fl=ft;var rr=class rr extends ke{constructor(n,t){if(typeof t!="string"||t=="")throw"The 'layer' parameter for subkey construction must be properly defined.";super(n,t)}getId(){return"popup-"+this.spec.elementID}construct(n,t,i,l){let s=this.spec,c=document.createElement("div"),r=c.style;c.className="kmw-key-square-ex",l&&(r.marginTop="5px"),r.width=i+"px",r.height=t.offsetHeight+"px";let o=document.createElement("div"),d=this.btn=Rl(o,new Bn(this,s.id));this.setButtonClass(),d.id=this.getId();let u=d.style;return u.height=r.height,u.lineHeight=t.style.lineHeight,u.width=r.width,u.position="absolute",d.appendChild(this.label=this.generateKeyText(n)),c.appendChild(d),this.square=c}allowsKeyTip(){return!1}};a(rr,"OSKSubKey");var bi=rr;var _o=.2,Bg=1.2,$o=3,In=5,qo=6+$o,or=class or{constructor(n,t,i,l,s){this.directlyEmitsKeys=!0;this.shouldLockLayer=!1;var x;this.baseKey=l,this.source=n,this.gestureParams=s,i.layerLocked&&(this.shouldLockLayer=!0),n.on("complete",()=>{var G;(G=this.currentSelection)==null||G.key.highlight(!1),this.clear()}),n.on("stage",()=>{let G=this.currentSelection;if(G){let p=i.keyEventFromSpec(G.key.spec);p.keyDistribution=this.currentStageKeyDistribution(),p.inputBreadcrumb=this.source.trace(),i.raiseKeyEvent(p,G)}});let c=n.stageReports[0].sources[0].constructSubview(!0,!1);c.path.on("step",G=>{var p,R;c.path.stats.netDistance>=4&&((p=this.currentSelection)==null||p.key.highlight(!1),(R=G.item)==null||R.key.highlight(!0),this.currentSelection=G.item)}),this.currentSelection=l,l.key.highlight(!0);let r=l.subKeys,o=this.element=document.createElement("div");o.id="kmw-popup-keys";var d=o.style;d.fontFamily=i.fontFamily;let u=getComputedStyle(l);d.fontSize=u.fontSize,d.visibility="hidden";let B=l.key.layer;(typeof B!="string"||B=="")&&(B=i.layerId);let b=r.length,I=Math.ceil(b/9),F=Math.ceil(b/I);this.subkeys=[];let h=In,y=0;for(let G=0,p=0;G<b;G++,p++){let R=typeof r[G].width!="undefined"?r[G].width*l.offsetWidth/100:l.offsetWidth;R>i.width-2*In&&(R=i.width-2*In),(h+R+In>i.width||p>=F)&&(y++,p=0,h=In);let v=new bi(r[G],B).construct(i,l,R,y>0);h+=R+In,this.menuWidth=Math.max((x=this.menuWidth)!=null?x:0,h),this.subkeys.push(v.firstChild),o.appendChild(v)}d.width=this.menuWidth+"px",this.shim=document.createElement("div"),this.shim.id="kmw-popup-shim",i.device.formFactor==S.FormFactor.Phone&&this.selectDefaultSubkey(l,o),i.element.appendChild(this.element),i.topContainer.appendChild(this.shim),this.reposition(i);let U=this.buildPopupRecognitionConfig(i);t({type:"push",config:U})}buildPopupRecognitionConfig(n){let t=this.element.getBoundingClientRect(),i=this.baseKey.getBoundingClientRect(),l=this.subkeys[0].style,c=-.666*Number.parseInt(l.height,10),r=3,o=i.bottom-t.bottom,d=new Be(this.element,[c*r,c,-o<c?-o:c]),u={getBoundingClientRect(){let B=Number.MAX_SAFE_INTEGER;return new DOMRect(-B,-B,2*B,2*B)}};return{targetRoot:this.element,inputStartBounds:n.element,maxRoamingBounds:u,safeBounds:u,itemIdentifier:(B,b)=>{let I=d.getBoundingClientRect(),F=null,h=Number.MAX_VALUE,y=Number.MAX_VALUE;if(B.clientX<I.left||B.clientX>I.right||B.clientY<I.top||B.clientY>I.bottom)return null;for(let U of this.subkeys){let x=U.getBoundingClientRect(),G=Number.MAX_VALUE,p=Number.MAX_VALUE;if(x.left<=B.clientX&&B.clientX<x.right?G=0:G=x.left>=B.clientX?x.left-B.clientX:B.clientX-x.right,x.top<=B.clientY&&B.clientY<x.bottom?p=0:p=x.top>=B.clientY?x.top-B.clientY:B.clientY-x.bottom,G==0&&p==0)return U;(G<y||G==y&&p<h)&&(y=G,F=U,h=p)}return F}}}reposition(n){let t=this.element,i=this.baseKey,l=n.topContainer,s=i.key.row.element,c=t.style,r=i.offsetParent?i.offsetParent.offsetLeft:0;var o=i.offsetLeft+r+.5*(i.offsetWidth-t.offsetWidth),d=n.width-t.offsetWidth;o>d&&(o=d),o<0&&(o=0),c.left=o+"px";let u=l.getBoundingClientRect(),B=s.getBoundingClientRect();c.top=B.top-u.top-t.offsetHeight-$o+"px",c.visibility="visible";let b=n.isEmbedded,I=getComputedStyle(t),F=parseFloat(I.top),h=0,y=0;F<h&&b&&(y=h-F,c.top=h+"px"),this.callout=this.addCallout(i,y,n.element,n.topContainer,n.device.formFactor=="tablet")}addCallout(n,t,i,l,s){t=t||0;let c=getComputedStyle(this.element),r=Math.max(Number.parseInt(c.borderRadius),0),o=n.getBoundingClientRect(),d=l.getBoundingClientRect(),u=Math.floor(Number.parseInt(c.top,10)+Number.parseInt(c.height,10)+Number.parseInt(c.paddingTop,10)/2+Number.parseInt(c.paddingBottom,10)),B=_o*(o.height-t),b=_o*o.height,I=B+qo,F=I/(b+qo),h=o.bottom-d.top-u-1,y=h<I?h:I;if(y>0){let U=document.createElement("div"),x=U.style;U.id="kmw-popup-callout",i.appendChild(U),x.top=u+"px",x.borderTopWidth=y+"px";let G=Bg*F,p=o.width*G,R=this.menuWidth-2*r,f=R<p?R:p,v=o.left-d.left-(f-o.width)/2,w=Math.max(0,v+f-(d.right-r)),qe=Math.max(0,r-v);return x.left=o.left-d.left-(f-o.width)/2+qe+"px",x.borderLeftWidth=f/2-qe+"px",x.borderRightWidth=f/2-w+"px",U}else return null}selectDefaultSubkey(n,t){var s;var i;let l=n.subKeys;for(let c=0;c<l.length;c++){let r=l[c],o=t.childNodes[c].firstChild;if(r.default){i=o;break}else if(!n.key||!n.key.spec)continue;r.elementID==n.key.spec.elementID&&(i=o)}i&&((s=this.currentSelection)==null||s.key.highlight(!1),this.currentSelection=i,i.key.highlight(!0))}get hasModalVisualization(){return this.element.style.visibility=="visible"}buildCorrectiveLayout(){let n=this.element.getBoundingClientRect(),t=n.width/n.height;return{keys:this.subkeys.map(l=>{let s=l.getBoundingClientRect();return{keySpec:l.key.spec,centerX:(s.right-s.width/2-n.left)/n.width,centerY:(s.bottom-s.height/2-n.top)/n.height,width:s.width/n.width,height:s.height/n.height}}),kbdScaleRatio:t}}currentStageKeyDistribution(){let n=this.source.stageReports[this.source.stageReports.length-1],t=this.source.stageReports[0],i=n.sources[0],l=i.currentSample,s=this.element.getBoundingClientRect(),c={x:l.targetX/s.width,y:l.targetY/s.height};c.x=c.x<0?0:c.x>1?1:c.x,c.y=c.y<0?0:c.y>1?1:c.y;let r=pl(c,this.buildCorrectiveLayout()),o=r.get(l.item.key.spec),d=Math.min(i.path.stats.duration-t.sources[0].path.stats.duration,this.gestureParams.longpress.waitLength)/(2*this.gestureParams.longpress.waitLength),u=Math.min(i.path.stats.rawDistance,this.gestureParams.longpress.noiseTolerance*4)/(this.gestureParams.longpress.noiseTolerance*8),B=Math.min(d*d,u*u),b=o+B,I=new Map,F=this.subkeys.find(h=>h.keyId==this.baseKey.keyId);return F?I.set(F.key.spec,b):I.set(this.baseKey.key.spec,b),ut([r,I])}cancel(){this.clear(),this.source.cancel()}clear(){this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.shim.parentNode&&this.shim.parentNode.removeChild(this.shim),this.callout&&this.callout.parentNode&&this.callout.parentNode.removeChild(this.callout)}};a(or,"SubkeyPopup");var bn=or;var ar=class ar{constructor(n,t,i){this.directlyEmitsKeys=!0;this.shouldRestore=!1;this.hasModalVisualization=!1;let l=n.stageReports[0];this.originalLayer=l.sources[0].stateToken,this.source=n,this.completionCallback=()=>{t.lockLayer(!1),this.shouldRestore&&(t.layerId=this.originalLayer,t.updateState()),i==null||i()},t.lockLayer(!0),n.on("stage",s=>{let c=s.matchedId;c.includes("modipress")&&c.includes("-end")?this.clear():c.includes("modipress")&&c.includes("-hold")&&(this.shouldRestore=!0)}),n.on("complete",()=>this.cancel())}get isLocked(){return this.shouldRestore}setLocked(){this.shouldRestore=!0}get completed(){return this.completionCallback===null}clear(){let n=this.completionCallback;this.completionCallback=null,n==null||n()}cancel(){this.clear(),this.source.cancel()}currentStageKeyDistribution(n){return null}};a(ar,"Modipress");var Bt=ar;var gr=class gr{constructor(n,t,i,l,s){this.directlyEmitsKeys=!0;this.hasModalVisualization=!1;this.tapIndex=0;this.baseKey=i,this.baseContextToken=l,this.multitaps=[i.key.spec].concat(i.key.spec.multitap),this.sequence=n;let c=a(B=>{var I;(I=this.modipress)==null||I.clear();let b=new Bt(n,t,()=>{this.modipress=t.activeModipress=null});this.modipress=t.activeModipress=b},"startModipress");this.originalLayer=t.layerId,this.keyboardId=t.layoutKeyboard.id;let r=a(B=>(this.tapIndex+B)%this.multitaps.length,"tapLookahead"),o=a(()=>{s==null||s.setMultitapHint(this.multitaps[r(0)],this.multitaps[r(1)],t)},"updatePreview");n.on("complete",()=>{var B;(B=this.modipress)==null||B.cancel(),this.clear()});let d=a(B=>{var U;switch(B.matchedId){case"modipress-hold":this.clear(),n.off("stage",d);return;case"modipress-end-multitap-transition":case"modipress-multitap-end":case"modipress-end":case"multitap-end":case"simple-tap":return;case"modipress-multitap-lock-transition":(U=this.modipress)==null||U.setLocked();return;case"modipress-multitap-start":case"multitap-start":break;default:throw new Error(`Unsupported gesture state encountered during multitap: 
${this.sequence.trace()}`)}this.tapIndex=r(1);let b=this.multitaps[this.tapIndex];o();let I=t.keyEventFromSpec(b);I.baseTranscriptionToken=this.baseContextToken,this.baseContextToken==null&&console.warn("Multitap init warning:  no associated base context (with base key "+i.key.spec.coreID+")");let F=B.sources[0].currentSample,h=this.baseKey.key.spec,y=t.getSimpleTapCorrectionDistances(F,h);if(F.stateToken!=t.layerId&&!B.matchedId.includes("modipress")){let x=t.layerGroup.findNearestKey(W(C({},F),{stateToken:t.layerId}));if(Al(x.key.spec)){let G=y.get(x.key.spec);G==null?console.warn(`Could not find fat-finger probability for current layer's key:  current key = ${x.key.spec.elementID}, current layer = ${t.layerId}, keyboard = ${this.keyboardId}`):(y.delete(x.key.spec),y.set(F.item.key.spec,G))}}F.item&&Al(F.item.key.spec)&&(I.keyDistribution=this.currentStageKeyDistribution(y)),I.kNextLayer||(I.kNextLayer=this.originalLayer),I.inputBreadcrumb=this.sequence.trace(),t.raiseKeyEvent(I,null),B.matchedId=="modipress-multitap-start"&&c(B)},"stageHandler");n.on("stage",d),n.stageReports[0].matchedId=="modipress-start"&&c(n.stageReports[0]),o()}currentStageKeyDistribution(n){let t=ut(n),i=t.findIndex(o=>o.keySpec==this.baseKey.key.spec);if(i==-1)return si(this.baseKey)||console.warn(`Could not find base key's probability for multitap correction adjustments: ${this.baseKey.key.spec.elementID}, keyboard = ${this.keyboardId}`),t;let l=t.splice(i,1)[0].p,s=0,c=[];for(let o=0;o<this.multitaps.length;o++){let d=this.multitaps[o],u=Math.abs(o-this.tapIndex)%this.multitaps.length,B=(o+this.multitaps.length-this.tapIndex)%this.multitaps.length,b=u<B?u:B,I=1/((1+b)*(1+b));s+=I,c.push({keySpec:d,p:I})}let r=l/s;return c.forEach(o=>{o.p=r*o.p}),t.concat(c).sort((o,d)=>d.p-o.p)}cancel(){this.clear(),this.sequence.cancel()}clear(){}};a(gr,"Multitap");var hi=gr;var Fi=1.4142,dr=a(g=>Math.abs(g)<1e-10?0:g,"coerceZeroes"),ur=class ur extends V.default{constructor(t,i,l,s){var b;super();this.flickPreviews=new Map;this.orientation="top";let c=t.key.spec,r=this.flickEdgeLength=Math.max(l,s),o=this.div=document.createElement("div");o.className=o.id="kmw-gesture-preview",o.style.pointerEvents="none";let d=this.previewImgContainer=document.createElement("div");this.previewImgContainer.id="kmw-preview-img-container";let u=this.label=document.createElement("span");if(u.className="kmw-gesture-base-label kmw-key-text",u.id="kmw-gesture-base-label",d.appendChild(u),u.textContent=t.key.label.textContent,this.div.appendChild(this.previewImgContainer),c.flick){let I=c.flick||{};Object.keys(I).forEach(F=>{let h=document.createElement("div");h.className="kmw-flick-preview kmw-key-text",h.textContent=I[F].text;let y=h.style,U=Yc.get(F),x=dr(-Math.sin(U[0])),G=dr(Math.cos(U[0]));y.width="100%",y.textAlign="center",x<0?y.right=-x*Fi*r+"px":x>0?y.left=x*Fi*r+"px":y.left="0px",y.height="100%",y.lineHeight="100%",G<0?y.bottom=-G*Fi*r+"px":G>0?y.top=G*Fi*r+"px":y.top="0px",this.flickPreviews.set(F,h),d.appendChild(h)})}let B=this.hintLabel=document.createElement("div");B.className="kmw-key-popup-icon",i||(B.textContent=c==c.hintSrc?c.hint:(b=c.hintSrc)==null?void 0:b.text,B.style.fontWeight=B.textContent=="•"?"bold":""),o.appendChild(B)}get element(){return this.div}refreshLayout(){let t=getComputedStyle(this.div),i=Number.parseInt(t.height,10);this.flickPreviews.forEach(l=>{l.style.lineHeight=l.style.height=`${i}px`})}cancel(){var t;(t=this.onCancel)==null||t.call(this),this.onCancel=null}setCancellationHandler(t){this.onCancel=t}setMultitapHint(t,i,l){var r,o;let s=vt(t.text,l),c=vt(i.text,l);this.label.textContent=s,this.hintLabel.textContent=c,this.label.style.fontFamily=s!=t.text?"SpecialOSK":(r=t.font)!=null?r:this.label.style.fontFamily,this.hintLabel.style.fontFamily=c!=i.text?"SpecialOSK":(o=i.font)!=null?o:this.hintLabel.style.fontFamily,this.emit("startFade"),this.clearFlick()}scrollFlickPreview(t,i){this.clearHint();let l=this.previewImgContainer.style,s=this.flickEdgeLength*Fi;l.marginLeft=`${s*t}px`,l.marginTop=`${s*i}px`;let c=dr(i)<0?"bottom":"top";this.orientation!=c&&(this.orientation=c,this.emit("preferredOrientation",c))}clearFlick(){this.previewImgContainer.style.marginTop="0px",this.previewImgContainer.style.marginLeft="0px",this.previewImgContainer.classList.add("kmw-flick-clear")}clearHint(){this.hintLabel.classList.add("kmw-hint-clear")}clearAll(){this.clearFlick()}};a(ur,"GesturePreviewHost");var Ll=ur;var ea=tt.TIER!="stable"||tt.VERSION_ENVIRONMENT!="",Ig=ea?10:0,yi=class yi extends V.default{constructor(t){var d,u,B;super();this.layerLocked=!1;this.layerIndex=0;this.isStatic=!1;this._fixedWidthScaling=!1;this._fixedHeightScaling=!0;this._borderWidth=0;this.stateKeys={K_CAPS:!1,K_NUMLOCK:!1,K_SCROLL:!1};this.activeGestures=[];this.activeModipress=null;this.config=t,this.config.device=t.device||t.hostDevice,this.config.isEmbedded=t.isEmbedded||!1,t.isStatic&&(this.isStatic=t.isStatic),(d=this.config).gestureParams||(d.gestureParams=C({},li)),this._fixedWidthScaling=this.device.touchable&&!this.isStatic,this._fixedHeightScaling=this.device.touchable&&!this.isStatic;var i=document.createElement("div");this.config.styleSheetManager=t.styleSheetManager||new de(i);let l;if(t.keyboard)l=this.kbdLayout=t.keyboard.layout(t.device.formFactor),this.layoutKeyboardProperties=t.keyboardMetadata,this.isRTL=t.keyboard.isRTL;else{let b=E.buildDefaultLayout(null,null,t.device.formFactor);l=this.kbdLayout=Mt.polyfill(b,null,t.device.formFactor),this.layoutKeyboardProperties=null,this.isRTL=!1}"font"in l?this.fontFamily=l.font:this.fontFamily="";let s=t.device.formFactor;this.layoutKeyboard=t.keyboard,this.layoutKeyboard||(this.layoutKeyboard=new T(null)),this.layerGroup=new Bi(this,this.layoutKeyboard,s),this.layoutKeyboard.markLayoutCalibrated(s),i.appendChild(this.layerGroup.element),this.kbdDiv=i,this.isStatic||(this.gestureEngine=this.constructGestureEngine()),i.classList.add(t.device.formFactor,"kmw-osk-inner-frame");let c=(B=(u=this.layoutKeyboard)==null?void 0:u.id.replace("Keyboard_",""))!=null?B:"",r=c.indexOf("::");r!=-1&&(c=c.substring(r+2));let o="kmw-keyboard-"+c;this.element.classList.add(o)}get gestureParams(){return this.config.gestureParams}get layerId(){var t,i;return(i=(t=this.layerGroup)==null?void 0:t.activeLayerId)!=null?i:"default"}set layerId(t){let i=t!=this.layerId;if(this.layerGroup.getLayer(t))this.layerGroup.activeLayerId=t,this.gestureEngine&&(this.gestureEngine.stateToken=t);else throw new Error(`Keyboard ${this.layoutKeyboard.id} does not have a layer with id ${t}`);i&&!this.deferLayout&&(this.updateState(),this.layerGroup.refreshLayout(this.constructLayoutParams()))}get currentLayer(){var t;return(t=this.layerGroup)==null?void 0:t.activeLayer}get lgKey(){var t,i;return(i=(t=this.currentLayer)==null?void 0:t.globeKey)==null?void 0:i.btn}get hkKey(){var t,i;return(i=(t=this.currentLayer)==null?void 0:t.hideKey)==null?void 0:i.btn}get spaceBar(){var t,i;return(i=(t=this.currentLayer)==null?void 0:t.spaceBarKey)==null?void 0:i.btn}constructGestureEngine(){let t={targetRoot:this.element,mouseEventRoot:document.body,maxRoamingBounds:new Be(this.topContainer,[NaN]),itemIdentifier:(r,o)=>this.layerGroup.findNearestKey(r),recordingMode:ea,historyLength:Ig},i=new At(Tc(this.kbdLayout,this.gestureParams),t);i.stateToken=this.layerId;let l={},s=a(r=>{for(let o of Object.keys(l)){if(o==r)continue;l[o].source.terminate(!0)}},"clearActiveGestures"),c=new Map;return i.on("inputstart",r=>{var B;let o=this.highlightKey(r.currentSample.item,!0);o&&((B=this.gesturePreviewHost)==null||B.cancel(),this.gesturePreviewHost=o),l[r.identifier]={source:r,roamingHighlightHandler:null,key:r.currentSample.item,previewHost:o};let d=l[r.identifier],u=a(()=>{ge(0).then(()=>{let b=d.previewHost;b&&(b.cancel(),this.gesturePreviewHost=null,d.previewHost=null),d.key&&(this.highlightKey(d.key,!1),d.key=null)})},"endHighlighting");d.roamingHighlightHandler=b=>{var h;let I=b.item,F=l[r.identifier].key;if(!this.kbdLayout.hasFlicks&&I!=F){this.highlightKey(F,!1),(h=this.gesturePreviewHost)==null||h.cancel(),this.gesturePreviewHost=null,d.previewHost=null;let y=this.highlightKey(I,!0);y&&(this.gesturePreviewHost=y,d.previewHost=y),l[r.identifier].key=I}},r.path.on("invalidated",u),r.path.on("complete",u),r.path.on("step",d.roamingHighlightHandler)}),i.on("recognizedgesture",r=>{var o;(o=this.activeModipress)==null||o.setLocked(),r.on("complete",()=>{var d;for(let u of r.allSourceIds)(d=l[u])!=null&&d.previewHost&&(this.gesturePreviewHost=null,l[u].previewHost.cancel()),delete l[u]}),r.on("stage",(d,u)=>{let B=r.allSourceIds.map(G=>{var p;return(p=l[G])==null?void 0:p.previewHost}).find(G=>!!G),b=a(()=>{B&&(B.cancel(),this.gesturePreviewHost=null)},"clearPreviewHost"),I=c.get(r);!I&&B&&!d.matchedId.includes("flick")&&B.clearFlick();let F;for(let G of d.allSourceIds){let p=a(R=>{R.key&&(this.highlightKey(R.key,!1),R.key=null),R.source.path.off("step",R.roamingHighlightHandler)},"clearRoaming");if(F=l[G],F)p(F);else{let R=G;ge(0).then(()=>{let f=l[R];f&&p(f)})}}let h=d.item,y=d.sources[0],U=null;if(h&&!(I&&I[0].directlyEmitsKeys)){let G,p=this.getSimpleTapCorrectionDistances(y.currentSample,h.key.spec);I&&(G=I[0].currentStageKeyDistribution(p)),G||(G=ut(p));let R=!this.layerLocked&&I&&I[0]instanceof bn&&I[0].shouldLockLayer;try{R&&this.lockLayer(!0),U=this.modelKeyClick(r,G)}finally{R&&this.lockLayer(!1)}}if(r.stageReports.length>1&&d.matchedId!="modipress-end")return;let x=r.stageReports[0].item;if(d.matchedId=="special-key-start")h.key.spec.baseKeyID=="K_BKSP"?(b(),I=[new fl(r,()=>this.modelKeyClick(r))]):h.key.spec.baseKeyID=="K_LOPT"&&(r.on("complete",()=>{h.key.highlight(!1),this.emit("globekey",h,!1)}),s(y.identifier),h.key.highlight(!0));else if(d.matchedId.indexOf("longpress")>-1)b(),I=[new bn(r,u,this,r.stageReports[0].sources[0].baseItem,this.gestureParams)];else if(x!=null&&x.key.spec.multitap&&(d.matchedId=="initial-tap"||d.matchedId=="multitap"||d.matchedId=="modipress-start"))F.previewHost=null,r.on("complete",()=>{b()}),I=[new hi(r,this,x,U.contextToken,B)];else if(d.matchedId.indexOf("flick")>-1)I=[new ni(r,u,this,r.stageReports[0].sources[0].baseItem,this.gestureParams,B)];else if(d.matchedId.includes("modipress")&&d.matchedId.includes("-start"))if(b(),this.layerLocked)console.warn("Unexpected state:  modipress start attempt during an active modipress");else{I||(I=[]);let G=new Bt(r,this,()=>{let p=I.indexOf(G);p>-1&&I.splice(p,1),this.activeModipress=null});I.push(G),this.activeModipress=G}else b();I&&(this.activeGestures=this.activeGestures.concat(I),c.set(r,I),r.on("complete",()=>{let G=this.activeGestures.filter(p=>I.includes(p));this.activeGestures=this.activeGestures.filter(p=>!I.includes(p)),G.forEach(p=>{p instanceof Bt&&p.cancel()})}))})}),i}get element(){return this.kbdDiv}get device(){return this.config.device}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get styleSheetManager(){return this.config.styleSheetManager}get topContainer(){return this.config.topContainer}get isEmbedded(){return this.config.isEmbedded}postInsert(){}get width(){return this._width}get height(){return this._height}get layoutWidth(){if(this.usesFixedWidthScaling){let t=this.width;return t-=this._borderWidth*2,Z.inPixels(t)}else return Z.forScalar(1)}get layoutHeight(){if(this.usesFixedHeightScaling){let t=this.height;return t-=this._borderWidth*2,Z.inPixels(t)}else return Z.forScalar(1)}get internalHeight(){return this.usesFixedHeightScaling?Z.inPixels(this.layoutHeight.val-this._borderWidth*2-this.layerGroup.verticalPadding):Z.forScalar(1)}get fontSize(){return this._fontSize||(this._fontSize=new Z("1em")),this._fontSize}set fontSize(t){this._fontSize=t,this.kbdDiv.style.fontSize=t.styleString}get usesFixedWidthScaling(){return this._fixedWidthScaling}set usesFixedWidthScaling(t){this._fixedWidthScaling=t}get usesFixedHeightScaling(){return this._fixedHeightScaling}set usesFixedHeightScaling(t){this._fixedHeightScaling=t}get usesFixedPositioning(){let t=this.element;for(;t;){if(getComputedStyle(t).position=="fixed")return!0;t=t.offsetParent}return!1}setSize(t,i,l){this._width=t,this._height=i,this.kbdDiv&&(this.kbdDiv.style.width=t?this._width+"px":"",this.kbdDiv.style.height=i?this._height+"px":"",!this.device.touchable&&i&&(this.fontSize=new Z(this._height/8+"px")),l||this.refreshLayout())}getTouchCoordinatesOnKeyboard(t){let i={x:t.targetX,y:t.targetY};return i.x/=this.layerGroup.element.offsetWidth,i.y/=this.kbdDiv.offsetHeight,i}getSimpleTapCorrectionDistances(t,i){let l=this.getTouchCoordinatesOnKeyboard(t),c=this.layerGroup.element.offsetWidth,r=this.kbdDiv.offsetHeight;if(!c||!r)return new Map;let o=c/r,d=Oo(this.kbdLayout.getLayer(this.layerId),o);return pl(l,d)}modelKeyClick(t,i){var o;if(!t)throw new Error("cannot model key event without its gesture");let l=t.stageReports[t.stageReports.length-1],s=l.item,c=(o=l.sources[0])==null?void 0:o.currentSample;if(!s)throw new Error(`Cannot model keypress without a selected key: 
${t.trace()}`);let r=this.initKeyEvent(s);return c&&(r.source=c),i&&(r.keyDistribution=i),r.inputBreadcrumb=t.trace(),this.raiseKeyEvent(r,s)}initKeyEvent(t){this.highlightKey(t,!1);let i=t.key?t.key.spec:null;return i?this.keyEventFromSpec(i):null}keyEventFromSpec(t){let i=this.layoutKeyboard.constructKeyEvent(t,this.device,this.stateKeys);return i.srcKeyboard=this.layoutKeyboard,i}_UpdateVKShiftStyle(t){var r;var i;t||(t=this.layerId);let l=this.layerGroup.getLayer(t);if(!l||(this.gestureEngine&&(this.gestureEngine.stateToken=t),!((r=this.layoutKeyboard)!=null&&r.usesDesktopLayoutOnDevice(this.device))))return;let s=["K_CAPS","K_NUMLOCK","K_SCROLL"],c=[l.capsKey,l.numKey,l.scrollKey];for(i=0;i<c.length;i++)c[i]!=null&&c[i].setToggleState(this.stateKeys[s[i]])}updateStateKeys(t){for(let i of Object.keys(this.stateKeys))this.stateKeys[i]=t[i];this._UpdateVKShiftStyle()}highlightKey(t,i){if(!t||!t.key||t.className==""||t.className.indexOf("kmw-key-row")>=0)return null;let l=t.key.allowsKeyTip();return i=this.activeGestures.find(c=>c.hasModalVisualization)?!1:i,t.key.highlight(i),i&&l?this.gesturePreviewHost?null:this.showGesturePreview(t):null}getKeyEmFontSize(){if(!this.fontSize)return new Z("0px");if(this.device.formFactor=="desktop"){let t=.8;return this.fontSize.scaledBy(t)}else{let t=getComputedStyle(document.body).fontSize,i=new Z(t),l=1;if(!this.isStatic){if(this.fontSize.absolute)return this.fontSize;l=this.fontSize.val}return i.scaledBy(l)}}updateState(){this.currentLayer&&(this.nextLayer=this.layerId,this.currentLayer.nextlayer&&(this.nextLayer=this.currentLayer.nextlayer),this.layerGroup.activeLayerId=this.layerId,this._UpdateVKShiftStyle())}refreshLayout(){if(this.deferLayout)return;let t=this.device;var i=1;t.OS==S.OperatingSystem.iOS&&!this.isEmbedded&&(i=i/Ve(this.device.formFactor));let l=this.kbdDiv.style;this.usesFixedHeightScaling&&this.height&&(l.height=l.maxHeight=this.height+"px"),l.fontSize=this.fontSize.scaledBy(i).styleString;let s=this.width&&this.height,c=getComputedStyle(this.kbdDiv),r=getComputedStyle(this.layerGroup.element),o=c.height!=""&&c.height!="auto",d=r.height!=""&&r.height!="auto";if(c.border&&(this._borderWidth=new Z(c.borderWidth).val),s)this._computedWidth=this.width,this._computedHeight=this.height;else if(o)this._computedWidth=parseInt(c.width,10),this._computedHeight=parseInt(c.height,10);else if(d)this._computedWidth=parseInt(r.width,10),this._computedHeight=parseInt(r.height,10);else return;this.layerGroup.refreshLayout(this.constructLayoutParams()),this.isStatic||(this.gestureEngine.config.maxRoamingBounds.updatePadding([-.333*this.currentLayer.rowHeight]),this.gestureParams.longpress.flickDistStart=.24*this.currentLayer.rowHeight,this.gestureParams.flick.startDist=.3*this.currentLayer.rowHeight,this.gestureParams.flick.dirLockDist=.35*this.currentLayer.rowHeight,this.gestureParams.flick.triggerDist=.75*this.currentLayer.rowHeight,this.gestureParams.longpress.flickDistFinal=.75*this.currentLayer.rowHeight)}constructLayoutParams(){var t,i;return{keyboardWidth:this._computedWidth-2*this._borderWidth,keyboardHeight:this._computedHeight-2*this._borderWidth-this.layerGroup.verticalPadding,widthStyle:this.layoutWidth,heightStyle:this.internalHeight,baseEmFontSize:this.getKeyEmFontSize(),layoutFontSize:new Z(this.layerGroup.element.style.fontSize),spacebarText:(i=(t=this.layoutKeyboardProperties)==null?void 0:t.displayName)!=null?i:"(System keyboard)"}}appendStyleSheet(){var t=this.layoutKeyboard,i=this.layoutKeyboardProperties;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet);var l=i==null?void 0:i.textFont,s=i==null?void 0:i.oskFont;this.styleSheetManager.addStyleSheetForFont(l,this.fontRootPath,this.device.OS),this.styleSheetManager.addStyleSheetForFont(s,this.fontRootPath,this.device.OS),this.config.specialFont&&this.styleSheetManager.addStyleSheetForFont(this.config.specialFont,"",this.device.OS);var c=this.addFontStyle(l,s);t!=null&&typeof t.oskStyling=="string"&&(c=c+t.oskStyling),c&&(this.styleSheet=st(c),this.styleSheetManager.linkStylesheet(this.styleSheet)),this.styleSheetManager.allLoadedPromise().then(()=>{this.layerGroup.resetPrecalcFontSizes(),this.refreshLayout()})}addFontStyle(t,i){let l="",s=a(c=>c.family.replace(/\u0022/g,"").replace(/,/g,'","'),"family");return(t||i)&&(l=`
.kmw-key-text {
  font-family: "${s(i||t)}";
}

.kmw-suggestion-text {
  font-family: "${s(t||i)}";
}
`),l}static buildDocumentationKeyboard(t,i,l,s,c,r){if(!t)return null;var o=typeof s=="undefined"?"desktop":s,d=typeof c=="undefined"?"default":c,u={};u.formFactor=o,o!="desktop"?(u.OS=S.OperatingSystem.iOS,u.touchable=!0):(u.OS=S.OperatingSystem.Windows,u.touchable=!1);let B=t.layout(o),b=new S("other",u.formFactor,u.OS,u.touchable),I=new yi({keyboard:t,keyboardMetadata:i,hostDevice:b,isStatic:!0,topContainer:null,pathConfig:l,styleSheetManager:null,specialFont:{family:"SpecialOSK",files:[`${l.resources}/osk/keymanweb-osk.ttf`],path:""}});I.layerGroup.element.className=I.kbdDiv.className,I.layerGroup.element.classList.add(u.formFactor+"-static");let F=I.kbdDiv.childNodes[0],h=document.createElement("div");h.classList.add(u.OS.toLowerCase(),u.formFactor),B!=null?(I.layerId=d,I.layerGroup.activeLayerId=d,I.setSize(800,r),I.fontSize=Mo(b,r,!1),h.style.fontSize=I.element.style.fontSize,I.refreshLayout(),F.style.height=I.kbdDiv.style.height,F.style.maxHeight=I.kbdDiv.style.maxHeight):F.innerHTML="<p style='color:#c40; font-size:0.5em;margin:10px;'>No "+o+" layout is defined for "+t.name+".</p>",F.style.border="1px solid #ccc",I.updateState();let y=a(()=>A(this,null,function*(){if(document.contains(F))try{yield I.styleSheetManager.allLoadedPromise();let x=I.styleSheet;x&&F.appendChild(x);let G=[].concat(I.styleSheetManager.sheets);for(let p of G)p!=x&&(p.href||(I.styleSheetManager.unlink(p),document.head.appendChild(p)));I.refreshLayout(),I.styleSheet=null,I.shutdown()}finally{U.disconnect()}}),"detectAndHandleInsertion"),U=new MutationObserver(y);U.observe(document.body,{childList:!0,subtree:!0}),h.append(F);for(let x of Ge.STYLESHEET_FILES){let G=`${l.resources}/osk/${x}`,p=I.styleSheetManager.linkExternalSheet(G,!0);p.parentNode.removeChild(p),h.appendChild(p)}return I.appendStyleSheet(),delete I._width,delete I._height,h}onHide(){this.hkKey&&this.highlightKey(this.hkKey,!1)}optionKey(t,i,l){i.indexOf("K_LOPT")>=0?this.emit("globekey",t,l):i.indexOf("K_ROPT")>=0&&l&&this.emit("hiderequested",t)}showGesturePreview(t){let i=this.keytip,l=this.constructLayoutParams(),s=l.keyboardWidth*t.key.spec.proportionalWidth,c=l.keyboardHeight/this.currentLayer.rows.length,r=new Ll(t,this.device.formFactor=="phone",s,c);return i==null?t.key.setPreview(r):i.show(t,!0,r),r.refreshLayout(),r}createKeyTip(){if(this.keytip==null)if(this.device.formFactor=="phone"){let t=this.isEmbedded;this.keytip=new Ii(this,t)}else this.keytip=new vl(this);this.keytip&&this.keytip.element&&this.element.appendChild(this.keytip.element)}createGlobeHint(){return this.config.embeddedGestureConfig.createGlobeHint?this.config.embeddedGestureConfig.createGlobeHint(this):null}shutdown(){var t;this.styleSheet&&this.styleSheet.parentNode&&this.styleSheet.parentNode.removeChild(this.styleSheet),this.activeGestures.forEach(i=>i.cancel()),this.gestureEngine&&this.gestureEngine.destroy(),this.deleting&&window.clearTimeout(this.deleting),(t=this.keytip)==null||t.show(null,!1,null)}lockLayer(t){this.layerLocked=t}raiseKeyEvent(t,i){if(t.kName=="K_LOPT"||t.kName=="K_ROPT")return this.optionKey(i,t.kName,!0),{};let l={},s=a((c,r)=>{var d,u;l.contextToken=(d=c==null?void 0:c.transcription)==null?void 0:d.token;let o=(u=c==null?void 0:c.transcription)==null?void 0:u.transform;l.alteredText=c&&(!o||Zt(o))},"keyEventCallback");return this.layerLocked&&(t.kNextLayer=this.layerId),this.emit("keyevent",t,s),l}};a(yi,"VisualKeyboard"),yi.specialCharacters=ke.specialCharacters;var me=yi;var Br=class Br extends V.default{};a(Br,"Activator");var Oe=Br,Ir=class Ir extends Oe{get enabled(){return!0}set enabled(n){}get activate(){return!0}get conditionsMet(){return!0}};a(Ir,"StaticActivator");var Lt=Ir;var br=class br{constructor(){this.map=new Map}promiseForTouchpoint(n){return this.map.get(n)||this.map.set(n,new H),this.map.get(n)}maintainTouches(n){let t=Array.from(this.map.keys());for(let i=0;i<n.length;i++){let l=t.indexOf(n.item(i).identifier);l!=-1&&t.splice(l,1)}for(let i of t)this.map.get(i).resolve(),this.map.delete(i)}};a(br,"TouchEventPromiseMap");var mi=br;function ta(g){let n="osk/";return g.isEmbedded&&(n=""),`${g.pathConfig.resources}/${n}`}a(ta,"getResourcePath");var hn=class hn extends V.default{constructor(t){var l;super();this.legacyEvents=new cn;this.needsLayout=!0;this.touchEventPromiseManager=new mi;this.activationListener=a(t=>{if(!this.mayDisable&&!this.activationModel.enabled){this.activationModel.off("activate",this.activationListener);try{this.activationModel.enabled=!0}finally{this.activationModel.on("activate",this.activationListener)}}this.commonCheckAndDisplay()},"activationListener");this.layerChangeHandler=a((t,i)=>{var l,s;return this.vkbd&&this.vkbd._UpdateVKShiftStyle(i),(this.vkbd&&this.vkbd.layerId!=i||t.value!=i)&&(l=this.vkbd)!=null&&l.layerGroup.getLayer(i)&&!((s=this.vkbd)!=null&&s.layerLocked)&&(this.vkbd.layerId=i),!1},"layerChangeHandler");this._Visible=!1;this.config=t=C({},t),(l=this.config).gestureParams||(l.gestureParams=li),this.config.allowHideAnimations===void 0&&(this.config.allowHideAnimations=!0),this.config.device=t.device||t.hostDevice,this.config.isEmbedded=t.isEmbedded||!1,this.config.embeddedGestureConfig=t.embeddedGestureConfig||{},this.config.activator.on("activate",this.activationListener),this._Box=J("div"),this.kbdStyleSheetManager=new de(this._Box,this.config.doCacheBusting||!1),this.uiStyleSheetManager=new de(this._Box),this.bannerView=new rl,this.bannerView.events.on("bannerchange",()=>this.refreshLayout()),this._Box.appendChild(this.bannerView.element),this._bannerController=new oi(this.bannerView,this.hostDevice,this.config.predictionContextManager),this.keyboardView=this._GenerateKeyboardView(null,null),this._Box.appendChild(this.keyboardView.element);let i=ta(this.config);for(let s of hn.STYLESHEET_FILES){let c=`${i}${s}`;this.uiStyleSheetManager.linkExternalSheet(c)}this.setBaseMouseEventListeners(),this.hostDevice.touchable&&this.setBaseTouchEventListeners(),this._Box.style.display="none"}get keyCodes(){return Q.keyCodes}get modifierCodes(){return Q.modifierCodes}get modifierBitmasks(){return Q.modifierBitmasks}get stateBitmasks(){return Q.stateBitmasks}get gestureParams(){return this.config.gestureParams}get configuration(){return this.config}get bannerController(){return this._bannerController}get hostDevice(){return this.config.hostDevice}get fontRootPath(){return this.config.pathConfig.fonts}get isEmbedded(){return this.config.isEmbedded}setBaseMouseEventListeners(){this._Box.onmouseenter=t=>{this.mouseEnterPromise&&this.mouseEnterPromise.resolve(),this.mouseEnterPromise=new H,this.emit("pointerinteraction",this.mouseEnterPromise.corePromise)},this._Box.onmouseleave=t=>{this.mouseEnterPromise.resolve(),this.mouseEnterPromise=null}}removeBaseMouseEventListeners(){this._Box.onmouseenter=null,this._Box.onmouseleave=null}setBaseTouchEventListeners(){let t=a(function(i){return i.cancelable&&i.preventDefault(),i.stopPropagation(),!1},"commonPrevention");this._boxBaseTouchEventCancel=i=>(this.touchEventPromiseManager.maintainTouches(i.touches),t(i)),this._boxBaseTouchStart=i=>{for(let l=0;l<i.changedTouches.length;l++){let s=this.touchEventPromiseManager.promiseForTouchpoint(i.changedTouches[l].identifier);this.emit("pointerinteraction",s.corePromise)}return this.touchEventPromiseManager.maintainTouches(i.touches),t(i)},this._Box.addEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.addEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.addEventListener("touchcancel",this._boxBaseTouchEventCancel,!1)}removeBaseTouchEventListeners(){this._boxBaseTouchEventCancel&&(this._Box.removeEventListener("touchstart",this._boxBaseTouchStart,!1),this._Box.removeEventListener("touchmove",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchend",this._boxBaseTouchEventCancel,!1),this._Box.removeEventListener("touchcancel",this._boxBaseTouchEventCancel,!1),this._boxBaseTouchEventCancel=null,this._boxBaseTouchStart=null)}get targetDevice(){return this.config.device}set targetDevice(t){this.allowsDeviceChange(t)?(this.config.device=t,this.loadActiveKeyboard()):console.error("May not change target device for this OSKView type.")}allowsDeviceChange(t){return!1}get activationModel(){return this.config.activator}set activationModel(t){if(!t)throw new Error("The activation model may not be set to null or undefined!");this.config.activator.off("activate",this.activationListener),t.on("activate",this.activationListener),this.config.activator=t,this.commonCheckAndDisplay()}get mayDisable(){var t;return!(this.hostDevice.touchable||(t=this.activeKeyboard)!=null&&t.keyboard.isCJK)}get displayIfActive(){return this.activationModel.enabled}commonCheckAndDisplay(){this.activationModel.activate&&this.activeKeyboard?this.present():this.startHide(!1)}get vkbd(){return this.keyboardView instanceof me?this.keyboardView:null}get banner(){return this.bannerView}get width(){return this._width}get height(){return this._height}get computedWidth(){return this.needsLayout&&this.refreshLayout(),this._computedWidth}get computedHeight(){return this.needsLayout&&this.refreshLayout(),this._computedHeight}get baseFontSize(){var t;return((t=this.parsedBaseFontSize)==null?void 0:t.styleString)||""}get parsedBaseFontSize(){return this._baseFontSize||(this._baseFontSize=hn.defaultFontSize(this.targetDevice,this.computedHeight,this.isEmbedded)),this._baseFontSize}static defaultFontSize(t,i,l){if(t.touchable){let s=t.formFactor=="phone"?1.6*(l?.65:.6)*1.2:2;return Z.special(s,"em")}else return i?Z.inPixels(i/8):void 0}get activeKeyboard(){return this.keyboardData}set activeKeyboard(t){var i;this.keyboardData=t,this.loadActiveKeyboard(),(i=this.keyboardData)!=null&&i.keyboard.isCJK&&(this.activationModel.enabled=!0)}computeFrameHeight(){var t,i;return(((t=this.headerView)==null?void 0:t.layoutHeight.val)||0)+(((i=this.footerView)==null?void 0:i.layoutHeight.val)||0)}setSize(t,i,l){let s=!1,c,r;!t&&t!==0||!i&&i!==0||(Number.isFinite(t)?c=Z.inPixels(t):c=new Z(t),Number.isFinite(i)?r=Z.inPixels(i):r=new Z(i),t&&i&&(s=!this._width||!this._height,s=s||c.styleString!=this._width.styleString,s=s||r.styleString!=this._height.styleString,this._width=c,this._height=r),this.needsLayout=this.needsLayout||s,this.refreshLayoutIfNeeded(l))}setNeedsLayout(){this.needsLayout=!0}batchLayoutAfter(t){if(this.deferLayout){t();return}try{this.deferLayout=!0,this.vkbd&&(this.vkbd.deferLayout=!0),t()}finally{this.deferLayout=!1,this.vkbd&&(this.vkbd.deferLayout=!1),this.refreshLayout()}}refreshLayout(t){var r,o;if(!this.keyboardView||this.deferLayout||!(this.width&&this.height))return;let l=this.width.absolute&&this.height.absolute,s=getComputedStyle(this._Box),c=s.height!=""&&s.height!="auto";if(l)this._computedWidth=this.width.val,this._computedHeight=this.height.val;else if(c){let d=this._Box.parentElement;this._computedWidth=this.width.val*(this.width.absolute?1:d.offsetWidth),this._computedHeight=this.height.val*(this.height.absolute?1:d.offsetHeight)}else{console.warn("Unable to properly perform layout - specification uses a relative spec, thus relies upon insertion into the DOM for layout.");return}if(this.needsLayout=!1,this.banner.element.style.fontSize=this.baseFontSize,this.vkbd&&(this.vkbd.fontSize=this.parsedBaseFontSize),t||((r=this.headerView)==null||r.refreshLayout(),this.bannerView.width=this.computedWidth,this.bannerView.refreshLayout(),(o=this.footerView)==null||o.refreshLayout()),this.vkbd){let d=this.computedHeight-this.computeFrameHeight();this.bannerView.height>0&&(d-=this.bannerView.height+5),this.vkbd.setSize(this.computedWidth,d,t);let u=this._Box.style;u.width=u.maxWidth=this.computedWidth+"px",u.height=u.maxHeight=this.computedHeight+"px"}else{let d=this._Box.style;d.width="auto",d.height="auto",d.maxWidth=d.maxHeight=""}}refreshLayoutIfNeeded(t){this.needsLayout&&this.refreshLayout(t)}postKeyboardLoad(){this._Visible=!1,this.postKeyboardAdjustments(),this.displayIfActive&&this.present()}loadActiveKeyboard(){var s,c,r,o,d;this.setBoxStyling(),this.needsLayout=!0;let t=this.keyboardView,i=this.kbdStyleSheetManager;this.kbdStyleSheetManager=new de(this._Box,this.config.doCacheBusting||!1);let l=this.keyboardView=this._GenerateKeyboardView((s=this.keyboardData)==null?void 0:s.keyboard,(c=this.keyboardData)==null?void 0:c.metadata);if(this._Box.replaceChild(l.element,t.element),l.postInsert(),(d=this.bannerController)==null||d.configureForKeyboard((r=this.keyboardData)==null?void 0:r.keyboard,(o=this.keyboardData)==null?void 0:o.metadata),t instanceof me&&t.shutdown(),i.unlinkAll(),this.banner.appendStyles(),this.vkbd){this.vkbd.createKeyTip();let u=this.vkbd.createGlobeHint();u&&this._Box.appendChild(u.element),this.vkbd.appendStyleSheet()}this.postKeyboardLoad()}_GenerateKeyboardView(t,i){let l=this.targetDevice;return this._Box.className="",t==null&&!l.touchable?new Rt:t&&t.layout(l.formFactor)?this._GenerateVisualKeyboard(t,i):!t||!i?this._GenerateVisualKeyboard(null,null):new ai(t)}_GenerateVisualKeyboard(t,i){let l=this.targetDevice,s=ta(this.config),c=new me({keyboard:t,keyboardMetadata:i,device:l,hostDevice:this.hostDevice,topContainer:this._Box,styleSheetManager:this.kbdStyleSheetManager,pathConfig:this.config.pathConfig,embeddedGestureConfig:this.config.embeddedGestureConfig,isEmbedded:this.config.isEmbedded,specialFont:{family:"SpecialOSK",files:[`${s}/keymanweb-osk.ttf`],path:""},gestureParams:this.config.gestureParams});return c.on("keyevent",(r,o)=>this.emit("keyevent",r,o)),c.on("globekey",(r,o)=>this.emit("globekey",r,o)),c.on("hiderequested",r=>{this.doHide(!0),this.emit("hiderequested",r)}),this._Box.className=l.formFactor+" "+l.OS.toLowerCase()+" kmw-osk-frame",c}present(){if(this.mayShow()){if(this.keyboardView.updateState(),this._Box.style.display="block",this.refreshLayoutIfNeeded(),this._Visible=!0,this._Box.style.opacity="1",this._Box.style.visibility=="hidden"){let t=this;window.setTimeout(function(){t._Box.style.visibility="visible"},0)}this.setDisplayPositioning()}}startHide(t){if(!this.mayHide(t))return;t&&(this.activationModel.enabled=!!(this.keyboardData.keyboard.isCJK||this.hostDevice.touchable));let i=null;this._Box&&this.hostDevice.touchable&&!(this.keyboardView instanceof Rt)&&this.config.allowHideAnimations?i=this.useHideAnimation():i=Promise.resolve(!0);let l=this;i.then(function(s){s&&l.finalizeHide()}),this.doHide(t)}finalizeHide(){if(!(document.body.className.indexOf("osk-always-visible")>=0&&this.hostDevice.formFactor=="desktop")){if(this._Box){let t=this._Box.style;t.display="none",t.transition="",t.opacity="1",this._Visible=!1}this.vkbd&&this.vkbd.onHide()}}mayShow(){return!(!this.activationModel.conditionsMet||!this.keyboardView||this.keyboardView instanceof Rt||!this.activationModel.enabled||!this._Box)}mayHide(t){return!(this.activationModel.conditionsMet&&!this.mayDisable||this.activationModel instanceof Lt||!t&&this.hostDevice.formFactor=="desktop"&&document.body.className.indexOf("osk-always-visible")>=0)}useHideAnimation(){let t=this._Box.style,i=this;return new Promise(function(l){let s=a(function(){return i._Box.removeEventListener("transitionend",s,!1),i._Box.removeEventListener("webkitTransitionEnd",s,!1),i._Box.removeEventListener("transitioncancel",s,!1),i._Box.removeEventListener("webkitTransitionCancel",s,!1),i._animatedHideTimeout!=0&&window.clearTimeout(i._animatedHideTimeout),i._animatedHideTimeout=0,i._Visible&&i.activationModel.conditionsMet?(t.transition="",t.opacity="1",l(!1),!1):(l(!0),!0)},"cleanup"),c=a(function(){i._Box.removeEventListener("transitionrun",c,!1),i._Box.removeEventListener("webkitTransitionRun",c,!1),i._Box.addEventListener("transitionend",s,!1),i._Box.addEventListener("webkitTransitionEnd",s,!1),i._Box.addEventListener("transitioncancel",s,!1),i._Box.addEventListener("webkitTransitionCancel",s,!1)},"startup");i._Box.addEventListener("transitionrun",c,!1),i._Box.addEventListener("webkitTransitionRun",c,!1),t.transition="opacity 0.5s linear 0",t.opacity="0",i._animatedHideTimeout=window.setTimeout(s,200)})}hideNow(){if(!this.mayHide(!1)||!this._Box)return;this._animatedHideTimeout&&(window.clearTimeout(this._animatedHideTimeout),this._animatedHideTimeout=0);let t=this._Box.style;t.transition="",t.opacity="0",this.finalizeHide()}shutdown(){this.removeBaseMouseEventListeners(),this.removeBaseTouchEventListeners();var t=this._Box;t.parentElement&&t.parentElement.removeChild(t),this.kbdStyleSheetManager.unlinkAll(),this.uiStyleSheetManager.unlinkAll(),this.bannerController.shutdown()}getRect(){var t={};return t.left=t.left=z(this._Box),t.top=t.top=D(this._Box),t.width=this.computedWidth,t.height=this.computedHeight,t}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}hide(){this.activationModel.enabled=!1,this.startHide(!0)}show(t){arguments.length>0?this.activationModel.enabled=t:this.activationModel.conditionsMet&&(this.activationModel.enabled=!this.activationModel.enabled)}doShow(t){this.legacyEvents.callEvent("show",t)}doHide(t){let i={HiddenByUser:t};this.legacyEvents.callEvent("hide",i)}addEventListener(t,i){this.legacyEvents.addEventListener(t,i)}removeEventListener(t,i){this.legacyEvents.removeEventListener(t,i)}};a(hn,"OSKView"),hn.STYLESHEET_FILES=["kmwosk.css","globe-hint.css"];var Ge=hn;var Gi=class Gi extends V.default{constructor(t){super();this.mouseCancellingHandler=a(function(t){return t.preventDefault(),t.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildTitleBar(),this.helpEnabled=!1,this.configEnabled=!1,t&&(this.element.onmousedown=t.mouseDownHandler)}get helpEnabled(){return this._helpEnabled}set helpEnabled(t){this._helpEnabled=t,this._helpButton.style.display=t?"inline":"none"}get configEnabled(){return this._configEnabled}set configEnabled(t){this._configEnabled=t,this._configButton.style.display=t?"inline":"none"}get layoutHeight(){return Gi.DISPLAY_HEIGHT}get element(){return this._element}setPinCJKOffset(){this._unpinButton.style.left="15px"}showPin(t){this._unpinButton.style.display=t?"block":"none"}setTitle(t){this._caption.innerHTML=t}setTitleFromKeyboard(t){let i="<span style='font-weight:bold'>"+(t==null?void 0:t.name)+"</span>";this._caption.innerHTML=i}buildTitleBar(){let t=J("div");t.id="keymanweb_title_bar",t.className="kmw-title-bar";var i=this._caption=J("span");i.className="kmw-title-bar-caption",i.style.color="#fff",t.appendChild(i);var l=this._closeButton=this.buildCloseButton();return this._closeButton.onclick=()=>(this.emit("close"),!1),t.appendChild(l),l=this._helpButton=this.buildHelpButton(),this._helpButton.onclick=()=>(this.emit("help"),!1),t.appendChild(l),l=this._configButton=this.buildConfigButton(),this._configButton.onclick=()=>(this.emit("config"),!1),t.appendChild(l),l=this._unpinButton=this.buildUnpinButton(),this._unpinButton.onclick=()=>(this.emit("unpin"),!1),t.appendChild(l),t}buildCloseButton(){var t=J("div");return t.id="kmw-close-button",t.className="kmw-title-bar-image",t.onmousedown=this.mouseCancellingHandler,t}buildHelpButton(){let t=J("div");return t.id="kmw-help-image",t.className="kmw-title-bar-image",t.title="KeymanWeb Help",t.onmousedown=this.mouseCancellingHandler,t}buildConfigButton(){let t=J("div");return t.id="kmw-config-image",t.className="kmw-title-bar-image",t.title="KeymanWeb Configuration Options",t.onmousedown=this.mouseCancellingHandler,t}buildUnpinButton(){let t=J("div");return t.id="kmw-pin-image",t.className="kmw-title-bar-image",t.title="Pin the On Screen Keyboard to its default location on the active text box",t.onmousedown=this.mouseCancellingHandler,t}refreshLayout(){}};a(Gi,"TitleBar"),Gi.DISPLAY_HEIGHT=Z.inPixels(20);var Fn=Gi;var pi=class pi extends V.default{constructor(t){super();this.mouseCancellingHandler=a(function(t){return t.preventDefault(),t.cancelBubble=!0,!1},"mouseCancellingHandler");this._element=this.buildResizeBar(),t&&(this._resizeHandle.onmousedown=t.mouseDownHandler)}get layoutHeight(){return pi.DISPLAY_HEIGHT}get element(){return this._element}get handle(){return this._resizeHandle}allowResizing(t){this._resizeHandle.style.display=t?"block":"none"}buildResizeBar(){var t=J("div");t.className="kmw-footer",t.onmousedown=this.mouseCancellingHandler;var i=J("div");i.className="kmw-footer-caption",i.innerHTML='<a href="https://keyman.com/developer/keymanweb/">KeymanWeb</a>',i.id="keymanweb-osk-footer-caption",i.addEventListener("dblclick",s=>(this.emit("showbuild"),!1),!1),t.appendChild(i);var l=J("div");return l.className="kmw-footer-resize",t.appendChild(l),this._resizeHandle=l,t}refreshLayout(){}};a(pi,"ResizeBar"),pi.DISPLAY_HEIGHT=Z.inPixels(16);var Ci=pi;var yn=class yn{constructor(n,t,i){this.x=n,this.y=t}static fromEvent(n){let t;if(window.TouchEvent&&n instanceof TouchEvent||n.changedTouches?t=n.changedTouches[0]:t=n,t.pageX)return new yn(t.pageX,t.pageY,n);if(t.clientX){let i=t.clientX+document.body.scrollLeft,l=t.clientY+document.body.scrollTop;return new yn(i,l,n)}else return new yn(null,null,n)}};a(yn,"InputEventCoordinate");var Jl=yn,Fr=class Fr{constructor(n){this._VPreviousMouseMove=document.onmousemove,this._VPreviousMouseUp=document.onmouseup,this._VPreviousCursor=document.body.style.cursor,this._VPreviousMouseButton=typeof n.which=="undefined"?n.button:n.which}restore(){document.onmousemove=this._VPreviousMouseMove,document.onmouseup=this._VPreviousMouseUp,document.body.style.cursor&&(document.body.style.cursor=this._VPreviousCursor)}matchesCausingClick(n){return this._VPreviousMouseButton==(typeof n.which=="undefined"?n.button:n.which)}};a(Fr,"MouseStartSnapshot");var hr=Fr,yr=class yr{constructor(n){this.startHandler=this._VMoveMouseDown.bind(this),this.cursorType=n}get enabled(){return this._enabled}set enabled(n){this._enabled=n}get isActive(){return!!this._mouseStartSnapshot}get mouseDownHandler(){return this.startHandler}_VMoveMouseDown(n){return!n||!this._enabled?!0:(this._mouseStartSnapshot||(this._mouseStartSnapshot=new hr(n)),this._startCoord=Jl.fromEvent(n),document.onmousemove=this._VMoveMouseMove.bind(this),document.onmouseup=this._VMoveMouseUp.bind(this),document.body.style.cursor&&(document.body.style.cursor=this.cursorType),n.preventDefault(),n.cancelBubble=!0,this.onDragStart(),!1)}_VMoveMouseMove(n){if(!n||!this.enabled)return!0;if(n.preventDefault(),n.cancelBubble=!0,this._mouseStartSnapshot.matchesCausingClick(n)){let t=Jl.fromEvent(n),i=t.x-this._startCoord.x,l=t.y-this._startCoord.y;return this.onDragMove(i,l),!1}else return this._VMoveMouseUp(n)}_VMoveMouseUp(n){return n?(this._mouseStartSnapshot.restore(),this._mouseStartSnapshot=null,n.preventDefault(),n.cancelBubble=!0,this.onDragRelease(),!1):!0}};a(yr,"MouseDragOperation");var mn=yr;var mr=class mr extends Oe{constructor(){super(...arguments);this._enabled=!0;this.actValue=null}get activate(){return this._enabled&&!!this.actValue}checkState(t){this.activate!=t&&this.emit("activate",this.activate)}get enabled(){return this._enabled}set enabled(t){let i=this.activate;this._enabled=t,this.checkState(i)}get activationTrigger(){return this.actValue}set activationTrigger(t){let i=this.activate,l=this.actValue;this.actValue=t,this.checkState(i),l!=t&&this.emit("triggerchange",t)}get conditionsMet(){return!!this.activationTrigger}};a(mr,"TwoStateActivator");var It=mr;var Gr=class Gr extends ce{constructor(){super("KeymanWeb_OnScreenKeyboard")}loadWithDefaults(n){return C(C({},n),this.load())}load(){let n=super.load((t,i)=>{switch(i){case"version":return t;default:return Number.parseInt(t,10)}});return n.width||delete n.width,n.height||delete n.height,n}save(n){super.save(n)}};a(Gr,"FloatingOSKCookieSerializer");var kl=Gr;var pr=class pr extends Ge{constructor(t){t.activator=t.activator||new It;super(t);this.userPositioned=!1;this.specifiedPosition=!1;this.noDrag=!1;this.layoutSerializer=new kl;this.restorePosition=function(t){let i=this._Visible,l=new H;this.emit("dragmove",l.corePromise),this.loadPersistedLayout(),this.userPositioned=!1,t||(delete this.dfltX,delete this.dfltY),this.savePersistedLayout(),i&&this.present(),this.titleBar.showPin(!1),l.resolve(),this.doResizeMove()}.bind(this);this.typedActivationModel.on("triggerchange",()=>this.setDisplayPositioning()),document.body.appendChild(this._Box),this.titleBar=new Fn(this.titleDragHandler),this.titleBar.on("help",()=>{this.legacyEvents.callEvent("helpclick",{})}),this.titleBar.on("config",()=>{this.legacyEvents.callEvent("configclick",{})}),this.titleBar.on("close",()=>this.startHide(!0)),this.titleBar.on("unpin",()=>this.restorePosition(!0)),this.resizeBar=new Ci(this.resizeDragHandler),this.resizeBar.on("showbuild",()=>this.emit("showbuild")),this.headerView=this.titleBar,this._Box.insertBefore(this.headerView.element,this._Box.firstChild);let i=a(c=>{let r=this.headerView;if(r&&r instanceof Fn)switch(c){case"configclick":r.configEnabled=this.legacyEvents.listenerCount("configclick")>0;break;case"helpclick":r.helpEnabled=this.legacyEvents.listenerCount("helpclick")>0;break;default:return}},"onListenedEvent"),l=new sn(this),s=new sn(this.legacyEvents);for(let c of[l,s])c.on("listeneradded",i),c.on("listenerremoved",i);this.activeKeyboard&&this.postKeyboardAdjustments(),this.loadPersistedLayout()}get typedActivationModel(){return this.activationModel}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.zIndex="9999",t.display="none",t.width="auto",t.position="absolute"}postKeyboardAdjustments(){this.titleBar&&(this.enableMoveResizeHandlers(),this.activeKeyboard&&this.titleBar.setTitleFromKeyboard(this.activeKeyboard.keyboard),this.vkbd?(this.footerView=this.resizeBar,this._Box.appendChild(this.footerView.element)):(this.footerView&&this._Box.removeChild(this.footerView.element),this.footerView=null),this.loadPersistedLayout(),this.setNeedsLayout())}isEnabled(){return this.displayIfActive}isVisible(){return this._Visible}savePersistedLayout(){var t=this.getPos();let i={visible:this.displayIfActive?1:0,userSet:this.userPositioned?1:0,left:t.left,top:t.top,_version:K.CURRENT.toString()};this.vkbd&&(i.width=this.width.val,i.height=this.height.val),this.layoutSerializer.save(i)}loadPersistedLayout(){let t=this.layoutSerializer.loadWithDefaults({visible:1,userSet:0,left:-1,top:-1,_version:void 0,width:.3*screen.width,height:.15*screen.height});this.activationModel.enabled=t.visible==1,this.userPositioned=t.userSet==1,this.x=t.left,this.y=t.top;let i=t._version,l=i===void 0,s=t.width,c=t.height;s<.2*screen.width&&(s=.2*screen.width),c<.1*screen.height&&(c=.1*screen.height),s>.9*screen.width&&(s=.9*screen.width),c>.5*screen.height&&(c=.5*screen.height),(l||!i)&&(this.headerView&&this.headerView.layoutHeight.absolute&&(c+=this.headerView.layoutHeight.val),this.footerView&&this.footerView.layoutHeight.absolute&&(c+=this.footerView.layoutHeight.val)),this.setSize(s,c),(this.x==-1||this.y==-1||!this._Box)&&(this.userPositioned=!1),this.x<window.pageXOffset-.8*s&&(this.x=window.pageXOffset-.8*s),this.y<0&&(this.x=-1,this.y=-1,this.userPositioned=!1),this.userPositioned&&this._Box&&this.setPos({left:this.x,top:this.y})}getDefaultKeyboardHeight(){if(this.configuration.heightOverride)return this.configuration.heightOverride();var t=Math.floor(Math.min(screen.availHeight,screen.availWidth)/2),i=t;if(this.targetDevice.formFactor=="phone"){var l=Math.min(screen.height,screen.width),s=Math.max(screen.height,screen.width);he()?i=i*(s/l)/1.6:i=Math.floor(Math.max(screen.availHeight,screen.availWidth)/3)}return this.targetDevice.OS==S.OperatingSystem.iOS&&(i=i/Ve(this.targetDevice.formFactor)),i}getDefaultWidth(){if(this.configuration.widthOverride)return this.configuration.widthOverride();var t;if(this.targetDevice.OS==S.OperatingSystem.iOS)t=window.innerWidth;else if(this.targetDevice.OS==S.OperatingSystem.Android)try{t=document.documentElement.clientWidth}catch(i){t=screen.availWidth}else t=screen.width;return t}doResizeMove(t){this.legacyEvents.callEvent("resizemove",t)}setRect(t){if(!(this._Box==null||this.targetDevice.formFactor!="desktop")){var i=this._Box,l=i.style;if("left"in t&&(this.x=t.left-z(i)+i.offsetLeft,l.left=this.x+"px",this.dfltX=l.left),"top"in t&&(this.y=t.top-D(i)+i.offsetTop,l.top=this.y+"px",this.dfltY=l.top),this.vkbd!=null){var s=this.vkbd.kbdDiv,c=s.style;if("width"in t){var r=t.width-(i.offsetWidth-s.offsetWidth);r<.2*screen.width&&(r=.2*screen.width),r>.9*screen.width&&(r=.9*screen.width),c.width=r+"px",this.setSize(r,this.computedHeight,!0)}if("height"in t){var o=t.height-(i.offsetHeight-s.offsetHeight);o<.1*screen.height&&(o=.1*screen.height),o>.5*screen.height&&(o=.5*screen.height),c.height=o+"px",c.fontSize=o/8+"px",this.setSize(this.computedWidth,o,!0)}"nosize"in t&&(this.resizingEnabled=!t.nosize)}"nomove"in t&&(this.noDrag=t.nomove,this.movementEnabled=!this.noDrag),this.savePersistedLayout()}}getPos(){var t=this._Box,i={left:this._Visible?t.offsetLeft:this.x,top:this._Visible?t.offsetTop:this.y};return i}setPos(t){if(typeof this._Box!="undefined"){if(this.userPositioned){var i=t.left,l=t.top;typeof i!="undefined"&&(i<-.8*this._Box.offsetWidth&&(i=-.8*this._Box.offsetWidth),this.userPositioned&&(this._Box.style.left=i+"px",this.x=i)),typeof l!="undefined"&&(l<0&&(l=0),this.userPositioned&&(this._Box.style.top=l+"px",this.y=l))}this.titleBar.showPin(this.userPositioned)}}setDisplayPositioning(){var t=this._Box.style;if(t.position="absolute",this.activationModel.activate&&(t.display="block"),t.left="0px",this.specifiedPosition||this.userPositioned)t.left=this.x+"px",t.top=this.y+"px";else{let i=this.typedActivationModel.activationTrigger||null;this.dfltX?t.left=this.dfltX:typeof i!="undefined"&&i!=null&&(t.left=z(i)+"px"),this.dfltY?t.top=this.dfltY:typeof i!="undefined"&&i!=null&&(t.top=D(i)+i.offsetHeight+"px")}this.specifiedPosition=!1}presentAtPosition(t,i){this.mayShow()&&(this.specifiedPosition=t>=0||i>=0,this.specifiedPosition&&(this.x=t,this.y=i),this.specifiedPosition=this.specifiedPosition||this.userPositioned,this.present())}present(){this.mayShow()&&(this.titleBar.showPin(this.userPositioned),super.present(),this.doShow({x:this._Box.offsetLeft,y:this._Box.offsetTop,userLocated:this.userPositioned}))}startHide(t){super.startHide(t),t&&this.savePersistedLayout()}show(t){t!==void 0?super.show(t):super.show(),this.savePersistedLayout()}userLocated(){return this.userPositioned}get movementEnabled(){return this.titleDragHandler.enabled}set movementEnabled(t){this.titleDragHandler.enabled=t,this.titleBar.showPin(t&&this.userPositioned)}get resizingEnabled(){return this.resizeDragHandler.enabled}set resizingEnabled(t){this.resizeDragHandler.enabled=t,this.resizeBar.allowResizing(t)}get isBeingMoved(){return this.titleDragHandler.isActive}get isBeingResized(){return this.resizeDragHandler.isActive}enableMoveResizeHandlers(){this.titleDragHandler.enabled=!this.noDrag,this.resizeDragHandler.enabled=!0}get titleDragHandler(){let t=this;return this._moveHandler?this._moveHandler:(this._moveHandler=new class extends mn{constructor(){super("move")}onDragStart(){this.startX=t._Box.offsetLeft,this.startY=t._Box.offsetTop,t.activeKeyboard.keyboard.isCJK&&t.titleBar.setPinCJKOffset(),this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new H,t.emit("dragmove",this.dragPromise.corePromise)}onDragMove(l,s){t.titleBar.showPin(!0),t.userPositioned=!0,t._Box.style.left=this.startX+l+"px",t._Box.style.top=this.startY+s+"px";var c=t.getRect();t.setSize(c.width,c.height,!0),t.x=c.left,t.y=c.top}onDragRelease(){t.vkbd&&(t.vkbd.currentKey=null),this.dragPromise.resolve(),this.dragPromise.then(()=>{t.userPositioned=!0,t.doResizeMove(),t.savePersistedLayout()}),this.dragPromise=null}},this._moveHandler)}get resizeDragHandler(){let t=this;return this._resizeHandler?this._resizeHandler:(this._resizeHandler=new class extends mn{constructor(){super("se-resize")}onDragStart(){this.startWidth=t.computedWidth,this.startHeight=t.computedHeight,this.dragPromise&&this.dragPromise.resolve(),this.dragPromise=new H,t.emit("resizemove",this.dragPromise.corePromise)}onDragMove(l,s){let c=this.startWidth+l,r=this.startHeight+s;c<.2*screen.width&&(c=.2*screen.width),r<.1*screen.height&&(r=.1*screen.height),c>.9*screen.width&&(c=.9*screen.width),r>.5*screen.height&&(r=.5*screen.height),t.setSize(c,r,!0)}onDragRelease(){t.vkbd&&(t.vkbd.currentKey=null),t.vkbd&&(this.startWidth=t.computedWidth,this.startHeight=t.computedHeight),t.refreshLayout(),this.dragPromise.resolve(),this.dragPromise.then(()=>{t.doResizeMove(),t.savePersistedLayout()}),this.dragPromise=null}},this._resizeHandler)}};a(pr,"FloatingOSKView");var Pe=pr;var Cr=class Cr extends Ge{constructor(t){t.isEmbedded?t.activator=t.activator||new Lt:t.activator=t.activator||new It;super(t);this.isResizing=!1;this.restorePosition=function(t){}.bind(this);document.body.appendChild(this._Box)}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.zIndex="9999",t.display="none",t.width="100%",t.position="fixed"}refreshLayout(t){if(!this.isResizing){try{this.isResizing=!0,this.doResize()}finally{this.isResizing=!1}super.refreshLayout(t)}}doResize(){if(this.vkbd){let t=this.getDefaultKeyboardHeight();this.setSize(this.getDefaultWidth(),t+this.banner.height)}}postKeyboardAdjustments(){this.doResize()}getDefaultKeyboardHeight(){var r,o;let t=this.targetDevice;if(this.configuration.heightOverride)return this.configuration.heightOverride();let i=(r=document==null?void 0:document.documentElement)==null?void 0:r.clientWidth,l=(o=document==null?void 0:document.documentElement)==null?void 0:o.clientHeight;if(typeof i=="undefined"&&(i=Math.min(screen.height,screen.width),l=Math.max(screen.height,screen.width),he())){let d=i;i=l,l=d}var s=Math.floor(Math.min(l,i)/2),c=s;return t.formFactor=="phone"&&(he()?c=Math.floor(l/1.6):c=Math.floor(l/2.4)),this.targetDevice.OS==S.OperatingSystem.iOS&&(c=c/Ve(this.targetDevice.formFactor)),c}getDefaultWidth(){var l;let t=this.targetDevice;if(this.configuration.widthOverride)return this.configuration.widthOverride();var i;return i=(l=document==null?void 0:document.documentElement)==null?void 0:l.clientWidth,typeof i=="undefined"&&(this.targetDevice.OS==S.OperatingSystem.iOS?i=window.innerWidth:t.OS==S.OperatingSystem.Android?i=screen.availWidth:i=screen.width),i}setRect(t){}getPos(){var t=this._Box,i={left:this._Visible?t.offsetLeft:this.x,top:this._Visible?t.offsetTop:this.y};return i}setPos(t){}setDisplayPositioning(){let t=this._Box.style;this.vkbd&&(t.position="fixed",t.left=t.bottom="0px",t.border="none",t.borderTop="1px solid gray")}present(){super.present(),this.legacyEvents.callEvent("show",{})}};a(Cr,"AnchoredOSKView");var Gn=Cr;var Qr=class Qr extends Oe{constructor(){super(...arguments);this.flag=!0}get enabled(){return this.flag}set enabled(t){this.activate=t}get activate(){return this.flag}set activate(t){this.flag!=t&&(this.flag=t,this.emit("activate",t))}get conditionsMet(){return!0}};a(Qr,"SimpleActivator");var pn=Qr;var Ur=class Ur extends Ge{constructor(t){t.activator=t.activator||new pn;super(t);this.restorePosition=function(t){}.bind(this)}get element(){return this._Box}_Unload(){this.keyboardView=null,this.bannerView=null,this._Box=null}setBoxStyling(){let t=this._Box.style;t.display="none",t.position="relative"}postKeyboardAdjustments(){}getDefaultKeyboardHeight(){return this.keyboardView instanceof me?this.keyboardView.height:this.computedHeight}getDefaultWidth(){return this.computedWidth}setRect(t){}getPos(){var t=this._Box,i={left:this._Visible?t.offsetLeft:void 0,top:this._Visible?t.offsetTop:void 0};return i}setPos(t){}present(){super.present(),this.legacyEvents.callEvent("show",{})}setDisplayPositioning(){}allowsDeviceChange(t){return!0}};a(Ur,"InlinedOSKView");var Cn=Ur;var Xr={};Sn(Xr,{AnchoredOSKView:()=>Qi,FloatingOSKView:()=>Ui,InlinedOSKView:()=>xr});function Zr(g){return{hostDevice:g.config.hostDevice,pathConfig:g.config.paths,predictionContextManager:g.contextManager.predictionContext,isEmbedded:!1}}a(Zr,"buildBaseOskConfiguration");var Vr=class Vr extends Gn{constructor(n,t){let i=C(C({},Zr(n)),t||{});super(i)}};a(Vr,"PublishedAnchoredOSKView");var Qi=Vr,Sr=class Sr extends Pe{constructor(n,t){let i=C(C({},Zr(n)),t||{});super(i)}};a(Sr,"PublishedFloatingOSKView");var Ui=Sr,Wr=class Wr extends Cn{constructor(n,t){let i=C(C({},Zr(n)),t||{});super(i)}};a(Wr,"PublishedInlineOSKView");var xr=Wr;var Ar=class Ar extends lt{constructor(){super(...arguments);this.events=new V.default;this.changed=!1}focus(){let t=this.getElement();t.focus&&t.focus()}isForcingScroll(){return!1}dispatchInputEventOn(t){let i;window.InputEvent&&(i=new InputEvent("input",{bubbles:!0,cancelable:!1})),t&&i&&t.dispatchEvent(i)}};a(Ar,"OutputTarget");var P=Ar;var Rr=class Rr extends P{constructor(t){super();this.root=t,this._cachedSelectionStart=-1}get isSynthetic(){return!1}static isSupportedType(t){return t=="email"||t=="search"||t=="text"||t=="url"}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(t){this.setSelection(t,t,"none")}setSelection(t,i,l){let s=this.root.value._kmwCodePointToCodeUnit(t),c=this.root.value._kmwCodePointToCodeUnit(i);this.root.setSelectionRange(s,c,l),this.processedSelectionStart=t,this.processedSelectionEnd=i,this.forceScroll(),this.root.setSelectionRange(s,c,l)}forceScroll(){let t=this.getElement(),i=t.selectionStart,l=t.selectionEnd;this._activeForcedScroll=!0;try{t.blur(),t.focus()}finally{t.selectionStart=i,t.selectionEnd=l,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}setTextBeforeCaret(t){this.getCaret();let i=this.processedSelectionEnd-this.processedSelectionStart,l=this.getSelectionDirection(),s=t._kmwLength();this.root.value=t+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(s,s+i,l)}setTextAfterCaret(t){let i=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+t,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,i)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(t){if(t>0){let i=this.getTextBeforeCaret(),l=this.processedSelectionStart;t>l&&(t=l),this.adjustDeadkeys(-t),this.setTextBeforeCaret(i.kmwSubstring(0,l-t)),this.setCaret(l-t)}}insertTextBeforeCaret(t){if(!t)return;let i=this.getCaret(),l=this.getTextBeforeCaret(),s=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(t._kmwLength()),this.root.value=l+t+s,this.setCaret(i+t._kmwLength())}handleNewlineAtCaret(){let t=this.root;t&&(t.type=="search"||t.type=="submit")?(t.disabled=!1,t.form.submit()):this.events.emit("unhandlednewline",t)}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Rr,"Input");var je=Rr;var Hr=class Hr extends P{constructor(t){super();this.root=t,this._cachedSelectionStart=-1}get isSynthetic(){return!1}getElement(){return this.root}clearSelection(){this.getCaret(),this.root.value=this.root.value._kmwSubstring(0,this.processedSelectionStart)+this.root.value._kmwSubstring(this.processedSelectionEnd),this.setCaret(this.processedSelectionStart)}isSelectionEmpty(){return this.root.selectionStart==this.root.selectionEnd}hasSelection(){return!0}invalidateSelection(){this._cachedSelectionStart=-1}getCaret(){return this.root.selectionStart!=this._cachedSelectionStart&&(this._cachedSelectionStart=this.root.selectionStart,this.processedSelectionStart=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionStart),this.processedSelectionEnd=this.root.value._kmwCodeUnitToCodePoint(this.root.selectionEnd)),this.root.selectionDirection=="forward"?this.processedSelectionEnd:this.processedSelectionStart}getDeadkeyCaret(){return this.getCaret()}setCaret(t){this.setSelection(t,t,"none")}setSelection(t,i,l){let s=this.root.value._kmwCodePointToCodeUnit(t),c=this.root.value._kmwCodePointToCodeUnit(i);this.root.setSelectionRange(s,c,l),this.processedSelectionStart=t,this.processedSelectionEnd=i,this.forceScroll(),this.root.setSelectionRange(s,c,l)}forceScroll(){let t=this.getElement(),i=t.selectionStart,l=t.selectionEnd;this._activeForcedScroll=!0;try{t.blur(),t.focus()}finally{t.selectionStart=i,t.selectionEnd=l,this._activeForcedScroll=!1}}isForcingScroll(){return this._activeForcedScroll}getSelectionDirection(){return this.root.selectionDirection}getTextBeforeCaret(){return this.getCaret(),this.getText()._kmwSubstring(0,this.processedSelectionStart)}setTextBeforeCaret(t){this.getCaret();let i=this.processedSelectionEnd-this.processedSelectionStart,l=this.getSelectionDirection(),s=t._kmwLength();this.root.value=t+this.getText()._kmwSubstring(this.processedSelectionStart),this.setSelection(s,s+i,l)}setTextAfterCaret(t){let i=this.getSelectionDirection();this.root.value=this.getTextBeforeCaret()+t,this.setSelection(this.processedSelectionStart,this.processedSelectionEnd,i)}getTextAfterCaret(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionEnd)}getSelectedText(){return this.getCaret(),this.getText()._kmwSubstring(this.processedSelectionStart,this.processedSelectionEnd)}getText(){return this.root.value}deleteCharsBeforeCaret(t){if(t>0){let i=this.getTextBeforeCaret(),l=this.processedSelectionStart;t>l&&(t=l),this.adjustDeadkeys(-t),this.setTextBeforeCaret(i.kmwSubstring(0,l-t)),this.setCaret(l-t)}}insertTextBeforeCaret(t){if(!t)return;let i=this.getCaret(),l=this.getTextBeforeCaret(),s=this.getText()._kmwSubstring(this.processedSelectionStart);this.adjustDeadkeys(t._kmwLength()),this.root.value=l+t+s,this.setCaret(i+t._kmwLength())}handleNewlineAtCaret(){this.insertTextBeforeCaret(`
`)}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Hr,"TextArea");var Qn=Hr;var vr=class vr{constructor(n,t){this.node=n,this.offset=t}};a(vr,"SelectionCaret");var xi=vr,fr=class fr{constructor(n,t){this.start=n,this.end=t}};a(fr,"SelectionRange");var Zi=fr,Lr=class Lr{constructor(n,t){this.cmd=n,this.stateType=t}};a(Lr,"StyleCommand");var Ie=Lr,Jr=class Jr extends P{constructor(t){super();if(this.root=t,t.contentWindow&&t.contentWindow.document&&t.contentWindow.document.designMode=="on")this.doc=t.contentWindow.document,this.docRoot=t.contentWindow.document.documentElement;else throw"Specified IFrame is not in design-mode!"}get isSynthetic(){return!1}getElement(){return this.root}focus(){this.doc.defaultView.focus()}isSelectionEmpty(){return this.hasSelection()?this.doc.getSelection().isCollapsed:!0}hasSelection(){let t=this.doc.getSelection(),i=document.getSelection();return i.anchorNode==t.anchorNode&&i.focusNode==t.focusNode,!0}clearSelection(){if(this.hasSelection()){let t=this.doc.getSelection();t.isCollapsed||t.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let t=this.doc.getSelection(),i=t.anchorNode.compareDocumentPosition(t.focusNode);if(t.isCollapsed){let l=new xi(t.anchorNode,t.anchorOffset);return new Zi(l,l)}else{let l=new xi(t.anchorNode,t.anchorOffset),s=new xi(t.focusNode,t.focusOffset);return l.node==s.node&&(i=s.offset-l.offset>0?2:4),i&2?new Zi(l,s):new Zi(s,l)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let t=this.getCarets().start;return t.node.nodeType!=3?"":t.node.textContent.substr(0,t.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let t=this.getCarets().end;return t.node.nodeType!=3?"":t.node.textContent.substr(t.offset)}getText(){return this.docRoot.innerText}deleteCharsBeforeCaret(t){if(!this.hasSelection()||t<=0)return;let i=this.getCarets().start;if(t>i.offset&&(t=i.offset),i.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let l=this.doc.createRange(),s=i.offset-i.node.nodeValue.substr(0,i.offset)._kmwSubstr(-t).length;l.setStart(i.node,s),l.setEnd(i.node,i.offset),this.adjustDeadkeys(-t),l.deleteContents()}insertTextBeforeCaret(t){if(!this.hasSelection())return;let i=this.getCarets().start,l=t._kmwLength(),s=this.doc.getSelection();if(l==0)return;this.adjustDeadkeys(l);let c=this.root.ownerDocument.createRange();if(i.node.nodeType==3){let o=i.node;o.insertData(i.offset,t),c.setStart(o,i.offset+t.length)}else{var r=this.doc.createTextNode(t);let o=this.doc.createRange();o.setStart(i.node,i.offset),o.collapse(!0),o.insertNode(r),c.setStart(r,t.length)}c.collapse(!0),s.removeAllRanges();try{s.addRange(c)}catch(o){i.node.parentElement.scrollIntoView(),s.addRange(c)}s.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(t){if(!this.hasSelection())return;let i=this.getCarets().end;if(t._kmwLength()!=0)if(i.node.nodeType==3){let c=i.node;c.replaceData(i.offset,c.length,t)}else{var s=i.node.ownerDocument.createTextNode(t);let c=this.root.ownerDocument.createRange();c.setStart(i.node,i.offset),c.collapse(!0),c.insertNode(s)}}saveProperties(){var t=[new Ie("backcolor",1),new Ie("fontname",1),new Ie("fontsize",1),new Ie("forecolor",1),new Ie("bold",0),new Ie("italic",0),new Ie("strikethrough",0),new Ie("subscript",0),new Ie("superscript",0),new Ie("underline",0)];this.doc.defaultView&&t.push(new Ie("hilitecolor",1));for(var i=0;i<t.length;i++){let l=t[i];l.stateType==1?l.cache=this.doc.queryCommandValue(l.cmd):l.cache=this.doc.queryCommandState(l.cmd)}this.commandCache=t}restoreProperties(t){this.commandCache||console.error("No command cache exists to restore!");for(var i=0;i<this.commandCache.length;i++){let l=this.commandCache[i];l.stateType==1?this.doc.queryCommandValue(l.cmd)!=l.cache&&(t&&t(),this.doc.execCommand(l.cmd,!1,l.cache)):this.doc.queryCommandState(l.cmd)!=l.cache&&(t&&t(),this.doc.execCommand(l.cmd,!1,null))}}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Jr,"DesignIFrame");var j=Jr;var kr=class kr{constructor(n,t){this.node=n,this.offset=t}};a(kr,"SelectionCaret");var Xi=kr,Nr=class Nr{constructor(n,t){this.start=n,this.end=t}};a(Nr,"SelectionRange");var Vi=Nr,Yr=class Yr extends P{constructor(t){var n=(...args)=>{super(...args)};if(t.isContentEditable)n(),this.root=t;else throw"Specified element is not already content-editable!"}get isSynthetic(){return!1}getElement(){return this.root}isSelectionEmpty(){return this.hasSelection()?this.root.ownerDocument.getSelection().isCollapsed:!0}hasSelection(){let t=this.root.ownerDocument.getSelection();return!(this.root!=t.anchorNode&&!this.root.contains(t.anchorNode)||this.root!=t.focusNode&&!this.root.contains(t.focusNode))}clearSelection(){if(this.hasSelection()){let t=this.root.ownerDocument.getSelection();t.isCollapsed||t.deleteFromDocument()}else console.warn("Attempted to clear an unowned Selection!")}invalidateSelection(){}getCarets(){let t=this.root.ownerDocument.getSelection(),i=t.anchorNode.compareDocumentPosition(t.focusNode);if(t.isCollapsed){let l=new Xi(t.anchorNode,t.anchorOffset);return new Vi(l,l)}else{let l=new Xi(t.anchorNode,t.anchorOffset),s=new Xi(t.focusNode,t.focusOffset);return l.node==s.node&&(i=s.offset-l.offset>0?2:4),i&2?new Vi(l,s):new Vi(s,l)}}getDeadkeyCaret(){return this.getTextBeforeCaret().kmwLength()}getTextBeforeCaret(){if(!this.hasSelection())return this.getText();let t=this.getCarets().start;return t.node.nodeType!=3?"":t.node.textContent.substr(0,t.offset)}getSelectedText(){return""}getTextAfterCaret(){if(!this.hasSelection())return"";let t=this.getCarets().end;return t.node.nodeType!=3?"":t.node.textContent.substr(t.offset)}getText(){return this.root.innerText}deleteCharsBeforeCaret(t){if(!this.hasSelection()||t<=0)return;let i=this.getCarets().start;if(t>i.offset&&(t=i.offset),i.node.nodeType!=3){console.warn("Deletion of characters requested without available context!");return}let l=this.root.ownerDocument.createRange(),s=i.offset-i.node.nodeValue.substr(0,i.offset)._kmwSubstr(-t).length;l.setStart(i.node,s),l.setEnd(i.node,i.offset),this.adjustDeadkeys(-t),l.deleteContents()}insertTextBeforeCaret(t){if(!this.hasSelection())return;let i=this.getCarets().start,l=t._kmwLength(),s=this.root.ownerDocument.getSelection();if(l==0)return;this.adjustDeadkeys(l);let c=this.root.ownerDocument.createRange();if(i.node.nodeType==3){let o=i.node;o.insertData(i.offset,t),c.setStart(o,i.offset+t.length)}else{var r=i.node.ownerDocument.createTextNode(t);let o=this.root.ownerDocument.createRange();o.setStart(i.node,i.offset),o.collapse(!0),o.insertNode(r),c.setStart(r,t.length)}c.collapse(!0),s.removeAllRanges();try{s.addRange(c)}catch(o){i.node.parentElement.scrollIntoView(),s.addRange(c)}s.collapseToEnd()}handleNewlineAtCaret(){}setTextAfterCaret(t){if(!this.hasSelection())return;let i=this.getCarets().end;if(t._kmwLength()!=0)if(i.node.nodeType==3){let c=i.node;c.replaceData(i.offset,c.length,t)}else{var s=i.node.ownerDocument.createTextNode(t);let c=this.root.ownerDocument.createRange();c.setStart(i.node,i.offset),c.collapse(!0),c.insertNode(s)}}doInputEvent(){this.dispatchInputEventOn(this.root)}};a(Yr,"ContentEditable");var Jt=Yr;function _(g,n){var t;return g?g.Window?n=="Window":(g.defaultView?t=g.defaultView[n]:g.ownerDocument&&(t=g.ownerDocument.defaultView[n]),t?g instanceof t:!1):!1}a(_,"nestedInstanceOf");function Nl(g){if(_(g,"HTMLInputElement"))return new je(g);if(_(g,"HTMLTextAreaElement"))return new Qn(g);if(_(g,"HTMLIFrameElement")){let n=g;return n.contentWindow&&n.contentWindow.document&&n.contentWindow.document.designMode=="on"?new j(n):g.isContentEditable?new Jt(g):null}else if(g.isContentEditable)return new Jt(g);return null}a(Nl,"wrapElement");var Er=class Er{constructor(){this.pending=!1;let n=this.bg=document.createElement("div"),t=document.createElement("div"),i=this.lt=document.createElement("div"),l=this.gr=document.createElement("div"),s=this.bx=document.createElement("div");n.className="kmw-wait-background",t.className="kmw-wait-box",this.dismiss=null,i.className="kmw-wait-text",l.className="kmw-wait-graphic",s.className="kmw-alert-close";let c=t.onmousedown=t.onclick=o=>{s.style.display=="block"&&(n.style.display="none",this.dismiss&&this.dismiss())};t.addEventListener("touchstart",c,!1);let r=n.onmousedown=n.onclick=o=>{o.preventDefault(),o.stopPropagation()};n.addEventListener("touchstart",r,!1),t.appendChild(s),t.appendChild(i),t.appendChild(l),n.appendChild(t),document.body.appendChild(n)}get rootElement(){return this.bg}wait(n){let t=this.bg;typeof t=="undefined"||t==null||(n?(this.pending=!0,window.setTimeout(()=>{this.pending&&(window.scrollTo(0,0),this.bx.style.display="none",this.lt.className="kmw-wait-text",this.lt.innerHTML=n,this.gr.style.display="block",t.style.display="block")},1e3)):this.pending&&(this.lt.innerHTML="",this.pending=!1,t.style.display="none"))}alert(n,t){let i=this.bg;this.bx.style.display="block",this.lt.className="kmw-alert-text",this.lt.innerHTML=n,this.gr.style.display="none",i.style.display="block",this.dismiss=arguments.length>1?t:null}shutdown(){this.bg.parentNode.removeChild(this.bg)}};a(Er,"AlertHost");var bt=Er;function Si(){return document.readyState==="complete"?Promise.resolve():new Promise((g,n)=>{let t=a(()=>{window.removeEventListener("load",t),g()},"loadHandler");window.addEventListener("load",t)})}a(Si,"whenDocumentReady");var Tr=class Tr extends kn{initialize(t){this._options?this._options=C(C({},this._options),t):this._options=C({},t),super.initialize(t),this._options=t,this._ui=t.ui,this._attachType=t.attachType,Si().then(()=>{var i;t.useAlerts&&!this.alertHost?this._alertHost=new bt:!t.useAlerts&&this.alertHost&&((i=this._alertHost)==null||i.shutdown(),this._alertHost=null)})}get options(){return this._options}get attachType(){return this._attachType}get alertHost(){return this._alertHost}set signalUser(t){(!t||t!=this.alertHost)&&this.alertHost.shutdown(),this._alertHost=t}debugReport(){let t=super.debugReport();return t.attachType=this.attachType,t.ui=this._ui,t.keymanEngine="app/browser",t}onRuleFinalization(t,i){let l=t.transcription.transform;Zt(l)||i instanceof P&&(i.changed=!0)}};a(Tr,"BrowserConfiguration");var Yl=Tr,na=C({ui:"",attachType:"",useAlerts:!0},Xs);var wr=class wr{constructor(n,t,i){this.interface=n,this.keyboard=t}};a(wr,"AttachmentInfo");var Wi=wr;function _e(g){let n=g==null?void 0:g.target;return Se(n)}a(_e,"eventOutputTarget");function Se(g){var n;if(g==null)return null;if(g.body&&(g=g.body),g.nodeType==3&&(g=g.parentNode),_(g,"HTMLInputElement")){let t=g.type.toLowerCase();if(!(t=="text"||t=="search"))return null}return(n=g._kmwAttachment)==null?void 0:n.interface}a(Se,"outputTargetForElement");var El=class El extends V.default{constructor(t,i){if(!t)throw new Error("Cannot attach to a null/undefined document");super();this.baseFont="";this.appliedFont="";this.embeddedPageContexts=[];this._inputList=[];this._sortedInputs=[];this._InputModeObserverCore=a(t=>{this.disableInputModeObserver();try{for(let i of t){let l=i.target;this.isAttached(l)&&(l._kmwAttachment.inputMode=l.inputMode,this.device.touchable&&(l.inputMode="none"))}}finally{this.enableInputModeObserver()}},"_InputModeObserverCore");this._EnablementMutationObserverCore=a(t=>{for(var i=0;i<t.length;i++){var l=t[i],s=l.oldValue?l.oldValue.indexOf("kmw-disabled")>=0:!1,c=l.target.className.indexOf("kmw-disabled")>=0;if(s&&!c?this._EnableControl(l.target):!s&&c&&this._DisableControl(l.target),!c&&l.attributeName=="readonly"){var r=l.oldValue?l.oldValue!=null:!1,o=l.target;if(o instanceof o.ownerDocument.defaultView.HTMLInputElement||o instanceof o.ownerDocument.defaultView.HTMLTextAreaElement){var d=o.readOnly;r&&!d?this._EnableControl(l.target):!r&&d&&this._DisableControl(l.target)}}}},"_EnablementMutationObserverCore");this._AutoAttachObserverCore=a(t=>{for(var i=[],l=[],s=0;s<t.length;s++){let o=t[s];for(var c=0;c<o.addedNodes.length;c++)i=i.concat(this._GetDocumentEditables(o.addedNodes[c]));for(c=0;c<o.removedNodes.length;c++)l=l.concat(this._GetDocumentEditables(o.removedNodes[c]))}for(var r=0;r<i.length;r++)this.isKMWInput(i[r])&&this._MutationAdditionObserved(i[r]);for(r=0;r<l.length;r++){let o=!1,d=l[r];if(d instanceof d.ownerDocument.defaultView.HTMLIFrameElement){for(let u=0;u<this.embeddedPageContexts.length;u++)if(this.embeddedPageContexts[u].options.owner==d){this.embeddedPageContexts[u].shutdown(),this.embeddedPageContexts.splice(u,1),o=!0;break}if(!o){for(let u=0;u<this._inputList.length;u++)if(this._inputList[u]==d){this.detachFromControl(d),this._inputList[u]==d&&this._inputList.splice(u,1);break}}}else this.isKMWInput(d)&&this._MutationRemovalObserved(d)}(i.length||l.length)&&(this.device.touchable?this.device.touchable&&window.setTimeout(()=>{this.listInputs()},1):this.listInputs())},"_AutoAttachObserverCore");this._MutationAdditionObserved=a(t=>{if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement){let i=a(()=>{window.setTimeout(()=>{this.attachToControl(t)},1)},"attachFunctor");t.addEventListener("load",i)}else this.attachToControl(t)},"_MutationAdditionObserved");this._MutationRemovalObserved=a(t=>{this.detachFromControl(t)},"_MutationRemovalObserved");this.options=i,this.document=t,this.stylesheetManager=new de(this.document.body)}get device(){return this.options.hostDevice}get window(){return this.document.defaultView}get inputList(){let t=this.embeddedPageContexts.map(i=>i.inputList).reduce((i,l)=>i.concat(l),[]);return[].concat(this._inputList).concat(t)}get sortedInputs(){return this._sortedInputs}install(t){this.manualAttach=t,this.baseFont=this.getBaseFont(),this.manualAttach||(this._SetupDocument(this.document.documentElement),this.listInputs()),this.options.owner||this.initMutationObservers(this.document,t)}setupElementAttachment(t){if(!t._kmwAttachment){let i=Nl(t);i||_(t,"HTMLIFrameElement")||console.warn("Could not create processing interface for newly-attached element!"),t._kmwAttachment=new Wi(i,null,this.device.touchable)}}clearElementAttachment(t){t._kmwAttachment=null}isKMWInput(t){if(t instanceof t.ownerDocument.defaultView.HTMLTextAreaElement)return!0;if(t instanceof t.ownerDocument.defaultView.HTMLInputElement){if(je.isSupportedType(t.type))return!0}else if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)try{if(t.contentWindow){let i=t.contentWindow.document;if(i)return!(this.device.touchable&&i.designMode.toLowerCase()=="on")}else return!!t._kmwAttachment}catch(i){console.warn("Error during attachment to / detachment from iframe: "),console.warn(i)}else if(t.isContentEditable)return!0;return!1}isAttached(t){if(t._kmwAttachment)return!0;if(_(t,"HTMLIFrameElement")){if(t.contentDocument==this.document)return!0;for(let l of this.embeddedPageContexts)if(l.isAttached(t))return!0}return!1}isKMWDisabled(t){let i=t.className;return t.readOnly?!0:!!(i&&i.indexOf("kmw-disabled")>=0)}enableInputElement(t){var i;this.isKMWDisabled(t)||(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement?this._AttachToIframe(t):(this.setupElementAttachment(t),t._kmwAttachment.inputMode=(i=t.inputMode)!=null?i:"text",this.disableInputModeObserver(),t.inputMode="none",this.enableInputModeObserver(),t.classList.add("keymanweb-font"),this._inputList.push(t),this.emit("enabled",t)))}disableInputElement(t){var l;if(t)if(t.ownerDocument.defaultView&&t instanceof t.ownerDocument.defaultView.HTMLIFrameElement||t instanceof HTMLIFrameElement)this._DetachFromIframe(t);else{if(this.isAttached(t)){let c=(l=t._kmwAttachment)==null?void 0:l.inputMode;this.disableInputModeObserver(),t.inputMode=c,this.enableInputModeObserver()}t.className.indexOf("keymanweb-font")>=0&&(t.className=t.className.replace("keymanweb-font","").trim());var i=this.inputList.indexOf(t);i>-1&&this._inputList.splice(i,1),this.emit("disabled",t)}}enableTouchElement(t){return this.isKMWDisabled(t)?(this.emit("disabled",t),!1):(this.isAttached(t)||this.setupElementAttachment(t),this.enableInputElement(t),!0)}disableTouchElement(t){if(this.isAttached(t)){let i=t._kmwAttachment.inputMode;this.disableInputModeObserver(),t.inputMode=i,this.enableInputModeObserver()}}_AttachToIframe(t){try{let i=t.contentWindow.document;if(i){if(i.designMode.toLowerCase()=="on")this.setupElementAttachment(t),i.body._kmwAttachment=t._kmwAttachment,this._inputList.push(t),this.emit("enabled",t);else if(this.embeddedPageContexts.filter(l=>l.document==i).length==0){let l=new El(i,W(C({},this.options),{owner:t}));this.embeddedPageContexts.push(l),l.on("enabled",s=>this.emit("enabled",s)),l.on("disabled",s=>this.emit("disabled",s)),l.install(this.manualAttach)}}}catch(i){}}_DetachFromIframe(t){let i=a(()=>{this.clearElementAttachment(t);let l=this._inputList.indexOf(t);l!=-1&&this._inputList.splice(l,1),this.emit("disabled",t)},"detachFromDesignIframe");try{let l=t.contentWindow.document;if(l){if(l.designMode.toLowerCase()=="on")l.body._kmwAttachment=null,i();else for(let s=0;s<this.embeddedPageContexts.length;s++)if(this.embeddedPageContexts[s].document==l){let c=this.embeddedPageContexts.splice(s,1)[0];c._ClearDocument(l.body),c.shutdown(),this.embeddedPageContexts.splice(s,1);break}}}catch(l){t._kmwAttachment&&i()}}attachToControl(t){var i=this.device.touchable;this.isAttached(t)&&!(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)||(this.isKMWInput(t)?this.isKMWDisabled(t)?this.emit("disabled",t):i?this.enableTouchElement(t):this.enableInputElement(t):i&&this.emit("disabled",t))}detachFromControl(t){(this.isAttached(t)||t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)&&(this.isKMWInput(t)&&(this.isKMWDisabled(t)||this._DisableControl(t)),this.clearElementAttachment(t))}_DisableControl(t){(this.isAttached(t)||t instanceof t.ownerDocument.defaultView.HTMLIFrameElement)&&(this.device.touchable&&this.disableTouchElement(t),this.listInputs(),this.disableInputElement(t))}_EnableControl(t){this.isAttached(t)?(this.device.touchable?this.enableTouchElement(t):this.enableInputElement(t),this.listInputs()):_(t,"HTMLIFrameElement")&&this._AttachToIframe(t)}disableControl(t){this.isAttached(t)||console.warn("KeymanWeb is not attached to element "+t);var i=t.className;i.indexOf("kmw-disabled")<0&&(t.className=i?i+" kmw-disabled":"kmw-disabled")}enableControl(t){!this.isAttached(t)&&!_(t,"HTMLIFrameElement")&&console.warn("KeymanWeb is not attached to element "+t);var i=t.className,l=i.indexOf("kmw-disabled");l>=0&&(t.className=i.replace("kmw-disabled","").trim())}listInputs(){let t=[],i=document.getElementsByTagName("input"),l=document.getElementsByTagName("textarea");for(let c=0;c<i.length;c++)je.isSupportedType(i[c].type)&&i[c].className.indexOf("kmw-disabled")<0&&t.push({ip:i[c],x:z(i[c]),y:D(i[c])});for(let c=0;c<l.length;c++)l[c].className.indexOf("kmw-disabled")<0&&t.push({ip:l[c],x:z(l[c]),y:D(l[c])});t.sort((c,r)=>c.y!=r.y?c.y-r.y:c.x-r.x);let s=[];for(let c=0;c<t.length;c++)s.push(t[c].ip);this._sortedInputs=s}findNeighboringInput(t,i){var l,s=this.sortedInputs;if(s.length==0)return null;for(l=0;l<s.length&&s[l]!=t;l++);return l==s.length&&!i&&l--,l=i?l-1:l+1,l=l>=s.length?l-s.length:l,l=l<0?l+s.length:l,s[l]}_GetDocumentEditables(t){let i=[];if(t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement){let s=t.ownerDocument.defaultView;(t instanceof s.HTMLInputElement||t instanceof s.HTMLTextAreaElement||t instanceof s.HTMLIFrameElement)&&i.push(t)}if(t.getElementsByTagName){var l=a(function(s){return tl(t.getElementsByTagName(s))},"LiTmp");i=i.concat(l("INPUT"),l("TEXTAREA"),l("IFRAME"))}return t.querySelectorAll&&(i=i.concat(tl(t.querySelectorAll("[contenteditable]")))),t.ownerDocument&&t instanceof t.ownerDocument.defaultView.HTMLElement&&t.isContentEditable&&i.push(t),i}_SetupDocument(t){let i=this._GetDocumentEditables(t);for(var l=0;l<i.length;l++)this.attachToControl(i[l])}_ClearDocument(t){let i=this._GetDocumentEditables(t);for(var l=0;l<i.length;l++)this.detachFromControl(i[l])}initMutationObservers(t,i){if(typeof MutationObserver=="function"){var l=t.querySelector("body"),s;i||(s={childList:!0,subtree:!0},this.attachmentObserver=new MutationObserver(this._AutoAttachObserverCore),this.attachmentObserver.observe(l,s)),s={subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["class","readonly"]},this.enablementObserver=new MutationObserver(this._EnablementMutationObserverCore),this.enablementObserver.observe(l,s),this.inputModeObserver=new MutationObserver(this._InputModeObserverCore),this.enableInputModeObserver()}else console.warn("Your browser is outdated and does not support MutationObservers, a web feature needed by KeymanWeb to support dynamically-added elements.")}enableInputModeObserver(){var l;let t=document.querySelector("body"),i={subtree:!0,attributes:!0,attributeFilter:["inputmode"]};(l=this.inputModeObserver)==null||l.observe(t,i)}disableInputModeObserver(){var t;(t=this.inputModeObserver)==null||t.disconnect()}getBaseFont(){var t=document.getElementsByTagName("input"),i=document.getElementsByTagName("textarea"),l=0,s,c="Arial,sans-serif";if(t.length==0&&i.length==0)l=0;else if(t.length>0&&i.length==0)l=1;else if(t.length==0&&i.length>0)l=2;else{var r=t[0],o=i[0];r.offsetTop<o.offsetTop?l=1:r.offsetTop>o.offsetTop?l=2:r.offsetLeft<o.offsetLeft?l=1:r.offsetLeft>o.offsetLeft&&(l=2)}switch(l){case 0:s=c;break;case 1:s=getComputedStyle(t[0]).fontFamily||"";break;case 2:s=getComputedStyle(i[0]).fontFamily||"";break}return(typeof s=="undefined"||s=="monospace")&&(s=c),s}buildAttachmentFontStyle(t){let i=t,l=this.baseFont;i&&typeof i.family!="undefined"&&(l=i.family),l=l.replace(/\u0022/g,"");var s=new RegExp("\\s?"+l+",?"),c=this.appliedFont.replace(/\u0022/g,"");c=c.replace(s,""),c=c.replace(/,$/,""),c==""?c=l:c=l+","+c,c='"'+c.replace(/\,\s?/g,'","')+'"';let r=`.keymanweb-font{
font-family:`+c+` !important;
}
`;return this.appliedFont=c,r}setAttachmentFont(t,i,l){this.stylesheetManager.unlinkAll(),this.stylesheetManager.addStyleSheetForFont(t,i,l),this.stylesheetManager.linkStylesheet(st(this.buildAttachmentFontStyle(t)))}shutdown(){var t,i,l,s;try{(t=this.enablementObserver)==null||t.disconnect(),(i=this.attachmentObserver)==null||i.disconnect(),(l=this.inputModeObserver)==null||l.disconnect(),(s=this.stylesheetManager)==null||s.unlinkAll(),this.inputModeObserver=null,this.embeddedPageContexts.forEach(c=>{try{c.shutdown()}catch(r){}});for(let c of this.inputList)try{this.detachFromControl(c)}catch(r){this.emit("disabled",c)}this._inputList=[]}catch(c){console.error("Error occurred during shutdown"),console.error(c)}}};a(El,"PageContextAttachment");var Ai=El;var Kr=class Kr{constructor(n,t){this.activationPending=n,this.activated=t}};a(Kr,"FocusStateAPIObject");var Mr=Kr,zr=class zr extends V.default{constructor(t){super();this._maintainingFocus=!1;this.restoringFocus=!1;this._IgnoreNextSelChange=0;this.isTargetForcingScroll=t}get maintainingFocus(){return this._maintainingFocus}set maintainingFocus(t){let i=this._maintainingFocus;this._maintainingFocus=t,i&&!t&&this.emit("maintainingfocusend")}getUIState(){return new Mr(this.maintainingFocus,this.restoringFocus)}setMaintainingFocus(t){this.maintainingFocus=!!t}setFocusTimer(){this.focusing=!0,this.focusTimer=window.setTimeout(()=>{this.focusing=!1},50)}};a(zr,"FocusAssistant");var Tl=zr;function ia(g,n){let t=n!=null&&n.isRTL?"rtl":"ltr";g&&(g instanceof g.ownerDocument.defaultView.HTMLInputElement||g instanceof g.ownerDocument.defaultView.HTMLTextAreaElement?g.value.length==0&&(g.dir=t):typeof g.textContent=="string"&&g.textContent.length==0&&(g.dir=t))}a(ia,"_SetTargDir");var wl=class wl extends Yn{constructor(t,i){super(t);this.cookieManager=new ce("KeymanWeb_Keyboard");this.focusAssistant=new Tl(()=>{var t;return(t=this.activeTarget)==null?void 0:t.isForcingScroll()});this.domEventTracker=new Ze;this._ControlFocus=a(t=>{let i=_e(t);return i&&this.setActiveTarget(i,!0),!0},"_ControlFocus");this._ControlBlur=a(t=>{if(this.focusAssistant._IgnoreNextSelChange)return this.focusAssistant._IgnoreNextSelChange--,t.cancelBubble=!0,t.stopPropagation(),!0;if(this.focusAssistant.isTargetForcingScroll())return t.cancelBubble=!0,t.stopPropagation(),!0;let i=_e(t);if(i==null)return!0;this.lastActiveTarget&&this._BlurKeyboardSettings(this.lastActiveTarget.getElement());let l=this.activeTarget;this.currentTarget=null,(l||this.lastActiveTarget)&&(this.mostRecentTarget=i),this.focusAssistant.restoringFocus=!1;let s=this.activeKeyboard,c=this.focusAssistant.maintainingFocus;return!c&&s&&s.keyboard.notify(0,i,0),l&&!this.activeTarget&&this.emit("targetchange",null),this.apiEvents.callEvent("controlblurred",{target:i.getElement(),event:t,isActivating:c}),this.doChangeEvent(i),this.resetContext(),!0},"_ControlBlur");this._Click=a(t=>(this.resetContext(),!0),"_Click");this.nonKMWTouchHandler=a(t=>{this.focusAssistant.focusing=!1,clearTimeout(this.focusAssistant.focusTimer),this.forgetActiveTarget()},"nonKMWTouchHandler");this._eventsObj=i,this.page=new Ai(window.document,{hostDevice:this.engineConfig.hostDevice}),this.focusAssistant.on("maintainingfocusend",()=>{!this.activeTarget&&this.mostRecentTarget&&this.emit("targetchange",this.activeTarget)})}get apiEvents(){return this._eventsObj()}initialize(){this.on("keyboardasyncload",(t,i)=>{var l;(l=this.engineConfig.alertHost)==null||l.wait("Installing keyboard<br/>"+t.name),i.then(()=>{var s;(s=this.engineConfig.alertHost)==null||s.wait()})}),this.engineConfig.deferForInitialization.then(()=>{let t=this.engineConfig.hostDevice,i=a(l=>l.stopPropagation(),"noPropagation");this.page.on("enabled",l=>{if(!(l._kmwAttachment.interface instanceof j))t.touchable&&(this.domEventTracker.detachDOMEvent(l,"touchstart",this.nonKMWTouchHandler),this.domEventTracker.attachDOMEvent(l,"touchmove",i,!1),this.domEventTracker.attachDOMEvent(l,"touchend",i,!1)),this.domEventTracker.attachDOMEvent(l,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(l,"blur",this._ControlBlur),this.domEventTracker.attachDOMEvent(l,"click",this._Click);else{var s=l.contentWindow.document;t.browser=="firefox"?(this.domEventTracker.attachDOMEvent(s,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s,"blur",this._ControlBlur)):(this.domEventTracker.attachDOMEvent(s.body,"focus",this._ControlFocus),this.domEventTracker.attachDOMEvent(s.body,"blur",this._ControlBlur))}l.ownerDocument.activeElement==l&&this.setActiveTarget(Se(l),!0)}),this.page.on("disabled",l=>{var c;if(!_(l,"HTMLIFrameElement"))t.touchable&&this.domEventTracker.attachDOMEvent(l,"touchstart",this.nonKMWTouchHandler,!1),this.domEventTracker.detachDOMEvent(l,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(l,"blur",this._ControlBlur),this.domEventTracker.detachDOMEvent(l,"click",this._Click);else{let r=l.contentWindow.document;t.browser=="firefox"?(this.domEventTracker.detachDOMEvent(r,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(r,"blur",this._ControlBlur)):(this.domEventTracker.detachDOMEvent(r.body,"focus",this._ControlFocus),this.domEventTracker.detachDOMEvent(r.body,"blur",this._ControlBlur))}var s=(c=this.mostRecentTarget)==null?void 0:c.getElement();s&&s==l&&this.forgetActiveTarget()}),this.page.install(this.engineConfig.attachType=="manual")})}get activeTarget(){let t=this.focusAssistant.maintainingFocus;return this.currentTarget||(t?this.mostRecentTarget:null)}get lastActiveTarget(){return this.mostRecentTarget}deactivateCurrentTarget(){let t=this.activeTarget||this.lastActiveTarget;t&&this.page.isAttached(t.getElement())&&this._BlurKeyboardSettings(t.getElement()),this.activeTarget||this.setActiveTarget(null,!0)}forgetActiveTarget(){this.focusAssistant.maintainingFocus=!1,this.focusAssistant.restoringFocus=!1;let t=this.activeTarget||this.mostRecentTarget;t&&this._BlurKeyboardSettings(t.getElement()),this.setActiveTarget(null,!0),t==this.lastActiveTarget&&(this.mostRecentTarget=null)}setActiveTarget(t,i){var o;let l=this.mostRecentTarget,s=this.activeTarget;if(t==s){s&&(this.currentTarget=s);return}let c=!!l;if(this.currentTarget=this.mostRecentTarget=t,this.predictionContext.setCurrentTarget(t),this.focusAssistant.restoringFocus?this._BlurKeyboardSettings(t.getElement()):t&&this._FocusKeyboardSettings(t.getElement(),!c),this._CommonFocusHelper(t))return;let r=t==null?void 0:t.getElement();if(t instanceof j&&(r=t.docRoot),r&&r.ownerDocument&&r instanceof r.ownerDocument.defaultView.HTMLElement&&ia(r,(o=this.activeKeyboard)==null?void 0:o.keyboard),t!=s&&this.emit("targetchange",t),i){let d=l==null?void 0:l.getElement();l instanceof j&&(d=l.docRoot),r?this.apiEvents.callEvent("controlfocused",{target:r,activeControl:d}):d&&this.apiEvents.callEvent("controlblurred",{target:d,event:null,isActivating:this.focusAssistant.maintainingFocus})}}get activeKeyboard(){return this._activeKeyboard}restoreLastActiveTarget(){this.mostRecentTarget&&(this.focusAssistant.restoringFocus=!0,this.mostRecentTarget.focus(),this.focusAssistant.restoringFocus=!1)}insertText(t,i,l){this.restoreLastActiveTarget();let s=this.activeTarget;return s==null&&this.mostRecentTarget&&(s=this.activeTarget),s!=null?super.insertText(t,i,l):!1}currentKeyboardSrcTarget(){let t=this.currentTarget||this.mostRecentTarget;return this.isTargetKeyboardIndependent(t)?t:null}isTargetKeyboardIndependent(t){let i=t==null?void 0:t.getElement()._kmwAttachment;return!!(i!=null&&i.keyboard||(i==null?void 0:i.keyboard)==="")}activateKeyboardForTarget(t,i){var s,c;let l=i==null?void 0:i.getElement()._kmwAttachment;if(l?(l.keyboard=(s=t==null?void 0:t.metadata.id)!=null?s:"",l.languageCode=(c=t==null?void 0:t.metadata.langId)!=null?c:""):this.globalKeyboard=t,this.currentKeyboardSrcTarget()==i){this._activeKeyboard=t;let r=t==null?void 0:t.metadata;this.page.setAttachmentFont(r==null?void 0:r.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS)}}setKeyboardForTarget(t,i,l){if(t instanceof j){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}let s=t.getElement()._kmwAttachment,c=this.currentKeyboardSrcTarget()==t;if(s){if(s.keyboard=i||null,s.languageCode=l||null,c||this.currentKeyboardSrcTarget()==t){let r=this.globalKeyboard.metadata;this.activateKeyboard(s.keyboard||r.id,s.languageCode||r.langId,!0)}}else return}getKeyboardStubForTarget(t){if(this.isTargetKeyboardIndependent(t)){let i=t.getElement()._kmwAttachment;return this.keyboardCache.getStub(i.keyboard,i.languageCode)}else return this.globalKeyboard.metadata}getFallbackStubKey(){let t={id:"",langId:""};return this.engineConfig.hostDevice.touchable&&this.keyboardCache.defaultStub||t}activateKeyboard(t,i,l){return A(this,null,function*(){var c,r,o,d,u,B;l||(l=!1);let s=this.currentKeyboardSrcTarget();this.engineConfig.deferForInitialization.isFulfilled||(yield this.engineConfig.deferForInitialization.corePromise),t||(t=this.getFallbackStubKey().id,i=this.getFallbackStubKey().langId);try{let b=yield Ji(wl.prototype,this,"activateKeyboard").call(this,t,i,l);return(c=this.engineConfig.alertHost)==null||c.wait(),l&&!s&&this.cookieManager.save({current:`${t}:${i}`}),s==this.currentKeyboardSrcTarget()&&(ia((r=this.currentTarget)==null?void 0:r.getElement(),this.keyboardCache.getKeyboard(t)),this.page.setAttachmentFont((d=(o=this.activeKeyboard)==null?void 0:o.metadata)==null?void 0:d.KFont,this.engineConfig.paths.fonts,this.engineConfig.hostDevice.OS),this.restoreLastActiveTarget()),b}catch(b){let I=a(()=>A(this,null,function*(){let h=this.getFallbackStubKey();h.id!=t&&(yield this.activateKeyboard(h.id,h.langId,!0).catch(()=>{}))}),"fallback");(u=this.engineConfig.alertHost)==null||u.wait();let F=(b==null?void 0:b.message)||"Sorry, the "+t+" keyboard for "+i+" is not currently available.";throw b instanceof pt?console.error(b||F):console.warn(b||F),this.engineConfig.alertHost?(B=this.engineConfig.alertHost)==null||B.alert(F,I):yield I(),b}})}_BlurKeyboardSettings(t,i,l){var r;var s=this.activeKeyboard?this.activeKeyboard.keyboard.id:"",c=(r=this.activeKeyboard)==null?void 0:r.metadata.langId;i!==void 0&&l!==void 0&&(s=i,c=l),t&&t._kmwAttachment.keyboard!=null?(t._kmwAttachment.keyboard=s,t._kmwAttachment.languageCode=c):this.globalKeyboard=this.activeKeyboard}_FocusKeyboardSettings(t,i){var c;let l=t._kmwAttachment,s=this.globalKeyboard;l.keyboard!=null?this.activateKeyboard(l.keyboard,l.languageCode,!0):!i&&(s==null?void 0:s.metadata)!=((c=this._activeKeyboard)==null?void 0:c.metadata)&&this.activateKeyboard(s==null?void 0:s.metadata.id,s==null?void 0:s.metadata.langId,!0)}_CommonFocusHelper(t){var s;let i=this.focusAssistant,l=(s=this.activeKeyboard)==null?void 0:s.keyboard;return i.restoringFocus||(t==null||t.deadkeys().clear(),l==null||l.notify(0,t,1)),!i.restoringFocus&&this.mostRecentTarget!=t&&(i.maintainingFocus=!1),i.restoringFocus=!1,this.resetContext(),!1}doChangeEvent(t){if(t.changed){let i=new Event("change",{bubbles:!0,cancelable:!1});t.getElement().dispatchEvent(i)}t.changed=!1}getSavedKeyboardRaw(){var i=new ce("KeymanWeb_Keyboard").load(decodeURIComponent);return typeof i.current!="string"?null:i.current=="Keyboard_us:eng"?"Keyboard_us:en":i.current}getSavedKeyboard(){let t=this.getSavedKeyboardRaw(),i=this.keyboardCache.getStubList(),l;for(let s=0;s<i.length;s++)if(l=i[s].KI+":"+i[s].KLC,l==t)return l;for(let s=0;s<i.length;s++)if(l=i[s].KI+":"+i[s].KLC,l=="Keyboard_us:en")return l;return i.length>0?i[0].KI+":"+i[0].KLC:"Keyboard_us:en"}restoreSavedKeyboard(t){let l=t.split(":");if(l.length<2&&(l[1]=""),this.keyboardCache.getStub(l[0],l[1]))this.activateKeyboard(l[0],l[1]);else{let{id:c,langId:r}=this.getFallbackStubKey();this.activateKeyboard(c,r)}}shutdown(){this.page.shutdown(),this.domEventTracker.shutdown()}};a(wl,"ContextManager");var Ri=wl;var Dr=class Dr extends We{constructor(t){super();this.contextManager=t}isCommand(t){switch(this.codeForEvent(t)){case Q.keyCodes.K_TAB:case Q.keyCodes.K_TABBACK:case Q.keyCodes.K_TABFWD:return!0;default:return super.isCommand(t)}}applyCommand(t,i){let l=this.codeForEvent(t),s=a(c=>{var u;let r=this.contextManager,o=(u=r.activeTarget)==null?void 0:u.getElement(),d=r.page.findNeighboringInput(o,c);d==null||d.focus()},"moveToNext");switch(l){case Q.keyCodes.K_TAB:s((t.Lmodifiers&m.K_SHIFTFLAG)!=0);break;case Q.keyCodes.K_TABBACK:s(!0);break;case Q.keyCodes.K_TABFWD:s(!1);break}super.applyCommand(t,i)}};a(Dr,"DefaultBrowserRules");var Hi=Dr;function Or(g){return g.keyCode?g.keyCode:g.which?g.which:null}a(Or,"_GetEventKeyCode");function Ml(g,n,t){if(g.cancelBubble===!0)return null;let i=Or(g);if(i==null)return null;var l=n.modStateFlags,s=0,c=!1,r=!1;let o=Q.keyCodes;switch(i){case o.K_CTRL:case o.K_LCTRL:case o.K_RCTRL:case o.K_CONTROL:case o.K_LCONTROL:case o.K_RCONTROL:c=!0;break;case o.K_LMENU:case o.K_RMENU:case o.K_ALT:case o.K_LALT:case o.K_RALT:r=!0;break}s|=g.getModifierState("Shift")?16:0,g.getModifierState("Control")&&(s|=g.location!=0&&c?g.location==1?m.LCTRLFLAG:m.RCTRLFLAG:l&3),g.getModifierState("Alt")&&(s|=g.location!=0&&r?g.location==1?m.LALTFLAG:m.RALTFLAG:l&12);let d=0;d|=g.getModifierState("CapsLock")?m.CAPITALFLAG:m.NOTCAPITALFLAG,d|=g.getModifierState("NumLock")?m.NUMLOCKFLAG:m.NOTNUMLOCKFLAG,d|=g.getModifierState("ScrollLock")?m.SCROLLFLAG:m.NOTSCROLLFLAG,s|=d;let u=n.modStateFlags!=s;n.modStateFlags=s;let B=m.RALTFLAG|m.LCTRLFLAG;(l&B)==B&&(s&B)!=B&&(s&=~B),s&m.RALTFLAG&&(s&=~m.LCTRLFLAG);let b=Q.modifierBitmasks,I=n.activeKeyboard,F;I&&I.isChiral?(F=s&b.CHIRAL,I.emulatesAltGr&&(F&b.ALT_GR_SIM)==b.ALT_GR_SIM&&(F^=b.ALT_GR_SIM,F|=m.RALTFLAG)):F=s&16|(s&(m.LCTRLFLAG|m.RCTRLFLAG)?32:0)|(s&(m.LALTFLAG|m.RALTFLAG)?64:0),F|=g.metaKey?m.K_METAFLAG:0,t.browser==S.Browser.Firefox&&ne.browserMap.FF["k"+i]&&(i=ne.browserMap.FF["k"+i]);let h=new te({device:t,kName:"",Lcode:i,Lmodifiers:F,Lstates:d,LmodifierChange:u,isSynthetic:!1}),y=typeof g.charCode!="undefined"&&g.charCode!=null&&(g.charCode==0||(F&111)!=0);h.LisVirtualKey=y||g.type!="keypress",h=Ss(h,I,n.baseLayout);let U=new te(h);return U.source=g,U}a(Ml,"preprocessKeyboardEvent");var Pr=class Pr extends Ot{constructor(t,i,l){super();this.domEventTracker=new Ze;this.swallowKeypress=!1;this._KeyDown=a(t=>{var c;let i=this.contextManager.activeKeyboard,l=_e(t);if(!l||i==null)return!0;let s=l.getElement();return((c=s==null?void 0:s.getAttribute("class"))==null?void 0:c.indexOf("kmw-disabled"))>=0?!0:this.keyDown(t)},"_KeyDown");this._KeyPress=a(t=>{var l;return!_e(t)||((l=this.contextManager.activeKeyboard)==null?void 0:l.keyboard)==null?!0:this.keyPress(t)},"_KeyPress");this._KeyUp=a(t=>{let i=_e(t);var l=Ml(t,this.processor,this.hardDevice);if(l==null||i==null)return!0;var s=i.getElement();if(l.Lcode==13){var c=!1;if(_(s,"HTMLTextAreaElement")&&(c=!0),!c){if(s instanceof s.ownerDocument.defaultView.HTMLInputElement)if(s.form&&(s.type=="search"||s.type=="submit"))s.form.submit();else{let r=this.contextManager.page.findNeighboringInput(s,!1);r==null||r.focus()}return!0}}return this.keyUp(t)},"_KeyUp");this.hardDevice=t,this.contextManager=l,this.processor=i;let s=l.page,c=this.domEventTracker;s.on("enabled",r=>{let o=Se(r);if(!(o instanceof j))c.attachDOMEvent(r,"keypress",this._KeyPress),c.attachDOMEvent(r,"keydown",this._KeyDown),c.attachDOMEvent(r,"keyup",this._KeyUp);else{let d=o.getElement().contentDocument;c.attachDOMEvent(d.body,"keydown",this._KeyDown),c.attachDOMEvent(d.body,"keypress",this._KeyPress),c.attachDOMEvent(d.body,"keyup",this._KeyUp)}}),s.on("disabled",r=>{let o=Se(r);if(!(o instanceof j))c.detachDOMEvent(r,"keypress",this._KeyPress),c.detachDOMEvent(r,"keydown",this._KeyDown),c.detachDOMEvent(r,"keyup",this._KeyUp);else{let d=o.getElement().contentDocument;c.detachDOMEvent(d.body,"keydown",this._KeyDown),c.detachDOMEvent(d.body,"keypress",this._KeyPress),c.detachDOMEvent(d.body,"keyup",this._KeyUp)}})}keyDown(t){this.swallowKeypress=!1;var i=Ml(t,this.processor,this.hardDevice);if(i==null)return!0;let l={LeventMatched:!1};return this.emit("keyevent",i,(s,c)=>{l.LeventMatched=s&&!s.triggerKeyDefault,l.LeventMatched?(t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation()),this.swallowKeypress=!!i.Lcode,i.Lcode==8&&(this.swallowKeypress=!1)):this.swallowKeypress=!1}),!l.LeventMatched}keyUp(t){var i=Ml(t,this.processor,this.hardDevice);if(i==null)return!0;let l=_e(t);return this.processor.doModifierPress(i,l,!1)}keyPress(t){var s;var i=Ml(t,this.processor,this.hardDevice);if(i==null||i.LisVirtualKey)return!0;if(!((s=this.contextManager.activeKeyboard)!=null&&s.keyboard.isMnemonic))return!this.swallowKeypress||i.Lcode<32||this.hardDevice.browser==S.Browser.Safari&&i.Lcode>63232&&i.Lcode<63744;let l={};return this.swallowKeypress||this.emit("keyevent",i,(c,r)=>{l.preventDefaultKeystroke=!!c}),this.swallowKeypress||l.preventDefaultKeystroke?(this.swallowKeypress=!1,t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation()),!1):(this.swallowKeypress=!1,!0)}shutdown(){this.domEventTracker.shutdown()}};a(Pr,"HardwareEventKeyboard");var vi=Pr;var jr=class jr{constructor(){this.innerWidth=window.innerWidth,this.innerHeight=window.innerHeight}equals(n){return this.innerWidth==n.innerWidth&&this.innerHeight==n.innerHeight}};a(jr,"RotationState");var Kl=jr,ht=class ht{constructor(n){this.idlePermutationCounter=ht.IDLE_PERMUTATION_CAP;this.keyman=n}resolve(){var i;var n=this.keyman.osk;(i=this.keyman.touchLanguageMenu)==null||i.hide(),this.keyman.touchLanguageMenu=null,n.setNeedsLayout(),this.oskVisible&&n.present(),this.isActive=!1,this.updateTimer&&(window.clearInterval(this.updateTimer),this.rotState=null);let t=this.keyman.contextManager.activeTarget;t&&window.setTimeout(()=>{this.keyman.ensureElementVisibility(t.getElement())},0)}initNewRotation(){this.oskVisible=this.keyman.osk.isVisible(),this.keyman.osk.hideNow(),this.isActive=!0}init(){var n=this.keyman.config.hostDevice.OS,t=this.keyman.util;n=="ios"?(t.attachDOMEvent(window,"orientationchange",()=>(this.iOSEventHandler(),!1)),t.attachDOMEvent(window,"resize",()=>(this.iOSEventHandler(),!1))):n=="android"&&("onmozorientationchange"in screen?t.attachDOMEvent(screen,"mozorientationchange",()=>(this.initNewRotation(),!1)):t.attachDOMEvent(window,"orientationchange",()=>(this.initNewRotation(),!1)),t.attachDOMEvent(window,"resize",()=>(this.resolve(),!1)))}iOSEventHandler(){this.isActive||(this.initNewRotation(),this.rotState=new Kl,this.updateTimer=window.setInterval(this.iOSEventUpdate.bind(this),ht.UPDATE_INTERVAL)),this.idlePermutationCounter=0}iOSEventUpdate(){var n=new Kl;this.rotState.equals(n)?++this.idlePermutationCounter==ht.IDLE_PERMUTATION_CAP&&this.resolve():(this.rotState=n,this.idlePermutationCounter=0)}};a(ht,"RotationProcessor"),ht.IDLE_PERMUTATION_CAP=15,ht.UPDATE_INTERVAL=20;var zl=ht;var _r=class _r{constructor(n,t){this.domEventTracker=new Ze;this.suppressFocusCheck=a(n=>(this.focusAssistant.isTargetForcingScroll()&&(n.stopPropagation(),n.cancelBubble=!0),!0),"suppressFocusCheck");this.pageFocusHandler=a(()=>{var n;return!this.focusAssistant.maintainingFocus&&((n=this.engine.osk)!=null&&n.vkbd)&&(this.engine.contextManager.deactivateCurrentTarget(),this.engine.contextManager.resetContext()),!1},"pageFocusHandler");this.touchStartActivationHandler=a(n=>{var l,s;let t=this.engine.osk;if(!t)return!1;let i=this.engine.config.hostDevice;if(this.deactivateOnRelease=!0,this.touchY=n.touches[0].screenY,this.deactivateOnScroll=!1,i.OS=="android"&&i.browser=="chrome"){if(typeof t._Box=="undefined"||typeof t._Box.style=="undefined")return!1;let c=n.target.parentElement;if(typeof c!="undefined"&&c!=null&&(((l=c.getAttribute("class"))==null?void 0:l.indexOf("kmw-key-"))>=0||typeof c.parentElement!="undefined"&&c.parentElement!=null&&(c=c.parentElement,((s=c.getAttribute("class"))==null?void 0:s.indexOf("kmw-key-"))>=0)))return!1;this.deactivateOnScroll=!0}return!1},"touchStartActivationHandler");this.touchMoveActivationHandler=a(n=>{this.deactivateOnScroll&&(this.focusAssistant.focusing=!1,this.engine.contextManager.deactivateCurrentTarget());let t=n.touches[0].screenY,i=this.touchY;return(t-i>5||i-t<5)&&(this.deactivateOnRelease=!1),!1},"touchMoveActivationHandler");this.touchEndActivationHandler=a(n=>(this.deactivateOnRelease&&!this.engine.touchLanguageMenu&&!this.focusAssistant.focusing&&this.engine.contextManager.deactivateCurrentTarget(),this.deactivateOnRelease=!1,!1),"touchEndActivationHandler");this._WindowLoad=a(()=>{document.body.scrollTop=0,typeof document.documentElement!="undefined"&&(document.documentElement.scrollTop=0)},"_WindowLoad");this._WindowUnload=a(()=>{this.engine.shutdown()},"_WindowUnload");this.window=n,this.engine=t,this.attachHandlers(),t.config.hostDevice.touchable&&(this.buildPageTrailer(),this.rotationProcessor=new zl(this.engine),this.rotationProcessor.init())}buildPageTrailer(){let n=this.mobilePageTrailer=document.createElement("div"),t=n.style;t.width="100%",t.height=screen.width/2+"px",document.body.appendChild(n)}get focusAssistant(){return this.engine.contextManager.focusAssistant}attachHandlers(){let n=this.domEventTracker,t=this.engine.config.hostDevice,i=this.window.document.body;n.attachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),n.attachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),n.attachDOMEvent(i,"focus",this.suppressFocusCheck,!0),n.attachDOMEvent(i,"blur",this.suppressFocusCheck,!0),t.touchable&&(n.attachDOMEvent(i,"touchstart",this.touchStartActivationHandler,!1),n.attachDOMEvent(i,"touchmove",this.touchMoveActivationHandler,!1),n.attachDOMEvent(i,"touchend",this.touchEndActivationHandler,!1)),n.attachDOMEvent(window,"load",this._WindowLoad,!1),n.attachDOMEvent(window,"unload",this._WindowUnload,!1),n.attachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}shutdown(){var l;let n=this.domEventTracker,t=this.engine.config.hostDevice,i=this.window.document.body;n.detachDOMEvent(this.window,"focus",this.pageFocusHandler,!1),n.detachDOMEvent(this.window,"blur",this.pageFocusHandler,!1),n.detachDOMEvent(i,"focus",this.suppressFocusCheck,!0),n.detachDOMEvent(i,"blur",this.suppressFocusCheck,!0),t.touchable&&(n.detachDOMEvent(i,"touchstart",this.touchStartActivationHandler,!1),n.detachDOMEvent(i,"touchmove",this.touchMoveActivationHandler,!1),n.detachDOMEvent(i,"touchend",this.touchEndActivationHandler,!1),(l=this.mobilePageTrailer)==null||l.parentElement.removeChild(this.mobilePageTrailer)),n.detachDOMEvent(window,"load",this._WindowLoad,!1),n.detachDOMEvent(window,"unload",this._WindowUnload,!1),n.detachDOMEvent(document,"keyup",this.engine.hotkeyManager._Process,!1)}};a(_r,"PageIntegrationHandlers");var Dl=_r;function pe(g){let n=document.createElement(g);return n.style.userSelect="none",n.style.MozUserSelect="none",n.style.KhtmlUserSelect="none",n.style.UserSelect="none",n.style.WebkitUserSelect="none",n}a(pe,"_CreateElement");function kt(g,n){try{if(g&&typeof window.getComputedStyle!="undefined")return window.getComputedStyle(g,"").getPropertyValue(n)}catch(t){}return""}a(kt,"getStyleValue");var qr=class qr{constructor(n){this.keyman=n,this.scrolling=!1,this.shim=this.constructShim()}constructShim(){let n=this,t=pe("div"),i=this.keyman.osk;return t.id="kmw-language-menu-background",t.addEventListener("touchstart",l=>{if(l.preventDefault(),n.hide(),l.touches.length>2){var s=l.touches[1].pageX,c=l.touches[1].pageY;let r=i.vkbd.spaceBar;s>r.offsetLeft&&s<r.offsetLeft+r.offsetWidth&&c>r.offsetTop&&c<r.offsetTop+r.offsetHeight&&this.keyman.osk.emit("showbuild")}},!1),t}show(){let n=this.keyman.config.hostDevice,t=this.keyman.keyboardRequisitioner.cache.getStubList();if(t.length<1)return;var l=this.lgList=pe("div");this.lgList.id="kmw-language-menu";let s=this;document.body.appendChild(this.shim);var c=pe("div"),r=c.style,o=pe("div");c.id="kmw-menu-scroll-container",o.id="kmw-menu-scroller","WebkitOverflowScrolling"in r&&(r.WebkitOverflowScrolling="touch"),c.appendChild(o),l.appendChild(c);let d,u=pe("div");u.id="kmw-menu-index";for(let G=1;G<=26;G++)d=pe("p"),d.innerHTML=String.fromCharCode(G+64),u.appendChild(d);if(u.addEventListener("touchstart",function(G){s.scrollToLanguage(G,c,o)},!1),u.addEventListener("touchend",function(G){G.stopPropagation()},!1),l.appendChild(u),l.addEventListener("scroll",function(G){s.scrolling=!0},!1),c.addEventListener("scroll",function(G){c.scrollTop<1&&(c.scrollTop=1),c.scrollTop>c.scrollHeight-c.offsetHeight-1&&(c.scrollTop=c.scrollHeight-c.offsetHeight-1)},!1),this.activeLgNo=this.addLanguages(o,t),this.lgList.style.visibility="hidden",document.body.appendChild(this.lgList),n.OS=="android"&&"devicePixelRatio"in window&&(this.lgList.style.fontSize=2/window.devicePixelRatio+"em"),n.OS=="android"&&n.formFactor=="tablet"&&"devicePixelRatio"in window){var B=parseInt(kt(l,"width"),10),b=l.style;isNaN(B)||(b.width=b.maxWidth=2*B/window.devicePixelRatio+"px"),B=parseInt(kt(c,"width"),10),b=c.style,isNaN(B)||(b.width=b.maxWidth=2*B/window.devicePixelRatio+"px"),B=parseInt(kt(o,"width"),10),b=o.style,isNaN(B)||(b.width=b.maxWidth=2*B/window.devicePixelRatio+"px")}this.adjust(0);var I=u.childNodes[1].offsetTop-u.childNodes[0].offsetTop,F=Math.floor(l.offsetHeight/26),h=Math.round(100*F/I)/100,y=h>.6?1:2;h>1.25&&(h=1.25);for(let G=0;G<26;G++){var U=u.childNodes[G].style;y==2&&G%2==1?U.display="none":(U.fontSize=h*y+"em",U.lineHeight=F*y+"px")}var x=c.offsetWidth;c.scrollHeight>c.offsetHeight+3?x=x+u.offsetWidth:u.style.display="none",l.style.width=x+"px",this.lgList.style.visibility="",this.scrollToIndex(this.activeLgNo,c,o)}adjust(n){let t=this.keyman.osk,i=this.keyman.config.hostDevice;var l=this.lgList,s=l.firstChild,c=s.firstChild,r=0,o=l.style,d=l.childNodes[1],u=window.innerHeight-t.vkbd.lgKey.offsetHeight-16,B=c.childNodes.length+n-1,b=c.firstChild.firstChild.offsetHeight,I=B*b;i.OS=="ios"&&(i.formFactor=="phone"?(r=he()?36:0,u=(window.innerHeight-r-16)*Ve(i.formFactor)):i.formFactor=="tablet"&&(r=he()?16:0,u=u-r)),o.left=z(t.vkbd.lgKey)+"px",I>u&&(I=u),o.height=I+"px",o.bottom="0px",d.style.height=s.style.height=o.height}scrollToLanguage(n,t,i){n.stopImmediatePropagation(),n.stopPropagation(),n.preventDefault();let l=n.touches[0].target;if(l.nodeName=="P"){var s,c,r=l.innerHTML.charCodeAt(0),o=i.childNodes;try{for(s=0;s<o.length-1&&(c=o[s].firstChild.innerHTML.toUpperCase().charCodeAt(0),!(c>=r));s++);}catch(d){}this.scrollToIndex(s,t,i)}}scrollToIndex(n,t,i){let l;try{l=i.firstChild.getBoundingClientRect().height*(n-.5)+1,t.scrollTop=l}catch(c){l=0}try{t.scrollTop<0&&(t.scrollTop=0),t.scrollTop>t.scrollHeight-t.offsetHeight-1&&(t.scrollTop=t.scrollHeight-t.offsetHeight-1)}catch(c){}}addLanguages(n,t){var u;var i=t.length;let l=this.keyman.config.hostDevice,s=[];for(let B=0;B<i;B++){let b=t[B].KL;s.indexOf(b)==-1&&s.push(b)}s.sort();var c=Math.round(100/Ve(l.formFactor))/100;let r=-1;for(let B=0;B<s.length;B++){let b=pe("div");b.className="kbd-list-closed";let I=pe("p");I.kList=[];for(let h=0;h<i;h++)t[h].KL==s[B]&&I.kList.push(t[h]);l.OS=="ios"&&(I.style.fontSize=c+"em"),b.appendChild(I),n.appendChild(b),s[B]==((u=this.keyman.contextManager.activeKeyboard)==null?void 0:u.metadata.langName)&&(r=B);let F=this;if(I.kList.length>1){I.className="kbd-list",I.innerHTML=s[B]+"...",I.scrolled=!1,I.ontouchend=h=>{h.stopPropagation(),I.scrolled?I.scrolled=!1:I.parentElement.className=I.parentElement.className=="kbd-list-closed"?"kbd-list-open":"kbd-list-closed",F.adjust(I.parentElement.className=="kbd-list-closed"?0:I.kList.length)},I.addEventListener("touchstart",function(h){h.stopPropagation()},!1),I.addEventListener("touchmove",function(h){I.scrolled=!0,h.stopPropagation()},!1);for(let h=0;h<I.kList.length;h++){let y=pe("p");y.className="kbd-list-entry",l.OS=="ios"&&(y.style.fontSize=c+"em"),this.addKeyboard(I.kList[h],y,!1),b.appendChild(y)}}else I.innerHTML=s[B],I.className="kbd-single-entry",this.addKeyboard(I.kList[0],I,!0);B==r&&(I.className=I.className+" current")}var o=pe("div");o.id="kmw-menu-footer";var d=a(function(B){B.cancelable&&B.preventDefault(),B.stopPropagation()},"cancelTouch");return o.addEventListener("touchstart",d,!1),o.addEventListener("touchmove",d,!1),o.addEventListener("touchend",d,!1),n.appendChild(o),r}addKeyboard(n,t,i){t.kn=n.KI,t.kc=n.KLC,t.innerHTML=i?n.KL:n.KN.replace(" Keyboard","");let l=this,s=a(()=>{if(this.originalBodyStyle)return console.error("Unexpected state:  `originalBodyStyle` was not cleared by a previous `unlockBodyScroll()` call"),!1;this.originalBodyStyle={};let B=this.originalBodyStyle,b=document.body.style;return B.overflowY=b.overflowY,B.height=b.height,b.overflowY="hidden",b.height="100%",!0},"lockBodyScroll"),c=a(()=>{if(!this.originalBodyStyle){console.error("Unexpected state:  `originalBodyStyle` is unset; cannot restore original body style");return}let B=this.originalBodyStyle,b=document.body.style;b.overflowY=B.overflowY,b.height=B.height,this.originalBodyStyle=null},"unlockBodyScroll"),r=a(function(B){B.stopPropagation(),this.className.indexOf("selected")<=0&&(this.className=this.className+" selected"),l.scrolling=!1,l.y0=B.touches[0].pageY,s()},"touchStart"),o=a(function(B){B.stopImmediatePropagation();var b=l.lgList.childNodes[0],I=b.scrollHeight-b.offsetHeight,F,h;if(typeof B.pageY!="undefined")F=B.pageY;else if(typeof B.touches!="undefined")F=B.touches[0].pageY;else return!1;if(h=F-l.y0,h<0)b.scrollTop>=I-1&&(l.y0=F);else if(h>0)b.scrollTop<2&&(l.y0=F);else return!1;return(h<-5||h>5)&&(l.scrolling=!0,this.className=this.className.replace(/\s*selected/,""),l.y0=F),!0},"touchMove"),d=a(function(B){let b=this;return typeof B.stopImmediatePropagation!="undefined"?B.stopImmediatePropagation():B.stopPropagation(),l.scrolling?this.className=this.className.replace(/\s*selected/,""):(l.keyman.contextManager.focusAssistant.setFocusTimer(),l.lgList.style.display="none",l.keyman.contextManager.activateKeyboard(b.kn,b.kc,!0),l.keyman.contextManager.restoreLastActiveTarget(),l.hide()),c(),!0},"touchEnd"),u=a(function(B){c()},"touchCancel");t.addEventListener("touchstart",r,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",d,!1),t.addEventListener("touchcancel",u,!1)}hide(){let n=this.keyman.osk;this.lgList&&(n.vkbd.highlightKey(n.vkbd.lgKey,!1),this.lgList.style.visibility="hidden",window.setTimeout(()=>{this.shim.parentElement&&(document.body.removeChild(this.shim),document.body.removeChild(this.lgList))},500)),this.keyman.touchLanguageMenu=null}};a(qr,"LanguageMenu");var Ol=qr;function la(g,n,t){let i=t.focusAssistant;n.on("globekey",(l,s)=>{s&&n.hostDevice.touchable&&(g.touchLanguageMenu=new Ol(g),g.touchLanguageMenu.show()),n.vkbd&&n.vkbd.highlightKey(l,!1)}),n.on("hiderequested",l=>{n&&(n.startHide(!0),t.forgetActiveTarget())}),n.addEventListener("hide",l=>{var s;l!=null&&l.HiddenByUser&&((s=t.activeTarget)==null||s.focus())}),n.on("showbuild",()=>{var l;(l=g.config.alertHost)==null||l.alert("KeymanWeb Version "+Rn.VERSION+'<br /><br /><span style="font-size:0.8em">Copyright &copy; 2007-2023 SIL International</span>')}),n.on("dragmove",l=>A(this,null,function*(){i.restoringFocus=!0,yield l,t.restoreLastActiveTarget(),i.restoringFocus=!1,i.setMaintainingFocus(!1)})),n.on("resizemove",l=>A(this,null,function*(){i.restoringFocus=!0,yield l,t.restoreLastActiveTarget(),i.restoringFocus=!1,i.setMaintainingFocus(!1)})),n.on("pointerinteraction",l=>A(this,null,function*(){i.setMaintainingFocus(!0),yield l,i.setMaintainingFocus(!1)}))}a(la,"setupOskListeners");function hg(g){let n=document.createElement(g);return n.style.userSelect="none",n}a(hg,"createUnselectableElement");var $r=class $r{constructor(n){this.getAbsoluteX=z;this.getAbsoluteY=D;this._GetAbsoluteX=z;this._GetAbsoluteY=D;this._GetAbsolute=this.getAbsolute;this.toNzString=this.nzString;this.createElement=hg;this.getStyleValue=kt;this.config=n,this.stylesheetManager=new de(document.body,n.applyCacheBusting),this.domEventTracker=new Ze}isTouchDevice(){return this.config.hostDevice.touchable}getAbsolute(n){return{x:z(n),y:D(n)}}getOption(n,t){return n in this.config.paths?this.config.paths[n]:n in this.config.options?this.config.options[n]:arguments.length>1?t:""}setOption(n,t){switch(n){case"attachType":break;case"ui":break;case"useAlerts":this.config.signalUser=t?new bt:null;break;case"setActiveOnRegister":this.config.activateFirstKeyboard=!!t;break;case"spacebarText":this.config.spacebarText=t;break;default:throw new Error("Path-related options may not be changed after the engine has initialized.")}}loadCookie(n){return new ce(n).load(decodeURIComponent)}saveCookie(n,t){new ce(n).save(t,encodeURIComponent)}addStyleSheet(n){let t=st(n);return this.stylesheetManager.linkStylesheet(t),t}removeStyleSheet(n){return this.stylesheetManager.unlink(n)}linkStyleSheet(n){this.stylesheetManager.linkExternalSheet(n)}getLanguageCodes(n){return n.indexOf("-")==-1?[n]:n.split("-")}attachDOMEvent(n,t,i,l){this.domEventTracker.attachDOMEvent(n,t,i,l)}detachDOMEvent(n,t,i,l){this.domEventTracker.detachDOMEvent(n,t,i,l)}get alertHost(){return this.config.alertHost?this.config.alertHost:(this._alertHost||(this._alertHost=new bt),this._alertHost)}alert(n,t){this.alertHost.alert(n,t)}nzString(n,t){let i="";return arguments.length>1&&(i=t),typeof n=="undefined"||n==null||n==0||n==""?i:""+n}toNumber(n,t){let i=parseInt(n,10);return isNaN(i)?t:i}toFloat(n,t){let i=parseFloat(n);return isNaN(i)?t:i}rgba(n,t,i,l,s){let c="transparent";try{c="rgba("+t+","+i+","+l+","+s+")"}catch(r){c="rgb("+t+","+i+","+l+")"}return c}shutdown(){var n,t,i;(n=this.stylesheetManager)==null||n.unlinkAll(),(t=this.domEventTracker)==null||t.shutdown(),(i=this._alertHost)==null||i.shutdown()}};a($r,"UtilApiEndpoint");var Pl=$r;var to=class to{constructor(n,t,i){this.code=n,this.shift=t,this.handler=i}matches(n,t){return this.code==n&&this.shift==t}};a(to,"Hotkey");var eo=to,no=class no{constructor(){this.hotkeys=[];this._Process=a(n=>{n||(n=window.event);var t=Or(n);if(t==null)return!1;for(var i=(n.shiftKey?16:0)|(n.ctrlKey?32:0)|(n.altKey?64:0),l=0;l<this.hotkeys.length;l++)if(this.hotkeys[l].matches(t,i))return this.hotkeys[l].handler(),n.returnValue=!1,n&&n.preventDefault&&n.preventDefault(),n.cancelBubble=!0,!1;return!0},"_Process")}addHotKey(n,t,i){for(var l=0;l<this.hotkeys.length;l++)if(this.hotkeys[l].code==n&&this.hotkeys[l].shift==t){this.hotkeys[l].handler=i;return}this.hotkeys.push(new eo(n,t,i))}removeHotkey(n,t){for(var i=0;i<this.hotkeys.length;i++)if(this.hotkeys[i].matches(n,t)){this.hotkeys.splice(i,1);return}}};a(no,"HotkeyManager");var jl=no;var lo=class lo{constructor(n){this.e=n,this.c=n.style.backgroundColor}reset(){this.e.style.backgroundColor=this.c}};a(lo,"BeepData");var io=lo,so=class so{constructor(n){this._BeepObjects=[];this._BeepTimeout=0;this.reset=a(()=>{this.keyboardInterface.resetContextCache();var n;for(this._BeepTimeout=0,n=0;n<this._BeepObjects.length;n++)this._BeepObjects[n].reset();this._BeepObjects=[]},"reset");this.keyboardInterface=n}beep(n){if(n instanceof P){var t=n.getElement();if(n instanceof j&&(t=n.docRoot),!!t&&!(!t.style||typeof t.style.backgroundColor=="undefined")){for(var i=0;i<this._BeepObjects.length;i++)if(this._BeepObjects[i].e==t)return;this._BeepObjects.push(new io(t)),t.style.backgroundColor="#000000",this._BeepTimeout==0&&(this._BeepTimeout=1,window.setTimeout(this.reset,50))}}}};a(so,"BeepHandler");var _l=so;var co=class co extends Vt{constructor(t,i){super(t,i);this.GetLastActiveElement=this.getLastActiveElement;this.FocusLastActiveElement=this.focusLastActiveElement;this.HideHelp=this.hideHelp;this.ShowHelp=this.showHelp;this.ShowPinnedHelp=this.showPinnedHelp}saveFocus(){this.engine.contextManager.focusAssistant._IgnoreNextSelChange=1}getLastActiveElement(){return this.engine.contextManager.lastActiveTarget}focusLastActiveElement(){this.engine.contextManager.restoreLastActiveTarget()}hideHelp(){this.engine.osk.startHide(!0)}showHelp(t,i){let l=this.engine.osk;l instanceof Pe?l.presentAtPosition(t,i):l.present()}showPinnedHelp(){let t=this.engine.osk;t instanceof Pe&&(!t.activeKeyboard.keyboard.isCJK||!this.ruleBehavior)&&(t.userPositioned=!0),t.present()}};a(co,"KeyboardInterface");var Un=co;(function(){Un.__publishShorthandAPI()})();var ql=class ql extends rn{constructor(t,i){let l=new Yl(i);super(t,l,new Ri(l,()=>this.legacyAPIEvents),s=>({keyboardInterface:new Un(window,s),defaultOutputRules:new Hi(s.contextManager)}));this._initialized=0;this.hotkeyManager=new jl;this.getOskHeight=null;this.getOskWidth=null;this.helpURL="https://help.keyman.com/go";this.keyEventRefocus=a(()=>{this.contextManager.restoreLastActiveTarget()},"keyEventRefocus");this._GetKeyboardDetail=a(function(t,i){return{Name:t.KN,InternalName:t.KI,LanguageName:t.KL,LanguageCode:t.KLC,RegionName:t.KR,RegionCode:t.KRC,CountryName:t.KC,CountryCode:t.KCC,KeyboardID:t.KD,Font:t.KFont,OskFont:t.KOskFont,HasLoaded:!!i,IsRTL:i?i.isRTL:null}},"_GetKeyboardDetail");this._util=new Pl(l),this.beepHandler=new _l(this.core.keyboardInterface),this.core.keyboardProcessor.beepHandler=()=>this.beepHandler.beep(this.contextManager.activeTarget),this.hardKeyboard=new vi(l.hardDevice,this.core.keyboardProcessor,this.contextManager),this.contextManager.on("targetchange",s=>{let c=s==null?void 0:s.getElement();this.osk&&(this.osk.activationModel.activationTrigger=c),this.config.hostDevice.touchable&&s&&this.ensureElementVisibility(c)})}ensureElementVisibility(t){if(!t||!this.osk)return;let i=D(t),l=window.pageYOffset,s=i-l;i>=l&&(s-=window.innerHeight-this.osk._Box.offsetHeight-t.offsetHeight-2,s<0&&(s=0)),s!=0&&window.scrollTo(0,s+l)}get util(){return this._util}get views(){return Xr}get initialized(){return this._initialized}get ui(){return this._ui}set ui(t){this._ui&&this._ui.shutdown(),this._ui=t,this.config.deferForInitialization.isFulfilled&&t.initialize()}init(t){return A(this,null,function*(){let l=new Ut().detect(),s=C(C({},na),t);if(this.config.hostDevice=l,this.config.initialize(s),this._initialized=1,yield Si(),this.config.deferForInitialization.isResolved)return Promise.resolve();yield Ji(ql.prototype,this,"init").call(this,s),this.keyboardRequisitioner.cloudQueryEngine.once("unboundregister",()=>{var r;(r=this.contextManager.activeKeyboard)!=null&&r.keyboard||this.setActiveKeyboard("","")}),this.contextManager.initialize();let c=this.contextManager.getSavedKeyboardRaw();l.touchable?this.osk=new Qi(this):this.osk=new Ui(this),la(this,this.osk,this.contextManager),this.pageIntegration=new Dl(window,this),this.config.finalizeInit(),this.ui&&(this.ui.initialize(),this.legacyAPIEvents.callEvent("loaduserinterface",{})),this._initialized=2,yield Promise.resolve(),c||(c=this.contextManager.getSavedKeyboard()),c&&this.contextManager.restoreSavedKeyboard(c),yield Promise.resolve()})}get register(){return this.keyboardRequisitioner.cloudQueryEngine.registerFromCloud}getUIState(){return this.contextManager.focusAssistant.getUIState()}activatingUI(t){this.contextManager.focusAssistant.setMaintainingFocus(!!t)}setKeyboardForControl(t,i,l){if(t instanceof t.ownerDocument.defaultView.HTMLIFrameElement){console.warn("'keymanweb.setKeyboardForControl' cannot set keyboard on iframes.");return}if(!this.isAttached(t)){console.error("KeymanWeb is not attached to element "+t);return}let s=null;if(i&&(s=this.keyboardRequisitioner.cache.getStub(i,l),!s))throw new Error(`No keyboard has been registered with id ${i} and language code ${l}.`);this.contextManager.setKeyboardForTarget(t._kmwAttachment.interface,i,l)}getKeyboardForControl(t){let i=Se(t);return this.contextManager.getKeyboardStubForTarget(i).id}getLanguageForControl(t){let i=Se(t);return this.contextManager.getKeyboardStubForTarget(i).langId}isAttached(t){return this.contextManager.page.isAttached(t)}addKeyboards(...t){return this.config.deferForInitialization.then(()=>{if(!t||!t[0]||t[0].length==0)return this.keyboardRequisitioner.fetchCloudCatalog().catch(i=>(console.error(i[0].error),i));{let i=[];return Array.isArray(t[0])?i=i.concat(t[0]):Array.isArray(t)&&(i=i.concat(t)),this.keyboardRequisitioner.addKeyboardArray(i)}})}addKeyboardsForLanguage(t){return this.config.deferForInitialization.then(()=>typeof t=="string"?this.keyboardRequisitioner.addLanguageKeyboards(t.split(",").map(i=>i.trim())):this.keyboardRequisitioner.addLanguageKeyboards(t))}isCJK(t){let i;if(t){let l=t;l.KeyboardID?i=this.keyboardRequisitioner.cache.getKeyboard(l.KeyboardID):i=new T(t)}else i=this.core.activeKeyboard;return i&&i.isCJK}getKeyboard(t,i){let l=this.keyboardRequisitioner.cache.getStub(t,i),s=this.keyboardRequisitioner.cache.getKeyboardForStub(l);return l&&this._GetKeyboardDetail(l,s)}getKeyboards(){let t=[],i=this.keyboardRequisitioner.cache,l=i.getStubList();for(let s=0;s<l.length;s++){let c=l[s],r=i.getKeyboardForStub(c),o=this._GetKeyboardDetail(c,r);t.push(o)}return t}removeKeyboards(...t){var i;for(let l=0;l<t.length;l++)this.keyboardRequisitioner.cache.forgetKeyboard(t[l],!0),((i=this.contextManager.activeKeyboard)==null?void 0:i.metadata.id)==se(t[l])&&this.contextManager.activateKeyboard("","");return!0}getSavedKeyboard(){return this.contextManager.getSavedKeyboard()}focusLastActiveElement(){var t;(t=this.contextManager.lastActiveTarget)==null||t.focus()}getLastActiveElement(){var t;return(t=this.contextManager.lastActiveTarget)==null?void 0:t.getElement()}setActiveElement(t,i){if(typeof t=="string"){let s=t;if(t=document.getElementById(t),!t)throw new Error(`Could not find the specified element (id: ${s}`)}let l=Se(t);if(!l)throw new Error(`KMW is not attached to the specified element (id: ${t.id}).`);this.contextManager.setActiveTarget(l,i)}moveToElement(t){typeof t=="string"&&(t=document.getElementById(t)),t.focus()}addHotKey(t,i,l){this.hotkeyManager.addHotKey(t,i,l)}removeHotKey(t,i){this.hotkeyManager.removeHotkey(t,i)}attachToControl(t){this.contextManager.page.attachToControl(t)}detachFromControl(t){this.contextManager.page.detachFromControl(t)}disableControl(t){this.contextManager.page.disableControl(t)}enableControl(t){this.contextManager.page.enableControl(t)}BuildVisualKeyboard(t,i,l,s){let c=null;t!=null&&(c=this.keyboardRequisitioner.cache.getKeyboard(t)),c=c||this.core.activeKeyboard;let r=this.keyboardRequisitioner.cache.getStub(c),o=this.getOskHeight,d=(typeof o=="function"?o():null)||this.osk.computedHeight||200;return me.buildDocumentationKeyboard(c,r,this.config.paths,l,s,d)}shutdown(){var t,i;this.pageIntegration.shutdown(),this.contextManager.shutdown(),(t=this.osk)==null||t.shutdown(),this.core.languageProcessor.shutdown(),this.hardKeyboard.shutdown(),this.util.shutdown(),this.legacyAPIEvents.callEvent("unloaduserinterface",{}),(i=this.ui)==null||i.shutdown()}};a(ql,"KeymanEngine");var fi=ql;var sa=document.getElementsByTagName("script"),ca=sa[sa.length-1].src,Fg=ca.substr(0,ca.lastIndexOf("/")+1);window.keyman=new fi(ln,Fg);})();
//# sourceMappingURL=keymanweb.js.map
